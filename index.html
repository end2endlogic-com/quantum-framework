<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Quantum Framework Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Quantum Framework Documentation</h1>
<div class="details">
<span id="revnumber">version 1.2.2-SNAPSHOT,</span>
<span id="revdate">2025-09-13T10:41:36Z</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_quarkus_core_features_and_architecture">1. Quarkus Core Features and Architecture</a>
<ul class="sectlevel2">
<li><a href="#_graalvm_native_and_polyglot">1.1. GraalVM Native and Polyglot</a></li>
<li><a href="#_arc_quarkus_cdi_and_inversion_of_control">1.2. Arc (Quarkus CDI) and Inversion of Control</a></li>
<li><a href="#_bean_discovery_qualifiers_and_programmatic_lookups">1.3. Bean Discovery, Qualifiers, and Programmatic Lookups</a></li>
<li><a href="#_reflection_configuration_and_jandex_indexes">1.4. Reflection Configuration and Jandex Indexes</a></li>
</ul>
</li>
<li><a href="#_guides">2. Guides</a></li>
<li><a href="#overview">Overview: Building SaaS with Quantum</a>
<ul class="sectlevel1">
<li><a href="#overview-saas">3. SaaS and Multi‑Tenancy First</a></li>
</ul>
</li>
<li><a href="#tenant-models">Multi‑Tenancy Models</a>
<ul class="sectlevel1">
<li><a href="#_one_tenant_per_database_in_a_mongodb_cluster">4. One Tenant per Database (in a MongoDB Cluster)</a></li>
<li><a href="#_many_tenants_in_one_database_shared_database">5. Many Tenants in One Database (Shared Database)</a></li>
<li><a href="#_freemium_and_trial_tenants">6. Freemium and Trial Tenants</a></li>
<li><a href="#_datadomain_on_models">7. DataDomain on Models</a></li>
<li><a href="#_persistence_repositories">8. Persistence Repositories</a></li>
<li><a href="#_exposing_rest_resources">9. Exposing REST Resources</a></li>
<li><a href="#_lombok_in_models">10. Lombok in Models</a></li>
<li><a href="#_validation_with_jakarta_bean_validation">11. Validation with Jakarta Bean Validation</a></li>
<li><a href="#_jackson_vs_jakarta_validation_annotations">12. Jackson vs Jakarta Validation Annotations</a></li>
<li><a href="#_jackson_objectmapper_in_quarkus_and_in_quantum">13. Jackson ObjectMapper in Quarkus and in Quantum</a></li>
<li><a href="#_validation_lifecycle_and_morphia_interceptors">14. Validation Lifecycle and Morphia Interceptors</a></li>
<li><a href="#_functional_areadomain_in_rulecontext_permission_language">15. Functional Area/Domain in RuleContext Permission Language</a></li>
<li><a href="#_stategraphs_on_models">16. StateGraphs on Models</a></li>
<li><a href="#_references_and_entityreference">17. References and EntityReference</a></li>
<li><a href="#_tracking_references_with_trackreferences_and_delete_semantics">18. Tracking References with @TrackReferences and Delete Semantics</a></li>
</ul>
</li>
<li><a href="#domain-rule-context">DomainContext, RuleContext, and DataDomain</a>
<ul class="sectlevel1">
<li><a href="#_datadomain">19. DataDomain</a></li>
<li><a href="#_domaincontext">20. DomainContext</a></li>
<li><a href="#_rulecontext">21. RuleContext</a></li>
<li><a href="#_end_to_end_flow">22. End-to-End Flow</a></li>
</ul>
</li>
<li><a href="#rest-crud">REST: Find, Get, List, Save, Update, Delete</a>
<ul class="sectlevel1">
<li><a href="#_base_concepts">23. Base Concepts</a></li>
<li><a href="#_example_resource">24. Example Resource</a></li>
<li><a href="#_authorization_layers_in_rest_crud">25. Authorization Layers in REST CRUD</a></li>
<li><a href="#_querying">26. Querying</a></li>
<li><a href="#_responses_and_schemas">27. Responses and Schemas</a></li>
<li><a href="#_error_handling">28. Error Handling</a></li>
<li><a href="#_query_language_antlrbased">29. Query Language (ANTLR‑based)</a>
<ul class="sectlevel2">
<li><a href="#_simple_filters_equals">29.1. Simple filters (equals)</a></li>
<li><a href="#_advanced_filters_grouping_and_andornot">29.2. Advanced filters: grouping and AND/OR/NOT</a></li>
<li><a href="#_in_lists">29.3. IN lists</a></li>
<li><a href="#_sorting">29.4. Sorting</a></li>
<li><a href="#_projections">29.5. Projections</a></li>
<li><a href="#_endtoend_examples">29.6. End‑to‑end examples</a></li>
</ul>
</li>
<li><a href="#_csv_export_and_import">30. CSV Export and Import</a>
<ul class="sectlevel2">
<li><a href="#_export_get_csv">30.1. Export: GET /csv</a></li>
<li><a href="#_import_post_csv_multipart">30.2. Import: POST /csv (multipart)</a></li>
<li><a href="#_import_with_preview_sessions">30.3. Import with preview sessions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#migrations">Database Migrations and Index Management</a>
<ul class="sectlevel1">
<li><a href="#_overview">31. Overview</a></li>
<li><a href="#_semantic_versioning">32. Semantic Versioning</a></li>
<li><a href="#_configuration">33. Configuration</a></li>
<li><a href="#_how_change_sets_are_discovered_and_executed">34. How change sets are discovered and executed</a></li>
<li><a href="#_authoring_a_change_set">35. Authoring a change set</a></li>
<li><a href="#_example_change_sets_in_the_framework">36. Example change sets in the framework</a></li>
<li><a href="#_rest_apis_to_trigger_migrations_migrationresource">37. REST APIs to trigger migrations (MigrationResource)</a></li>
<li><a href="#_perentity_index_management_baseresource">38. Per‑entity index management (BaseResource)</a></li>
<li><a href="#_global_index_management_migrationservice">39. Global index management (MigrationService)</a></li>
<li><a href="#_validating_versions_at_startup">40. Validating versions at startup</a></li>
<li><a href="#_notes_and_best_practices">41. Notes and best practices</a></li>
<li><a href="#_jwt_provider">42. JWT Provider</a></li>
<li><a href="#_pluggable_authentication">43. Pluggable Authentication</a></li>
<li><a href="#_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference">44. Creating an Auth Plugin (using the Custom JWT provider as a reference)</a></li>
<li><a href="#_authprovider_interface_what_a_provider_must_implement">45. AuthProvider interface (what a provider must implement)</a></li>
<li><a href="#_usermanagement_interface_operations_your_plugin_must_support">46. UserManagement interface (operations your plugin must support)</a></li>
<li><a href="#_leveraging_baseauthprovider_in_your_plugin">47. Leveraging BaseAuthProvider in your plugin</a></li>
<li><a href="#_implementing_your_own_provider">48. Implementing your own provider</a></li>
<li><a href="#_credentialuseridpassword_model_and_domaincontext">49. CredentialUserIdPassword model and DomainContext</a></li>
<li><a href="#_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps">50. Quarkus OIDC out-of-the-box and integrating with common IdPs</a></li>
<li><a href="#_authorization_via_rulecontext">51. Authorization via RuleContext</a></li>
</ul>
</li>
<li><a href="#permissions">Permissions: Rule Bases, SecurityURLHeaders, and SecurityURLBody</a>
<ul class="sectlevel1">
<li><a href="#_key_concepts">52. Key Concepts</a></li>
<li><a href="#_rule_structure_illustrative">53. Rule Structure (Illustrative)</a></li>
<li><a href="#_matching_algorithm">54. Matching Algorithm</a></li>
<li><a href="#_priorities">55. Priorities</a></li>
<li><a href="#_multiple_matching_rulebases">56. Multiple Matching RuleBases</a></li>
<li><a href="#_identity_and_role_matching">57. Identity and Role Matching</a></li>
<li><a href="#_example_scenarios">58. Example Scenarios</a></li>
<li><a href="#_operational_tips">59. Operational Tips</a></li>
<li><a href="#_how_uiactions_and_defaultuiactions_are_calculated">60. How UIActions and DefaultUIActions are calculated</a></li>
<li><a href="#_how_this_integrates_end_to_end">61. How This Integrates End-to-End</a></li>
<li><a href="#_administering_policies_via_rest_policyresource">62. Administering Policies via REST (PolicyResource)</a>
<ul class="sectlevel2">
<li><a href="#_model_shape_policy">62.1. Model shape (Policy)</a></li>
<li><a href="#_endpoints">62.2. Endpoints</a></li>
<li><a href="#_examples">62.3. Examples</a></li>
<li><a href="#_how_changes_affect_rule_bases_and_enforcement">62.4. How changes affect rule bases and enforcement</a></li>
</ul>
</li>
<li><a href="#_realm_override_x_realm_and_impersonation_x_impersonate">63. Realm override (X-Realm) and Impersonation (X-Impersonate)</a>
<ul class="sectlevel2">
<li><a href="#_what_they_do_at_a_glance">63.1. What they do (at a glance)</a></li>
<li><a href="#_how_the_headers_integrate_with_permission_evaluation">63.2. How the headers integrate with permission evaluation</a></li>
<li><a href="#_required_credential_configuration_credentialuseridpassword">63.3. Required credential configuration (CredentialUserIdPassword)</a></li>
<li><a href="#_end_to_end_behavior_from_securityfilter_reference">63.4. End-to-end behavior from SecurityFilter (reference)</a></li>
<li><a href="#_practical_differences_and_use_cases">63.5. Practical differences and use cases</a></li>
<li><a href="#_examples_2">63.6. Examples</a></li>
</ul>
</li>
<li><a href="#_data_domain_assignment_on_create_domaincontext_and_datadomainpolicy">64. Data domain assignment on create: DomainContext and DataDomainPolicy</a>
<ul class="sectlevel2">
<li><a href="#_the_problem_this_solves_and_why_it_matters">64.1. The problem this solves (and why it matters)</a></li>
<li><a href="#_key_concepts_recap_domaincontext_and_datadomain">64.2. Key concepts recap: DomainContext and DataDomain</a></li>
<li><a href="#_the_default_policy_do_nothing_and_it_works">64.3. The default policy (do nothing and it works)</a></li>
<li><a href="#_policy_scopes_principalattached_vs_global">64.4. Policy scopes: principal‑attached vs. global</a></li>
<li><a href="#_the_policy_map_and_matching">64.5. The policy map and matching</a></li>
<li><a href="#_how_the_resolver_works">64.6. How the resolver works</a></li>
<li><a href="#_when_would_you_want_a_nonglobal_policy">64.7. When would you want a non‑global policy?</a></li>
<li><a href="#_relation_to_tenancy_models">64.8. Relation to tenancy models</a></li>
<li><a href="#_authoring_tips">64.9. Authoring tips</a></li>
<li><a href="#_api_pointers">64.10. API pointers</a></li>
</ul>
</li>
<li><a href="#_tutorials">65. Tutorials</a></li>
</ul>
</li>
<li><a href="#tutorial-supply-chain">Tutorial: Supply Chain Collaboration End-to-End</a>
<ul class="sectlevel1">
<li><a href="#_domain_overview">66. Domain Overview</a></li>
<li><a href="#_models">67. Models</a></li>
<li><a href="#_repositories">68. Repositories</a></li>
<li><a href="#_rest_resources">69. REST Resources</a></li>
<li><a href="#_multi_tenant_sharing_scenarios">70. Multi-Tenant Sharing Scenarios</a></li>
<li><a href="#_rulecontext_sketch">71. RuleContext Sketch</a></li>
<li><a href="#_authentication">72. Authentication</a></li>
<li><a href="#_separating_models_and_repos_for_workflows">73. Separating Models and Repos for Workflows</a></li>
<li><a href="#_result">74. Result</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This documentation provides user guides and tutorials for mid-level Java developers to build SaaS applications with multi-tenancy on the Quantum framework, in a structure similar to Spring’s reference documentation. Artifacts are generated as HTML and PDF via Maven.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quarkus_core_features_and_architecture">1. Quarkus Core Features and Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus is a Kubernetes‑native Java stack optimized for fast startup, low memory footprint, and developer productivity. Quantum builds on Quarkus to provide multi‑tenant persistence, security, and rule‑driven authorization.</p>
</div>
<div class="paragraph">
<p>Key capabilities:
- Developer joy: live reload (dev mode), unified config, test‑first ergonomics.
- Build‑time optimizations: aggressive classpath indexing and ahead‑of‑time processing to reduce reflection and bytecode scanning at runtime.
- Container and cloud native: seamless integration with containers, Kubernetes, health checks, metrics, and config.
- Extension ecosystem: rich set of extensions for data, security, messaging, observability, and more.</p>
</div>
<div class="sect2">
<h3 id="_graalvm_native_and_polyglot">1.1. GraalVM Native and Polyglot</h3>
<div class="ulist">
<ul>
<li>
<p>Native compilation: Quarkus applications can be compiled to native executables using GraalVM (or Mandrel). Benefits include millisecond startup times and drastically reduced RSS memory, ideal for serverless and microservice workloads.</p>
</li>
<li>
<p>Constraints: reflection, dynamic proxies, and some dynamic classloading need explicit configuration or substitution (Quarkus largely automates this, see @RegisterForReflection below).</p>
</li>
<li>
<p>Polyglot support: GraalVM provides runtimes for multiple languages (e.g., JavaScript, Python via GraalPy, Ruby, R). Applications can embed polyglot code where appropriate using GraalVM’s polyglot APIs. Use judiciously to avoid bloating native images and to maintain clear performance boundaries.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_arc_quarkus_cdi_and_inversion_of_control">1.2. Arc (Quarkus CDI) and Inversion of Control</h3>
<div class="paragraph">
<p>Arc is Quarkus’ CDI implementation, focused on build‑time analysis and small runtime overhead. It implements the Inversion of Control pattern:
- You declare components (beans) with scopes and qualifiers.
- The container instantiates, wires, and manages their lifecycle.
- Your code depends on interfaces and qualifiers rather than concrete implementations.</p>
</div>
<div class="paragraph">
<p>Common scopes and their semantics:
- @ApplicationScoped
  - One contextual instance for the duration of the application. Arc can proxy such beans and apply interceptors. Recommended default for stateless services and repositories.
- @Singleton
  - Single Java instance managed by the container, but not a normal CDI context. It typically doesn’t use client proxies; some CDI features (like certain interceptor/proxy behaviors) may differ. Prefer @ApplicationScoped for CDI beans unless you specifically need @Singleton semantics.
- @RequestScoped
  - One instance per incoming HTTP request. Useful for per‑request context holders or lightweight state.
- @SessionScoped (when web sessions are enabled)
  - One instance per HTTP session. Use sparingly due to clustering/state implications.
- @Dependent (the default if no scope is declared)
  - No contextual lifecycle; a new instance is created at every injection point, and its lifecycle is bound to the injecting bean. Good for lightweight, stateful helpers.</p>
</div>
<div class="paragraph">
<p>Recommendations:
- Prefer @ApplicationScoped for stateless services, @RequestScoped for per‑request concerns, and @Dependent for small, short‑lived helpers.
- Choose @Singleton only when you explicitly want a single instance without normal CDI contextual behavior.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bean_discovery_qualifiers_and_programmatic_lookups">1.3. Bean Discovery, Qualifiers, and Programmatic Lookups</h3>
<div class="ulist">
<ul>
<li>
<p>Discovery: Quarkus performs build‑time bean discovery using classpath indexing. A class becomes a bean when it has a bean‑defining annotation (e.g., a scope such as @ApplicationScoped) or is produced via a producer method/field.</p>
</li>
<li>
<p>Qualifiers: Use qualifiers (custom annotations annotated with @Qualifier) to disambiguate multiple implementations of the same interface.</p>
</li>
<li>
<p>Programmatic selection with Instance&lt;T&gt;:</p>
</li>
<li>
<p>Inject Instance&lt;SomeType&gt; to iterate over all beans of a type or to select by qualifier at runtime.</p>
</li>
<li>
<p>Useful for plugin architectures where you discover all provider implementations and choose one based on configuration or request context.</p>
</li>
<li>
<p>Remember that Instance&lt;T&gt; is lazy; calling get()/iterator() triggers resolution.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_reflection_configuration_and_jandex_indexes">1.4. Reflection Configuration and Jandex Indexes</h3>
<div class="ulist">
<ul>
<li>
<p>@RegisterForReflection</p>
</li>
<li>
<p>Native images eliminate reflection metadata by default. Annotate classes that must be available to reflection at runtime (e.g., JSON serializers, frameworks performing reflective access).</p>
</li>
<li>
<p>Quarkus extensions often auto‑register common frameworks. Use this annotation for your own types when needed, especially DTOs or model classes used by reflection‑heavy libraries.</p>
</li>
<li>
<p>Jandex indexes</p>
</li>
<li>
<p>Quarkus builds a Jandex index of your application and dependencies at build time to analyze annotations and discover beans without scanning at runtime.</p>
</li>
<li>
<p>This indexing underpins Arc’s fast startup and small footprint by moving classpath analysis to build time.</p>
</li>
<li>
<p>When adding third‑party libraries that rely on reflection or dynamic discovery, ensure they either provide Jandex indexes or are properly configured for reflection in native mode.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_guides">2. Guides</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="overview" class="sect0">Overview: Building SaaS with Quantum</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Quantum is a Quarkus-based framework that accelerates building multi-tenant SaaS platforms on MongoDB. It provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multi-tenancy primitives for tenant creation, isolation, and data sharing</p>
</li>
<li>
<p>A domain-first programming model with Functional Areas, Functional Domains, and Actions</p>
</li>
<li>
<p>Data security and contextual evaluation via DataDomain, DomainContext, and RuleContext</p>
</li>
<li>
<p>Consistent REST resources for find/get/list/save/update/delete operations</p>
</li>
<li>
<p>Pluggable authentication with a provided JWT module and extension points</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide targets mid-level Java developers and follows a structure similar to Spring’s reference docs. Use Maven to generate HTML/PDF: see docs module README for commands.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview-saas">3. SaaS and Multi‑Tenancy First</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SaaS solutions require:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Onboarding automation: programmatic tenant creation, freemium/trial flows</p>
</li>
<li>
<p>Isolation with selective sharing</p>
</li>
<li>
<p>Policy-driven access that adapts to user, org, tenant, and action</p>
</li>
<li>
<p>Operational efficiency (observability, cost control, upgradeability)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum’s building blocks address these needs out-of-the-box while remaining flexible to fit your architecture.</p>
</div>
</div>
</div>
<h1 id="tenant-models" class="sect0">Multi‑Tenancy Models</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Quantum supports multiple multi-tenant models for MongoDB deployments:</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_one_tenant_per_database_in_a_mongodb_cluster">4. One Tenant per Database (in a MongoDB Cluster)</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Each tenant is mapped to a dedicated MongoDB database within a cluster.</p>
</li>
<li>
<p>Strong isolation at the database level; operational controls via MongoDB roles.</p>
</li>
<li>
<p>Pros: Simplified backup/restore per tenant; reduced risk of data bleed.</p>
</li>
<li>
<p>Cons: More databases to manage (indexes, connections), higher operational overhead.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How Quantum helps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataDomain carries tenant identifiers (e.g., tenantId, ownerId, orgRefName) on each model.</p>
</li>
<li>
<p>Repositories can resolve connections/DB selection per tenant, enabling routing to the appropriate database.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_many_tenants_in_one_database_shared_database">5. Many Tenants in One Database (Shared Database)</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Multiple tenants share a single database and collections.</p>
</li>
<li>
<p>Isolation is enforced at the application layer using DataDomain filters.</p>
</li>
<li>
<p>Pros: Fewer databases to manage; efficient index utilization and connection pooling.</p>
</li>
<li>
<p>Cons: Strict discipline required to enforce filtering and access rules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How Quantum helps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataDomain is part of every persisted model, enabling programmatic, rule-based filtering.</p>
</li>
<li>
<p>RuleContext and DomainContext can be used to inject tenant-aware filters into repositories and resources.</p>
</li>
<li>
<p>Cross-tenant sharing can be modeled by specific DataDomain fields and RuleContext logic granting read access across tenants on a per-functional-area basis.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_freemium_and_trial_tenants">6. Freemium and Trial Tenants</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Programmatically create tenants to support self-service onboarding.</p>
</li>
<li>
<p>Attach time-bound or capability-bound policies.</p>
</li>
<li>
<p>Use scheduled jobs to convert/expire trials.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tenant onboarding service creates a DataDomain scope and any default records.</p>
</li>
<li>
<p>Policies are encoded in RuleContext checks to allow or restrict actions based on time, plan, or feature flags.
= Modeling with Functional Areas, Domains, and Actions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum organizes your system around three core constructs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional Area: A broad capability area (e.g., Identity, Catalog, Orders, Collaboration).</p>
</li>
<li>
<p>Functional Domain: A cohesive sub-area within an area (e.g., in Collaboration: Partners, Shipments, Tasks).</p>
</li>
<li>
<p>Actions: The set of operations applicable to a domain (CREATE, UPDATE, VIEW, DELETE, ARCHIVE, plus domain-specific actions).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These constructs allow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fine-grained sharing: Point specific functional areas to shared databases while others remain strictly segmented.</p>
</li>
<li>
<p>Policy composition: Apply RuleContext decisions at the level of area/domain/action.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_datadomain_on_models">7. DataDomain on Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All persisted models carry DataDomain (tenantId, orgRefName, ownerId, etc.) for rule-based filtering and cross-tenant sharing.</p>
</div>
<div class="paragraph">
<p>Example model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok.Data</span>;
<span class="keyword">import</span> <span class="include">lombok.EqualsAndHashCode</span>;
<span class="keyword">import</span> <span class="include">lombok.NoArgsConstructor</span>;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Product</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_persistence_repositories">8. Persistence Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Define a repository to persist and query your model. With Morphia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.MorphiaRepo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ProductRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Product&gt; {
    <span class="comment">// custom queries can be added here</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposing_rest_resources">9. Exposing REST Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Expose consistent CRUD endpoints by extending BaseResource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Inherit find, get, list, save, update, delete endpoints</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this minimal setup, you get standard REST APIs guarded by RuleContext/DataDomain and enriched with UIAction metadata.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lombok_in_models">10. Lombok in Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lombok reduces boilerplate in Quantum models and supports inheritance-friendly builders.</p>
</div>
<div class="paragraph">
<p>Common annotations you will see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Data: Generates getters, setters, toString, equals, and hashCode.</p>
</li>
<li>
<p>@NoArgsConstructor: Required by frameworks that need a no-arg constructor (e.g., Jackson, Morphia).</p>
</li>
<li>
<p>@EqualsAndHashCode(callSuper = true): Includes superclass fields in equality and hash.</p>
</li>
<li>
<p>@SuperBuilder: Provides a builder that cooperates with parent classes (useful for BaseModel subclasses).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> sku;
  <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Prefer @SuperBuilder over @Builder when extending BaseModel/UnversionedBaseModel.
- Keep equals/hashCode stable for collections and caches; include callSuper when needed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_with_jakarta_bean_validation">11. Validation with Jakarta Bean Validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum uses Jakarta Bean Validation to enforce invariants on models at persist time (and optionally at REST boundaries).</p>
</div>
<div class="paragraph">
<p>Typical annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Size(min=3): String/collection length constraints.</p>
</li>
<li>
<p>@Valid: Cascade validation to nested objects (e.g., DataDomain on models).</p>
</li>
<li>
<p>@NotNull, @Email, @Pattern, etc., as needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where validation runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Repository layer via Morphia ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Executes validator.validate(entity) before the document is written.</p>
</li>
<li>
<p>If there are violations and the entity does not implement InvalidSavable with canSaveInvalid=true, an E2eqValidationException is thrown.</p>
</li>
<li>
<p>If DataDomain is null and SecurityContext has a principal, ValidationInterceptor will default the DataDomain from the principal context.</p>
</li>
<li>
<p>Optionally at REST boundaries: You may also annotate resource DTOs/parameters with Jakarta validation; Quarkus can validate them before the method executes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jackson_vs_jakarta_validation_annotations">12. Jackson vs Jakarta Validation Annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These two families of annotations serve different purposes and complement each other:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jackson annotations (com.fasterxml.jackson.annotation.*) control JSON serialization/deserialization.</p>
</li>
<li>
<p>Examples: @JsonIgnore, @JsonIgnoreProperties, @JsonProperty, @JsonInclude.</p>
</li>
<li>
<p>They do not enforce business constraints; they affect how JSON is produced/consumed.</p>
</li>
<li>
<p>Jakarta Validation annotations (jakarta.validation.*) declare constraints that are evaluated at runtime.</p>
</li>
<li>
<p>Examples: @NotNull, @Size, @Valid, @Pattern.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Correspondence and interplay:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Jackson to hide or rename fields in API responses/requests (e.g., @JsonIgnore on transient/calculated fields such as UIActionList).</p>
</li>
<li>
<p>Use Jakarta Validation to ensure incoming/outgoing models satisfy required constraints; ValidationInterceptor runs before persistence to enforce them.</p>
</li>
<li>
<p>It’s common to annotate the same field with both families when you both constrain values and want specific JSON behavior.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jackson_objectmapper_in_quarkus_and_in_quantum">13. Jackson ObjectMapper in Quarkus and in Quantum</h2>
<div class="sectionbody">
<div class="paragraph">
<p>How Quarkus creates ObjectMapper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus produces a CDI-managed ObjectMapper. You can customize it by providing a bean that implements io.quarkus.jackson.ObjectMapperCustomizer.</p>
</li>
<li>
<p>You can also tweak common features via application.properties using quarkus.jackson.* properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The framework provides a QuarkusJacksonCustomizer that:</p>
</li>
<li>
<p>Sets DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES = true (reject unknown JSON fields).</p>
</li>
<li>
<p>Registers custom serializers/deserializers for org.bson.types.ObjectId so it can be used as String in APIs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Snippet from the framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">QuarkusJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper objectMapper) {
    objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="predefined-constant">true</span>);
    SimpleModule module = <span class="keyword">new</span> SimpleModule();
    module.addSerializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonSerializer());
    module.addDeserializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonDeserializer());
    objectMapper.registerModule(module);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Customize in your app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add another ObjectMapperCustomizer bean (order is not guaranteed; make changes idempotent):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper mapper) {
    mapper.findAndRegisterModules();
    mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
    mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
  }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Or set properties in application.properties:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Fail if extraneous fields are present
quarkus.jackson.fail-on-unknown-properties=true
# Example date format and inclusion
quarkus.jackson.write-dates-as-timestamps=false
quarkus.jackson.serialization-inclusion=NON_NULL</code></pre>
</div>
</div>
<div class="paragraph">
<p>When to adjust:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relax fail-on-unknown only for backward-compatibility scenarios; strictness helps catch client mistakes.</p>
</li>
<li>
<p>Register modules (JavaTime, etc.) if your models include those types.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_lifecycle_and_morphia_interceptors">14. Validation Lifecycle and Morphia Interceptors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Morphia interceptors enhance and enforce behavior during persistence. Quantum registers the following for each realm-specific datastore:</p>
</div>
<div class="paragraph">
<p>Order of registration (see MorphiaDataStore):
1) ValidationInterceptor
2) PermissionRuleInterceptor
3) AuditInterceptor
4) ReferenceInterceptor
5) PersistenceAuditEventInterceptor</p>
</div>
<div class="paragraph">
<p>High-level responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Defaults DataDomain from SecurityContext if missing.</p>
</li>
<li>
<p>Runs bean validation and throws E2eqValidationException on violations unless the entity supports saving invalid states (InvalidSavable).</p>
</li>
<li>
<p>PermissionRuleInterceptor (prePersist):</p>
</li>
<li>
<p>Evaluates RuleContext with PrincipalContext and ResourceContext from SecurityContext.</p>
</li>
<li>
<p>Throws SecurityCheckException if the rule decision is not ALLOW (enforcing write permissions for save/update/delete).</p>
</li>
<li>
<p>AuditInterceptor (prePersist):</p>
</li>
<li>
<p>Sets AuditInfo on creation and updates lastUpdate fields on modification; captures impersonation details if present.</p>
</li>
<li>
<p>ReferenceInterceptor (prePersist):</p>
</li>
<li>
<p>For @Reference fields annotated with @TrackReferences, maintains back-references on the parent entities via ReferenceEntry and persists the parent when needed.</p>
</li>
<li>
<p>PersistenceAuditEventInterceptor (prePersist when @AuditPersistence is present):</p>
</li>
<li>
<p>Appends a PersistentEvent with type PERSIST, date, userId, and version to the model’s persistentEvents before saving.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When does validation occur?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On every save/update path that hits persistence, prePersist triggers validation (and permission/audit/reference processing) before the document is written to MongoDB, guaranteeing constraints and policies are enforced consistently across all repositories.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_areadomain_in_rulecontext_permission_language">15. Functional Area/Domain in RuleContext Permission Language</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Models express their placement in the business model via:
- bmFunctionalArea(): returns a broad capability area (e.g., Catalog, Collaboration, Identity)
- bmFunctionalDomain(): returns the specific domain within that area (e.g., Product, Shipment, Partner)</p>
</div>
<div class="paragraph">
<p>How these map into authorization and rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ResourceContext/DomainContext: When a request operates on a model, the framework derives the functional area and domain from the model type (or resource) and places them on the current context alongside the action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE). RuleContext consumes these to evaluate policies.</p>
</li>
<li>
<p>Permission language (headers): Rule bases can match on HTTP headers such as x-functional-area and x-functional-domain. These are often set by the resource layer or middleware to reflect the model’s bmFunctionalArea/bmFunctionalDomain for the current operation.</p>
</li>
<li>
<p>Permission language (query variables): The ANTLR-based query language exposes variables that can be referenced in filters:</p>
</li>
<li>
<p>${area} corresponds to bmFunctionalArea()</p>
</li>
<li>
<p>${functionalDomain} corresponds to bmFunctionalDomain()
These can be used to author reusable filters or to record audit decisions by area/domain.</p>
</li>
<li>
<p>Repository filters: RuleContext can contribute additional predicates that are area/domain-specific, enabling fine-grained sharing. For example, a shared Catalog area may allow cross-tenant VIEW, while a Collaboration.Shipment domain remains tenant-strict.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>1) Header-based rule matching (Permissions)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-catalog-reads</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[GET]</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">/api/**</span></span>
    <span class="key">headers</span>:
      <span class="key">x-functional-area</span>: <span class="string"><span class="content">[Catalog]</span></span>
      <span class="key">x-functional-domain</span>: <span class="string"><span class="content">[Product, Category]</span></span>
    <span class="key">rolesAny</span>: <span class="string"><span class="content">[USER, ADMIN]</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">filters</span>:
    <span class="key">readScope</span>: <span class="string"><span class="content">{ orgRefName: PUBLIC }</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Query variable usage (Filters)</p>
</div>
<div class="paragraph">
<p>You can reference the active area/domain in filter expressions (e.g., for auditing or conditional branching in custom rule evaluators):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Constrain reads differently when operating in the Catalog area
(${area}:&quot;Catalog&quot; &amp;&amp; dataDomain.orgRefName:&quot;PUBLIC&quot;) ||
(${area}:!&quot;Catalog&quot; &amp;&amp; dataDomain.tenantId:${pTenantId})</code></pre>
</div>
</div>
<div class="paragraph">
<p>3) Model-driven mapping</p>
</div>
<div class="paragraph">
<p>Given a model like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Collaboration</span><span class="delimiter">&quot;</span></span>; }
<span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>; }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Incoming REST requests that operate on Shipment resources set area=Collaboration and functionalDomain=Shipment in the ResourceContext.</p>
</li>
<li>
<p>RuleContext evaluates policies considering action + area + domain, e.g., deny cross-tenant UPDATE in Collaboration.Shipment, but allow cross-tenant VIEW in Collaboration.Partner if marked shared.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you create composite resources that span multiple models, set the headers (x-functional-area, x-functional-domain) explicitly for each endpoint so rules can target them precisely.</p>
</li>
<li>
<p>See also: the Permissions section for rule-base matching and priorities, and the DomainContext/RuleContext section for end-to-end flow.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stategraphs_on_models">16. StateGraphs on Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>StateGraphs let you restrict valid values and transitions of String state fields. They are declared on model fields with @StateGraph and enforced during save/update when the model class is annotated with @Stateful.</p>
</div>
<div class="paragraph">
<p>Key pieces:
- @StateGraph(graphName="&#8230;&#8203;"): mark a String field as governed by a named state graph.
- @Stateful: mark the entity type as participating in state validation.
- StateGraphManager: runtime registry that holds graphs and validates transitions.
- StringState and StateNode: define the graph (states, initial/final flags, transitions).</p>
</div>
<div class="paragraph">
<p>Defining a state graph at startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Startup</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StateGraphInitializer</span> {
  <span class="annotation">@Inject</span> StateGraphManager stateGraphManager;
  <span class="annotation">@PostConstruct</span> <span class="type">void</span> init() {
    StringState order = <span class="keyword">new</span> StringState();
    order.setFieldName(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, StateNode&gt; states = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">true</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    order.setStates(states);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">List</span>&lt;StateNode&gt;&gt; transitions = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    order.setTransitions(transitions);

    stateGraphManager.defineStateGraph(order);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the graph in a model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateful</span>
<span class="annotation">@Entity</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@StateGraph</span>(graphName = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">private</span> <span class="predefined-type">String</span> status;

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Orders</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How it affects save/update:
- On create: validateInitialStates ensures the field value is one of the configured initial states. Otherwise, InvalidStateTransitionException is thrown.
- On update: validateStateTransitions checks each @StateGraph field’s old&#8594;new transition against the graph via StateGraphManager.validateTransition(). If invalid, save/update fails with InvalidStateTransitionException. This applies to full-entity saves and to partial updates via repo.update(&#8230;&#8203;pairs) on that field.
- Utilities: StateGraphManager.getNextPossibleStates(graphName, current) and printStateGraph(&#8230;&#8203;) can aid UIs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references_and_entityreference">17. References and EntityReference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Morphia @Reference establishes relationships between entities:
- One-to-one: a BaseModel field annotated with @Reference.
- One-to-many: a Collection&lt;BaseModel&gt; field annotated with @Reference.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Shipment</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@Reference</span>(ignoreMissing = <span class="predefined-constant">false</span>)
  <span class="annotation">@TrackReferences</span>
  <span class="directive">private</span> Partner partner;   <span class="comment">// parent entity</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>EntityReference is a lightweight reference object used across the framework to avoid DBRef loading when only identity info is needed. Any model can produce one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityReference ref = shipment.createEntityReference();
<span class="comment">// contains: entityId, entityType, entityRefName, entityDisplayName (and optional realm)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>REST convenience:
- BaseResource exposes GET /entityref to list EntityReference for a model with optional filter/sort.
- Repositories expose getEntityReferenceListByQuery(&#8230;&#8203;), and utilities exist to convert lists of EntityReference back to entities when needed.</p>
</div>
<div class="paragraph">
<p>When to use which:
- Use @Reference for strong persistence-level links where Morphia should maintain foreign references.
- Use EntityReference for UI lists, foreign-key-like pointers in other documents, events/audit logs, or cross-module decoupling without DBRef behavior.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tracking_references_with_trackreferences_and_delete_semantics">18. Tracking References with @TrackReferences and Delete Semantics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>@TrackReferences on a @Reference field tells the framework to maintain a back-reference set on the parent entity. The back-reference field is UnversionedBaseModel.references (a Set&lt;ReferenceEntry&gt;), which is calculated/maintained by the framework and should not be set by clients.</p>
</div>
<div class="paragraph">
<p>What references contains:
- Each ReferenceEntry holds: referencedId (ObjectId of the child), type (fully-qualified class name of the child’s entity), and refName (child’s stable reference name).
- It indicates that the parent is being referenced by the given child entity. The set is used for fast checks and to enforce referential integrity.</p>
</div>
<div class="paragraph">
<p>How tracking works (save/update):
- ReferenceInterceptor inspects @Reference fields annotated with @TrackReferences during prePersist.
- When a child references a parent, a ReferenceEntry for the child is added to the parent’s references set and the parent is saved to persist the back-reference.
- For @Reference collections, entries are added for each child-parent pair.
- If a @Reference is null but ignoreMissing=false, a save will fail with an IllegalStateException since the parent is required.</p>
</div>
<div class="paragraph">
<p>How it affects delete:
- During delete in MorphiaRepo.delete(&#8230;&#8203;):
  - If obj.references is empty, the object can be deleted directly (after removing any references it holds to parents).
  - If obj.references is not empty, the repo checks each ReferenceEntry. If any referring parent still exists, a ReferentialIntegrityViolationException is thrown to prevent breaking relationships.
  - If all references are stale (referring objects no longer exist), the repo removes stale entries, removes this object’s own reference constraints from parents, and performs the delete within a transaction.
- removeReferenceConstraint(&#8230;&#8203;) ensures that, when deleting a child, its ReferenceEntry is removed from parent.references and the parent is saved, keeping back-references consistent.</p>
</div>
<div class="paragraph">
<p>Practical guidance:
- Annotate parent links with both @Reference and @TrackReferences when you need strong integrity guarantees and easy “who references me?” queries.
- Use ignoreMissing=true only for optional references; you still get back-reference tracking when not null.
- Expect HTTP delete to fail with a meaningful error if there are live references; remove or update those references first, or design cascading behavior explicitly in your domain logic.</p>
</div>
</div>
</div>
<h1 id="domain-rule-context" class="sect0">DomainContext, RuleContext, and DataDomain</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Quantum enforces multi-tenant isolation and sharing through contextual data carried on models and evaluated at runtime.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_datadomain">19. DataDomain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every persisted model includes a DataDomain that describes ownership and scope, commonly including fields such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tenantId: Identifies the tenant</p>
</li>
<li>
<p>orgRefName: Organization unit reference within a tenant</p>
</li>
<li>
<p>ownerId: Owning user or system entity</p>
</li>
<li>
<p>realm: Optional runtime override for partitioning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These fields enable filtering, authorization, and controlled sharing of data between tenants or org units.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_domaincontext">20. DomainContext</h2>
<div class="sectionbody">
<div class="paragraph">
<p>DomainContext represents the current execution context for a request or operation, typically capturing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>current tenant/org/user identity</p>
</li>
<li>
<p>functional area / functional domain</p>
</li>
<li>
<p>the action being executed (e.g., CREATE, UPDATE, VIEW, DELETE, ARCHIVE)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It feeds downstream components (repositories, resources) to consistently apply filtering and policy decisions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rulecontext">21. RuleContext</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RuleContext encapsulates policy evaluation. It can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enforce whether an action is allowed for a given model and DataDomain</p>
</li>
<li>
<p>Produce additional filters and projections used by repositories</p>
</li>
<li>
<p>Grant cross-tenant read access for specific functional areas (e.g., shared catalogs) while keeping others strictly isolated</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_end_to_end_flow">22. End-to-End Flow</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A REST request enters a BaseResource-derived endpoint.</p>
</li>
<li>
<p>The resource builds a DomainContext from the security principal and request parameters.</p>
</li>
<li>
<p>RuleContext evaluates permissions and returns effective filters.</p>
</li>
<li>
<p>Repository applies filters (DataDomain-aware) to find/get/list/update/delete.</p>
</li>
<li>
<p>The model’s UIActionList can be computed to reflect what the caller can do next.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This pattern ensures consistent enforcement across all CRUD operations, independent of the specific model or repository.</p>
</div>
</div>
</div>
<h1 id="rest-crud" class="sect0">REST: Find, Get, List, Save, Update, Delete</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Quantum provides consistent REST resources backed by repositories. Extend BaseResource to expose CRUD quickly and consistently.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_base_concepts">23. Base Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>BaseResource&lt;T, R extends Repo&lt;T&gt;&gt; provides endpoints for:</p>
</li>
<li>
<p>find: query by criteria (filters, pagination)</p>
</li>
<li>
<p>get: fetch by id or refName</p>
</li>
<li>
<p>list: list all within scope with paging</p>
</li>
<li>
<p>save: create</p>
</li>
<li>
<p>update: modify existing</p>
</li>
<li>
<p>delete: delete or soft-delete/archival depending on model</p>
</li>
<li>
<p>UIActionList: derive available actions based on current model state.</p>
</li>
<li>
<p>DataDomain filtering is applied across all operations to enforce multi-tenancy.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_resource">24. Example Resource</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authorization_layers_in_rest_crud">25. Authorization Layers in REST CRUD</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum combines static, identity-based checks with dynamic, domain-aware policy evaluation. In practice you will often use both:</p>
</div>
<div class="paragraph">
<p>1) Hard-coded permissions via annotations</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use standard Jakarta annotations like @RolesAllowed (or the framework’s @RoleAllow if present) on resource classes or methods to declare role-based checks that must pass before executing an endpoint.</p>
</li>
<li>
<p>These checks are fast and decisive. They rely on the caller’s roles as established by the current SecurityIdentity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">jakarta.annotation.security.RolesAllowed</span>;

<span class="annotation">@RolesAllowed</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">ADMIN</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">CATALOG_EDITOR</span><span class="delimiter">&quot;</span></span>})
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Only ADMIN or CATALOG_EDITOR can access all inherited CRUD endpoints</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) JWT groups and role mapping</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When using the JWT provider, the token’s groups/roles claims are mapped into the Quarkus SecurityIdentity (see the Authentication guide).</p>
</li>
<li>
<p>Groups in JWT typically become roles on SecurityIdentity; these roles are what @RolesAllowed/@RoleAllow checks evaluate.</p>
</li>
<li>
<p>You can augment or transform roles using a SecurityIdentityAugmentor (see RolesAugmentor in the framework) to add derived roles based on claims or external lookups.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>3) RuleContext layered authorization (dynamic policies)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>After annotation checks pass, RuleContext evaluates domain-aware permissions. This layer can:</p>
</li>
<li>
<p>Enforce DataDomain scoping (tenant/org/owner)</p>
</li>
<li>
<p>Allow cross-tenant reads for specific functional areas when policy permits</p>
</li>
<li>
<p>Contribute query predicates and projections to repositories</p>
</li>
<li>
<p>Think of @RolesAllowed/@RoleAllow as the coarse-grained gate, and RuleContext as the fine-grained, context-sensitive policy engine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>4) Quarkus SecurityIdentity and SecurityFilter</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus produces a SecurityIdentity for each request containing principal name and roles.</p>
</li>
<li>
<p>The framework’s SecurityFilter inspects the incoming request (e.g., JWT) and populates/augments the SecurityIdentity and the derived DomainContext used by RuleContext and repositories.</p>
</li>
<li>
<p>BaseResource and underlying repos (e.g., MorphiaRepo) consume SecurityIdentity/DomainContext to apply permissions and filters consistently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For detailed rule-base matching (URL, headers, body predicates, priorities), see the Permissions section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_querying">26. Querying</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use query parameters or a request body (depending on your API convention) to express filters.</p>
</li>
<li>
<p>RuleContext contributes tenant-aware filters and projections automatically.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_responses_and_schemas">27. Responses and Schemas</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Models are returned with calculated fields (e.g., actionList) when appropriate.</p>
</li>
<li>
<p>OpenAPI annotations in your models/resources integrate with MicroProfile OpenAPI for schema docs.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_error_handling">28. Error Handling</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Validation errors (e.g., ImportRequiredField, Size) return helpful messages.</p>
</li>
<li>
<p>Rule-based denials return appropriate HTTP statuses (403/404) without leaking cross-tenant metadata.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_language_antlrbased">29. Query Language (ANTLR‑based)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The find/list endpoints accept a filter string parsed by an ANTLR grammar (BIAPIQuery.g4). Use the filter query parameter to express predicates; combine them with logical operators and grouping. Sorting and projection are separate query parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operators:</p>
</li>
<li>
<p>Equals: ':'</p>
</li>
<li>
<p>Not equals: ':!'</p>
</li>
<li>
<p>Less than/Greater than: ':&lt;' / ':&gt;'</p>
</li>
<li>
<p>Less‑than‑or‑equal/Greater‑than‑or‑equal: ':&#8656;' / ':&gt;='</p>
</li>
<li>
<p>Exists (field present): ':~' (no value)</p>
</li>
<li>
<p>In list: ':^' followed by [v1,v2,&#8230;&#8203;]</p>
</li>
<li>
<p>Boolean literals: true/false</p>
</li>
<li>
<p>Null literal: null</p>
</li>
<li>
<p>Logical:</p>
</li>
<li>
<p>AND: '&amp;&amp;'</p>
</li>
<li>
<p>OR: '||'</p>
</li>
<li>
<p>NOT: '!!' (applies to a single allowed expression)</p>
</li>
<li>
<p>Grouping: parentheses '(' and ')'</p>
</li>
<li>
<p>Values by type:</p>
</li>
<li>
<p>Strings: unquoted or quoted with "&#8230;&#8203;"; quotes allow spaces and punctuation</p>
</li>
<li>
<p>Whole numbers: prefix with '#' (e.g., #10)</p>
</li>
<li>
<p>Decimals: prefix with '<mark>' (e.g., </mark>19.99)</p>
</li>
<li>
<p>Date: yyyy-MM-dd (e.g., 2025-09-10)</p>
</li>
<li>
<p>DateTime (ISO‑8601): 2025-09-10T12:30:00Z (timezone supported)</p>
</li>
<li>
<p>ObjectId (Mongo 24‑hex): 5f1e9b9c8a0b0c0d1e2f3a4b</p>
</li>
<li>
<p>Reference by ObjectId: @@5f1e9b9c8a0b0c0d1e2f3a4b</p>
</li>
<li>
<p>Variables: ${ownerId|principalId|resourceId|action|functionalDomain|pTenantId|pAccountId|rTenantId|rAccountId|realm|area}</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_simple_filters_equals">29.1. Simple filters (equals)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># string equality
name:&quot;Acme Widget&quot;
# whole number
quantity:#10
# decimal number
price:##19.99
# date and datetime
shipDate:2025-09-12
updatedAt:2025-09-12T10:15:00Z
# boolean
active:true
# null checks
description:null
# field exists
lastLogin:~
# object id equality
id:5f1e9b9c8a0b0c0d1e2f3a4b
# variable usage (e.g., tenant scoping)
dataDomain.tenantId:${pTenantId}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_filters_grouping_and_andornot">29.2. Advanced filters: grouping and AND/OR/NOT</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Products that are active and (name contains widget OR gizmo), excluding discontinued
active:true &amp;&amp; (name:*widget* || name:*gizmo*) &amp;&amp; status:!&quot;DISCONTINUED&quot;

# Shipments updated after a date AND (destination NY OR CA)
updatedAt:&gt;=2025-09-01 &amp;&amp; (destination:&quot;NY&quot; || destination:&quot;CA&quot;)

# NOT example: items where category is not null and not (price &lt; 10)
category:!null &amp;&amp; !!(price:&lt;##10)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Wildcard matching uses '<strong>': name:*widget</strong> (prefix/suffix/contains). '?' matches a single character.
- Use parentheses to enforce precedence; otherwise AND/OR follow standard left‑to‑right with explicit operators.</p>
</div>
</div>
<div class="sect2">
<h3 id="_in_lists">29.3. IN lists</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>status:^[&quot;OPEN&quot;,&quot;CLOSED&quot;,&quot;ON_HOLD&quot;]
ownerId:^[&quot;u1&quot;,&quot;u2&quot;,&quot;u3&quot;]
referenceId:^[@@5f1e9b9c8a0b0c0d1e2f3a4b, @@6a7b8c9d0e1f2a3b4c5d6e7f]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sorting">29.4. Sorting</h3>
<div class="paragraph">
<p>Provide a sort query parameter (comma‑separated fields):
- '-' prefix = descending, '+' or no prefix = ascending.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># single field descending
?sort=-createdAt

# multiple fields: createdAt desc, refName asc
?sort=-createdAt,refName</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_projections">29.5. Projections</h3>
<div class="paragraph">
<p>Limit returned fields with the projection parameter (comma‑separated):
- '+' prefix = include, '-' prefix = exclude.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># include only id and refName, exclude heavy fields
?projection=+id,+refName,-auditInfo,-persistentEvents</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_endtoend_examples">29.6. End‑to‑end examples</h3>
<div class="ulist">
<ul>
<li>
<p>GET /products/list?skip=0&amp;limit=50&amp;filter=active:true&amp;&amp;name:*widget*&amp;sort=-updatedAt&amp;projection=+id,+name,-auditInfo</p>
</li>
<li>
<p>GET /shipments/list?filter=(destination:"NY"||destination:"CA")&amp;&amp;updatedAt:&gt;=2025-09-01&amp;sort=origin</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These features integrate with RuleContext and DataDomain: your filter runs within the tenant/org scope derived from the security context; RuleContext may add further predicates or projections automatically.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_csv_export_and_import">30. CSV Export and Import</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These endpoints are inherited by every resource that extends BaseResource. They are mounted under the resource’s base path. For example, PolicyResource at /security/permission/policies exposes:
- GET /security/permission/policies/csv
- POST /security/permission/policies/csv
- POST /security/permission/policies/csv/session
- POST /security/permission/policies/csv/session/{sessionId}/commit
- DELETE /security/permission/policies/csv/session/{sessionId}
- GET /security/permission/policies/csv/session/{sessionId}/rows</p>
</div>
<div class="paragraph">
<p>Authorization and scoping:
- All CSV endpoints are protected by the same @RolesAllowed("user", "admin") checks as other CRUD operations.
- RuleContext filters and DataDomain scoping apply the same way as list/find; exports stream only what the caller may see, and imports are saved under the same permissions.
- In multi‑realm deployments, include your X-Realm header as you do for CRUD; underlying repos resolve realm and domain context consistently.</p>
</div>
<div class="sect2">
<h3 id="_export_get_csv">30.1. Export: GET /csv</h3>
<div class="paragraph">
<p>Produces a streamed CSV download of the current resource collection.</p>
</div>
<div class="paragraph">
<p>Query parameters and behavior:
- fieldSeparator (default ",")
  - Single character used to separate fields. Typical values: , ; \t
- requestedColumns (default refName)
  - Comma‑separated list of model field names to include, in output order. If omitted, BaseResource defaults to refName.
  - Nested list extraction is supported with the [0] notation on a single nested property across all requested columns (e.g., addresses[0].city, addresses[0].zip). Indices other than [0] are rejected. If the nested list has multiple items, multiple rows are emitted per record (one per list element), preserving other column values.
- quotingStrategy (default QUOTE_WHERE_ESSENTIAL)
  - QUOTE_WHERE_ESSENTIAL: quote only when needed (when a value contains the separator or quoteChar).
  - QUOTE_ALL_COLUMNS: quote every column in every row.
- quoteChar (default ")
  - The character used to surround quoted values.
- decimalSeparator (default .)
  - Reserved for decimal formatting. Note: current implementation ignores this value; decimals are rendered using the locale‑independent dot.
- charsetEncoding (default UTF-8-without-BOM)
  - One of: US-ASCII, UTF-8-without-BOM, UTF-8-with-BOM, UTF-16-with-BOM, UTF-16BE, UTF-16LE.
  - “with-BOM” values write a Byte Order Mark at the beginning of the file (UTF‑8: EF BB BF; UTF‑16: FE FF).
- filter (optional)
  - ANTLR DSL filter applied server‑side before streaming (see Query Language section). Reduces rows and can improve performance.
- filename (default downloaded.csv)
  - Suggested download filename returned via Content‑Disposition header.
- offset (default 0)
  - Zero‑based index of the first record to stream.
- length (default 1000, use -1 for all)
  - Maximum number of records to stream from offset. Use -1 to stream all (be mindful of client memory/time).
- prependHeaderRow (optional boolean, default false)
  - When true, the first row contains column headers. Requires requestedColumns to be set (the default refName satisfies this requirement).
- preferredColumnNames (optional list)
  - Overrides header names positionally when prependHeaderRow=true. The list length must be ≤ requestedColumns; an empty string entry means “use default field name” for that column.</p>
</div>
<div class="paragraph">
<p>Response:
- 200 OK with Content-Type: text/csv and Content-Disposition: attachment; filename="&#8230;&#8203;".
- On validation/processing errors, the response status is 400/500 and the body contains a single text line describing the problem (e.g., “Incorrect information supplied: …”). Unrecognized query parameters are rejected with 400.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Export selected fields with header, custom filename and filter</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: system-com&quot; \
     &quot;https://host/api/products/csv?requestedColumns=id,refName,price&amp;prependHeaderRow=true&amp;filename=products.csv&amp;filter=active:true&amp;sort=+refName&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Export nested list’s first element across columns</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># emits one row per address entry when more than one is present
curl -H &quot;Authorization: Bearer $JWT&quot; \
     &quot;https://host/api/customers/csv?requestedColumns=refName,addresses[0].city,addresses[0].zip&amp;prependHeaderRow=true&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_import_post_csv_multipart">30.2. Import: POST /csv (multipart)</h3>
<div class="paragraph">
<p>Consumes a CSV file (multipart/form‑data) and imports records in batches. The form field name for the file is file.</p>
</div>
<div class="paragraph">
<p>Query parameters and behavior:
- fieldSeparator (default ",")
  - Single character expected between fields.
- quotingStrategy (default QUOTE_WHERE_ESSENTIAL)
  - Same values as export; controls how embedded quotes are recognized.
- quoteChar (default ")
  - The expected quote character in the file.
- skipHeaderRow (default true)
  - When true, the first row is treated as a header and skipped. Mapping is positional, not by header names.
- charsetEncoding (default UTF-8-without-BOM)
  - The file encoding. “with-BOM” variants allow consuming a BOM at the start.
- requestedColumns (required)
  - Comma‑separated list of model field names in the same order as the CSV columns. This positional mapping drives parsing and validation. Nested list syntax [0] is allowed with the same constraints as export.</p>
</div>
<div class="paragraph">
<p>Behavior:
- Each row is parsed into a model instance using type‑aware processors (ints, longs, decimals, enums, etc.).
- Bean Validation is applied; rows with violations are collected as errors and not saved; valid rows are batched and saved.
- For each saved batch, insert vs update is determined by refName presence in the repository.
- Response entity includes counts (importedCount, failedCount) and per‑row results when available.
- Response headers:
  - X-Import-Success-Count: number of rows successfully imported.
  - X-Import-Failed-Count: number of rows that failed validation or DB write.
  - X-Import-Message: summary message.</p>
</div>
<div class="paragraph">
<p>Example (direct import):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;X-Realm: system-com&quot; \
  -F &quot;file=@policies.csv&quot; \
  &quot;https://host/api/security/permission/policies/csv?requestedColumns=refName,principalId,description&amp;skipHeaderRow=true&amp;fieldSeparator=,&amp;quoteChar=\&quot;&amp;quotingStrategy=QUOTE_WHERE_ESSENTIAL&amp;charsetEncoding=UTF-8-without-BOM&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_import_with_preview_sessions">30.3. Import with preview sessions</h3>
<div class="paragraph">
<p>Use a two‑step flow to analyze first, then commit only valid rows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POST /csv/session (multipart): analyzes the file and creates a session</p>
</li>
<li>
<p>Same parameters as POST /csv (fieldSeparator, quotingStrategy, quoteChar, skipHeaderRow, charsetEncoding, requestedColumns).</p>
</li>
<li>
<p>Returns a preview ImportResult including sessionId, totals (totalRows, validRows, errorRows), and row‑level findings. No data is saved yet.</p>
</li>
<li>
<p>POST /csv/session/{sessionId}/commit: imports only error‑free rows from the analyzed session</p>
</li>
<li>
<p>Returns CommitResult with inserted/updated counts.</p>
</li>
<li>
<p>DELETE /csv/session/{sessionId}: cancels and discards session state (idempotent; always returns 204).</p>
</li>
<li>
<p>GET /csv/session/{sessionId}/rows: page through analyzed rows</p>
</li>
<li>
<p>Query params:</p>
</li>
<li>
<p>skip (default 0), limit (default 50)</p>
</li>
<li>
<p>onlyErrors (default false): when true, returns only rows with errors</p>
</li>
<li>
<p>intent (optional): filter rows by intended action: INSERT, UPDATE, or SKIP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes and constraints:
- requestedColumns must reference actual model fields. Unknown fields or multiple different nested properties are rejected (only one nested property across requestedColumns is allowed when using [0]).
- Unrecognized query parameters are rejected with HTTP 400 to prevent silent misconfiguration.
- Very large exports should prefer streaming with sensible length settings or server‑side filters to reduce memory and time.
- Imports run under the same security rules as POST / (save). Ensure the caller has permission to create/update the target entities in the chosen realm.</p>
</div>
</div>
</div>
</div>
<h1 id="migrations" class="sect0">Database Migrations and Index Management</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This guide explains Quantum’s MongoDB migration subsystem (quantum-morphia-repos), how migrations are authored and executed, and how to manage indexes. It also documents the REST APIs that trigger migrations and index operations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">31. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum uses a simple, versioned change‑set mechanism to evolve MongoDB schemas and seed data safely across realms (databases). Key building blocks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ChangeSetBean: a CDI bean describing one migration step with metadata (from/to version, priority, etc.) and an execute method.</p>
</li>
<li>
<p>ChangeSetBase: convenience base class you can extend; provides logging helpers and optional targeting controls.</p>
</li>
<li>
<p>MigrationService: discovers pending change sets, applies them in order within a transaction, records execution, and bumps the DatabaseVersion.</p>
</li>
<li>
<p>DatabaseVersion and ChangeSetRecord: stored in Mongo to track current schema version and previously executed change sets.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_semantic_versioning">32. Semantic Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Semantic Versioning (SemVer) expresses versions in the form MAJOR.MINOR.PATCH (for example, 1.4.2):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MAJOR: increment for incompatible/breaking schema changes.</p>
</li>
<li>
<p>MINOR: increment for backward‑compatible additions (new collections/fields that don’t break existing code).</p>
</li>
<li>
<p>PATCH: increment for backward‑compatible fixes or small adjustments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why this matters for migrations:
- Ordering: migrations must apply in a deterministic order that reflects real compatibility. SemVer provides a natural ordering and clear intent for authors and reviewers.
- Compatibility checks: the application can assert that the current database is “new enough” to run the code safely.</p>
</div>
<div class="paragraph">
<p>How semver4j is used:
- Parsing and validation: version strings are parsed into a SemVer object. Invalid strings fail fast during parsing, ensuring only compliant versions are stored and compared.
- Introspection and comparison: the parsed object exposes major/minor/patch components and supports comparisons, enabling safe ordering and “greater than / less than” checks.
- Consistent string form: the canonical string is retained for display, logs, and API responses.</p>
</div>
<div class="paragraph">
<p>How DatabaseVersion leverages SemVer:
- Single source of truth: DatabaseVersion stores the canonical SemVer string alongside a parsed SemVer object for logic and comparisons.
- Efficient ordering: for fast sorting and tie‑breaking, DatabaseVersion also keeps a compact integer encoding of MAJOR.MINOR.PATCH as (major*100) + (minor*10) + patch (e.g., 1.0.3 → 103). This makes numeric comparisons straightforward while still recording the exact SemVer string.
- Migration flow: when migrations run, successful execution records the new database version in DatabaseVersion. Startup checks compare the stored version to the required quantum.database.version to prevent the app from running against an older, incompatible schema.</p>
</div>
<div class="paragraph">
<p>Recommendations:
- Always bump MAJOR for breaking data changes, MINOR for additive changes, and PATCH for backward‑compatible fixes.
- Keep change sets small and target a single to‑version per change set to make intent clear.
- Use SemVer consistently in getDbFromVersion/getDbToVersion across all change sets so ordering and compatibility checks remain reliable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">33. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following MicroProfile config properties influence migrations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum.database.version: target version the application requires (SemVer, e.g., 1.0.3). MigrationService.checkDataBaseVersion compares this to the stored version.</p>
</li>
<li>
<p>quantum.database.migration.enabled: feature flag checked by resources/services when running migrations. Default: true.</p>
</li>
<li>
<p>quantum.database.migration.changeset.package: package containing change sets (CDI still discovers beans via type, but this property documents the intended package).</p>
</li>
<li>
<p>quantum.realmConfig.systemRealm, quantum.realmConfig.defaultRealm, quantum.realmConfig.testRealm: well‑known realms used by MigrationResource when running migrations across environments.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_change_sets_are_discovered_and_executed">34. How change sets are discovered and executed</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Discovery: MigrationService#getAllChangeSetBeans locates all CDI beans implementing ChangeSetBean.</p>
</li>
<li>
<p>Ordering: change sets are sorted by dbToVersionInt, then by priority (ascending). That ensures lower target versions apply before higher ones; priority resolves ties.</p>
</li>
<li>
<p>Pending selection: For the target realm, MigrationService#getAllPendingChangeSetBeans compares each change set’s dbToVersion against the stored DatabaseVersion and ignores already executed ones (tracked in ChangeSetRecord).</p>
</li>
<li>
<p>Locking: A distributed lock (Mongo‑backed Sherlock) is acquired per realm before applying change sets to prevent concurrent execution.</p>
</li>
<li>
<p>Transactions: Each change set runs within a MorphiaSession transaction; on success the change is recorded in ChangeSetRecord and DatabaseVersion is advanced (if higher). On failure the transaction is aborted and the error returned.</p>
</li>
<li>
<p>Realms: Migrations run per realm (Mongo database). A change set can optionally be restricted to certain database names or even override the realm it executes against (see below).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authoring_a_change_set">35. Authoring a change set</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Implement ChangeSetBean; most change sets extend ChangeSetBase.</p>
</div>
<div class="paragraph">
<p>Required metadata methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getId(): a string id for human tracking (e.g., 00003)</p>
</li>
<li>
<p>getDbFromVersion() / getDbFromVersionInt(): previous version you are migrating from (SemVer and an int like 102 for 1.0.2)</p>
</li>
<li>
<p>getDbToVersion() / getDbToVersionInt(): target version after running this change (SemVer and int)</p>
</li>
<li>
<p>getPriority(): integer priority when multiple change sets have same toVersion</p>
</li>
<li>
<p>getAuthor(), getName(), getDescription(), getScope(): informational fields recorded in ChangeSetRecord</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Execution method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>void execute(MorphiaSession session, MongoClient mongoClient, MultiEmitter&lt;? super String&gt; emitter)</p>
</li>
<li>
<p>Perform your data/index changes using the provided session (transaction).</p>
</li>
<li>
<p>Use emitter.emit("message") to stream log lines back to SSE clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optional targeting controls (provided by ChangeSetBase):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boolean isOverrideDatabase(): return true to execute against a specific database instead of the requested realm.</p>
</li>
<li>
<p>String getOverrideDatabaseName(): the concrete database name to use when overriding.</p>
</li>
<li>
<p>Set&lt;String&gt; getApplicableDatabases(): return a set of database names to which this change set should apply. Return null or an empty set to allow all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Logging helper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ChangeSetBase.log(String, MultiEmitter) emits to both Quarkus log and the SSE stream.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_change_sets_in_the_framework">36. Example change sets in the framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Package: com.e2eq.framework.model.persistent.morphia.changesets</p>
</div>
<div class="ulist">
<ul>
<li>
<p>InitializeDatabase</p>
</li>
<li>
<p>Seeds foundational data in a new realm: counters (e.g., accountNumber), system Organization and Account, initial Rule and Policy scaffolding, default user profiles and security model. Uses EnvConfigUtils and SecurityUtils to derive system DataDomain and defaults.</p>
</li>
<li>
<p>AddAnonymousSecurityRules</p>
</li>
<li>
<p>Adds a defaultAnonymousPolicy with an allow rule for unauthenticated actions such as registration and contact‑us in the website area.</p>
</li>
<li>
<p>AddRealms</p>
</li>
<li>
<p>Creates the system and default Realm records based on configuration, if missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are typical examples of idempotent change sets that can be safely re‑evaluated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest_apis_to_trigger_migrations_migrationresource">37. REST APIs to trigger migrations (MigrationResource)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Base path: /system/migration</p>
</div>
<div class="paragraph">
<p>Security: Most endpoints require admin role; dbversion is PermitAll for introspection.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /system/migration/dbversion/{realm}</p>
</li>
<li>
<p>Returns the current DatabaseVersion document for the given realm, or 404 if not found.</p>
</li>
<li>
<p>Example:
curl -s <a href="http://localhost:8080/system/migration/dbversion/system-com" class="bare">http://localhost:8080/system/migration/dbversion/system-com</a></p>
</li>
<li>
<p>POST /system/migration/indexes/applyIndexes/{realm}</p>
</li>
<li>
<p>Admin only. Calls MigrationService.applyIndexes(realm) which invokes Morphia Datastore.applyIndexes() for all mapped entities. Use this after adding @Indexed annotations.</p>
</li>
<li>
<p>Example:
curl -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/indexes/applyIndexes/system-com" class="bare">http://localhost:8080/system/migration/indexes/applyIndexes/system-com</a></p>
</li>
<li>
<p>POST /system/migration/indexes/dropAllIndexes/{realm}</p>
</li>
<li>
<p>Admin only. Drops all indexes on all mapped collections in the realm. Useful before re‑creation or when changing index definitions.</p>
</li>
<li>
<p>Example:
curl -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/indexes/dropAllIndexes/system-com" class="bare">http://localhost:8080/system/migration/indexes/dropAllIndexes/system-com</a></p>
</li>
<li>
<p>POST /system/migration/initialize/{realm}</p>
</li>
<li>
<p>Admin only. Server‑Sent Events (SSE) stream that executes all pending change sets for the specific realm.</p>
</li>
<li>
<p>Example (note -N to keep connection open):
curl -N -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/initialize/system-com" class="bare">http://localhost:8080/system/migration/initialize/system-com</a></p>
</li>
<li>
<p>GET /system/migration/start</p>
</li>
<li>
<p>Admin only. SSE stream that runs pending change sets across test, system, and default realms from configuration.</p>
</li>
<li>
<p>Example:
curl -N -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/start" class="bare">http://localhost:8080/system/migration/start</a></p>
</li>
<li>
<p>GET /system/migration/start/{realm}</p>
</li>
<li>
<p>Admin only. SSE for a specific realm.</p>
</li>
<li>
<p>Example:
curl -N -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/start/my-realm" class="bare">http://localhost:8080/system/migration/start/my-realm</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SSE responses stream human‑readable messages produced by MigrationService and your change sets. The connection ends with "Task completed" or an error message.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_perentity_index_management_baseresource">38. Per‑entity index management (BaseResource)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every entity resource that extends BaseResource&lt;T, R extends BaseMorphiaRepo&lt;T&gt;&gt; exposes a convenience endpoint to (re)create indexes for a single collection in a realm.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POST &lt;entity‑resource‑base‑path&gt;/indexes/ensureIndexes/{realm}?collectionName=&lt;collection&gt;</p>
</li>
<li>
<p>Admin only. Invokes R.ensureIndexes(realm, collectionName).</p>
</li>
<li>
<p>Use this when you want to reapply indexes for one collection without touching others.</p>
</li>
<li>
<p>Example (assuming a ProductResource at /products):
curl -X POST -H "Authorization: Bearer $TOKEN" \
     "http://localhost:8080/products/indexes/ensureIndexes/system-com?collectionName=product"</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_global_index_management_migrationservice">39. Global index management (MigrationService)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MigrationService also exposes programmatic index utilities used by the MigrationResource endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applyIndexes(realm): calls Morphia Datastore.applyIndexes() for the realm.</p>
</li>
<li>
<p>dropAllIndexes(realm): iterates mapped entities and drops indexes on each underlying collection.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validating_versions_at_startup">40. Validating versions at startup</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>MigrationService.checkDataBaseVersion() compares the stored DatabaseVersion in each well‑known realm to quantum.database.version and throws a DatabaseMigrationException when lower than required. This prevents the app from running against an incompatible schema.</p>
</li>
<li>
<p>MigrationService.checkInitialized(realm) is a convenience that asserts DatabaseVersion exists and is &gt;= required version; helpful for preflight checks.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notes_and_best_practices">41. Notes and best practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Make change sets idempotent: Always check for existing records before creating/updating indexes or documents.</p>
</li>
<li>
<p>Use SemVer consistently for from/to versions. The framework computes an integer form (e.g., 1.0.3 &#8594; 103) for ordering.</p>
</li>
<li>
<p>Prefer small, focused change sets with clear descriptions and authorship.</p>
</li>
<li>
<p>Use the MultiEmitter in execute(&#8230;&#8203;) to provide progress to operators consuming the SSE endpoint.</p>
</li>
<li>
<p>Apply new indexes with applyIndexes after deploying models with new @Indexed annotations; optionally dropAllIndexes then applyIndexes when changing index definitions across the board.</p>
</li>
<li>
<p>Limit scope: use getApplicableDatabases() to constrain execution to specific databases, or isOverrideDatabase/getOverrideDatabaseName to target a different database when appropriate.
= Authentication and Authorization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum integrates with Quarkus security while providing a pluggable approach to authentication. The repository includes a JWT provider module to get started quickly and an extension surface to replace or complement it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jwt_provider">42. JWT Provider</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Module: quantum-jwt-provider</p>
</li>
<li>
<p>Purpose: Validate JWTs on incoming requests, populate the security principal, and surface tenant/org/user claims that feed DomainContext.</p>
</li>
<li>
<p>Configuration: Standard Quarkus/MicroProfile JWT properties plus custom claim mappings as needed for DataDomain.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pluggable_authentication">43. Pluggable Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can introduce alternative authentication mechanisms (e.g., API keys, SAML/OIDC front-channel tokens exchanged for back-end JWTs, HMAC signatures) by providing CDI beans that integrate with the security layer and emit the same normalized context consumed by DomainContext/RuleContext.</p>
</div>
<div class="paragraph">
<p>Typical steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement a request filter or identity provider that validates the token/credential.</p>
</li>
<li>
<p>Map identity and tenant claims into a principal model (tenantId, orgRefName, userId, roles).</p>
</li>
<li>
<p>Ensure BaseResource (and other entry points) can derive DomainContext from that principal.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference">44. Creating an Auth Plugin (using the Custom JWT provider as a reference)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An auth plugin is typically a CDI bean that:
- Extends BaseAuthProvider to inherit user-management helpers and persistence utilities.
- Implements AuthProvider to integrate with request-time authentication flows.
- Implements UserManagement to expose CRUD-style operations for users, passwords, and roles.</p>
</div>
<div class="paragraph">
<p>A concrete provider should:
- Be annotated as a CDI bean (e.g., @ApplicationScoped).
- Provide a stable getName() identifier (e.g., "custom", "oidc", "apikey").
- Use config properties for secrets, issuers, token durations, and any external identity provider details.
- Build a Quarkus SecurityIdentity with the authenticated principal and roles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authprovider_interface_what_a_provider_must_implement">45. AuthProvider interface (what a provider must implement)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Core methods:
- SecurityIdentity validateAccessToken(String token)
  - Parse and validate the incoming credential (JWT, API key, signature).
  - Return a SecurityIdentity with principal name and roles. Throw a security exception for invalid tokens.
- String getName()
  - A short identifier for the provider. Persisted alongside credentials and used in logs/metrics.
- LoginResponse login(String userId, String password)
  - Credential-based login. Return a structured response:
    - positiveResponse: includes SecurityIdentity, roles, accessToken, refreshToken, expirationTime, and realm/mongodbUrl if applicable.
    - negativeResponse: includes error codes/reason/message for clients to act on (e.g., password change required).
- LoginResponse refreshTokens(String refreshToken)
  - Validate the refresh token, mint a new access token (and optionally a new refresh token), and return a positive response.</p>
</div>
<div class="paragraph">
<p>Notes:
- Login flow should check force-change-password or equivalent flags and return a negative response when user interaction is required before issuing tokens.
- validateAccessToken should only accept valid, non-expired tokens and construct SecurityIdentity consistently with role mappings used across the platform.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usermanagement_interface_operations_your_plugin_must_support">46. UserManagement interface (operations your plugin must support)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Typical responsibilities include:
- User lifecycle
  - String createUser(String userId, String password, Set&lt;String&gt; roles, DomainContext domainContext, [optional] DataDomain)
  - void changePassword(String userId, String oldPassword, String newPassword, Boolean forceChangePassword)
  - boolean removeUserWithUserId(String userId)
  - boolean removeUserWithSubject(String subject)
- Role management
  - void assignRolesForUserId(String userId, Set&lt;String&gt; roles)
  - void assignRolesForSubject(String subject, Set&lt;String&gt; roles)
  - void removeRolesForUserId(String userId, Set&lt;String&gt; roles)
  - void removeRolesForSubject(String subject, Set&lt;String&gt; roles)
  - Set&lt;String&gt; getUserRolesForUserId(String userId)
  - Set&lt;String&gt; getUserRolesForSubject(String subject)
- Lookups and existence checks
  - Optional&lt;String&gt; getSubjectForUserId(String userId)
  - Optional&lt;String&gt; getUserIdForSubject(String subject)
  - boolean userIdExists(String userId)
  - boolean subjectExists(String subject)</p>
</div>
<div class="paragraph">
<p>Return values and exceptions:
- Throw SecurityException or domain-specific exceptions for invalid states (duplicate users, bad password, unsupported hashing).
- Return Optional for lookups that may not find a result.
- For removals, return boolean to communicate whether a record was deleted.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_leveraging_baseauthprovider_in_your_plugin">47. Leveraging BaseAuthProvider in your plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you extend BaseAuthProvider, you inherit ready-to-use capabilities that reduce boilerplate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Impersonation controls</p>
</li>
<li>
<p>enableImpersonationWithUserId / enableImpersonationWithSubject</p>
</li>
<li>
<p>disableImpersonationWithUserId / disableImpersonationWithSubject</p>
</li>
<li>
<p>These set or clear an impersonation filter script and realm regex that downstream services can honor to act on behalf of another identity under controlled scope.</p>
</li>
<li>
<p>Realm override helpers</p>
</li>
<li>
<p>enableRealmOverrideWithUserId / enableRealmOverrideWithSubject</p>
</li>
<li>
<p>disableRealmOverrideWithUserId / disableRealmOverrideWithSubject</p>
</li>
<li>
<p>Useful for multi-realm/tenant scenarios, enabling scoped cross-realm behavior.</p>
</li>
<li>
<p>Persistence utilities</p>
</li>
<li>
<p>Built-in use of the credential repository to save, update, and delete credentials.</p>
</li>
<li>
<p>Consistent validation of inputs (non-null checks, non-blank checks).</p>
</li>
<li>
<p>Hashing algorithm guardrails to ensure only supported algorithms are used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Best practices when deriving:
- Always set the auth provider name in stored credentials so records can be traced to the correct provider.
- Reuse the role merge/remove patterns to avoid accidental role loss.
- Prefer emitting precise exceptions (e.g., NotFound for missing users, SecurityException for access violations).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_your_own_provider">48. Implementing your own provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Checklist:
- Class design
  - @ApplicationScoped bean
  - extends BaseAuthProvider
  - implements AuthProvider and UserManagement
  - return a stable getName()
- Configuration
  - Externalize secrets (signing keys), issuers, token durations, and realm details via MicroProfile Config.
- SecurityIdentity
  - Consistently build identities with principal and roles; include useful attributes for auditing/telemetry.
- Tokens/credentials
  - For JWT-like tokens, implement robust parsing, signature verification, expiration checks, and claim validation.
  - For non-JWT credentials (API keys, HMAC), ensure replay protection and scope binding.
- Responses and errors
  - Use structured LoginResponse for both success and error paths.
  - Prefer idempotent user/role operations; validate inputs and surface actionable messages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_credentialuseridpassword_model_and_domaincontext">49. CredentialUserIdPassword model and DomainContext</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section explains how user credentials are represented, how those records tie to tenancy and realms, and how the server chooses the database (“realm”) for REST calls.</p>
</div>
<div class="paragraph">
<p>What the credential model represents
- userId: The human-friendly login handle that users type. Must be unique within the applicable tenancy/realm scope.
- subject: A stable, system-generated identifier for the principal. Tokens and internal references favor subject over userId because subjects do not change.
- description, emailOfResponsibleParty: Optional metadata to describe the credential and provide an owner contact.
- domainContext: The tenancy and organization placement of the principal. It contains:
  - tenantId: Logical tenant partition.
  - orgRefName: Organization/business unit within the tenant.
  - accountId: Account or billing identifier.
  - defaultRealm: The default database/realm used for this identity’s operations.
  - dataSegment: Optional partitioning segment for advanced sharding or data slicing.
- roles: The set of authorities granted (e.g., USER, ADMIN). These become groups/roles on the SecurityIdentity.
- issuer: An identifier for who issued the credential or tokens (useful for auditing and multi-provider setups).
- passwordHash, hashingAlgorithm: The stored password hash and declared algorithm. Not exposed over REST. Providers verify passwords against this.
- forceChangePassword: Flag that forces a password reset on next login; the login flow returns a structured negative response instead of tokens.
- lastUpdate: Timestamp for auditing and token invalidation strategies.
- area2RealmOverrides: Optional map to route specific functional areas to different realms than the default (e.g., “Reporting” → analytics-realm).
- realmRegEx: Optional regex to limit or override which realms this identity may act in; also used by impersonation/override flows.
- impersonateFilterScript: Optional script indicating the filter/scope applied during impersonation so actions are constrained.
- authProviderName: The name of the provider that owns this credential (e.g., “custom”, “oidc”), enabling multi-provider operations and audits.</p>
</div>
<div class="paragraph">
<p>How DomainContext selects the realm for REST calls
- For each authenticated request, the server derives or retrieves a DomainContext associated with the principal.
- The DomainContext.defaultRealm indicates which backing MongoDB database (“realm”) should be used by repositories for that request.
- If realm override features are enabled (e.g., through provider helpers or per-credential overrides), the system may route certain functional areas to alternate realms using area2RealmOverrides or validated by realmRegEx.
- The remainder of DomainContext (tenantId, orgRefName, accountId, dataSegment) is applied as scope constraints through permission rules and repository filters so reads and writes are automatically restricted to the correct tenant/org segment.</p>
</div>
<div class="paragraph">
<p>Typical flow
1) Login
   - A user authenticates with userId/password (or other mechanism).
   - On success, a token is returned alongside role information; the principal is associated with a DomainContext that includes the defaultRealm.
2) Subsequent REST calls
   - The token is validated; the server reconstructs SecurityIdentity and DomainContext.
   - Repositories choose the datastore for defaultRealm and enforce tenant/org filters using the DomainContext values.
   - If the request targets a functional area with a defined override, the operation may route to a different realm for that area alone.
3) UI implications
   - The client does not need to know which realm is selected; it simply calls the API. The server ensures the correct database is used based on DomainContext and any configured overrides.</p>
</div>
<div class="paragraph">
<p>Best practices
- Keep userId immutable once established; use subject for internal joins and token subjects.
- Always attach the correct DomainContext when creating users to avoid cross-tenant leakage.
- Use realm overrides deliberately for well-isolated areas (e.g., analytics, archiving) and document them for operators.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps">50. Quarkus OIDC out-of-the-box and integrating with common IdPs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus ships with first-class OpenID Connect (OIDC) support, enabling both service-to-service and browser-based logins.</p>
</div>
<div class="paragraph">
<p>What the Quarkus OIDC extension provides
- OIDC client and server-side adapters:
  - Authorization Code flow with PKCE for browser sign-in.
  - Bearer token authentication for APIs (validating access tokens on incoming requests).
  - Token propagation for downstream calls (forwarding or exchanging tokens).
- Token verification and claim mapping:
  - Validates issuer, audience, signature, expiration, and scopes.
  - Maps standard claims (sub, email, groups/roles) into the security identity.
- Multi-tenancy and configuration:
  - Supports multiple OIDC tenants via configuration, each with its own issuer, client id/secret, and flows.
- Logout and session support:
  - Front-channel and back-channel logout hooks depending on provider capabilities.</p>
</div>
<div class="paragraph">
<p>Integrating with common providers
- Works with providers like Keycloak, Auth0, Okta, Azure AD, Cognito, and enterprise IdPs exposing OIDC.
- Configure the issuer URL and client credentials. Quarkus discovers endpoints via the provider’s .well-known/openid-configuration.
- For roles/permissions, map provider groups/roles claims to your platform roles in the identity.</p>
</div>
<div class="paragraph">
<p>OIDC vs OAuth vs OpenID (terminology and evolution)
- OAuth 2.0:
  - Authorization framework for delegated access (scopes), not authentication. Defines flows to obtain access tokens for APIs.
- OpenID (OpenID 1.x/2.0):
  - Older federated identity protocol that preceded OIDC. It has been superseded by OpenID Connect.
- OpenID Connect (OIDC):
  - An identity layer on top of OAuth 2.0. Adds standardized authentication, user info endpoints, ID tokens (JWT) with subject and profile claims, and discovery metadata.
  - In practice, OIDC is the modern standard for SSO and user authentication; OAuth remains the authorization substrate underneath.
Summary:
- OpenID → historical, replaced by OIDC.
- OAuth 2.0 → authorization framework.
- OIDC → authentication (identity) layer built on OAuth 2.0.</p>
</div>
<div class="paragraph">
<p>OIDC and SAML in relation to SSO
- SAML (Security Assertion Markup Language):
  - XML-based federation protocol widely used in enterprises for browser SSO.
  - Uses signed XML assertions transported through browser redirects/posts.
- OIDC:
  - JSON/REST-oriented, uses JWTs, and is well-suited for modern SPAs and APIs.
- Relationship:
  - Both enable SSO and federation across identity providers and service providers.
  - Many enterprise IdPs support both; OIDC is generally simpler for APIs and modern web stacks, while SAML is entrenched in legacy/enterprise SSO.
- Bridging:
  - Gateways or identity brokers can translate SAML assertions to OIDC tokens and vice versa, allowing gradual migration.</p>
</div>
<div class="paragraph">
<p>Common customer IdP models and OIDC integration patterns
- Centralized IdP (single-tenant):
  - One organization-wide IdP issues tokens for all users.
  - Configure a single OIDC tenant in Quarkus; map groups/roles to application roles.
- Multi-tenant SaaS with per-tenant IdP:
  - Each customer brings their own IdP (BYOID).
  - Configure Quarkus OIDC multitenancy with per-tenant issuer discovery and client credentials.
  - Tenant selection can be based on domain, request header, or path; the selected OIDC tenant performs login and token validation.
- Brokered identity:
  - Use a broker (e.g., a central identity layer) that federates to multiple upstream IdPs (OIDC, SAML).
  - Quarkus integrates with the broker as a single OIDC client; the broker handles IdP routing and protocol translation.
- Hybrid API and web flows:
  - Browser apps use Authorization Code flow with sessions; APIs use bearer token authentication.
  - Quarkus OIDC extension can handle both in the same application when properly configured.</p>
</div>
<div class="paragraph">
<p>Best practices
- Prefer OIDC for new integrations; use SAML through a broker if enterprise constraints require it.
- Normalize roles/claims server-side so downstream authorization (RuleContext, repositories) sees consistent group names regardless of IdP.
- Use token exchange or client credentials for service-to-service calls; do not reuse end-user tokens where not appropriate.
- For multi-tenant OIDC, secure tenant resolution logic and validate issuer/tenant binding to prevent mix-ups.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authorization_via_rulecontext">51. Authorization via RuleContext</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication establishes identity; RuleContext enforces what the identity can do. For each action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE), RuleContext can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow or deny the action</p>
</li>
<li>
<p>Contribute additional filters (e.g., org scoping, functional-area specific sharing)</p>
</li>
<li>
<p>Adjust UIActionList to reflect permitted next steps</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This division of responsibilities keeps providers focused on identity while policies remain centralized in RuleContext.</p>
</div>
</div>
</div>
<h1 id="permissions" class="sect0">Permissions: Rule Bases, SecurityURLHeaders, and SecurityURLBody</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section explains how Quantum evaluates permissions for REST requests using rule bases that match on URL, HTTP method, headers, and request body content. It also covers how identities and roles (as found on userProfile or credentialUserIdPassword) are matched, how priority works, and how multiple matching rule bases are evaluated.</p>
</div>
<div class="paragraph">
<p>Note: The terms SecurityURLHeaders and SecurityURLBody in this document describe the matching dimensions for rules. Implementations may vary, but the semantics below are stable for authoring and reasoning about permissions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_key_concepts">52. Key Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Identity: The authenticated principal, typically originating from JWT or another provider. It includes:</p>
</li>
<li>
<p>userId (or credentialUserIdPassword username)</p>
</li>
<li>
<p>roles (authorities/groups)</p>
</li>
<li>
<p>tenantId, orgRefName, optional realm, and other claims that contribute to DomainContext</p>
</li>
<li>
<p>userProfile: A domain representation of the user that aggregates identity, roles, and policy decorations (feature flags, plans, expiration, etc.).</p>
</li>
<li>
<p>Rule Base (Permission Rule): A declarative rule with matching criteria and an effect (ALLOW or DENY). Criteria may include:</p>
</li>
<li>
<p>HTTP method and URL pattern</p>
</li>
<li>
<p>SecurityURLHeaders: predicates over selected HTTP headers (e.g., x-functional-area, x-functional-domain, x-tenant-id)</p>
</li>
<li>
<p>SecurityURLBody: predicates over request body fields (JSON paths) or query parameters</p>
</li>
<li>
<p>Required roles/attributes on identity or userProfile</p>
</li>
<li>
<p>Functional area/domain/action</p>
</li>
<li>
<p>Priority: integer used to sort rule evaluation</p>
</li>
<li>
<p>Effect: ALLOW or DENY; an ALLOW may also contribute scope filters (e.g., DataDomain constraints) to be applied downstream by repositories.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rule_structure_illustrative">53. Rule Structure (Illustrative)</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-public-reads</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">100</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[GET]</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">/api/catalog/**</span></span>
    <span class="key">headers</span>:
      <span class="key">x-functional-area</span>: <span class="string"><span class="content">[Catalog]</span></span>
    <span class="key">rolesAny</span>: <span class="string"><span class="content">[USER, ADMIN]</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">filters</span>:
    <span class="comment"># Optional: contribute additional DataDomain filters</span>
    <span class="key">readScope</span>: <span class="string"><span class="content">{ orgRefName: PUBLIC }</span></span>

- <span class="string"><span class="content">name: deny-non-admin-delete</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">10</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[DELETE]</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">/api/**</span></span>
  <span class="key">requireRolesAll</span>: <span class="string"><span class="content">[ADMIN]</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>

- <span class="string"><span class="content">name: default-deny</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">10000</span></span>
  <span class="key">match</span>: <span class="string"><span class="content">{}</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">DENY</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>headers under match are the SecurityURLHeaders predicates.</p>
</li>
<li>
<p>Body predicates (SecurityURLBody) can be expressed similarly as JSONPath-like constraints:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">  <span class="key">body</span>:
    <span class="error">$.dataDomain.tenantId</span>: <span class="error">${identity.tenantId}</span>
    <span class="error">$.action</span>: [<span class="error">CREATE, UPDATE]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_matching_algorithm">54. Matching Algorithm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given a request R and identity I, evaluate a set of rule bases RB as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Candidate selection</p>
<div class="ulist">
<ul>
<li>
<p>From RB, select all rules whose URL pattern and HTTP method match R.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Attribute and header/body checks</p>
<div class="ulist">
<ul>
<li>
<p>For each candidate, check:</p>
</li>
<li>
<p>SecurityURLHeaders: header predicates must all match (case-insensitive header names; values support exact string, regex, or one-of lists depending on rule authoring capability).</p>
</li>
<li>
<p>SecurityURLBody: if present, evaluate body predicates against parsed JSON body (or query params when body is absent). Predicates must all match.</p>
</li>
<li>
<p>Identity/UserProfile: role requirements and attribute requirements must be satisfied.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Priority sort</p>
<div class="ulist">
<ul>
<li>
<p>Sort matching candidates by ascending priority (lower numbers indicate higher precedence). If not specified, default priority is 1000.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Evaluation order and decision</p>
<div class="ulist">
<ul>
<li>
<p>Iterate in sorted order; the first rule that yields a decisive effect (ALLOW or DENY) becomes the decision.</p>
</li>
<li>
<p>If the rule is ALLOW and contributes filters (e.g., DataDomain read/write scope), attach those to the request context for downstream repositories.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multi-match aggregation (optional advanced mode)</p>
<div class="ulist">
<ul>
<li>
<p>In advanced configurations, if multiple ALLOW rules match at the same priority, their filters may be merged (intersection for restrictive scope, union for permissive scope) according to a configured merge strategy. If not configured, the default is first-match-wins.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Fallback</p>
<div class="ulist">
<ul>
<li>
<p>If no rules match decisively, apply a default policy (typically DENY).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_priorities">55. Priorities</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Lower integer = higher priority. Example: priority 1 overrides priority 10.</p>
</li>
<li>
<p>Use tight scopes with low priority for critical protections (e.g., denies), and broader ALLOWs with higher numeric priority.</p>
</li>
<li>
<p>Recommended ranges:</p>
</li>
<li>
<p>1–99: global deny rules and emergency blocks</p>
</li>
<li>
<p>100–499: domain/area-specific critical rules</p>
</li>
<li>
<p>500–999: standard ALLOW policies</p>
</li>
<li>
<p>1000+: defaults and catch-alls</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multiple_matching_rulebases">56. Multiple Matching RuleBases</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>First-match-wins (default): after sorting by priority, the first decisive rule determines the result; subsequent matches are ignored.</p>
</li>
<li>
<p>Merge strategy (optional):</p>
</li>
<li>
<p>When enabled and multiple ALLOW rules share the same priority, scopes/filters are merged.</p>
</li>
<li>
<p>Conflicts between ALLOW and DENY at the same priority resolve to DENY unless explicitly configured otherwise (fail-safe).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identity_and_role_matching">57. Identity and Role Matching</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>RolesAny: request is allowed if identity has at least one of the specified roles.</p>
</li>
<li>
<p>RolesAll: request requires all listed roles.</p>
</li>
<li>
<p>Attribute predicates can compare identity/userProfile attributes (e.g., identity.tenantId == header.x-tenant-id).</p>
</li>
<li>
<p>Time or plan-based conditions: userProfile can embed plan and expiration; rules may check that trials are active or features are enabled.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_scenarios">58. Example Scenarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1) Public catalog browsing
   - Request: GET /api/catalog/products?search=widgets
   - Headers: x-functional-area=Catalog
   - Identity: anonymous or role USER
   - Rules:
     - allow-public-reads (priority 100) ALLOW + readScope orgRefName=PUBLIC
   - Outcome: ALLOW; repository applies DataDomain filter orgRefName=PUBLIC</p>
</div>
<div class="paragraph">
<p>2) Tenant-scoped shipment update
   - Request: PUT /api/shipments/ABC123
   - Headers: x-functional-area=Collaboration, x-tenant-id=T1
   - Body: { dataDomain: { tenantId: "T1" }, &#8230;&#8203; }
   - Identity: user in tenant T1 with roles [USER]
   - Rules:
     - allow-collab-update (priority 300) requires body.dataDomain.tenantId == identity.tenantId and rolesAny USER, ADMIN &#8658; ALLOW
   - Outcome: ALLOW; Rule contributes writeScope tenantId=T1</p>
</div>
<div class="paragraph">
<p>3) Cross-tenant admin read with higher priority
   - Request: GET /api/partners
   - Identity: role ADMIN (super-admin)
   - Rules:
     - admin-override (priority 50) ALLOW
     - default-tenant-read (priority 600) ALLOW with tenant filter
   - Outcome: admin-override wins due to higher precedence (lower number), allowing broader read</p>
</div>
<div class="paragraph">
<p>4) Conflicting ALLOW and DENY at same priority
   - Two rules match with priority 200: one ALLOW, one DENY
   - Resolution: DENY wins unless merge strategy configured to handle explicitly; recommended to avoid same-priority conflicts by policy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operational_tips">59. Operational Tips</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Author specific DENY rules with low numbers to prevent accidental exposure.</p>
</li>
<li>
<p>Keep URL patterns narrowly tailored for sensitive domains.</p>
</li>
<li>
<p>Prefer header/body predicates to refine matches without exploding URL patterns.</p>
</li>
<li>
<p>Log matched rule names and applied scopes for auditability.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_uiactions_and_defaultuiactions_are_calculated">60. How UIActions and DefaultUIActions are calculated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the server returns a collection of entities (for example, userProfiles), each entity may expose two action lists:
- DefaultUIActions: the full set of actions that conceptually apply to this type of entity (e.g., CREATE, UPDATE, VIEW, DELETE, ARCHIVE). Think of this as the “menu template” for the type.
- UIActions: the subset of actions the current user is actually permitted to perform on that specific entity instance right now.</p>
</div>
<div class="paragraph">
<p>Why they can differ per entity:
- Entity attributes: state or flags (e.g., archived, soft-deleted, immutable) can remove or alter available actions at instance level.
- Permission rule base: evaluated against the current request, identity, and context to allow or deny actions.
- DataDomain membership: tenant/org/owner scoping can further restrict actions if the identity is outside the entity’s domain.</p>
</div>
<div class="paragraph">
<p>How the server computes them:
1) Start with a default action template for the entity type (DefaultUIActions).
2) Apply simple state-based adjustments (e.g., suppress CREATE on already-persisted instances).
3) Evaluate the permission rules with the current identity and context:
   - Consider roles, functional area/domain, action intent, headers/body, and any rule-contributed scopes.
   - Resolve DataDomain constraints to ensure the identity is permitted to act within the entity’s domain.
4) Produce UIActions as the allowed subset for that entity instance.
5) Return both lists with each entity in collection responses.</p>
</div>
<div class="paragraph">
<p>How the client should use the two lists:
- Render the full DefaultUIActions as the visible set of possible actions (icons, buttons, menus) so the UI stays consistent.
- Enable only those actions present in UIActions; gray out or disable the remainder to signal capability but lack of current permission.
- This approach avoids flicker and keeps affordances discoverable while remaining truthful to the user’s current authorization.</p>
</div>
<div class="paragraph">
<p>Example:
- You fetch 25 userProfiles.
- DefaultUIActions for the type = [CREATE, VIEW, UPDATE, DELETE, ARCHIVE].
- For a specific profile A (owned by your tenant), UIActions may be [VIEW, UPDATE] based on your roles and domain.
- For another profile B (in a different tenant), UIActions may be [VIEW] only.
- The UI renders the same controls for both A and B, but only enables the actions present in each item’s UIActions list.</p>
</div>
<div class="paragraph">
<p>Operational considerations:
- Keep action names stable and documented so front-ends can map to icons and tooltips consistently.
- Prefer small, composable rules that evaluate action permissions explicitly by functional area/domain to avoid surprises.
- Consider server-side caching of action evaluations for list views to reduce latency, respecting identity and scope.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_this_integrates_end_to_end">61. How This Integrates End-to-End</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>BaseResource extracts identity and headers to construct DomainContext.</p>
</li>
<li>
<p>Rule evaluation uses URL/method + SecurityURLHeaders + SecurityURLBody + identity/userProfile to reach a decision and derive scope filters.</p>
</li>
<li>
<p>Repositories (e.g., MorphiaRepo) apply the filters to queries and updates, ensuring DataDomain-respecting access.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administering_policies_via_rest_policyresource">62. Administering Policies via REST (PolicyResource)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The PolicyResource exposes CRUD-style REST APIs for creating and managing policies (rule bases) that drive authorization decisions. Each Policy targets a principalId (either a specific userId or a role name) and contains an ordered list of Rule objects. Rules match requests using SecurityURIHeader and SecurityURIBody and then contribute an effect (ALLOW/DENY) and optional repository filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Base path: /security/permission/policies</p>
</li>
<li>
<p>Auth: Bearer JWT (see Authentication); resource methods are guarded by @RolesAllowed("user", "admin") at the BaseResource level and your own realm/role policies.</p>
</li>
<li>
<p>Multi-realm: pass X-Realm header to operate within a specific realm; otherwise the default realm is used.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_model_shape_policy">62.1. Model shape (Policy)</h3>
<div class="paragraph">
<p>A Policy extends FullBaseModel and includes:
- id, refName, displayName, dataDomain, archived/expired flags (inherited)
- principalId: userId or role name that this policy attaches to
- description: human-readable summary
- rules: array of Rule entries</p>
</div>
<div class="paragraph">
<p>Rule fields (key ones):
- name, description
- securityURI.header: identity, area, functionalDomain, action (supports wildcard "<strong>")
- securityURI.body: realm, orgRefName, accountNumber, tenantId, ownerId, dataSegment, resourceId (supports wildcard "</strong>")
- effect: ALLOW or DENY
- priority: integer; lower numbers evaluated first
- finalRule: boolean; stop evaluating when this rule applies
- andFilterString / orFilterString: ANTLR filter DSL snippets injected into repository queries (see Query Language section)</p>
</div>
<div class="paragraph">
<p>Example payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">defaultUserPolicy</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">displayName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default user policy</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">principalId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Users can act on their own data; deny dangerous ops in security area</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">rules</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">view-own-resources</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Limit reads to owner and default data segment</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">securityURI</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">identity</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">area</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">functionalDomain</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>:   { <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">accountNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ownerId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> }
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">andFilterString</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.ownerId:${principalId}&amp;&amp;dataDomain.dataSegment:#0</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">priority</span><span class="delimiter">&quot;</span></span>: <span class="integer">300</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">finalRule</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>
    },
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">deny-delete-in-security</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">securityURI</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">identity</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">area</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">security</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">functionalDomain</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span> },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>:   { <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">accountNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ownerId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> }
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DENY</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">priority</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">finalRule</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>
    }
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_endpoints">62.2. Endpoints</h3>
<div class="paragraph">
<p>All endpoints are relative to /security/permission/policies. These are inherited from BaseResource and are consistent across entity resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /list</p>
</li>
<li>
<p>Query params: skip, limit, filter, sort, projection</p>
</li>
<li>
<p>Returns a Collection&lt;Policy&gt; with paging metadata; respects X-Realm.</p>
</li>
<li>
<p>GET /id/{id} and GET /id?id=&#8230;&#8203;</p>
</li>
<li>
<p>Fetch a single Policy by id.</p>
</li>
<li>
<p>GET /refName/{refName} and GET /refName?refName=&#8230;&#8203;</p>
</li>
<li>
<p>Fetch a single Policy by refName.</p>
</li>
<li>
<p>GET /count?filter=&#8230;&#8203;</p>
</li>
<li>
<p>Returns a CounterResponse with total matching entities.</p>
</li>
<li>
<p>GET /schema</p>
</li>
<li>
<p>Returns JSON Schema for Policy.</p>
</li>
<li>
<p>POST /</p>
</li>
<li>
<p>Create or upsert a Policy (if id is present and matches an existing entity in the selected realm, it is updated).</p>
</li>
<li>
<p>PUT /set?id=&#8230;&#8203;&amp;pairs=field:value</p>
</li>
<li>
<p>Targeted field updates by id. pairs is a repeated query parameter specifying field/value pairs.</p>
</li>
<li>
<p>PUT /bulk/setByQuery?filter=&#8230;&#8203;&amp;pairs=&#8230;&#8203;</p>
</li>
<li>
<p>Bulk updates by query. Note: ignoreRules=true is not supported on this endpoint.</p>
</li>
<li>
<p>PUT /bulk/setByIds</p>
</li>
<li>
<p>Bulk updates by list of ids posted in the request body.</p>
</li>
<li>
<p>PUT /bulk/setByRefAndDomain</p>
</li>
<li>
<p>Bulk updates by a list of (refName, dataDomain) pairs in the request body.</p>
</li>
<li>
<p>DELETE /id/{id} (or /id?id=&#8230;&#8203;)</p>
</li>
<li>
<p>Delete by id.</p>
</li>
<li>
<p>DELETE /refName/{refName} (or /refName?refName=&#8230;&#8203;)</p>
</li>
<li>
<p>Delete by refName.</p>
</li>
<li>
<p>CSV import/export endpoints for bulk operations:</p>
</li>
<li>
<p>GET /csv – export as CSV (field selection, encoding, etc.)</p>
</li>
<li>
<p>POST /csv – import CSV into Policies</p>
</li>
<li>
<p>POST /csv/session – analyze CSV and create an import session (preview)</p>
</li>
<li>
<p>POST /csv/session/{sessionId}/commit – commit a previously analyzed session</p>
</li>
<li>
<p>DELETE /csv/session/{sessionId} – cancel a session</p>
</li>
<li>
<p>GET /csv/session/{sessionId}/rows – page through analyzed rows</p>
</li>
<li>
<p>Index management (admin only):</p>
</li>
<li>
<p>POST /indexes/ensureIndexes/{realm}?collectionName=policy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Headers:
- Authorization: Bearer &lt;token&gt;
- X-Realm: realm identifier (optional but recommended in multi-tenant deployments)</p>
</div>
<div class="paragraph">
<p>Filtering and sorting:
- filter uses the ANTLR-based DSL (see REST CRUD &gt; Query Language)
- sort uses comma-separated fields with optional +/- prefix; projection accepts a comma-separated field list</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples">62.3. Examples</h3>
<div class="ulist">
<ul>
<li>
<p>Create or update a Policy</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -H &quot;X-Realm: system-com&quot; \
  https://host/api/security/permission/policies \
  -d @policy.json</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List policies for principalId=user</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: system-com&quot; \
     &quot;https://host/api/security/permission/policies/list?filter=principalId:'user'&amp;sort=+refName&amp;limit=50&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete a policy by refName</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X DELETE \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;X-Realm: system-com&quot; \
  &quot;https://host/api/security/permission/policies/refName/defaultUserPolicy&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_changes_affect_rule_bases_and_enforcement">62.4. How changes affect rule bases and enforcement</h3>
<div class="ulist">
<ul>
<li>
<p>Persistence vs. in-memory rules:</p>
</li>
<li>
<p>PolicyResource updates the persistent store of policies (one policy per principalId or role with a list of rules).</p>
</li>
<li>
<p>RuleContext is the in-memory evaluator used by repositories and resources to enforce permissions. It matches SecurityURIHeader/Body, orders rules by priority, and applies effects and filters.</p>
</li>
<li>
<p>Making persisted policy changes effective:</p>
</li>
<li>
<p>On startup, migrations (see InitializeDatabase and AddAnonymousSecurityRules) typically seed default policies and/or programmatically add rules to RuleContext.</p>
</li>
<li>
<p>When you modify policies via REST, you have two options to apply them at runtime:
1) Implement a reload step that reads policies from PolicyRepo and rehydrates RuleContext (e.g., RuleContext.clear(); then add rules built from current policies).
2) Restart the service or trigger whatever policy-loader your application uses at boot.</p>
</li>
<li>
<p>Tip: If you maintain a background watcher or admin endpoint to refresh policies, keep it tenant/realm-aware and idempotent.</p>
</li>
<li>
<p>Evaluation semantics (recap):</p>
</li>
<li>
<p>Rules are sorted by ascending priority; the first decisive rule sets the outcome. finalRule=true stops further processing.</p>
</li>
<li>
<p>andFilterString/orFilterString contribute repository filters through RuleContext.getFilters(), constraining result sets and write scopes.</p>
</li>
<li>
<p>principalId can be a concrete userId or a role; RuleContext considers both the principal and all associated roles.</p>
</li>
<li>
<p>Safe rollout:</p>
</li>
<li>
<p>Create new policies with a higher numeric priority (lower precedence) first, test with GET /schema and dry-run queries.</p>
</li>
<li>
<p>Use realm scoping via X-Realm to stage changes in a non-production realm.</p>
</li>
<li>
<p>Prefer DENY with low priority numbers for critical protections.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also:
- Permissions: Matching Algorithm, Priorities, and Multiple Matching RuleBases (sections above)
- REST CRUD: Query Language and generic endpoint behaviors</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_realm_override_x_realm_and_impersonation_x_impersonate">63. Realm override (X-Realm) and Impersonation (X-Impersonate)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section explains how to use the request headers X-Realm and X-Impersonate-* alongside permission rule bases. These headers influence which realm (database) a request operates against and, in the case of impersonation, which identity’s roles are evaluated by the rule engine.</p>
</div>
<div class="sect2">
<h3 id="_what_they_do_at_a_glance">63.1. What they do (at a glance)</h3>
<div class="ulist">
<ul>
<li>
<p>X-Realm: Overrides the target realm (MongoDB database) used by repositories for this request. Your own identity and roles remain the same; only the data context (tenant/realm) changes for this call. This lets you “switch tenants” at the database level in deployments that use the one-tenant-per-database model.</p>
</li>
<li>
<p>X-Impersonate-Subject or X-Impersonate-UserId: Causes the request to run as another identity. The effective permissions become those of the impersonated identity (potentially more or less than your own). This is analogous to sudo on Unix or to “simulate a user/role” for troubleshooting.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Only one of X-Impersonate-Subject or X-Impersonate-UserId may be supplied per request. Supplying both results in a 400/IllegalArgumentException.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_the_headers_integrate_with_permission_evaluation">63.2. How the headers integrate with permission evaluation</h3>
<div class="ulist">
<ul>
<li>
<p>Rule matching and effects (ALLOW/DENY) still follow the standard algorithm described earlier.</p>
</li>
<li>
<p>With X-Realm (no impersonation):</p>
</li>
<li>
<p>The PrincipalContext.defaultRealm is set to the header value (after validation), and repositories operate in that realm.</p>
</li>
<li>
<p>Your own roles and identity remain intact; the rule base is evaluated for your identity and roles but in the specified realm’s data context.</p>
</li>
<li>
<p>With impersonation:</p>
</li>
<li>
<p>The PrincipalContext is rebuilt from the impersonated user’s credential. The effective roles used by the rule engine include the impersonated user’s roles; the platform also merges in the caller’s security roles from Quarkus SecurityIdentity. This means permissions can be a superset; design policy rules accordingly.</p>
</li>
<li>
<p>The effective realm for the request is set to the impersonated user’s default realm (not the X-Realm header). If you passed X-Realm, it is still validated (see below) but not used to override the impersonated default realm in the current implementation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_required_credential_configuration_credentialuseridpassword">63.3. Required credential configuration (CredentialUserIdPassword)</h3>
<div class="paragraph">
<p>Two fields on CredentialUserIdPassword govern whether a user may use these headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>realmRegEx (for X-Realm):</p>
</li>
<li>
<p>A wildcard pattern ("*" matches any sequence; case-insensitive) listing the realms a user is allowed to target with X-Realm.</p>
</li>
<li>
<p>If X-Realm is present but realmRegEx is null/blank or does not match the requested realm, the server returns 403 Forbidden.</p>
</li>
<li>
<p>Examples:</p>
</li>
<li>
<p>"*" → allow any realm</p>
</li>
<li>
<p>"acme-*" → allow realms that start with acme-</p>
</li>
<li>
<p>"dev|stage|prod" is not supported as-is; use wildcards like "dev*" and "stage*" or a combined pattern like "(dev|stage|prod)" only if you store a true regex. The current validator replaces '<strong>' with ".</strong>" and matches case-insensitively.</p>
</li>
<li>
<p>impersonateFilterScript (for X-Impersonate-*):</p>
</li>
<li>
<p>A JavaScript snippet executed by the server (GraalVM) that must return a boolean. It receives three variables: username (the caller’s subject), userId (caller’s userId), and realm (the requested realm or current DB name).</p>
</li>
<li>
<p>If the script evaluates to false, the server returns 403 Forbidden for impersonation.</p>
</li>
<li>
<p>If the script is missing (null) and you attempt impersonation, the server rejects the request with 400/IllegalArgumentException.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example impersonation script (allow only company admins to impersonate in dev realms):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// username = caller's subject, userId = caller's userId, realm = requested realm (or current)</span>
(username.endsWith(<span class="string"><span class="delimiter">'</span><span class="content">@acme.com</span><span class="delimiter">'</span></span>) &amp;&amp; realm.startsWith(<span class="string"><span class="delimiter">'</span><span class="content">dev-</span><span class="delimiter">'</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tip: Manage these two fields via your auth provider’s admin APIs or directly through CredentialRepo in controlled environments.</p>
</div>
</div>
<div class="sect2">
<h3 id="_end_to_end_behavior_from_securityfilter_reference">63.4. End-to-end behavior from SecurityFilter (reference)</h3>
<div class="paragraph">
<p>The SecurityFilter constructs the PrincipalContext/ResourceContext before rule evaluation:
- X-Realm is read and, if present, validated against the caller’s credential.realmRegEx.
- If impersonation headers are present:
  - The caller’s credential.impersonateFilterScript is executed. If it returns true, the impersonated user’s credential is loaded and used to build the PrincipalContext.
  - The final PrincipalContext carries the impersonated user’s defaultRealm and roles (merged with the caller’s SecurityIdentity roles), and may copy area2RealmOverrides from the impersonated credential.
- Without impersonation, the PrincipalContext is built from the caller’s credential; X-Realm, when valid, sets the defaultRealm for this request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_practical_differences_and_use_cases">63.5. Practical differences and use cases</h3>
<div class="ulist">
<ul>
<li>
<p>Realm override (X-Realm):</p>
</li>
<li>
<p>Who you are does not change; only where you act changes. Your permissions (as determined by policies attached to your identity/roles) are applied against data in the specified realm.</p>
</li>
<li>
<p>Use cases:</p>
</li>
<li>
<p>Multi-tenant admin tooling that needs to inspect or repair data in customer realms.</p>
</li>
<li>
<p>Reporting or backfills where the same service is pointed at different tenant databases per request.</p>
</li>
<li>
<p>Impersonation (X-Impersonate-*):</p>
</li>
<li>
<p>Who you are (for authorization purposes) changes. You act with the impersonated identity’s permissions; depending on your configuration, additional caller roles may be merged.</p>
</li>
<li>
<p>Use cases:</p>
</li>
<li>
<p>Temporary elevation to an admin identity (sudo-like) for break-glass operations.</p>
</li>
<li>
<p>Simulate what a given role/identity can see/do for troubleshooting or customer support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caveats:
- Never set a permissive impersonateFilterScript in production. Keep it restrictive and auditable.
- When using both X-Realm and impersonation in one call, be aware that the effective realm will be the impersonated user’s default realm; X-Realm is not applied in the impersonation branch in the current implementation.
- realmRegEx must be populated for any user who needs realm override; leaving it blank effectively disables X-Realm for that user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2">63.6. Examples</h3>
<div class="ulist">
<ul>
<li>
<p>List policies in a different realm using your own identity</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: acme-prod&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&amp;sort=+refName&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Simulate another user by subject while staying in their default realm</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Impersonate-Subject: 3d8f4e7b-...-idp-subject&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Attempt impersonation with a realm hint (validated by script; effective realm = impersonated default)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: dev-acme&quot; \
     -H &quot;X-Impersonate-UserId: tenant-admin&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security outcomes in all cases continue to be driven by your rule bases (Policy rules) matched against the effective PrincipalContext and ResourceContext.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_domain_assignment_on_create_domaincontext_and_datadomainpolicy">64. Data domain assignment on create: DomainContext and DataDomainPolicy</h2>
<div class="sectionbody">
<div id="_data_domain_assignment" class="paragraph">
<p>This section explains how Quantum decides which dataDomain is stamped on newly created records, why this decision is necessary in a multi‑tenant system, what the default behavior is, and how you can override it globally or per Functional Area / Functional Domain. It also describes the DataDomainResolver interface and the default implementation provided by the framework.</p>
</div>
<div class="sect2">
<h3 id="_the_problem_this_solves_and_why_it_matters">64.1. The problem this solves (and why it matters)</h3>
<div class="paragraph">
<p>In a multi‑tenant platform you must ensure each new record is written to the correct data partition so later reads/updates can be scoped safely. If the dataDomain is wrong or missing, you risk leaking data across tenants or making your own data inaccessible due to mis‑scoping.</p>
</div>
<div class="paragraph">
<p>Historically, Quantum set the dataDomain of new entities to match the creator’s credential (i.e., the principal’s DomainContext → DataDomain). That default is sensible in many cases, but real systems often need more specific behavior per business area or type. For example:
- You may centralize HR records in a single org‑level domain regardless of who created them.
- Sales invoices for EU customers must live under an EU data segment.
- A specific product area might always write into a shared catalog domain separate from the author’s tenant.</p>
</div>
<div class="paragraph">
<p>These needs require a simple, deterministic way to override the default per Functional Area and/or Functional Domain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_key_concepts_recap_domaincontext_and_datadomain">64.2. Key concepts recap: DomainContext and DataDomain</h3>
<div class="ulist">
<ul>
<li>
<p>DomainContext (on credentials/realms) captures the principal’s scoping defaults (realm, org/account/tenant identifiers, data segment). At request time this is materialized into a DataDomain.</p>
</li>
<li>
<p>DataDomain is what gets stamped onto persisted entities and later used by repositories to constrain queries and updates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you do nothing, new records inherit the principal’s DataDomain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_default_policy_do_nothing_and_it_works">64.3. The default policy (do nothing and it works)</h3>
<div class="paragraph">
<p>Out of the box, Quantum preserves the existing behavior: if no policy is configured, the resolver falls back to the authenticated principal’s DataDomain. This guarantees compatibility with existing applications.</p>
</div>
<div class="paragraph">
<p>Concretely:
- ValidationInterceptor checks if an entity being persisted lacks a dataDomain.
- If missing, it calls DataDomainResolver.resolveForCreate(area, domain).
- The DefaultDataDomainResolver first looks for overrides (credential‑attached or global); if none match, it returns the principal’s DataDomain from the current SecurityContext.</p>
</div>
</div>
<div class="sect2">
<h3 id="_policy_scopes_principalattached_vs_global">64.4. Policy scopes: principal‑attached vs. global</h3>
<div class="paragraph">
<p>You can define overrides at two levels:
- Principal‑attached (per credential): attach a DataDomainPolicy to a CredentialUserIdPassword. The SecurityFilter places this policy into the PrincipalContext, so it applies only to records created by that principal. This is useful for VIP service accounts or specific partners.
- Global policy: an application‑wide DataDomainPolicy provided by GlobalDataDomainPolicyProvider. If present, this applies when the principal has no specific override for the matching area/domain.</p>
</div>
<div class="paragraph">
<p>Precedence: principal‑attached policy wins over global policy; if neither applies, fall back to the principal’s credential domain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_policy_map_and_matching">64.5. The policy map and matching</h3>
<div class="paragraph">
<p>A DataDomainPolicy is a small map of rules: Map&lt;String, DataDomainPolicyEntry&gt; policyEntries, keyed by "&lt;FunctionalArea&gt;:&lt;FunctionalDomain&gt;" with support for "*" wildcards. The resolver evaluates keys in this order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>area:domain (most specific)</p>
</li>
<li>
<p>area:*</p>
</li>
<li>
<p>*:domain</p>
</li>
<li>
<p><strong>:</strong> (global catch‑all)</p>
</li>
<li>
<p>Fallback to principal’s domain if no entry yields a value</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each DataDomainPolicyEntry has a resolutionMode:
- FROM_CREDENTIAL (default): use the principal’s credential domain (i.e., the historical behavior).
- FIXED: use the first DataDomain listed in dataDomains on the entry.</p>
</div>
<div class="paragraph">
<p>Example policy definitions (illustrative JSON):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">policyEntries</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Sales:Invoice</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FIXED</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataDomains</span><span class="delimiter">&quot;</span></span>: [ {<span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ACME</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">eu-1</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">INVOICE</span><span class="delimiter">&quot;</span></span>} ] },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Sales:*</span><span class="delimiter">&quot;</span></span>:      { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_CREDENTIAL</span><span class="delimiter">&quot;</span></span> },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">*:HR</span><span class="delimiter">&quot;</span></span>:         { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FIXED</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataDomains</span><span class="delimiter">&quot;</span></span>: [ {<span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">GLOBAL</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hr</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">HR</span><span class="delimiter">&quot;</span></span>} ] },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">*:*</span><span class="delimiter">&quot;</span></span>:          { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_CREDENTIAL</span><span class="delimiter">&quot;</span></span> }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior of the above:
- Sales:Invoice records always go to the fixed EU invoices domain.
- Any other Sales:* creation uses the creator’s credential domain.
- All HR records go to a central HR domain.
- Otherwise, default to the creator’s domain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_the_resolver_works">64.6. How the resolver works</h3>
<div class="paragraph">
<p>Interfaces and default implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">DataDomainResolver</span> {
  DataDomain resolveForCreate(<span class="predefined-type">String</span> functionalArea, <span class="predefined-type">String</span> functionalDomain);
}

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultDataDomainResolver</span> <span class="directive">implements</span> DataDomainResolver {
  <span class="annotation">@Inject</span> GlobalDataDomainPolicyProvider globalPolicyProvider;
  <span class="directive">public</span> DataDomain resolveForCreate(<span class="predefined-type">String</span> area, <span class="predefined-type">String</span> domain) {
    DataDomain principalDD = SecurityContext.getPrincipalDataDomain()
      .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Principal context not providing a data domain</span><span class="delimiter">&quot;</span></span>));
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keys = <span class="predefined-type">List</span>.of(areaOrStar(area)+<span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span>+areaOrStar(domain), areaOrStar(area)+<span class="string"><span class="delimiter">&quot;</span><span class="content">:*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">*:</span><span class="delimiter">&quot;</span></span>+areaOrStar(domain), <span class="string"><span class="delimiter">&quot;</span><span class="content">*:*</span><span class="delimiter">&quot;</span></span>);
    <span class="comment">// 1) principal‑attached policy from PrincipalContext</span>
    DataDomain fromPrincipal = resolveFrom(policyFromPrincipal(), keys, principalDD);
    <span class="keyword">if</span> (fromPrincipal != <span class="predefined-constant">null</span>) <span class="keyword">return</span> fromPrincipal;
    <span class="comment">// 2) global policy</span>
    DataDomain fromGlobal = resolveFrom(globalPolicyProvider.getPolicy().orElse(<span class="predefined-constant">null</span>), keys, principalDD);
    <span class="keyword">if</span> (fromGlobal != <span class="predefined-constant">null</span>) <span class="keyword">return</span> fromGlobal;
    <span class="comment">// 3) default fallback</span>
    <span class="keyword">return</span> principalDD;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Integration point:
- ValidationInterceptor injects DataDomainResolver and calls it in prePersist when an entity’s dataDomain is null.
- SecurityFilter propagates a principal’s attached DataDomainPolicy (if any) into the PrincipalContext so the resolver can see it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_would_you_want_a_nonglobal_policy">64.7. When would you want a non‑global policy?</h3>
<div class="paragraph">
<p>Here are a few concrete scenarios:
- Centralized HR: All HR Employee records are written to a shared HR domain regardless of the team creating them. This supports a shared‑service HR model without duplicating HR data per tenant.
- Regulated invoices: In the Sales:Invoice domain for EU, you must write under a specific EU tenantId/dataSegment to satisfy data residency. Other Sales domains can keep default behavior.
- Shared catalog: The Catalog:Item domain is a cross‑tenant shared catalog maintained by a core team. Writes should go to a canonical catalog domain even when initiated by tenant‑specific users.
- VIP account override: A particular integration user should always write to a staging domain for testing purposes, while all others use defaults. Attach a small policy to just that credential.</p>
</div>
</div>
<div class="sect2">
<h3 id="_relation_to_tenancy_models">64.8. Relation to tenancy models</h3>
<div class="paragraph">
<p>The policy mechanism supports both siloed and pooled tenancy:
- Siloed tenancy: Most domains default to FROM_CREDENTIAL (each tenant writes to its own partition). Only a few shared services (e.g., HR, catalog) use FIXED to centralize data.
- Pooled tenancy: You may lean on FIXED policies more often to route writes into pooled/segment‑specific domains (e.g., region, product line), while still enforcing read/write scoping via permissions.</p>
</div>
<div class="paragraph">
<p>Because the resolver always validates through the principal context and falls back safely, you can introduce overrides gradually without destabilizing existing flows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authoring_tips">64.9. Authoring tips</h3>
<div class="ulist">
<ul>
<li>
<p>Start with no policy and verify your default flows. Add entries only where necessary.</p>
</li>
<li>
<p>Prefer specific keys (area:domain) for clarity; use wildcards sparingly.</p>
</li>
<li>
<p>Keep FIXED DataDomain objects minimal and valid for your deployment (orgRefName, tenantId, and dataSegment as needed).</p>
</li>
<li>
<p>Document any global policy so teams know which areas are centralized.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_api_pointers">64.10. API pointers</h3>
<div class="ulist">
<ul>
<li>
<p>CredentialUserIdPassword.dataDomainPolicy: optional per‑credential overrides (propagated to PrincipalContext).</p>
</li>
<li>
<p>GlobalDataDomainPolicyProvider: holds an optional in‑memory global policy (null by default).</p>
</li>
<li>
<p>DataDomainPolicyEntry.resolutionMode: FROM_CREDENTIAL (default) or FIXED.</p>
</li>
<li>
<p>DataDomainResolver / DefaultDataDomainResolver: the extension point and default behavior.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorials">65. Tutorials</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="tutorial-supply-chain" class="sect0">Tutorial: Supply Chain Collaboration End-to-End</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In this tutorial, we will model a simplified supply chain collaboration system, create repositories and REST resources, and see how Quantum provides a robust set of APIs that a UI can utilize—all with multi-tenancy baked in.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_domain_overview">66. Domain Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functional Area: Collaboration</p>
</div>
<div class="paragraph">
<p>Functional Domains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partner: Companies participating in the supply chain (manufacturers, carriers, retailers)</p>
</li>
<li>
<p>Shipment: Units of transport moving goods between locations</p>
</li>
<li>
<p>Task: Collaborative tasks associated with shipments (e.g., confirm pickup, update ETA)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_models">67. Models</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok.Data</span>;
<span class="keyword">import</span> <span class="include">lombok.EqualsAndHashCode</span>;
<span class="keyword">import</span> <span class="include">lombok.NoArgsConstructor</span>;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Partner</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> refCode;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Collaboration</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Partner</span><span class="delimiter">&quot;</span></span>; }
}

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Shipment</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> trackingNumber;
    <span class="directive">private</span> <span class="predefined-type">String</span> origin;
    <span class="directive">private</span> <span class="predefined-type">String</span> destination;
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Collaboration</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DataDomain on BaseModel ensures tenant context (tenantId/orgRefName/etc.) is carried and indexed as needed (see idx_refIdUniqueInDomain).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repositories">68. Repositories</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.MorphiaRepo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">PartnerRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Partner&gt; {}
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ShipmentRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Shipment&gt; {}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rest_resources">69. REST Resources</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/partners</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PartnerResource</span> <span class="directive">extends</span> BaseResource&lt;Partner, PartnerRepo&gt; {}

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/shipments</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ShipmentResource</span> <span class="directive">extends</span> BaseResource&lt;Shipment, ShipmentRepo&gt; {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These resources automatically expose consistent find/get/list/save/update/delete endpoints with DataDomain-aware filtering.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multi_tenant_sharing_scenarios">70. Multi-Tenant Sharing Scenarios</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Shared Partner Directory: Allow cross-tenant read of Partner records while keeping Shipments strictly tenant-scoped. Implement in RuleContext by permitting VIEW on Partner across tenants when a sharing flag is set in DataDomain (e.g., orgRefName == "PUBLIC").</p>
</li>
<li>
<p>Strict Shipment Isolation: Enforce that Shipment queries always constrain by tenantId and (optionally) orgRefName.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rulecontext_sketch">71. RuleContext Sketch</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CollaborationRuleContext</span> <span class="comment">/* implements your RuleContext SPI */</span> {
    <span class="directive">public</span> <span class="type">boolean</span> canView(<span class="predefined-type">Object</span> model, DomainContext ctx) {
        <span class="comment">// Allow partner directory reads across tenants if shared</span>
        <span class="keyword">if</span> (model <span class="keyword">instanceof</span> Partner p) {
            <span class="keyword">return</span> p.getDataDomain() != <span class="predefined-constant">null</span> &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">PUBLIC</span><span class="delimiter">&quot;</span></span>.equals(p.getDataDomain().getOrgRefName());
        }
        <span class="comment">// Default: require same tenant</span>
        <span class="keyword">return</span> ctx.getTenantId().equals(extractTenant(model));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">72. Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use quantum-jwt-provider to accept JWTs from your IdP. Map claims to tenantId/orgRefName/user/roles; BaseResource builds DomainContext for RuleContext.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_separating_models_and_repos_for_workflows">73. Separating Models and Repos for Workflows</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keep models and repositories in their own modules (as this repository does for quantum-models and quantum-morphia-repos). This allows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Integration into workflows like Temporal (activities operating directly on repos/models)</p>
</li>
<li>
<p>Orchestration by tools like Windmill, while REST APIs remain in another service/module</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_result">74. Result</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With these building blocks, a UI can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Search the Partner directory (cross-tenant where allowed)</p>
</li>
<li>
<p>Create/manage Shipments scoped to the tenant</p>
</li>
<li>
<p>Update and track tasks with action-driven UIActionList feedback</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All while maintaining consistent policy enforcement via RuleContext and DataDomain.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.2.2-SNAPSHOT<br>
Last updated 2025-09-12 22:56:24 -0400
</div>
</div>
</body>
</html>