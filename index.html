<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Quantum Framework Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Quantum Framework Documentation</h1>
<div class="details">
<span id="revnumber">version 1.2.3,</span>
<span id="revdate">2026-01-29T19:30:21Z</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_quick_links">1. Quick links</a></li>
<li><a href="#executive-brief-section">2. Executive Brief</a></li>
<li><a href="#executive-brief">Quantum Framework: Executive Brief for Business Leaders</a>
<ul class="sectlevel1">
<li><a href="#_what_quantum_is_in_one_page">3. What Quantum is (in one page)</a></li>
<li><a href="#_why_this_matters_to_the_business">4. Why this matters to the business</a></li>
<li><a href="#_core_concepts_in_plain_language">5. Core concepts in plain language</a>
<ul class="sectlevel2">
<li><a href="#_ontologies_the_business_map">5.1. Ontologies: the business map</a></li>
<li><a href="#_data_governance_policydriven_access_and_placement">5.2. Data governance: policy‑driven access and placement</a></li>
<li><a href="#_layered_architecture_clarity_and_agility">5.3. Layered architecture: clarity and agility</a></li>
</ul>
</li>
<li><a href="#_supply_chain_how_the_pieces_come_together">6. Supply chain: how the pieces come together</a></li>
<li><a href="#_where_quantum_fits_in_your_landscape">7. Where Quantum fits in your landscape</a></li>
<li><a href="#_getting_started_pragmatic_rollout">8. Getting started: pragmatic rollout</a></li>
<li><a href="#_summary_for_executives">9. Summary for executives</a></li>
<li><a href="#tutorial-guide">10. Tutorial Guide</a></li>
</ul>
</li>
<li><a href="#_quantum_tutorial_build_a_multi_tenant_saas_with_quantum">Quantum Tutorial: Build a Multi-tenant SaaS with Quantum</a>
<ul class="sectlevel1">
<li><a href="#sec-setup">11. 1. Project setup</a>
<ul class="sectlevel2">
<li><a href="#getting-started">11.1. Getting Started: Your First Quantum Application</a>
<ul class="sectlevel3">
<li><a href="#_prerequisites">11.1.1. Prerequisites</a></li>
<li><a href="#_project_setup">11.1.2. Project Setup</a></li>
<li><a href="#_configuration">11.1.3. Configuration</a></li>
<li><a href="#_your_first_model">11.1.4. Your First Model</a></li>
<li><a href="#_repository">11.1.5. Repository</a></li>
<li><a href="#_rest_resource">11.1.6. REST Resource</a></li>
<li><a href="#_running_the_application">11.1.7. Running the Application</a></li>
<li><a href="#_testing_your_api">11.1.8. Testing Your API</a></li>
<li><a href="#_what_you_get_automatically">11.1.9. What You Get Automatically</a></li>
<li><a href="#_next_steps">11.1.10. Next Steps</a></li>
<li><a href="#_optional_enable_ontology_modules">11.1.11. Optional: Enable Ontology Modules</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-overview">12. 2. Platform overview</a>
<ul class="sectlevel2">
<li><a href="#overview">12.1. Overview: Building SaaS with Quantum</a>
<ul class="sectlevel3">
<li><a href="#overview-saas">12.1.1. SaaS and Multi‑Tenancy First</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-modeling">13. 3. Domain modeling fundamentals</a>
<ul class="sectlevel2">
<li><a href="#modeling">13.1. Modeling with Functional Areas, Domains, and Actions</a>
<ul class="sectlevel4">
<li><a href="#_prefer_annotations_for_functional_mapping_recommended">Prefer Annotations for Functional Mapping (recommended)</a></li>
<li><a href="#_datadomain_on_models">DataDomain on Models</a></li>
<li><a href="#_persistence_repositories">Persistence Repositories</a></li>
<li><a href="#_exposing_rest_resources">Exposing REST Resources</a></li>
<li><a href="#_lombok_in_models">Lombok in Models</a></li>
<li><a href="#_validation_with_jakarta_bean_validation">Validation with Jakarta Bean Validation</a></li>
<li><a href="#_jackson_vs_jakarta_validation_annotations">Jackson vs Jakarta Validation Annotations</a></li>
</ul>
</li>
<li><a href="#_jackson_objectmapper_in_quarkus_and_in_quantum">13.2. Jackson ObjectMapper in Quarkus and in Quantum</a></li>
<li><a href="#_validation_lifecycle_and_morphia_interceptors">13.3. Validation Lifecycle and Morphia Interceptors</a></li>
<li><a href="#_functional_areadomain_in_rulecontext_permission_language">13.4. Functional Area/Domain in RuleContext Permission Language</a></li>
<li><a href="#_stategraphs_on_models">13.5. StateGraphs on Models</a></li>
<li><a href="#_state_graph_dot">13.6. State Graph (DOT)</a></li>
<li><a href="#_completiontasks_and_completiontaskgroups">13.7. CompletionTasks and CompletionTaskGroups</a></li>
<li><a href="#_references_and_entityreference">13.8. References and EntityReference</a></li>
<li><a href="#_tracking_references_with_trackreferences_and_delete_semantics">13.9. Tracking References with @TrackReferences and Delete Semantics</a>
<ul class="sectlevel3">
<li><a href="#ontologies-in-quantum">13.9.1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</a></li>
<li><a href="#ontology-integration-morphia-permissions">13.9.2. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-tenant-models">14. 4. Multi-tenant model and realm separation</a>
<ul class="sectlevel2">
<li><a href="#tenant-models">14.1. Multi‑Tenancy Models</a>
<ul class="sectlevel3">
<li><a href="#_one_tenant_per_database_in_a_mongodb_cluster">14.1.1. One Tenant per Database (in a MongoDB Cluster)</a></li>
<li><a href="#_many_tenants_in_one_database_shared_database">14.1.2. Many Tenants in One Database (Shared Database)</a></li>
<li><a href="#_freemium_and_trial_tenants">14.1.3. Freemium and Trial Tenants</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-domain-rule-context">15. 5. Domain rule context</a></li>
<li><a href="#domain-rule-context">16. DomainContext, RuleContext, and DataDomain</a>
<ul class="sectlevel2">
<li><a href="#_datadomain">16.1. DataDomain</a></li>
<li><a href="#_domaincontext">16.2. DomainContext</a></li>
<li><a href="#_rulecontext">16.3. RuleContext</a></li>
<li><a href="#_end_to_end_flow">16.4. End-to-End Flow</a></li>
<li><a href="#_resolvers_and_variables_in_rule_filters">16.5. Resolvers and Variables in Rule Filters</a></li>
<li><a href="#_concrete_example_building_and_using_a_resolver">16.6. Concrete example: building and using a resolver</a>
<ul class="sectlevel3">
<li><a href="#_1_implement_the_spi">16.6.1. 1) Implement the SPI</a></li>
<li><a href="#_2_how_rulecontext_uses_resolvers">16.6.2. 2) How RuleContext uses resolvers</a></li>
<li><a href="#_3_author_a_rule_that_consumes_the_variable">16.6.3. 3) Author a rule that consumes the variable</a></li>
<li><a href="#_4_end_to_end_behavior">16.6.4. 4) End-to-end behavior</a></li>
<li><a href="#_string_literals_vs_typed_values_in_resolver_variables">16.6.5. String literals vs. typed values in resolver variables</a></li>
<li><a href="#ontology-domain-rule-context">16.6.6. Using AccessListResolver with Ontology (optional)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-rest-crud">17. 6. Building RESTful CRUD APIs</a>
<ul class="sectlevel2">
<li><a href="#rest-crud">17.1. REST: Find, Get, List, Save, Update, Delete</a>
<ul class="sectlevel3">
<li><a href="#_base_concepts">17.1.1. Base Concepts</a></li>
<li><a href="#_example_resource">17.1.2. Example Resource</a></li>
<li><a href="#_authorization_layers_in_rest_crud">17.1.3. Authorization Layers in REST CRUD</a></li>
<li><a href="#querying">17.1.4. Querying</a></li>
<li><a href="#_responses_and_schemas">17.1.5. Responses and Schemas</a></li>
<li><a href="#_error_handling">17.1.6. Error Handling</a></li>
<li><a href="#_simple_filters_equals">17.1.7. Simple filters (equals)</a></li>
<li><a href="#_advanced_filters_grouping_and_andornot">17.1.8. Advanced filters: grouping and AND/OR/NOT</a></li>
<li><a href="#_in_lists">17.1.9. IN lists</a></li>
<li><a href="#_sorting">17.1.10. Sorting</a></li>
<li><a href="#_projections">17.1.11. Projections</a></li>
<li><a href="#_endtoend_examples">17.1.12. End‑to‑end examples</a></li>
</ul>
</li>
<li><a href="#_csv_export_and_import">17.2. CSV Export and Import</a>
<ul class="sectlevel3">
<li><a href="#_export_get_csv">17.2.1. Export: GET /csv</a></li>
<li><a href="#_import_post_csv_multipart">17.2.2. Import: POST /csv (multipart)</a></li>
<li><a href="#_import_with_preview_sessions">17.2.3. Import with preview sessions</a></li>
<li><a href="#_enhanced_import_with_importprofile">17.2.4. Enhanced Import with ImportProfile</a></li>
<li><a href="#_rowvalueresolver_custom_per_row_logic">17.2.5. RowValueResolver: Custom Per-Row Logic</a></li>
<li><a href="#_dynamic_attribute_import">17.2.6. Dynamic Attribute Import</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#rest-crud-auth">18. Authentication and Authorization</a>
<ul class="sectlevel2">
<li><a href="#_jwt_provider">18.1. JWT Provider</a></li>
<li><a href="#_pluggable_authentication">18.2. Pluggable Authentication</a></li>
<li><a href="#_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference">18.3. Creating an Auth Plugin (using the Custom JWT provider as a reference)</a></li>
<li><a href="#_authprovider_interface_what_a_provider_must_implement">18.4. AuthProvider interface (what a provider must implement)</a></li>
<li><a href="#_usermanagement_interface_operations_your_plugin_must_support">18.5. UserManagement interface (operations your plugin must support)</a></li>
<li><a href="#_leveraging_baseauthprovider_in_your_plugin">18.6. Leveraging BaseAuthProvider in your plugin</a></li>
<li><a href="#_implementing_your_own_provider">18.7. Implementing your own provider</a></li>
<li><a href="#_credentialuseridpassword_model_and_domaincontext">18.8. CredentialUserIdPassword model and DomainContext</a></li>
<li><a href="#_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps">18.9. Quarkus OIDC out-of-the-box and integrating with common IdPs</a></li>
<li><a href="#_authorization_via_rulecontext">18.10. Authorization via RuleContext</a>
<ul class="sectlevel3">
<li><a href="#ontology-rest-crud">18.10.1. Using Ontology Edges in List Endpoints (optional)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-query-language">19. 7. Query language and filtering</a>
<ul class="sectlevel2">
<li><a href="#query-language">19.1. Query Language Reference</a>
<ul class="sectlevel3">
<li><a href="#_basic_syntax">19.1.1. Basic Syntax</a></li>
<li><a href="#_common_patterns">19.1.2. Common Patterns</a></li>
</ul>
</li>
<li><a href="#_hands_on_relationships_and_ontology_aware_queries">19.2. Hands-on: Relationships and Ontology-aware queries</a>
<ul class="sectlevel3">
<li><a href="#_hydrate_related_data_with_expandpath">19.2.1. Hydrate related data with expand(path)</a></li>
<li><a href="#_ontology_constrain_by_relationships_with_hasedgepredicate_dst">19.2.2. Ontology: constrain by relationships with hasEdge(predicate, dst)</a></li>
<li><a href="#_inspect_the_planner_with_querygateway">19.2.3. Inspect the planner with QueryGateway</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-security">20. 8. Authentication, permissions, and annotations</a></li>
<li><a href="#auth">21. Authentication and Authorization</a>
<ul class="sectlevel2">
<li><a href="#_jwt_provider_2">21.1. JWT Provider</a></li>
<li><a href="#_pluggable_authentication_2">21.2. Pluggable Authentication</a></li>
<li><a href="#_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference_2">21.3. Creating an Auth Plugin (using the Custom JWT provider as a reference)</a></li>
<li><a href="#_authprovider_interface_what_a_provider_must_implement_2">21.4. AuthProvider interface (what a provider must implement)</a></li>
<li><a href="#_usermanagement_interface_operations_your_plugin_must_support_2">21.5. UserManagement interface (operations your plugin must support)</a></li>
<li><a href="#_leveraging_baseauthprovider_in_your_plugin_2">21.6. Leveraging BaseAuthProvider in your plugin</a></li>
<li><a href="#_implementing_your_own_provider_2">21.7. Implementing your own provider</a></li>
<li><a href="#_credentialuseridpassword_model_and_domaincontext_2">21.8. CredentialUserIdPassword model and DomainContext</a></li>
<li><a href="#_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps_2">21.9. Quarkus OIDC out-of-the-box and integrating with common IdPs</a></li>
<li><a href="#_authorization_via_rulecontext_2">21.10. Authorization via RuleContext</a></li>
</ul>
</li>
<li><a href="#permissions">22. Permissions: Rule Bases, SecurityURIHeader, and SecurityURIBody</a>
<ul class="sectlevel2">
<li><a href="#_introduction_layered_enforcement_overview">22.1. Introduction: Layered Enforcement Overview</a></li>
<li><a href="#_key_concepts">22.2. Key Concepts</a></li>
<li><a href="#_rule_structure_illustrative">22.3. Rule Structure (Illustrative)</a></li>
<li><a href="#_matching_algorithm">22.4. Matching Algorithm</a></li>
<li><a href="#_priorities">22.5. Priorities</a></li>
<li><a href="#_grant_based_vs_deny_based_rule_sets">22.6. Grant-based vs Deny-based Rule Sets</a></li>
<li><a href="#_feature_flags_variants_and_target_rules">22.7. Feature Flags, Variants, and Target Rules</a></li>
<li><a href="#_multiple_matching_rulebases">22.8. Multiple Matching RuleBases</a></li>
<li><a href="#_identity_and_role_matching">22.9. Identity and Role Matching</a>
<ul class="sectlevel3">
<li><a href="#_how_roles_are_defined_for_an_identity_role_sources_and_resolution">22.9.1. How roles are defined for an identity (role sources and resolution)</a></li>
</ul>
</li>
<li><a href="#_example_scenarios">22.10. Example Scenarios</a></li>
<li><a href="#_operational_tips">22.11. Operational Tips</a></li>
<li><a href="#_how_uiactions_and_defaultuiactions_are_calculated">22.12. How UIActions and DefaultUIActions are calculated</a></li>
<li><a href="#_how_this_integrates_end_to_end">22.13. How This Integrates End-to-End</a></li>
<li><a href="#_administering_policies_via_rest_policyresource">22.14. Administering Policies via REST (PolicyResource)</a>
<ul class="sectlevel3">
<li><a href="#_model_shape_policy">22.14.1. Model shape (Policy)</a></li>
<li><a href="#_how_rule_contributed_filters_work_andfilterstring_orfilterstring_joinop">22.14.2. How rule-contributed filters work (andFilterString, orFilterString, joinOp)</a></li>
<li><a href="#_accesslistresolvers_spi_for_list_based_access">22.14.3. AccessListResolvers (SPI) for list-based access</a></li>
<li><a href="#_principalcontextpropertiesresolver_spi_for_custom_principal_properties">22.14.4. PrincipalContextPropertiesResolver (SPI) for custom principal properties</a></li>
<li><a href="#_endpoints">22.14.5. Endpoints</a></li>
<li><a href="#_examples">22.14.6. Examples</a></li>
<li><a href="#_how_changes_affect_rule_bases_and_enforcement">22.14.7. How changes affect rule bases and enforcement</a></li>
</ul>
</li>
<li><a href="#_realm_override_x_realm_and_impersonation_x_impersonate">22.15. Realm override (X-Realm) and Impersonation (X-Impersonate)</a>
<ul class="sectlevel3">
<li><a href="#_what_they_do_at_a_glance">22.15.1. What they do (at a glance)</a></li>
<li><a href="#_how_the_headers_integrate_with_permission_evaluation">22.15.2. How the headers integrate with permission evaluation</a></li>
<li><a href="#_required_credential_configuration_credentialuseridpassword">22.15.3. Required credential configuration (CredentialUserIdPassword)</a></li>
<li><a href="#_end_to_end_behavior_from_securityfilter_reference">22.15.4. End-to-end behavior from SecurityFilter (reference)</a></li>
<li><a href="#_practical_differences_and_use_cases">22.15.5. Practical differences and use cases</a></li>
<li><a href="#_examples_2">22.15.6. Examples</a></li>
</ul>
</li>
<li><a href="#_data_domain_assignment_on_create_domaincontext_and_datadomainpolicy">22.16. Data domain assignment on create: DomainContext and DataDomainPolicy</a>
<ul class="sectlevel3">
<li><a href="#_the_problem_this_solves_and_why_it_matters">22.16.1. The problem this solves (and why it matters)</a></li>
<li><a href="#_key_concepts_recap_domaincontext_and_datadomain">22.16.2. Key concepts recap: DomainContext and DataDomain</a></li>
<li><a href="#_the_default_policy_do_nothing_and_it_works">22.16.3. The default policy (do nothing and it works)</a></li>
<li><a href="#_policy_scopes_principalattached_vs_global">22.16.4. Policy scopes: principal‑attached vs. global</a></li>
<li><a href="#_the_policy_map_and_matching">22.16.5. The policy map and matching</a></li>
<li><a href="#_how_the_resolver_works">22.16.6. How the resolver works</a></li>
<li><a href="#_when_would_you_want_a_nonglobal_policy">22.16.7. When would you want a non‑global policy?</a></li>
<li><a href="#_relation_to_tenancy_models">22.16.8. Relation to tenancy models</a></li>
<li><a href="#_authoring_tips">22.16.9. Authoring tips</a></li>
<li><a href="#_api_pointers">22.16.10. API pointers</a></li>
<li><a href="#ontology-permissions">22.16.11. Ontology in Permission Rules (optional)</a></li>
<li><a href="#label-resolution-spi">22.16.12. Label resolution SPI and hasLabel() in rules</a></li>
</ul>
</li>
<li><a href="#script-helpers-reference">22.17. Script Helpers reference (when enabled)</a>
<ul class="sectlevel3">
<li><a href="#security-annotations">22.17.1. Security Annotations: FunctionalMapping and FunctionalAction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-seed-packs">23. 9. Seed packs: Declarative tenant seeding</a></li>
<li><a href="#_seed_packs_and_declarative_tenant_seeding">24. Seed packs and declarative tenant seeding</a>
<ul class="sectlevel2">
<li><a href="#_introduction">24.1. Introduction</a>
<ul class="sectlevel3">
<li><a href="#_the_problem">24.1.1. The problem</a></li>
<li><a href="#_why_this_needs_to_be_solved">24.1.2. Why this needs to be solved</a></li>
<li><a href="#_how_seed_packs_solve_it">24.1.3. How seed packs solve it</a></li>
</ul>
</li>
<li><a href="#_why_seed_packs">24.2. Why seed packs?</a></li>
<li><a href="#_high_level_flow">24.3. High-level flow</a></li>
<li><a href="#_manifest_quick_reference">24.4. Manifest quick reference</a></li>
<li><a href="#_programmatic_usage">24.5. Programmatic usage</a></li>
<li><a href="#_extensibility_hooks">24.6. Extensibility hooks</a></li>
<li><a href="#_operational_tips_2">24.7. Operational tips</a></li>
<li><a href="#_primary_scenarios">24.8. Primary scenarios</a></li>
<li><a href="#_explicit_examples">24.9. Explicit examples</a>
<ul class="sectlevel3">
<li><a href="#_example_1_minimal_manifest_and_ndjson">24.9.1. Example 1: Minimal manifest and NDJSON</a></li>
<li><a href="#_example_2_applying_packs_in_code">24.9.2. Example 2: Applying packs in code</a></li>
<li><a href="#_example_3_using_an_archetype">24.9.3. Example 3: Using an archetype</a></li>
<li><a href="#_example_4_exact_version_and_includes_in_a_manifest">24.9.4. Example 4: Exact version and includes in a manifest</a></li>
</ul>
</li>
<li><a href="#_troubleshooting">24.10. Troubleshooting</a></li>
<li><a href="#_how_seeds_are_applied_automatically_at_startup">24.11. How seeds are applied automatically at startup</a></li>
<li><a href="#_transforms_in_depth">24.12. Transforms in depth</a>
<ul class="sectlevel3">
<li><a href="#_creating_your_own_transforms_example_dropiftransform">24.12.1. Creating your own transforms (example: DropIfTransform)</a></li>
</ul>
</li>
<li><a href="#_test_walkthrough_seedloaderintegrationtest">24.13. Test walkthrough: SeedLoaderIntegrationTest</a></li>
<li><a href="#_archetypes_explained">24.14. Archetypes explained</a>
<ul class="sectlevel3">
<li><a href="#_example_a_define_and_apply_an_archetype_in_the_same_pack">24.14.1. Example A: Define and apply an archetype in the same pack</a></li>
<li><a href="#_example_b_cross_pack_archetype_in_a_dedicated_editions_pack">24.14.2. Example B: Cross-pack archetype in a dedicated "editions" pack</a></li>
<li><a href="#_resolution_and_ordering_details">24.14.3. Resolution and ordering details</a></li>
<li><a href="#_interaction_with_applyseedpackschangeset">24.14.4. Interaction with ApplySeedPacksChangeSet</a></li>
<li><a href="#_tenant_provisioning_with_archetypes">24.14.5. Tenant provisioning with archetypes</a></li>
</ul>
</li>
<li><a href="#_rest_api_for_seed_packs">24.15. REST API for seed packs</a></li>
<li><a href="#_using_morphiaseedrepository_morphia_backed_seeding">24.16. Using MorphiaSeedRepository (Morphia-backed seeding)</a></li>
<li><a href="#_dataset_urls_and_routing_file_and_s3">24.17. Dataset URLs and routing (file:// and s3://)</a></li>
<li><a href="#_s3_seed_source_optional_module">24.18. S3 Seed Source (optional module)</a>
<ul class="sectlevel3">
<li><a href="#_when_to_use_s3_vs_filesystem">24.18.1. When to use S3 vs. filesystem</a></li>
<li><a href="#_s3_layout_conventions">24.18.2. S3 layout conventions</a></li>
<li><a href="#_configuration_and_credentials">24.18.3. Configuration and credentials</a></li>
<li><a href="#_usage_examples">24.18.4. Usage examples</a></li>
<li><a href="#_defining_datasets_in_the_manifest_s3">24.18.5. Defining datasets in the manifest (S3)</a></li>
<li><a href="#_troubleshooting_2">24.18.6. Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-migrations">25. 10. Migrations</a></li>
<li><a href="#migrations">26. Database Migrations and Index Management</a>
<ul class="sectlevel2">
<li><a href="#_overview">26.1. Overview</a></li>
<li><a href="#_semantic_versioning">26.2. Semantic Versioning</a></li>
<li><a href="#_configuration_2">26.3. Configuration</a></li>
<li><a href="#_how_change_sets_are_discovered_and_executed">26.4. How change sets are discovered and executed</a></li>
<li><a href="#_authoring_a_change_set">26.5. Authoring a change set</a></li>
<li><a href="#_example_change_sets_in_the_framework">26.6. Example change sets in the framework</a></li>
<li><a href="#_rest_apis_to_trigger_migrations_migrationresource">26.7. REST APIs to trigger migrations (MigrationResource)</a></li>
<li><a href="#_perentity_index_management_baseresource">26.8. Per‑entity index management (BaseResource)</a></li>
<li><a href="#_global_index_management_migrationservice">26.9. Global index management (MigrationService)</a></li>
<li><a href="#_validating_versions_at_startup">26.10. Validating versions at startup</a></li>
<li><a href="#_notes_and_best_practices">26.11. Notes and best practices</a>
<ul class="sectlevel3">
<li><a href="#_checksum_vs_fromto_versions">26.11.1. Checksum vs. from/to versions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-testing">27. 11. Testing</a>
<ul class="sectlevel2">
<li><a href="#testing">27.1. Testing in Quantum: Security Contexts, Repos, and REST APIs</a>
<ul class="sectlevel3">
<li><a href="#_testing_framework">27.1.1. Testing Framework</a></li>
<li><a href="#_prerequisites_and_glossary">27.1.2. Prerequisites and glossary</a></li>
<li><a href="#_pattern_1_extend_baserepotest">27.1.3. Pattern 1 — Extend BaseRepoTest</a></li>
<li><a href="#_pattern_2_try_with_resources_securitysession">27.1.4. Pattern 2 — Try-with-resources SecuritySession</a></li>
<li><a href="#_pattern_3_scoped_call_wrapper_scopedcallscope">27.1.5. Pattern 3 — Scoped-call wrapper (ScopedCallScope)</a></li>
<li><a href="#_pattern_4_testsecurity_annotation_quarkus">27.1.6. Pattern 4 — @TestSecurity annotation (Quarkus)</a></li>
<li><a href="#_testing_rest_apis_vs_repository_logic">27.1.7. Testing REST APIs vs. Repository Logic</a></li>
<li><a href="#_useful_quarkus_test_features">27.1.8. Useful Quarkus Test features</a></li>
<li><a href="#_real_world_tips">27.1.9. Real-world tips</a></li>
<li><a href="#_summary_2">27.1.10. Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-next-steps">28. 12. Next steps</a></li>
<li><a href="#reference-guide">29. Reference Guide</a></li>
</ul>
</li>
<li><a href="#_quantum_reference_guide">Quantum Reference Guide</a>
<ul class="sectlevel1">
<li><a href="#_platform">30. Platform</a></li>
<li><a href="#_modeling_and_tenancy">31. Modeling and Tenancy</a></li>
<li><a href="#_apis_and_queries">32. APIs and Queries</a></li>
<li><a href="#_security">33. Security</a></li>
<li><a href="#_data_seeding">34. Data Seeding</a></li>
<li><a href="#_operations">35. Operations</a></li>
<li><a href="#_samples">36. Samples</a></li>
<li><a href="#_appendix">37. Appendix</a></li>
<li><a href="#ontology-chapter">38. Ontology Modeling</a></li>
</ul>
</li>
<li><a href="#_ontology_modeling">Ontology Modeling</a>
<ul class="sectlevel1">
<li><a href="#ontologies-in-quantum">39. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</a>
<ul class="sectlevel2">
<li><a href="#_what_is_an_ontology_2">39.1. What is an Ontology?</a></li>
<li><a href="#_ontology_vs_object_model_2">39.2. Ontology vs. Object Model</a></li>
<li><a href="#_why_prefer_ontology_driven_relationships_over_referenceentityreference_2">39.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</a></li>
<li><a href="#_how_quantum_supports_ontologies_2">39.4. How Quantum supports Ontologies</a></li>
<li><a href="#_modeling_guidance_from_object_fields_to_predicates_2">39.5. Modeling guidance: from object fields to predicates</a></li>
<li><a href="#_querying_with_ontology_edges_vs_direct_references_2">39.6. Querying with ontology edges vs direct references</a></li>
<li><a href="#_migration_from_reference_to_ontology_edges_2">39.7. Migration: from @Reference to ontology edges</a></li>
<li><a href="#_performance_and_operational_notes_2">39.8. Performance and operational notes</a></li>
<li><a href="#_how_this_integrates_with_functional_areasdomains_2">39.9. How this integrates with Functional Areas/Domains</a></li>
<li><a href="#_summary_3">39.10. Summary</a></li>
</ul>
</li>
<li><a href="#ontology-ecommerce-example">40. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</a></li>
<li><a href="#ontology-visualizing-edges-and-provenance">41. Visualizing ontology edges and provenance</a>
<ul class="sectlevel2">
<li><a href="#_example_graph_orders_customers_organizations">41.1. Example graph: Orders, Customers, Organizations</a></li>
<li><a href="#_example_graph_shipments_and_regions">41.2. Example graph: Shipments and Regions</a></li>
<li><a href="#_what_is_provenance_and_how_to_read_it">41.3. What is provenance and how to read it</a></li>
<li><a href="#_querying_ontologies">41.4. Querying Ontologies</a>
<ul class="sectlevel3">
<li><a href="#_biapi_query_language_functions_hasedge_and_hasincomingedge">41.4.1. BIAPI Query Language Functions: hasEdge and hasIncomingEdge</a></li>
<li><a href="#_programmatic_querying_with_edgedao">41.4.2. Programmatic Querying with EdgeDao</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ontology-integration-morphia-permissions">42. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</a>
<ul class="sectlevel2">
<li><a href="#_big_picture_where_ontology_fits_2">42.1. Big picture: where ontology fits</a></li>
<li><a href="#_rule_language_add_hasedge_2">42.2. Rule language: add hasEdge()</a></li>
<li><a href="#_passing_tenantid_correctly_2">42.3. Passing tenantId correctly</a></li>
<li><a href="#_morphia_repository_integration_patterns_2">42.4. Morphia repository integration patterns</a></li>
<li><a href="#_where_ontology_materialization_happens">42.5. Where ontology materialization happens</a></li>
<li><a href="#custom-edge-providers">42.6. Custom Edge Providers: OntologyEdgeProvider and HierarchyListEdgeProvider</a>
<ul class="sectlevel3">
<li><a href="#_ontologyedgeprovider_the_core_spi">42.6.1. OntologyEdgeProvider: The Core SPI</a></li>
<li><a href="#_hierarchylistedgeprovider_handling_complex_hierarchies">42.6.2. HierarchyListEdgeProvider: Handling Complex Hierarchies</a></li>
<li><a href="#property-chains-vs-computed-providers">42.6.3. When to use Property Chains vs ComputedEdgeProvider</a></li>
<li><a href="#_extending_materialization_with_computededgeprovider_advanced">42.6.4. Extending materialization with ComputedEdgeProvider (Advanced)</a></li>
<li><a href="#_extending_materialization_with_ontologyedgeprovider_spi">42.6.5. Extending materialization with OntologyEdgeProvider (SPI)</a></li>
<li><a href="#_configuration_3">42.6.6. Configuration</a></li>
<li><a href="#_example_annotate_and_save_edges_are_materialized_automatically">42.6.7. Example: annotate and save — edges are materialized automatically</a></li>
</ul>
</li>
<li><a href="#_security_and_multi_tenant_considerations_2">42.7. Security and multi-tenant considerations</a></li>
<li><a href="#_developer_workflow_and_dx_checklist_2">42.8. Developer workflow and DX checklist</a></li>
<li><a href="#_cookbook_end_to_end_example_with_orders_org_2">42.9. Cookbook: end-to-end example with Orders + Org</a></li>
<li><a href="#_migration_notes_for_teams_using_reference_2">42.10. Migration notes for teams using @Reference</a></li>
</ul>
</li>
<li><a href="#_primer_first_time_guide_to_core_relationship_semantics">43. Primer: First-time guide to core relationship semantics</a></li>
<li><a href="#_new_ontology_features_in_this_release">44. New ontology features in this release</a>
<ul class="sectlevel2">
<li><a href="#_feature_overview">44.1. Feature overview</a></li>
<li><a href="#_business_problems_solved">44.2. Business problems solved</a></li>
<li><a href="#_how_to_code_it_with_current_apis">44.3. How to code it with current APIs</a>
<ul class="sectlevel3">
<li><a href="#_1_define_ontology_programmatic_tbox">44.3.1. 1) Define ontology (programmatic TBox)</a></li>
<li><a href="#_2_materialize_inferences_when_data_changes">44.3.2. 2) Materialize inferences when data changes</a></li>
<li><a href="#_3_query_with_listqueryrewriter_quarkusmorphia">44.3.3. 3) Query with ListQueryRewriter (Quarkus/Morphia)</a></li>
<li><a href="#_functional_properties_at_write_time">44.3.4. Functional properties at write time</a></li>
</ul>
</li>
<li><a href="#_backward_compatibility_and_migration">44.4. Backward compatibility and migration</a></li>
<li><a href="#_troubleshooting_and_tips">44.5. Troubleshooting and tips</a></li>
</ul>
</li>
<li><a href="#_model_first_ontology_with_annotations_and_morphiaontologyloader">45. Model-first ontology with annotations and MorphiaOntologyLoader</a>
<ul class="sectlevel2">
<li><a href="#_why_model_first">45.1. Why model-first?</a></li>
<li><a href="#_annotations_overview">45.2. Annotations overview</a>
<ul class="sectlevel3">
<li><a href="#ontology-relationships">45.2.1. Relationship semantics on @OntologyProperty</a></li>
<li><a href="#ontology-cascading">45.2.2. Cascading policies for relationships</a></li>
<li><a href="#ontology-benefits-relationships">45.2.3. Business benefits of ontology relationships and cascade</a></li>
</ul>
</li>
<li><a href="#_example_orders_placed_in_an_organization_e_commerce">45.3. Example: Orders placed in an Organization (e-commerce)</a></li>
<li><a href="#_how_the_registry_is_produced_quarkus_cdi">45.4. How the registry is produced (Quarkus CDI)</a></li>
<li><a href="#_defining_an_ontology_with_yaml_yamlontologyloader">45.5. Defining an ontology with YAML (YamlOntologyLoader)</a></li>
<li><a href="#_materializing_inferences_from_annotated_models">45.6. Materializing inferences from annotated models</a></li>
<li><a href="#_querying_using_listqueryrewriter_unchanged">45.7. Querying using ListQueryRewriter (unchanged)</a></li>
<li><a href="#_business_case_recipes_with_annotations">45.8. Business case recipes with annotations</a></li>
<li><a href="#_troubleshooting_3">45.9. Troubleshooting</a></li>
<li><a href="#_migration_strategy">45.10. Migration strategy</a></li>
<li><a href="#_modeling_guidance_annotate_existing_idreference_getters_keep_api_and_db_clean">45.11. Modeling guidance: annotate existing id/reference getters (keep API and DB clean)</a></li>
</ul>
</li>
<li><a href="#ontology-rest-api">46. Exploring the ontology via REST and JointJS</a>
<ul class="sectlevel2">
<li><a href="#_base_info">46.1. Base info</a></li>
<li><a href="#_tbox_schema_endpoints">46.2. TBox (schema) endpoints</a></li>
<li><a href="#_abox_instances_graph_endpoint">46.3. ABox (instances) graph endpoint</a></li>
<li><a href="#_rendering_with_jointjs_quick_snippet">46.4. Rendering with JointJS (quick snippet)</a></li>
<li><a href="#_when_to_use_these_endpoints">46.5. When to use these endpoints</a></li>
</ul>
</li>
<li><a href="#dev-howto-ontology-yaml-materialization-reindex-provenance">47. Developer how-to: YAML properties, chains, write-time materialization, reindex, and provenance</a>
<ul class="sectlevel2">
<li><a href="#_declare_properties_and_chains_in_yaml">47.1. Declare properties and chains in YAML</a></li>
<li><a href="#_write_time_materialization_what_runs_and_how_to_toggle">47.2. Write-time materialization: what runs and how to toggle</a></li>
<li><a href="#_reindex_after_yaml_changes">47.3. Reindex after YAML changes</a></li>
<li><a href="#_edge_provenance_format_and_deletions">47.4. Edge provenance format and deletions</a></li>
</ul>
</li>
<li><a href="#_samples_2">48. Samples</a></li>
</ul>
</li>
<li><a href="#tutorial-supply-chain">Supply Chain Collaboration SaaS: A Business‑First Guide</a>
<ul class="sectlevel1">
<li><a href="#_what_a_supplychain_saas_needs_and_how_quantum_helps">49. What a supply‑chain SaaS needs (and how Quantum helps)</a></li>
<li><a href="#_why_multitenancy_is_a_natural_fit_for_supply_chains">50. Why multi‑tenancy is a natural fit for supply chains</a></li>
<li><a href="#_who_uses_the_system_organizations_and_roles">51. Who uses the system (organizations and roles)</a></li>
<li><a href="#_identity_and_access_meet_partners_where_they_are">52. Identity and access: meet partners where they are</a></li>
<li><a href="#_modeling_without_jargon_areas_domains_and_actions">53. Modeling without jargon: Areas, Domains, and Actions</a></li>
<li><a href="#_policies_that_say_who_can_do_what_rule_language">54. Policies that say “who can do what” (Rule Language)</a></li>
<li><a href="#_domain_contexts_and_domain_policies_placing_and_sharing_data">55. Domain contexts and domain policies (placing and sharing data)</a></li>
<li><a href="#_bootstrap_tenants_with_seed_packs_zerotouch_baseline_data">56. Bootstrap tenants with Seed Packs (zero‑touch baseline data)</a></li>
<li><a href="#_security_policies_practical_protections_and_proofs">57. Security policies: practical protections and proofs</a></li>
<li><a href="#_a_small_powerful_api_surface_list_query">58. A small, powerful API surface: List + Query</a></li>
<li><a href="#_delegated_administration_tenantlevel_user_management">59. Delegated Administration (tenant‑level user management)</a></li>
<li><a href="#_integrations_and_data_management">60. Integrations and data management</a></li>
<li><a href="#_endtoend_examples_2">61. End‑to‑end examples</a></li>
<li><a href="#_what_you_dont_have_to_build_from_scratch">62. What you don’t have to build from scratch</a></li>
<li><a href="#_other_helpful_capabilities_you_get_out_of_the_box">63. Other helpful capabilities you get out of the box</a></li>
<li><a href="#_next_steps_2">64. Next steps</a></li>
<li><a href="#_a_day_in_the_life_from_purchase_order_to_delivery">65. A day in the life: From Purchase Order to Delivery</a></li>
<li><a href="#_appendix_2">66. Appendix</a>
<ul class="sectlevel2">
<li><a href="#configuration">66.1. Configuration Reference</a>
<ul class="sectlevel3">
<li><a href="#_configuration_basics">66.1.1. Configuration Basics</a></li>
<li><a href="#_database_configuration">66.1.2. Database Configuration</a></li>
<li><a href="#_authentication_configuration">66.1.3. Authentication Configuration</a></li>
<li><a href="#_quantum_framework_configuration">66.1.4. Quantum Framework Configuration</a></li>
<li><a href="#_see_also_3">66.1.5. See Also</a></li>
<li><a href="#_ontology_configuration_optional">66.1.6. Ontology Configuration (optional)</a></li>
<li><a href="#_key_quarkus_capabilities">66.1.7. Key Quarkus Capabilities</a></li>
<li><a href="#_arc_quarkus_cdi">66.1.8. Arc (Quarkus CDI)</a></li>
<li><a href="#_native_compilation_with_graalvm">66.1.9. Native Compilation with GraalVM</a></li>
<li><a href="#_extension_ecosystem">66.1.10. Extension Ecosystem</a></li>
<li><a href="#_quantums_quarkus_integration">66.1.11. Quantum&#8217;s Quarkus Integration</a></li>
<li><a href="#_getting_started_with_quarkus">66.1.12. Getting Started with Quarkus</a></li>
<li><a href="#_see_also_4">66.1.13. See Also</a></li>
<li><a href="#_core_concepts">66.1.14. Core Concepts</a></li>
<li><a href="#_multi_tenancy">66.1.15. Multi-Tenancy</a></li>
<li><a href="#_security_2">66.1.16. Security</a></li>
<li><a href="#_data_and_persistence">66.1.17. Data and Persistence</a></li>
<li><a href="#_rest_and_apis">66.1.18. REST and APIs</a></li>
<li><a href="#_framework_components">66.1.19. Framework Components</a></li>
<li><a href="#_annotations">66.1.20. Annotations</a></li>
<li><a href="#_external_integrations">66.1.21. External Integrations</a></li>
<li><a href="#_ontology_optional_feature">66.1.22. Ontology (optional feature)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This documentation provides user guides and tutorials for mid-level Java developers to build SaaS applications with multi-tenancy on the Quantum framework, in a structure similar to Spring’s reference documentation. Artifacts are generated as HTML and PDF via Maven.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_links">1. Quick links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Executive Brief: <a href="#">Executive Brief for Business Leaders</a></p>
</li>
<li>
<p>Tutorial Guide: <a href="#tutorial-guide">Quantum Tutorial</a></p>
</li>
<li>
<p>Reference Guide: <a href="#reference-guide">Quantum Reference Guide</a></p>
</li>
<li>
<p>Ontologies in Quantum: <a href="#ontologies-in-quantum">Modeling relationships and cascading</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="executive-brief-section">2. Executive Brief</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="executive-brief" class="sect0">Quantum Framework: Executive Brief for Business Leaders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This brief is written for senior business and technology leaders who do not write code. It explains what the Quantum framework is, the business problems it solves, and why its approach to ontologies, data governance, and layered architecture is valuable across industries. A supply chain scenario is used to ground the concepts in familiar outcomes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_quantum_is_in_one_page">3. What Quantum is (in one page)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum is a foundation for building secure, multi‑tenant business applications where multiple parties need to collaborate on shared data without losing control of their own data. It reduces time‑to‑value by giving product teams a consistent way to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define the language of the business (via an ontology) so the system understands how things relate: orders, shipments, customers, facilities, approvals, etc.</p>
</li>
<li>
<p>Enforce policy‑driven data access and data placement (data governance) so people only see what they should, and data lives where it should.</p>
</li>
<li>
<p>Offer a consistent API and query model to the UI and to partner systems, avoiding a tangle of bespoke endpoints.</p>
</li>
<li>
<p>Operate as a true multi‑tenant SaaS: each organization is separate by default, with explicit, auditable sharing when needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Think of Quantum as a “business‑aware operating system” for enterprise SaaS: you focus on the domain and outcomes, while the framework bakes in the cross‑cutting concerns.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_this_matters_to_the_business">4. Why this matters to the business</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Faster delivery of new products and modules: teams assemble capabilities instead of re‑building plumbing.</p>
</li>
<li>
<p>Lower integration friction: partners and internal apps access data through consistent, governed interfaces.</p>
</li>
<li>
<p>Reduced risk: privacy, residency, and least‑privilege access are enforced by policy rather than scattered code.</p>
</li>
<li>
<p>Explainable security: clear answers to “who can do what, with which data, and why.”</p>
</li>
<li>
<p>Future‑proof data: an ontology makes relationships explicit so you can extend, analyze, and automate without re‑platforming.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_concepts_in_plain_language">5. Core concepts in plain language</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ontologies_the_business_map">5.1. Ontologies: the business map</h3>
<div class="paragraph">
<p>An ontology is a formal map of the important things in your business and how they relate. In Quantum, the ontology:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Names the key entities (Shipment, PurchaseOrder, Partner, Invoice, Facility, etc.).</p>
</li>
<li>
<p>Captures how those entities connect (e.g., Shipment fulfills a PurchaseOrder; Partner operates a Facility).</p>
</li>
<li>
<p>Lets rules and analytics reason over those relationships (e.g., "show me all shipments for orders from strategic suppliers").</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Business value
- Shared understanding across teams and systems—no more mismatched semantics.
- Richer navigation and reporting—less brittle than hard‑coded joins and endpoints.
- Safer automation—policies and workflows operate on concepts the business understands, not table names.</p>
</div>
<div class="paragraph">
<p>See also: Modeling relationships and cascading (<a href="../user-guide/ontology.html">Ontology Guide</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_governance_policydriven_access_and_placement">5.2. Data governance: policy‑driven access and placement</h3>
<div class="paragraph">
<p>Data governance in Quantum is not an afterthought. It is expressed as human‑readable policies that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decide who can perform which action (VIEW, CREATE, APPROVE, EXPORT, etc.) on which domain objects.</p>
</li>
<li>
<p>Filter results so users see only the records they are entitled to.</p>
</li>
<li>
<p>Determine where new data belongs (which tenant or shared domain) to satisfy ownership and residency rules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Business value
- Compliance by construction: residency, separation, and least‑privilege enforced centrally.
- Clear audit: policies explain why a user saw or changed specific data.
- Low cost of change: update a rule, not a dozen services.</p>
</div>
<div class="paragraph">
<p>See also: <a href="../user-guide/permissions.html">Permissions and Policy Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_layered_architecture_clarity_and_agility">5.3. Layered architecture: clarity and agility</h3>
<div class="paragraph">
<p>Quantum separates concerns so teams can move independently while staying consistent:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identity and tenancy layer: integrates enterprise SSO, supports partner logins, and isolates each organization by default.</p>
</li>
<li>
<p>Policy layer: human‑readable rules specify who can do what and where data lives.</p>
</li>
<li>
<p>Ontology layer: defines entities and relationships; enables graph‑style reasoning and cascaded actions.</p>
</li>
<li>
<p>Data access &amp; query layer: consistent list/filter/query for all domains; fewer bespoke endpoints.</p>
</li>
<li>
<p>Workflow &amp; state layer: patterns for long‑running processes and completion tasks.</p>
</li>
<li>
<p>Seed packs &amp; configuration layer: versioned baseline data and settings for rapid, repeatable onboarding.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Business value
- Predictable delivery: features fit naturally into the layers instead of reinventing plumbing.
- Easier governance: one place to review identity, policy, and data placement.
- Extensibility: add domains and relationships without ripping up the foundation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_supply_chain_how_the_pieces_come_together">6. Supply chain: how the pieces come together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider a multi‑party supply chain platform where shippers, suppliers, carriers, and 3PLs collaborate.</p>
</div>
<div class="paragraph">
<p>Business needs
- Secure cross‑company sharing without exposing everything.
- Role‑appropriate visibility: planners, operators, and analysts each see what they need.
- Auditability and compliance across regions.
- Rapid partner onboarding without long IT cycles.</p>
</div>
<div class="paragraph">
<p>How Quantum addresses these needs</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ontology maps the domain</p>
</li>
<li>
<p>Entities: PurchaseOrder, Shipment, Item, Partner, Facility, Appointment, Invoice.</p>
</li>
<li>
<p>Relationships: Shipment fulfills PurchaseOrder; Partner operates Facility; Appointment schedules Facility for Shipment.</p>
</li>
<li>
<p>Outcomes: Ask meaningful questions like “Which late shipments are tied to orders from strategic suppliers with capacity constraints?”</p>
</li>
<li>
<p>Data governance via policy</p>
</li>
<li>
<p>Private by default: each company’s data is isolated within its tenant.</p>
</li>
<li>
<p>Deliberate sharing: create a "collaboration bubble" for a specific order or shipment so the buyer and a chosen carrier see the same milestones and documents—nothing more.</p>
</li>
<li>
<p>Residency &amp; scope: EU shipments remain in‑region; policies pin reads/writes accordingly.</p>
</li>
<li>
<p>Layered delivery</p>
</li>
<li>
<p>Identity/tenancy: enterprises use SSO; smaller partners use passwords; all mapped consistently.</p>
</li>
<li>
<p>Policy: human‑readable rules control who can VIEW, UPDATE, or APPROVE across areas like Collaboration or Finance.</p>
</li>
<li>
<p>Ontology: relationships drive navigation, automation, and impact analysis.</p>
</li>
<li>
<p>Query: one consistent List API powers dashboards and reports without proliferating endpoints.</p>
</li>
<li>
<p>Seed packs: onboard a new supplier with a versioned baseline—roles, code lists, sample workflows—applied in minutes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Measurable business outcomes
- Time‑to‑value: new partners live in days, not weeks.
- Lower operating risk: explainable access and audit trails by design.
- Better decisioning: cross‑entity insights (“orders at risk by lane and supplier”) with less IT effort.
- Product agility: add a returns workflow or a new KPI without re‑architecting.</p>
</div>
<div class="paragraph">
<p>For a business‑friendly deep dive, see the Supply Chain Collaboration guide (<a href="../tutorials/supply-chain.html">Supply Chain</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_quantum_fits_in_your_landscape">7. Where Quantum fits in your landscape</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Complement to ERP/TMS: Quantum doesn’t replace your systems of record; it coordinates collaboration around them with governed data sharing.</p>
</li>
<li>
<p>Safer data mesh: connect domains through the ontology and policies rather than ad‑hoc point‑to‑point contracts.</p>
</li>
<li>
<p>Cloud‑ready foundation: designed for multi‑tenant SaaS, whether deployed privately or as a shared service.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started_pragmatic_rollout">8. Getting started: pragmatic rollout</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Start with one domain and one outcome (e.g., shipment visibility and exception handling for a key lane).</p>
</li>
<li>
<p>Define the ontology for that slice and the access policies.</p>
</li>
<li>
<p>Use seed packs to bootstrap pilot tenants and iterate quickly.</p>
</li>
<li>
<p>Expand to adjacent domains (orders, appointments, invoices) once the core is delivering value.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary_for_executives">9. Summary for executives</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum gives you a governed, business‑aware foundation for multi‑party applications. Its ontology makes the business explicit; its policies make access and residency enforceable and explainable; and its layered architecture accelerates delivery while lowering risk. The result: faster product cycles, safer collaboration, and durable data assets that keep paying dividends as you grow.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tutorial-guide">10. Tutorial Guide</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="_quantum_tutorial_build_a_multi_tenant_saas_with_quantum" class="sect0">Quantum Tutorial: Build a Multi-tenant SaaS with Quantum</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This tutorial takes you end-to-end through building a small SaaS application on the Quantum framework.
It pulls in the core concepts and how-to content from the main index in a progressive, hands-on flow so you can learn by doing.</p>
</div>
<div class="paragraph">
<p>Audience: Mid-level Java developers building multi-tenant SaaS on Quarkus and MongoDB.
Prerequisites: JDK 17+, Maven, Docker (for local MongoDB), and basic familiarity with Quarkus.
Artifacts: The docs can be built as HTML/PDF via Maven; the code snippets compile against the Quantum modules published in this repo.</p>
</div>
<div class="paragraph">
<p>What you&#8217;ll build: A small, tenant-aware service with domain models, REST CRUD, flexible queries, security, migrations, and seed packs for baseline data.</p>
</div>
<div class="paragraph">
<p>Each section starts with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Problem: What we are solving</p>
</li>
<li>
<p>Why for SaaS: Why this matters in multi-tenant systems</p>
</li>
<li>
<p>How Quantum helps: Concepts and features that address the problem</p>
</li>
<li>
<p>Walkthrough: Code and configuration that build on prior sections</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Throughout, we reuse and expand the same example to reinforce learning. The reference guide links back to these sections for deeper context.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-setup">11. 1. Project setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Getting a runnable project scaffolded with Quantum and Quarkus.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Consistent project structure and dependencies are critical to scale teams and environments.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Provides opinionated dependencies, conventions, and ready-made modules for multi-tenancy, security, persistence, and seeding.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Follow the steps below to create and run your first service.</p>
</div>
<div class="sect2">
<h3 id="getting-started">11.1. Getting Started: Your First Quantum Application</h3>
<div class="paragraph">
<p>This section walks through creating a simple multi-tenant Product catalog to demonstrate core Quantum concepts.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites">11.1.1. Prerequisites</h4>
<div class="ulist">
<ul>
<li>
<p>Java 17+</p>
</li>
<li>
<p>Maven 3.8+</p>
</li>
<li>
<p>MongoDB (local or cloud)</p>
</li>
<li>
<p>Basic Quarkus knowledge (see <a href="../appendix/quarkus-foundation.html">Quarkus Foundation</a>)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_project_setup">11.1.2. Project Setup</h4>
<div class="paragraph">
<p>Create a new Quarkus project with Quantum dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:create \
    -DprojectGroupId=com.example \
    -DprojectArtifactId=product-catalog \
    -DclassName=&quot;com.example.ProductResource&quot; \
    -Dpath=&quot;/products&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add Quantum dependencies to <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.e2eq.framework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>quantum-framework<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${quantum.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">11.1.3. Configuration</h4>
<div class="paragraph">
<p>Create <code>.env</code> file (copy from template):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">MONGODB_USERNAME=your-username
MONGODB_PASSWORD=your-password
MONGODB_DATABASE=product-catalog
MONGODB_HOST=localhost:27017
JWT_SECRET=your-secret-key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basic <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># MongoDB
quarkus.mongodb.connection-string=${MONGODB_CONNECTION_STRING:mongodb://localhost:27017}
quarkus.mongodb.database=${MONGODB_DATABASE:product-catalog}

# JWT Authentication
auth.provider=custom
auth.jwt.secret=${JWT_SECRET:change-me-in-production}
auth.jwt.expiration=60

# CORS for development
quarkus.http.cors=true
quarkus.http.cors.origins=http://localhost:3000</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_your_first_model">11.1.4. Your First Model</h4>
<div class="paragraph">
<p>Create a Product model with multi-tenancy built-in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.model</span>;

<span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalMapping</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok.Data</span>;
<span class="keyword">import</span> <span class="include">lombok.EqualsAndHashCode</span>;
<span class="keyword">import</span> <span class="include">lombok.NoArgsConstructor</span>;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.Size</span>;
<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {

    <span class="annotation">@NotBlank</span>
    <span class="annotation">@Size</span>(max = <span class="integer">50</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;

    <span class="annotation">@NotBlank</span>
    <span class="annotation">@Size</span>(max = <span class="integer">200</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">private</span> <span class="predefined-type">String</span> description;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> price;
    <span class="directive">private</span> <span class="type">boolean</span> active = <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Key points:
- Extends <code>BaseModel</code> for automatic DataDomain, audit fields, and ID management
- <code>@FunctionalMapping</code> declares this model&#8217;s business area and domain for security rules
- Standard Jakarta validation annotations
- Lombok reduces boilerplate</p>
</div>
</div>
<div class="sect3">
<h4 id="_repository">11.1.5. Repository</h4>
<div class="paragraph">
<p>Create a repository interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.repository</span>;

<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.MorphiaRepo</span>;
<span class="keyword">import</span> <span class="include">com.example.model.Product</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ProductRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Product&gt; {
    <span class="comment">// Custom queries can be added here</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rest_resource">11.1.6. REST Resource</h4>
<div class="paragraph">
<p>Create a REST endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.resource</span>;

<span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">com.example.model.Product</span>;
<span class="keyword">import</span> <span class="include">com.example.repository.ProductRepo</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Inherits all CRUD endpoints: GET, POST, PUT, DELETE</span>
    <span class="comment">// GET /products/list - paginated list with filtering</span>
    <span class="comment">// GET /products/id/{id} - get by ID</span>
    <span class="comment">// POST /products - create new product</span>
    <span class="comment">// PUT /products/set?id={id}&amp;pairs=field:value - update fields</span>
    <span class="comment">// DELETE /products/id/{id} - delete product</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_application">11.1.7. Running the Application</h4>
<div class="paragraph">
<p>Start your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application provides:
- Swagger UI at <a href="http://localhost:8080/q/swagger-ui/" class="bare">http://localhost:8080/q/swagger-ui/</a>
- Dev UI at <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_your_api">11.1.8. Testing Your API</h4>
<div class="paragraph">
<p>Create a product:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST http://localhost:8080/products \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;sku&quot;: &quot;WIDGET-001&quot;,
    &quot;name&quot;: &quot;Super Widget&quot;,
    &quot;description&quot;: &quot;The best widget ever&quot;,
    &quot;price&quot;: 29.99,
    &quot;active&quot;: true
  }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>List products:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://localhost:8080/products/list?limit=10&amp;sort=+name&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Filter products:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://localhost:8080/products/list?filter=active:true&amp;&amp;price:&gt;##20&quot;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_you_get_automatically">11.1.9. What You Get Automatically</h4>
<div class="paragraph">
<p>With this minimal setup, Quantum provides:</p>
</div>
<div class="paragraph">
<p><strong>Multi-tenancy</strong>: Each product is automatically tagged with the creator&#8217;s DataDomain (tenant, org, owner)</p>
</div>
<div class="paragraph">
<p><strong>Security</strong>: DataDomain filtering ensures users only see their own data by default</p>
</div>
<div class="paragraph">
<p><strong>Validation</strong>: Jakarta Bean Validation runs before persistence</p>
</div>
<div class="paragraph">
<p><strong>Audit Trail</strong>: Automatic createdBy, createdDate, lastUpdatedBy, lastUpdatedDate fields</p>
</div>
<div class="paragraph">
<p><strong>Consistent APIs</strong>: Standard REST patterns across all resources</p>
</div>
<div class="paragraph">
<p><strong>Query Language</strong>: Powerful filtering with the ANTLR-based query syntax</p>
</div>
<div class="paragraph">
<p><strong>OpenAPI</strong>: Automatic API documentation</p>
</div>
</div>
<div class="sect3">
<h4 id="_next_steps">11.1.10. Next Steps</h4>
<div class="ulist">
<ul>
<li>
<p>Add authentication: <a href="auth.html">Authentication Guide</a></p>
</li>
<li>
<p>Create sharing rules: <a href="permissions.html">Permissions Guide</a></p>
</li>
<li>
<p>Learn the query language: <a href="query-language.html">Query Language</a></p>
</li>
<li>
<p>See real-world example: <a href="../tutorials/supply-chain.html">Supply Chain Tutorial</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_optional_enable_ontology_modules">11.1.11. Optional: Enable Ontology Modules</h4>
<div class="paragraph">
<p>You can adopt ontology incrementally. If you don’t enable it, everything works as before.</p>
</div>
<div class="paragraph">
<p>Quick checklist</p>
</div>
<div class="paragraph">
<p>1) Add dependencies (app-level)
- quantum-ontology-core, quantum-ontology-mongo, quantum-ontology-policy-bridge</p>
</div>
<div class="paragraph">
<p>2) Turn it on via config</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">e2eq.ontology.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>3) Provide an ontology registry (TBox)
- Start with an in-memory registry (recommended initially). See <a href="ontology.html">Ontologies in Quantum</a>.</p>
</div>
<div class="paragraph">
<p>4) Wire data and indexes
- Inject EdgeDao as a CDI bean (@Inject); indexes are ensured automatically at startup.
- Indices: (tenantId, p, dst) and (tenantId, src, p)</p>
</div>
<div class="paragraph">
<p>5) Materialize edges on entity changes
- Use OntologyMaterializer when sources or intermediates change (e.g., Order/Customer/Org/Address/Shipment in the e‑commerce example).</p>
</div>
<div class="paragraph">
<p>6) Use edges in queries/policies
- Wrap BSON via ListQueryRewriter or constrain by _id sets. See <a href="ontology.html#ontology-integration-morphia-permissions">Integrating Ontology</a>.</p>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep it optional: only wire beans and create collections when e2eq.ontology.enabled=true.</p>
</li>
<li>
<p>Multi-tenant: always pass tenantId from RuleContext.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-overview">12. 2. Platform overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Understanding the moving parts and how they fit together.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: You’ll be composing features (tenancy, security, APIs, data) across many modules and services.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: A cohesive model with clear boundaries and integration points.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Read the overview and keep it handy as you progress.</p>
</div>
<div class="sect2">
<h3 id="overview">12.1. Overview: Building SaaS with Quantum</h3>
<div class="paragraph">
<p>Quantum is a Quarkus-based framework that accelerates building multi-tenant SaaS platforms on MongoDB. It provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multi-tenancy primitives for tenant creation, isolation, and data sharing</p>
</li>
<li>
<p>A domain-first programming model with Functional Areas, Functional Domains, and Actions</p>
</li>
<li>
<p>Data security and contextual evaluation via DataDomain, DomainContext, and RuleContext</p>
</li>
<li>
<p>Consistent REST resources for find/get/list/save/update/delete operations</p>
</li>
<li>
<p>Pluggable authentication with a provided JWT module and extension points</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide targets mid-level Java developers and follows a structure similar to Spring’s reference docs. Use Maven to generate HTML/PDF: see docs module README for commands.</p>
</div>
<div class="sect3">
<h4 id="overview-saas">12.1.1. SaaS and Multi‑Tenancy First</h4>
<div class="paragraph">
<p>SaaS solutions require:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Onboarding automation: programmatic tenant creation, freemium/trial flows</p>
</li>
<li>
<p>Isolation with selective sharing</p>
</li>
<li>
<p>Policy-driven access that adapts to user, org, tenant, and action</p>
</li>
<li>
<p>Operational efficiency (observability, cost control, upgradeability)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum’s building blocks address these needs out-of-the-box while remaining flexible to fit your architecture.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-modeling">13. 3. Domain modeling fundamentals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Modeling your domain effectively for persistence and API exposure.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Cross-tenant scale and isolation drive modeling choices (IDs, natural keys, versioning, ownership).</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Provides base models, annotations, and repository patterns to model tenant-safe entities.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Build a minimal domain model and persist it.</p>
</div>
<div class="sect2">
<h3 id="modeling">13.1. Modeling with Functional Areas, Domains, and Actions</h3>
<div class="paragraph">
<p>Quantum organizes your system around three core constructs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional Area: A broad capability area (e.g., Identity, Catalog, Orders, Collaboration).</p>
</li>
<li>
<p>Functional Domain: A cohesive sub-area within an area (e.g., in Collaboration: Partners, Shipments, Tasks).</p>
</li>
<li>
<p>Actions: The set of operations applicable to a domain (CREATE, UPDATE, VIEW, DELETE, ARCHIVE, plus domain-specific actions).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These constructs allow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fine-grained sharing: Point specific functional areas to shared databases while others remain strictly segmented.</p>
</li>
<li>
<p>Policy composition: Apply RuleContext decisions at the level of area/domain/action.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_prefer_annotations_for_functional_mapping_recommended">Prefer Annotations for Functional Mapping (recommended)</h5>
<div class="paragraph">
<p>Starting with this version, you should use annotations to declare a model or resource&#8217;s Functional Area/Domain and the Action being performed. The legacy bmFunctionalArea() and bmFunctionalDomain() methods are still supported for backward compatibility in this release, but they will be phased out soon.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Class-level mapping: use @FunctionalMapping(area = "&lt;area&gt;", domain = "&lt;domain&gt;") on your model or resource class.</p>
</li>
<li>
<p>Method-level action: use @FunctionalAction("&lt;ACTION&gt;") on your JAX-RS resource methods when the action is not implied by the HTTP verb.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example: model annotated with FunctionalMapping</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok</span>.*;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalMapping</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="comment">// No need to override bmFunctionalArea/bmFunctionalDomain when using @FunctionalMapping</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: resource method annotated with FunctionalAction</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">jakarta.ws.rs</span>.*;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalAction</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> {

    <span class="comment">// Action will default from HTTP verb (POST -&gt; CREATE), but you can be explicit:</span>
    <span class="annotation">@POST</span>
    <span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Product create(Product payload) { <span class="comment">/* ... */</span> <span class="keyword">return</span> payload; }

    <span class="comment">// GET will infer VIEW automatically when building the ResourceContext</span>
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Product get(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) { <span class="comment">/* ... */</span> <span class="keyword">return</span> <span class="keyword">new</span> Product(); }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How the framework uses these annotations</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityFilter: If the matched resource class has @FunctionalMapping, it uses area/domain from the annotation. If the method has @FunctionalAction, it uses that value; otherwise, it infers the action from the HTTP method (GET=VIEW, POST=CREATE, PUT/PATCH=UPDATE, DELETE=DELETE). If annotations are absent, it falls back to the existing path- and convention-based logic.</p>
</li>
<li>
<p>MorphiaRepo.fillUIActions: If the model class has @FunctionalMapping, its area/domain are used to resolve allowed UI actions; otherwise, it falls back to the legacy bmFunctionalArea()/bmFunctionalDomain() methods.</p>
</li>
<li>
<p>PermissionResource: When listing functional domains, it prefers @FunctionalMapping on entity classes and falls back to bmFunctionalArea()/bmFunctionalDomain() when missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Migration notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preferred: add @FunctionalMapping to each model class (or resource class) and remove the bmFunctionalArea/bmFunctionalDomain overrides.</p>
</li>
<li>
<p>Transitional: you can keep the legacy methods; they will be used only if the annotation is not present.</p>
</li>
<li>
<p>Future: bmFunctionalArea and bmFunctionalDomain will be removed in a future release; plan to migrate now.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also: <a href="security-annotations.html#security-annotations">Security Annotations: FunctionalMapping and FunctionalAction</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_datadomain_on_models">DataDomain on Models</h5>
<div class="paragraph">
<p>All persisted models carry DataDomain (tenantId, orgRefName, ownerId, etc.) for rule-based filtering and cross-tenant sharing.</p>
</div>
<div class="paragraph">
<p>Example model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok.Data</span>;
<span class="keyword">import</span> <span class="include">lombok.EqualsAndHashCode</span>;
<span class="keyword">import</span> <span class="include">lombok.NoArgsConstructor</span>;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Product</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_persistence_repositories">Persistence Repositories</h5>
<div class="paragraph">
<p>Define a repository to persist and query your model. With Morphia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.MorphiaRepo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ProductRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Product&gt; {
    <span class="comment">// custom queries can be added here</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_exposing_rest_resources">Exposing REST Resources</h5>
<div class="paragraph">
<p>Expose consistent CRUD endpoints by extending BaseResource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Inherit find, get, list, save, update, delete endpoints</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this minimal setup, you get standard REST APIs guarded by RuleContext/DataDomain and enriched with UIAction metadata.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lombok_in_models">Lombok in Models</h5>
<div class="paragraph">
<p>Lombok reduces boilerplate in Quantum models and supports inheritance-friendly builders.</p>
</div>
<div class="paragraph">
<p>Common annotations you will see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Data: Generates getters, setters, toString, equals, and hashCode.</p>
</li>
<li>
<p>@NoArgsConstructor: Required by frameworks that need a no-arg constructor (e.g., Jackson, Morphia).</p>
</li>
<li>
<p>@EqualsAndHashCode(callSuper = true): Includes superclass fields in equality and hash.</p>
</li>
<li>
<p>@SuperBuilder: Provides a builder that cooperates with parent classes (useful for BaseModel subclasses).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> sku;
  <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Prefer @SuperBuilder over @Builder when extending BaseModel/UnversionedBaseModel.
- Keep equals/hashCode stable for collections and caches; include callSuper when needed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_validation_with_jakarta_bean_validation">Validation with Jakarta Bean Validation</h5>
<div class="paragraph">
<p>Quantum uses Jakarta Bean Validation to enforce invariants on models at persist time (and optionally at REST boundaries).</p>
</div>
<div class="paragraph">
<p>Typical annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Size(min=3): String/collection length constraints.</p>
</li>
<li>
<p>@Valid: Cascade validation to nested objects (e.g., DataDomain on models).</p>
</li>
<li>
<p>@NotNull, @Email, @Pattern, etc., as needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where validation runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Repository layer via Morphia ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Executes validator.validate(entity) before the document is written.</p>
</li>
<li>
<p>If there are violations and the entity does not implement InvalidSavable with canSaveInvalid=true, an E2eqValidationException is thrown.</p>
</li>
<li>
<p>If DataDomain is null and SecurityContext has a principal, ValidationInterceptor will default the DataDomain from the principal context.</p>
</li>
<li>
<p>Optionally at REST boundaries: You may also annotate resource DTOs/parameters with Jakarta validation; Quarkus can validate them before the method executes.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jackson_vs_jakarta_validation_annotations">Jackson vs Jakarta Validation Annotations</h5>
<div class="paragraph">
<p>These two families of annotations serve different purposes and complement each other:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jackson annotations (com.fasterxml.jackson.annotation.*) control JSON serialization/deserialization.</p>
</li>
<li>
<p>Examples: @JsonIgnore, @JsonIgnoreProperties, @JsonProperty, @JsonInclude.</p>
</li>
<li>
<p>They do not enforce business constraints; they affect how JSON is produced/consumed.</p>
</li>
<li>
<p>Jakarta Validation annotations (jakarta.validation.*) declare constraints that are evaluated at runtime.</p>
</li>
<li>
<p>Examples: @NotNull, @Size, @Valid, @Pattern.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Correspondence and interplay:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Jackson to hide or rename fields in API responses/requests (e.g., @JsonIgnore on transient/calculated fields such as UIActionList).</p>
</li>
<li>
<p>Use Jakarta Validation to ensure incoming/outgoing models satisfy required constraints; ValidationInterceptor runs before persistence to enforce them.</p>
</li>
<li>
<p>It’s common to annotate the same field with both families when you both constrain values and want specific JSON behavior.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jackson_objectmapper_in_quarkus_and_in_quantum">13.2. Jackson ObjectMapper in Quarkus and in Quantum</h3>
<div class="paragraph">
<p>How Quarkus creates ObjectMapper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus produces a CDI-managed ObjectMapper. You can customize it by providing a bean that implements io.quarkus.jackson.ObjectMapperCustomizer.</p>
</li>
<li>
<p>You can also tweak common features via application.properties using quarkus.jackson.* properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The framework provides a QuarkusJacksonCustomizer that:</p>
</li>
<li>
<p>Sets DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES = true (reject unknown JSON fields).</p>
</li>
<li>
<p>Registers custom serializers/deserializers for org.bson.types.ObjectId so it can be used as String in APIs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Snippet from the framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">QuarkusJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper objectMapper) {
    objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="predefined-constant">true</span>);
    SimpleModule module = <span class="keyword">new</span> SimpleModule();
    module.addSerializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonSerializer());
    module.addDeserializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonDeserializer());
    objectMapper.registerModule(module);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Customize in your app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add another ObjectMapperCustomizer bean (order is not guaranteed; make changes idempotent):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper mapper) {
    mapper.findAndRegisterModules();
    mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
    mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
  }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Or set properties in application.properties:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Fail if extraneous fields are present
quarkus.jackson.fail-on-unknown-properties=true
# Example date format and inclusion
quarkus.jackson.write-dates-as-timestamps=false
quarkus.jackson.serialization-inclusion=NON_NULL</code></pre>
</div>
</div>
<div class="paragraph">
<p>When to adjust:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relax fail-on-unknown only for backward-compatibility scenarios; strictness helps catch client mistakes.</p>
</li>
<li>
<p>Register modules (JavaTime, etc.) if your models include those types.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_validation_lifecycle_and_morphia_interceptors">13.3. Validation Lifecycle and Morphia Interceptors</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-eb93a6a189c8f862001d90ef83301062.svg" alt="Diagram" width="1332" height="446">
</div>
</div>
<div class="paragraph">
<p>Morphia interceptors enhance and enforce behavior during persistence. Quantum registers the following for each realm-specific datastore:</p>
</div>
<div class="paragraph">
<p>Order of registration (see MorphiaDataStore):
1) ValidationInterceptor
2) PermissionRuleInterceptor
3) AuditInterceptor
4) ReferenceInterceptor
5) PersistenceAuditEventInterceptor</p>
</div>
<div class="paragraph">
<p>High-level responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Defaults DataDomain from SecurityContext if missing.</p>
</li>
<li>
<p>Runs bean validation and throws E2eqValidationException on violations unless the entity supports saving invalid states (InvalidSavable).</p>
</li>
<li>
<p>PermissionRuleInterceptor (prePersist):</p>
</li>
<li>
<p>Evaluates RuleContext with PrincipalContext and ResourceContext from SecurityContext.</p>
</li>
<li>
<p>Throws SecurityCheckException if the rule decision is not ALLOW (enforcing write permissions for save/update/delete).</p>
</li>
<li>
<p>AuditInterceptor (prePersist):</p>
</li>
<li>
<p>Sets AuditInfo on creation and updates lastUpdate fields on modification; captures impersonation details if present.</p>
</li>
<li>
<p>ReferenceInterceptor (prePersist):</p>
</li>
<li>
<p>For @Reference fields annotated with @TrackReferences, maintains back-references on the parent entities via ReferenceEntry and persists the parent when needed.</p>
</li>
<li>
<p>PersistenceAuditEventInterceptor (prePersist when @AuditPersistence is present):</p>
</li>
<li>
<p>Appends a PersistentEvent with type PERSIST, date, userId, and version to the model’s persistentEvents before saving.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When does validation occur?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On every save/update path that hits persistence, prePersist triggers validation (and permission/audit/reference processing) before the document is written to MongoDB, guaranteeing constraints and policies are enforced consistently across all repositories.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_functional_areadomain_in_rulecontext_permission_language">13.4. Functional Area/Domain in RuleContext Permission Language</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-d1b559d0b5553fa1f33a365251de99a5.svg" alt="Diagram" width="1049" height="350">
</div>
</div>
<div class="paragraph">
<p>Models express their placement in the business model via:
- bmFunctionalArea(): returns a broad capability area (e.g., Catalog, Collaboration, Identity)
- bmFunctionalDomain(): returns the specific domain within that area (e.g., Product, Shipment, Partner)</p>
</div>
<div class="paragraph">
<p>How these map into authorization and rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ResourceContext/DomainContext: When a request operates on a model, the framework derives the functional area and domain from the model type (or resource) and places them on the current context alongside the action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE). RuleContext consumes these to evaluate policies.</p>
</li>
<li>
<p>Permission language (SecurityURI-based matching): The framework derives area and functionalDomain from REST path segments using the convention: /{area}/{functionalDomain}/{action}/&#8230;&#8203; . These values, together with action and identity, form the SecurityURI (header + body) used by the rule engine. Rules match on SecurityURI fields using wildcard string comparison; there is no HTTP method/URL pattern matching.</p>
</li>
<li>
<p>Permission language (query variables): The ANTLR-based query language exposes variables that can be referenced in filters:</p>
</li>
<li>
<p>${area} corresponds to bmFunctionalArea()</p>
</li>
<li>
<p>${functionalDomain} corresponds to bmFunctionalDomain()
These can be used to author reusable filters or to record audit decisions by area/domain.</p>
</li>
<li>
<p>Repository filters: RuleContext can contribute additional predicates that are area/domain-specific, enabling fine-grained sharing. For example, a shared Catalog area may allow cross-tenant VIEW, while a Collaboration.Shipment domain remains tenant-strict.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>1) SecurityURI-based rule matching (Permissions)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-catalog-product-reads</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Allow USER and ADMIN to view products in the Catalog area</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">USER</span></span>            <span class="comment"># role treated as identity; author a second rule for ADMIN if needed</span>
      <span class="key">area</span>: <span class="string"><span class="content">Catalog</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">Product</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">system-com</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Query variable usage (Filters)</p>
</div>
<div class="paragraph">
<p>You can reference the active area/domain in filter expressions (e.g., for auditing or conditional branching in custom rule evaluators):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Constrain reads differently when operating in the Catalog area
(${area}:&quot;Catalog&quot; &amp;&amp; dataDomain.orgRefName:&quot;PUBLIC&quot;) ||
(${area}:!&quot;Catalog&quot; &amp;&amp; dataDomain.tenantId:${pTenantId})</code></pre>
</div>
</div>
<div class="paragraph">
<p>3) Model-driven mapping</p>
</div>
<div class="paragraph">
<p>Given a model like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Collaboration</span><span class="delimiter">&quot;</span></span>; }
<span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>; }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Incoming REST requests that operate on Shipment resources set area=Collaboration and functionalDomain=Shipment in the ResourceContext.</p>
</li>
<li>
<p>RuleContext evaluates policies considering action + area + domain, e.g., deny cross-tenant UPDATE in Collaboration.Shipment, but allow cross-tenant VIEW in Collaboration.Partner if marked shared.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Path convention: Use leading segments /{area}/{functionalDomain}/{action}/&#8230;&#8203; so the framework can derive ResourceContext reliably. Extra segments after the first three are allowed; only the first three are used to compute area, domain, and action.</p>
</li>
<li>
<p>Nonconformant paths: If the path has fewer than three segments, the framework sets an anonymous/default ResourceContext. In practice, rules will typically evaluate to DENY unless there is an explicit allowance for anonymous contexts.</p>
</li>
<li>
<p>See also: the Permissions section for rule-base matching and priorities, and the DomainContext/RuleContext section for end-to-end flow.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_stategraphs_on_models">13.5. StateGraphs on Models</h3>
<div class="paragraph">
<p>StateGraphs let you restrict valid values and transitions of String state fields. They are declared on model fields with @StateGraph and enforced during save/update when the model class is annotated with @Stateful.</p>
</div>
<div class="paragraph">
<p>Key pieces:
- @StateGraph(graphName="&#8230;&#8203;"): mark a String field as governed by a named state graph.
- @Stateful: mark the entity type as participating in state validation.
- StateGraphManager: runtime registry that holds graphs and validates transitions.
- StringState and StateNode: define the graph (states, initial/final flags, transitions).</p>
</div>
<div class="paragraph">
<p>Defining a state graph at startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Startup</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StateGraphInitializer</span> {
  <span class="annotation">@Inject</span> StateGraphManager stateGraphManager;
  <span class="annotation">@PostConstruct</span> <span class="type">void</span> init() {
    StringState order = <span class="keyword">new</span> StringState();
    order.setFieldName(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, StateNode&gt; states = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">true</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    order.setStates(states);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">List</span>&lt;StateNode&gt;&gt; transitions = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    order.setTransitions(transitions);

    stateGraphManager.defineStateGraph(order);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_state_graph_dot">13.6. State Graph (DOT)</h3>
<div class="imageblock">
<div class="content">
<img src="state-graph.svg" alt="state graph" width="1006" height="353">
</div>
</div>
<div class="paragraph">
<p>Using the graph in a model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateful</span>
<span class="annotation">@Entity</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@StateGraph</span>(graphName = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">private</span> <span class="predefined-type">String</span> status;

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Orders</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="state-lifecycle.svg" alt="state lifecycle" width="836" height="569">
</div>
</div>
<div class="paragraph">
<p>How it affects save/update:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On create: validateInitialStates ensures the field value is one of the configured initial states. Otherwise, InvalidStateTransitionException is thrown.</p>
</li>
<li>
<p>On update: validateStateTransitions checks each @StateGraph field’s old&#8594;new transition against the graph via StateGraphManager.validateTransition(). If invalid, save/update fails with InvalidStateTransitionException. This applies to full-entity saves and to partial updates via repo.update(&#8230;&#8203;pairs) on that field.</p>
</li>
<li>
<p>Utilities: StateGraphManager.getNextPossibleStates(graphName, current) and printStateGraph(&#8230;&#8203;) can aid UIs.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_completiontasks_and_completiontaskgroups">13.7. CompletionTasks and CompletionTaskGroups</h3>
<div class="paragraph">
<p>CompletionTasks and CompletionTaskGroups provide a simple, persistent way to track a series of work items that need to be completed, either by background processes or external systems. Use them when you need durable progress tracking across restarts and an auditable record of outcomes.</p>
</div>
<div class="paragraph">
<p>Key models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CompletionTask: an individual unit of work with fields like status, timestamps, and optional result/details.</p>
</li>
<li>
<p>CompletionTaskGroup: a container that represents a cohort of tasks progressing toward completion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Model overview:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Individual task</span>
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">completionTask</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CompletionTask</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">public</span> <span class="type">enum</span> Status { PENDING, RUNNING, SUCCESS, FAILED }

  <span class="annotation">@Reference</span>
  CompletionTaskGroup group;   <span class="comment">// optional grouping</span>
  <span class="predefined-type">String</span> details;              <span class="comment">// human-readable context (what/why)</span>
  Status status;               <span class="comment">// PENDING -&gt; RUNNING -&gt; (SUCCESS|FAILED)</span>
  <span class="predefined-type">Date</span> createdDate;            <span class="comment">// when the task was created</span>
  <span class="predefined-type">Date</span> completedDate;          <span class="comment">// set when terminal (SUCCESS/FAILED)</span>
  <span class="predefined-type">String</span> result;               <span class="comment">// output, message, or error summary</span>

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()   { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">TASK</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETION_TASK</span><span class="delimiter">&quot;</span></span>; }
}

<span class="comment">// Group of tasks</span>
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">completionTaskGroup</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CompletionTaskGroup</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">public</span> <span class="type">enum</span> Status { NEW, RUNNING, COMPLETE }

  <span class="predefined-type">String</span> description;   <span class="comment">// e.g., &quot;Onboarding: create resources&quot;</span>
  Status status;        <span class="comment">// reflects overall progress of the group</span>
  <span class="predefined-type">Date</span> createdDate;     <span class="comment">// when the group was created</span>
  <span class="predefined-type">Date</span> completedDate;   <span class="comment">// when the group finished</span>

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()   { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">TASK</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETION_TASK_GROUP</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typical lifecycle:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-2eeb655becc44b8fa685c07e4ac12e5c.svg" alt="Diagram" width="760" height="738">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a CompletionTaskGroup in NEW status.</p>
</li>
<li>
<p>Create N CompletionTasks (status=PENDING) referencing the group.</p>
</li>
<li>
<p>A worker picks tasks and flips status to RUNNING, performs the work, then to SUCCESS or FAILED, setting completedDate and result.</p>
</li>
<li>
<p>Periodically update the group:</p>
</li>
<li>
<p>If at least one task is RUNNING (and none pending), set group status to RUNNING.</p>
</li>
<li>
<p>When all tasks are terminal (SUCCESS or FAILED), set group status to COMPLETE and completedDate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to use for tracking a series of things that need to be completed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Batch operations: When submitting a batch (e.g., provisioning 100 accounts), create one group and 100 tasks. The UI/API can poll the group to show overall progress and per-item results.</p>
</li>
<li>
<p>Multi-step workflows: Represent each step as its own task, or use one task per target resource. Groups help correlate all steps for a single business request.</p>
</li>
<li>
<p>Retry/compensation: FAILED tasks can be retried by creating new tasks or resetting status to PENDING based on your policy. Keep result populated with failure reasons.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example creation flow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionTaskGroup group = CompletionTaskGroup.builder()
  .description(<span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog import: 250 SKUs</span><span class="delimiter">&quot;</span></span>)
  .status(CompletionTaskGroup.Status.NEW)
  .createdDate(<span class="keyword">new</span> <span class="predefined-type">Date</span>())
  .build();
completionTaskGroupRepo.save(group);

<span class="keyword">for</span> (Sku s : skus) {
  CompletionTask t = CompletionTask.builder()
    .group(group)
    .details(<span class="string"><span class="delimiter">&quot;</span><span class="content">Import SKU </span><span class="delimiter">&quot;</span></span> + s.code())
    .status(CompletionTask.Status.PENDING)
    .createdDate(<span class="keyword">new</span> <span class="predefined-type">Date</span>())
    .build();
  completionTaskRepo.save(t);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example worker progression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Fetch a PENDING task and execute</span>
CompletionTask t = completionTaskRepo.findOneByStatus(CompletionTask.Status.PENDING);
<span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) {
  completionTaskRepo.update(t.getId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.RUNNING);
  <span class="keyword">try</span> {
    <span class="comment">// ... do work ...</span>
    completionTaskRepo.update(t.getId(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.SUCCESS,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OK</span><span class="delimiter">&quot;</span></span>);
  } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    completionTaskRepo.update(t.getId(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.FAILED,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>, e.getMessage());
  }
}

<span class="comment">// Periodically recompute group status</span>
<span class="predefined-type">List</span>&lt;CompletionTask&gt; tasks = completionTaskRepo.findByGroup(group);
<span class="type">boolean</span> allTerminal = tasks.stream().allMatch(x -&gt; x.getStatus()==SUCCESS || x.getStatus()==FAILED);
<span class="type">boolean</span> anyRunning = tasks.stream().anyMatch(x -&gt; x.getStatus()==RUNNING);
<span class="type">boolean</span> anyPending = tasks.stream().anyMatch(x -&gt; x.getStatus()==PENDING);

<span class="keyword">if</span> (allTerminal) {
  completionTaskGroupRepo.update(group.getId(),
    <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTaskGroup.Status.COMPLETE,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>());
} <span class="keyword">else</span> <span class="keyword">if</span> (anyRunning || (!anyPending &amp;&amp; !allTerminal)) {
  completionTaskGroupRepo.update(group.getId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTaskGroup.Status.RUNNING);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes and best practices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep details short but diagnostic, and store richer context in result.</p>
</li>
<li>
<p>Use DataDomain fields for multi-tenant scoping so groups/tasks are isolated per tenant/org as needed.</p>
</li>
<li>
<p>Avoid unbounded growth: archive or purge old groups once COMPLETE.</p>
</li>
<li>
<p>Consider idempotency keys in details or a custom field to prevent processing the same logical work twice.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_references_and_entityreference">13.8. References and EntityReference</h3>
<div class="paragraph">
<p>Morphia @Reference establishes relationships between entities:
- One-to-one: a BaseModel field annotated with @Reference.
- One-to-many: a Collection&lt;BaseModel&gt; field annotated with @Reference.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Shipment</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@Reference</span>(ignoreMissing = <span class="predefined-constant">false</span>)
  <span class="annotation">@TrackReferences</span>
  <span class="directive">private</span> Partner partner;   <span class="comment">// parent entity</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>EntityReference is a lightweight reference object used across the framework to avoid DBRef loading when only identity info is needed. Any model can produce one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityReference ref = shipment.createEntityReference();
<span class="comment">// contains: entityId, entityType, entityRefName, entityDisplayName (and optional realm)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>REST convenience:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BaseResource exposes GET /entityref to list EntityReference for a model with optional filter/sort.</p>
</li>
<li>
<p>Repositories expose getEntityReferenceListByQuery(&#8230;&#8203;), and utilities exist to convert lists of EntityReference back to entities when needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When to use which:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use @Reference for strong persistence-level links where Morphia should maintain foreign references.</p>
</li>
<li>
<p>Use EntityReference for UI lists, foreign-key-like pointers in other documents, events/audit logs, or cross-module decoupling without DBRef behavior.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tracking_references_with_trackreferences_and_delete_semantics">13.9. Tracking References with @TrackReferences and Delete Semantics</h3>
<div class="paragraph">
<p>@TrackReferences on a @Reference field tells the framework to maintain a back-reference set on the parent entity. The back-reference field is UnversionedBaseModel.references (a Set&lt;ReferenceEntry&gt;), which is calculated/maintained by the framework and should not be set by clients.</p>
</div>
<div class="paragraph">
<p>What references contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each ReferenceEntry holds: referencedId (ObjectId of the child), type (fully-qualified class name of the child’s entity), and refName (child’s stable reference name).</p>
</li>
<li>
<p>It indicates that the parent is being referenced by the given child entity. The set is used for fast checks and to enforce referential integrity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How tracking works (save/update):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReferenceInterceptor inspects @Reference fields annotated with @TrackReferences during prePersist.</p>
</li>
<li>
<p>When a child references a parent, a ReferenceEntry for the child is added to the parent’s references set and the parent is saved to persist the back-reference.</p>
</li>
<li>
<p>For @Reference collections, entries are added for each child-parent pair.</p>
</li>
<li>
<p>If a @Reference is null but ignoreMissing=false, a save will fail with an IllegalStateException since the parent is required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How it affects delete:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During delete in MorphiaRepo.delete(&#8230;&#8203;):</p>
</li>
<li>
<p>If obj.references is empty, the object can be deleted directly (after removing any references it holds to parents).</p>
</li>
<li>
<p>If obj.references is not empty, the repo checks each ReferenceEntry. If any referring parent still exists, a ReferentialIntegrityViolationException is thrown to prevent breaking relationships.</p>
</li>
<li>
<p>If all references are stale (referring objects no longer exist), the repo removes stale entries, removes this object’s own reference constraints from parents, and performs the delete within a transaction.</p>
</li>
<li>
<p>removeReferenceConstraint(&#8230;&#8203;) ensures that, when deleting a child, its ReferenceEntry is removed from parent.references and the parent is saved, keeping back-references consistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Practical guidance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotate parent links with both @Reference and @TrackReferences when you need strong integrity guarantees and easy “who references me?” queries.</p>
</li>
<li>
<p>Use ignoreMissing=true only for optional references; you still get back-reference tracking when not null.</p>
</li>
<li>
<p>Expect HTTP delete to fail with a meaningful error if there are live references; remove or update those references first, or design cascading behavior explicitly in your domain logic.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="ontologies-in-quantum">13.9.1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Looking for the short implementation plan? See PROPOSAL.md at the repository root for a concise module-by-module checklist.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section explains what an ontology is, how it differs from a traditional object model, and how the Quantum Ontology modules make it practical to apply ontology ideas to your domain models and queries. It also contrasts ontology-driven relationships with direct object references (for example, using @Reference or EntityReference).</p>
</div>
<div class="sect4">
<h5 id="_what_is_an_ontology">What is an Ontology?</h5>
<div class="paragraph">
<p>In software terms, an ontology is a formal, explicit specification of concepts and their relationships.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concepts (Classes): Named categories/types in your domain. Concepts can form taxonomies (is-a hierarchies), be declared disjoint, or be equivalent.</p>
</li>
<li>
<p>Relationships (Properties): Named relationships between entities. Properties can have a domain (applies to X) and a range (points to Y). They may be inverse or transitive.</p>
</li>
<li>
<p>Axioms (Rules): Constraints and entailment rules, including property chains such as: if (A --p-&#8594; B) and (B --q-&#8594; C) then we infer (A --r-&#8594; C).</p>
</li>
<li>
<p>Inference: The process of deriving new facts (types, labels, edges) that were not explicitly stored but follow from axioms and known facts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An ontology is not the data; it is the schema plus logic that gives your data additional meaning and enables consistent, automated inferences.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ontology_vs_object_model">Ontology vs. Object Model</h5>
<div class="paragraph">
<p>A conventional object model focuses on concrete classes, fields, and direct references between objects at implementation time. An ontology focuses on semantic types and relationships, with explicit rules that can derive new knowledge independent of how objects are instantiated.</p>
</div>
<div class="paragraph">
<p>Key differences:
- Purpose
  - Object model: Encapsulate data and behavior for application code generation and persistence.
  - Ontology: Encode shared meaning, constraints, and inference rules that remain stable as implementation details change.
- Relationship handling
  - Object model: Typically uses direct references or foreign keys; traversals are hard-coded and fragile to change.
  - Ontology: Uses named predicates (properties) and can infer additional relationships by rules (property chains, inverses, transitivity).
- Polymorphism and evolution
  - Object model: Polymorphism requires class inheritance in code; cross-cutting categories are awkward to add later.
  - Ontology: Entities can have multiple types/labels at once. New concepts and properties can be introduced without breaking existing data.
- Querying
  - Object model: Queries couple to concrete classes and field paths; changes force query rewrites.
  - Ontology: Queries target semantic relationships; reasoners can materialize edges that queries reuse, decoupling queries from implementation details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_why_prefer_ontology_driven_relationships_over_referenceentityreference">Why prefer Ontology-driven relationships over @Reference/EntityReference</h5>
<div class="paragraph">
<p>Direct references (@Reference or custom EntityReference) are simple to start but become restrictive as domains grow:
- Tight coupling: Code and queries couple to concrete field paths (customer.primaryAddress.id), making refactors risky.
- Limited expressivity: Hard to encode and reuse higher-order relationships (e.g., "partners of my supplier&#8217;s parent org").
- Poor polymorphism: References point to one collection/type; accommodating multiple target types requires extra code.
- Performance pitfalls: Deep traversals cause extra queries, N+1 selects, or complex $lookup joins.</p>
</div>
<div class="paragraph">
<p>Ontology-driven edges address these issues:
- Decoupling via predicates: Use named predicates (e.g., hasAddress, memberOf, supplies) that remain stable while internal object fields change.
- Inference for reachability: Property chains can materialize implied links (A --p-&#8594; B &amp; B --q-&#8594; C &#8658; A --r-&#8594; C), avoiding runtime multi-hop traversals.
- Polymorphism-first: A predicate can connect heterogeneous types; type inferences (domain/range) remain consistent.
- Query performance: Pre-materialized edges allow single-hop, index-friendly queries (in or eq filters) instead of ad-hoc multi-collection traversals.
- Resilience to change: You can add or modify rules without rewriting data structures or touching referencing fields across models.</p>
</div>
</div>
<div class="sect4">
<h5 id="_how_quantum_supports_ontologies">How Quantum supports Ontologies</h5>
<div class="paragraph">
<p>Quantum provides three cooperating modules that make ontology modeling practical and fast:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum-ontology-core (package com.e2eq.ontology.core)</p>
</li>
<li>
<p>OntologyRegistry: Holds the TBox (terminology) of your ontology.</p>
</li>
<li>
<p>ClassDef: Concept names and relationships (parents, disjointWith, sameAs).</p>
</li>
<li>
<p>PropertyDef: Property names with optional domain, range, inverse flags, and transitivity.</p>
</li>
<li>
<p>PropertyChainDef: Rules that define multi-hop implications (chains &#8594; implied property).</p>
</li>
<li>
<p>TBox: Container for classes, properties, and property chains.</p>
</li>
<li>
<p>Reasoner interface and ForwardChainingReasoner: Given an entity snapshot and the registry, computes inferences:</p>
</li>
<li>
<p>New types/labels to assert on entities.</p>
</li>
<li>
<p>New edges to add (implied by property chains, inverses, or other rules).</p>
</li>
<li>
<p>quantum-ontology-mongo (package com.e2eq.ontology.mongo)</p>
</li>
<li>
<p>EdgeDao: A thin DAO around an edges collection in Mongo. Each edge contains tenantId, src, predicate p, dst, inferred flag, provenance, and timestamp.</p>
</li>
<li>
<p>OntologyMaterializer: Runs the Reasoner for an entity snapshot and upserts the inferred edges, so queries can be rewritten to simple in/in eq filters.</p>
</li>
<li>
<p>quantum-ontology-policy-bridge (package com.e2eq.ontology.policy)</p>
</li>
<li>
<p>ListQueryRewriter: Takes a base query and rewrites it using the EdgeDao to filter by the set of source entity ids that have a specific predicate to a given destination.</p>
</li>
<li>
<p>This integrates ontology edges with RuleContext or policy decisions: policy asks for entities related by a predicate; the rewriter converts that into an efficient Mongo query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These modules let you define your ontology (core), materialize derived relations (mongo), and leverage them in access and list queries (policy bridge).</p>
</div>
</div>
<div class="sect4">
<h5 id="_modeling_guidance_from_object_fields_to_predicates">Modeling guidance: from object fields to predicates</h5>
<div class="ulist">
<ul>
<li>
<p>Name relationships explicitly</p>
</li>
<li>
<p>Define clear predicate names (hasAddress, memberOf, supplies, owns, assignedTo). Avoid encoding relationship semantics in field names only.</p>
</li>
<li>
<p>Keep object model minimal and flexible</p>
</li>
<li>
<p>Store lightweight identifiers (ids) as needed, but avoid deeply nested reference graphs that encode traversals in code.</p>
</li>
<li>
<p>Model polymorphic relationships</p>
</li>
<li>
<p>Prefer predicates that naturally connect multiple possible types (e.g., assignedTo can target User, Team, Bot) and rely on ontology type assertions to constrain where needed.</p>
</li>
<li>
<p>Use property chains for common paths</p>
</li>
<li>
<p>If business logic often traverses A &#8594; B &#8594; C, define a chain p∘q ⇒ r and materialize r for faster queries and simpler policies.</p>
</li>
<li>
<p>Capture inverses and transitivity</p>
</li>
<li>
<p>For natural inverses (parentOf ⇄ childOf) or transitive relations (partOf, locatedIn), define them in the ontology so edges and queries stay consistent.</p>
</li>
<li>
<p>Keep provenance</p>
</li>
<li>
<p>Record why an edge exists (prov.rule, prov.inputs) so you can recompute, audit, or retract when inputs change.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_querying_with_ontology_edges_vs_direct_references">Querying with ontology edges vs direct references</h5>
<div class="ulist">
<ul>
<li>
<p>Direct reference example (fragile/slow)</p>
</li>
<li>
<p>Query: "Find Orders whose buyer belongs to Org X or its parents."</p>
</li>
<li>
<p>With @Reference: requires joining Order &#8594; User &#8594; Org and recursing org.parent; costly and tightly coupled to fields.</p>
</li>
<li>
<p>Ontology edge example (resilient/fast)</p>
</li>
<li>
<p>Define predicates: placedBy(order, user), memberOf(user, org), ancestorOf(org, org). Define chain placedBy ∘ memberOf ⇒ placedInOrg.</p>
</li>
<li>
<p>Materialize edges: (order --placedInOrg-&#8594; org). Also make ancestorOf transitive.</p>
</li>
<li>
<p>Query becomes: where order._id in EdgeDao.srcIdsByDst(tenantId, "placedInOrg", orgX).</p>
</li>
<li>
<p>With transitivity, you can precompute ancestor closure or add a chain placedInOrg ∘ ancestorOf ⇒ placedInOrg to include parents automatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_migration_from_reference_to_ontology_edges">Migration: from @Reference to ontology edges</h5>
<div class="ulist">
<ul>
<li>
<p>Start by introducing predicates alongside existing references; do not remove references immediately.</p>
</li>
<li>
<p>Materialize edges for hot read paths; keep provenance so you can reconstruct.</p>
</li>
<li>
<p>Gradually update queries (list screens, policy filters) to use ListQueryRewriter with EdgeDao instead of deep traversals or $lookup.</p>
</li>
<li>
<p>Once stable, you can simplify models by removing rigid reference fields where unnecessary and rely on edges for read-side composition.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_performance_and_operational_notes">Performance and operational notes</h5>
<div class="ulist">
<ul>
<li>
<p>Indexing: Create compound indexes on edges: (tenantId, p, dst) and (tenantId, src, p) to support both reverse and forward lookups.</p>
</li>
<li>
<p>Write amplification vs read wins: Materialization adds write work, but dramatically improves read latency and simplifies queries.</p>
</li>
<li>
<p>Consistency: Re-materialize edges on relevant entity changes (source, destination, or intermediate) using OntologyMaterializer.</p>
</li>
<li>
<p>Multi-tenancy: Keep tenantId in the edge key and filters; the provided EdgeDao methods include tenant scoping.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_how_this_integrates_with_functional_areasdomains">How this integrates with Functional Areas/Domains</h5>
<div class="ulist">
<ul>
<li>
<p>Functional domains often map to concept clusters in the ontology. Use @FunctionalMapping to aid discovery and apply policies per area/domain.</p>
</li>
<li>
<p>Policies can refer to relationships semantically ("hasEdge placedInOrg OrgX") and rely on the policy bridge to turn this into efficient data filters.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_summary">Summary</h5>
<div class="ulist">
<ul>
<li>
<p>Ontology-powered relationships provide a stable, semantic layer over your object model.</p>
</li>
<li>
<p>The Quantum Ontology modules let you define, infer, and query these relationships efficiently on MongoDB.</p>
</li>
<li>
<p>Compared with direct @Reference/EntityReference, ontology edges are more expressive, resilient to change, and typically faster for complex list/policy queries once materialized.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="ontology-ecommerce-example">Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</h5>
<div class="paragraph">
<p>This example shows how to use an ontology to model relationships around Orders, Customers, and Shipments, and how the model can evolve to include Fulfillment and Returns without breaking existing queries. We will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define core concepts and predicates.</p>
</li>
<li>
<p>Add property chains that materialize implied relationships for fast queries.</p>
</li>
<li>
<p>Show how queries are rewritten using edges instead of deep object traversals.</p>
</li>
<li>
<p>Evolve the model to support Fulfillment and Returns with minimal changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core concepts (classes)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order, Customer, Organization, Shipment, Address, Region</p>
</li>
<li>
<p>Later evolution: FulfillmentTask, FulfillmentUnit, ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key predicates (relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy(order, customer): who placed the order</p>
</li>
<li>
<p>memberOf(customer, org): a customer belongs to an organization (or account)</p>
</li>
<li>
<p>orderHasShipment(order, shipment): outbound shipment for the order</p>
</li>
<li>
<p>shipsTo(shipment, address): shipment destination</p>
</li>
<li>
<p>locatedIn(address, region): address is located in a Region</p>
</li>
<li>
<p>ancestorOf(org, org): organizational ancestry (transitive)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Property chains (implied relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy ∘ memberOf ⇒ placedInOrg</p>
</li>
<li>
<p>If (order --placedBy-&#8594; customer) and (customer --memberOf-&#8594; org), then infer (order --placedInOrg-&#8594; org)</p>
</li>
<li>
<p>orderHasShipment ∘ shipsTo ⇒ orderShipsTo</p>
</li>
<li>
<p>If (order --orderHasShipment-&#8594; shipment) and (shipment --shipsTo-&#8594; address), infer (order --orderShipsTo-&#8594; address)</p>
</li>
<li>
<p>orderShipsTo ∘ locatedIn ⇒ orderShipsToRegion</p>
</li>
<li>
<p>If (order --orderShipsTo-&#8594; address) and (address --locatedIn-&#8594; region), infer (order --orderShipsToRegion-&#8594; region)</p>
</li>
<li>
<p>placedInOrg ∘ ancestorOf ⇒ placedInOrg</p>
</li>
<li>
<p>Makes placedInOrg resilient to org hierarchy changes (ancestorOf is transitive). This is a common “closure” trick: re-assert the same predicate via chain to absorb hierarchy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A minimal Java-style snippet to define this TBox</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util</span>.*;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>.*;

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, PropertyDef&gt; props = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">true</span>), <span class="comment">// transitive</span>
  <span class="comment">// implied predicates (no domain/range required, but you may add them for validation)</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>)
);

<span class="predefined-type">List</span>&lt;PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
);

OntologyRegistry.TBox tbox = <span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains);
OntologyRegistry registry = OntologyRegistry.inMemory(tbox);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Materializing edges for an Order</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit facts for order O1:</p>
</li>
<li>
<p>O1 placedBy C9</p>
</li>
<li>
<p>C9 memberOf OrgA</p>
</li>
<li>
<p>O1 orderHasShipment S17</p>
</li>
<li>
<p>S17 shipsTo Addr42</p>
</li>
<li>
<p>Addr42 locatedIn RegionWest</p>
</li>
<li>
<p>OrgA ancestorOf OrgParent</p>
</li>
<li>
<p>Inferred edges after running the reasoner for O1’s snapshot:</p>
</li>
<li>
<p>O1 placedInOrg OrgA</p>
</li>
<li>
<p>O1 placedInOrg OrgParent (via closure with ancestorOf)</p>
</li>
<li>
<p>O1 orderShipsTo Addr42</p>
</li>
<li>
<p>O1 orderShipsToRegion RegionWest</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How queries become simple and fast</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders for Organization OrgParent (including children):</p>
</li>
<li>
<p>Instead of joining Order &#8594; Customer &#8594; Org and recursing org.parent, run a single filter using materialized edges.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.mongodb.client.model.Filters</span>;
<span class="keyword">import</span> <span class="include">org.bson.conversions.Bson</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.policy.ListQueryRewriter</span>;

Bson base = Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Use rewritten in your Mongo find</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson rewritten2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why this is resilient</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If tomorrow Customer becomes AccountContact and the organization model gains Divisions and multi-parent org graphs, you only adjust predicates and chains.</p>
</li>
<li>
<p>Queries that rely on placedInOrg or orderShipsToRegion remain unchanged and fast, because edges are re-materialized by OntologyMaterializer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evolving the model: add Fulfillment</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FulfillmentTask: a unit of work to pick/pack/ship order lines</p>
</li>
<li>
<p>FulfillmentUnit: a logical grouping (e.g., wave, tote, parcel)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills(task, order)</p>
</li>
<li>
<p>realizedBy(order, fulfillmentUnit)</p>
</li>
<li>
<p>taskProduces(task, shipment)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills ⇒ derived edge from task to order; combine with taskProduces to connect order to shipment without touching Order fields:</p>
</li>
<li>
<p>fulfills ∘ taskProduces ⇒ orderHasShipment</p>
</li>
<li>
<p>realizedBy ∘ orderHasShipment ⇒ fulfilledByUnit</p>
</li>
<li>
<p>If (order --realizedBy-&#8594; fu) and (order --orderHasShipment-&#8594; s) ⇒ (fu --fulfillsShipment-&#8594; s) or simply (order --fulfilledByUnit-&#8594; fu)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These chains let you introduce warehouse concepts without changing how UI filters orders by organization or ship-to region. Existing queries still operate via placedInOrg and orderShipsToRegion.</p>
</div>
<div class="paragraph">
<p>Evolving further: add Returns</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn(order, returnRequest)</p>
</li>
<li>
<p>returnFor(returnItem, order)</p>
</li>
<li>
<p>returnRma(returnRequest, rma)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn ⇒ openReturnOnOrg via placedInOrg:</p>
</li>
<li>
<p>hasReturn ∘ placedInOrg ⇒ returnPlacedInOrg</p>
</li>
<li>
<p>returnFor ∘ orderShipsToRegion ⇒ returnShipsToRegion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example queries with new capabilities</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders with open returns in OrgParent:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnPlacedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Returns associated to Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparison with direct references (@Reference/EntityReference)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With direct references you would encode fields like Order.customer, Order.shipments, Shipment.address, Address.region and then implement multi-hop traversals in code or $lookup pipelines, rewriting them whenever you add Fulfillment or Returns.</p>
</li>
<li>
<p>With ontology edges, you keep predicates stable and add property chains. Existing list and policy queries keep working and typically become faster due to single-hop filters on an indexed edges collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational tips for this scenario</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure EdgeDao has indexes on (tenantId, p, dst) and (tenantId, src, p).</p>
</li>
<li>
<p>Use OntologyMaterializer when Order, Shipment, Customer, Address, or org hierarchy changes to keep edges fresh.</p>
</li>
<li>
<p>Keep provenance in edge.prov (rule, inputs) so you can recompute or retract edges when source data changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ontology-integration-morphia-permissions">13.9.2. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</h4>
<div class="paragraph">
<p>This section focuses on integration and developer experience: how ontology edges flow into Morphia-based repositories and the permission rule language, while remaining fully multi-tenant and secure.</p>
</div>
<div class="sect4">
<h5 id="_big_picture_where_ontology_fits">Big picture: where ontology fits</h5>
<div class="ulist">
<ul>
<li>
<p>Write path (materialization):</p>
</li>
<li>
<p>Your domain code persists entities with minimal direct references.</p>
</li>
<li>
<p>An OntologyMaterializer runs when entities change to derive and upsert edges into the edges collection (per tenant).</p>
</li>
<li>
<p>Policy path (authorization and list filters):</p>
</li>
<li>
<p>The permission rule language evaluates the caller’s SecurityContext/RuleContext and produces logical filters.</p>
</li>
<li>
<p>When a rule asks for a semantic relationship (hasEdge), we use ListQueryRewriter + EdgeDao to translate that into efficient Mongo filters over ids.</p>
</li>
<li>
<p>Read path (queries):</p>
</li>
<li>
<p>Morphia repos apply the base data-domain filters and the rewritten ontology constraint to queries, producing fast lists without deep joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_rule_language_add_hasedge">Rule language: add hasEdge()</h5>
<div class="paragraph">
<p>We introduce a policy function/operator to reference ontology edges directly from rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature: hasEdge(predicate, dstIdOrVar)</p>
</li>
<li>
<p>predicate: String name of the ontology predicate (e.g., "placedInOrg", "orderShipsToRegion").</p>
</li>
<li>
<p>dstIdOrVar: Either a concrete id/refName or a variable resolved from RuleContext (e.g., principal.orgRefName, request.region).</p>
</li>
<li>
<p>Semantics: The rule grants/filters entities for which an edge (tenantId, src = entity._id, p = predicate, dst = resolvedDst) exists.</p>
</li>
<li>
<p>Composition: hasEdge can be combined with existing rule clauses (and/or/not) and other filters (states, tags, ownerId, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example rule snippets (illustrative):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow viewing Orders in the caller’s org (including ancestors via ontology closure):</p>
</li>
<li>
<p>allow VIEW Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Restrict list to Orders shipping to a region chosen in request:</p>
</li>
<li>
<p>allow LIST Order when hasEdge("orderShipsToRegion", request.region)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under the hood, policy evaluation uses ListQueryRewriter.rewriteForHasEdge(&#8230;&#8203;), which converts hasEdge into a set of source ids and merges that with the base query.</p>
</div>
</div>
<div class="sect4">
<h5 id="_passing_tenantid_correctly">Passing tenantId correctly</h5>
<div class="ulist">
<ul>
<li>
<p>Always resolve tenantId from RuleContext/SecurityContext (the same source your repos use for realm/database selection).</p>
</li>
<li>
<p>EdgeDao and ListQueryRewriter already accept tenantId; never cross tenant boundaries when reading edges.</p>
</li>
<li>
<p>Index recommendation (per tenant):</p>
</li>
<li>
<p>(tenantId, p, dst)</p>
</li>
<li>
<p>(tenantId, src, p)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_morphia_repository_integration_patterns">Morphia repository integration patterns</h5>
<div class="paragraph">
<p>The goal is zero-friction usage in existing repos without invasive changes.</p>
</div>
<div class="paragraph">
<p>Option A: Apply ontology constraints in code paths that already construct BSON filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your repo method builds a Bson filter before calling find(), wrap it through rewriter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson base = Filters.and(existingFilters...);
Bson rewritten = hasEdgeRequested
  ? rewriter.rewriteForHasEdge(base, tenantId, predicate, dst)
  : base;
<span class="type">var</span> cursor = datastore.getDatabase().getCollection(coll).find(rewritten);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option B: Apply ontology constraints to Morphia Filter/Query via ids.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the repo uses Morphia’s typed query API instead of BSON, pre-compute the id set and constrain by _id:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; ids = edgeDao.srcIdsByDst(tenantId, predicate, dst);
<span class="keyword">if</span> (ids.isEmpty()) {
  <span class="keyword">return</span> <span class="predefined-type">List</span>.of(); <span class="comment">// short-circuit</span>
}
query.filter(Filters.in(<span class="string"><span class="delimiter">&quot;</span><span class="content">_id</span><span class="delimiter">&quot;</span></span>, ids));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option C: Centralize in a tiny helper for developer ergonomics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide one helper in your application layer, invoked wherever policies inject additional constraints:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">OntologyFilterHelper</span> {
  <span class="directive">private</span> <span class="directive">final</span> ListQueryRewriter rewriter;
  <span class="directive">public</span> OntologyFilterHelper(ListQueryRewriter r) { <span class="local-variable">this</span>.rewriter = r; }

  <span class="directive">public</span> Bson ensureHasEdge(Bson base, <span class="predefined-type">String</span> tenantId, <span class="predefined-type">String</span> predicate, <span class="predefined-type">String</span> dst) {
    <span class="keyword">return</span> rewriter.rewriteForHasEdge(base, tenantId, predicate, dst);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_where_to_hook_materialization">Where to hook materialization</h5>
<div class="ulist">
<ul>
<li>
<p>On entity changes that are sources or intermediates for chains:</p>
</li>
<li>
<p>Order (placedBy, orderHasShipment), Customer (memberOf), Shipment (shipsTo), Address (locatedIn), Organization (ancestorOf/parent), and any Fulfillment/Returns entities.</p>
</li>
<li>
<p>Recommended patterns:</p>
</li>
<li>
<p>On-save/on-update hooks in your service layer call OntologyMaterializer.apply(&#8230;&#8203;) with the explicit edges known from the entity snapshot.</p>
</li>
<li>
<p>For intermediates (e.g., Address.region changed), enqueue affected sources for recomputation; use provenance to locate impacted edges.</p>
</li>
<li>
<p>Provide nightly/backfill jobs for recomputing edges across a tenant when ontology rules evolve.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_security_and_multi_tenant_considerations">Security and multi-tenant considerations</h5>
<div class="ulist">
<ul>
<li>
<p>Edge rows include tenantId and should be validated/filtered by tenant on every operation.</p>
</li>
<li>
<p>Never trust a client-supplied predicate or destination id blindly; combine with rule evaluation and whitelist allowed predicates per domain if needed.</p>
</li>
<li>
<p>For shared resources across tenants (rare), model cross-tenant permissions at the policy layer; don’t reuse edges across tenants unless explicitly designed.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_developer_workflow_and_dx_checklist">Developer workflow and DX checklist</h5>
<div class="ulist">
<ul>
<li>
<p>When writing a rule: use hasEdge("&lt;predicate&gt;", &lt;rhs&gt;) and rely on RuleContext variables for the destination when possible.</p>
</li>
<li>
<p>When writing a list endpoint: read optional ontology filter hints from the policy layer; if present, apply ensureHasEdge(&#8230;&#8203;) before find().</p>
</li>
<li>
<p>When changing domain relationships: update predicates/chains and re-materialize; list/policy code stays unchanged.</p>
</li>
<li>
<p>When indexing a new tenant: include the edges indexes early and validate via a smoke test query using ListQueryRewriter.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_cookbook_end_to_end_example_with_orders_org">Cookbook: end-to-end example with Orders + Org</h5>
<div class="ulist">
<ul>
<li>
<p>Policy: allow LIST Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Request lifecycle:
1) Security filter builds SecurityContext and RuleContext with tenantId and principal.
2) Policy evaluation returns a directive to constrain by hasEdge("placedInOrg", orgRefName).
3) Repo builds base filter (state != ARCHIVED, etc.).
4) Repo calls OntologyFilterHelper.ensureHasEdge(base, tenantId, "placedInOrg", orgRefName).
5) Mongo executes a single-hop query using materialized edges; results respect both policy and multi-tenancy.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_migration_notes_for_teams_using_reference">Migration notes for teams using @Reference</h5>
<div class="ulist">
<ul>
<li>
<p>Keep existing references for write-side integrity and local joins where simple.</p>
</li>
<li>
<p>Introduce ontology edges on hot read paths first; update policy rules to hasEdge and verify results.</p>
</li>
<li>
<p>Gradually replace deep $lookup traversals with hasEdge-based rewrites.</p>
</li>
<li>
<p>Ensure materialization hooks are deployed before removing data fields used as inputs to the ontology.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-tenant-models">14. 4. Multi-tenant model and realm separation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Isolating data per tenant while enabling selective sharing.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Security, compliance, and data residency require strong segregation and auditability.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Realm/tenant identifiers, context propagation, transforms, and repository filters.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Configure realms and mark your models for tenancy.</p>
</div>
<div class="sect2">
<h3 id="tenant-models">14.1. Multi‑Tenancy Models</h3>
<div class="paragraph">
<p>Quantum supports multiple multi-tenant models for MongoDB deployments:</p>
</div>
<div class="sect3">
<h4 id="_one_tenant_per_database_in_a_mongodb_cluster">14.1.1. One Tenant per Database (in a MongoDB Cluster)</h4>
<div class="ulist">
<ul>
<li>
<p>Each tenant is mapped to a dedicated MongoDB database within a cluster.</p>
</li>
<li>
<p>Strong isolation at the database level; operational controls via MongoDB roles.</p>
</li>
<li>
<p>Pros: Simplified backup/restore per tenant; reduced risk of data bleed.</p>
</li>
<li>
<p>Cons: More databases to manage (indexes, connections), higher operational overhead.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How Quantum helps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataDomain carries tenant identifiers (e.g., tenantId, ownerId, orgRefName) on each model.</p>
</li>
<li>
<p>Repositories can resolve connections/DB selection per tenant, enabling routing to the appropriate database.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_many_tenants_in_one_database_shared_database">14.1.2. Many Tenants in One Database (Shared Database)</h4>
<div class="ulist">
<ul>
<li>
<p>Multiple tenants share a single database and collections.</p>
</li>
<li>
<p>Isolation is enforced at the application layer using DataDomain filters.</p>
</li>
<li>
<p>Pros: Fewer databases to manage; efficient index utilization and connection pooling.</p>
</li>
<li>
<p>Cons: Strict discipline required to enforce filtering and access rules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How Quantum helps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DataDomain is part of every persisted model, enabling programmatic, rule-based filtering.</p>
</li>
<li>
<p>RuleContext and DomainContext can be used to inject tenant-aware filters into repositories and resources.</p>
</li>
<li>
<p>Cross-tenant sharing can be modeled by specific DataDomain fields and RuleContext logic granting read access across tenants on a per-functional-area basis.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_freemium_and_trial_tenants">14.1.3. Freemium and Trial Tenants</h4>
<div class="ulist">
<ul>
<li>
<p>Programmatically create tenants to support self-service onboarding.</p>
</li>
<li>
<p>Attach time-bound or capability-bound policies.</p>
</li>
<li>
<p>Use scheduled jobs to convert/expire trials.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tenant onboarding service creates a DataDomain scope and any default records.</p>
</li>
<li>
<p>Policies are encoded in RuleContext checks to allow or restrict actions based on time, plan, or feature flags.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-domain-rule-context">15. 5. Domain rule context</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Applying business rules based on user, org, account, and tenant context.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Entitlements and behavior vary by tenant, role, and plan.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Built-in domain rule context to consistently pass identity and policy inputs.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Inject and use the context in services and repositories.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domain-rule-context">16. DomainContext, RuleContext, and DataDomain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum enforces multi-tenant isolation and sharing through contextual data carried on models and evaluated at runtime.</p>
</div>
<div class="sect2">
<h3 id="_datadomain">16.1. DataDomain</h3>
<div class="paragraph">
<p>Every persisted model includes a DataDomain that describes ownership and scope, commonly including fields such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tenantId: Identifies the tenant</p>
</li>
<li>
<p>orgRefName: Organization unit reference within a tenant</p>
</li>
<li>
<p>ownerId: Owning user or system entity</p>
</li>
<li>
<p>realm: Optional runtime override for partitioning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These fields enable filtering, authorization, and controlled sharing of data between tenants or org units.</p>
</div>
</div>
<div class="sect2">
<h3 id="_domaincontext">16.2. DomainContext</h3>
<div class="paragraph">
<p>DomainContext represents the current execution context for a request or operation, typically capturing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>current tenant/org/user identity</p>
</li>
<li>
<p>functional area / functional domain</p>
</li>
<li>
<p>the action being executed (e.g., CREATE, UPDATE, VIEW, DELETE, ARCHIVE)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It feeds downstream components (repositories, resources) to consistently apply filtering and policy decisions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rulecontext">16.3. RuleContext</h3>
<div class="paragraph">
<p>RuleContext encapsulates policy evaluation. It can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enforce whether an action is allowed for a given model and DataDomain</p>
</li>
<li>
<p>Produce additional filters and projections used by repositories</p>
</li>
<li>
<p>Grant cross-tenant read access for specific functional areas (e.g., shared catalogs) while keeping others strictly isolated</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_end_to_end_flow">16.4. End-to-End Flow</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A REST request enters a BaseResource-derived endpoint.</p>
</li>
<li>
<p>The resource builds a DomainContext from the security principal and request parameters.</p>
</li>
<li>
<p>RuleContext evaluates permissions and returns effective filters.</p>
</li>
<li>
<p>Repository applies filters (DataDomain-aware) to find/get/list/update/delete.</p>
</li>
<li>
<p>The model’s UIActionList can be computed to reflect what the caller can do next.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This pattern ensures consistent enforcement across all CRUD operations, independent of the specific model or repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolvers_and_variables_in_rule_filters">16.5. Resolvers and Variables in Rule Filters</h3>
<div class="paragraph">
<p>RuleContext can attach FILTERs (not only ALLOW/DENY) to repository queries using rule fields and filter strings. Variables inside those filter strings are populated from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PrincipalContext and ResourceContext standard variables: principalId, pAccountId, pTenantId, ownerId, orgRefName, resourceId, action, functionalDomain, area</p>
</li>
<li>
<p>AccessListResolver SPI implementations: per-request computed Collections (e.g., customer IDs the caller can access)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementation highlights:
- AccessListResolver has methods key(), supports(&#8230;&#8203;), resolve(&#8230;&#8203;). Resolvers are injected and invoked for each request; results are published as variables by key.
- MorphiaUtils.VariableBundle carries both string variables and object variables (including collections) to the query listener.
- The QueryToFilterListener supports IN clauses using a single ${var} inside brackets, expanding Collections/arrays and coercing types (ObjectId, numbers, booleans, dates).</p>
</div>
<div class="paragraph">
<p>Authoring examples:
- Constrain by principal domain:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>orgRefName:${orgRefName} &amp;&amp; dataDomain.tenantId:${pTenantId}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Access list resolver for customer visibility:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>customerId:^[${accessibleCustomerIds}]</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the complete query language reference, see <a href="query-language.html#query-language">Query Language</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_concrete_example_building_and_using_a_resolver">16.6. Concrete example: building and using a resolver</h3>
<div class="paragraph">
<p>This section shows how to implement a resolver that restricts access to orders by the set of customerIds the current user is allowed to see.</p>
</div>
<div class="sect3">
<h4 id="_1_implement_the_spi">16.6.1. 1) Implement the SPI</h4>
<div class="paragraph">
<p>Create a CDI bean that implements AccessListResolver. It decides when it applies and returns a Collection of values. The collection can be ObjectId, String, numbers, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.securityrules.AccessListResolver</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.UnversionedBaseModel</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.securityrules.PrincipalContext</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.securityrules.ResourceContext</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.bson.types.ObjectId</span>;
<span class="keyword">import</span> <span class="include">java.util</span>.*;

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerAccessResolver</span> <span class="directive">implements</span> AccessListResolver {

    <span class="annotation">@Inject</span> CustomerAccessService service; <span class="comment">// your app-specific service</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> key() {
        <span class="comment">// This becomes the variable name available to rules: ${accessibleCustomerIds}</span>
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleCustomerIds</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> supports(PrincipalContext pctx, ResourceContext rctx,
                            <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; modelClass) {
        <span class="comment">// Optionally narrow by area/domain/action/model</span>
        <span class="keyword">return</span> rctx != <span class="predefined-constant">null</span> &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">sales</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(rctx.getArea())
               &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(rctx.getFunctionalDomain());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(PrincipalContext pctx, ResourceContext rctx,
                                 <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; modelClass) {
        <span class="comment">// Return the set of customer ids for this user; could be ObjectId or String.</span>
        <span class="comment">// Example returns strings; the query listener will coerce 24-hex to ObjectId.</span>
        <span class="keyword">return</span> service.findCustomerIdsForUser(pctx.getUserId());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- You can return List&lt;ObjectId&gt; directly if you prefer; no coercion needed then.
- The resolver runs per request. Cache internally if the computation is expensive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_how_rulecontext_uses_resolvers">16.6.2. 2) How RuleContext uses resolvers</h4>
<div class="paragraph">
<p>At query time, RuleContext discovers all AccessListResolver beans and calls supports(&#8230;&#8203;). For those that apply, it invokes resolve(&#8230;&#8203;) and publishes the result into the variable bundle under the provided key(). Variables are available to the BIAPI query via ${&#8230;&#8203;}.</p>
</div>
<div class="paragraph">
<p>Internally this uses <code>MorphiaUtils.VariableBundle</code> and <code>QueryToFilterListener</code> to carry both strings and typed objects/collections.
Starting with this release you can reuse the exact same variable bundle for custom evaluation paths. The
<code>RuleContext.resolveVariableBundle(&#8230;&#8203;)</code> helper runs all matching <code>AccessListResolver</code> beans and returns the
maps you can feed directly into <code>QueryPredicates</code> (for in-memory rules) or any other component that understands
<code>${var}</code> tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">PrincipalContext pc = ...; <span class="comment">// build from request</span>
ResourceContext rc = ...;

MorphiaUtils.VariableBundle vars = ruleContext.resolveVariableBundle(pc, rc, UserProfile.class);

<span class="predefined-type">Predicate</span>&lt;JsonNode&gt; predicate = QueryPredicates.compilePredicate(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">customerId:^[${accessibleCustomerIds}]</span><span class="delimiter">&quot;</span></span>,
    vars.strings,
    vars.objects
);

JsonNode order = QueryPredicates.toJsonNode(<span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">5f1e1a5e5e5e5e5e5e5e5e51</span><span class="delimiter">&quot;</span></span>));
<span class="type">boolean</span> allowed = predicate.test(order); <span class="comment">// true when resolver returned that ObjectId</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows the same resolver outputs to drive Morphia queries and client-side predicate checks without
duplicating resolver logic.</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_author_a_rule_that_consumes_the_variable">16.6.3. 3) Author a rule that consumes the variable</h4>
<div class="paragraph">
<p>Given the resolver above, a rule can attach an IN filter to constrain queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// andFilterString (example)
customerId:^[${accessibleCustomerIds}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When executed:
- If accessibleCustomerIds is a Collection/array, each element is type-coerced (ObjectId, number, date, boolean, or string) and used in $in.
- If accessibleCustomerIds is a comma-separated string, it is split and each token is coerced similarly.
- An empty collection results in an empty $in (matches none), effectively denying access via filtering, not via ALLOW/DENY.</p>
</div>
</div>
<div class="sect3">
<h4 id="_4_end_to_end_behavior">16.6.4. 4) End-to-end behavior</h4>
<div class="ulist">
<ul>
<li>
<p>SecurityFilter sets ResourceContext (area/domain/action) per request.</p>
</li>
<li>
<p>RuleContext evaluates rules for the principal and resource and gathers resolvers.</p>
</li>
<li>
<p>The repository composes filters including the rule-provided IN clause with the access list.</p>
</li>
<li>
<p>Only documents whose customerId is in the caller’s resolved set are returned.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_string_literals_vs_typed_values_in_resolver_variables">16.6.5. String literals vs. typed values in resolver variables</h4>
<div class="paragraph">
<p>When an <code>AccessListResolver</code> returns a list of values that will be used in an <code>IN</code> clause (for example, <code>field:^[${var}]</code>), the engine attempts to coerce each element to an appropriate type so Mongo/Morphia filters are typed correctly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>24‑hex string → ObjectId</p>
</li>
<li>
<p><code>true</code>/<code>false</code> → Boolean</p>
</li>
<li>
<p>integer → Long</p>
</li>
<li>
<p>decimal → Double</p>
</li>
<li>
<p>ISO‑8601 datetime → <code>java.util.Date</code></p>
</li>
<li>
<p><code>yyyy-MM-dd</code> → <code>java.time.LocalDate</code></p>
</li>
<li>
<p>otherwise → String</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This works well when your target field is an ObjectId, number, or date. However, string fields can contain values that look like other types (for example, a 24‑hex string that resembles an ObjectId). In those cases you must force "treat as plain string" so no coercion occurs.</p>
</div>
<div class="paragraph">
<p>To do this, the framework provides a small wrapper type <code>StringLiteral</code>. If a resolver returns <code>StringLiteral</code> instances, the listener unwraps them to plain <code>String</code> values and skips coercion entirely.</p>
</div>
<div class="sect4">
<h5 id="_example_a_resolver_returns_objectids_typed">Example A: Resolver returns ObjectIds (typed)</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerAccessResolver</span> <span class="directive">implements</span> AccessListResolver {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> ObjectId ID1 = <span class="keyword">new</span> ObjectId(<span class="string"><span class="delimiter">&quot;</span><span class="content">5f1e1a5e5e5e5e5e5e5e5e51</span><span class="delimiter">&quot;</span></span>);
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> ObjectId ID2 = <span class="keyword">new</span> ObjectId(<span class="string"><span class="delimiter">&quot;</span><span class="content">5f1e1a5e5e5e5e5e5e5e5e52</span><span class="delimiter">&quot;</span></span>);

    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> key() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleCustomerIds</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="type">boolean</span> supports(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; m) {
        <span class="keyword">return</span> r != <span class="predefined-constant">null</span> &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">sales</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getArea()) &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getFunctionalDomain()) &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">view</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getAction());
    }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; m) {
        <span class="keyword">return</span> java.util.List.of(ID1, ID2); <span class="comment">// typed values pass through as-is</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>customerId:^[${accessibleCustomerIds}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result: <code>$in</code> with <code>List&lt;ObjectId&gt;</code> on <code>customerId</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_example_b_resolver_returns_string_literals_force_raw_strings">Example B: Resolver returns String literals (force raw strings)</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerCodeResolver</span> <span class="directive">implements</span> AccessListResolver {
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> key() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleCustomerCodes</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="type">boolean</span> supports(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; m) {
        <span class="keyword">return</span> r != <span class="predefined-constant">null</span> &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">sales</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getArea()) &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getFunctionalDomain()) &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">view</span><span class="delimiter">&quot;</span></span>.equalsIgnoreCase(r.getAction());
    }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; m) {
        <span class="keyword">return</span> java.util.List.of(
            com.e2eq.framework.model.persistent.morphia.StringLiteral.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">5f1e1a5e5e5e5e5e5e5e5e51</span><span class="delimiter">&quot;</span></span>),
            com.e2eq.framework.model.persistent.morphia.StringLiteral.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">CUST-42</span><span class="delimiter">&quot;</span></span>)
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>customerCode:^[${accessibleCustomerCodes}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result: <code>$in</code> with <code>List&lt;String&gt;</code> on <code>customerCode</code> (even for hex-like strings).</p>
</div>
</div>
<div class="sect4">
<h5 id="_other_types_supported">Other types supported</h5>
<div class="paragraph">
<p>Resolvers can also return numbers, booleans, and dates/datetimes. Already-typed elements (Number, Boolean, java.util.Date, java.time.LocalDate, ObjectId) are preserved. String elements are heuristically parsed into those types unless wrapped with <code>StringLiteral</code>.</p>
</div>
<div class="paragraph">
<p>Authoring tips:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefer returning already-typed values when you know the target field type.</p>
</li>
<li>
<p>Use <code>StringLiteral</code> when a value might be misinterpreted (for example, 24‑hex or numeric-looking strings).</p>
</li>
<li>
<p>For CSV strings published under a variable, the engine splits by comma and applies the same per-element coercion.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ontology-domain-rule-context">16.6.6. Using AccessListResolver with Ontology (optional)</h4>
<div class="paragraph">
<p>When ontology is enabled, an AccessListResolver can compute ID lists from semantic edges (materialized in Mongo) and publish them as variables for use in rule filters.</p>
</div>
<div class="paragraph">
<p>Example resolver (conceptual)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OrdersByOrgResolver</span> <span class="directive">implements</span> AccessListResolver {
  <span class="annotation">@Inject</span> EdgeDao edgeDao; <span class="comment">// from quantum-ontology-mongo</span>
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> key() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">idsByPlacedInOrg</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="type">boolean</span> supports(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; model) {
    <span class="keyword">return</span> model.getSimpleName().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>);
  }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(PrincipalContext p, ResourceContext r, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> UnversionedBaseModel&gt; model) {
    <span class="predefined-type">String</span> tenantId = p.getDataDomain().getTenantId();
    <span class="predefined-type">String</span> org = p.getDataDomain().getOrgRefName();
    <span class="keyword">return</span> edgeDao.srcIdsByDst(tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, org);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rule filter usage</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>id:^${idsByPlacedInOrg}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always scope by tenantId from RuleContext/PrincipalContext.</p>
</li>
<li>
<p>This is optional and only active if you wire ontology components. For a deeper integration path, see <a href="modeling.html#ontology-integration-morphia-permissions">Integrating Ontology</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-rest-crud">17. 6. Building RESTful CRUD APIs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Exposing standardized CRUD endpoints with minimal boilerplate.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Consistency across services reduces cognitive load and accelerates delivery.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Resource scaffolding, conventions, and helpers for common CRUD.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Create controllers/resources for your model and wire persistence.</p>
</div>
<div class="sect2">
<h3 id="rest-crud">17.1. REST: Find, Get, List, Save, Update, Delete</h3>
<div class="paragraph">
<p>Quantum provides consistent REST resources backed by repositories. Extend BaseResource to expose CRUD quickly and consistently.</p>
</div>
<div class="sect3">
<h4 id="_base_concepts">17.1.1. Base Concepts</h4>
<div class="ulist">
<ul>
<li>
<p>BaseResource&lt;T, R extends Repo&lt;T&gt;&gt; provides endpoints for:</p>
</li>
<li>
<p>find: query by criteria (filters, pagination)</p>
</li>
<li>
<p>get: fetch by id or refName</p>
</li>
<li>
<p>list: list all within scope with paging</p>
</li>
<li>
<p>save: create</p>
</li>
<li>
<p>update: modify existing</p>
</li>
<li>
<p>delete: delete or soft-delete/archival depending on model</p>
</li>
<li>
<p>UIActionList: derive available actions based on current model state.</p>
</li>
<li>
<p>DataDomain filtering is applied across all operations to enforce multi-tenancy.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_example_resource">17.1.2. Example Resource</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authorization_layers_in_rest_crud">17.1.3. Authorization Layers in REST CRUD</h4>
<div class="paragraph">
<p>Quantum combines static, identity-based checks with dynamic, domain-aware policy evaluation. In practice you will often use both:</p>
</div>
<div class="paragraph">
<p>1) Hard-coded permissions via annotations</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use standard Jakarta annotations like @RolesAllowed (or the framework’s @RoleAllow if present) on resource classes or methods to declare role-based checks that must pass before executing an endpoint.</p>
</li>
<li>
<p>These checks are fast and decisive. They rely on the caller’s roles as established by the current SecurityIdentity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">jakarta.annotation.security.RolesAllowed</span>;

<span class="annotation">@RolesAllowed</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">ADMIN</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">CATALOG_EDITOR</span><span class="delimiter">&quot;</span></span>})
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Only ADMIN or CATALOG_EDITOR can access all inherited CRUD endpoints</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) JWT groups and role mapping</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When using the JWT provider, the token’s groups/roles claims are mapped into the Quarkus SecurityIdentity (see the Authentication guide).</p>
</li>
<li>
<p>Groups in JWT typically become roles on SecurityIdentity; these roles are what @RolesAllowed/@RoleAllow checks evaluate.</p>
</li>
<li>
<p>You can augment or transform roles using a SecurityIdentityAugmentor (see RolesAugmentor in the framework) to add derived roles based on claims or external lookups.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>3) RuleContext layered authorization (dynamic policies)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>After annotation checks pass, RuleContext evaluates domain-aware permissions. This layer can:</p>
</li>
<li>
<p>Enforce DataDomain scoping (tenant/org/owner)</p>
</li>
<li>
<p>Allow cross-tenant reads for specific functional areas when policy permits</p>
</li>
<li>
<p>Contribute query predicates and projections to repositories</p>
</li>
<li>
<p>Think of @RolesAllowed/@RoleAllow as the coarse-grained gate, and RuleContext as the fine-grained, context-sensitive policy engine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>4) Quarkus SecurityIdentity and SecurityFilter</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus produces a SecurityIdentity for each request containing principal name and roles.</p>
</li>
<li>
<p>The framework’s SecurityFilter inspects the incoming request (e.g., JWT) and populates/augments the SecurityIdentity and the derived DomainContext used by RuleContext and repositories.</p>
</li>
<li>
<p>BaseResource and underlying repos (e.g., MorphiaRepo) consume SecurityIdentity/DomainContext to apply permissions and filters consistently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For detailed rule-base matching (URL, headers, body predicates, priorities), see the Permissions section.</p>
</div>
</div>
<div class="sect3">
<h4 id="querying">17.1.4. Querying</h4>
<div class="ulist">
<ul>
<li>
<p>Use query parameters or a request body (depending on your API convention) to express filters.</p>
</li>
<li>
<p>RuleContext contributes tenant-aware filters and projections automatically.</p>
</li>
<li>
<p>See <a href="query-language.html#query-language">Query Language</a> for the full BIAPIQuery syntax, including array filtering with elemMatch and IN‑clause enhancements that accept resolver‑provided lists.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_responses_and_schemas">17.1.5. Responses and Schemas</h4>
<div class="ulist">
<ul>
<li>
<p>Models are returned with calculated fields (e.g., actionList) when appropriate.</p>
</li>
<li>
<p>OpenAPI annotations in your models/resources integrate with MicroProfile OpenAPI for schema docs.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_error_handling">17.1.6. Error Handling</h4>
<div class="ulist">
<ul>
<li>
<p>Validation errors (e.g., ImportRequiredField, Size) return helpful messages.</p>
</li>
<li>
<p>Rule-based denials return appropriate HTTP statuses (403/404) without leaking cross-tenant metadata.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_query_language_antlrbased">Query Language (ANTLR‑based)</h5>
<div class="paragraph">
<p>The find/list endpoints accept a filter string parsed by an ANTLR grammar (BIAPIQuery.g4). Use the filter query parameter to express predicates; combine them with logical operators and grouping. Sorting and projection are separate query parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operators:</p>
</li>
<li>
<p>Equals: ':'</p>
</li>
<li>
<p>Not equals: ':!'</p>
</li>
<li>
<p>Less than/Greater than: ':&lt;' / ':&gt;'</p>
</li>
<li>
<p>Less‑than‑or‑equal/Greater‑than‑or‑equal: ':&#8656;' / ':&gt;='</p>
</li>
<li>
<p>Exists (field present): ':~' (no value)</p>
</li>
<li>
<p>In list: ':^' followed by [v1,v2,&#8230;&#8203;]</p>
</li>
<li>
<p>Boolean literals: true/false</p>
</li>
<li>
<p>Null literal: null</p>
</li>
<li>
<p>Logical:</p>
</li>
<li>
<p>AND: '&amp;&amp;'</p>
</li>
<li>
<p>OR: '||'</p>
</li>
<li>
<p>NOT: '!!' (applies to a single allowed expression)</p>
</li>
<li>
<p>Grouping: parentheses '(' and ')'</p>
</li>
<li>
<p>Values by type:</p>
</li>
<li>
<p>Strings: unquoted or quoted with "&#8230;&#8203;"; quotes allow spaces and punctuation</p>
</li>
<li>
<p>Whole numbers: prefix with '#' (e.g., #10)</p>
</li>
<li>
<p>Decimals: prefix with '<mark>' (e.g., </mark>19.99)</p>
</li>
<li>
<p>Date: yyyy-MM-dd (e.g., 2025-09-10)</p>
</li>
<li>
<p>DateTime (ISO‑8601): 2025-09-10T12:30:00Z (timezone supported)</p>
</li>
<li>
<p>ObjectId (Mongo 24‑hex): 5f1e9b9c8a0b0c0d1e2f3a4b</p>
</li>
<li>
<p>Reference by ObjectId: @@5f1e9b9c8a0b0c0d1e2f3a4b</p>
</li>
<li>
<p>Variables: ${ownerId|principalId|resourceId|action|functionalDomain|pTenantId|pAccountId|rTenantId|rAccountId|realm|area}</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_filters_equals">17.1.7. Simple filters (equals)</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># string equality
name:&quot;Acme Widget&quot;
# whole number
quantity:#10
# decimal number
price:##19.99
# date and datetime
shipDate:2025-09-12
updatedAt:2025-09-12T10:15:00Z
# boolean
active:true
# null checks
description:null
# field exists
lastLogin:~
# object id equality
id:5f1e9b9c8a0b0c0d1e2f3a4b
# variable usage (e.g., tenant scoping)
dataDomain.tenantId:${pTenantId}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_advanced_filters_grouping_and_andornot">17.1.8. Advanced filters: grouping and AND/OR/NOT</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Products that are active and (name contains widget OR gizmo), excluding discontinued
active:true &amp;&amp; (name:*widget* || name:*gizmo*) &amp;&amp; status:!&quot;DISCONTINUED&quot;

# Shipments updated after a date AND (destination NY OR CA)
updatedAt:&gt;=2025-09-01 &amp;&amp; (destination:&quot;NY&quot; || destination:&quot;CA&quot;)

# NOT example: items where category is not null and not (price &lt; 10)
category:!null &amp;&amp; !!(price:&lt;##10)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Wildcard matching uses '<strong>': name:*widget</strong> (prefix/suffix/contains). '?' matches a single character.
- Use parentheses to enforce precedence; otherwise AND/OR follow standard left‑to‑right with explicit operators.</p>
</div>
</div>
<div class="sect3">
<h4 id="_in_lists">17.1.9. IN lists</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>status:^[&quot;OPEN&quot;,&quot;CLOSED&quot;,&quot;ON_HOLD&quot;]
ownerId:^[&quot;u1&quot;,&quot;u2&quot;,&quot;u3&quot;]
referenceId:^[@@5f1e9b9c8a0b0c0d1e2f3a4b, @@6a7b8c9d0e1f2a3b4c5d6e7f]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sorting">17.1.10. Sorting</h4>
<div class="paragraph">
<p>Provide a sort query parameter (comma‑separated fields):
- '-' prefix = descending, '+' or no prefix = ascending.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># single field descending
?sort=-createdAt

# multiple fields: createdAt desc, refName asc
?sort=-createdAt,refName</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_projections">17.1.11. Projections</h4>
<div class="paragraph">
<p>Limit returned fields with the projection parameter (comma‑separated):
- '+' prefix = include, '-' prefix = exclude.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># include only id and refName, exclude heavy fields
?projection=+id,+refName,-auditInfo,-persistentEvents</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_endtoend_examples">17.1.12. End‑to‑end examples</h4>
<div class="ulist">
<ul>
<li>
<p>GET /products/list?skip=0&amp;limit=50&amp;filter=active:true&amp;&amp;name:*widget*&amp;sort=-updatedAt&amp;projection=+id,+name,-auditInfo</p>
</li>
<li>
<p>GET /shipments/list?filter=(destination:"NY"||destination:"CA")&amp;&amp;updatedAt:&gt;=2025-09-01&amp;sort=origin</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These features integrate with RuleContext and DataDomain: your filter runs within the tenant/org scope derived from the security context; RuleContext may add further predicates or projections automatically.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_csv_export_and_import">17.2. CSV Export and Import</h3>
<div class="paragraph">
<p>These endpoints are inherited by every resource that extends BaseResource. They are mounted under the resource’s base path. For example, PolicyResource at /security/permission/policies exposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /security/permission/policies/csv</p>
</li>
<li>
<p>POST /security/permission/policies/csv</p>
</li>
<li>
<p>POST /security/permission/policies/csv/session</p>
</li>
<li>
<p>POST /security/permission/policies/csv/session/{sessionId}/commit</p>
</li>
<li>
<p>DELETE /security/permission/policies/csv/session/{sessionId}</p>
</li>
<li>
<p>GET /security/permission/policies/csv/session/{sessionId}/rows</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authorization and scoping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All CSV endpoints are protected by the same @RolesAllowed("user", "admin") checks as other CRUD operations.</p>
</li>
<li>
<p>RuleContext filters and DataDomain scoping apply the same way as list/find; exports stream only what the caller may see, and imports are saved under the same permissions.</p>
</li>
<li>
<p>In multi‑realm deployments, include your X-Realm header as you do for CRUD; underlying repos resolve realm and domain context consistently.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_export_get_csv">17.2.1. Export: GET /csv</h4>
<div class="paragraph">
<p>Produces a streamed CSV download of the current resource collection.</p>
</div>
<div class="paragraph">
<p>Query parameters and behavior:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fieldSeparator (default <code>"</code>)</dt>
<dd>
<p>Single character used to separate fields. Typical values: <code>,</code>, <code>;</code>, <code>\t</code>.</p>
</dd>
<dt class="hdlist1">requestedColumns (default refName)</dt>
<dd>
<p>Comma‑separated list of model field names to include, in output order. If omitted, BaseResource defaults to refName. Nested list extraction is supported with the <code>[0]</code> notation on a single nested property across all requested columns (e.g., <code>addresses[0].city</code>, <code>addresses[0].zip</code>). Indices other than <code>[0]</code> are rejected. If the nested list has multiple items, multiple rows are emitted per record (one per list element), preserving other column values.</p>
</dd>
<dt class="hdlist1">quotingStrategy (default QUOTE_WHERE_ESSENTIAL)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>QUOTE_WHERE_ESSENTIAL: quote only when needed (when a value contains the separator or quoteChar).</p>
</li>
<li>
<p>QUOTE_ALL_COLUMNS: quote every column in every row.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">quoteChar (default <code>"</code>)</dt>
<dd>
<p>The character used to surround quoted values.</p>
</dd>
<dt class="hdlist1">decimalSeparator (default <code>.</code>)</dt>
<dd>
<p>Reserved for decimal formatting. Note: current implementation ignores this value; decimals are rendered using the locale‑independent dot.</p>
</dd>
<dt class="hdlist1">charsetEncoding (default UTF-8-without-BOM)</dt>
<dd>
<p>One of: <code>US-ASCII</code>, <code>UTF-8-without-BOM</code>, <code>UTF-8-with-BOM</code>, <code>UTF-16-with-BOM</code>, <code>UTF-16BE</code>, <code>UTF-16LE</code>. “with‑BOM” values write a Byte Order Mark at the beginning of the file (UTF‑8: <code>EF BB BF</code>; UTF‑16: <code>FE FF</code>).</p>
</dd>
<dt class="hdlist1">filter (optional)</dt>
<dd>
<p>ANTLR DSL filter applied server‑side before streaming (see Query Language section). Reduces rows and can improve performance.</p>
</dd>
<dt class="hdlist1">filename (default downloaded.csv)</dt>
<dd>
<p>Suggested download filename returned via Content‑Disposition header.</p>
</dd>
<dt class="hdlist1">offset (default 0)</dt>
<dd>
<p>Zero‑based index of the first record to stream.</p>
</dd>
<dt class="hdlist1">length (default 1000, use <code>-1</code> for all)</dt>
<dd>
<p>Maximum number of records to stream from offset. Use <code>-1</code> to stream all (be mindful of client memory/time).</p>
</dd>
<dt class="hdlist1">prependHeaderRow (optional boolean, default false)</dt>
<dd>
<p>When true, the first row contains column headers. Requires requestedColumns to be set (the default refName satisfies this requirement).</p>
</dd>
<dt class="hdlist1">preferredColumnNames (optional list)</dt>
<dd>
<p>Overrides header names positionally when <code>prependHeaderRow=true</code>. The list length must be ≤ requestedColumns; an empty string entry means “use default field name” for that column.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>200 OK with Content-Type: text/csv and Content-Disposition: attachment; filename="&#8230;&#8203;".</p>
</li>
<li>
<p>On validation/processing errors, the response status is 400/500 and the body contains a single text line describing the problem (e.g., “Incorrect information supplied: …”). Unrecognized query parameters are rejected with 400.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Export selected fields with header, custom filename and filter</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: system-com&quot; \
     &quot;https://host/api/products/csv?requestedColumns=id,refName,price&amp;prependHeaderRow=true&amp;filename=products.csv&amp;filter=active:true&amp;sort=+refName&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Export nested list’s first element across columns</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># emits one row per address entry when more than one is present
curl -H &quot;Authorization: Bearer $JWT&quot; \
     &quot;https://host/api/customers/csv?requestedColumns=refName,addresses[0].city,addresses[0].zip&amp;prependHeaderRow=true&quot;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_import_post_csv_multipart">17.2.2. Import: POST /csv (multipart)</h4>
<div class="paragraph">
<p>Consumes a CSV file (multipart/form‑data) and imports records in batches. The form field name for the file is file.</p>
</div>
<div class="paragraph">
<p>Query parameters and behavior:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fieldSeparator (default <code>"</code>)</dt>
<dd>
<p>Single character expected between fields.</p>
</dd>
<dt class="hdlist1">quotingStrategy (default QUOTE_WHERE_ESSENTIAL)</dt>
<dd>
<p>Same values as export; controls how embedded quotes are recognized.</p>
</dd>
<dt class="hdlist1">quoteChar (default <code>"</code>)</dt>
<dd>
<p>The expected quote character in the file.</p>
</dd>
<dt class="hdlist1">skipHeaderRow (default true)</dt>
<dd>
<p>When true, the first row is treated as a header and skipped. Mapping is positional, not by header names.</p>
</dd>
<dt class="hdlist1">charsetEncoding (default UTF-8-without-BOM)</dt>
<dd>
<p>The file encoding. “with‑BOM” variants allow consuming a BOM at the start.</p>
</dd>
<dt class="hdlist1">requestedColumns (required)</dt>
<dd>
<p>Comma‑separated list of model field names in the same order as the CSV columns. This positional mapping drives parsing and validation. Nested list syntax <code>[0]</code> is allowed with the same constraints as export.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each row is parsed into a model instance using type‑aware processors (ints, longs, decimals, enums, etc.).</p>
</li>
<li>
<p>Bean Validation is applied; rows with violations are collected as errors and not saved; valid rows are batched and saved.</p>
</li>
<li>
<p>For each saved batch, insert vs update is determined by refName presence in the repository.</p>
</li>
<li>
<p>Response entity includes counts (importedCount, failedCount) and per‑row results when available.</p>
</li>
<li>
<p>Response headers:</p>
<div class="ulist">
<ul>
<li>
<p>X-Import-Success-Count: number of rows successfully imported.</p>
</li>
<li>
<p>X-Import-Failed-Count: number of rows that failed validation or DB write.</p>
</li>
<li>
<p>X-Import-Message: summary message.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example (direct import):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;X-Realm: system-com&quot; \
  -F &quot;file=@policies.csv&quot; \
  &quot;https://host/api/security/permission/policies/csv?requestedColumns=refName,principalId,description&amp;skipHeaderRow=true&amp;fieldSeparator=,&amp;quoteChar=\&quot;&amp;quotingStrategy=QUOTE_WHERE_ESSENTIAL&amp;charsetEncoding=UTF-8-without-BOM&quot;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_import_with_preview_sessions">17.2.3. Import with preview sessions</h4>
<div class="paragraph">
<p>Use a two‑step flow to analyze first, then commit only valid rows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POST /csv/session (multipart): analyzes the file and creates a session</p>
<div class="ulist">
<ul>
<li>
<p>Same parameters as POST /csv (fieldSeparator, quotingStrategy, quoteChar, skipHeaderRow, charsetEncoding, requestedColumns).</p>
</li>
<li>
<p>Returns a preview ImportResult including sessionId, totals (totalRows, validRows, errorRows), and row‑level findings. No data is saved yet.</p>
</li>
</ul>
</div>
</li>
<li>
<p>POST /csv/session/{sessionId}/commit: imports only error‑free rows from the analyzed session</p>
<div class="ulist">
<ul>
<li>
<p>Returns CommitResult with inserted/updated counts.</p>
</li>
<li>
<p>DELETE /csv/session/{sessionId}: cancels and discards session state (idempotent; always returns 204).</p>
</li>
</ul>
</div>
</li>
<li>
<p>GET /csv/session/{sessionId}/rows: page through analyzed rows</p>
<div class="ulist">
<ul>
<li>
<p>Query params:</p>
</li>
<li>
<p>skip (default 0), limit (default 50)</p>
</li>
<li>
<p>onlyErrors (default false): when true, returns only rows with errors</p>
</li>
<li>
<p>intent (optional): filter rows by intended action: INSERT, UPDATE, or SKIP</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes and constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>requestedColumns must reference actual model fields. Unknown fields or multiple different nested properties are rejected (only one nested property across requestedColumns is allowed when using [0]).</p>
</li>
<li>
<p>Unrecognized query parameters are rejected with HTTP 400 to prevent silent misconfiguration.</p>
</li>
<li>
<p>Very large exports should prefer streaming with sensible length settings or server‑side filters to reduce memory and time.</p>
</li>
<li>
<p>Imports run under the same security rules as POST / (save). Ensure the caller has permission to create/update the target entities in the chosen realm.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_enhanced_import_with_importprofile">17.2.4. Enhanced Import with ImportProfile</h4>
<div class="paragraph">
<p>ImportProfile provides reusable, configurable transformation and mapping rules for CSV imports. Profiles are persistent entities that can be created via REST and referenced during imports.</p>
</div>
<div class="sect4">
<h5 id="_key_features">Key Features</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Value Mapping</strong>: Transform CSV values before type conversion (e.g., "Y" → <code>true</code>, "Active" → <code>ACTIVE</code>)</p>
</li>
<li>
<p><strong>Lookup Resolution</strong>: Resolve foreign references by looking up values in other collections</p>
</li>
<li>
<p><strong>String Transformations</strong>: Trim, case conversion, regex replacement</p>
</li>
<li>
<p><strong>Intent Control</strong>: Specify INSERT vs UPDATE per row via an intent column</p>
</li>
<li>
<p><strong>Header Modifiers</strong>: Mark fields as required (*), optional (?), calculated (~), or key (#)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_using_a_profile">Using a Profile</h5>
<div class="paragraph">
<p>Create a profile first, then reference it during import:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Create profile
curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;Content-Type: application/json&quot; \
  &quot;https://host/api/integration/import-profiles&quot; \
  -d @product-import-profile.json

# Import using profile
curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -F &quot;file=@products.csv&quot; \
  &quot;https://host/api/products/csv/session/profile?profileRefName=product-import-v1&quot;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_profile_with_session_flow">Profile with Session Flow</h5>
<div class="ulist">
<ul>
<li>
<p>POST /{entity}/csv/session/profile (multipart): analyzes the file using the specified profile</p>
<div class="ulist">
<ul>
<li>
<p>Query param: <code>profileRefName</code> - reference to an existing ImportProfile</p>
</li>
<li>
<p>Returns preview ImportResult including sessionId, totals, and row-level findings</p>
</li>
</ul>
</div>
</li>
<li>
<p>POST /{entity}/csv/session/{sessionId}/commit: imports valid rows (same as basic flow)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_example_importprofile_json">Example ImportProfile (JSON)</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">product-import-v1</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">displayName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Product Import Profile</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">targetType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.Product</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">columnMappings</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sourceColumn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Status</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">targetField</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">valueMappings</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ACTIVE</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">I</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">INACTIVE</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DISCONTINUED</span><span class="delimiter">&quot;</span></span>
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">unmappedValueBehavior</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span>
    },
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sourceColumn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Category</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">targetField</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">categoryRefName</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">lookup</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">lookupCollection</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Category</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">lookupMatchField</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">displayName</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">lookupReturnField</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">onNotFound</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span>
      }
    }
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">intentColumn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">_action</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultIntent</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">UPSERT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_intent_column">Intent Column</h5>
<div class="paragraph">
<p>When <code>intentColumn</code> is configured, each row can specify its own intent:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Intent</th>
<th class="tableblock halign-left valign-top">Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert new record. Fails if refName already exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update existing record. Fails if refName does not exist.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPSERT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto-detect: INSERT if new, UPDATE if exists.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SKIP</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip this row entirely.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>MERGE</code> and <code>DELETE</code> are intentionally not supported for safety reasons.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For complete ImportProfile documentation, see <a href="../design/csv-import-enhancements.html">CSV Import Enhancements</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rowvalueresolver_custom_per_row_logic">17.2.5. RowValueResolver: Custom Per-Row Logic</h4>
<div class="paragraph">
<p>The <code>RowValueResolver</code> SPI allows arbitrary code execution for each row during import. Unlike static lookups, RowValueResolvers have access to all columns in the row and can invoke external services.</p>
</div>
<div class="sect4">
<h5 id="_key_features_2">Key Features</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Arc CDI Beans</strong>: Full dependency injection support</p>
</li>
<li>
<p><strong>Multi-Collection Updates</strong>: Update multiple collections from a single CSV row</p>
</li>
<li>
<p><strong>Full Row Access</strong>: Read any column value, not just the mapped column</p>
</li>
<li>
<p><strong>Context Awareness</strong>: Access to realm, session, row number, and profile</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_example_implementation">Example Implementation</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">GeocodeResolver</span> <span class="directive">implements</span> RowValueResolver {

    <span class="annotation">@Inject</span>
    GeocodingService geocodingService;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">geocodeResolver</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">ResolveResult</span> resolve(<span class="predefined-type">String</span> inputValue, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; rowData, ImportContext context) {
        <span class="predefined-type">String</span> street = (<span class="predefined-type">String</span>) rowData.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> city = (<span class="predefined-type">String</span>) rowData.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">city</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> state = (<span class="predefined-type">String</span>) rowData.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">state</span><span class="delimiter">&quot;</span></span>);

        GeocodingResult result = geocodingService.geocode(
            <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s, %s, %s</span><span class="delimiter">&quot;</span></span>, street, city, state));

        <span class="keyword">if</span> (result != <span class="predefined-constant">null</span> &amp;&amp; result.isValid()) {
            <span class="keyword">return</span> <span class="predefined-type">ResolveResult</span>.success(<span class="keyword">new</span> GeoPoint(result.getLatitude(), result.getLongitude()));
        }
        <span class="keyword">return</span> <span class="predefined-type">ResolveResult</span>.nullValue();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_in_importprofile">Configuration in ImportProfile</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">columnMappings</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sourceColumn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">targetField</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">rowValueResolverName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">geocodeResolver</span><span class="delimiter">&quot;</span></span>
    }
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_result_types">Result Types</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResolveResult.success(value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the field to the resolved value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResolveResult.passthrough(original)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keep the original value unchanged</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResolveResult.nullValue()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the field to null</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResolveResult.skip()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip this row (not an error)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResolveResult.error(message)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mark the row as an error</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For complete RowValueResolver documentation, see <a href="../design/csv-import-enhancements.html">CSV Import Enhancements</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_attribute_import">17.2.6. Dynamic Attribute Import</h4>
<div class="paragraph">
<p>For entities with dynamic attributes (schema-less, nested key-value structures), Quantum supports multiple import strategies.</p>
</div>
<div class="sect4">
<h5 id="_import_strategies">Import Strategies</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DOT_NOTATION</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>dyn.setName.attrName[:type]</code> column headers. Best for spreadsheet-friendly imports.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JSON_COLUMN</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single JSON column containing all attributes. Best for programmatic imports.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>VERTICAL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple rows per entity with one attribute per row. Best for attribute-centric workflows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>HYBRID</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines DOT_NOTATION and JSON_COLUMN in the same import.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_dot_notation_example">DOT_NOTATION Example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">name,sku,dyn.logistics.weight:Double,dyn.logistics.hazmat:Boolean,dyn.compliance.ce_mark:Boolean
&quot;Widget Pro&quot;,&quot;WGT-001&quot;,2.5,false,true
&quot;Gadget X&quot;,&quot;GDG-002&quot;,1.2,false,true</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_json_column_example">JSON_COLUMN Example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">name,sku,dynamicAttributes
&quot;Widget Pro&quot;,&quot;WGT-001&quot;,&quot;{&quot;&quot;logistics&quot;&quot;:{&quot;&quot;weight&quot;&quot;:2.5,&quot;&quot;hazmat&quot;&quot;:false},&quot;&quot;compliance&quot;&quot;:{&quot;&quot;ce_mark&quot;&quot;:true}}&quot;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_in_importprofile_2">Configuration in ImportProfile</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">product-import-dynamic</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamicAttributeStrategy</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DOT_NOTATION</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamicAttributePrefix</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dyn.</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">enableDynamicAttributeDiscovery</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dynamicAttributeMergeStrategy</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_merge_strategies">Merge Strategies</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REPLACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove all existing attributes, replace with imported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MERGE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keep existing attributes, update matching, add new</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>APPEND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keep existing attributes, only add new (no updates)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For complete dynamic attribute import documentation, see <a href="../design/csv-dynamic-attributes-design.html">CSV Dynamic Attributes Design</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rest-crud-auth">18. Authentication and Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum integrates with Quarkus security while providing a pluggable approach to authentication. The repository includes a JWT provider module to get started quickly and an extension surface to replace or complement it.</p>
</div>
<div class="sect2">
<h3 id="_jwt_provider">18.1. JWT Provider</h3>
<div class="ulist">
<ul>
<li>
<p>Module: quantum-jwt-provider</p>
</li>
<li>
<p>Purpose: Validate JWTs on incoming requests, populate the security principal, and surface tenant/org/user claims that feed DomainContext.</p>
</li>
<li>
<p>Configuration: Standard Quarkus/MicroProfile JWT properties plus custom claim mappings as needed for DataDomain.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_pluggable_authentication">18.2. Pluggable Authentication</h3>
<div class="paragraph">
<p>You can introduce alternative authentication mechanisms (e.g., API keys, SAML/OIDC front-channel tokens exchanged for back-end JWTs, HMAC signatures) by providing CDI beans that integrate with the security layer and emit the same normalized context consumed by DomainContext/RuleContext.</p>
</div>
<div class="paragraph">
<p>Typical steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement a request filter or identity provider that validates the token/credential.</p>
</li>
<li>
<p>Map identity and tenant claims into a principal model (tenantId, orgRefName, userId, roles).</p>
</li>
<li>
<p>Ensure BaseResource (and other entry points) can derive DomainContext from that principal.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference">18.3. Creating an Auth Plugin (using the Custom JWT provider as a reference)</h3>
<div class="paragraph">
<p>An auth plugin is typically a CDI bean that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extends BaseAuthProvider to inherit user-management helpers and persistence utilities.</p>
</li>
<li>
<p>Implements AuthProvider to integrate with request-time authentication flows.</p>
</li>
<li>
<p>Implements UserManagement to expose CRUD-style operations for users, passwords, and roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A concrete provider should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Be annotated as a CDI bean (e.g., @ApplicationScoped).</p>
</li>
<li>
<p>Provide a stable getName() identifier (e.g., "custom", "oidc", "apikey").</p>
</li>
<li>
<p>Use config properties for secrets, issuers, token durations, and any external identity provider details.</p>
</li>
<li>
<p>Build a Quarkus SecurityIdentity with the authenticated principal and roles.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authprovider_interface_what_a_provider_must_implement">18.4. AuthProvider interface (what a provider must implement)</h3>
<div class="paragraph">
<p>Core methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityIdentity validateAccessToken(String token)</p>
<div class="ulist">
<ul>
<li>
<p>Parse and validate the incoming credential (JWT, API key, signature).</p>
</li>
<li>
<p>Return a SecurityIdentity with principal name and roles; throw a security exception for invalid tokens.</p>
</li>
</ul>
</div>
</li>
<li>
<p>String getName()</p>
<div class="ulist">
<ul>
<li>
<p>A short identifier for the provider; persisted alongside credentials and used in logs/metrics.</p>
</li>
</ul>
</div>
</li>
<li>
<p>LoginResponse login(String userId, String password)</p>
<div class="ulist">
<ul>
<li>
<p>Credential-based login. Return a structured response:</p>
<div class="ulist">
<ul>
<li>
<p>positiveResponse: includes SecurityIdentity, roles, accessToken, refreshToken, expirationTime, and realm/mongodbUrl if applicable.</p>
</li>
<li>
<p>negativeResponse: includes error codes/reason/message for clients to act on (e.g., password change required).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>LoginResponse refreshTokens(String refreshToken)</p>
<div class="ulist">
<ul>
<li>
<p>Validate the refresh token, mint a new access token (and optionally a new refresh token), and return a positive response.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login flow should check force-change-password or equivalent flags and return a negative response when user interaction is required before issuing tokens.</p>
</li>
<li>
<p>validateAccessToken should only accept valid, non-expired tokens and construct SecurityIdentity consistently with role mappings used across the platform.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_usermanagement_interface_operations_your_plugin_must_support">18.5. UserManagement interface (operations your plugin must support)</h3>
<div class="paragraph">
<p>Typical responsibilities include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User lifecycle</p>
<div class="ulist">
<ul>
<li>
<p>String createUser(String userId, String password, Set&lt;String&gt; roles, DomainContext domainContext, [optional] DataDomain)</p>
</li>
<li>
<p>void changePassword(String userId, String oldPassword, String newPassword, Boolean forceChangePassword)</p>
</li>
<li>
<p>boolean removeUserWithUserId(String userId)</p>
</li>
<li>
<p>boolean removeUserWithSubject(String subject)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Role management</p>
<div class="ulist">
<ul>
<li>
<p>void assignRolesForUserId(String userId, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void assignRolesForSubject(String subject, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void removeRolesForUserId(String userId, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void removeRolesForSubject(String subject, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>Set&lt;String&gt; getUserRolesForUserId(String userId)</p>
</li>
<li>
<p>Set&lt;String&gt; getUserRolesForSubject(String subject)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Lookups and existence checks</p>
<div class="ulist">
<ul>
<li>
<p>Optional&lt;String&gt; getSubjectForUserId(String userId)</p>
</li>
<li>
<p>Optional&lt;String&gt; getUserIdForSubject(String subject)</p>
</li>
<li>
<p>boolean userIdExists(String userId)</p>
</li>
<li>
<p>boolean subjectExists(String subject)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Return values and exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Throw SecurityException or domain-specific exceptions for invalid states (duplicate users, bad password, unsupported hashing).</p>
</li>
<li>
<p>Return Optional for lookups that may not find a result.</p>
</li>
<li>
<p>For removals, return boolean to communicate whether a record was deleted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_leveraging_baseauthprovider_in_your_plugin">18.6. Leveraging BaseAuthProvider in your plugin</h3>
<div class="paragraph">
<p>When you extend BaseAuthProvider, you inherit ready-to-use capabilities that reduce boilerplate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Impersonation controls</p>
<div class="ulist">
<ul>
<li>
<p>enableImpersonationWithUserId / enableImpersonationWithSubject</p>
</li>
<li>
<p>disableImpersonationWithUserId / disableImpersonationWithSubject</p>
</li>
<li>
<p>These set or clear an impersonation filter script and realm regex that downstream services can honor to act on behalf of another identity under controlled scope.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Realm override helpers</p>
<div class="ulist">
<ul>
<li>
<p>enableRealmOverrideWithUserId / enableRealmOverrideWithSubject</p>
</li>
<li>
<p>disableRealmOverrideWithUserId / disableRealmOverrideWithSubject</p>
</li>
<li>
<p>Useful for multi-realm/tenant scenarios, enabling scoped cross-realm behavior.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Persistence utilities</p>
<div class="ulist">
<ul>
<li>
<p>Built-in use of the credential repository to save, update, and delete credentials.</p>
</li>
<li>
<p>Consistent validation of inputs (non-null checks, non-blank checks).</p>
</li>
<li>
<p>Hashing algorithm guardrails to ensure only supported algorithms are used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Best practices when deriving:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always set the auth provider name in stored credentials so records can be traced to the correct provider.</p>
</li>
<li>
<p>Reuse the role merge/remove patterns to avoid accidental role loss.</p>
</li>
<li>
<p>Prefer emitting precise exceptions (e.g., NotFound for missing users, SecurityException for access violations).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_your_own_provider">18.7. Implementing your own provider</h3>
<div class="paragraph">
<p>Checklist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Class design</p>
<div class="ulist">
<ul>
<li>
<p>@ApplicationScoped bean</p>
</li>
<li>
<p>extends BaseAuthProvider</p>
</li>
<li>
<p>implements AuthProvider and UserManagement</p>
</li>
<li>
<p>return a stable getName()</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration</p>
<div class="ulist">
<ul>
<li>
<p>Externalize secrets (signing keys), issuers, token durations, and realm details via MicroProfile Config.</p>
</li>
</ul>
</div>
</li>
<li>
<p>SecurityIdentity</p>
<div class="ulist">
<ul>
<li>
<p>Consistently build identities with principal and roles; include useful attributes for auditing/telemetry.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tokens/credentials</p>
<div class="ulist">
<ul>
<li>
<p>For JWT-like tokens, implement robust parsing, signature verification, expiration checks, and claim validation.</p>
</li>
<li>
<p>For non-JWT credentials (API keys, HMAC), ensure replay protection and scope binding.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Responses and errors</p>
<div class="ulist">
<ul>
<li>
<p>Use structured LoginResponse for both success and error paths.</p>
</li>
<li>
<p>Prefer idempotent user/role operations; validate inputs and surface actionable messages.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_credentialuseridpassword_model_and_domaincontext">18.8. CredentialUserIdPassword model and DomainContext</h3>
<div class="paragraph">
<p>This section explains how user credentials are represented, how those records tie to tenancy and realms, and how the server chooses the database (“realm”) for REST calls.</p>
</div>
<div class="paragraph">
<p>What the credential model represents</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">userId</dt>
<dd>
<p>The human-friendly login handle that users type. Must be unique within the applicable tenancy/realm scope.</p>
</dd>
<dt class="hdlist1">subject</dt>
<dd>
<p>A stable, system-generated identifier for the principal. Tokens and internal references favor subject over userId because subjects do not change.</p>
</dd>
<dt class="hdlist1">description, emailOfResponsibleParty</dt>
<dd>
<p>Optional metadata to describe the credential and provide an owner contact.</p>
</dd>
<dt class="hdlist1">domainContext</dt>
<dd>
<p>The tenancy and organization placement of the principal. It contains:</p>
<div class="ulist">
<ul>
<li>
<p>tenantId: Logical tenant partition.</p>
</li>
<li>
<p>orgRefName: Organization/business unit within the tenant.</p>
</li>
<li>
<p>accountId: Account or billing identifier.</p>
</li>
<li>
<p>defaultRealm: The default database/realm used for this identity’s operations.</p>
</li>
<li>
<p>dataSegment: Optional partitioning segment for advanced sharding or data slicing.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">roles</dt>
<dd>
<p>The set of authorities granted (e.g., USER, ADMIN). These become groups/roles on the SecurityIdentity.</p>
</dd>
<dt class="hdlist1">issuer</dt>
<dd>
<p>An identifier for who issued the credential or tokens (useful for auditing and multi-provider setups).</p>
</dd>
<dt class="hdlist1">passwordHash, hashingAlgorithm</dt>
<dd>
<p>The stored password hash and declared algorithm. Not exposed over REST. Providers verify passwords against this.</p>
</dd>
<dt class="hdlist1">forceChangePassword</dt>
<dd>
<p>Flag that forces a password reset on next login; the login flow returns a structured negative response instead of tokens.</p>
</dd>
<dt class="hdlist1">lastUpdate</dt>
<dd>
<p>Timestamp for auditing and token invalidation strategies.</p>
</dd>
<dt class="hdlist1">area2RealmOverrides</dt>
<dd>
<p>Optional map to route specific functional areas to different realms than the default (e.g., “Reporting” → analytics-realm).</p>
</dd>
<dt class="hdlist1">realmRegEx</dt>
<dd>
<p>Optional regex to limit or override which realms this identity may act in; also used by impersonation/override flows.</p>
</dd>
<dt class="hdlist1">impersonateFilterScript</dt>
<dd>
<p>Optional script indicating the filter/scope applied during impersonation so actions are constrained.</p>
</dd>
<dt class="hdlist1">authProviderName</dt>
<dd>
<p>The name of the provider that owns this credential (e.g., “custom”, “oidc”), enabling multi-provider operations and audits.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>How DomainContext selects the realm for REST calls</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For each authenticated request, the server derives or retrieves a DomainContext associated with the principal.</p>
</li>
<li>
<p>The DomainContext.defaultRealm indicates which backing MongoDB database (“realm”) should be used by repositories for that request.</p>
</li>
<li>
<p>If realm override features are enabled (e.g., through provider helpers or per-credential overrides), the system may route certain functional areas to alternate realms using area2RealmOverrides or validated by realmRegEx.</p>
</li>
<li>
<p>The remainder of DomainContext (tenantId, orgRefName, accountId, dataSegment) is applied as scope constraints through permission rules and repository filters so reads and writes are automatically restricted to the correct tenant/org segment.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps">18.9. Quarkus OIDC out-of-the-box and integrating with common IdPs</h3>
<div class="paragraph">
<p>Quarkus ships with first-class OpenID Connect (OIDC) support, enabling both service-to-service and browser-based logins.</p>
</div>
<div class="paragraph">
<p>What the Quarkus OIDC extension provides</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OIDC client and server-side adapters:</p>
<div class="ulist">
<ul>
<li>
<p>Authorization Code flow with PKCE for browser sign-in.</p>
</li>
<li>
<p>Bearer token authentication for APIs (validating access tokens on incoming requests).</p>
</li>
<li>
<p>Token propagation for downstream calls (forwarding or exchanging tokens).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Token verification and claim mapping:</p>
<div class="ulist">
<ul>
<li>
<p>Validates issuer, audience, signature, expiration, and scopes.</p>
</li>
<li>
<p>Maps standard claims (sub, email, groups/roles) into the security identity.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multi-tenancy and configuration:</p>
<div class="ulist">
<ul>
<li>
<p>Supports multiple OIDC tenants via configuration, each with its own issuer, client id/secret, and flows.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Logout and session support:</p>
<div class="ulist">
<ul>
<li>
<p>Front-channel and back-channel logout hooks depending on provider capabilities.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Integrating with common providers</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Works with providers like Keycloak, Auth0, Okta, Azure AD, Cognito, and enterprise IdPs exposing OIDC.</p>
</li>
<li>
<p>Configure the issuer URL and client credentials. Quarkus discovers endpoints via the provider’s .well-known/openid-configuration.</p>
</li>
<li>
<p>For roles/permissions, map provider groups/roles claims to your platform roles in the identity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OIDC vs OAuth vs OpenID (terminology and evolution)</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OAuth 2.0</dt>
<dd>
<p>Authorization framework for delegated access (scopes), not authentication. Defines flows to obtain access tokens for APIs.</p>
</dd>
<dt class="hdlist1">OpenID (OpenID 1.x/2.0)</dt>
<dd>
<p>Older federated identity protocol that preceded OIDC. It has been superseded by OpenID Connect.</p>
</dd>
<dt class="hdlist1">OpenID Connect (OIDC)</dt>
<dd>
<p>An identity layer on top of OAuth 2.0. Adds standardized authentication, user info endpoints, ID tokens (JWT) with subject and profile claims, and discovery metadata. In practice, OIDC is the modern standard for SSO and user authentication; OAuth remains the authorization substrate underneath.</p>
</dd>
<dt class="hdlist1">Summary</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>OpenID → historical, replaced by OIDC.</p>
</li>
<li>
<p>OAuth 2.0 → authorization framework.</p>
</li>
<li>
<p>OIDC → authentication (identity) layer built on OAuth 2.0.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>OIDC and SAML in relation to SSO</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SAML (Security Assertion Markup Language)</dt>
<dd>
<p>XML-based federation protocol widely used in enterprises for browser SSO; uses signed XML assertions transported through browser redirects/posts.</p>
</dd>
<dt class="hdlist1">OIDC</dt>
<dd>
<p>JSON/REST-oriented, uses JWTs, and is well-suited for modern SPAs and APIs.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Relationship:
* Both enable SSO and federation across identity providers and service providers.
* Many enterprise IdPs support both; OIDC is generally simpler for APIs and modern web stacks, while SAML is entrenched in legacy/enterprise SSO.</p>
</div>
<div class="paragraph">
<p>Bridging:
* Gateways or identity brokers can translate SAML assertions to OIDC tokens and vice versa, allowing gradual migration.</p>
</div>
<div class="paragraph">
<p>Common customer IdP models and OIDC integration patterns</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Centralized IdP (single-tenant)</p>
<div class="ulist">
<ul>
<li>
<p>One organization-wide IdP issues tokens for all users.</p>
</li>
<li>
<p>Configure a single OIDC tenant in Quarkus; map groups/roles to application roles.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multi-tenant SaaS with per-tenant IdP (BYOID)</p>
<div class="ulist">
<ul>
<li>
<p>Each customer brings their own IdP.</p>
</li>
<li>
<p>Configure Quarkus OIDC multitenancy with per-tenant issuer discovery and client credentials.</p>
</li>
<li>
<p>Tenant selection can be based on domain, request header, or path; the selected OIDC tenant performs login and token validation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Brokered identity</p>
<div class="ulist">
<ul>
<li>
<p>Use a broker that federates to multiple upstream IdPs (OIDC, SAML).</p>
</li>
<li>
<p>Quarkus integrates with the broker as a single OIDC client; the broker handles IdP routing and protocol translation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hybrid API and web flows</p>
<div class="ulist">
<ul>
<li>
<p>Browser apps use Authorization Code flow with sessions; APIs use bearer token authentication.</p>
</li>
<li>
<p>The OIDC extension can handle both in the same application when properly configured.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authorization_via_rulecontext">18.10. Authorization via RuleContext</h3>
<div class="paragraph">
<p>Authentication establishes identity; RuleContext enforces what the identity can do. For each action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE), RuleContext can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow or deny the action</p>
</li>
<li>
<p>Contribute additional filters (e.g., org scoping, functional-area specific sharing)</p>
</li>
<li>
<p>Adjust UIActionList to reflect permitted next steps</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This division of responsibilities keeps providers focused on identity while policies remain centralized in RuleContext.</p>
</div>
<div class="sect3">
<h4 id="ontology-rest-crud">18.10.1. Using Ontology Edges in List Endpoints (optional)</h4>
<div class="paragraph">
<p>When ontology is enabled and edges are materialized, list endpoints can avoid deep joins or multi-collection traversals by rewriting queries based on semantic relationships.</p>
</div>
<div class="paragraph">
<p>Pattern A: Wrap BSON with ListQueryRewriter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson base = Filters.and(existingFilters...);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgRefName);
collection.find(rewritten).iterator();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pattern B: Constrain Morphia query by IDs</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; ids = edgeDao.srcIdsByDst(tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, region);
<span class="keyword">if</span> (!ids.isEmpty()) {
  query.filter(dev.morphia.query.filters.Filters.in(<span class="string"><span class="delimiter">&quot;</span><span class="content">_id</span><span class="delimiter">&quot;</span></span>, ids));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always scope by tenantId from DomainContext/RuleContext.</p>
</li>
<li>
<p>Index edges on (tenantId, p, dst) and (tenantId, src, p) to keep queries fast.</p>
</li>
<li>
<p>See <a href="ontology.html#ontology-integration-morphia-permissions">Integrating Ontology</a> for more integration options.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-query-language">19. 7. Query language and filtering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Powerful, safe, and consistent querying across collections.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Tenants need flexible reporting and filtration without bespoke endpoints.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: A uniform query language layer with server-side enforcement.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Add query endpoints and test filters/security.</p>
</div>
<div class="sect2">
<h3 id="query-language">19.1. Query Language Reference</h3>
<div class="paragraph">
<p>Quantum uses an ANTLR-based query language (BIAPIQuery.g4) for filtering, searching, and constraining data across all REST endpoints. This single, consistent syntax works everywhere: list APIs, permission rules, and access resolvers.</p>
</div>
<div class="sect3">
<h4 id="_basic_syntax">19.1.1. Basic Syntax</h4>
<div class="sect4">
<h5 id="_operators">Operators</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Symbol</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name:"Widget"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not equals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:!</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status:!"DELETED"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:&lt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>price:&lt;##100</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quantity:&gt;#50</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than or equal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:&#8656;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createdDate:&#8656;2024-12-31</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than or equal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:&gt;=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updatedAt:&gt;=2024-01-01T00:00:00Z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field exists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:~</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description:~</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">In list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:^</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status:^["ACTIVE","PENDING"]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not in list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:!^</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status:!^["DELETED","ARCHIVED"]</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_value_types">Value Types</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none or <code>"&#8230;&#8203;"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name:widget</code> or <code>name:"Super Widget"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (integer)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>#</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quantity:#42</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (decimal)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>##</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>price:##19.99</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shipDate:2024-12-25</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createdAt:2024-12-25T10:30:00Z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>active:true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description:null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id:507f1f77bcf86cd799439011</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@@</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parentId:@@507f1f77bcf86cd799439011</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${&#8230;&#8203;}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ownerId:${principalId}</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_logical_operators">Logical Operators</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Symbol</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&amp;&amp;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>active:true &amp;&amp; price:&gt;##10</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>||</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status:"ACTIVE" || status:"PENDING"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!!</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!!(price:&lt;##5)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grouping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(active:true || featured:true) &amp;&amp; price:&gt;##0</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_common_patterns">19.1.2. Common Patterns</h4>
<div class="sect4">
<h5 id="_string_matching">String Matching</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Exact match
name:&quot;Super Widget&quot;

# Wildcard matching
name:*widget*        # contains &quot;widget&quot;
name:widget*         # starts with &quot;widget&quot;
name:*widget         # ends with &quot;widget&quot;
name:w?dget          # single character wildcard

# Case sensitivity (depends on database collation)
name:&quot;WIDGET&quot;        # may or may not match &quot;widget&quot;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_text_search">Text Search</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Full-text search (requires MongoDB text index)
text(&quot;priority escalation&quot;)

# Combine text search with other filters
text(&quot;priority escalation&quot;) &amp;&amp; status:&quot;OPEN&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>text(&#8230;&#8203;)</code> maps to MongoDB <code>$text</code> queries and is case-insensitive by default.</p>
</li>
<li>
<p>MongoDB allows only one <code>text(&#8230;&#8203;)</code> clause per query.</p>
</li>
<li>
<p>Text search must be backed by a text index on the target collection.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
MongoDB requires <code>$text</code> to be a top-level query operator. The following usages are <strong>not allowed</strong> and will be rejected at parse time:
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Invalid Usage</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inside NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!!text("foo")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoDB does not support <code>$text</code> inside <code>$not</code> or <code>$nor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inside OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>text("foo") || status:"OPEN"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoDB does not allow <code>$text</code> inside <code>$or</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inside elemMatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tags:{text("foo")}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoDB does not support <code>$text</code> inside <code>$elemMatch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple text clauses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>text("foo") &amp;&amp; text("bar")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only one <code>$text</code> operator is allowed per query</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Valid usage: <code>text(&#8230;&#8203;)</code> combined with <code>&amp;&amp;</code> (AND) at the top level is supported because MongoDB allows <code>$text</code> alongside other top-level conditions.</p>
</div>
</div>
<div class="sect4">
<h5 id="_numeric_ranges">Numeric Ranges</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Price between 10 and 100
price:&gt;=##10 &amp;&amp; price:&lt;=##100

# Quantity greater than 0
quantity:&gt;#0

# Exact count
itemCount:#5</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_date_and_time_queries">Date and Time Queries</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Orders from today
createdDate:&gt;=2024-12-25

# Orders from last week
createdDate:&gt;=2024-12-18 &amp;&amp; createdDate:&lt;2024-12-25

# Specific timestamp
updatedAt:2024-12-25T14:30:00Z

# Orders modified this year
updatedAt:&gt;=2024-01-01T00:00:00Z</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_list_membership">List Membership</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Status in specific values (IN)
status:^[&quot;ACTIVE&quot;,&quot;PENDING&quot;,&quot;PROCESSING&quot;]

# Exclude statuses (NOT IN)
status:!^[&quot;DELETED&quot;,&quot;ARCHIVED&quot;]

# User IDs from a list (IN)
ownerId:^[&quot;user1&quot;,&quot;user2&quot;,&quot;user3&quot;]

# Exclude specific users (NOT IN)
ownerId:!^[&quot;user1&quot;,&quot;user2&quot;]

# ObjectId list (IN)
categoryId:^[@@507f1f77bcf86cd799439011, @@507f1f77bcf86cd799439012]

# ObjectId list (NOT IN)
categoryId:!^[@@507f1f77bcf86cd799439011, @@507f1f77bcf86cd799439012]

# Mixed types (coerced automatically)
priority:^[#1,#2,#3]

# Using variables (CSV expansion supported by access resolvers)
customerId:!^[${accessibleCustomerIds}]</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_null_and_existence_checks">Null and Existence Checks</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Field has any value (not null)
description:~

# Field is null
description:null

# Field is not null
description:!null

# Field exists and is not empty string
description:~ &amp;&amp; description:!&quot;&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_examples">Advanced Examples</h5>
<div class="sect5">
<h6 id="_complex_business_logic">Complex Business Logic</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Active products under $50 OR featured products at any price
(active:true &amp;&amp; price:&lt;##50) || featured:true

# Orders needing attention: overdue OR high-value pending
(dueDate:&lt;2024-12-25 &amp;&amp; status:!&quot;COMPLETED&quot;) ||
(status:&quot;PENDING&quot; &amp;&amp; totalAmount:&gt;##1000)

# Products with inventory issues
(quantity:&lt;=#5 &amp;&amp; reorderPoint:&gt;#5) || stockStatus:&quot;OUT_OF_STOCK&quot;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_multi_tenant_filtering">Multi-tenant Filtering</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># User's own records
dataDomain.ownerId:${principalId}

# Organization-wide access
dataDomain.orgRefName:${orgRefName}

# Tenant-scoped with public sharing
dataDomain.tenantId:${pTenantId} || dataDomain.orgRefName:&quot;PUBLIC&quot;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_audit_and_compliance">Audit and Compliance</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Records modified by specific user
auditInfo.lastUpdatedBy:&quot;john.doe&quot;

# Changes in date range
auditInfo.lastUpdatedDate:&gt;=2024-12-01 &amp;&amp;
auditInfo.lastUpdatedDate:&lt;2024-12-31

# Created vs modified
auditInfo.createdDate:auditInfo.lastUpdatedDate  # never modified
auditInfo.createdDate:!auditInfo.lastUpdatedDate # has been modified</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_variables_in_filters">Variables in Filters</h5>
<div class="paragraph">
<p>Variables are resolved from the current security context and can be used in permission rules and access resolvers.</p>
</div>
<div class="sect5">
<h6 id="_standard_variables">Standard Variables</h6>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${principalId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current user&#8217;s ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${pTenantId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal&#8217;s tenant ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${pAccountId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal&#8217;s account ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${pOrgRefName}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal&#8217;s organization</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${realm}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current realm/database</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${area}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current functional area</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${functionalDomain}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current functional domain</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${action}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Current action (CREATE, UPDATE, etc.)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_custom_variables_from_access_resolvers">Custom Variables from Access Resolvers</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// In your AccessListResolver</span>
<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">String</span> key() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleCustomerIds</span><span class="delimiter">&quot;</span></span>;  <span class="comment">// becomes ${accessibleCustomerIds}</span>
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(...) {
    <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">CUST001</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">CUST002</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">CUST003</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Use in filter
customerId:^[${accessibleCustomerIds}]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_performance_tips">Performance Tips</h5>
<div class="sect5">
<h6 id="_efficient_queries">Efficient Queries</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Good: Use indexed fields first
status:&quot;ACTIVE&quot; &amp;&amp; createdDate:&gt;=2024-01-01

# Better: Combine with specific values
status:&quot;ACTIVE&quot; &amp;&amp; ownerId:${principalId} &amp;&amp; createdDate:&gt;=2024-01-01

# Avoid: Leading wildcards on large collections
name:*widget  # can be slow on millions of records</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_projection_for_large_objects">Projection for Large Objects</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># In REST calls, limit returned fields
GET /products/list?filter=active:true&amp;projection=+id,+name,+price,-description</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_integration_with_rest_apis">Integration with REST APIs</h5>
<div class="sect5">
<h6 id="_list_endpoints">List Endpoints</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Basic filtering
GET /products/list?filter=active:true

# With sorting and pagination
GET /products/list?filter=price:&gt;##10&amp;sort=-createdDate&amp;skip=20&amp;limit=10

# Complex filter with projection
GET /orders/list?filter=(status:&quot;PENDING&quot;||status:&quot;PROCESSING&quot;)&amp;&amp;totalAmount:&gt;##100&amp;projection=+id,+status,+totalAmount,+customerName</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_permission_rules">Permission Rules</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: user-own-records</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[GET]</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">/api/**</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.ownerId:${principalId}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_access_resolvers">Access Resolvers</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Resolver returns customer IDs user can access</span>
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;?&gt; resolve(...) {
    <span class="keyword">return</span> customerService.getAccessibleIds(principalId);
}

<span class="comment">// Used in permission rule</span>
andFilterString: <span class="string"><span class="delimiter">&quot;</span><span class="content">customerId:^[${accessibleCustomerIds}]</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_error_handling_2">Error Handling</h5>
<div class="paragraph">
<p>Common syntax errors and solutions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Wrong: Missing quotes for multi-word strings
name:Super Widget
# Right:
name:&quot;Super Widget&quot;

# Wrong: Incorrect number prefix
price:19.99
# Right:
price:##19.99

# Wrong: Invalid date format
createdDate:12/25/2024
# Right:
createdDate:2024-12-25

# Wrong: Unbalanced parentheses
(active:true &amp;&amp; price:&gt;##10
# Right:
(active:true &amp;&amp; price:&gt;##10)

# Wrong: text() inside NOT
!!text(&quot;search&quot;)
# Right: Use text() at top level only
text(&quot;search&quot;) &amp;&amp; status:!&quot;DELETED&quot;

# Wrong: text() inside OR
text(&quot;search&quot;) || status:&quot;ACTIVE&quot;
# Right: Use text() with AND only
text(&quot;search&quot;) &amp;&amp; (status:&quot;ACTIVE&quot; || status:&quot;PENDING&quot;)

# Wrong: Multiple text() clauses
text(&quot;foo&quot;) &amp;&amp; text(&quot;bar&quot;)
# Right: Combine search terms in a single text()
text(&quot;foo bar&quot;)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_see_also">See Also</h5>
<div class="ulist">
<ul>
<li>
<p><a href="rest-crud.html#querying">REST CRUD Querying</a></p>
</li>
<li>
<p><a href="permissions.html">Permission Rules</a></p>
</li>
<li>
<p><a href="domain-rule-context.html">Access Resolvers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_execution_engines_and_listeners">Execution engines and listeners</h5>
<div class="paragraph">
<p>The BIAPI query syntax is parsed once (via ANTLR) and can be executed by different "listeners" depending on the use case. Quantum ships with two primary implementations that share the same grammar and semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Morphia listener: converts a query into Mongo/Morphia Filters for database-side execution</p>
</li>
<li>
<p>In-memory listener: converts a query into a Java Predicate over JSON data for Quarkus/GraalVM-friendly in-memory execution</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_morphia_querytofilterlistener">Morphia: QueryToFilterListener</h6>
<div class="paragraph">
<p>Use this when you want the database to perform the filtering. The listener walks the parse tree and produces a dev.morphia.query.filters.Filter which you can apply to Morphia queries. This is ideal for repository APIs and any endpoint where you want to leverage MongoDB indexes and avoid loading large data sets into memory.</p>
</div>
<div class="paragraph">
<p>Key characteristics:
- Output type: Morphia Filter
- Execution: database-side (MongoDB)
- Semantics: identical to grammar (comparisons, IN/NIN, exists, null, regex with wildcards, elemMatch, boolean &amp;&amp;/||/!!)
- Text search: <code>text("&#8230;&#8203;")</code> is supported when a collection has a text index; only one text clause is allowed per query, and it must be at the top level (cannot be inside OR, NOT, or elemMatch).
- Variable expansion: supports ${vars} and single-variable IN list expansion (e.g., [${ids}] can expand to a collection/array or a comma-separated string)</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.grammar</span>.*;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.QueryToFilterListener</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.query.filters.Filter</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.query.filters.Filters</span>;
<span class="keyword">import</span> <span class="include">org.antlr.v4.runtime</span>.*;
<span class="keyword">import</span> <span class="include">org.antlr.v4.runtime.tree.ParseTreeWalker</span>;
<span class="keyword">import</span> <span class="include">org.apache.commons.text.StringSubstitutor</span>;

<span class="predefined-type">String</span> query = <span class="string"><span class="delimiter">&quot;</span><span class="content">(status:Assigned||status:Pending)&amp;&amp;displayName:*Route*</span><span class="delimiter">&quot;</span></span>;
<span class="type">var</span> vars = java.util.Map.&lt;<span class="predefined-type">String</span>,<span class="predefined-type">String</span>&gt;of();

<span class="comment">// Parse</span>
CharStream cs = CharStreams.fromString(query);
BIAPIQueryLexer lexer = <span class="keyword">new</span> BIAPIQueryLexer(cs);
CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);
BIAPIQueryParser parser = <span class="keyword">new</span> BIAPIQueryParser(tokens);
BIAPIQueryParser.QueryContext tree = parser.query();

<span class="comment">// Build Morphia filter</span>
QueryToFilterListener listener = <span class="keyword">new</span> QueryToFilterListener(vars, <span class="keyword">new</span> StringSubstitutor(vars), <span class="comment">/* modelClass */</span> <span class="predefined-constant">null</span>);
ParseTreeWalker.DEFAULT.walk(listener, tree);
<span class="predefined-type">Filter</span> morphiaFilter = listener.getFilter();

<span class="comment">// Use with Morphia query (example)</span>
<span class="comment">// datastore.find(MyEntity.class).filter(morphiaFilter).iterator().toList();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few query examples (taken from testQueryStrings.txt):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Equality: field:"quotedString"</p>
</li>
<li>
<p>Comparisons: field:&gt;##12.56, field:&#8656;#123</p>
</li>
<li>
<p>IN/NIN: field:^[value1,value2], field:!^[value1,value2]</p>
</li>
<li>
<p>Exists/Null: field:~, field:null</p>
</li>
<li>
<p>elemMatch: arrayField:{(subField:&lt;#12)||(subField:&gt;#15)}</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_in_memory_jsonnode_querytopredicatejsonlistener">In-memory (JsonNode): QueryToPredicateJsonListener</h6>
<div class="paragraph">
<p>Use this when you need to evaluate queries in memory without reflection on POJOs. This implementation compiles a query into a java.util.function.Predicate over a Jackson JsonNode. It is Quarkus/GraalVM friendly, useful for:
- Unit tests where you want to validate query behavior without a database
- Post-filtering or pre-filtering of already-fetched data
- Evaluating access rules or business logic against transient objects</p>
</div>
<div class="paragraph">
<p>Key characteristics:
- Output type: Predicate&lt;JsonNode&gt;
- Execution: in-memory
- No runtime reflection: operates on JsonNode
- Semantics and variable expansion match the Morphia listener</p>
</div>
<div class="paragraph">
<p>Convenience helpers exist in QueryPredicates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.query.QueryPredicates</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.JsonNode</span>;
<span class="keyword">import</span> <span class="include">java.util.function.Predicate</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="predefined-type">String</span> query = <span class="string"><span class="delimiter">&quot;</span><span class="content">(status:Assigned||status:Pending)&amp;&amp;displayName:*Route*</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">Predicate</span>&lt;JsonNode&gt; p = QueryPredicates.compilePredicate(query, <span class="predefined-type">Map</span>.of(), <span class="predefined-type">Map</span>.of());

<span class="comment">// Example data as a POJO or Map -&gt; convert to JsonNode</span>
record Ticket(<span class="predefined-type">String</span> status, <span class="predefined-type">String</span> displayName) {}
Ticket ticket = <span class="keyword">new</span> Ticket(<span class="string"><span class="delimiter">&quot;</span><span class="content">Assigned</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Route Exception in Route:To[http://com.xxx/update]</span><span class="delimiter">&quot;</span></span>);
JsonNode node = QueryPredicates.toJsonNode(ticket);

<span class="type">boolean</span> include = p.test(node); <span class="comment">// true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional examples</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Equality and comparisons</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>var vars = Map.&lt;String,String&gt;of();
var objVars = Map.&lt;String,Object&gt;of();
Predicate&lt;JsonNode&gt; eq = QueryPredicates.compilePredicate("quantity:#42", vars, objVars);
Predicate&lt;JsonNode&gt; gt = QueryPredicates.compilePredicate("price:&gt;##19.99", vars, objVars);

JsonNode product = QueryPredicates.toJsonNode(Map.of("quantity", 42, "price", 25.00));
assert eq.test(product);
assert gt.test(product);</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>IN / NIN with variable expansion</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>var vars = Map.of("principalId", "66d1f1ab452b94674bbd934a");
Predicate&lt;JsonNode&gt; in = QueryPredicates.compilePredicate("ownerId:^[${principalId},value2]", vars, Map.of());
JsonNode doc = QueryPredicates.toJsonNode(Map.of("ownerId", "66d1f1ab452b94674bbd934a"));
assert in.test(doc);</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>elemMatch over arrays of objects</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>String q = "items:{(sku:abc||qty:&gt;#10)&amp;&amp;price:&lt;=##9.99}";
Predicate&lt;JsonNode&gt; em = QueryPredicates.compilePredicate(q, Map.of(), Map.of());
JsonNode order = QueryPredicates.toJsonNode(Map.of(
  "items", java.util.List.of(
     Map.of("sku","abc","qty", 5,  "price", 9.99),
     Map.of("sku","xyz","qty", 12, "price", 8.50)
)));
// Matches: first item by sku OR second item by qty with price cap
assert em.test(order);</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Regex with wildcards</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Predicate&lt;JsonNode&gt; rx = QueryPredicates.compilePredicate("displayName:*Route*", Map.of(), Map.of());
JsonNode ticket = QueryPredicates.toJsonNode(Map.of("displayName", "Route Exception in Route:To[...]"));
assert rx.test(ticket);</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_choosing_the_right_listener">Choosing the right listener</h6>
<div class="ulist">
<ul>
<li>
<p>Use Morphia (QueryToFilterListener) when:</p>
<div class="ulist">
<ul>
<li>
<p>You are filtering MongoDB collections and want the DB to do the work (indexing, pagination, scalability)</p>
</li>
<li>
<p>You need server-side performance and minimal memory footprint</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use In-memory (QueryToPredicateJsonListener) when:</p>
<div class="ulist">
<ul>
<li>
<p>You run in Quarkus native image and want to avoid reflection on POJOs</p>
</li>
<li>
<p>You are writing unit tests or applying rules to transient/aggregated data</p>
</li>
<li>
<p>You need to evaluate a query over already materialized objects without another database round-trip</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both listeners aim to maintain parity with the grammar. If you observe mismatches, please file an issue with the query string, the evaluated data sample, and the expected vs actual results.</p>
</div>
</div>
<div class="sect5">
<h6 id="_query_field_validation">Query Field Validation</h6>
<div class="paragraph">
<p>Quantum provides validation capabilities to detect references to non-existent fields before query execution, preventing runtime errors and providing early feedback.</p>
</div>
<div class="sect6">
<h7 id="_validating_listeners">Validating Listeners</h7>
<div class="paragraph">
<p>Two validating listener implementations extend the standard listeners:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ValidatingQueryToFilterListener: extends QueryToFilterListener for Morphia queries</p>
</li>
<li>
<p>ValidatingQueryToPredicateJsonListener: extends QueryToPredicateJsonListener for in-memory predicates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both validate field references against a model class during parsing and accumulate errors.</p>
</div>
<div class="paragraph">
<p>Example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.ValidatingQueryToFilterListener</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.grammar</span>.*;
<span class="keyword">import</span> <span class="include">org.antlr.v4.runtime</span>.*;
<span class="keyword">import</span> <span class="include">org.antlr.v4.runtime.tree.ParseTreeWalker</span>;

<span class="predefined-type">String</span> query = <span class="string"><span class="delimiter">&quot;</span><span class="content">name:John AND invalidField:test</span><span class="delimiter">&quot;</span></span>;

BIAPIQueryLexer lexer = <span class="keyword">new</span> BIAPIQueryLexer(CharStreams.fromString(query));
CommonTokenStream tokens = <span class="keyword">new</span> CommonTokenStream(lexer);
BIAPIQueryParser parser = <span class="keyword">new</span> BIAPIQueryParser(tokens);

ValidatingQueryToFilterListener listener =
    <span class="keyword">new</span> ValidatingQueryToFilterListener(UserProfile.class);
ParseTreeWalker.DEFAULT.walk(listener, parser.query());

<span class="keyword">if</span> (listener.hasValidationErrors()) {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; errors = listener.getValidationErrors();
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid query: </span><span class="delimiter">&quot;</span></span> + errors);
}

<span class="predefined-type">Filter</span> filter = listener.getFilter();</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_validqueryfilter_annotation">@ValidQueryFilter Annotation</h7>
<div class="paragraph">
<p>For automatic validation in DTOs and models, use the <code>@ValidQueryFilter</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.ValidQueryFilter</span>;
<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotNull</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SearchRequest</span> {
    <span class="annotation">@NotNull</span>
    <span class="annotation">@ValidQueryFilter</span>(modelClass = UserProfile.class)
    <span class="directive">private</span> <span class="predefined-type">String</span> filterQuery;

    <span class="comment">// getters/setters</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation integrates with Jakarta Bean Validation and is automatically enforced by the ValidationInterceptor during entity persistence.</p>
</div>
<div class="paragraph">
<p>REST endpoint example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserResource</span> {

    <span class="annotation">@GET</span>
    <span class="directive">public</span> Response searchUsers(<span class="annotation">@Valid</span> <span class="annotation">@BeanParam</span> SearchParams params) {
        <span class="comment">// filterQuery is validated before this method executes</span>
        <span class="keyword">return</span> Response.ok(userService.search(params.getFilterQuery())).build();
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">SearchParams</span> {
    <span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">filter</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@ValidQueryFilter</span>(modelClass = UserProfile.class)
    <span class="directive">private</span> <span class="predefined-type">String</span> filterQuery;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Persisted filter example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SavedSearch</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@ValidQueryFilter</span>(modelClass = Order.class)
    <span class="directive">private</span> <span class="predefined-type">String</span> filterExpression;

    <span class="comment">// When saved, ValidationInterceptor validates the filter</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_queryfieldvalidator_utility">QueryFieldValidator Utility</h7>
<div class="paragraph">
<p>For programmatic validation without listeners:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.query.QueryFieldValidator</span>;

<span class="comment">// Validate against a model class</span>
QueryFieldValidator validator = QueryFieldValidator.forModelClass(UserProfile.class);

<span class="type">boolean</span> isValid = validator.validateField(<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// true</span>
<span class="type">boolean</span> isInvalid = validator.validateField(<span class="string"><span class="delimiter">&quot;</span><span class="content">nonExistentField</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// false</span>

<span class="keyword">if</span> (validator.hasErrors()) {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; errors = validator.getErrors();
    <span class="comment">// Handle validation errors</span>
}

<span class="comment">// Validate against aggregation pipeline schema</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Class</span>&lt;?&gt;&gt; schema = <span class="predefined-type">Map</span>.of(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">totalAmount</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Double</span>.class,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">orderCount</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">customerName</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class
);

QueryFieldValidator aggValidator = QueryFieldValidator.forAggregationSchema(schema);
aggValidator.validateField(<span class="string"><span class="delimiter">&quot;</span><span class="content">totalAmount</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// true</span>
aggValidator.validateField(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalidField</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// false</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_benefits">Benefits</h7>
<div class="ulist">
<ul>
<li>
<p>Early error detection: catch field reference errors before query execution</p>
</li>
<li>
<p>Better error messages: specific feedback about which fields are invalid</p>
</li>
<li>
<p>Development safety: prevent typos and refactoring issues</p>
</li>
<li>
<p>API validation: validate user-provided query strings in REST endpoints</p>
</li>
<li>
<p>Data integrity: prevent saving invalid filter expressions to the database</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ontology-query-language">Expressing Ontology Constraints in Queries (optional)</h5>
<div class="paragraph">
<p>The BIAPI query language primarily targets fields on documents. When using the ontology modules, there are two ways to incorporate ontology relationships into queries:</p>
</div>
<div class="paragraph">
<p>Option A: Variable from an AccessListResolver</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A resolver computes the set of IDs using EdgeDao (e.g., orders related by placedInOrg to the caller’s org).</p>
</li>
<li>
<p>Use an IN clause over id in your filter string:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># idsByPlacedInOrg is published by an AccessListResolver
id:^${idsByPlacedInOrg}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_ontology_operators_hasedge_and_hasincomingedge">Ontology operators: hasEdge and hasIncomingEdge</h5>
<div class="paragraph">
<p>When the ontology module is enabled and edges are materialized, you can constrain results by semantic relationships using <code>hasEdge</code> and <code>hasIncomingEdge</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Syntax: <code>hasEdge(predicate, dst)</code></p>
</li>
<li>
<p>Finds entities (sources) that have an edge with the specified <code>predicate</code> pointing TO the <code>dst</code>.</p>
</li>
<li>
<p>Syntax: <code>hasIncomingEdge(predicate, src)</code></p>
</li>
<li>
<p>Finds entities (targets) that have an edge with the specified <code>predicate</code> coming FROM the <code>src</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Arguments:
- <code>predicate</code> can be an unquoted string, a quoted string, or a <code>${var}</code> placeholder.
- <code>dst</code> / <code>src</code> can be a literal id, a variable like <code>${principalId}</code>, an ObjectId, or a reference literal <code>@@&#8230;&#8203;</code>.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Orders placed in a specific organization (find sources)
hasEdge(&quot;placedInOrg&quot;, ${orgRefName})

# Tickets routed to a region by id
hasEdge(routedToRegion, @@507f1f77bcf86cd799439011)

# Find locations that an associate can access (find targets)
# assumes an edge exists: Associate --canAccessLocation--&gt; Location
hasIncomingEdge(canAccessLocation, ${principalId})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>These operators narrow the result set based on the existence of edges in the ontology edges collection.</p>
</li>
<li>
<p>They compose with other filters using <code>&amp;&amp;</code>, <code>||</code>, and <code>!!</code>.</p>
</li>
<li>
<p>Tenancy: edge resolution is always scoped by tenant/realm.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_root_projection_recap_fields">Root projection recap: fields:[+…,-…]</h5>
<div class="paragraph">
<p>To include or exclude fields from the root documents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Syntax: <code>fields:[+f1,+f2,-f3]</code></p>
</li>
<li>
<p>Include mode: if any <code>+</code> is present, only the listed fields are included (with explicit <code>-</code> carving out exceptions).</p>
</li>
<li>
<p>Exclude mode: if only <code>-</code> entries exist, all fields are included except those.</p>
</li>
<li>
<p>Default <code>_id</code>: preserved unless explicitly specified (<code>+_id</code>/<code>-_id</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Include a few fields from the root and drop one
fields:[+_id,+total,-internalNotes]

# Combine with expansion (planner chooses aggregation mode)
expand(customer) &amp;&amp; fields:[+_id,+customer,+total]</code></pre>
</div>
</div>
<div class="paragraph">
<p>For per-expansion projections and advanced traversal filters, see <a href="query-expansion.html">Query Expansion</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hands_on_relationships_and_ontology_aware_queries">19.2. Hands-on: Relationships and Ontology-aware queries</h3>
<div class="paragraph">
<p>In addition to basic filters, the query layer supports relationship hydration and ontology-aware constraints.
These features are MongoDB-first in this release and remain backward compatible:
- If you don&#8217;t use them, behavior is unchanged.
- When you do, the planner may choose a Mongo aggregation under the hood.</p>
</div>
<div class="sect3">
<h4 id="_hydrate_related_data_with_expandpath">19.2.1. Hydrate related data with expand(path)</h4>
<div class="paragraph">
<p>Use expand(path) to materialize related entities referenced by your root documents. Paths are dotted and can include array wildcards [*].</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Single reference
expand(customer)

# Array of references in an items array
expand(items[*].product)

# Nested arrays (bounded by the first non-reference boundary)
expand(patient.visits[*].diagnoses[*])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Combine with normal filters and projection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>q = &quot;realm:acme &amp;&amp; expand(customer, fields:[+name,+tier]) &amp;&amp; fields:[+_id,+total,+customer.name]&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Depth on mixed arrays/objects stops at the first non-reference boundary.
- Unknown projection paths are hard errors.</p>
</div>
<div class="paragraph">
<p>See: <a href="../user-guide/query-expansion.html">Query Expansion</a> for more patterns and semantics.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ontology_constrain_by_relationships_with_hasedgepredicate_dst">19.2.2. Ontology: constrain by relationships with hasEdge(predicate, dst)</h4>
<div class="paragraph">
<p>When the ontology module is enabled and edges are materialized, you can filter by semantic relationships using hasEdge.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Orders placed in a specific organization
hasEdge(&quot;placedInOrg&quot;, ${orgRefName})

# Tickets routed to a region by id
hasEdge(&quot;routedToRegion&quot;, 507f1f77bcf86cd799439011)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tenancy is always applied when resolving edges. See:
- <a href="../user-guide/permissions.html#rule-hasedge">Permissions: hasEdge rule</a>
- <a href="../user-guide/query-language.html#ontology-query-language">Ontology in queries</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_inspect_the_planner_with_querygateway">19.2.3. Inspect the planner with QueryGateway</h4>
<div class="paragraph">
<p>You can inspect how a query will execute (FILTER vs AGGREGATION) using the new QueryGateway facade.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.query.QueryGateway</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.query.QueryGatewayImpl</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.planner.PlannerResult</span>;

QueryGateway gateway = <span class="keyword">new</span> QueryGatewayImpl();
PlannerResult pr = gateway.plan(<span class="string"><span class="delimiter">&quot;</span><span class="content">expand(customer) &amp;&amp; status:active</span><span class="delimiter">&quot;</span></span>, Order.class);
<span class="comment">// pr.getMode() == PlannerResult.Mode.AGGREGATION</span>
<span class="comment">// pr.getExpandPaths() == [&quot;customer&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For lower-level control, use MorphiaUtils.convertToPlannedQuery(&#8230;&#8203;). See: <a href="../user-guide/planner-and-query-gateway.html">Planner and QueryGateway</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-security">20. 8. Authentication, permissions, and annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Securely authenticating users and enforcing fine-grained authorization.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Multi-tenant apps must ensure tenant isolation and principle-of-least-privilege.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: JWT integration, permissions model, and security annotations.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Protect your APIs and add role/permission checks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auth">21. Authentication and Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum integrates with Quarkus security while providing a pluggable approach to authentication. The repository includes a JWT provider module to get started quickly and an extension surface to replace or complement it.</p>
</div>
<div class="sect2">
<h3 id="_jwt_provider_2">21.1. JWT Provider</h3>
<div class="ulist">
<ul>
<li>
<p>Module: quantum-jwt-provider</p>
</li>
<li>
<p>Purpose: Validate JWTs on incoming requests, populate the security principal, and surface tenant/org/user claims that feed DomainContext.</p>
</li>
<li>
<p>Configuration: Standard Quarkus/MicroProfile JWT properties plus custom claim mappings as needed for DataDomain.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_pluggable_authentication_2">21.2. Pluggable Authentication</h3>
<div class="paragraph">
<p>You can introduce alternative authentication mechanisms (e.g., API keys, SAML/OIDC front-channel tokens exchanged for back-end JWTs, HMAC signatures) by providing CDI beans that integrate with the security layer and emit the same normalized context consumed by DomainContext/RuleContext.</p>
</div>
<div class="paragraph">
<p>Typical steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement a request filter or identity provider that validates the token/credential.</p>
</li>
<li>
<p>Map identity and tenant claims into a principal model (tenantId, orgRefName, userId, roles).</p>
</li>
<li>
<p>Ensure BaseResource (and other entry points) can derive DomainContext from that principal.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_creating_an_auth_plugin_using_the_custom_jwt_provider_as_a_reference_2">21.3. Creating an Auth Plugin (using the Custom JWT provider as a reference)</h3>
<div class="paragraph">
<p>An auth plugin is typically a CDI bean that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extends BaseAuthProvider to inherit user-management helpers and persistence utilities.</p>
</li>
<li>
<p>Implements AuthProvider to integrate with request-time authentication flows.</p>
</li>
<li>
<p>Implements UserManagement to expose CRUD-style operations for users, passwords, and roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A concrete provider should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Be annotated as a CDI bean (e.g., @ApplicationScoped).</p>
</li>
<li>
<p>Provide a stable getName() identifier (e.g., "custom", "oidc", "apikey").</p>
</li>
<li>
<p>Use config properties for secrets, issuers, token durations, and any external identity provider details.</p>
</li>
<li>
<p>Build a Quarkus SecurityIdentity with the authenticated principal and roles.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authprovider_interface_what_a_provider_must_implement_2">21.4. AuthProvider interface (what a provider must implement)</h3>
<div class="paragraph">
<p>Core methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityIdentity validateAccessToken(String token)</p>
<div class="ulist">
<ul>
<li>
<p>Parse and validate the incoming credential (JWT, API key, signature).</p>
</li>
<li>
<p>Return a SecurityIdentity with principal name and roles. Throw a security exception for invalid tokens.</p>
</li>
</ul>
</div>
</li>
<li>
<p>String getName()</p>
<div class="ulist">
<ul>
<li>
<p>A short identifier for the provider. Persisted alongside credentials and used in logs/metrics.</p>
</li>
</ul>
</div>
</li>
<li>
<p>LoginResponse login(String userId, String password)</p>
<div class="ulist">
<ul>
<li>
<p>Credential-based login. Return a structured response:</p>
</li>
<li>
<p>positiveResponse: includes SecurityIdentity, roles, accessToken, refreshToken, expirationTime, and realm/mongodbUrl if applicable.</p>
</li>
<li>
<p>negativeResponse: includes error codes/reason/message for clients to act on (e.g., password change required).</p>
</li>
</ul>
</div>
</li>
<li>
<p>LoginResponse refreshTokens(String refreshToken)</p>
<div class="ulist">
<ul>
<li>
<p>Validate the refresh token, mint a new access token (and optionally a new refresh token), and return a positive response.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login flow should check force-change-password or equivalent flags and return a negative response when user interaction is required before issuing tokens.</p>
</li>
<li>
<p>validateAccessToken should only accept valid, non-expired tokens and construct SecurityIdentity consistently with role mappings used across the platform.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_usermanagement_interface_operations_your_plugin_must_support_2">21.5. UserManagement interface (operations your plugin must support)</h3>
<div class="paragraph">
<p>Typical responsibilities include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User lifecycle</p>
<div class="ulist">
<ul>
<li>
<p>String createUser(String userId, String password, Set&lt;String&gt; roles, DomainContext domainContext, [optional] DataDomain)</p>
</li>
<li>
<p>void changePassword(String userId, String oldPassword, String newPassword, Boolean forceChangePassword)</p>
</li>
<li>
<p>boolean removeUserWithUserId(String userId)</p>
</li>
<li>
<p>boolean removeUserWithSubject(String subject)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Role management</p>
<div class="ulist">
<ul>
<li>
<p>void assignRolesForUserId(String userId, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void assignRolesForSubject(String subject, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void removeRolesForUserId(String userId, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>void removeRolesForSubject(String subject, Set&lt;String&gt; roles)</p>
</li>
<li>
<p>Set&lt;String&gt; getUserRolesForUserId(String userId)</p>
</li>
<li>
<p>Set&lt;String&gt; getUserRolesForSubject(String subject)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Lookups and existence checks</p>
<div class="ulist">
<ul>
<li>
<p>Optional&lt;String&gt; getSubjectForUserId(String userId)</p>
</li>
<li>
<p>Optional&lt;String&gt; getUserIdForSubject(String subject)</p>
</li>
<li>
<p>boolean userIdExists(String userId)</p>
</li>
<li>
<p>boolean subjectExists(String subject)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Return values and exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Throw SecurityException or domain-specific exceptions for invalid states (duplicate users, bad password, unsupported hashing).</p>
</li>
<li>
<p>Return Optional for lookups that may not find a result.</p>
</li>
<li>
<p>For removals, return boolean to communicate whether a record was deleted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_leveraging_baseauthprovider_in_your_plugin_2">21.6. Leveraging BaseAuthProvider in your plugin</h3>
<div class="paragraph">
<p>When you extend BaseAuthProvider, you inherit ready-to-use capabilities that reduce boilerplate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Impersonation controls</p>
<div class="ulist">
<ul>
<li>
<p>enableImpersonationWithUserId / enableImpersonationWithSubject</p>
</li>
<li>
<p>disableImpersonationWithUserId / disableImpersonationWithSubject</p>
</li>
<li>
<p>These set or clear an impersonation filter script and realm regex that downstream services can honor to act on behalf of another identity under controlled scope.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Realm override helpers</p>
<div class="ulist">
<ul>
<li>
<p>enableRealmOverrideWithUserId / enableRealmOverrideWithSubject</p>
</li>
<li>
<p>disableRealmOverrideWithUserId / disableRealmOverrideWithSubject</p>
</li>
<li>
<p>Useful for multi-realm/tenant scenarios, enabling scoped cross-realm behavior.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Persistence utilities</p>
<div class="ulist">
<ul>
<li>
<p>Built-in use of the credential repository to save, update, and delete credentials.</p>
</li>
<li>
<p>Consistent validation of inputs (non-null checks, non-blank checks).</p>
</li>
<li>
<p>Hashing algorithm guardrails to ensure only supported algorithms are used.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Best practices when deriving:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always set the auth provider name in stored credentials so records can be traced to the correct provider.</p>
</li>
<li>
<p>Reuse the role merge/remove patterns to avoid accidental role loss.</p>
</li>
<li>
<p>Prefer emitting precise exceptions (e.g., NotFound for missing users, SecurityException for access violations).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_your_own_provider_2">21.7. Implementing your own provider</h3>
<div class="paragraph">
<p>Checklist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Class design</p>
<div class="ulist">
<ul>
<li>
<p>@ApplicationScoped bean</p>
</li>
<li>
<p>extends BaseAuthProvider</p>
</li>
<li>
<p>implements AuthProvider and UserManagement</p>
</li>
<li>
<p>return a stable getName()</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configuration</p>
<div class="ulist">
<ul>
<li>
<p>Externalize secrets (signing keys), issuers, token durations, and realm details via MicroProfile Config.</p>
</li>
</ul>
</div>
</li>
<li>
<p>SecurityIdentity</p>
<div class="ulist">
<ul>
<li>
<p>Consistently build identities with principal and roles; include useful attributes for auditing/telemetry.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tokens/credentials</p>
<div class="ulist">
<ul>
<li>
<p>For JWT-like tokens, implement robust parsing, signature verification, expiration checks, and claim validation.</p>
</li>
<li>
<p>For non-JWT credentials (API keys, HMAC), ensure replay protection and scope binding.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Responses and errors</p>
<div class="ulist">
<ul>
<li>
<p>Use structured LoginResponse for both success and error paths.</p>
</li>
<li>
<p>Prefer idempotent user/role operations; validate inputs and surface actionable messages.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_credentialuseridpassword_model_and_domaincontext_2">21.8. CredentialUserIdPassword model and DomainContext</h3>
<div class="paragraph">
<p>This section explains how user credentials are represented, how those records tie to tenancy and realms, and how the server chooses the database (“realm”) for REST calls.</p>
</div>
<div class="paragraph">
<p>What the credential model represents</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">userId</dt>
<dd>
<p>The human-friendly login handle that users type. Must be unique within the applicable tenancy/realm scope.</p>
</dd>
<dt class="hdlist1">subject</dt>
<dd>
<p>A stable, system-generated identifier for the principal. Tokens and internal references favor subject over userId because subjects do not change.</p>
</dd>
<dt class="hdlist1">description, emailOfResponsibleParty</dt>
<dd>
<p>Optional metadata to describe the credential and provide an owner contact.</p>
</dd>
<dt class="hdlist1">domainContext</dt>
<dd>
<p>The tenancy and organization placement of the principal. It contains:</p>
<div class="ulist">
<ul>
<li>
<p>tenantId: Logical tenant partition.</p>
</li>
<li>
<p>orgRefName: Organization/business unit within the tenant.</p>
</li>
<li>
<p>accountId: Account or billing identifier.</p>
</li>
<li>
<p>defaultRealm: The default database/realm used for this identity’s operations.</p>
</li>
<li>
<p>dataSegment: Optional partitioning segment for advanced sharding or data slicing.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">roles</dt>
<dd>
<p>The set of authorities granted (e.g., USER, ADMIN). These become groups/roles on the SecurityIdentity.</p>
</dd>
<dt class="hdlist1">issuer</dt>
<dd>
<p>An identifier for who issued the credential or tokens (useful for auditing and multi-provider setups).</p>
</dd>
<dt class="hdlist1">passwordHash, hashingAlgorithm</dt>
<dd>
<p>The stored password hash and declared algorithm. Not exposed over REST. Providers verify passwords against this.</p>
</dd>
<dt class="hdlist1">forceChangePassword</dt>
<dd>
<p>Flag that forces a password reset on next login; the login flow returns a structured negative response instead of tokens.</p>
</dd>
<dt class="hdlist1">lastUpdate</dt>
<dd>
<p>Timestamp for auditing and token invalidation strategies.</p>
</dd>
<dt class="hdlist1">area2RealmOverrides</dt>
<dd>
<p>Optional map to route specific functional areas to different realms than the default (e.g., “Reporting” → analytics-realm).</p>
</dd>
<dt class="hdlist1">realmRegEx</dt>
<dd>
<p>Optional regex to limit or override which realms this identity may act in; also used by impersonation/override flows.</p>
</dd>
<dt class="hdlist1">impersonateFilterScript</dt>
<dd>
<p>Optional script indicating the filter/scope applied during impersonation so actions are constrained.</p>
</dd>
<dt class="hdlist1">authProviderName</dt>
<dd>
<p>The name of the provider that owns this credential (e.g., “custom”, “oidc”), enabling multi-provider operations and audits.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>How DomainContext selects the realm for REST calls</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For each authenticated request, the server derives or retrieves a DomainContext associated with the principal.</p>
</li>
<li>
<p>The DomainContext.defaultRealm indicates which backing MongoDB database (“realm”) should be used by repositories for that request.</p>
</li>
<li>
<p>If realm override features are enabled (e.g., through provider helpers or per-credential overrides), the system may route certain functional areas to alternate realms using area2RealmOverrides or validated by realmRegEx.</p>
</li>
<li>
<p>The remainder of DomainContext (tenantId, orgRefName, accountId, dataSegment) is applied as scope constraints through permission rules and repository filters so reads and writes are automatically restricted to the correct tenant/org segment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Typical flow</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Login</p>
<div class="ulist">
<ul>
<li>
<p>A user authenticates with userId/password (or other mechanism).</p>
</li>
<li>
<p>On success, a token is returned alongside role information; the principal is associated with a DomainContext that includes the defaultRealm.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Subsequent REST calls</p>
<div class="ulist">
<ul>
<li>
<p>The token is validated; the server reconstructs SecurityIdentity and DomainContext.</p>
</li>
<li>
<p>Repositories choose the datastore for defaultRealm and enforce tenant/org filters using the DomainContext values.</p>
</li>
<li>
<p>If the request targets a functional area with a defined override, the operation may route to a different realm for that area alone.</p>
</li>
</ul>
</div>
</li>
<li>
<p>UI implications</p>
<div class="ulist">
<ul>
<li>
<p>The client does not need to know which realm is selected; it simply calls the API. The server ensures the correct database is used based on DomainContext and any configured overrides.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Best practices</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep userId immutable once established; use subject for internal joins and token subjects.</p>
</li>
<li>
<p>Always attach the correct DomainContext when creating users to avoid cross-tenant leakage.</p>
</li>
<li>
<p>Use realm overrides deliberately for well-isolated areas (e.g., analytics, archiving) and document them for operators.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_quarkus_oidc_out_of_the_box_and_integrating_with_common_idps_2">21.9. Quarkus OIDC out-of-the-box and integrating with common IdPs</h3>
<div class="paragraph">
<p>Quarkus ships with first-class OpenID Connect (OIDC) support, enabling both service-to-service and browser-based logins.</p>
</div>
<div class="paragraph">
<p>What the Quarkus OIDC extension provides</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OIDC client and server-side adapters:</p>
<div class="ulist">
<ul>
<li>
<p>Authorization Code flow with PKCE for browser sign-in.</p>
</li>
<li>
<p>Bearer token authentication for APIs (validating access tokens on incoming requests).</p>
</li>
<li>
<p>Token propagation for downstream calls (forwarding or exchanging tokens).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Token verification and claim mapping:</p>
<div class="ulist">
<ul>
<li>
<p>Validates issuer, audience, signature, expiration, and scopes.</p>
</li>
<li>
<p>Maps standard claims (sub, email, groups/roles) into the security identity.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multi-tenancy and configuration:</p>
<div class="ulist">
<ul>
<li>
<p>Supports multiple OIDC tenants via configuration, each with its own issuer, client id/secret, and flows.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Logout and session support:</p>
<div class="ulist">
<ul>
<li>
<p>Front-channel and back-channel logout hooks depending on provider capabilities.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Integrating with common providers</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Works with providers like Keycloak, Auth0, Okta, Azure AD, Cognito, and enterprise IdPs exposing OIDC.</p>
</li>
<li>
<p>Configure the issuer URL and client credentials. Quarkus discovers endpoints via the provider’s .well-known/openid-configuration.</p>
</li>
<li>
<p>For roles/permissions, map provider groups/roles claims to your platform roles in the identity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OIDC vs OAuth vs OpenID (terminology and evolution)</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OAuth 2.0</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Authorization framework for delegated access (scopes), not authentication. Defines flows to obtain access tokens for APIs.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">OpenID (OpenID 1.x/2.0)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Older federated identity protocol that preceded OIDC. It has been superseded by OpenID Connect.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">OpenID Connect (OIDC)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An identity layer on top of OAuth 2.0. Adds standardized authentication, user info endpoints, ID tokens (JWT) with subject and profile claims, and discovery metadata.</p>
</li>
<li>
<p>In practice, OIDC is the modern standard for SSO and user authentication; OAuth remains the authorization substrate underneath.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Summary</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>OpenID → historical, replaced by OIDC.</p>
</li>
<li>
<p>OAuth 2.0 → authorization framework.</p>
</li>
<li>
<p>OIDC → authentication (identity) layer built on OAuth 2.0.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>OIDC and SAML in relation to SSO
 SAML (Security Assertion Markup Language)::</p>
</div>
<div class="ulist">
<ul>
<li>
<p>XML-based federation protocol widely used in enterprises for browser SSO.</p>
</li>
<li>
<p>Uses signed XML assertions transported through browser redirects/posts.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">OIDC</dt>
</dl>
</div>
</li>
<li>
<p>JSON/REST-oriented, uses JWTs, and is well-suited for modern SPAs and APIs.</p>
</li>
<li>
<p>Relationship:</p>
</li>
<li>
<p>Both enable SSO and federation across identity providers and service providers.</p>
</li>
<li>
<p>Many enterprise IdPs support both; OIDC is generally simpler for APIs and modern web stacks, while SAML is entrenched in legacy/enterprise SSO.</p>
</li>
<li>
<p>Bridging:</p>
</li>
<li>
<p>Gateways or identity brokers can translate SAML assertions to OIDC tokens and vice versa, allowing gradual migration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Common customer IdP models and OIDC integration patterns</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Centralized IdP (single-tenant):</p>
<div class="ulist">
<ul>
<li>
<p>One organization-wide IdP issues tokens for all users.</p>
</li>
<li>
<p>Configure a single OIDC tenant in Quarkus; map groups/roles to application roles.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Multi-tenant SaaS with per-tenant IdP:</p>
<div class="ulist">
<ul>
<li>
<p>Each customer brings their own IdP (BYOID).</p>
</li>
<li>
<p>Configure Quarkus OIDC multitenancy with per-tenant issuer discovery and client credentials.</p>
</li>
<li>
<p>Tenant selection can be based on domain, request header, or path; the selected OIDC tenant performs login and token validation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Brokered identity:</p>
<div class="ulist">
<ul>
<li>
<p>Use a broker (e.g., a central identity layer) that federates to multiple upstream IdPs (OIDC, SAML).</p>
</li>
<li>
<p>Quarkus integrates with the broker as a single OIDC client; the broker handles IdP routing and protocol translation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hybrid API and web flows:</p>
<div class="ulist">
<ul>
<li>
<p>Browser apps use Authorization Code flow with sessions; APIs use bearer token authentication.</p>
</li>
<li>
<p>Quarkus OIDC extension can handle both in the same application when properly configured.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Best practices</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefer OIDC for new integrations; use SAML through a broker if enterprise constraints require it.</p>
</li>
<li>
<p>Normalize roles/claims server-side so downstream authorization (RuleContext, repositories) sees consistent group names regardless of IdP.</p>
</li>
<li>
<p>Use token exchange or client credentials for service-to-service calls; do not reuse end-user tokens where not appropriate.</p>
</li>
<li>
<p>For multi-tenant OIDC, secure tenant resolution logic and validate issuer/tenant binding to prevent mix-ups.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authorization_via_rulecontext_2">21.10. Authorization via RuleContext</h3>
<div class="paragraph">
<p>Authentication establishes identity; RuleContext enforces what the identity can do. For each action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE), RuleContext can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow or deny the action</p>
</li>
<li>
<p>Contribute additional filters (e.g., org scoping, functional-area specific sharing)</p>
</li>
<li>
<p>Adjust UIActionList to reflect permitted next steps</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This division of responsibilities keeps providers focused on identity while policies remain centralized in RuleContext.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="permissions">22. Permissions: Rule Bases, SecurityURIHeader, and SecurityURIBody</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section explains how Quantum evaluates permissions for REST requests using rule bases that match on a SecurityURI composed of a header and a body. The header includes identity, area, functionalDomain, and action. The body includes realm, accountNumber, tenantId, dataSegment, ownerId, and resourceId. It also covers how identities and roles (as found on userProfile or credentialUserIdPassword) are matched, how priority works, and how multiple matching rule bases are evaluated.</p>
</div>
<div class="sect2">
<h3 id="_introduction_layered_enforcement_overview">22.1. Introduction: Layered Enforcement Overview</h3>
<div class="paragraph">
<p>Quantum evaluates "can this identity do X?" through three complementary layers. Understanding them in order helps you pick the right tool for the job and combine them safely:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>REST API annotations (top layer, code-level)</p>
<div class="ulist">
<ul>
<li>
<p>What: JAX-RS/Jakarta Security annotations on resource methods, for example, <code>@RolesAllowed("ADMIN")</code>, <code>@PermitAll</code>, <code>@DenyAll</code>, <code>@Authenticated</code>.</p>
</li>
<li>
<p>Purpose: Coarse-grained, immediate gates right at the endpoint. Ideal for baseline protections (for example, only ADMIN may call <code>/admin/**</code>) and for non-dynamic constraints that rarely change.</p>
</li>
<li>
<p>Pros: Simple, fast, visible in code reviews.</p>
</li>
<li>
<p>Cons: Hard-coded; changing access requires a code change, build, and deploy. No data-aware scoping (for example, cannot express tenant/domain filters).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Feature flags (exposure and variants)</p>
<div class="ulist">
<ul>
<li>
<p>What: Turn capabilities on/off per environment or cohort and select variants (A/B, multivariate). See "Feature Flags, Variants, and Target Rules" below.</p>
</li>
<li>
<p>Purpose: Control who even sees or can reach a capability during rollout (by tenant, role, geography, plan), independently of authorization. Flags answer "is the feature ON and which variant?"; they do not by themselves prove the caller is authorized.</p>
</li>
<li>
<p>Pros: Reversible, environment-aware, safe rollout and experimentation.</p>
</li>
<li>
<p>Cons: Not a substitute for authorization; must be paired with roles/permission rules for enforcement.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Permission Rules with SecurityURI (fine-grained, dynamic)</p>
<div class="ulist">
<ul>
<li>
<p>What: Declarative rule bases authored against a SecurityURI composed of header (identity, area, functionalDomain, action) and body (realm, accountNumber, tenantId, dataSegment, ownerId, resourceId). Rules decide ALLOW or DENY and may use an optional postconditionScript for additional checks. See sections "Key Concepts", "Matching Algorithm", and examples below.</p>
</li>
<li>
<p>Purpose: Express least-privilege, data-aware policies that evolve without code changes (data-driven authoring).</p>
</li>
<li>
<p>Pros: Dynamic, auditable, supports role-based matching and simple attribute scoping via the SecurityURI body.</p>
</li>
<li>
<p>Cons: Requires governance of rulebases and careful priority management.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>How roles, Functional Areas, and Functional Domains fit in</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roles: Used by both layers (1) and (3). Annotations directly reference roles. In the rule engine, roles are evaluated by treating each role as an identity: rules authored for a role name (for example, "ADMIN") are considered alongside rules authored for the user&#8217;s own userId. Effective roles are resolved by merging IdP roles with roles on the user record; see "How roles are defined for an identity" below.</p>
</li>
<li>
<p>Functional Area/Domain: Derived from the URL convention <code>/{area}/{functionalDomain}/{action}</code> as parsed by <code>SecurityFilter.determineResourceContext</code>. Author policies using these fields to target business capabilities rather than raw URLs or ad‑hoc headers.</p>
</li>
<li>
<p>DataDomain: When rules ALLOW an action, they can attach data-scope filters (tenant/org/owner) so downstream reads/writes are constrained to the caller’s domain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choosing the right approach</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use annotations for stable, coarse gates you want visible in code (for example, admin-only endpoints, health endpoints with <code>@PermitAll</code>).</p>
</li>
<li>
<p>Use feature flags to manage rollout/exposure and variants across environments and cohorts.</p>
</li>
<li>
<p>Use permission rules to encode fine-grained, data-aware authorization and to evolve policy without redeploying.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Compare and contrast</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotation-based controls are compile-time and hard-code policy into the service; changing them requires code changes.</p>
</li>
<li>
<p>Permission Rules and the Rule Language are data-driven and user-changeable (with proper governance), enabling rapid, auditable policy changes and DataDomain scoping.</p>
</li>
<li>
<p>In practice: apply annotations as the first gate, evaluate feature flags to determine exposure/variant, then evaluate permission rules to decide ALLOW/DENY and attach scopes. This layered approach yields both safety and agility.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Ontology- and label-aware policy helpers are available to postconditionScript when the optional ontology module is enabled. Helpers include hasEdge, hasAnyEdge, hasAllEdges, relatedIds for graph checks; hasLabel for label checks; and isA/noViolations for type/validation contexts. See the "Script Helpers reference" section for details. When data access must be restricted to lists resolved outside the rule engine (for example, from an external ACL service), use AccessListResolvers (SPI) and reference their outputs from andFilterString/orFilterString.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-b7118a18301b5bafb431c162190563b5.svg" alt="Diagram" width="492" height="461">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_key_concepts">22.2. Key Concepts</h3>
<div class="ulist">
<ul>
<li>
<p>Identity: The authenticated principal, typically originating from JWT or another provider. It includes:</p>
<div class="ulist">
<ul>
<li>
<p>userId (or credentialUserIdPassword username)</p>
</li>
<li>
<p>roles (authorities/groups)</p>
</li>
<li>
<p>tenantId, orgRefName, optional realm, and other claims that contribute to DomainContext</p>
</li>
</ul>
</div>
</li>
<li>
<p>userProfile: A domain representation of the user that adds human information such as first name, last name, email address, phone number and provides a linkage back to  identity, roles, and policy decorations (feature flags, plans, expiration, etc.).</p>
</li>
<li>
<p>Rule Base (Permission Rule): A declarative rule with matching criteria and an effect (ALLOW or DENY). Criteria are authored against SecurityURI and may include:</p>
<div class="ulist">
<ul>
<li>
<p>SecurityURIHeader fields: identity (userId or role name), area, functionalDomain, action</p>
</li>
<li>
<p>SecurityURIBody fields: realm, accountNumber, tenantId, dataSegment, ownerId, resourceId</p>
</li>
<li>
<p>Optional postconditionScript evaluated with pcontext/rcontext for additional checks</p>
</li>
<li>
<p>Priority: integer used to sort rule evaluation (lower numbers evaluated first)</p>
</li>
<li>
<p>Effect: ALLOW or DENY; ALLOWs may be paired with repository-level scoping using the SecurityURI body (e.g., DataDomain constraints)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rule_structure_illustrative">22.3. Rule Structure (Illustrative)</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-b157fee1180f4d419a93f8c9505cde0b.svg" alt="Diagram" width="523" height="285">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-catalog-product-reads</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Allow USER and ADMIN to view products in the Catalog area</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">USER</span></span>            <span class="comment"># or a specific userId; roles are treated as identities</span>
      <span class="key">area</span>: <span class="string"><span class="content">Catalog</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">Product</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">system-com</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">postconditionScript</span>:
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">false</span></span>

- <span class="string"><span class="content">name: default-deny</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Fallback deny when nothing else matches</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">area</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">'*'</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">DENY</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">10000</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The securityURI.header section corresponds to SecurityURIHeader: identity (userId or role name), area, functionalDomain, and action. Functional area/domain/action are typically derived from the URL convention <code>/{area}/{functionalDomain}/{action}</code> by SecurityFilter.</p>
</li>
<li>
<p>The securityURI.body section corresponds to SecurityURIBody: realm, accountNumber, tenantId, dataSegment, ownerId, and resourceId. These values are matched using simple string equality with support for the wildcard '*'.</p>
</li>
<li>
<p>Optional postconditionScript may be provided and is executed as JavaScript with pcontext and rcontext bindings; the rule only applies if the script evaluates to true.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_matching_algorithm">22.4. Matching Algorithm</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-e925a0338de57566633f769f931bc137.svg" alt="Diagram" width="812" height="688">
</div>
</div>
<div class="paragraph">
<p>The engine evaluates permission rules using SecurityURI wildcard matching. At a high level:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build ResourceContext</p>
<div class="ulist">
<ul>
<li>
<p>SecurityFilter derives area, functionalDomain, and action from the request path (or REST annotations if present) and sets the ResourceContext.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Expand identities</p>
<div class="ulist">
<ul>
<li>
<p>Build a set of identities consisting of the caller’s userId plus each effective role. Each of these identities is treated as a potential match target for rules.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Gather candidate rules</p>
<div class="ulist">
<ul>
<li>
<p>For each identity, collect rules authored for that identity. This forms the candidate set. There is no separate HTTP method/URL or rolesAny/rolesAll matching.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sort by priority</p>
<div class="ulist">
<ul>
<li>
<p>Order candidates by ascending priority (lower numbers are evaluated first).</p>
</li>
</ul>
</div>
</li>
<li>
<p>URI wildcard comparison</p>
<div class="ulist">
<ul>
<li>
<p>For each rule in priority order, compare the caller’s expanded SecurityURIs to the rule’s securityURI using case‑insensitive wildcard comparison on the full URI string (header + body). Asterisks ('*') in rules match any value.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Postcondition script (optional)</p>
<div class="ulist">
<ul>
<li>
<p>If the rule specifies postconditionScript, execute it as JavaScript with pcontext (principal) and rcontext (resource) variables bound. The rule applies only if the script returns true.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Apply effect and finalRule</p>
<div class="ulist">
<ul>
<li>
<p>When a rule matches (and any script returns true), set the response’s finalEffect to the rule’s effect (ALLOW or DENY). If finalRule is true, stop evaluating further rules; otherwise continue.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Default decision</p>
<div class="ulist">
<ul>
<li>
<p>If no rule determines a decision, the system returns the default final effect configured by the caller of the check (typically DENY).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_priorities">22.5. Priorities</h3>
<div class="ulist">
<ul>
<li>
<p>Lower integer = higher priority. Example: priority 1 overrides priority 10.</p>
</li>
<li>
<p>Use tight scopes with low priority for critical protections (e.g., denies), and broader ALLOWs with higher numeric priority.</p>
</li>
<li>
<p>Recommended ranges:</p>
</li>
<li>
<p>1–99: global deny rules and emergency blocks</p>
</li>
<li>
<p>100–499: domain/area-specific critical rules</p>
</li>
<li>
<p>500–999: standard ALLOW policies</p>
</li>
<li>
<p>1000+: defaults and catch-alls</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_grant_based_vs_deny_based_rule_sets">22.6. Grant-based vs Deny-based Rule Sets</h3>
<div class="paragraph">
<p>Grant-based rule sets start with a default decision of DENY and then incrementally add ALLOW scenarios through explicit rules. This model is fail‑safe by default: any URL, action, or functional area that does not have a matching ALLOW rule remains inaccessible. As new endpoints or capabilities are added to the system, users will not gain access until an explicit ALLOW is authored. This is the recommended posture for security‑sensitive systems and multi‑tenant platforms.</p>
</div>
<div class="paragraph">
<p>Deny-based rule sets start with a default decision of ALLOW and then add DENY scenarios to carve away disallowed cases. In this model, new functionality is exposed by default unless a DENY is added. While convenient during rapid prototyping, this posture risks accidental exposure as the surface area grows.</p>
</div>
<div class="paragraph">
<p>Practical implications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change management: Grant-based requires adding ALLOWs when shipping new features; Deny-based requires remembering to add new DENYs.</p>
</li>
<li>
<p>Auditability: Grant-based policies make it easy to enumerate what is permitted; Deny-based requires proving the absence of permissive gaps.</p>
</li>
<li>
<p>Safety: In merge conflicts or partial deployments, Grant-based tends to fail closed (DENY), which is usually safer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grant-based (recommended):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: default-deny</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">10000</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: '*', area: '*', functionalDomain: '*', action: '*' }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', accountNumber: '*', tenantId: '*', dataSegment: '*', ownerId: '*', resourceId: '*'}</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">DENY</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Deny-based (use with caution):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: default-allow</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">10000</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: '*', area: '*', functionalDomain: '*', action: '*' }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', accountNumber: '*', tenantId: '*', dataSegment: '*', ownerId: '*', resourceId: '*'}</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tip: Even in a deny-based set, author low‑number DENY rules for critical protections. In most production systems, prefer the grant-based model and layer specific ALLOWs for each capability.</p>
</div>
</div>
<div class="sect2">
<h3 id="_feature_flags_variants_and_target_rules">22.7. Feature Flags, Variants, and Target Rules</h3>
<div class="paragraph">
<p>Feature flags complement permission rules by controlling whether a capability is active for a given principal, cohort, or environment. Permissions answer “may this identity perform this action?”; feature flags answer “is this capability turned on, and which variant applies?” Use them together to achieve safe rollouts and fine‑grained authorization.</p>
</div>
<div class="paragraph">
<p>Model reference: com.e2eq.framework.model.general.FeatureFlag with key fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enabled: master on/off</p>
</li>
<li>
<p>type: BOOLEAN or MULTIVARIATE</p>
</li>
<li>
<p>variants: list of variant keys for multivariate experiments</p>
</li>
<li>
<p>targetRules: cohort targeting rules</p>
</li>
<li>
<p>environment: e.g., dev, staging, prod</p>
</li>
<li>
<p>jsonConfiguration: arbitrary configuration for the feature (e.g., rollout %, UI copy, limits)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example: Boolean flag for a new export API with environment‑specific targeting</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">EXPORT_API</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Enable CSV export endpoint</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">enabled</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">BOOLEAN</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">environment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">prod</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">targetRules</span><span class="delimiter">&quot;</span></span>: [
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">attribute</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>,     <span class="key"><span class="delimiter">&quot;</span><span class="content">operator</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">equals</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">BETA</span><span class="delimiter">&quot;</span></span>] },
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">attribute</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">operator</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">in</span><span class="delimiter">&quot;</span></span>,      <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">T100</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">T200</span><span class="delimiter">&quot;</span></span>] }
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">jsonConfiguration</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">rateLimitPerMin</span><span class="delimiter">&quot;</span></span>: <span class="integer">60</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: Multivariate flag to roll out Search v2 to 10% of users and all members of a beta role</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">SEARCH_V2</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">New search implementation</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">enabled</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MULTIVARIATE</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">variants</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">environment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">prod</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">targetRules</span><span class="delimiter">&quot;</span></span>: [
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">attribute</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">operator</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">equals</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">BETA</span><span class="delimiter">&quot;</span></span>], <span class="key"><span class="delimiter">&quot;</span><span class="content">variant</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span> },
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">attribute</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">userId</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">operator</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hashMod</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">values</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>], <span class="key"><span class="delimiter">&quot;</span><span class="content">variant</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span> }
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">jsonConfiguration</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">defaultVariant</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes on TargetRules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>attribute: a property from identity/userProfile (e.g., userId, role, tenantId, location, plan).</p>
</li>
<li>
<p>operator: equals, in, contains, startsWith, regex, or domain‑specific operators like hashMod for percentage rollouts.</p>
</li>
<li>
<p>values: comparison values; semantics depend on operator.</p>
</li>
<li>
<p>variant: when type is MULTIVARIATE, selects which variant applies when the rule matches.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How feature flags complement Permission Rule Context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The evaluation of a request can enrich the Rule Context (SecurityURI or userProfile) with resolved feature flags and variants (e.g., userProfile.features["SEARCH_V2"] = "v2").</p>
</li>
<li>
<p>Permission rules can then require a feature to be present before ALLOWing an action:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-export-when-flag-on</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Allow ADMIN and REPORTER identities to view export when feature flag is on</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">ADMIN</span></span>      <span class="comment"># treat roles as identities</span>
      <span class="key">area</span>: <span class="string"><span class="content">Reports</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">Export</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">system-com</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">postconditionScript</span>: <span class="string"><span class="content">userProfile?.features?.EXPORT_API === true</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">false</span></span>

- <span class="string"><span class="content">name: allow-export-when-flag-on-reporter</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Same as above but for REPORTER role</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">REPORTER</span></span>
      <span class="key">area</span>: <span class="string"><span class="content">Reports</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">Export</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">system-com</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">postconditionScript</span>: <span class="string"><span class="content">userProfile?.features?.EXPORT_API === true</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, systems may surface feature decisions via headers (e.g., X-Feature-SEARCH_V2: v2) so that rules or postconditionScript can read them directly from the request context.</p>
</div>
<div class="paragraph">
<p>Business usage examples for TargetRules and their correlation to Permission Rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Progressive rollout by tenant TargetRule tenantId in [T100, T200] → Permission adds ALLOW for endpoints guarded by that flag so only those tenants can call them during rollout.</p>
<div class="ulist">
<ul>
<li>
<p>Role‑based beta access: TargetRule role equals BETA → Permission requires both the BETA feature flag and standard role checks (e.g., USER/ADMIN) to ALLOW sensitive actions.</p>
</li>
<li>
<p>Plan/entitlement tiers: TargetRule plan in [Pro, Enterprise] → Permission rules enforce additional data‑domain constraints (e.g., export size limits) while the flag simply turns the feature on for eligible plans.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Guidance: Feature Flags vs Permission Rules</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put into Feature Flags:</p>
<div class="ulist">
<ul>
<li>
<p>Gradual, reversible rollouts; A/B or multivariate experiments; UI/behavior switches.</p>
</li>
<li>
<p>Environment gates (dev/staging/prod) and cohort targeting (tenants, beta users, geography).</p>
</li>
<li>
<p>Non‑security configuration values in jsonConfiguration (limits, thresholds, copy) that do not change who is authorized.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Put into Permission Rules:</p>
<div class="ulist">
<ul>
<li>
<p>Durable authorization logic: roles, identities, functional area/domain/action, and DataDomain constraints.</p>
</li>
<li>
<p>Compliance and least‑privilege decisions where fail‑closed behavior is required.</p>
</li>
<li>
<p>Enforcement that remains valid after a feature is fully launched (even when the flag is removed).</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Recommendation</dt>
<dd>
<p>Use a grant‑based permission posture (default DENY) and let feature flags decide which cohorts even see or can reach new capabilities. Then author explicit ALLOW rules for those capabilities, conditioned on both role and feature presence.</p>
</dd>
</dl>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_matching_rulebases">22.8. Multiple Matching RuleBases</h3>
<div class="ulist">
<ul>
<li>
<p>Ordering: rules are evaluated in ascending priority (lower numbers first).</p>
</li>
<li>
<p>Decision: when a rule matches, its effect (ALLOW or DENY) becomes the current decision.</p>
</li>
<li>
<p>finalRule: if the matching rule has finalRule: true, evaluation stops immediately; otherwise, evaluation continues and a later rule may overwrite the decision.</p>
</li>
<li>
<p>Default: if no rule matches decisively, the default effect supplied by the caller (typically DENY) is returned.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_identity_and_role_matching">22.9. Identity and Role Matching</h3>
<div class="ulist">
<ul>
<li>
<p>Roles-as-identities: the engine evaluates rules for the caller&#8217;s userId and for each effective role by treating each role name as an identity.</p>
</li>
<li>
<p>There are no rolesAny/rolesAll fields in rules; author separate rules for specific roles as needed.</p>
</li>
<li>
<p>Optional postconditionScript can inspect attributes (for example, tenantId) via pcontext and rcontext when additional checks are needed.</p>
</li>
<li>
<p>Time or plan-based conditions can be implemented inside postconditionScript or via feature flags.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_how_roles_are_defined_for_an_identity_role_sources_and_resolution">22.9.1. How roles are defined for an identity (role sources and resolution)</h4>
<div class="paragraph">
<p>Quantum composes the effective roles for a request by merging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roles from the identity provider (JWT/<code>SecurityIdentity</code>)</p>
</li>
<li>
<p>Roles configured on the user record (<code>CredentialUserIdPassword.roles</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Source details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identity Provider (JWT): roles commonly arrive via standard claims (for example, <code>groups</code>, <code>roles</code>, or provider-specific fields). Quarkus maps these into <code>SecurityIdentity.getRoles()</code>. In multi-realm setups, the realm in <code>X-Realm</code> can scope lookups but does not alter what the JWT asserts.</p>
</li>
<li>
<p>Quantum user record: <code>com.e2eq.framework.model.security.CredentialUserIdPassword</code> has a <code>String[] roles</code> field stored per realm. This can be administered by Quantum to grant platform- or tenant-level roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Merge semantics (current implementation):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Union: the effective role set is the union of JWT roles and <code>CredentialUserIdPassword.roles</code>. If either source is empty, the other source defines the set.</p>
</li>
<li>
<p>Fallback: when neither source yields roles, the framework defaults to <code>ANONYMOUS</code>.</p>
</li>
<li>
<p>Where implemented: <code>SecurityFilter.determinePrincipalContext</code> builds <code>PrincipalContext</code> with the merged roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Realm considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user record is looked up by subject or userId in the active realm (default or <code>X-Realm</code>). If a realm override is provided, it is validated with <code>CredentialUserIdPassword.realmRegEx</code>.</p>
</li>
<li>
<p>Roles stored in a user record are realm-specific; JWT roles are whatever the IdP asserts for the token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operating models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quantum-managed roles:</p>
<div class="ulist">
<ul>
<li>
<p>IdP authenticates the user (subject, username). Authorization is primarily driven by roles stored in <code>CredentialUserIdPassword.roles</code>.</p>
</li>
<li>
<p>Use when you want central, auditable role assignment within Quantum, independent of IdP groups.</p>
</li>
</ul>
</div>
</li>
<li>
<p>IdP-managed roles:</p>
<div class="ulist">
<ul>
<li>
<p>IdP carries authoritative roles/groups in the JWT. Keep <code>CredentialUserIdPassword.roles</code> minimal or empty.</p>
</li>
<li>
<p>Use when enterprises require IdP as the source of truth for access groups.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hybrid (recommended in many deployments):</p>
<div class="ulist">
<ul>
<li>
<p>Effective roles = JWT roles ∪ <code>CredentialUserIdPassword.roles</code>.</p>
</li>
<li>
<p>Use JWT for enterprise groups (for example, <code>DEPT_SALES</code>, <code>ORG_ADMIN</code>) and Quantum roles for app-specific grants (for example, <code>REPORT_EXPORTER</code>, <code>BETA</code>).</p>
</li>
<li>
<p>This avoids IdP churn for application-local concerns while respecting org policies.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JWT-only:</p>
<div class="ulist">
<ul>
<li>
<p>JWT.groups = [USER, REPORTER]; user record roles = []</p>
</li>
<li>
<p>Effective roles = [USER, REPORTER]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Quantum-only:</p>
<div class="ulist">
<ul>
<li>
<p>JWT.groups = []; user record roles = [USER, ADMIN]</p>
</li>
<li>
<p>Effective roles = [USER, ADMIN]</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hybrid union:</p>
<div class="ulist">
<ul>
<li>
<p>JWT.groups = [USER]; user record roles = [BETA, REPORT_EXPORTER]</p>
</li>
<li>
<p>Effective roles = [USER, BETA, REPORT_EXPORTER]</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Guidance and best practices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep role names stable and environment-agnostic; use realms/permissions to scope where needed.</p>
</li>
<li>
<p>Avoid overloading roles for feature rollout; use Feature Flags for rollout and variants, and roles for durable authorization.</p>
</li>
<li>
<p>When IdP is authoritative, ensure consistent claim mapping so <code>SecurityIdentity.getRoles()</code> contains the expected values; commonly via <code>groups</code> claim in JWT.</p>
</li>
<li>
<p>Use grant-based permission rules and require the minimal set of roles (<code>rolesAny</code>/<code>rolesAll</code>) needed for each capability.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cross-references:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User model: <code>com.e2eq.framework.model.security.CredentialUserIdPassword.roles</code></p>
</li>
<li>
<p>Context: <code>com.e2eq.framework.model.securityrules.PrincipalContext.getRoles()</code></p>
</li>
<li>
<p>Filter logic: <code>com.e2eq.framework.rest.filters.SecurityFilter.determinePrincipalContext</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_populating_rolesource_and_roleassignments">Populating <code>RoleSource</code> and <code>roleAssignments</code></h5>
<div class="paragraph">
<p>Quantum exposes structured provenance for each role via:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.e2eq.framework.model.auth.RoleSource</code> enum with values: <code>USERGROUP</code>, <code>IDP</code>, <code>CREDENTIAL</code></p>
</li>
<li>
<p><code>com.e2eq.framework.model.auth.RoleAssignment</code> record: <code>role</code> + <code>Set&lt;RoleSource&gt; sources</code></p>
</li>
<li>
<p>Login response model <code>com.e2eq.framework.model.auth.AuthProvider.LoginPositiveResponse</code> now includes
a <code>roleAssignments</code> field next to plain <code>roles</code>.</p>
</li>
<li>
<p><code>com.e2eq.framework.model.securityrules.SecurityCheckResponse</code> also includes <code>roleAssignments</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Defaults and compatibility:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you do nothing, both login and security check responses automatically derive <code>roleAssignments</code>
from the flat <code>roles</code> set and mark each role with <code>CREDENTIAL</code>. This preserves backward compatibility.</p>
</li>
<li>
<p>To provide accurate provenance, populate <code>roleAssignments</code> explicitly where you already know role sources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JSON example (login success):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">userId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">alice</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">roles</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">roleAssignments</span><span class="delimiter">&quot;</span></span>: [
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">sources</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">credential</span><span class="delimiter">&quot;</span></span>]},
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">role</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">sources</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">usergroup</span><span class="delimiter">&quot;</span></span>]}
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">accessToken</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refreshToken</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">expirationTime</span><span class="delimiter">&quot;</span></span>: <span class="integer">1732100000</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">mongodbUrl</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">system</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_authproviders_what_you_need_to_do">AuthProviders: what you need to do</h5>
<div class="paragraph">
<p>Auth providers (for example, <code>CustomTokenAuthProvider</code>) should add provenance at two points:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>During login (<code>login(userId, password)</code>)</p>
</li>
<li>
<p>During token refresh (<code>refreshTokens(refreshToken)</code>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>At each point build three role sets and then compute per-role sources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IDP roles → from <code>io.quarkus.security.identity.SecurityIdentity.getRoles()</code> for the current access/refresh token</p>
</li>
<li>
<p>Credential roles → from <code>com.e2eq.framework.model.security.CredentialUserIdPassword.getRoles()</code> in the DB</p>
</li>
<li>
<p>User group roles → gathered by resolving the user&#8217;s <code>UserProfile</code> and its <code>UserGroup</code> memberships</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then build <code>List&lt;RoleAssignment&gt;</code> and pass the full constructor of <code>LoginPositiveResponse</code>.</p>
</div>
<div class="paragraph">
<p>Example (inside <code>CustomTokenAuthProvider.login(&#8230;&#8203;)</code> after you create <code>identity</code> and locate the <code>credential</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 1) Collect source role sets</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; idpRoles = (identity != <span class="predefined-constant">null</span>) ? <span class="keyword">new</span> java.util.LinkedHashSet&lt;&gt;(identity.getRoles()) : java.util.Set.of();
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; credentialRoles = <span class="keyword">new</span> java.util.LinkedHashSet&lt;&gt;(java.util.Arrays.asList(credential.getRoles()));
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; userGroupRoles = <span class="keyword">new</span> java.util.LinkedHashSet&lt;&gt;();
<span class="keyword">try</span> {
    <span class="type">var</span> userProfileOpt = userProfileRepo.getBySubject(credential.getSubject());
    <span class="keyword">if</span> (userProfileOpt.isPresent()) {
        <span class="type">var</span> groups = userGroupRepo.findByUserProfileRef(userProfileOpt.get().createEntityReference());
        <span class="keyword">if</span> (groups != <span class="predefined-constant">null</span>) {
            <span class="keyword">for</span> (com.e2eq.framework.model.security.UserGroup g : groups) {
                <span class="keyword">if</span> (g != <span class="predefined-constant">null</span> &amp;&amp; g.getRoles() != <span class="predefined-constant">null</span>) {
                    java.util.Collections.addAll(userGroupRoles, g.getRoles());
                }
            }
        }
    }
} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    io.quarkus.logging.Log.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Group role expansion failed; continuing without group roles</span><span class="delimiter">&quot;</span></span>, e);
}

<span class="comment">// 2) Union of all roles for the response</span>
java.util.Set&lt;<span class="predefined-type">String</span>&gt; allRoles = <span class="keyword">new</span> java.util.LinkedHashSet&lt;&gt;();
allRoles.addAll(idpRoles);
allRoles.addAll(credentialRoles);
allRoles.addAll(userGroupRoles);

<span class="comment">// 3) Build per-role source assignments</span>
java.util.List&lt;com.e2eq.framework.model.auth.RoleAssignment&gt; roleAssignments = allRoles.stream()
    .filter(java.util.Objects::nonNull)
    .map(role -&gt; {
        java.util.EnumSet&lt;com.e2eq.framework.model.auth.RoleSource&gt; src =
            java.util.EnumSet.noneOf(com.e2eq.framework.model.auth.RoleSource.class);
        <span class="keyword">if</span> (idpRoles.contains(role)) src.add(com.e2eq.framework.model.auth.RoleSource.IDP);
        <span class="keyword">if</span> (credentialRoles.contains(role)) src.add(com.e2eq.framework.model.auth.RoleSource.CREDENTIAL);
        <span class="keyword">if</span> (userGroupRoles.contains(role)) src.add(com.e2eq.framework.model.auth.RoleSource.USERGROUP);
        <span class="keyword">return</span> <span class="keyword">new</span> com.e2eq.framework.model.auth.RoleAssignment(role, src);
    })
    .toList();

<span class="comment">// 4) Use the full constructor that accepts roleAssignments</span>
<span class="keyword">return</span> <span class="keyword">new</span> com.e2eq.framework.model.auth.AuthProvider.LoginResponse(
    <span class="predefined-constant">true</span>,
    <span class="keyword">new</span> com.e2eq.framework.model.auth.AuthProvider.LoginPositiveResponse(
        userId,
        identity,
        allRoles,               <span class="comment">// Set&lt;String&gt;</span>
        roleAssignments,        <span class="comment">// List&lt;RoleAssignment&gt;</span>
        accessToken,
        refreshToken,
        expirationTime,
        mongodbUrl,
        realm
    )
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes and tips:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You may centralize this logic in <code>IdentityRoleResolver</code> by adding a method that returns <code>Map&lt;String, EnumSet&lt;RoleSource&gt;&gt;</code> (role → sources) and reuse it across login and <code>/check</code>.</p>
</li>
<li>
<p>If you cannot resolve a user record (for example, token-only identities), populate only <code>IDP</code> sources.</p>
</li>
<li>
<p>Avoid adding synthetic roles like <code>ANONYMOUS</code> to <code>roleAssignments</code>—the structure should cover actual grants.</p>
</li>
<li>
<p>Consider caching group-derived roles per user/request if lookups are expensive.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_security_check_responses_enriching_roleassignments">Security Check responses: enriching <code>roleAssignments</code></h5>
<div class="paragraph">
<p><code>SecurityCheckResponse</code> defaults to marking all roles as <code>CREDENTIAL</code>. To provide accurate provenance during permission checks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Near <code>PermissionResource.check(&#8230;&#8203;)</code>, where roles are resolved, compute the same three source sets as above.</p>
</li>
<li>
<p>Build <code>List&lt;RoleAssignment&gt;</code> from the final role set used for <code>PrincipalContext</code>.</p>
</li>
<li>
<p>After calling the rule engine, overwrite the response’s assignments:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SecurityCheckResponse resp = ruleContext.checkRules(pc, rc);
resp.setRoleAssignments(roleAssignments);
<span class="keyword">return</span> Response.ok(resp).build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This keeps the default behavior (no breaking changes) while enabling clients to see precisely how each role was granted.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_scenarios">22.10. Example Scenarios</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Public catalog browsing</p>
<div class="ulist">
<ul>
<li>
<p>Request: GET /Catalog/Products/VIEW?search=widgets</p>
</li>
<li>
<p>Identity: anonymous or role USER</p>
</li>
<li>
<p>Rules:</p>
<div class="ulist">
<ul>
<li>
<p>allow-public-reads (priority 100) ALLOW + readScope orgRefName=PUBLIC</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome: ALLOW; repository applies DataDomain filter orgRefName=PUBLIC</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tenant-scoped shipment update</p>
<div class="ulist">
<ul>
<li>
<p>Request: PUT /Collaboration/Shipments/UPDATE</p>
</li>
<li>
<p>Headers: x-tenant-id=T1</p>
</li>
<li>
<p>Body: { dataDomain: { tenantId: "T1" }, &#8230;&#8203; }</p>
</li>
<li>
<p>Identity: user in tenant T1 with roles [USER]</p>
</li>
<li>
<p>Rules:</p>
<div class="ulist">
<ul>
<li>
<p>allow-collab-update (priority 300) requires body.dataDomain.tenantId == identity.tenantId and rolesAny USER, ADMIN &#8658; ALLOW</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome: ALLOW; Rule contributes writeScope tenantId=T1</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cross-tenant admin read with higher priority</p>
<div class="ulist">
<ul>
<li>
<p>Request: GET /api/partners</p>
</li>
<li>
<p>Identity: role ADMIN (super-admin)</p>
</li>
<li>
<p>Rules:</p>
<div class="ulist">
<ul>
<li>
<p>admin-override (priority 50) ALLOW</p>
</li>
<li>
<p>default-tenant-read (priority 600) ALLOW with tenant filter</p>
</li>
</ul>
</div>
</li>
<li>
<p>Outcome: admin-override wins due to higher precedence (lower number), allowing broader read</p>
</li>
</ul>
</div>
</li>
<li>
<p>Conflicting ALLOW and DENY at same priority</p>
<div class="ulist">
<ul>
<li>
<p>Two rules match with priority 200: one ALLOW, one DENY</p>
</li>
<li>
<p>Resolution: DENY wins unless merge strategy configured to handle explicitly; recommended to avoid same-priority conflicts by policy.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_operational_tips">22.11. Operational Tips</h3>
<div class="ulist">
<ul>
<li>
<p>Author specific DENY rules with low numbers to prevent accidental exposure.</p>
</li>
<li>
<p>Author SecurityURI header (area/domain/action) as narrowly as needed for sensitive domains.</p>
</li>
<li>
<p>Prefer SecurityURI body fields and postconditionScript to refine matches without over-broad area/domain/action patterns.</p>
</li>
<li>
<p>Log matched rule names and applied scopes for auditability.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_uiactions_and_defaultuiactions_are_calculated">22.12. How UIActions and DefaultUIActions are calculated</h3>
<div class="paragraph">
<p>When the server returns a collection of entities (for example, userProfiles), each entity may expose two action lists:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DefaultUIActions: the full set of actions that conceptually apply to this type of entity (e.g., CREATE, UPDATE, VIEW, DELETE, ARCHIVE). Think of this as the “menu template” for the type.</p>
</li>
<li>
<p>UIActions: the subset of actions the current user is actually permitted to perform on that specific entity instance right now.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why they can differ per entity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity attributes: state or flags (e.g., archived, soft-deleted, immutable) can remove or alter available actions at instance level.</p>
</li>
<li>
<p>Permission rule base: evaluated against the current request, identity, and context to allow or deny actions.</p>
</li>
<li>
<p>DataDomain membership: tenant/org/owner scoping can further restrict actions if the identity is outside the entity’s domain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How the server computes them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with a default action template for the entity type (DefaultUIActions).</p>
</li>
<li>
<p>Apply simple state-based adjustments (for example, suppress CREATE on already-persisted instances).</p>
</li>
<li>
<p>Evaluate the permission rules with the current identity and context:</p>
<div class="ulist">
<ul>
<li>
<p>Consider roles, functional area/domain, action intent, SecurityURI body fields, and any rule-contributed scopes.</p>
</li>
<li>
<p>Resolve DataDomain constraints to ensure the identity is permitted to act within the entity’s domain.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Produce UIActions as the allowed subset for that entity instance.</p>
</li>
<li>
<p>Return both lists with each entity in collection responses.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>How the client should use the two lists:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Render the full DefaultUIActions as the visible set of possible actions (icons, buttons, menus) so the UI stays consistent.</p>
</li>
<li>
<p>Enable only those actions present in UIActions; gray out or disable the remainder to signal capability but lack of current permission.</p>
</li>
<li>
<p>This approach avoids flicker and keeps affordances discoverable while remaining truthful to the user’s current authorization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You fetch 25 userProfiles.</p>
</li>
<li>
<p>DefaultUIActions for the type = [CREATE, VIEW, UPDATE, DELETE, ARCHIVE].</p>
</li>
<li>
<p>For a specific profile A (owned by your tenant), UIActions may be [VIEW, UPDATE] based on your roles and domain.</p>
</li>
<li>
<p>For another profile B (in a different tenant), UIActions may be [VIEW] only.</p>
</li>
<li>
<p>The UI renders the same controls for both A and B, but only enables the actions present in each item’s UIActions list.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep action names stable and documented so front-ends can map to icons and tooltips consistently.</p>
</li>
<li>
<p>Prefer small, composable rules that evaluate action permissions explicitly by functional area/domain to avoid surprises.</p>
</li>
<li>
<p>Consider server-side caching of action evaluations for list views to reduce latency, respecting identity and scope.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_this_integrates_end_to_end">22.13. How This Integrates End-to-End</h3>
<div class="ulist">
<ul>
<li>
<p>BaseResource extracts identity and headers to construct DomainContext.</p>
</li>
<li>
<p>Rule evaluation uses SecurityURI (header + body) matching with optional postconditionScript and identity/userProfile to reach a decision and derive scope filters.</p>
</li>
<li>
<p>Repositories (e.g., MorphiaRepo) apply the filters to queries and updates, ensuring DataDomain-respecting access.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_administering_policies_via_rest_policyresource">22.14. Administering Policies via REST (PolicyResource)</h3>
<div class="paragraph">
<p>The PolicyResource exposes CRUD-style REST APIs for creating and managing policies (rule bases) that drive authorization decisions. Each Policy targets a principalId (either a specific userId or a role name) and contains an ordered list of Rule objects. Rules match requests using SecurityURIHeader and SecurityURIBody and then contribute an effect (ALLOW/DENY) and optional repository filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Base path: /security/permission/policies</p>
</li>
<li>
<p>Auth: Bearer JWT (see Authentication); resource methods are guarded by @RolesAllowed("user", "admin") at the BaseResource level and your own realm/role policies.</p>
</li>
<li>
<p>Multi-realm: pass X-Realm header to operate within a specific realm; otherwise the default realm is used.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_model_shape_policy">22.14.1. Model shape (Policy)</h4>
<div class="paragraph">
<p>A Policy extends FullBaseModel and includes:
- id, refName, displayName, dataDomain, archived/expired flags (inherited)
- principalId: userId or role name that this policy attaches to
- description: human-readable summary
- rules: array of Rule entries</p>
</div>
<div class="paragraph">
<p>Rule fields (key ones):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name, description</p>
</li>
<li>
<p>securityURI.header: identity, area, functionalDomain, action (supports wildcard "*")</p>
</li>
<li>
<p>securityURI.body: realm, orgRefName, accountNumber, tenantId, ownerId, dataSegment, resourceId (supports wildcard "*")</p>
</li>
<li>
<p>effect: ALLOW or DENY</p>
</li>
<li>
<p>priority: integer; lower numbers evaluated first</p>
</li>
<li>
<p>finalRule: boolean; stop evaluating when this rule applies</p>
</li>
<li>
<p>andFilterString / orFilterString: ANTLR filter DSL snippets injected into repository queries (see Query Language section)</p>
</li>
<li>
<p>joinOp: how to combine the andFilterString group with the orFilterString group when both are present; defaults to AND</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_how_rule_contributed_filters_work_andfilterstring_orfilterstring_joinop">22.14.2. How rule-contributed filters work (andFilterString, orFilterString, joinOp)</h4>
<div class="paragraph">
<p>When an ALLOW rule matches, it can contribute repository-level filters that restrict which documents are visible or mutable. The fields are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>andFilterString: a filter expression added to the AND group.</p>
</li>
<li>
<p>orFilterString: a filter expression added to the OR group.</p>
</li>
<li>
<p>joinOp: when both groups are present, specifies how to join them. Values: AND or OR. Default: AND.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-5e57fd419660daec73fb677d74312696.svg" alt="Diagram" width="771" height="605">
</div>
</div>
<div class="paragraph">
<p>Composition algorithm (implemented in RuleContext.getFilters):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Collect all matched rules (in priority order; skipping NOT_APPLICABLE script results). For each rule:</p>
<div class="ulist">
<ul>
<li>
<p>If andFilterString is set, parse it into a Morphia Filter and add to the and-group.</p>
</li>
<li>
<p>If orFilterString is set, parse it into a Morphia Filter and add to the or-group.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If both groups are non-empty for the current rule:</p>
<div class="ulist">
<ul>
<li>
<p>If joinOp == AND (default): effective = AND( AND(all and-group), OR(all or-group) ).</p>
</li>
<li>
<p>If joinOp == OR: effective = OR( OR(all or-group), AND(all and-group) ).</p>
</li>
</ul>
</div>
</li>
<li>
<p>If only one group is non-empty:</p>
<div class="ulist">
<ul>
<li>
<p>Use AND(all and-group) or OR(all or-group) as the effective filter.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Append the effective filter(s) to the query’s filter list. If the rule has finalRule: true, stop accumulating more filters.</p>
</li>
<li>
<p>Deduplicate filters by string form before returning.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AND only</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: tenant-scope</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: sales, functionalDomain: order, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.tenantId:${pcontext.dataDomain.tenantId}</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">200</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting Morphia: AND( eq("dataDomain.tenantId", &lt;caller-tenant&gt;) )</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OR only</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: visibility-by-segment</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: sales, functionalDomain: order, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">orFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.dataSegment:^[PUBLIC|INTERNAL]</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">210</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting Morphia: OR( in("dataDomain.dataSegment", [PUBLIC, INTERNAL]) )</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AND + OR with joinOp: AND (default)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: own-or-public</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: security, functionalDomain: userProfile, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.ownerId:${principalId}</span><span class="delimiter">&quot;</span></span>
  <span class="key">orFilterString</span>:  <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.dataSegment:^[PUBLIC]</span><span class="delimiter">&quot;</span></span>
  <span class="key">joinOp</span>: <span class="string"><span class="content">AND</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">220</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Effective: AND( eq(ownerId, principalId), OR(eq(dataSegment, 'PUBLIC')) )</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AND + OR with joinOp: OR</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: owner-or-segment</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: files, functionalDomain: document, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.ownerId:${principalId}</span><span class="delimiter">&quot;</span></span>
  <span class="key">orFilterString</span>:  <span class="string"><span class="delimiter">&quot;</span><span class="content">tags:^[shared]</span><span class="delimiter">&quot;</span></span>
  <span class="key">joinOp</span>: <span class="string"><span class="content">OR</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">230</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Effective: OR( eq(ownerId, principalId), AND(eq(tags, 'shared')) )</p>
</div>
<div class="paragraph">
<p>Placeholders and variables:</p>
</div>
<div class="paragraph">
<p>The following standard variables are available in andFilterString/orFilterString:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Source</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${principalId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.userId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The authenticated user&#8217;s ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${pAccountId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.dataDomain.accountNum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The principal&#8217;s account number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${pTenantId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.dataDomain.tenantId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The principal&#8217;s tenant ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${ownerId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.dataDomain.ownerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The data owner ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${orgRefName}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.dataDomain.orgRefName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The organization reference name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${defaultRealm}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext.defaultRealm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current realm (changes with X-Realm override)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${resourceId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ResourceContext.resourceId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The target resource ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${action}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ResourceContext.action</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The action being performed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${functionalDomain}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ResourceContext.functionalDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The functional domain</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${area}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ResourceContext.area</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The functional area</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${dcTenantId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DomainContext.tenantId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant ID from the current domain context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${dcOrgRefName}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DomainContext.orgRefName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Organization reference name from domain context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${dcAccountId}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DomainContext.accountId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account ID from domain context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>${dcDataSegment}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DomainContext.dataSegment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data segment number from domain context</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>X-Realm integration</strong>: When <code>X-Realm</code> is used, <code>${defaultRealm}</code> automatically reflects the target realm. This enables permission filters to dynamically scope data based on the active realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: scope-by-realm</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: '*', functionalDomain: '*', action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.tenantId:${defaultRealm}</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">200</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The filter DSL is described in the Query Language guide; it maps to Morphia dev.morphia.query.filters.Filters under the hood via MorphiaUtils.convertToFilter.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_accesslistresolvers_spi_for_list_based_access">22.14.3. AccessListResolvers (SPI) for list-based access</h4>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-19678e06c83a16fe71cfaff92a476663.svg" alt="Diagram" width="629" height="385">
</div>
</div>
<div class="paragraph">
<p>AccessListResolvers let you plug in computed collections (IDs, codes, emails, etc.) at request time and reference them from andFilterString/orFilterString. This is ideal for ACL-style list checks or integrating with external systems that decide which resources a user may access.</p>
</div>
<div class="paragraph">
<p>How it works (as implemented):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SPI: com.e2eq.framework.securityrules.AccessListResolver</p>
</li>
<li>
<p>key(): the variable name published to the filter variable bundle (e.g., "accessibleCustomerIds").</p>
</li>
<li>
<p>supports(pctx, rctx, modelClass): return true when this resolver applies for the current request and repository model type.</p>
</li>
<li>
<p>resolve(pctx, rctx, modelClass): return a Collection&lt;?&gt; which will be available as ${&lt;key&gt;} in filter strings.</p>
</li>
<li>
<p>RuleContext.getFilters discovers all AccessListResolver beans via CDI, calls supports(&#8230;&#8203;), and for those that apply it puts key() &#8594; resolve(&#8230;&#8203;) into the "extraObjects" map. MorphiaUtils.buildVariableBundle merges these into the variable set used by convertToFilter.</p>
</li>
<li>
<p>In your filter DSL, use:</p>
</li>
<li>
<p>IN with resolver-provided lists: field:^${key}</p>
</li>
<li>
<p>Equality with resolver-provided scalars: field:${key}</p>
</li>
<li>
<p>You can also reference nested principals: ${pcontext.dataDomain.tenantId}, ${principalId}, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restrict Orders to the set of ids returned by a resolver</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: orders-by-acl</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: sales, functionalDomain: order, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">_id:^${accessibleOrderIds}</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">200</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use resolver that returns customer codes and OR with a public segment</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: customer-code-or-public</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: USER, area: crm, functionalDomain: customer, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">code:^${visibleCustomerCodes}</span><span class="delimiter">&quot;</span></span>
  <span class="key">orFilterString</span>:  <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.dataSegment:^[PUBLIC]</span><span class="delimiter">&quot;</span></span>
  <span class="key">joinOp</span>: <span class="string"><span class="content">OR</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">210</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reference implementation (tests/examples):
- RuleContext.getFilters collects resolvers and exposes them to the filter StringSubstitutor via MorphiaUtils.buildVariableBundle.
- See also: quantum-framework/src/test/java/com/e2eq/framework/securityrules/TestCustomerAccessResolver.java and TestStringAccessResolver.java for sample resolvers.</p>
</div>
<div class="paragraph">
<p>Guidance:
- Keep keys stable and document them; they form your contract between resolver authors and rule authors.
- Always scope resolver queries by tenant/realm from PrincipalContext/ResourceContext.
- Return empty collections instead of null. An empty IN list yields no matches, which is safe by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_principalcontextpropertiesresolver_spi_for_custom_principal_properties">22.14.4. PrincipalContextPropertiesResolver (SPI) for custom principal properties</h4>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-3f301d1907337043041d1f30cc0a065b.svg" alt="Diagram" width="873" height="278">
</div>
</div>
<div class="paragraph">
<p>PrincipalContextPropertiesResolver allows applications to enrich PrincipalContext with custom, domain-specific properties during authentication. Unlike AccessListResolver (which is invoked per-query and scoped to specific resources), these properties are resolved once when the principal context is built and are available throughout the request lifecycle.</p>
</div>
<div class="paragraph">
<p>Use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Associate/Sales Rep binding</strong>: Link a UserProfile to an Associate entity and expose <code>associateId</code> for filtering</p>
</li>
<li>
<p><strong>Territory assignments</strong>: Expose <code>accessibleTerritoryIds</code> based on the user&#8217;s role assignments</p>
</li>
<li>
<p><strong>Organizational hierarchies</strong>: Expose <code>accessibleLocationIds</code> via ontology relationships</p>
</li>
<li>
<p><strong>Custom attributes</strong>: Any domain-specific property needed for security filtering</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How it works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SPI: <code>com.e2eq.framework.model.securityrules.PrincipalContextPropertiesResolver</code></p>
</li>
<li>
<p><code>priority()</code>: Execution order (lower = earlier). Default: 1000.</p>
</li>
<li>
<p><code>resolve(ResolutionContext)</code>: Return a Map&lt;String, Object&gt; of properties to add to PrincipalContext.</p>
</li>
<li>
<p><code>ResolutionContext</code> provides access to:</p>
</li>
<li>
<p><code>isAnonymous()</code>, <code>getPrincipalName()</code>, <code>getIdentityRoles()</code>: Security identity info</p>
</li>
<li>
<p><code>getUserId()</code>, <code>getSubjectId()</code>: User identifiers</p>
</li>
<li>
<p><code>getRealm()</code>, <code>getDataDomain()</code>, <code>getDomainContext()</code>: Realm and domain context</p>
</li>
<li>
<p><code>getHeader(name)</code>: HTTP request headers</p>
</li>
<li>
<p><code>getJwtClaim(name)</code>: JWT token claims</p>
</li>
<li>
<p><code>hasCredentials()</code>, <code>getCredentialUserId()</code>, <code>getCredentialRoles()</code>: Database credentials</p>
</li>
<li>
<p>SecurityFilter discovers all resolvers via CDI, invokes them in priority order, and merges results into PrincipalContext.customProperties.</p>
</li>
<li>
<p>MorphiaUtils.createStandardVariableMapFrom includes custom properties, making them available as <code>${key}</code> in filter strings.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.myapp.security</span>;

<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.securityrules.PrincipalContextPropertiesResolver</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.securityrules.ResolutionContext</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.repo.OntologyEdgeRepo</span>;
<span class="keyword">import</span> <span class="include">jakarta.enterprise.context.ApplicationScoped</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">java.util</span>.*;

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AssociatePropertiesResolver</span> <span class="directive">implements</span> PrincipalContextPropertiesResolver {

    <span class="annotation">@Inject</span>
    OntologyEdgeRepo edgeRepo;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> priority() {
        <span class="keyword">return</span> <span class="integer">100</span>; <span class="comment">// Run early</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; resolve(ResolutionContext context) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; properties = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

        <span class="comment">// Skip for anonymous users</span>
        <span class="keyword">if</span> (context.isAnonymous()) {
            <span class="keyword">return</span> properties;
        }

        <span class="predefined-type">String</span> userProfileId = context.getSubjectId().orElse(context.getUserId());

        <span class="comment">// Find Associate linked to this UserProfile via hasUser relationship</span>
        <span class="comment">// Associate.hasUser -&gt; UserProfile (functional/1:1)</span>
        Optional&lt;<span class="predefined-type">String</span>&gt; associateId = edgeRepo.singleSrcIdByDst(
            context.getDataDomain(), <span class="string"><span class="delimiter">&quot;</span><span class="content">hasUser</span><span class="delimiter">&quot;</span></span>, userProfileId);

        <span class="keyword">if</span> (associateId.isPresent()) {
            properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">associateId</span><span class="delimiter">&quot;</span></span>, associateId.get());

            <span class="comment">// Get territories this associate can access</span>
            <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; territoryIds = edgeRepo.dstIdsBySrc(
                context.getDataDomain(), <span class="string"><span class="delimiter">&quot;</span><span class="content">assignedToTerritory</span><span class="delimiter">&quot;</span></span>, associateId.get());
            properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleTerritoryIds</span><span class="delimiter">&quot;</span></span>, territoryIds);

            <span class="comment">// Get locations via inferred canSeeLocation edge</span>
            <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; locationIds = edgeRepo.dstIdsBySrc(
                context.getDataDomain(), <span class="string"><span class="delimiter">&quot;</span><span class="content">canSeeLocation</span><span class="delimiter">&quot;</span></span>, associateId.get());
            properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleLocationIds</span><span class="delimiter">&quot;</span></span>, locationIds);
        }

        <span class="keyword">return</span> properties;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using custom properties in rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># Filter locations to those the associate can see</span>
- <span class="string"><span class="content">name: associate-location-access</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: sales-rep, area: sales, functionalDomain: location, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.tenantId:${pTenantId}</span><span class="delimiter">&quot;</span></span>
  <span class="key">orFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">_id:^${accessibleLocationIds}</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">200</span></span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># Filter orders by territory</span>
- <span class="string"><span class="content">name: territory-order-access</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>: <span class="string"><span class="content">{ identity: sales-rep, area: sales, functionalDomain: order, action: view }</span></span>
    <span class="key">body</span>:   <span class="string"><span class="content">{ realm: '*', orgRefName: '*', accountNumber: '*', tenantId: '*', ownerId: '*', dataSegment: '*', resourceId: '*' }</span></span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.tenantId:${pTenantId} AND territoryId:^${accessibleTerritoryIds}</span><span class="delimiter">&quot;</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">200</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Accessing properties programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// In application code or postconditionScript</span>
PrincipalContext pctx = SecurityContext.getPrincipalContext().get();

<span class="comment">// Get a single property</span>
<span class="predefined-type">String</span> associateId = (<span class="predefined-type">String</span>) pctx.getCustomProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">associateId</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Get with type safety</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; locationIds = pctx.getCustomProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">accessibleLocationIds</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.class);

<span class="comment">// Get all custom properties</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; allProps = pctx.getCustomProperties();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparison: PrincipalContextPropertiesResolver vs AccessListResolver</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aspect</th>
<th class="tableblock halign-left valign-top">PrincipalContextPropertiesResolver</th>
<th class="tableblock halign-left valign-top">AccessListResolver</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">When invoked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Once during authentication (eager)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per query during rule evaluation (lazy)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Context available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SecurityIdentity, JWT claims, HTTP headers, Credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PrincipalContext, ResourceContext, ModelClass</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Caching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cached in PrincipalContext for request lifetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per-request via RuleContext</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use case</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-level properties constant across all queries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource-specific access lists that vary by model/action</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Performance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single invocation per request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoked per repository call</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Guidance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use PrincipalContextPropertiesResolver for properties that apply to the user regardless of what resource they&#8217;re accessing (e.g., associate ID, territory assignments).</p>
</li>
<li>
<p>Use AccessListResolver when the access list depends on the specific resource type or action being performed.</p>
</li>
<li>
<p>Both mechanisms can coexist and complement each other.</p>
</li>
<li>
<p>Return empty maps (not null) from resolvers; resolver failures are logged and skipped, not propagated.</p>
</li>
<li>
<p>Properties should not override built-in PrincipalContext fields (userId, roles, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where filters are applied (MorphiaRepo methods):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-67439e3543db0a23bccf4694e3af377c.svg" alt="Diagram" width="341" height="461">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>getList / getListByQuery / find: RuleContext.getFilters augments the base filters with the effective security filters before executing the query.</p>
</li>
<li>
<p>count: same as read paths, ensuring counts reflect scoped visibility.</p>
</li>
<li>
<p>save (create): rules typically do not inject filters for inserts; writes are validated by separate preconditions or postconditionScript. If your policy encodes write-scope, author UPDATE/DELETE rules to guard modifications rather than CREATE, unless your domain enforces ownership/tenant on insert.</p>
</li>
<li>
<p>update / merge / set / bulk set: the security filters are ANDed into the target selection so only documents visible under the policy are affected.</p>
</li>
<li>
<p>delete (by id or by query): security filters are applied to the selection to prevent deleting outside the allowed scope.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementation reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Repositories call into RuleContext to augment filters</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Filter</span>&gt; filters = ruleContext.getFilters(baseFilters,
    SecurityContext.getPrincipalContext().get(),
    SecurityContext.getResourceContext().get(),
    getPersistentClass());
<span class="predefined-type">Query</span>&lt;T&gt; query = datastore.find(getPersistentClass()).filter(filters.toArray(<span class="keyword">new</span> <span class="predefined-type">Filter</span>[<span class="integer">0</span>]));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filters are applied regardless of whether the match decision was ALLOW or DENY; only ALLOW rules contribute filters. DENY rules decide the outcome but do not add filters.</p>
</li>
<li>
<p>finalRule: true stops evaluating later rules for both decision and filter contribution.</p>
</li>
<li>
<p>If no ALLOW rules match, repositories may still execute with caller-provided filters, but upstream permission checks should have DENIED the action; by convention, most endpoints call checkRules and short-circuit DENY before hitting the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example impact per MorphiaRepo method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>save: no security filters are injected into the insert operation; enforce ownership/tenant fields via model validation and/or postconditionScript.</p>
</li>
<li>
<p>find/findById: adds security filters; if the requested id is outside scope, the result is empty.</p>
</li>
<li>
<p>getList/getListByQuery: adds security filters to user-supplied query; scope cannot be broadened by the client.</p>
</li>
<li>
<p>update/merge: AND the security filters into the update selector; records outside scope are unaffected.</p>
</li>
<li>
<p>delete: AND the security filters into the delete selector; out-of-scope records are not removed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">refName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">defaultUserPolicy</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">displayName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default user policy</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">principalId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Users can act on their own data; deny dangerous ops in security area</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">rules</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">view-own-resources</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Limit reads to owner and default data segment</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">securityURI</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">identity</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">area</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">functionalDomain</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>:   { <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">accountNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ownerId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> }
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">andFilterString</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dataDomain.ownerId:${principalId}&amp;&amp;dataDomain.dataSegment:#0</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">priority</span><span class="delimiter">&quot;</span></span>: <span class="integer">300</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">finalRule</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>
    },
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">deny-delete-in-security</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">securityURI</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">identity</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">area</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">security</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">functionalDomain</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span> },
        <span class="key"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>:   { <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">accountNumber</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ownerId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> }
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">DENY</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">priority</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">finalRule</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>
    }
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_endpoints">22.14.5. Endpoints</h4>
<div class="paragraph">
<p>All endpoints are relative to /security/permission/policies. These are inherited from BaseResource and are consistent across entity resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /list</p>
<div class="ulist">
<ul>
<li>
<p>Query params: skip, limit, filter, sort, projection</p>
</li>
<li>
<p>Returns a Collection&lt;Policy&gt; with paging metadata; respects X-Realm.</p>
</li>
</ul>
</div>
</li>
<li>
<p>GET /id/{id} and GET /id?id=&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Fetch a single Policy by id.</p>
</li>
</ul>
</div>
</li>
<li>
<p>GET /refName/{refName} and GET /refName?refName=&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Fetch a single Policy by refName.</p>
</li>
</ul>
</div>
</li>
<li>
<p>GET /count?filter=&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Returns a CounterResponse with total matching entities.</p>
</li>
</ul>
</div>
</li>
<li>
<p>GET /schema</p>
<div class="ulist">
<ul>
<li>
<p>Returns JSON Schema for Policy.</p>
</li>
</ul>
</div>
</li>
<li>
<p>POST /</p>
<div class="ulist">
<ul>
<li>
<p>Create or upsert a Policy (if id is present and matches an existing entity in the selected realm, it is updated).</p>
</li>
</ul>
</div>
</li>
<li>
<p>PUT /set?id=&#8230;&#8203;&amp;pairs=field:value</p>
<div class="ulist">
<ul>
<li>
<p>Targeted field updates by id. pairs is a repeated query parameter specifying field/value pairs.</p>
</li>
</ul>
</div>
</li>
<li>
<p>PUT /bulk/setByQuery?filter=&#8230;&#8203;&amp;pairs=&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Bulk updates by query. Note: ignoreRules=true is not supported on this endpoint.</p>
</li>
</ul>
</div>
</li>
<li>
<p>PUT /bulk/setByIds</p>
<div class="ulist">
<ul>
<li>
<p>Bulk updates by list of ids posted in the request body.</p>
</li>
</ul>
</div>
</li>
<li>
<p>PUT /bulk/setByRefAndDomain</p>
<div class="ulist">
<ul>
<li>
<p>Bulk updates by a list of (refName, dataDomain) pairs in the request body.</p>
</li>
</ul>
</div>
</li>
<li>
<p>DELETE /id/{id} (or /id?id=&#8230;&#8203;)</p>
<div class="ulist">
<ul>
<li>
<p>Delete by id.</p>
</li>
</ul>
</div>
</li>
<li>
<p>DELETE /refName/{refName} (or /refName?refName=&#8230;&#8203;)</p>
<div class="ulist">
<ul>
<li>
<p>Delete by refName.</p>
</li>
</ul>
</div>
</li>
<li>
<p>CSV import/export endpoints for bulk operations:</p>
<div class="ulist">
<ul>
<li>
<p>GET /csv – export as CSV (field selection, encoding, etc.)</p>
</li>
<li>
<p>POST /csv – import CSV into Policies</p>
</li>
<li>
<p>POST /csv/session – analyze CSV and create an import session (preview)</p>
</li>
<li>
<p>POST /csv/session/{sessionId}/commit – commit a previously analyzed session</p>
</li>
<li>
<p>DELETE /csv/session/{sessionId} – cancel a session</p>
</li>
<li>
<p>GET /csv/session/{sessionId}/rows – page through analyzed rows</p>
</li>
</ul>
</div>
</li>
<li>
<p>Index management (admin only):</p>
<div class="ulist">
<ul>
<li>
<p>POST /indexes/ensureIndexes/{realm}?collectionName=policy</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authorization: Bearer &lt;token&gt;</p>
</li>
<li>
<p>X-Realm: realm identifier (optional but recommended in multi-tenant deployments)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Filtering and sorting:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>filter uses the ANTLR-based DSL (see REST CRUD &gt; Query Language)</p>
</li>
<li>
<p>sort uses comma-separated fields with optional +/- prefix; projection accepts a comma-separated field list</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_examples">22.14.6. Examples</h4>
<div class="ulist">
<ul>
<li>
<p>Create or update a Policy</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -H &quot;X-Realm: system-com&quot; \
  https://host/api/security/permission/policies \
  -d @policy.json</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List policies for principalId=user</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: system-com&quot; \
     &quot;https://host/api/security/permission/policies/list?filter=principalId:'user'&amp;sort=+refName&amp;limit=50&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete a policy by refName</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X DELETE \
  -H &quot;Authorization: Bearer $JWT&quot; \
  -H &quot;X-Realm: system-com&quot; \
  &quot;https://host/api/security/permission/policies/refName/defaultUserPolicy&quot;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_changes_affect_rule_bases_and_enforcement">22.14.7. How changes affect rule bases and enforcement</h4>
<div class="ulist">
<ul>
<li>
<p>Persistence vs. in-memory rules:</p>
</li>
<li>
<p>PolicyResource updates the persistent store of policies (one policy per principalId or role with a list of rules).</p>
</li>
<li>
<p>RuleContext is the in-memory evaluator used by repositories and resources to enforce permissions. It matches SecurityURIHeader/Body, orders rules by priority, and applies effects and filters.</p>
</li>
<li>
<p>Making persisted policy changes effective:</p>
</li>
<li>
<p>On startup, migrations (see InitializeDatabase and AddAnonymousSecurityRules) typically seed default policies and/or programmatically add rules to RuleContext.</p>
</li>
<li>
<p>When you modify policies via REST, you have two options to apply them at runtime:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement a reload step that reads policies from PolicyRepo and rehydrates RuleContext (for example, RuleContext.clear(); then add rules built from current policies).</p>
</li>
<li>
<p>Restart the service or trigger whatever policy-loader your application uses at boot.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Tip: If you maintain a background watcher or admin endpoint to refresh policies, keep it tenant/realm-aware and idempotent.</p>
</li>
<li>
<p>Evaluation semantics (recap):</p>
</li>
<li>
<p>Rules are sorted by ascending priority; the first decisive rule sets the outcome. finalRule=true stops further processing.</p>
</li>
<li>
<p>andFilterString/orFilterString contribute repository filters through RuleContext.getFilters(), constraining result sets and write scopes.</p>
</li>
<li>
<p>principalId can be a concrete userId or a role; RuleContext considers both the principal and all associated roles.</p>
</li>
<li>
<p>Safe rollout:</p>
</li>
<li>
<p>Create new policies with a higher numeric priority (lower precedence) first, test with GET /schema and dry-run queries.</p>
</li>
<li>
<p>Use realm scoping via X-Realm to stage changes in a non-production realm.</p>
</li>
<li>
<p>Prefer DENY with low priority numbers for critical protections.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also:
- Permissions: Matching Algorithm, Priorities, and Multiple Matching RuleBases (sections above)
- REST CRUD: Query Language and generic endpoint behaviors</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_realm_override_x_realm_and_impersonation_x_impersonate">22.15. Realm override (X-Realm) and Impersonation (X-Impersonate)</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-04369f6fc7778d6745830bc098403f15.svg" alt="Diagram" width="1085" height="535">
</div>
</div>
<div class="paragraph">
<p>This section explains how to use the request headers X-Realm, X-Impersonate-<strong>, and X-Acting-On-Behalf-Of-</strong> alongside permission rule bases. These headers influence which realm (database) a request operates against and, in the case of impersonation, which identity&#8217;s roles are evaluated by the rule engine.</p>
</div>
<div class="sect3">
<h4 id="_what_they_do_at_a_glance">22.15.1. What they do (at a glance)</h4>
<div class="ulist">
<ul>
<li>
<p>X-Realm: Overrides the target realm (MongoDB database) used by repositories for this request. Your own identity and roles remain the same. <strong>The DataDomain is updated to the target realm&#8217;s default DomainContext</strong> (while preserving your userId as the ownerId). This ensures that data created via X-Realm is properly scoped to the target realm&#8217;s tenant/org structure.</p>
</li>
<li>
<p>X-Impersonate-Subject or X-Impersonate-UserId: Causes the request to run as another identity. The effective permissions become those of the impersonated identity (potentially more or less than your own). This is analogous to sudo on Unix or to "simulate a user/role" for troubleshooting.</p>
</li>
<li>
<p>X-Acting-On-Behalf-Of-Subject or X-Acting-On-Behalf-Of-UserId: Records that the caller is acting on behalf of another party (for audit/tracking purposes). Unlike impersonation, this does NOT change permissions—the caller retains their own identity and roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Only one of X-Impersonate-Subject or X-Impersonate-UserId may be supplied per request. Supplying both results in a 400/IllegalArgumentException.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_the_headers_integrate_with_permission_evaluation">22.15.2. How the headers integrate with permission evaluation</h4>
<div class="ulist">
<ul>
<li>
<p>Rule matching and effects (ALLOW/DENY) still follow the standard algorithm described earlier.</p>
</li>
<li>
<p>With X-Realm (no impersonation):</p>
</li>
<li>
<p>The PrincipalContext.defaultRealm is set to the header value (after validation), and repositories operate in that realm.</p>
</li>
<li>
<p><strong>The DataDomain is updated</strong> from the target realm&#8217;s DomainContext (org, tenant, account, dataSegment), while preserving your userId as the ownerId.</p>
</li>
<li>
<p>Your own roles and identity remain intact; the rule base is evaluated for your identity and roles but with the target realm&#8217;s data context.</p>
</li>
<li>
<p>Permission filter strings can use <code>${defaultRealm}</code> to dynamically scope queries based on the active realm.</p>
</li>
<li>
<p>With impersonation:</p>
</li>
<li>
<p>The PrincipalContext is rebuilt from the impersonated user&#8217;s credential. The effective roles used by the rule engine include the impersonated user&#8217;s roles; the platform also merges in the caller&#8217;s security roles from Quarkus SecurityIdentity. This means permissions can be a superset; design policy rules accordingly.</p>
</li>
<li>
<p>The effective realm for the request is set to the impersonated user&#8217;s default realm (not the X-Realm header). If you passed X-Realm, it is still validated (see below) but not used to override the impersonated default realm in the current implementation.</p>
</li>
<li>
<p>The DataDomain is set from the impersonated user&#8217;s DomainContext.</p>
</li>
<li>
<p>With Acting-On-Behalf-Of:</p>
</li>
<li>
<p>The caller retains their own identity, roles, realm, and DataDomain.</p>
</li>
<li>
<p>The X-Acting-On-Behalf-Of-Subject or X-Acting-On-Behalf-Of-UserId is recorded in the PrincipalContext for audit purposes.</p>
</li>
<li>
<p>This is useful for service-to-service calls or when a support agent needs to perform actions that should be attributed to a customer.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_required_credential_configuration_credentialuseridpassword">22.15.3. Required credential configuration (CredentialUserIdPassword)</h4>
<div class="paragraph">
<p>Two fields on CredentialUserIdPassword govern whether a user may use these headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>realmRegEx (for X-Realm):</p>
</li>
<li>
<p>A wildcard pattern ("*" matches any sequence; case-insensitive) listing the realms a user is allowed to target with X-Realm.</p>
</li>
<li>
<p>If X-Realm is present but realmRegEx is null/blank or does not match the requested realm, the server returns 403 Forbidden.</p>
</li>
<li>
<p>Examples:</p>
</li>
<li>
<p>"*" → allow any realm</p>
</li>
<li>
<p>"acme-*" → allow realms that start with acme-</p>
</li>
<li>
<p>"dev|stage|prod" is not supported as-is; use wildcards like "dev*" and "stage*" or a combined pattern like "(dev|stage|prod)" only if you store a true regex. The current validator replaces '<strong>' with ".</strong>" and matches case-insensitively.</p>
</li>
<li>
<p>impersonateFilterScript (for X-Impersonate-*):</p>
</li>
<li>
<p>A JavaScript snippet executed by the server (GraalVM) that must return a boolean. It receives three variables: username (the caller’s subject), userId (caller’s userId), and realm (the requested realm or current DB name).</p>
</li>
<li>
<p>If the script evaluates to false, the server returns 403 Forbidden for impersonation.</p>
</li>
<li>
<p>If the script is missing (null) and you attempt impersonation, the server rejects the request with 400/IllegalArgumentException.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example impersonation script (allow only company admins to impersonate in dev realms):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// username = caller's subject, userId = caller's userId, realm = requested realm (or current)</span>
(username.endsWith(<span class="string"><span class="delimiter">'</span><span class="content">@acme.com</span><span class="delimiter">'</span></span>) &amp;&amp; realm.startsWith(<span class="string"><span class="delimiter">'</span><span class="content">dev-</span><span class="delimiter">'</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tip: Manage these two fields via your auth provider’s admin APIs or directly through CredentialRepo in controlled environments.</p>
</div>
</div>
<div class="sect3">
<h4 id="_end_to_end_behavior_from_securityfilter_reference">22.15.4. End-to-end behavior from SecurityFilter (reference)</h4>
<div class="paragraph">
<p>The SecurityFilter constructs the PrincipalContext/ResourceContext before rule evaluation:
- X-Realm is read and, if present, validated against the caller’s credential.realmRegEx.
- If impersonation headers are present:
  - The caller’s credential.impersonateFilterScript is executed. If it returns true, the impersonated user’s credential is loaded and used to build the PrincipalContext.
  - The final PrincipalContext carries the impersonated user’s defaultRealm and roles (merged with the caller’s SecurityIdentity roles), and may copy area2RealmOverrides from the impersonated credential.
- Without impersonation, the PrincipalContext is built from the caller’s credential; X-Realm, when valid, sets the defaultRealm for this request.</p>
</div>
</div>
<div class="sect3">
<h4 id="_practical_differences_and_use_cases">22.15.5. Practical differences and use cases</h4>
<div class="ulist">
<ul>
<li>
<p>Realm override (X-Realm):</p>
</li>
<li>
<p>Who you are does not change; only where you act changes. Your permissions (as determined by policies attached to your identity/roles) are applied against data in the specified realm.</p>
</li>
<li>
<p><strong>DataDomain changes</strong>: The DataDomain is updated from the target realm&#8217;s DomainContext (tenant, org, account), ensuring new records are created with the correct scoping.</p>
</li>
<li>
<p>Use cases:</p>
</li>
<li>
<p>Multi-tenant admin tooling that needs to inspect or repair data in customer realms.</p>
</li>
<li>
<p>Reporting or backfills where the same service is pointed at different tenant databases per request.</p>
</li>
<li>
<p>Creating data in a target realm with proper DataDomain stamping.</p>
</li>
<li>
<p>Impersonation (X-Impersonate-*):</p>
</li>
<li>
<p>Who you are (for authorization purposes) changes. You act with the impersonated identity&#8217;s permissions; depending on your configuration, additional caller roles may be merged.</p>
</li>
<li>
<p>The DataDomain is set from the impersonated user&#8217;s credential.</p>
</li>
<li>
<p>Use cases:</p>
</li>
<li>
<p>Temporary elevation to an admin identity (sudo-like) for break-glass operations.</p>
</li>
<li>
<p>Simulate what a given role/identity can see/do for troubleshooting or customer support.</p>
</li>
<li>
<p>Testing user-specific permission rules without logging in as that user.</p>
</li>
<li>
<p>Acting-On-Behalf-Of (X-Acting-On-Behalf-Of-*):</p>
</li>
<li>
<p>Who you are does NOT change; you retain your own identity, roles, realm, and DataDomain.</p>
</li>
<li>
<p>The "acting on behalf of" information is recorded in the PrincipalContext for audit trails.</p>
</li>
<li>
<p>Use cases:</p>
</li>
<li>
<p>Service-to-service calls where the downstream service needs to know the original requestor.</p>
</li>
<li>
<p>Support agents performing actions that should be audited as being done "on behalf of" a customer.</p>
</li>
<li>
<p>Compliance and audit requirements where the chain of delegation must be recorded.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caveats:
- Never set a permissive impersonateFilterScript in production. Keep it restrictive and auditable.
- When using both X-Realm and impersonation in one call, be aware that the effective realm will be the impersonated user&#8217;s default realm; X-Realm is not applied in the impersonation branch in the current implementation.
- realmRegEx must be populated for any user who needs realm override; leaving it blank effectively disables X-Realm for that user.
- Acting-On-Behalf-Of headers do NOT grant any additional permissions; they are purely for audit purposes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_examples_2">22.15.6. Examples</h4>
<div class="ulist">
<ul>
<li>
<p>List policies in a different realm using your own identity</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: acme-prod&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&amp;sort=+refName&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Simulate another user by subject while staying in their default realm</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Impersonate-Subject: 3d8f4e7b-...-idp-subject&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&quot;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Attempt impersonation with a realm hint (validated by script; effective realm = impersonated default)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -H &quot;Authorization: Bearer $JWT&quot; \
     -H &quot;X-Realm: dev-acme&quot; \
     -H &quot;X-Impersonate-UserId: tenant-admin&quot; \
     &quot;https://host/api/security/permission/policies/list?limit=20&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Security outcomes in all cases continue to be driven by your rule bases (Policy rules) matched against the effective PrincipalContext and ResourceContext.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_domain_assignment_on_create_domaincontext_and_datadomainpolicy">22.16. Data domain assignment on create: DomainContext and DataDomainPolicy</h3>
<div id="_data_domain_assignment" class="paragraph">
<p>This section explains how Quantum decides which dataDomain is stamped on newly created records, why this decision is necessary in a multi‑tenant system, what the default behavior is, and how you can override it globally or per Functional Area / Functional Domain. It also describes the DataDomainResolver interface and the default implementation provided by the framework.</p>
</div>
<div class="sect3">
<h4 id="_the_problem_this_solves_and_why_it_matters">22.16.1. The problem this solves (and why it matters)</h4>
<div class="paragraph">
<p>In a multi‑tenant platform you must ensure each new record is written to the correct data partition so later reads/updates can be scoped safely. If the dataDomain is wrong or missing, you risk leaking data across tenants or making your own data inaccessible due to mis‑scoping.</p>
</div>
<div class="paragraph">
<p>Historically, Quantum set the dataDomain of new entities to match the creator’s credential (i.e., the principal’s DomainContext → DataDomain). That default is sensible in many cases, but real systems often need more specific behavior per business area or type. For example:
- You may centralize HR records in a single org‑level domain regardless of who created them.
- Sales invoices for EU customers must live under an EU data segment.
- A specific product area might always write into a shared catalog domain separate from the author’s tenant.</p>
</div>
<div class="paragraph">
<p>These needs require a simple, deterministic way to override the default per Functional Area and/or Functional Domain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_key_concepts_recap_domaincontext_and_datadomain">22.16.2. Key concepts recap: DomainContext and DataDomain</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">DomainContext (on credentials/realms)</dt>
<dd>
<p>captures the principal’s scoping defaults (realm, org/account/tenant identifiers, data segment). At request time this is materialized into a DataDomain.</p>
</dd>
<dt class="hdlist1">DataDomain</dt>
<dd>
<p>is what gets stamped onto persisted entities and later used by repositories to constrain queries and updates.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you do nothing, new records inherit the principal’s DataDomain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_default_policy_do_nothing_and_it_works">22.16.3. The default policy (do nothing and it works)</h4>
<div class="paragraph">
<p>Out of the box, Quantum preserves the existing behavior: if no policy is configured, the resolver falls back to the authenticated principal’s DataDomain. This guarantees compatibility with existing applications.</p>
</div>
<div class="paragraph">
<p>Concretely:
- ValidationInterceptor checks if an entity being persisted lacks a dataDomain.
- If missing, it calls DataDomainResolver.resolveForCreate(area, domain).
- The DefaultDataDomainResolver first looks for overrides (credential‑attached or global); if none match, it returns the principal’s DataDomain from the current SecurityContext.</p>
</div>
</div>
<div class="sect3">
<h4 id="_policy_scopes_principalattached_vs_global">22.16.4. Policy scopes: principal‑attached vs. global</h4>
<div class="paragraph">
<p>You can define overrides at two levels:
- Principal‑attached (per credential): attach a DataDomainPolicy to a CredentialUserIdPassword. The SecurityFilter places this policy into the PrincipalContext, so it applies only to records created by that principal. This is useful for VIP service accounts or specific partners.
- Global policy: an application‑wide DataDomainPolicy provided by GlobalDataDomainPolicyProvider. If present, this applies when the principal has no specific override for the matching area/domain.</p>
</div>
<div class="paragraph">
<p>Precedence: principal‑attached policy wins over global policy; if neither applies, fall back to the principal’s credential domain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_policy_map_and_matching">22.16.5. The policy map and matching</h4>
<div class="paragraph">
<p>A DataDomainPolicy is a small map of rules: Map&lt;String, DataDomainPolicyEntry&gt; policyEntries, keyed by "&lt;FunctionalArea&gt;:&lt;FunctionalDomain&gt;" with support for "*" wildcards. The resolver evaluates keys in this order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>area:domain (most specific)</p>
</li>
<li>
<p>area:*</p>
</li>
<li>
<p>*:domain</p>
</li>
<li>
<p><strong>:</strong> (global catch‑all)</p>
</li>
<li>
<p>Fallback to principal’s domain if no entry yields a value</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each DataDomainPolicyEntry has a resolutionMode:
- FROM_CREDENTIAL (default): use the principal’s credential domain (i.e., the historical behavior).
- FIXED: use the first DataDomain listed in dataDomains on the entry.</p>
</div>
<div class="paragraph">
<p>Example policy definitions (illustrative JSON):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">policyEntries</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Sales:Invoice</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FIXED</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataDomains</span><span class="delimiter">&quot;</span></span>: [ {<span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ACME</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">eu-1</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">INVOICE</span><span class="delimiter">&quot;</span></span>} ] },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">Sales:*</span><span class="delimiter">&quot;</span></span>:      { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_CREDENTIAL</span><span class="delimiter">&quot;</span></span> },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">*:HR</span><span class="delimiter">&quot;</span></span>:         { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FIXED</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataDomains</span><span class="delimiter">&quot;</span></span>: [ {<span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">GLOBAL</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hr</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dataSegment</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">HR</span><span class="delimiter">&quot;</span></span>} ] },
    <span class="key"><span class="delimiter">&quot;</span><span class="content">*:*</span><span class="delimiter">&quot;</span></span>:          { <span class="key"><span class="delimiter">&quot;</span><span class="content">resolutionMode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_CREDENTIAL</span><span class="delimiter">&quot;</span></span> }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior of the above:
- Sales:Invoice records always go to the fixed EU invoices domain.
- Any other Sales:* creation uses the creator’s credential domain.
- All HR records go to a central HR domain.
- Otherwise, default to the creator’s domain.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-d1a19bafd9bcbe906d9469e35b37f41e.svg" alt="Diagram" width="596" height="481">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_the_resolver_works">22.16.6. How the resolver works</h4>
<div class="paragraph">
<p>Interfaces and default implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">DataDomainResolver</span> {
  DataDomain resolveForCreate(<span class="predefined-type">String</span> functionalArea, <span class="predefined-type">String</span> functionalDomain);
}

<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultDataDomainResolver</span> <span class="directive">implements</span> DataDomainResolver {
  <span class="annotation">@Inject</span> GlobalDataDomainPolicyProvider globalPolicyProvider;
  <span class="directive">public</span> DataDomain resolveForCreate(<span class="predefined-type">String</span> area, <span class="predefined-type">String</span> domain) {
    DataDomain principalDD = SecurityContext.getPrincipalDataDomain()
      .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Principal context not providing a data domain</span><span class="delimiter">&quot;</span></span>));
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keys = <span class="predefined-type">List</span>.of(areaOrStar(area)+<span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span>+areaOrStar(domain), areaOrStar(area)+<span class="string"><span class="delimiter">&quot;</span><span class="content">:*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">*:</span><span class="delimiter">&quot;</span></span>+areaOrStar(domain), <span class="string"><span class="delimiter">&quot;</span><span class="content">*:*</span><span class="delimiter">&quot;</span></span>);
    <span class="comment">// 1) principal‑attached policy from PrincipalContext</span>
    DataDomain fromPrincipal = resolveFrom(policyFromPrincipal(), keys, principalDD);
    <span class="keyword">if</span> (fromPrincipal != <span class="predefined-constant">null</span>) <span class="keyword">return</span> fromPrincipal;
    <span class="comment">// 2) global policy</span>
    DataDomain fromGlobal = resolveFrom(globalPolicyProvider.getPolicy().orElse(<span class="predefined-constant">null</span>), keys, principalDD);
    <span class="keyword">if</span> (fromGlobal != <span class="predefined-constant">null</span>) <span class="keyword">return</span> fromGlobal;
    <span class="comment">// 3) default fallback</span>
    <span class="keyword">return</span> principalDD;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Integration point:
- ValidationInterceptor injects DataDomainResolver and calls it in prePersist when an entity’s dataDomain is null.
- SecurityFilter propagates a principal’s attached DataDomainPolicy (if any) into the PrincipalContext so the resolver can see it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_when_would_you_want_a_nonglobal_policy">22.16.7. When would you want a non‑global policy?</h4>
<div class="paragraph">
<p>Here are a few concrete scenarios:
- Centralized HR: All HR Employee records are written to a shared HR domain regardless of the team creating them. This supports a shared‑service HR model without duplicating HR data per tenant.
- Regulated invoices: In the Sales:Invoice domain for EU, you must write under a specific EU tenantId/dataSegment to satisfy data residency. Other Sales domains can keep default behavior.
- Shared catalog: The Catalog:Item domain is a cross‑tenant shared catalog maintained by a core team. Writes should go to a canonical catalog domain even when initiated by tenant‑specific users.
- VIP account override: A particular integration user should always write to a staging domain for testing purposes, while all others use defaults. Attach a small policy to just that credential.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relation_to_tenancy_models">22.16.8. Relation to tenancy models</h4>
<div class="paragraph">
<p>The policy mechanism supports both siloed and pooled tenancy:
- Siloed tenancy: Most domains default to FROM_CREDENTIAL (each tenant writes to its own partition). Only a few shared services (e.g., HR, catalog) use FIXED to centralize data.
- Pooled tenancy: You may lean on FIXED policies more often to route writes into pooled/segment‑specific domains (e.g., region, product line), while still enforcing read/write scoping via permissions.</p>
</div>
<div class="paragraph">
<p>Because the resolver always validates through the principal context and falls back safely, you can introduce overrides gradually without destabilizing existing flows.</p>
</div>
</div>
<div class="sect3">
<h4 id="_authoring_tips">22.16.9. Authoring tips</h4>
<div class="ulist">
<ul>
<li>
<p>Start with no policy and verify your default flows. Add entries only where necessary.</p>
</li>
<li>
<p>Prefer specific keys (area:domain) for clarity; use wildcards sparingly.</p>
</li>
<li>
<p>Keep FIXED DataDomain objects minimal and valid for your deployment (orgRefName, tenantId, and dataSegment as needed).</p>
</li>
<li>
<p>Document any global policy so teams know which areas are centralized.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_api_pointers">22.16.10. API pointers</h4>
<div class="ulist">
<ul>
<li>
<p>CredentialUserIdPassword.dataDomainPolicy: optional per‑credential overrides (propagated to PrincipalContext).</p>
</li>
<li>
<p>GlobalDataDomainPolicyProvider: holds an optional in‑memory global policy (null by default).</p>
</li>
<li>
<p>DataDomainPolicyEntry.resolutionMode: FROM_CREDENTIAL (default) or FIXED.</p>
</li>
<li>
<p>DataDomainResolver / DefaultDataDomainResolver: the extension point and default behavior.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ontology-permissions">22.16.11. Ontology in Permission Rules (optional)</h4>
<div class="paragraph">
<p>If you enable the ontology modules, you can author rules that constrain access by semantic relationships, not field paths. This keeps policies stable as your object model evolves.</p>
</div>
<div class="paragraph">
<p>Key idea</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Materialize edges in Mongo using OntologyMaterializer (e.g., placedInOrg, orderShipsToRegion).</p>
</li>
<li>
<p>During rule evaluation, translate a semantic constraint like "has edge placedInOrg to OrgX" into a set of IDs, and combine that with your query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to use</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preferred: author a rule with a semantic hint and let the application translate it via ListQueryRewriter.</p>
</li>
<li>
<p>Minimal change path: publish a variable via an AccessListResolver and use an IN filter over _id.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example (resolver + IN filter)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add an AccessListResolver that returns order IDs for which (tenantId, p="placedInOrg", dst=orgRefName) exists.</p>
</li>
<li>
<p>In your rule’s AND filter string (query language), use: id:^${idsByPlacedInOrg}</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ontology overview and examples: <a href="ontology.html">Ontologies in Quantum</a></p>
</li>
<li>
<p>Integration with Morphia and multi-tenancy: <a href="ontology.html#ontology-integration-morphia-permissions">Integrating Ontology</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ontology is optional. Enable it per service when the config flag and dependencies are present.</p>
</li>
<li>
<p>Always scope edge queries by tenantId sourced from RuleContext.</p>
</li>
<li>
<p>Index edges on (tenantId, p, dst) and (tenantId, src, p) for performance.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="rule-hasedge">Rule language: add hasEdge()</h5>
<div class="paragraph">
<p>We introduce a policy function/operator to reference ontology edges directly from rules. This lets policies constrain access by semantic relationships instead of field paths.</p>
</div>
<div class="paragraph">
<p>Signature</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasEdge(predicate, dstIdOrVar)</p>
</li>
<li>
<p>hasIncomingEdge(predicate, srcIdOrVar)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Parameters</p>
</div>
<div class="ulist">
<ul>
<li>
<p>predicate: String name of the ontology predicate (e.g., "placedInOrg", "orderShipsToRegion").</p>
</li>
<li>
<p>dstIdOrVar / srcIdOrVar: Either a concrete id/refName or a variable resolved from RuleContext (e.g., principal.orgRefName, request.region, ${principalId}).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Semantics</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>hasEdge</strong>: The rule grants/filters entities (sources) for which an edge exists: (tenantId, src = entity._id, p = predicate, dst = resolvedDst).</p>
</li>
<li>
<p><strong>hasIncomingEdge</strong>: The rule grants/filters entities (targets) for which an edge exists: (tenantId, src = resolvedSrc, p = predicate, dst = entity._id). Useful for finding entities that are destinations of a relationship (e.g., "find locations reachable FROM an associate").</p>
</li>
<li>
<p>Multi-tenant safety: tenantId is always taken from RuleContext/DomainContext.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Composition</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasEdge and hasIncomingEdge can be combined with existing rule clauses (and/or/not) and other filters (states, tags, ownerId, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow viewing Orders in the caller’s org (including ancestors via ontology closure):</p>
</li>
<li>
<p>allow VIEW Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Restrict list to Orders shipping to a region chosen in request:</p>
</li>
<li>
<p>allow LIST Order when hasEdge("orderShipsToRegion", request.region)</p>
</li>
<li>
<p>Allow viewing Locations reachable from the current user:</p>
</li>
<li>
<p>allow VIEW Location when hasIncomingEdge("canAccessLocation", ${principalId})</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <code>andFilterString</code> and <code>orFilterString</code>, use standard BIAPI syntax for these functions: <code>hasEdge(predicate, dst)</code> and <code>hasIncomingEdge(predicate, src)</code>. In <code>postconditionScript</code>, use the JavaScript helper counterparts: <code>hasEdge(predicate, dst)</code> and <code>hasIncomingEdge(predicate, src)</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Under the hood</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Policy evaluation resolves dstIdOrVar / srcIdOrVar against RuleContext (for example, principal.orgRefName → "OrgP").</p>
</li>
<li>
<p>The list/filter query is rewritten using ListQueryRewriter.rewriteForHasEdge(&#8230;&#8203;) or rewriteForHasIncomingEdge(&#8230;&#8203;), which turns the predicate and resolved ID into a set of target/source IDs and merges it with the base query efficiently.</p>
</li>
<li>
<p>OntologyEdgeDao must be indexed on (tenantId, p, dst) and (tenantId, src, p) for performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Full end-to-end example (implementation pattern)</p>
</div>
<div class="paragraph">
<p>1) Author a rule (illustrative YAML/pseudocode)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: list-orders-by-org</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">100</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">USER</span></span>
      <span class="key">area</span>: <span class="string"><span class="content">sales</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">order</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">list</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="comment"># Semantic constraint expressed via ontology helper in postconditionScript</span>
  <span class="key">postconditionScript</span>: <span class="string"><span class="content">hasEdge(&quot;placedInOrg&quot;, pcontext?.dataDomain?.orgRefName) === true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another example using <code>hasIncomingEdge</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: view-reachable-locations</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">110</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">USER</span></span>
      <span class="key">area</span>: <span class="string"><span class="content">core</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">location</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="comment"># Find locations that the current user has a &quot;canAccessLocation&quot; edge to</span>
  <span class="key">andFilterString</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">hasIncomingEdge(canAccessLocation, ${principalId})</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Evaluate policy and apply constraint in the repository/list path</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.ontology.policy.ListQueryRewriter</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.repo.OntologyEdgeRepo</span>;
<span class="keyword">import</span> <span class="include">com.mongodb.client.model.Filters</span>;
<span class="keyword">import</span> <span class="include">org.bson.conversions.Bson</span>;

<span class="comment">// Injected once per service when ontology is enabled (Quarkus CDI)</span>
<span class="annotation">@jakarta</span>.inject.Inject OntologyEdgeDao edgeDao;
ListQueryRewriter rewriter = <span class="keyword">new</span> ListQueryRewriter(edgeDao);

<span class="comment">// Inside your list method, after building the base filter</span>
<span class="predefined-type">String</span> tenantId = ruleContext.getRealmId(pctx, rctx); <span class="comment">// or from DomainContext</span>
<span class="predefined-type">String</span> predicate = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">String</span> orgRefName = pctx.getDataDomain().getOrgRefName(); <span class="comment">// resolves principal.orgRefName</span>

Bson base = Filters.and(existingFilters...);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, predicate, orgRefName);
<span class="type">var</span> results = datastore.getDatabase().getCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>).find(rewritten).iterator();

<span class="comment">// Example for hasIncomingEdge in code</span>
Bson locationRewritten = rewriter.rewriteForHasIncomingEdge(locationBase, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">canAccessLocation</span><span class="delimiter">&quot;</span></span>, principalId);</code></pre>
</div>
</div>
<div class="paragraph">
<p>3) Morphia-typed queries alternative</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// If you’re using Morphia’s typed Query API</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; ids = edgeDao.srcIdsByDst(tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgRefName);
<span class="keyword">if</span> (ids.isEmpty()) {
  <span class="keyword">return</span> java.util.List.of(); <span class="comment">// short-circuit</span>
}
query.filter(dev.morphia.query.filters.Filters.in(<span class="string"><span class="delimiter">&quot;</span><span class="content">_id</span><span class="delimiter">&quot;</span></span>, ids));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Developer requirements and checklist</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable ontology (optional feature): set e2eq.ontology.enabled=true in your app and add module dependencies.</p>
</li>
<li>
<p>Provide a TBox (OntologyRegistry) and run OntologyMaterializer on entity changes to keep edges up to date.</p>
</li>
<li>
<p>Inject EdgeDao as a CDI bean (@Inject); indexes are ensured automatically at startup.</p>
</li>
<li>
<p>Always pass tenantId from RuleContext/DomainContext; never cross tenants.</p>
</li>
<li>
<p>When using variables on the RHS (dstIdOrVar), ensure the RuleContext exposes them (for example, principal.orgRefName or request.region).</p>
</li>
<li>
<p>Monitor provenance (edge.prov) and re-materialize edges when intermediate nodes change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasEdge() is a policy function; it is evaluated before constructing database filters. It is not part of the core BIAPI query grammar.</p>
</li>
<li>
<p>If ontology is disabled, skip the rewrite (return base) or configure a no-op implementation so policies that include hasEdge are rejected early with a clear error message.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="label-resolution-spi">22.16.12. Label resolution SPI and hasLabel() in rules</h4>
<div class="paragraph">
<p>Labels are a lightweight way to attach semantic markers to principals and resources, and then use them in rule scripts. Quantum provides a pluggable label resolution SPI and a script helper to check labels during policy evaluation.</p>
</div>
<div class="paragraph">
<p>Why labels?
- Decouple policy from rigid fields (e.g., “VIP”, “HARD_DELETE_DISABLED”, “B2B”).
- Compute labels from multiple sources (simple tags, advancedTags, dynamic attributes, or custom derivations).</p>
</div>
<div class="paragraph">
<p>Components</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LabelResolver (SPI):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">LabelResolver</span> {
  <span class="type">boolean</span> supports(<span class="predefined-type">Class</span>&lt;?&gt; type);
  java.util.Set&lt;<span class="predefined-type">String</span>&gt; resolveLabels(<span class="predefined-type">Object</span> entity);
}</code></pre>
</div>
</div>
</li>
<li>
<p>DefaultLabelResolver (built-in): Applies to UnversionedBaseModel.</p>
</li>
<li>
<p>Collects tags (String[]), advancedTags.name, and optionally any dynamicAttributes whose isInheritable()==true, using best‑effort reflection.</p>
</li>
<li>
<p>LabelService: Aggregates all LabelResolver beans via CDI and delegates to the first that supports the entity type. Also supports annotation-based extraction (see below).</p>
</li>
<li>
<p>Annotations (optional, opt-in at your model):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@LabelSource</span>(method = <span class="string"><span class="delimiter">&quot;</span><span class="content">computeLabels</span><span class="delimiter">&quot;</span></span>) <span class="comment">// class-level method returning Collection&lt;String&gt;, String[], or String</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyEntity</span> { ... }

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyEntity</span> {
  <span class="annotation">@LabelField</span>                <span class="comment">// field can be Collection&lt;String&gt;, String[], or String</span>
  <span class="directive">private</span> java.util.List&lt;<span class="predefined-type">String</span>&gt; policyLabels;
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Availability in rule scripts</p>
</div>
<div class="paragraph">
<p>During policy evaluation, RuleContext resolves labels for both principal and resource contexts and installs a script helper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasLabel(label: String) → Boolean</p>
</li>
<li>
<p>Returns true if the current resource context has the specified label.</p>
</li>
<li>
<p>Label resolution uses LabelService (including custom resolvers and annotations) at evaluation time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples (postcondition script)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Allow if the resource is labeled VIP</span>
hasLabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">VIP</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Combine with other helpers when ontology is enabled</span>
hasLabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">RESTRICTED</span><span class="delimiter">&quot;</span></span>) &amp;&amp; !hasEdge(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgX</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Extending labels for your domain</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a new resolver:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@jakarta</span>.enterprise.context.ApplicationScoped
<span class="directive">public</span> <span class="type">class</span> <span class="class">InvoiceLabelResolver</span> <span class="directive">implements</span> LabelResolver {
  <span class="directive">public</span> <span class="type">boolean</span> supports(<span class="predefined-type">Class</span>&lt;?&gt; type) { <span class="keyword">return</span> type.getName().endsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invoice</span><span class="delimiter">&quot;</span></span>); }
  <span class="directive">public</span> java.util.Set&lt;<span class="predefined-type">String</span>&gt; resolveLabels(<span class="predefined-type">Object</span> entity) {
    <span class="type">var</span> out = <span class="keyword">new</span> java.util.LinkedHashSet&lt;<span class="predefined-type">String</span>&gt;();
    <span class="type">var</span> inv = (com.example.Invoice) entity;
    <span class="keyword">if</span> (inv.isHighValue()) out.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">HIGH_VALUE</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">if</span> (inv.isPastDue()) out.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">PAST_DUE</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> out;
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Or annotate your model with @LabelSource/@LabelField to contribute labels without writing a resolver.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes
- Labels are resolved best‑effort; failures are swallowed to keep policy evaluation robust.
- If multiple resolvers exist, the first that supports the type wins. Prefer narrow supports() checks.
- Keep label names stable; treat them as part of your policy contract.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="script-helpers-reference">22.17. Script Helpers reference (when enabled)</h3>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-0ada0ba001bddd7560ed850e83a62f4a.svg" alt="Diagram" width="1050" height="321">
</div>
</div>
<div class="paragraph">
<p>Script helpers are small functions injected into the postconditionScript environment to make common policy checks concise. They are provided by com.e2eq.ontology.policy.ScriptHelpers.install(&#8230;&#8203;) when the optional ontology/label modules are present. In all cases, postconditionScript also has direct access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pcontext: the Java PrincipalContext for the caller</p>
</li>
<li>
<p>rcontext: a lightweight map for resource-related helper data (labels, types, edges, violations) when populated by your application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Availability notes:
- Labels are made available by RuleContext via LabelService. hasLabel() checks the resource’s labels only.
- Edges, types, and violations must be populated by your application into the rcontext map before calling RuleContext.runScript (typically via an ontology bridge). If absent, edge/type helpers return false/empty.</p>
</div>
<div class="paragraph">
<p>Helpers and examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>isA(type: String) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: Check whether the resource has a semantic type in rcontext.types.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Allow when the resource is of type &quot;Invoice&quot;</span>
isA(<span class="string"><span class="delimiter">&quot;</span><span class="content">Invoice</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</li>
<li>
<p>hasLabel(label: String) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: Check whether the resource has a policy label (labels resolved via LabelService).</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Permit view if resource is labeled PUBLIC</span>
hasLabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">PUBLIC</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</li>
<li>
<p>hasEdge(predicate: String, dst: String|null) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: True if an ontology edge with property p=predicate exists from the current resource to dst. If dst is null, true if any dst exists for the predicate.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Require that this resource is placed in the caller's org</span>
hasEdge(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, pcontext?.dataDomain?.orgRefName)</code></pre>
</div>
</div>
</li>
<li>
<p>hasIncomingEdge(predicate: String, src: String|null) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: True if an ontology edge with property p=predicate exists from src to the current resource. If src is null, true if any src exists for the predicate.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Permit view if the current resource is a location reachable from the caller</span>
hasIncomingEdge(<span class="string"><span class="delimiter">&quot;</span><span class="content">canAccessLocation</span><span class="delimiter">&quot;</span></span>, principalId)</code></pre>
</div>
</div>
</li>
<li>
<p>hasAnyEdge(predicate: String, dsts: Collection&lt;String&gt;) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: True if there is at least one edge to any of the destinations.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Allow if the order ships to any of the selected regions</span>
hasAnyEdge(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, [<span class="string"><span class="delimiter">&quot;</span><span class="content">NA</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EU</span><span class="delimiter">&quot;</span></span>]) === <span class="predefined-constant">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>hasAllEdges(predicate: String, dsts: Collection&lt;String&gt;) &#8594; Boolean</p>
</li>
<li>
<p>Purpose: True only if there is an edge for every destination in the list.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Require all compliance flags to be present</span>
hasAllEdges(<span class="string"><span class="delimiter">&quot;</span><span class="content">hasComplianceFlag</span><span class="delimiter">&quot;</span></span>, [<span class="string"><span class="delimiter">&quot;</span><span class="content">KYC</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">AML</span><span class="delimiter">&quot;</span></span>]) === <span class="predefined-constant">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>relatedIds(predicate: String) &#8594; List&lt;String&gt;</p>
</li>
<li>
<p>Purpose: Return the list of dst ids for edges with property p=predicate.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Use in conjunction with a filter list variable (via AccessListResolver)</span>
<span class="keyword">var</span> projectIds = relatedIds(<span class="string"><span class="delimiter">&quot;</span><span class="content">belongsToProject</span><span class="delimiter">&quot;</span></span>);
projectIds &amp;&amp; projectIds.length &gt; <span class="integer">0</span></code></pre>
</div>
</div>
</li>
<li>
<p>noViolations() &#8594; Boolean</p>
</li>
<li>
<p>Purpose: True if rcontext.violations is empty. Helpful when upstream validators populate violations.</p>
</li>
<li>
<p>Example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// Deny action if any violations were detected earlier in the pipeline</span>
noViolations() === <span class="predefined-constant">true</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Best practices:
- Prefer simple boolean expressions; keep postconditionScript fast and side-effect free.
- When using ontology helpers, always scope your edge materialization by tenantId to avoid cross-tenant leakage.
- Combine helpers with SecurityURIBody scoping and repository filters for defense in depth.</p>
</div>
<div class="paragraph">
<p>Cross‑references:
- Ontology usage and hasEdge: see <a href="permissions.html#ontology-permissions">Ontology in Permission Rules</a>.
- Label SPI and hasLabel: see <a href="permissions.html#label-resolution-spi">Label resolution SPI</a>.
- AccessListResolver for list variables in filters: see "AccessListResolvers (SPI) for list-based access" above.</p>
</div>
<div class="sect3">
<h4 id="security-annotations">22.17.1. Security Annotations: FunctionalMapping and FunctionalAction</h4>
<div class="paragraph">
<p>Quantum uses annotations to declare a model or resource&#8217;s functional area, domain, and actions for security evaluation. This replaces the legacy <code>bmFunctionalArea()</code> and <code>bmFunctionalDomain()</code> methods.</p>
</div>
<div class="sect4">
<h5 id="_functionalmapping">@FunctionalMapping</h5>
<div class="paragraph">
<p>Use <code>@FunctionalMapping</code> on model classes or resource classes to declare their business placement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalMapping</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="comment">// No need to override bmFunctionalArea/bmFunctionalDomain</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// All methods inherit area/domain from class annotation</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_functionalaction">@FunctionalAction</h5>
<div class="paragraph">
<p>Use <code>@FunctionalAction</code> on JAX-RS resource methods when the action differs from the HTTP verb default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> {

    <span class="annotation">@POST</span>
    <span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// Explicit, though POST implies CREATE</span>
    <span class="directive">public</span> Product create(Product payload) {
        <span class="keyword">return</span> productRepo.save(payload);
    }

    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">// No annotation needed - GET implies VIEW</span>
    <span class="directive">public</span> Product get(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) {
        <span class="keyword">return</span> productRepo.findById(id);
    }

    <span class="annotation">@PUT</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}/approve</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">APPROVE</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// Custom action beyond standard CRUD</span>
    <span class="directive">public</span> Product approve(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) {
        Product p = productRepo.findById(id);
        p.setStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">APPROVED</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> productRepo.save(p);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_default_action_mapping">Default Action Mapping</h5>
<div class="paragraph">
<p>When <code>@FunctionalAction</code> is not present, actions are inferred from HTTP methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HTTP Method</th>
<th class="tableblock halign-left valign-top">Default Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIEW</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UPDATE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PATCH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UPDATE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELETE</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_how_the_framework_uses_these_annotations">How the Framework Uses These Annotations</h5>
<div class="sect5">
<h6 id="_securityfilter">SecurityFilter</h6>
<div class="ulist">
<ul>
<li>
<p>Reads <code>@FunctionalMapping</code> from the matched resource class for area/domain</p>
</li>
<li>
<p>Reads <code>@FunctionalAction</code> from the method, or infers from HTTP method</p>
</li>
<li>
<p>Falls back to path-based parsing if annotations are missing</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_morphiarepo_filluiactions">MorphiaRepo.fillUIActions</h6>
<div class="ulist">
<ul>
<li>
<p>Uses <code>@FunctionalMapping</code> on model classes to resolve allowed UI actions</p>
</li>
<li>
<p>Falls back to legacy <code>bmFunctionalArea()/bmFunctionalDomain()</code> methods</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_permissionresource">PermissionResource</h6>
<div class="ulist">
<ul>
<li>
<p>Prefers <code>@FunctionalMapping</code> when listing functional domains</p>
</li>
<li>
<p>Falls back to legacy methods when annotation is missing</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_migration_from_legacy_methods">Migration from Legacy Methods</h5>
<div class="sect5">
<h6 id="_current_legacy_approach">Current (Legacy) Approach</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Product</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_new_recommended_approach">New (Recommended) Approach</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="comment">// Clean - no method overrides needed</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_transitional_support">Transitional Support</h6>
<div class="paragraph">
<p>You can use both during migration:
- If <code>@FunctionalMapping</code> is present, it takes precedence
- If missing, legacy methods are used as fallback
- Plan to remove legacy methods in future releases</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_best_practices">Best Practices</h5>
<div class="sect5">
<h6 id="_consistent_naming">Consistent Naming</h6>
<div class="paragraph">
<p>Use lowercase, kebab-case for areas and domains:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">supply-chain</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">purchase-order</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">identity</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">user-profile</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_resource_vs_model_annotations">Resource vs Model Annotations</h6>
<div class="ulist">
<ul>
<li>
<p><strong>Prefer model annotations</strong> for consistency across all usage</p>
</li>
<li>
<p>Use resource annotations only when the resource handles multiple model types</p>
</li>
<li>
<p>Avoid duplicating annotations on both model and resource for the same entity</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_custom_actions">Custom Actions</h6>
<div class="paragraph">
<p>Define custom actions for business operations beyond CRUD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PUT</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}/publish</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">PUBLISH</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Product publish(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) { ... }

<span class="annotation">@POST</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}/duplicate</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">DUPLICATE</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Product duplicate(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) { ... }

<span class="annotation">@DELETE</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}/archive</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ARCHIVE</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// Soft delete vs hard DELETE</span>
<span class="directive">public</span> <span class="type">void</span> archive(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) { ... }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bypassing_data_scoping_for_system_operations">Bypassing Data Scoping for System Operations</h5>
<div class="paragraph">
<p>Some endpoints perform system-level operations that don&#8217;t operate on tenant-scoped data entities. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database migration operations (index creation, schema changes)</p>
</li>
<li>
<p>System initialization and setup endpoints</p>
</li>
<li>
<p>Administrative operations that don&#8217;t query/modify tenant-scoped records</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For these endpoints, permission rules may return a <code>SCOPED</code> decision with data-level constraints like <code>dataDomain.tenantId:${pTenantId}</code>. However, since there&#8217;s no data entity to scope on, these constraints can&#8217;t be meaningfully applied.</p>
</div>
<div class="paragraph">
<p>Use <code>bypassDataScoping = true</code> to mark such endpoints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@POST</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/indexes/applyAllIndexes/{realm}</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RolesAllowed</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">migration</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">indexes</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@FunctionalAction</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">APPLY_ALL_INDEXES</span><span class="delimiter">&quot;</span></span>, bypassDataScoping = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">void</span> applyAllIndexes(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> realm) {
    migrationService.applyAllIndexes(realm);
}</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_how_it_works">How It Works</h6>
<div class="paragraph">
<p>When <code>bypassDataScoping = true</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Permission checks still apply</strong> - The user must still be authorized (ALLOW decision) based on their roles and the permission rules</p>
</li>
<li>
<p><strong>SCOPED constraints are ignored</strong> - Data-level filters (like <code>dataDomain.tenantId:${pTenantId}</code>) are bypassed because they&#8217;re not applicable</p>
</li>
<li>
<p><strong>Audit logging</strong> - The framework logs when data scoping is bypassed for transparency</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_security_considerations">Security Considerations</h6>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Only use <code>bypassDataScoping = true</code> for endpoints that genuinely do not operate on tenant-scoped data. Misuse could expose cross-tenant data access vulnerabilities.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Use Case</th>
<th class="tableblock halign-left valign-top">bypassDataScoping</th>
<th class="tableblock halign-left valign-top">Why</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database migrations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index/schema operations don&#8217;t involve tenant data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">System initialization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Setup operations are realm-wide, not tenant-scoped</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRUD on tenant data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code> (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must respect tenant isolation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report generation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reports should only include user&#8217;s accessible data</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_example_migrationresource">Example: MigrationResource</h6>
<div class="paragraph">
<p>The <code>MigrationResource</code> class uses <code>bypassDataScoping</code> for all index management operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/system/migration</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RolesAllowed</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>})
<span class="directive">public</span> <span class="type">class</span> <span class="class">MigrationResource</span> {

   <span class="annotation">@POST</span>
   <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/indexes/applyIndexes/{realm}</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">MIGRATION</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">INDEXES</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@FunctionalAction</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">APPLY_INDEXES</span><span class="delimiter">&quot;</span></span>, bypassDataScoping = <span class="predefined-constant">true</span>)
   <span class="directive">public</span> <span class="type">void</span> applyIndexes(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> realm) {
      migrationService.applyIndexes(realm);
   }

   <span class="annotation">@POST</span>
   <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/indexes/dropAllIndexes/{realm}</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">MIGRATION</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">INDEXES</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@FunctionalAction</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">DROP_ALL_INDEXES</span><span class="delimiter">&quot;</span></span>, bypassDataScoping = <span class="predefined-constant">true</span>)
   <span class="directive">public</span> <span class="type">void</span> dropIndexes(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> realm) {
      migrationService.dropAllIndexes(realm);
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_integration_with_permission_rules">Integration with Permission Rules</h5>
<div class="paragraph">
<p>Annotations feed into permission rule matching:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-catalog-reads</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[GET]</span></span>
    <span class="comment"># Matches area/domain from @FunctionalMapping</span>
    <span class="key">functionalArea</span>: <span class="string"><span class="content">catalog</span></span>
    <span class="key">functionalDomain</span>: <span class="string"><span class="content">product</span></span>
  <span class="key">rolesAny</span>: <span class="string"><span class="content">[USER, ADMIN]</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: admin-only-approval</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">100</span></span>
  <span class="key">match</span>:
    <span class="key">method</span>: <span class="string"><span class="content">[PUT]</span></span>
    <span class="key">functionalArea</span>: <span class="string"><span class="content">catalog</span></span>
    <span class="key">functionalDomain</span>: <span class="string"><span class="content">product</span></span>
    <span class="comment"># Matches @FunctionalAction(&quot;APPROVE&quot;)</span>
    <span class="key">action</span>: <span class="string"><span class="content">APPROVE</span></span>
  <span class="key">rolesAll</span>: <span class="string"><span class="content">[ADMIN]</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_see_also_2">See Also</h5>
<div class="ulist">
<ul>
<li>
<p><a href="modeling.html#prefer-annotations-for-functional-mapping-recommended">Modeling: Functional Mapping</a></p>
</li>
<li>
<p><a href="permissions.html">Permission Rules</a></p>
</li>
<li>
<p><a href="domain-rule-context.html">DomainContext and RuleContext</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also: <a href="../user-guide/permission-resource.html">Permission Resource: Check APIs and Client Usage</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-seed-packs">23. 9. Seed packs: Declarative tenant seeding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Provisioning repeatable, versioned baseline data for tenants.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Every tenant must start with known-good defaults; upgrades must be idempotent and auditable.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Seed packs with manifests, datasets, transforms, includes, archetypes, and a registry.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Create a seed pack, apply it programmatically, and verify idempotency.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_seed_packs_and_declarative_tenant_seeding">24. Seed packs and declarative tenant seeding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum 1.2 introduces a seed-pack subsystem that lets applications publish versioned baseline
content without hard-coding values in <code>ChangeSet</code> beans or maintaining a separate "seed" tenant.</p>
</div>
<div class="sect2">
<h3 id="_introduction">24.1. Introduction</h3>
<div class="sect3">
<h4 id="_the_problem">24.1.1. The problem</h4>
<div class="paragraph">
<p>In multi-tenant SaaS platforms, every new tenant must start with a known-good baseline of data: code lists, roles, default settings, reference values, and sometimes product- or region-specific content. Traditionally this baseline is scattered across ad‑hoc SQL/Mongo scripts, hand-written bootstrap code, or a "template" tenant that is copied forward. These approaches are hard to version, review, test, and repeat reliably across environments.</p>
</div>
<div class="paragraph">
<p>Compounding the issue, tenants evolve over time. As modules are upgraded, their baseline content must be updated too. Without a disciplined mechanism, teams risk drift between environments and tenants, brittle migrations, and non-idempotent provisioning that causes duplicates or corruption.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_this_needs_to_be_solved">24.1.2. Why this needs to be solved</h4>
<div class="ulist">
<ul>
<li>
<p>Operational consistency: Provisioning should be predictable, repeatable, and safe to re-run.</p>
</li>
<li>
<p>Developer velocity: Changes to baseline data should be reviewed like code and travel with the module that owns them.</p>
</li>
<li>
<p>Compliance and audit: You need to know exactly which version of seed content was applied to which tenant and when.</p>
</li>
<li>
<p>Composability: Different product editions or SKUs need different combinations of baseline content without forked scripts.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_how_seed_packs_solve_it">24.1.3. How seed packs solve it</h4>
<div class="paragraph">
<p>Seed packs provide a declarative, versioned, and composable way to describe tenant baseline data:
- A manifest (manifest.yaml) declares datasets, natural keys, transforms, required indexes, and optional includes/archetypes.
- Datasets point to JSON/NDJSON files that are upserted using natural-key filters, making runs idempotent.
- Transforms inject tenant/realm identifiers and can rewrite references deterministically.
- Includes compose other packs with exact versions or semantic version ranges, enabling dependency management.
- Archetypes bundle a named set of packs to represent product tiers or verticals.
- A registry records checksums per dataset so unchanged data is skipped on subsequent runs.</p>
</div>
<div class="paragraph">
<p>Together, these features make seeding safe, observable, and maintainable across development, test, and production.</p>
</div>
<div class="paragraph">
<p>The next section expands on why seed packs are beneficial and how to use them effectively.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_seed_packs">24.2. Why seed packs?</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Versioned + reviewable</strong>: seed packs are plain files (YAML + JSON/NDJSON) that live next to your
module code. Pull requests show exactly which records changed.</p>
</li>
<li>
<p><strong>Composable</strong>: packs can depend on other packs and expose named <em>archetypes</em> for different product
editions or verticals.</p>
</li>
<li>
<p><strong>Pluggable sources</strong>: load packs from the filesystem, object storage, or even a curated seed
database by providing a custom <code>SeedSource</code>.</p>
</li>
<li>
<p><strong>Tenant-aware</strong>: transforms inject tenant identifiers and remap references before persisting.</p>
</li>
<li>
<p><strong>Idempotent</strong>: a <code>SeedRegistry</code> tracks checksums per dataset so provisioning can be re-run safely.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_high_level_flow">24.3. High-level flow</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>SeedLoader</code> discovers manifests via the configured <code>SeedSource</code> implementations (for example the
provided <code>FileSeedSource</code>).</p>
</li>
<li>
<p>A manifest (<code>manifest.yaml</code>) declares datasets, required indexes, transforms, optional includes, and
archetypes.</p>
</li>
<li>
<p>During provisioning a migration invokes <code>SeedLoader.apply(&#8230;&#8203;)</code> with the packs (or archetype) that
should be materialised for the tenant.</p>
</li>
<li>
<p>Records are parsed, transformed, and upserted through a <code>SeedRepository</code> implementation. The
default <code>MongoSeedRepository</code> writes to the tenant realm using natural-key filters.</p>
</li>
<li>
<p>The <code>SeedRegistry</code> (backed by <code>_seed_registry</code> via <code>MongoSeedRegistry</code>) records the checksum so
unchanged datasets are skipped on later runs.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_manifest_quick_reference">24.4. Manifest quick reference</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">logistics-core</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.4.2</span></span>
<span class="key">includes</span>:
  - <span class="string"><span class="content">accounting-base@^1.1</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: codeLists</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codelists.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[codeListName, code]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">requiredIndexes</span>:
      - <span class="string"><span class="content">name: uk_codeLists_name_code</span></span>
        <span class="key">unique</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">keys</span>:
          <span class="key">codeListName</span>: <span class="string"><span class="content">1</span></span>
          <span class="key">code</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">transforms</span>:
      - <span class="string"><span class="content">type: tenantSubstitution</span></span>
        <span class="key">config</span>:
          <span class="key">tenantField</span>: <span class="string"><span class="content">tenantId</span></span>
          <span class="key">orgField</span>: <span class="string"><span class="content">orgRefName</span></span>
          <span class="key">ownerField</span>: <span class="string"><span class="content">ownerId</span></span>
          <span class="key">realmField</span>: <span class="string"><span class="content">realmId</span></span>

<span class="key">archetypes</span>:
  - <span class="string"><span class="content">name: FulfillmentPlus</span></span>
    <span class="key">includes</span>:
      - <span class="string"><span class="content">logistics-core@^1.4</span></span>
      - <span class="string"><span class="content">shipping-defaults@~2</span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_programmatic_usage">24.5. Programmatic usage</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
        .addSeedSource(<span class="keyword">new</span> FileSeedSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, Paths.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs</span><span class="delimiter">&quot;</span></span>)))
        .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
        .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
        .build();

SeedContext ctx = SeedContext.builder(realmId)
        .tenantId(tenantId)
        .orgRefName(orgRef)
        .accountId(accountId)
        .ownerId(ownerId)
        .build();

loader.apply(<span class="predefined-type">List</span>.of(
        SeedPackRef.range(<span class="string"><span class="delimiter">&quot;</span><span class="content">logistics-core</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">^1.4</span><span class="delimiter">&quot;</span></span>),
        SeedPackRef.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">oms-defaults</span><span class="delimiter">&quot;</span></span>)
), ctx);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Callers can also use <code>loader.applyArchetype("FulfillmentPlus", ctx)</code> to resolve an archetype defined
in any manifest.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensibility_hooks">24.6. Extensibility hooks</h3>
<div class="ulist">
<ul>
<li>
<p>Implement <code>SeedSource</code> to load manifests from custom storage (S3, Git, curated seed DB…).</p>
</li>
<li>
<p>Register additional <code>SeedTransformFactory</code> instances with the builder to support bespoke
transformations (for example JMESPath projections or deterministic ObjectId mapping).</p>
</li>
<li>
<p>Swap in a different <code>SeedRepository</code>/<code>SeedRegistry</code> to write to alternative datastores or change the
idempotency policy.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_operational_tips_2">24.7. Operational tips</h3>
<div class="ulist">
<ul>
<li>
<p>Validate manifests in CI by running the loader against a disposable database.</p>
</li>
<li>
<p>Keep seed pack versions aligned with module versions so upgrade paths are clear.</p>
</li>
<li>
<p>Derive any ObjectIds deterministically from natural keys inside a transform so data can be
re-applied without collisions.</p>
</li>
<li>
<p>Use archetypes to model product tiers and optional modules: <code>TenantProvisioningService</code> can decide
which archetype(s) to apply based on SKU.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_primary_scenarios">24.8. Primary scenarios</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initial tenant provisioning</p>
<div class="ulist">
<ul>
<li>
<p>Apply one or more seed packs to bootstrap a brand-new tenant (realm) with baseline code lists, roles, and default settings.</p>
</li>
<li>
<p>Use SeedPackRef.of("pack-name") or SeedPackRef.range("pack-name", "^1.4") to control versions.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Updating a module to a new version</p>
<div class="ulist">
<ul>
<li>
<p>Publish a new seed pack version (e.g., logistics-core 1.5.0) with incremental dataset changes.</p>
</li>
<li>
<p>Re-run loader.apply(&#8230;&#8203;) for the same tenant; unchanged datasets are skipped via _seed_registry, modified datasets are re-applied.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Idempotent re-apply during deployments</p>
<div class="ulist">
<ul>
<li>
<p>Safe to invoke on every startup/migration. Upserts are driven by naturalKey and upsert: true.</p>
</li>
<li>
<p>Keep natural keys stable; derive surrogate IDs deterministically in a transform if needed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Selecting product tiers with archetypes</p>
<div class="ulist">
<ul>
<li>
<p>Define archetypes in a manifest to bundle multiple seed packs under a named edition.</p>
</li>
<li>
<p>Call loader.applyArchetype("FulfillmentPlus", ctx) to materialize the predefined stack for a tenant.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Composing packs with includes</p>
<div class="ulist">
<ul>
<li>
<p>Use includes to depend on base packs (e.g., accounting-base@^1.1) and extend with your own datasets.</p>
</li>
<li>
<p>Includes support exact (=1.2.3) and range (e.g., ^1.4, ~2) selectors via SeedPackRef.parse("name@spec").</p>
</li>
</ul>
</div>
</li>
<li>
<p>Partial refresh of specific datasets</p>
<div class="ulist">
<ul>
<li>
<p>You can split large packs into multiple datasets and re-apply only the packs you want by passing a smaller list to loader.apply(&#8230;&#8203;).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Testing seed packs</p>
<div class="ulist">
<ul>
<li>
<p>Add an integration test similar to SeedLoaderIntegrationTest that seeds into an ephemeral MongoDB and asserts collection state and _seed_registry entries.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_explicit_examples">24.9. Explicit examples</h3>
<div class="sect3">
<h4 id="_example_1_minimal_manifest_and_ndjson">24.9.1. Example 1: Minimal manifest and NDJSON</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">demo-seed</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.0.0</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: codeLists</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codeLists.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">requiredIndexes</span>:
      - <span class="string"><span class="content">name: uk_codeLists_code</span></span>
        <span class="key">unique</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">keys</span>:
          <span class="key">code</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">transforms</span>:
      - <span class="string"><span class="content">type: tenantSubstitution</span></span>
        <span class="key">config</span>:
          <span class="key">tenantField</span>: <span class="string"><span class="content">tenantId</span></span>
          <span class="key">orgField</span>: <span class="string"><span class="content">orgRefName</span></span>
          <span class="key">accountField</span>: <span class="string"><span class="content">accountId</span></span>
          <span class="key">ownerField</span>: <span class="string"><span class="content">ownerId</span></span>
          <span class="key">realmField</span>: <span class="string"><span class="content">realmId</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example NDJSON (datasets/codeLists.ndjson):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">NEW</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">New</span><span class="delimiter">&quot;</span></span>}
{<span class="key"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">CLOSED</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Closed</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_2_applying_packs_in_code">24.9.2. Example 2: Applying packs in code</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
        .addSeedSource(<span class="keyword">new</span> FileSeedSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, Paths.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs</span><span class="delimiter">&quot;</span></span>)))
        .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
        .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
        .build();

SeedContext ctx = SeedContext.builder(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-realm</span><span class="delimiter">&quot;</span></span>)
        .tenantId(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenant-123</span><span class="delimiter">&quot;</span></span>)
        .orgRefName(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenant-123</span><span class="delimiter">&quot;</span></span>)
        .accountId(<span class="string"><span class="delimiter">&quot;</span><span class="content">acct-123</span><span class="delimiter">&quot;</span></span>)
        .ownerId(<span class="string"><span class="delimiter">&quot;</span><span class="content">owner-123</span><span class="delimiter">&quot;</span></span>)
        .build();

loader.apply(<span class="predefined-type">List</span>.of(
        SeedPackRef.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">demo-seed</span><span class="delimiter">&quot;</span></span>),
        SeedPackRef.range(<span class="string"><span class="delimiter">&quot;</span><span class="content">logistics-core</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">^1.4</span><span class="delimiter">&quot;</span></span>)
), ctx);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_3_using_an_archetype">24.9.3. Example 3: Using an archetype</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">archetypes</span>:
  - <span class="string"><span class="content">name: FulfillmentPlus</span></span>
    <span class="key">includes</span>:
      - <span class="string"><span class="content">logistics-core@^1.4</span></span>
      - <span class="string"><span class="content">shipping-defaults@~2</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">loader.applyArchetype(<span class="string"><span class="delimiter">&quot;</span><span class="content">FulfillmentPlus</span><span class="delimiter">&quot;</span></span>, ctx);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_4_exact_version_and_includes_in_a_manifest">24.9.4. Example 4: Exact version and includes in a manifest</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">shipping-defaults</span></span>
<span class="key">version</span>: <span class="string"><span class="content">2.3.0</span></span>
<span class="key">includes</span>:
  - <span class="string"><span class="content">accounting-base@=1.1.2</span></span>
  - <span class="string"><span class="content">logistics-core@^1.5</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: shippingMethods</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/methods.json</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">24.10. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>Manifest parsing errors: Confirm manifest.yaml keys match SeedPackManifest fields; boolean flags like upsert and unique must be proper booleans.</p>
</li>
<li>
<p>Duplicate key or unique index violations: Check naturalKey and requiredIndexes; ensure transforms don’t change key fields inconsistently.</p>
</li>
<li>
<p>Nothing changes on re-run: The _seed_registry may have recorded the same checksum; bump version or change dataset content.</p>
</li>
<li>
<p>File resolution issues: Ensure FileSeedSource base path points to the correct seed-packs directory and file names match.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_seeds_are_applied_automatically_at_startup">24.11. How seeds are applied automatically at startup</h3>
<div class="paragraph">
<p>The framework now applies seed packs via a dedicated SeedStartupRunner, independent of schema migrations. This runner discovers and applies the latest version of each seed pack for important realms (system/default/test) on application startup.</p>
</div>
<div class="paragraph">
<p>Key points:
- Discovery: SeedStartupRunner constructs a <code>SeedLoader</code> with a <code>FileSeedSource</code> pointing at the configured seed root. Set <code>quantum.seed.root</code> (for tests we default to <code>src/main/resources/seed-packs</code>). The source walks the directory tree and locates every <code>manifest.yaml</code> file.
- Selection: For each discovered seed pack name, the runner selects the latest semantic version and builds <code>SeedPackRef.exact(name, version)</code> for application.
- Execution: The runner builds a <code>SeedContext</code> for the target realm and calls <code>loader.apply(refs, context)</code>. Indexes declared in the manifest are created before data is upserted.
- Idempotency + repeatable: The <code>MongoSeedRegistry</code> stores a checksum per dataset in the realm&#8217;s <code>_seed_registry</code> collection. If the checksum matches on a later run, the dataset is skipped; if it changes, the dataset is re-applied.
- Concurrency safety: The runner uses a Sherlock distributed lock per realm to prevent concurrent execution across nodes.</p>
</div>
<div class="paragraph">
<p>Configuration snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># test profile uses a local seed root
quantum.seed.root=src/test/resources/seed-packs
# control seed runner behavior
quantum.seeds.enabled=true
quantum.seeds.apply.on-startup=true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transforms_in_depth">24.12. Transforms in depth</h3>
<div class="paragraph">
<p>Transforms are small, composable functions that shape each dataset record just before it is written to the database. They let you keep dataset files generic and inject environment/tenant specifics or perform repeatable rewrites at apply time.</p>
</div>
<div class="paragraph">
<p>What a transform gets and returns:
- Input: the current record (a Map), the SeedContext, and the Dataset definition
- Output: the next record (Map) to be passed to the rest of the pipeline; return null or an empty map to drop the record</p>
</div>
<div class="paragraph">
<p>Where transforms are declared (manifest):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: codeLists</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codeLists.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ codeListName, code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">transforms</span>:
      - <span class="string"><span class="content">type: tenantSubstitution</span></span>
        <span class="key">config</span>:
          <span class="key">tenantField</span>: <span class="string"><span class="content">tenantId</span></span>
          <span class="key">orgField</span>: <span class="string"><span class="content">orgRefName</span></span>
          <span class="key">ownerField</span>: <span class="string"><span class="content">ownerId</span></span>
          <span class="key">accountField</span>: <span class="string"><span class="content">accountNum</span></span>
          <span class="key">realmField</span>: <span class="string"><span class="content">realmId</span></span>
      <span class="comment"># Additional transforms can be added here and will execute in order</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Execution semantics:
- Ordering: transforms are executed top-to-bottom for each record
- Short-circuit: if any transform returns null or an empty map, the record is skipped and no write occurs
- Overwrite rules: a transform can set or overwrite fields on the record; when upsert=true, the final transformed record replaces the existing one matched by naturalKey
- Interaction with naturalKey and indexes: transforms run before naturalKey validation and index creation; do not remove fields listed in naturalKey, otherwise an error will be thrown during write</p>
</div>
<div class="paragraph">
<p>Built-in transform types:
- tenantSubstitution: Injects identifiers from SeedContext into the record&#8217;s dataDomain.* fields (tenant/org/owner/account) and sets realmId at the record root. Config keys in the manifest (defaults target dataDomain.*):
  - tenantField: key inside dataDomain to receive tenantId (default: tenantId)
  - orgField: key inside dataDomain to receive orgRefName (default: orgRefName)
  - ownerField: key inside dataDomain to receive ownerId (default: ownerId)
  - accountField: key inside dataDomain to receive account number (default: accountNum)
  - realmField: root-level field to receive realmId (default: realmId)</p>
</div>
<div class="paragraph">
<p>Notes and guarantees:
- Optional values missing from SeedContext are simply omitted; existing record values are preserved unless you target the same field
- Transforms operate on in-memory maps and cannot perform I/O by default; keep them deterministic so re-runs are idempotent
- Compose multiple transforms when needed (for example: first tenantSubstitution, then a custom id computation)
- To add new transform types, implement SeedTransformFactory and register it during SeedLoader.builder() with registerTransformFactory("myType", new MyFactory()); then declare - type: myType in the manifest</p>
</div>
<div class="paragraph">
<p>When to use transforms (and why):
- Injecting tenant/realm identity: keep datasets source-controlled and generic; inject tenant IDs at apply time (tenantSubstitution)
- Deterministic IDs: derive _id or other surrogate keys from naturalKey so upserts remain stable across environments
- Normalization and defaults: add missing fields, convert formats, enforce enums before write
- Reference remapping: translate human-readable codes in the dataset into datastore-specific identifiers (ObjectIds, UUIDs) in a repeatable way</p>
</div>
<div class="paragraph">
<p>Practical examples</p>
</div>
<div class="paragraph">
<p>1) Tenant identity injection (built-in)
Manifest snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">transforms</span>:
  - <span class="string"><span class="content">type: tenantSubstitution</span></span>
    <span class="key">config</span>:
      <span class="key">tenantField</span>: <span class="string"><span class="content">tenantId</span></span>
      <span class="key">orgField</span>: <span class="string"><span class="content">orgRefName</span></span>
      <span class="key">ownerField</span>: <span class="string"><span class="content">ownerId</span></span>
      <span class="key">accountField</span>: <span class="string"><span class="content">accountId</span></span>
      <span class="key">realmField</span>: <span class="string"><span class="content">realmId</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why: keep codeLists.ndjson portable across tenants; provisioning injects the right IDs based on SeedContext.</p>
</div>
<div class="paragraph">
<p>2) Deterministic _id from natural key (custom)
- Goal: ensure stable MongoDB _id across re-applies and environments, derived from codeListName+code
- Approach: implement a custom transform that computes a SHA-1/MD5 hash (or any deterministic function) and sets _id</p>
</div>
<div class="paragraph">
<p>Java registration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
    .addSeedSource(<span class="keyword">new</span> FileSeedSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, Paths.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs</span><span class="delimiter">&quot;</span></span>)))
    .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
    .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
    .registerTransformFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">deterministicId</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> DeterministicIdTransform.Factory())
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manifest usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">transforms</span>:
  - <span class="string"><span class="content">type: tenantSubstitution</span></span>
  - <span class="string"><span class="content">type: deterministicId</span></span>
    <span class="key">config</span>:
      <span class="key">sourceFields</span>: <span class="string"><span class="content">[ codeListName, code ]</span></span>
      <span class="key">targetField</span>: <span class="string"><span class="content">_id</span></span>
      <span class="key">algorithm</span>: <span class="string"><span class="content">sha1</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why: makes upserts resilient and allows cross-environment joins by a stable key.</p>
</div>
<div class="paragraph">
<p>3) Foreign key remapping by code (custom)
- Goal: dataset uses human-readable statusCode; transform maps it to a canonical statusId
- Approach: custom transform with an in-memory map or deterministic derivation</p>
</div>
<div class="paragraph">
<p>Manifest usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">transforms</span>:
  - <span class="string"><span class="content">type: mapCode</span></span>
    <span class="key">config</span>:
      <span class="key">field</span>: <span class="string"><span class="content">statusCode</span></span>
      <span class="key">target</span>: <span class="string"><span class="content">statusId</span></span>
      <span class="key">mapping</span>:
        <span class="key">NEW</span>: <span class="string"><span class="content">100</span></span>
        <span class="key">CLOSED</span>: <span class="string"><span class="content">900</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why: keeps datasets human-friendly while persisting efficient identifiers.</p>
</div>
<div class="paragraph">
<p>4) Defaulting and sanitization (custom)
- Goal: ensure missing fields get defaults and strings are trimmed/lowercased
- Approach: simple custom transform that fills defaults and cleans values</p>
</div>
<div class="paragraph">
<p>Manifest usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">transforms</span>:
  - <span class="string"><span class="content">type: defaults</span></span>
    <span class="key">config</span>:
      <span class="key">defaults</span>:
        <span class="key">isActive</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">locale</span>: <span class="string"><span class="content">en_US</span></span>
  - <span class="string"><span class="content">type: sanitize</span></span>
    <span class="key">config</span>:
      <span class="key">trim</span>: <span class="string"><span class="content">[ label ]</span></span>
      <span class="key">lowercase</span>: <span class="string"><span class="content">[ email ]</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why: enforces consistency without editing large datasets.</p>
</div>
<div class="paragraph">
<p>Testing transforms:
- Add integration tests that seed into an ephemeral DB and assert both record shape and _seed_registry entries
- For custom transforms, add focused unit tests for edge cases (missing fields, nulls, unexpected types)</p>
</div>
<div class="sect3">
<h4 id="_creating_your_own_transforms_example_dropiftransform">24.12.1. Creating your own transforms (example: DropIfTransform)</h4>
<div class="paragraph">
<p>Custom transforms let you implement project-specific shaping logic. You implement two small interfaces and register the type on the SeedLoader builder. Below we walk through a simple "drop the record if a field equals a value" transform used in tests, called DropIfTransform.</p>
</div>
<div class="paragraph">
<p>Overview of the SPI:
- SeedTransform: executes per-record and can return a new map (continue) or null/empty (drop this record).
- SeedTransformFactory: builds a SeedTransform instance from the manifest&#8217;s Transform definition (provides access to type and config map).</p>
</div>
<div class="paragraph">
<p>Minimal interfaces (simplified for clarity):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SeedTransform</span> {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; apply(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; record,
                              SeedContext context,
                              SeedPackManifest.Dataset dataset);
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">SeedTransformFactory</span> {
    SeedTransform create(SeedPackManifest.Transform transformDefinition);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation: DropIfTransform
- Behavior: if record[field] equals a configured value, return null to short-circuit the pipeline and skip writing the record; otherwise, pass the record through unchanged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example.seed.transforms</span>;

<span class="keyword">import</span> <span class="include">com.e2eq.framework.service.seed</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">DropIfTransform</span> <span class="directive">implements</span> SeedTransform {
  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> field;
  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> equalsValue;

  <span class="directive">public</span> DropIfTransform(<span class="predefined-type">String</span> field, <span class="predefined-type">String</span> equalsValue) {
    <span class="local-variable">this</span>.field = field;
    <span class="local-variable">this</span>.equalsValue = equalsValue;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; apply(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; record, SeedContext context, SeedPackManifest.Dataset dataset) {
    <span class="predefined-type">Object</span> v = record.get(field);
    <span class="keyword">if</span> (Objects.equals(Objects.toString(v, <span class="predefined-constant">null</span>), equalsValue)) {
      <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// short-circuit: drop this record</span>
    }
    <span class="keyword">return</span> record;
  }

  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Factory</span> <span class="directive">implements</span> SeedTransformFactory {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> SeedTransform create(SeedPackManifest.Transform transformDefinition) {
      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; cfg = transformDefinition.getConfig();
      <span class="predefined-type">String</span> field = Objects.toString(cfg.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">null</span>);
      <span class="predefined-type">String</span> eq = Objects.toString(cfg.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">equals</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">null</span>);
      <span class="keyword">return</span> <span class="keyword">new</span> DropIfTransform(field, eq);
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Registration on the SeedLoader builder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
    .addSeedSource(<span class="keyword">new</span> FileSeedSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, Paths.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs</span><span class="delimiter">&quot;</span></span>)))
    .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
    .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
    .registerTransformFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">dropIf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> DropIfTransform.Factory())
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manifest usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: codeLists</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codeLists.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">transforms</span>:
      - <span class="string"><span class="content">type: dropIf</span></span>
        <span class="key">config</span>:
          <span class="key">field</span>: <span class="string"><span class="content">status</span></span>
          <span class="key">equals</span>: <span class="string"><span class="content">CLOSED</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes and tips:
- Validation: your factory should validate required config keys and fail fast with a clear error if missing/invalid.
- Determinism: keep transforms pure and deterministic (no I/O) so seeding remains idempotent.
- Short-circuit: returning null or an empty map drops the record; otherwise, the next transform in the list will receive the (possibly mutated) map.
- Composition: you can chain several transforms; for example, first dropIf, then tenantSubstitution, then a custom deterministicId.
- Packaging: test-only transforms can live under test sources; production transforms should be in main sources and registered where you construct the SeedLoader (for example, in a ChangeSet or a provisioning service).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_walkthrough_seedloaderintegrationtest">24.13. Test walkthrough: SeedLoaderIntegrationTest</h3>
<div class="paragraph">
<p>The <code>SeedLoaderIntegrationTest</code> demonstrates end-to-end seeding using the demo seed pack at <code>src/main/resources/seed-packs/demo-seed</code>.</p>
</div>
<div class="paragraph">
<p>What the test does:
- Creates a <code>SeedLoader</code> backed by <code>FileSeedSource</code>, <code>MongoSeedRepository</code>, and <code>MongoSeedRegistry</code>.
- Builds a <code>SeedContext</code> populated with tenant/realm details to exercise the <code>tenantSubstitution</code> transform.
- Applies the pack reference <code>SeedPackRef.of("demo-seed")</code>, which resolves the latest version of that pack (1.0.0 in tests).
- Asserts that 2 records were inserted into the <code>codeLists</code> collection and that the <code>tenantSubstitution</code> fields were populated from the context.
- Verifies an entry was written to <code>_seed_registry</code> with the dataset checksum and <code>records: 2</code>.
- Re-applies the same pack and asserts the record count remains 2, demonstrating idempotency (thanks to upsert + registry checksum).</p>
</div>
<div class="paragraph">
<p>Why these design choices:
- NDJSON for datasets: allows streaming large datasets and simple line-by-line diffs in code review; arrays are also supported for smaller payloads.
- Natural-key upsert: manifests declare <code>naturalKey</code> to form the filter for <code>replaceOne(&#8230;&#8203;, upsert=true)</code> ensuring idempotent writes and predictable overwrites.
- Transform pipeline: keeps dataset files free of environment-specific values; all tenant/realm specifics are injected consistently at apply time.
- Registry-based skip: checksums per dataset avoid unnecessary writes when content hasn&#8217;t changed—fast, safe re-runs during deployments.
- Semantic-version selection: when multiple versions of a pack are available, the latest semver is used unless an exact version is requested.</p>
</div>
<div class="paragraph">
<p>Alternatives considered:
- Store seed state in an external table keyed only by version. Rejected in favor of per-dataset checksums to detect content drift without bumping versions.
- Hardcode seeding logic inside ad-hoc migrations. Rejected for lack of composability and poor reviewability.
- Use inserts only (no upsert). Rejected due to lack of idempotence and difficulty correcting baseline data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_archetypes_explained">24.14. Archetypes explained</h3>
<div class="paragraph">
<p>Archetypes are named compositions of seed packs that model a product edition, SKU, or vertical stack. Instead of listing several packs every time you provision a tenant, you define an archetype once in a manifest and then apply it by name.</p>
</div>
<div class="paragraph">
<p>What an archetype is in this context:
- It lives inside a seed pack manifest under archetypes:.
- It contains a list of includes (same syntax as top-level includes) referring to packs and version ranges.
- When applied, the loader resolves those pack refs plus the hosting pack itself (the manifest that defines the archetype) so that local datasets are included as part of the archetype.
- Resolution uses semantic version rules and deduplicates by pack name, respecting dependency order and preventing cycles.</p>
</div>
<div class="paragraph">
<p>When to use archetypes:
- To represent product tiers (e.g., Community, Pro, Enterprise) that bundle different combinations of base packs and optional modules.
- To group verticalized defaults (e.g., Logistics-Fulfillment, Healthcare-Core) without forcing consumers to know every underlying pack.</p>
</div>
<div class="sect3">
<h4 id="_example_a_define_and_apply_an_archetype_in_the_same_pack">24.14.1. Example A: Define and apply an archetype in the same pack</h4>
<div class="paragraph">
<p>Manifest (logistics-core/manifest.yaml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">logistics-core</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.4.2</span></span>

<span class="key">includes</span>:
  - <span class="string"><span class="content">accounting-base@^1.1</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: codeLists</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codelists.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ codeListName, code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>

<span class="key">archetypes</span>:
  - <span class="string"><span class="content">name: FulfillmentPlus</span></span>
    <span class="key">includes</span>:
      - <span class="string"><span class="content">logistics-core@^1.4</span></span>     <span class="comment"># self + constraints</span>
      - <span class="string"><span class="content">shipping-defaults@~2</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Applying it in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
        .addSeedSource(<span class="keyword">new</span> FileSeedSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, Paths.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs</span><span class="delimiter">&quot;</span></span>)))
        .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
        .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
        .build();

SeedContext ctx = SeedContext.builder(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-realm</span><span class="delimiter">&quot;</span></span>).build();
loader.applyArchetype(<span class="string"><span class="delimiter">&quot;</span><span class="content">FulfillmentPlus</span><span class="delimiter">&quot;</span></span>, ctx);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- applyArchetype looks up the latest manifest that defines an archetype named "FulfillmentPlus" across all discovered packs, resolves the include refs, and then applies the union.
- If multiple manifests define the same archetype name, the latest semver manifest wins.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_b_cross_pack_archetype_in_a_dedicated_editions_pack">24.14.2. Example B: Cross-pack archetype in a dedicated "editions" pack</h4>
<div class="paragraph">
<p>You can centralize product definitions into a thin pack that only defines archetypes and forward-references other packs:</p>
</div>
<div class="paragraph">
<p>Manifest (product-editions/manifest.yaml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">product-editions</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.0.0</span></span>

<span class="key">archetypes</span>:
  - <span class="string"><span class="content">name: Enterprise</span></span>
    <span class="key">includes</span>:
      - <span class="string"><span class="content">logistics-core@^1.5</span></span>
      - <span class="string"><span class="content">shipping-defaults@~2</span></span>
      - <span class="string"><span class="content">analytics-starter@^0.9</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">loader.applyArchetype(<span class="string"><span class="delimiter">&quot;</span><span class="content">Enterprise</span><span class="delimiter">&quot;</span></span>, ctx);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This keeps edition composition decoupled from individual module packs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resolution_and_ordering_details">24.14.3. Resolution and ordering details</h4>
<div class="ulist">
<ul>
<li>
<p>Version matching: Each include can be exact (=1.2.3), a semver range (e.g., ^1.5, ~2), or omitted (latest). See SeedPackRef.parse("name@spec").</p>
</li>
<li>
<p>Deduplication: If multiple includes select the same pack name (possibly different versions), the highest version that satisfies all constraints is chosen; duplicates are applied only once.</p>
</li>
<li>
<p>Dependency order: Includes are recursively resolved depth-first, while the loader guards against cycles and applies datasets in a stable order per resolved pack.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interaction_with_applyseedpackschangeset">24.14.4. Interaction with ApplySeedPacksChangeSet</h4>
<div class="ulist">
<ul>
<li>
<p>The Apply Seed Packs change set scans the seed root and applies the latest version of every discovered pack to the realm. It does not automatically choose an archetype.</p>
</li>
<li>
<p>Use applyArchetype programmatically (e.g., from a TenantProvisioningService) when you want to provision only the packs that belong to a specific edition.</p>
</li>
<li>
<p>You can combine approaches: let migrations ensure baseline packs are present for all tenants; then, on tenant onboarding, call applyArchetype(&#8230;&#8203;) to add edition-specific content.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_tenant_provisioning_with_archetypes">24.14.5. Tenant provisioning with archetypes</h4>
<div class="paragraph">
<p>The tenant provisioning API accepts an optional list of archetype names and will apply the corresponding seed packs during onboarding.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Endpoint: POST /admin/tenants</p>
</li>
<li>
<p>Request body fields (subset):</p>
</li>
<li>
<p>tenantEmailDomain, orgRefName, accountId, adminUserId, adminUsername, adminPassword</p>
</li>
<li>
<p>archetypes: optional array of strings (archetype names)</p>
</li>
<li>
<p>Behavior:</p>
</li>
<li>
<p>After running migrations and creating the admin user, each archetype is resolved across all manifests and applied using the same SeedLoader used elsewhere.</p>
</li>
<li>
<p>If an archetype name is unknown, the request fails with 409/500 depending on context.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantEmailDomain</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-archetype.example</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">orgRefName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-archetype.example</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">accountId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">9999999999</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">adminUserId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">admin@demo-archetype.example</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">adminUsername</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">admin@demo-archetype.example</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">adminPassword</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">archetypes</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">DemoArchetype</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>On success, the new realm (demo-archetype-example) will have the datasets from the selected archetypes applied and recorded in the _seed_registry.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rest_api_for_seed_packs">24.15. REST API for seed packs</h3>
<div class="paragraph">
<p>The framework exposes admin-only endpoints to inspect and apply seed packs per realm (tenant DB). These are disabled to non-admin users via role checks.</p>
</div>
<div class="paragraph">
<p>Base path: /admin/seeds</p>
</div>
<div class="paragraph">
<p>Endpoints:
- GET /admin/seeds/pending/{realm}
  - Lists pending seed packs for the realm. A pack is pending if any dataset checksum differs from the last applied or was never applied.
  - Optional query parameter: filter=pack1,pack2 to restrict by pack name.
  - Response example:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
  {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">seedId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-seed@1.0.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">seedPack</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-seed</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">datasets</span><span class="delimiter">&quot;</span></span>: [
      {<span class="key"><span class="delimiter">&quot;</span><span class="content">collection</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">codeLists</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">datasets/codelists.ndjson</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">checksum</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>}
    ]
  }
]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>POST /admin/seeds/apply/{realm}</p>
</li>
<li>
<p>Applies the latest version of all discovered packs (or only those matching filter).</p>
</li>
<li>
<p>Query parameter: filter=pack1,pack2</p>
</li>
<li>
<p>Response example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">applied</span><span class="delimiter">&quot;</span></span>:[<span class="string"><span class="delimiter">&quot;</span><span class="content">demo-seed</span><span class="delimiter">&quot;</span></span>]}</code></pre>
</div>
</div>
</li>
<li>
<p>POST /admin/seeds/{realm}/{seedPack}/apply</p>
</li>
<li>
<p>Applies the latest version of a single pack by name. Idempotent: unchanged datasets are skipped.</p>
</li>
<li>
<p>Response example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">applied</span><span class="delimiter">&quot;</span></span>:[<span class="string"><span class="delimiter">&quot;</span><span class="content">demo-seed</span><span class="delimiter">&quot;</span></span>]}</code></pre>
</div>
</div>
</li>
<li>
<p>GET /admin/seeds/history/{realm}</p>
</li>
<li>
<p>Returns the per-dataset seeding history as recorded in the <code>_seed_registry</code> collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authentication and roles:
- All endpoints require role admin. In integration tests you can use @TestSecurity(user="admin", roles={"admin").</p>
</div>
<div class="paragraph">
<p>Configuration:
- quantum.seed.root: filesystem path to the root folder where seed packs are discovered. In tests this defaults to src/test/resources/seed-packs.
- quantum.seed.apply.filter: optional comma-separated list of pack names to limit automatic application by changeset.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_morphiaseedrepository_morphia_backed_seeding">24.16. Using MorphiaSeedRepository (Morphia-backed seeding)</h3>
<div class="paragraph">
<p>Note about collection vs modelClass:
- You can now omit collection in a dataset when you specify modelClass. The framework will derive the collection name from the Morphia mapping of the model class.
- Derivation rules: if the model class has @Entity with a non-empty value, that value is used as the collection name; otherwise the simple Java class name is used.
- This derived name is used consistently for logging, in the _seed_registry entries, and for the Mongo fallback path.
- Backwards compatibility: specifying collection is still supported, and will override the derived name.</p>
</div>
<div class="paragraph">
<p>In addition to the default Mongo-based persistence, you can instruct the seeding pipeline to persist
a dataset via a Morphia repository mapped to a concrete UnversionedBaseModel. This enables:
- Automatic class discriminator fields (for example, Morphia’s _t) and proper collection mapping.
- Population of framework-managed fields (dataDomain, audit info, etc.) by the repository layer.
- Consistent security filtering and validations applied by Morphia repos in normal runtime.</p>
</div>
<div class="paragraph">
<p>How to enable Morphia for a dataset:
- Add modelClass to the dataset in manifest.yaml with the fully-qualified class name that extends UnversionedBaseModel.
- Keep naturalKey and transforms as usual. The loader will still compute checksums and idempotently upsert.</p>
</div>
<div class="paragraph">
<p>Example manifest snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">morphia-demo</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.0.0</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: CodeList</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/codeList.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[category, key]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">modelClass</span>: <span class="string"><span class="content">com.e2eq.framework.model.persistent.base.CodeList</span></span>
    <span class="key">transforms</span>:
      - <span class="string"><span class="content">type: tenantSubstitution</span></span>
        <span class="key">config</span>:
          <span class="key">tenantField</span>: <span class="string"><span class="content">tenantId</span></span>
          <span class="key">orgField</span>: <span class="string"><span class="content">orgRefName</span></span>
          <span class="key">ownerField</span>: <span class="string"><span class="content">ownerId</span></span>
          <span class="key">accountField</span>: <span class="string"><span class="content">accountNum</span></span>
          <span class="key">realmField</span>: <span class="string"><span class="content">realmId</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Walkthrough (based on the integration test MorphiaSeedRepositoryIntegrationTest):
- The test builds a SeedLoader with MorphiaSeedRepository and MongoSeedRegistry pointing at src/test/resources/seed-packs.
- A SeedContext is created for a test realm. For repository-layer behavior (dataDomain, permissions), a minimal SecurityContext is also established in the test.
- The loader applies SeedPackRef.of("morphia-demo"), which reads datasets/codeList.ndjson with two CodeList records.
- The dataset declares modelClass, so MorphiaSeedRepository resolves the CodeList MorphiaRepo and attempts to save via Morphia.
- If Morphia permission rules are not yet configured for the realm, MorphiaSeedRepository automatically falls back to a direct Mongo write, ensuring seeds still apply predictably but without Morphia-only fields.
- The test then asserts that two documents exist in the CodeList collection and that _seed_registry has a matching history entry for the dataset checksum with records: 2.</p>
</div>
<div class="paragraph">
<p>Key behaviors and edge cases:
- Indexes: When modelClass is present, ensureIndexes relies on Morphia mapping to enforce annotated indexes for the model. Any requiredIndexes declared in the manifest are still respected by the Mongo fallback.
- Transforms: tenantSubstitution adds tenant context fields. When saving via Morphia, the repository adapts top-level tenant fields into dataDomain.* automatically for common models, and removes transient fields like realmId before mapping.
- Permissions: If repository permissions prevent writes (for example, missing policies in a brand-new realm), MorphiaSeedRepository will log a warning and fall back to Mongo so seeding is not blocked. As you evolve policies, the Morphia path will be taken automatically on future runs.
- Idempotency: Upsert semantics still honor naturalKey for both Morphia and Mongo paths, and _seed_registry records checksums so unchanged datasets are skipped.</p>
</div>
<div class="paragraph">
<p>See also:
- Test source: quantum-framework/src/test/java/com/e2eq/framework/service/seed/MorphiaSeedRepositoryIntegrationTest.java
- Manifest and dataset: quantum-framework/src/test/resources/seed-packs/morphia-demo
- Admin APIs: /admin/seeds to list pending, apply packs, and inspect history per realm.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dataset_urls_and_routing_file_and_s3">24.17. Dataset URLs and routing (file:// and s3://)</h3>
<div class="paragraph">
<p>Starting with Quantum 1.2.2, dataset files in a manifest can be specified either as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relative paths (backward compatible): resolved relative to the manifest’s own location as provided by its SeedSource (filesystem or S3).</p>
</li>
<li>
<p>Absolute URLs with a scheme that identifies the source: currently supported schemes are file:// and s3://. The loader automatically routes these URLs to the appropriate SeedSource at runtime.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes:
- If the dataset value contains "://", it is treated as a URL and routed by scheme. Otherwise it is treated as a relative path.
- Using URLs allows you to mix sources inside a single manifest (e.g., some datasets from the local filesystem and others from S3).
- This is extensible; additional schemes can be supported by adding optional modules in the future.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">mixed-demo</span></span>
<span class="key">version</span>: <span class="string"><span class="content">0.1.0</span></span>

<span class="key">datasets</span>:
  <span class="comment"># Relative path (resolved relative to the manifest location)</span>
  - <span class="string"><span class="content">collection: localDefaults</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">datasets/defaults.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ key ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>

  <span class="comment"># Absolute filesystem URL</span>
  - <span class="string"><span class="content">collection: roles</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">file:///opt/app/seed-packs/roles.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>

  <span class="comment"># Absolute S3 URL</span>
  - <span class="string"><span class="content">collection: carriers</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">s3://my-seeds/mixed-demo/0.1.0/carriers.ndjson</span></span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Routing behavior:
- Relative path: delegated to the SeedSource that loaded the manifest (unchanged behavior).
- file:// URL: handled by FileSeedSource.
- s3:// URL: handled by S3SeedSource (requires the optional quantum-seed-s3 module on the classpath).</p>
</div>
</div>
<div class="sect2">
<h3 id="_s3_seed_source_optional_module">24.18. S3 Seed Source (optional module)</h3>
<div class="paragraph">
<p>The framework provides an optional SeedSource backed by Amazon S3, packaged in a separate module so you can include it only when needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Module: <code>quantum-seed-s3</code></p>
</li>
<li>
<p>Class: <code>com.end2endlogic.quantum.seed.s3.S3SeedSource</code></p>
</li>
<li>
<p>Purpose: Discover seed pack manifests and datasets stored in S3; optionally assume an IAM role via STS if cross‑account access is required.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_when_to_use_s3_vs_filesystem">24.18.1. When to use S3 vs. filesystem</h4>
<div class="paragraph">
<p>Use S3 when any of the following apply:
- You want a single canonical location for seed content shared across services and environments.
- You need to distribute seed packs across many runtimes (containers, serverless) without baking files into images.
- You want to leverage S3 features: versioning, object immutability, access logging, and cross‑account sharing.
- CI/CD pipelines or content teams publish seed packs independently from application deployments.</p>
</div>
<div class="paragraph">
<p>Filesystem may be simpler when:
- Developing locally with small packs that live inside your project.
- You prefer packs bundled within the application JAR/image and don’t need central distribution.</p>
</div>
<div class="paragraph">
<p>Advantages of S3 over filesystem:
- Centralized distribution and caching via S3/CloudFront.
- Cross‑account access with STS AssumeRole.
- Object versioning and retention policies for auditability.
- Decouples seed content delivery from app build artifacts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_s3_layout_conventions">24.18.2. S3 layout conventions</h4>
<div class="paragraph">
<p>S3SeedSource expects the same on-disk structure as FileSeedSource, just hosted under a bucket + optional prefix. Each seed pack version is a folder containing a manifest file and any referenced datasets. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>s3://my-seeds/seed-packs/customer/1.0.0/manifest.yaml</p>
</li>
<li>
<p>s3://my-seeds/seed-packs/customer/1.0.0/customers.ndjson</p>
</li>
<li>
<p>s3://my-seeds/seed-packs/logistics-core/1.4.2/manifest.yaml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes:
- The manifest file name defaults to <code>manifest.yaml</code> but can be overridden.
- Dataset file paths in the manifest are resolved relative to the manifest’s key (folder).</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_and_credentials">24.18.3. Configuration and credentials</h4>
<div class="paragraph">
<p>Constructor parameters for S3SeedSource:
- id: Human-friendly source id (e.g., "s3-main").
- bucket: S3 bucket name.
- prefix: Optional prefix under which seed packs live (e.g., "seed-packs/"). May be empty.
- manifestFileName: Optional. Defaults to "manifest.yaml".
- region: Optional AWS region. If omitted, AWS SDK v2 region resolution applies.
- roleArn: Optional ARN of a role to assume via STS. If omitted/blank, the default credentials chain is used.
- roleSessionName: Optional session name when assuming a role. Defaults to "quantum-seed".
- externalId: Optional ExternalId for AssumeRole if the target role trust policy requires it.
- roleDuration: Optional session duration for AssumeRole; defaults to 30 minutes.</p>
</div>
<div class="paragraph">
<p>Credential modes:
- Default credentials chain (no roleArn): The AWS SDK v2 uses environment variables, profile, ECS/EC2/Lambda task role, etc.
- AssumeRole (roleArn provided): The source uses STS to assume the specified role before calling S3.</p>
</div>
<div class="paragraph">
<p>IAM considerations:
- The credentials (base or assumed) must allow <code>s3:ListBucket</code> on the bucket (scoped to the prefix) and <code>s3:GetObject</code> for objects under the prefix.
- For cross‑account usage, grant the calling account sts:AssumeRole on the target role, and in the role’s policy grant the S3 permissions above.</p>
</div>
<div class="paragraph">
<p>Minimal target role policy example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">Version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2012-10-17</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">Statement</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Allow</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">s3:ListBucket</span><span class="delimiter">&quot;</span></span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Resource</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arn:aws:s3:::my-seeds</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Condition</span><span class="delimiter">&quot;</span></span>: {<span class="key"><span class="delimiter">&quot;</span><span class="content">StringLike</span><span class="delimiter">&quot;</span></span>: {<span class="key"><span class="delimiter">&quot;</span><span class="content">s3:prefix</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs/*</span><span class="delimiter">&quot;</span></span>]}}
    },
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Effect</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Allow</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">s3:GetObject</span><span class="delimiter">&quot;</span></span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">Resource</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">arn:aws:s3:::my-seeds/seed-packs/*</span><span class="delimiter">&quot;</span></span>
    }
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usage_examples">24.18.4. Usage examples</h4>
<div class="paragraph">
<p>Create a loader that discovers packs from S3 with the runtime IAM role or local credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.service.seed</span>.*;
<span class="keyword">import</span> <span class="include">com.end2endlogic.quantum.seed.s3.S3SeedSource</span>;
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.regions.Region</span>;

SeedLoader loader = SeedLoader.builder()
    .addSeedSource(<span class="keyword">new</span> S3SeedSource(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">s3-main</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">my-seeds</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs/</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">manifest.yaml</span><span class="delimiter">&quot;</span></span>,
        <span class="predefined-type">Region</span>.US_EAST_1,
        <span class="predefined-constant">null</span>, <span class="comment">// roleArn null =&gt; use default creds / runtime role</span>
        <span class="predefined-constant">null</span>,
        <span class="predefined-constant">null</span>,
        <span class="predefined-constant">null</span>))
    .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
    .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming a cross‑account role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SeedLoader loader = SeedLoader.builder()
    .addSeedSource(<span class="keyword">new</span> S3SeedSource(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">s3-cross-account</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">partner-seeds</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">prod/</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">manifest.yaml</span><span class="delimiter">&quot;</span></span>,
        <span class="predefined-type">Region</span>.US_WEST_2,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">arn:aws:iam::123456789012:role/SeedReadOnly</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">quantum-seed-session</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">external-id-abc123</span><span class="delimiter">&quot;</span></span>,
        java.time.Duration.ofMinutes(<span class="integer">45</span>)))
    .seedRepository(<span class="keyword">new</span> MongoSeedRepository(mongoClient))
    .seedRegistry(<span class="keyword">new</span> MongoSeedRegistry(mongoClient))
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the builder helper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.end2endlogic.quantum.seed.s3.S3SeedSourceBuilder</span>;

S3SeedSource s3 = <span class="keyword">new</span> S3SeedSourceBuilder()
    .id(<span class="string"><span class="delimiter">&quot;</span><span class="content">s3-main</span><span class="delimiter">&quot;</span></span>)
    .bucket(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-seeds</span><span class="delimiter">&quot;</span></span>)
    .prefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">seed-packs/</span><span class="delimiter">&quot;</span></span>)
    .region(<span class="predefined-type">Region</span>.US_EAST_1)
    .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_defining_datasets_in_the_manifest_s3">24.18.5. Defining datasets in the manifest (S3)</h4>
<div class="paragraph">
<p>Manifests can reference S3 in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relative paths (backward compatible): when a manifest itself is loaded from S3, dataset files are resolved relative to the manifest’s S3 key (folder), just like the filesystem source.</p>
</li>
<li>
<p>Absolute URLs: you can specify s3://bucket/key URLs directly in any manifest. These are routed to S3 regardless of where the manifest was discovered from.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example S3 manifest and dataset layout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">s3://my-seeds/seed-packs/customer/1.0.0/manifest.yaml
s3://my-seeds/seed-packs/customer/1.0.0/customers.ndjson
s3://my-seeds/seed-packs/customer/1.0.0/roles.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manifest file (manifest.yaml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">seedPack</span>: <span class="string"><span class="content">customer</span></span>
<span class="key">version</span>: <span class="string"><span class="content">1.0.0</span></span>

<span class="key">datasets</span>:
  - <span class="string"><span class="content">collection: customers</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">customers.ndjson</span></span>     <span class="comment"># resolved relative to the manifest’s folder in S3</span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ accountNumber ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>

  - <span class="string"><span class="content">collection: roles</span></span>
    <span class="key">file</span>: <span class="string"><span class="content">roles.json</span></span>           <span class="comment"># also relative to the manifest’s folder</span>
    <span class="key">naturalKey</span>: <span class="string"><span class="content">[ code ]</span></span>
    <span class="key">upsert</span>: <span class="string"><span class="content">true</span></span>

<span class="key">archetypes</span>:
  - <span class="string"><span class="content">name: CustomerBase</span></span>
    <span class="key">includes</span>:
      - <span class="string"><span class="content">customer@=1.0.0</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No additional configuration is required in the manifest to indicate S3; the SeedSource you configure at runtime determines where manifests are discovered and how dataset paths are resolved.</p>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_2">24.18.6. Troubleshooting</h4>
<div class="ulist">
<ul>
<li>
<p>Access denied: Verify credentials or the assumed role’s permissions for ListBucket/GetObject on the bucket/prefix.</p>
</li>
<li>
<p>Region mismatch: Provide an explicit region if your runtime’s default region doesn’t match the bucket’s region.</p>
</li>
<li>
<p>Object not found: Confirm the prefix and that the manifest file name matches (default is manifest.yaml).</p>
</li>
<li>
<p>Slow discovery: Use a tighter prefix to avoid scanning a large bucket namespace; consider S3 inventory or object tagging strategies if your repository grows significantly.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-migrations">25. 10. Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Evolving schemas and data safely across environments.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Continuous delivery means frequent, incremental change with strict uptime and audit needs.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Opinionated patterns and hooks for applying safe migrations.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Add and run a simple migration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrations">26. Database Migrations and Index Management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide explains Quantum’s MongoDB migration subsystem (quantum-morphia-repos), how migrations are authored and executed, and how to manage indexes. It also documents the REST APIs that trigger migrations and index operations.</p>
</div>
<div class="sect2">
<h3 id="_overview">26.1. Overview</h3>
<div class="paragraph">
<p>Quantum uses a simple, versioned change‑set mechanism to evolve MongoDB schemas and seed data safely across realms (databases). Key building blocks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ChangeSetBean: a CDI bean describing one migration step with metadata (from/to version, priority, etc.) and an execute method.</p>
</li>
<li>
<p>ChangeSetBase: convenience base class you can extend; provides logging helpers and optional targeting controls.</p>
</li>
<li>
<p>MigrationService: discovers pending change sets, applies them in order within a transaction, records execution, and bumps the DatabaseVersion.</p>
</li>
<li>
<p>DatabaseVersion and ChangeSetRecord: stored in Mongo to track current schema version and previously executed change sets.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_semantic_versioning">26.2. Semantic Versioning</h3>
<div class="paragraph">
<p>Semantic Versioning (SemVer) expresses versions in the form MAJOR.MINOR.PATCH (for example, 1.4.2):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MAJOR: increment for incompatible/breaking schema changes.</p>
</li>
<li>
<p>MINOR: increment for backward‑compatible additions (new collections/fields that don’t break existing code).</p>
</li>
<li>
<p>PATCH: increment for backward‑compatible fixes or small adjustments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why this matters for migrations:
- Ordering: migrations must apply in a deterministic order that reflects real compatibility. SemVer provides a natural ordering and clear intent for authors and reviewers.
- Compatibility checks: the application can assert that the current database is “new enough” to run the code safely.</p>
</div>
<div class="paragraph">
<p>How semver4j is used:
- Parsing and validation: version strings are parsed into a SemVer object. Invalid strings fail fast during parsing, ensuring only compliant versions are stored and compared.
- Introspection and comparison: the parsed object exposes major/minor/patch components and supports comparisons, enabling safe ordering and “greater than / less than” checks.
- Consistent string form: the canonical string is retained for display, logs, and API responses.</p>
</div>
<div class="paragraph">
<p>How DatabaseVersion leverages SemVer:
- Single source of truth: DatabaseVersion stores the canonical SemVer string alongside a parsed SemVer object for logic and comparisons.
- Efficient ordering: for fast sorting and tie‑breaking, DatabaseVersion also keeps a compact integer encoding of MAJOR.MINOR.PATCH as (major*100) + (minor*10) + patch (e.g., 1.0.3 → 103). This makes numeric comparisons straightforward while still recording the exact SemVer string.
- Migration flow: when migrations run, successful execution records the new database version in DatabaseVersion. Startup checks compare the stored version to the required quantum.database.version to prevent the app from running against an older, incompatible schema.</p>
</div>
<div class="paragraph">
<p>Recommendations:
- Always bump MAJOR for breaking data changes, MINOR for additive changes, and PATCH for backward‑compatible fixes.
- Keep change sets small and target a single to‑version per change set to make intent clear.
- Use SemVer consistently in getDbFromVersion/getDbToVersion across all change sets so ordering and compatibility checks remain reliable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2">26.3. Configuration</h3>
<div class="paragraph">
<p>The following MicroProfile config properties influence migrations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum.database.version: target version the application requires (SemVer, e.g., 1.0.3). MigrationService.checkDataBaseVersion compares this to the stored version.</p>
</li>
<li>
<p>quantum.database.migration.enabled: feature flag checked by resources/services when running migrations. Default: true.</p>
</li>
<li>
<p>quantum.database.migration.changeset.package: package containing change sets (CDI still discovers beans via type, but this property documents the intended package).</p>
</li>
<li>
<p>quantum.realmConfig.systemRealm, quantum.realmConfig.defaultRealm, quantum.realmConfig.testRealm: well‑known realms used by MigrationResource when running migrations across environments.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_change_sets_are_discovered_and_executed">26.4. How change sets are discovered and executed</h3>
<div class="ulist">
<ul>
<li>
<p>Discovery: MigrationService#getAllChangeSetBeans locates all CDI beans implementing ChangeSetBean.</p>
</li>
<li>
<p>Ordering: change sets are sorted by dbToVersionInt, then by priority (ascending). That ensures lower target versions apply before higher ones; priority resolves ties.</p>
</li>
<li>
<p>Pending selection: For the target realm, MigrationService#getAllPendingChangeSetBeans considers a change set pending if either (a) it has never run, (b) the bean’s changeSetVersion is greater than the last recorded one, or (c) the bean’s checksum is non-null and differs from the last recorded checksum in ChangeSetRecord. It also compares each change set’s dbToVersion against the stored DatabaseVersion.</p>
</li>
<li>
<p>Locking: A distributed lock (Mongo‑backed Sherlock) is acquired per realm before applying change sets to prevent concurrent execution.</p>
</li>
<li>
<p>Transactions: Each change set runs within a MorphiaSession transaction; on success the change is recorded in ChangeSetRecord and DatabaseVersion is advanced (if higher). On failure the transaction is aborted and the error returned.</p>
</li>
<li>
<p>Realms: Migrations run per realm (Mongo database). A change set can optionally be restricted to certain database names or even override the realm it executes against (see below).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_authoring_a_change_set">26.5. Authoring a change set</h3>
<div class="paragraph">
<p>Implement ChangeSetBean; most change sets extend ChangeSetBase.</p>
</div>
<div class="paragraph">
<p>Required metadata methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getId(): a string id for human tracking (e.g., 00003)</p>
</li>
<li>
<p>getDbFromVersion() / getDbFromVersionInt(): previous version you are migrating from (SemVer and an int like 102 for 1.0.2)</p>
</li>
<li>
<p>getDbToVersion() / getDbToVersionInt(): target version after running this change (SemVer and int)</p>
</li>
<li>
<p>getPriority(): integer priority when multiple change sets have same toVersion</p>
</li>
<li>
<p>getAuthor(), getName(), getDescription(), getScope(): informational fields recorded in ChangeSetRecord</p>
</li>
<li>
<p>getChangeSetVersion() [optional]: an integer you bump when the definition/logic of this change set evolves but its target database version does not. Defaults to 1.</p>
</li>
<li>
<p>getChecksum() [optional]: a stable checksum string representing the content/logic of the change set. If provided and it changes, the change set will re-run even if versions did not change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Execution method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>void execute(MorphiaSession session, MongoClient mongoClient, MultiEmitter&lt;? super String&gt; emitter)</p>
</li>
<li>
<p>Perform your data/index changes using the provided session (transaction).</p>
</li>
<li>
<p>Use emitter.emit("message") to stream log lines back to SSE clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optional targeting controls (provided by ChangeSetBase):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boolean isOverrideDatabase(): return true to execute against a specific database instead of the requested realm.</p>
</li>
<li>
<p>String getOverrideDatabaseName(): the concrete database name to use when overriding.</p>
</li>
<li>
<p>Set&lt;String&gt; getApplicableDatabases(): return a set of database names to which this change set should apply. Return null or an empty set to allow all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Logging helper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ChangeSetBase.log(String, MultiEmitter) emits to both Quarkus log and the SSE stream.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_example_change_sets_in_the_framework">26.6. Example change sets in the framework</h3>
<div class="paragraph">
<p>Package: com.e2eq.framework.model.persistent.morphia.changesets</p>
</div>
<div class="ulist">
<ul>
<li>
<p>InitializeDatabase</p>
</li>
<li>
<p>Seeds foundational data in a new realm: counters (e.g., accountNumber), system Organization and Account, initial Rule and Policy scaffolding, default user profiles and security model. Uses EnvConfigUtils and SecurityUtils to derive system DataDomain and defaults.</p>
</li>
<li>
<p>AddAnonymousSecurityRules</p>
</li>
<li>
<p>Adds a defaultAnonymousPolicy with an allow rule for unauthenticated actions such as registration and contact‑us in the website area.</p>
</li>
<li>
<p>AddRealms</p>
</li>
<li>
<p>Creates the system and default Realm records based on configuration, if missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are typical examples of idempotent change sets that can be safely re‑evaluated.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rest_apis_to_trigger_migrations_migrationresource">26.7. REST APIs to trigger migrations (MigrationResource)</h3>
<div class="paragraph">
<p>Base path: /system/migration</p>
</div>
<div class="paragraph">
<p>Security: Most endpoints require admin role; dbversion is PermitAll for introspection.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /system/migration/dbversion/{realm}</p>
</li>
<li>
<p>Returns the current DatabaseVersion document for the given realm, or 404 if not found.</p>
</li>
<li>
<p>Example:
curl -s <a href="http://localhost:8080/system/migration/dbversion/system-com" class="bare">http://localhost:8080/system/migration/dbversion/system-com</a></p>
</li>
<li>
<p>POST /system/migration/indexes/applyIndexes/{realm}</p>
</li>
<li>
<p>Admin only. Calls MigrationService.applyIndexes(realm) which invokes Morphia Datastore.applyIndexes() for all mapped entities. Use this after adding @Indexed annotations.</p>
</li>
<li>
<p>Example:
curl -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/indexes/applyIndexes/system-com" class="bare">http://localhost:8080/system/migration/indexes/applyIndexes/system-com</a></p>
</li>
<li>
<p>POST /system/migration/indexes/dropAllIndexes/{realm}</p>
</li>
<li>
<p>Admin only. Drops all indexes on all mapped collections in the realm. Useful before re‑creation or when changing index definitions.</p>
</li>
<li>
<p>Example:
curl -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/indexes/dropAllIndexes/system-com" class="bare">http://localhost:8080/system/migration/indexes/dropAllIndexes/system-com</a></p>
</li>
<li>
<p>POST /system/migration/initialize/{realm}</p>
</li>
<li>
<p>Admin only. Server‑Sent Events (SSE) stream that executes all pending change sets for the specific realm.</p>
</li>
<li>
<p>Example (note -N to keep connection open):
curl -N -X POST -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/initialize/system-com" class="bare">http://localhost:8080/system/migration/initialize/system-com</a></p>
</li>
<li>
<p>GET /system/migration/start</p>
</li>
<li>
<p>Admin only. SSE stream that runs pending change sets across test, system, and default realms from configuration.</p>
</li>
<li>
<p>Example:
curl -N -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/start" class="bare">http://localhost:8080/system/migration/start</a></p>
</li>
<li>
<p>GET /system/migration/start/{realm}</p>
</li>
<li>
<p>Admin only. SSE for a specific realm.</p>
</li>
<li>
<p>Example:
curl -N -H "Authorization: Bearer $TOKEN" <a href="http://localhost:8080/system/migration/start/my-realm" class="bare">http://localhost:8080/system/migration/start/my-realm</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SSE responses stream human‑readable messages produced by MigrationService and your change sets. The connection ends with "Task completed" or an error message.</p>
</div>
</div>
<div class="sect2">
<h3 id="_perentity_index_management_baseresource">26.8. Per‑entity index management (BaseResource)</h3>
<div class="paragraph">
<p>Every entity resource that extends BaseResource&lt;T, R extends BaseMorphiaRepo&lt;T&gt;&gt; exposes a convenience endpoint to (re)create indexes for a single collection in a realm.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POST &lt;entity‑resource‑base‑path&gt;/indexes/ensureIndexes/{realm}?collectionName=&lt;collection&gt;</p>
</li>
<li>
<p>Admin only. Invokes R.ensureIndexes(realm, collectionName).</p>
</li>
<li>
<p>Use this when you want to reapply indexes for one collection without touching others.</p>
</li>
<li>
<p>Example (assuming a ProductResource at /products):
curl -X POST -H "Authorization: Bearer $TOKEN" \
     "http://localhost:8080/products/indexes/ensureIndexes/system-com?collectionName=product"</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_global_index_management_migrationservice">26.9. Global index management (MigrationService)</h3>
<div class="paragraph">
<p>MigrationService also exposes programmatic index utilities used by the MigrationResource endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applyIndexes(realm): calls Morphia Datastore.applyIndexes() for the realm.</p>
</li>
<li>
<p>dropAllIndexes(realm): iterates mapped entities and drops indexes on each underlying collection.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_validating_versions_at_startup">26.10. Validating versions at startup</h3>
<div class="ulist">
<ul>
<li>
<p>MigrationService.checkDataBaseVersion() compares the stored DatabaseVersion in each well‑known realm to quantum.database.version and throws a DatabaseMigrationException when lower than required. This prevents the app from running against an incompatible schema.</p>
</li>
<li>
<p>MigrationService.checkInitialized(realm) is a convenience that asserts DatabaseVersion exists and is &gt;= required version; helpful for preflight checks.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_notes_and_best_practices">26.11. Notes and best practices</h3>
<div class="ulist">
<ul>
<li>
<p>Make change sets idempotent: Always check for existing records before creating/updating indexes or documents.</p>
</li>
<li>
<p>Use SemVer consistently for from/to versions. The framework computes an integer form (e.g., 1.0.3 &#8594; 103) for ordering.</p>
</li>
<li>
<p>Prefer small, focused change sets with clear descriptions and authorship.</p>
</li>
<li>
<p>Use the MultiEmitter in execute(&#8230;&#8203;) to provide progress to operators consuming the SSE endpoint.</p>
</li>
<li>
<p>Apply new indexes with applyIndexes after deploying models with new @Indexed annotations; optionally dropAllIndexes then applyIndexes when changing index definitions across the board.</p>
</li>
<li>
<p>Limit scope: use getApplicableDatabases() to constrain execution to specific databases, or isOverrideDatabase/getOverrideDatabaseName to target a different database when appropriate.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_checksum_vs_fromto_versions">26.11.1. Checksum vs. from/to versions</h4>
<div class="paragraph">
<p>ChangeSetBean introduces two optional mechanisms that influence whether a change set runs again after it has already executed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>changeSetVersion (int): A manual counter you increment when you intentionally want the same change set (same to-version) to run again because its logic changed or needs to reapply. Defaults to 1.</p>
</li>
<li>
<p>checksum (String): A content-derived fingerprint of the change set’s implementation. If provided, the framework will re-run the change set whenever the checksum differs from the last recorded value, even if versions and changeSetVersion are unchanged.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How they complement getDbFromVersion/getDbToVersion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>getDbFromVersion/getDbToVersion define the database version boundary the change set moves the realm across. They control ordering and whether the database version should advance on success.</p>
</li>
<li>
<p>changeSetVersion/checksum control repeatability of a change set at a fixed to-version. They do not change ordering; they only indicate that the change set should be applied again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Typical usage patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minor logic refactor that should re-apply: bump changeSetVersion, or update checksum if you compute it from code/resources.</p>
</li>
<li>
<p>Data or index definition tweaked without a version bump: provide getChecksum() that reflects the relevant definitions (e.g., hash of DDL/index specs or embedded dataset), so the system auto-detects changes and re-runs.</p>
</li>
<li>
<p>Actual schema version change: bump getDbToVersion (and possibly from) as usual; you may leave changeSetVersion and checksum alone.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Recording and behavior in ChangeSetRecord:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On each execution, MigrationService stores changeSetVersion and checksum alongside from/to versions.</p>
</li>
<li>
<p>A change set is considered pending if no record exists, or the bean’s changeSetVersion is greater than the recorded one, or the bean’s checksum is non-null and differs from the recorded checksum.</p>
</li>
<li>
<p>After a successful run, DatabaseVersion is updated to dbToVersion if it is higher than current.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caveats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you return null from getChecksum(), only first-run and changeSetVersion increases can trigger re-execution.</p>
</li>
<li>
<p>Ensure your checksum is stable across processes and deterministic for the same logic; do not include timestamps or environment-specific data.</p>
</li>
<li>
<p>When migrating large datasets, prefer idempotent logic so repeated runs are safe even if checksum forces a re-run.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-testing">27. 11. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Problem: Validating behavior quickly and reliably, including tenant-specific behavior.</p>
</div>
<div class="paragraph">
<p>Why for SaaS: Isolation, entitlements, and data variance require strong test coverage.</p>
</div>
<div class="paragraph">
<p>How Quantum helps: Test utilities, runtime hooks, and integration testing guidance.</p>
</div>
<div class="paragraph">
<p>Walkthrough: Write integration tests for APIs and seed packs.</p>
</div>
<div class="sect2">
<h3 id="testing">27.1. Testing in Quantum: Security Contexts, Repos, and REST APIs</h3>
<div class="sect3">
<h4 id="_testing_framework">27.1.1. Testing Framework</h4>
<div class="paragraph">
<p>This guide explains how to write effective tests in the Quantum framework, with a focus on setting the security context and choosing the right Quarkus testing patterns for repository logic vs. REST APIs.</p>
</div>
<div class="paragraph">
<p>It covers four practical patterns you can use to establish the security context in tests:
- Extending BaseRepoTest
- Using a try-with-resources SecuritySession
- Using a scoped-call pattern to wrap work under a SecuritySession
- Using the @TestSecurity annotation</p>
</div>
<div class="paragraph">
<p>In addition, it outlines how to test REST endpoints vs. repository logic and highlights useful features of the Quarkus Test Framework.</p>
</div>
</div>
<div class="sect3">
<h4 id="_prerequisites_and_glossary">27.1.2. Prerequisites and glossary</h4>
<div class="ulist">
<ul>
<li>
<p>RuleContext: the in-memory rule engine configuration used by authorization checks.</p>
</li>
<li>
<p>PrincipalContext (pContext): who is performing the action (userId, roles, realms, data domain).</p>
</li>
<li>
<p>ResourceContext (rContext): what is being acted upon (area/domain, resource, action).</p>
</li>
<li>
<p>SecuritySession: a small utility that binds PrincipalContext and ResourceContext to SecurityContext for the current thread, and clears them on close.</p>
</li>
<li>
<p>SecurityIdentity: Quarkus’ current identity (used by @TestSecurity and HTTP request security).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_1_extend_baserepotest">27.1.3. Pattern 1 — Extend BaseRepoTest</h4>
<div class="paragraph">
<p>For repository tests (no HTTP), the simplest approach is to extend BaseRepoTest.</p>
</div>
<div class="paragraph">
<p>What BaseRepoTest does for you:
- Initializes RuleContext with default rules.
- Builds default pContext and rContext for a system/test user.
- Ensures test database migrations are applied.
- Gives you protected fields pContext and rContext you can use in your test.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@QuarkusTest</span>
<span class="type">class</span> <span class="class">MyRepoTest</span> <span class="directive">extends</span> com.e2eq.framework.persistent.BaseRepoTest {

  <span class="annotation">@Inject</span>
  com.e2eq.framework.model.persistent.morphia.UserProfileRepo userProfileRepo;

  <span class="annotation">@Test</span>
  <span class="type">void</span> canReadUnderTestUser() {
    <span class="comment">// Activate the security context for this block</span>
    <span class="keyword">try</span> (<span class="directive">final</span> com.e2eq.framework.securityrules.SecuritySession ignored =
             <span class="keyword">new</span> com.e2eq.framework.securityrules.SecuritySession(pContext, rContext)) {
      <span class="type">var</span> list = userProfileRepo.list(testUtils.getTestRealm());
      org.junit.jupiter.api.Assertions.assertNotNull(list);
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- BaseRepoTest prepares contexts but does not keep them permanently active. Wrap repo calls that require authorization in a SecuritySession (see Pattern 2), or activate it in @BeforeEach if many test methods use it.
- BaseRepoTest also runs migrations once using your test principal, which avoids authorization failures during initialization.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_2_try_with_resources_securitysession">27.1.4. Pattern 2 — Try-with-resources SecuritySession</h4>
<div class="paragraph">
<p>Use SecuritySession explicitly to scope work that should run under a specific PrincipalContext and ResourceContext. This is the most explicit pattern and works in both repository and service-level tests.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@QuarkusTest</span>
<span class="type">class</span> <span class="class">CredentialRepoTest</span> <span class="directive">extends</span> com.e2eq.framework.persistent.BaseRepoTest {

  <span class="annotation">@Inject</span>
  com.e2eq.framework.model.persistent.morphia.CredentialRepo credRepo;

  <span class="annotation">@Test</span>
  <span class="type">void</span> findByUserId_asTestUser() {
    <span class="keyword">try</span> (<span class="directive">final</span> com.e2eq.framework.securityrules.SecuritySession s =
             <span class="keyword">new</span> com.e2eq.framework.securityrules.SecuritySession(pContext, rContext)) {
      <span class="type">var</span> op = credRepo.findByUserId(testUtils.getTestUserId(), testUtils.getSystemRealm());
      org.junit.jupiter.api.Assertions.assertTrue(op.isPresent());
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tips:
- Prefer try-with-resources so contexts are always cleared, even when assertions fail.
- You can construct custom PrincipalContext/ResourceContext for specific scenarios (e.g., different roles or realms) and pass them to SecuritySession.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_3_scoped_call_wrapper_scopedcallscope">27.1.5. Pattern 3 — Scoped-call wrapper (ScopedCallScope)</h4>
<div class="paragraph">
<p>If you prefer not to repeat try-with-resources blocks, wrap your work in a helper that creates a SecuritySession, runs your logic, and ensures cleanup. This is sometimes called a “scoped call” pattern, often referred to as a ScopedCallScope.</p>
</div>
<div class="paragraph">
<p>Example helper (placed in test sources):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">SecurityScopes</span> {
  <span class="directive">private</span> SecurityScopes() {}

  <span class="directive">public</span> <span class="directive">static</span> &lt;T&gt; T call(
      com.e2eq.framework.model.securityrules.PrincipalContext p,
      com.e2eq.framework.model.securityrules.ResourceContext r,
      java.util.concurrent.Callable&lt;T&gt; work) {
    <span class="keyword">try</span> (<span class="directive">final</span> com.e2eq.framework.securityrules.SecuritySession s =
             <span class="keyword">new</span> com.e2eq.framework.securityrules.SecuritySession(p, r)) {
      <span class="keyword">try</span> { <span class="keyword">return</span> work.call(); }
      <span class="keyword">catch</span> (<span class="exception">Exception</span> e) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e); }
    }
  }

  <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> run(
      com.e2eq.framework.model.securityrules.PrincipalContext p,
      com.e2eq.framework.model.securityrules.ResourceContext r,
      <span class="predefined-type">Runnable</span> work) {
    <span class="keyword">try</span> (<span class="directive">final</span> com.e2eq.framework.securityrules.SecuritySession s =
             <span class="keyword">new</span> com.e2eq.framework.securityrules.SecuritySession(p, r)) {
      work.run();
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>var result = SecurityScopes.call(pContext, rContext, () -&gt; repo.getByUserId(realm, userId));
SecurityScopes.run(pContext, rContext, () -&gt; repo.save(realm, entity));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This achieves the same effect as try-with-resources but centralizes the pattern.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pattern_4_testsecurity_annotation_quarkus">27.1.6. Pattern 4 — @TestSecurity annotation (Quarkus)</h4>
<div class="paragraph">
<p>For tests that run through HTTP (and in some repo tests), you can use Quarkus’ @io.quarkus.test.security.TestSecurity to set the SecurityIdentity without creating a SecuritySession.</p>
</div>
<div class="paragraph">
<p>Quantum integrates with this in two places:
- SecurityFilter: when a request has a SecurityIdentity but no JWT, it builds a PrincipalContext from the identity (user and roles). You can also pass X-Realm to control the realm.
- MorphiaRepo: when repo methods are invoked under @TestSecurity with no active SecuritySession, MorphiaRepo lazily builds PrincipalContext from SecurityIdentity and sets a safe default ResourceContext to enable rule evaluation.</p>
</div>
<div class="paragraph">
<p>Example (HTTP):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@QuarkusTest</span>
<span class="type">class</span> <span class="class">SecureResourceTest</span> {

  <span class="annotation">@Inject</span> com.e2eq.framework.util.TestUtils testUtils;

  <span class="annotation">@Test</span>
  <span class="annotation">@io</span>.quarkus.test.security.TestSecurity(user = <span class="string"><span class="delimiter">&quot;</span><span class="content">test@system.com</span><span class="delimiter">&quot;</span></span>, roles = {<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>})
  <span class="type">void</span> listProfiles_asUser() {
    io.restassured.RestAssured.given()
      .header(<span class="string"><span class="delimiter">&quot;</span><span class="content">X-Realm</span><span class="delimiter">&quot;</span></span>, testUtils.getTestRealm())
      .when().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/user/userProfile/list</span><span class="delimiter">&quot;</span></span>)
      .then().statusCode(<span class="integer">200</span>);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example (repo call under @TestSecurity fallback, no SecuritySession):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@QuarkusTest</span>
<span class="type">class</span> <span class="class">RepoFallbackTest</span> {

  <span class="annotation">@Inject</span> com.e2eq.framework.util.TestUtils testUtils;
  <span class="annotation">@Inject</span> com.e2eq.framework.model.persistent.morphia.CredentialRepo credentialRepo;

  <span class="annotation">@Test</span>
  <span class="annotation">@io</span>.quarkus.test.security.TestSecurity(user = <span class="string"><span class="delimiter">&quot;</span><span class="content">test@system.com</span><span class="delimiter">&quot;</span></span>, roles = {<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>})
  <span class="type">void</span> repoUsesIdentityWhenNoSecuritySession() {
    <span class="comment">// Internally, MorphiaRepo will ensure PrincipalContext exists using SecurityIdentity</span>
    credentialRepo.findByUserId(<span class="string"><span class="delimiter">&quot;</span><span class="content">nonexistent@end2endlogic.com</span><span class="delimiter">&quot;</span></span>, testUtils.getTestRealm(), <span class="predefined-constant">false</span>);
    <span class="comment">// Optionally assert that SecurityContext has been initialized</span>
    org.junit.jupiter.api.Assertions.assertTrue(
      com.e2eq.framework.model.securityrules.SecurityContext.getPrincipalContext().isPresent());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- @TestSecurity is perfect for authorizing requests in HTTP tests without generating JWTs.
- For repo tests that require precise ResourceContext (area/domain/action), prefer SecuritySession; MorphiaRepo sets a generic default ResourceContext when needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_rest_apis_vs_repository_logic">27.1.7. Testing REST APIs vs. Repository Logic</h4>
<div class="paragraph">
<p>When to prefer REST (HTTP) tests:
- End-to-end authorization: validate request filters, identity mapping, realm headers, and JWT handling.
- Request/response shape and status codes.
- Role-based access checks via @TestSecurity.</p>
</div>
<div class="paragraph">
<p>How to test REST APIs:
- Use @QuarkusTest and RestAssured:
  [source,java]
  ----
  var resp = io.restassured.RestAssured.given()
      .header("Content-Type", "application/json")
      .header("X-Realm", testUtils.getTestRealm())
      .when().get("/user/userProfile/list")
      .then().statusCode(200).extract().response();
  ----
- To test JWT-protected endpoints end-to-end, first call the login API to obtain a token, then pass Authorization: Bearer &lt;token&gt;. See SecurityTest.testGetUserProfileRESTAPI for a complete example.</p>
</div>
<div class="paragraph">
<p>When to prefer repository/service tests:
- You want precise control over PrincipalContext/ResourceContext and rule evaluation without HTTP overhead.
- You are asserting persistence logic, query filters, or domain rules.</p>
</div>
<div class="paragraph">
<p>How to test repository logic:
- Extend BaseRepoTest (Pattern 1) for ready-to-use pContext/rContext and migrations.
- Wrap calls with SecuritySession (Pattern 2) or use a scoped-call helper (Pattern 3).</p>
</div>
</div>
<div class="sect3">
<h4 id="_useful_quarkus_test_features">27.1.8. Useful Quarkus Test features</h4>
<div class="ulist">
<ul>
<li>
<p>@QuarkusTest: boots the app for integration tests with CDI, config, and persistence.</p>
</li>
<li>
<p>RestAssured: fluent HTTP client baked into Quarkus tests; supports JSON assertions and extraction.</p>
</li>
<li>
<p>@TestSecurity: set SecurityIdentity (user, roles) for tests.</p>
</li>
<li>
<p>@InjectMock/@InjectSpy (quarkus-junit5-mockito): replace beans with mocks/spies for isolation.</p>
</li>
<li>
<p>@QuarkusTestResource: manage external resources (e.g., starting/stopping containers) for a test class or suite.</p>
</li>
<li>
<p>@TestHTTPEndpoint and @TestHTTPResource: convenient endpoint URI injection.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_real_world_tips">27.1.9. Real-world tips</h4>
<div class="ulist">
<ul>
<li>
<p>Clearing thread locals: If you manipulate SecurityContext directly in advanced tests, clear it in @AfterEach to avoid cross-test leakage:
[source,java]
----
@AfterEach
void cleanup() { com.e2eq.framework.model.securityrules.SecurityContext.clear(); }
----</p>
</li>
<li>
<p>Realm routing: pass X-Realm in REST tests to select the target realm. SecurityFilter also validates realm access against user credentials when present.</p>
</li>
<li>
<p>Data prep: If your test needs specific users/roles, create them under a SecuritySession beforehand (see SecurityTest.ensureTestUserExists()).</p>
</li>
<li>
<p>Logging: enable DEBUG for com.e2eq to inspect rule evaluation and identity resolution during tests.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_summary_2">27.1.10. Summary</h4>
<div class="ulist">
<ul>
<li>
<p>Use BaseRepoTest for repository tests and migrations, and wrap work in SecuritySession.</p>
</li>
<li>
<p>For less ceremony, create a simple scoped-call helper to run code under a SecuritySession.</p>
</li>
<li>
<p>For REST/API tests and quick identity setup, use @TestSecurity, realm headers, and RestAssured.</p>
</li>
<li>
<p>For full e2e security, obtain a JWT via the login API and include it in requests.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-next-steps">28. 12. Next steps</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Explore the Supply Chain sample tutorial for an end-to-end scenario.</p>
</li>
<li>
<p>Use the Reference Guide to quickly jump to deeper explanations of any topic above.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference-guide">29. Reference Guide</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="_quantum_reference_guide" class="sect0">Quantum Reference Guide</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This reference is a topic-based index that links to the in-depth tutorial sections.
Use it to jump directly to a subject and then explore details in context.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_platform">30. Platform</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Overview: <a href="../tutorials/quantum-tutorial.html#sec-overview">Platform overview</a></p>
</li>
<li>
<p>Project setup: <a href="../tutorials/quantum-tutorial.html#sec-setup">Project setup</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modeling_and_tenancy">31. Modeling and Tenancy</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Ontologies in Quantum (deep dive): <a href="./ontology.html">Modeling relationships with ontologies</a></p>
</li>
<li>
<p>Concrete e-commerce example: <a href="./ontology.html#ontology-ecommerce-example">Orders, Shipments, Fulfillment, Returns</a></p>
</li>
<li>
<p>Integration with Morphia/permissions: <a href="./ontology.html#ontology-integration-morphia-permissions">Integrating ontology with rules and repos</a></p>
</li>
<li>
<p>Domain modeling: <a href="../tutorials/quantum-tutorial.html#sec-modeling">Domain modeling fundamentals</a></p>
</li>
<li>
<p>Tenant models and realms: <a href="../tutorials/quantum-tutorial.html#sec-tenant-models">Multi-tenant model and realm separation</a></p>
</li>
<li>
<p>Domain rule context: <a href="../tutorials/quantum-tutorial.html#sec-domain-rule-context">Domain rule context</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_apis_and_queries">32. APIs and Queries</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>REST CRUD: <a href="../tutorials/quantum-tutorial.html#sec-rest-crud">Building RESTful CRUD APIs</a></p>
</li>
<li>
<p>Query language: <a href="../tutorials/quantum-tutorial.html#sec-query-language">Query language and filtering</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">33. Security</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Authentication: <a href="../tutorials/quantum-tutorial.html#sec-security">Authentication, permissions, and annotations</a></p>
</li>
<li>
<p>Permissions: <a href="../tutorials/quantum-tutorial.html#sec-security">Permissions</a></p>
</li>
<li>
<p>Security annotations: <a href="../tutorials/quantum-tutorial.html#sec-security">Security annotations</a></p>
</li>
<li>
<p>Permission Resource Check APIs: <a href="./permission-resource.html">Permission Resource: Check APIs and Client Usage</a></p>
</li>
<li>
<p>Label resolution and script helpers: <a href="./permissions.html#label-resolution-spi">Labels (SPI) and hasLabel()</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_seeding">34. Data Seeding</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Seed packs (tutorial): <a href="../tutorials/quantum-tutorial.html#sec-seed-packs">Seed packs: Declarative tenant seeding</a></p>
</li>
<li>
<p>Seed packs (deep dive document): <a href="./seed-packs.html">Seed packs and declarative tenant seeding</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operations">35. Operations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Migrations: <a href="../tutorials/quantum-tutorial.html#sec-migrations">Migrations</a></p>
</li>
<li>
<p>Testing: <a href="../tutorials/quantum-tutorial.html#sec-testing">Testing</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_samples">36. Samples</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Supply Chain tutorial: <a href="../tutorials/supply-chain.html">Supply Chain</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix">37. Appendix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For configuration, Quarkus integration details, and glossary, see the Appendix in the main index.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-chapter">38. Ontology Modeling</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="_ontology_modeling" class="sect0">Ontology Modeling</h1>
<div class="sect1">
<h2 id="ontologies-in-quantum">39. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Looking for the short implementation plan? See PROPOSAL.md at the repository root for a concise module-by-module checklist.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section explains what an ontology is, how it differs from a traditional object model, and how the Quantum Ontology modules make it practical to apply ontology ideas to your domain models and queries. It also contrasts ontology-driven relationships with direct object references (for example, using @Reference or EntityReference).</p>
</div>
<div class="sect2">
<h3 id="_what_is_an_ontology_2">39.1. What is an Ontology?</h3>
<div class="paragraph">
<p>In software terms, an ontology is a formal, explicit specification of concepts and their relationships.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concepts (Classes): Named categories/types in your domain. Concepts can form taxonomies (is-a hierarchies), be declared disjoint, or be equivalent.</p>
</li>
<li>
<p>Relationships (Properties): Named relationships between entities. Properties can have a domain (applies to X) and a range (points to Y). They may be inverse or transitive.</p>
</li>
<li>
<p>Axioms (Rules): Constraints and entailment rules, including property chains such as: if (A --p-&#8594; B) and (B --q-&#8594; C) then we infer (A --r-&#8594; C).</p>
</li>
<li>
<p>Inference: The process of deriving new facts (types, labels, edges) that were not explicitly stored but follow from axioms and known facts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An ontology is not the data; it is the schema plus logic that gives your data additional meaning and enables consistent, automated inferences.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ontology_vs_object_model_2">39.2. Ontology vs. Object Model</h3>
<div class="paragraph">
<p>A conventional object model focuses on concrete classes, fields, and direct references between objects at implementation time. An ontology focuses on semantic types and relationships, with explicit rules that can derive new knowledge independent of how objects are instantiated.</p>
</div>
<div class="paragraph">
<p>Key differences:</p>
</div>
<div class="paragraph">
<p>Purpose</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Object model: Encapsulate data and behavior for application code generation and persistence.</p>
</li>
<li>
<p>Ontology: Encode shared meaning, constraints, and inference rules that remain stable as implementation details change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relationship handling</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Object model: Typically uses direct references or foreign keys; traversals are hard-coded and fragile to change.</p>
</li>
<li>
<p>Ontology: Uses named predicates (properties) and can infer additional relationships by rules (property chains, inverses, transitivity).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Polymorphism and evolution</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Object model: Polymorphism requires class inheritance in code; cross-cutting categories are awkward to add later.</p>
</li>
<li>
<p>Ontology: Entities can have multiple types/labels at once. New concepts and properties can be introduced without breaking existing data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Querying</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Object model: Queries couple to concrete classes and field paths; changes force query rewrites.</p>
</li>
<li>
<p>Ontology: Queries target semantic relationships; reasoners can materialize edges that queries reuse, decoupling queries from implementation details.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_why_prefer_ontology_driven_relationships_over_referenceentityreference_2">39.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</h3>
<div class="paragraph">
<p>Direct references (@Reference or custom EntityReference) are simple to start but become restrictive as domains grow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tight coupling: Code and queries couple to concrete field paths (customer.primaryAddress.id), making refactors risky.</p>
</li>
<li>
<p>Limited expressivity: Hard to encode and reuse higher-order relationships (e.g., "partners of my supplier&#8217;s parent org").</p>
</li>
<li>
<p>Poor polymorphism: References point to one collection/type; accommodating multiple target types requires extra code.</p>
</li>
<li>
<p>Performance pitfalls: Deep traversals cause extra queries, N+1 selects, or complex $lookup joins.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ontology-driven edges address these issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decoupling via predicates: Use named predicates (e.g., hasAddress, memberOf, supplies) that remain stable while internal object fields change.</p>
</li>
<li>
<p>Inference for reachability: Property chains can materialize implied links (A --p-&#8594; B &amp; B --q-&#8594; C &#8658; A --r-&#8594; C), avoiding runtime multi-hop traversals.</p>
</li>
<li>
<p>Polymorphism-first: A predicate can connect heterogeneous types; type inferences (domain/range) remain consistent.</p>
</li>
<li>
<p>Query performance: Pre-materialized edges allow single-hop, index-friendly queries (in or eq filters) instead of ad-hoc multi-collection traversals.</p>
</li>
<li>
<p>Resilience to change: You can add or modify rules without rewriting data structures or touching referencing fields across models.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_quantum_supports_ontologies_2">39.4. How Quantum supports Ontologies</h3>
<div class="paragraph">
<p>Quantum provides three cooperating modules that make ontology modeling practical and fast:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum-ontology-core (package com.e2eq.ontology.core)</p>
</li>
<li>
<p>OntologyRegistry: Holds the TBox (terminology) of your ontology.</p>
</li>
<li>
<p>ClassDef: Concept names and relationships (parents, disjointWith, sameAs).</p>
</li>
<li>
<p>PropertyDef: Property names with optional domain, range, inverse flags, and transitivity.</p>
</li>
<li>
<p>PropertyChainDef: Rules that define multi-hop implications (chains &#8594; implied property).</p>
</li>
<li>
<p>TBox: Container for classes, properties, and property chains.</p>
</li>
<li>
<p>Reasoner interface and ForwardChainingReasoner: Given an entity snapshot and the registry, computes inferences:</p>
</li>
<li>
<p>New types/labels to assert on entities.</p>
</li>
<li>
<p>New edges to add (implied by property chains, inverses, or other rules).</p>
</li>
<li>
<p>quantum-ontology-mongo (package com.e2eq.ontology.mongo)</p>
</li>
<li>
<p>EdgeDao: A thin DAO around an edges collection in Mongo. Each edge contains tenantId, src, predicate p, dst, inferred flag, provenance, and timestamp.</p>
</li>
<li>
<p>OntologyMaterializer: Runs the Reasoner for an entity snapshot and upserts the inferred edges, so queries can be rewritten to simple in/in eq filters.</p>
</li>
<li>
<p>quantum-ontology-policy-bridge (package com.e2eq.ontology.policy)</p>
</li>
<li>
<p>ListQueryRewriter: Takes a base query and rewrites it using the EdgeDao to filter by the set of source entity ids that have a specific predicate to a given destination.</p>
</li>
<li>
<p>This integrates ontology edges with RuleContext or policy decisions: policy asks for entities related by a predicate; the rewriter converts that into an efficient Mongo query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These modules let you define your ontology (core), materialize derived relations (mongo), and leverage them in access and list queries (policy bridge).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Quarkus, all ontology components are CDI-managed. Inject EdgeDao and services via @Inject; indexes are ensured automatically at startup by OntologyMongoProducers. Configure collection/database with properties ontology.mongo.database and ontology.mongo.collection.edges.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modeling_guidance_from_object_fields_to_predicates_2">39.5. Modeling guidance: from object fields to predicates</h3>
<div class="ulist">
<ul>
<li>
<p>Name relationships explicitly</p>
</li>
<li>
<p>Define clear predicate names (hasAddress, memberOf, supplies, owns, assignedTo). Avoid encoding relationship semantics in field names only.</p>
</li>
<li>
<p>Keep object model minimal and flexible</p>
</li>
<li>
<p>Store lightweight identifiers (ids) as needed, but avoid deeply nested reference graphs that encode traversals in code.</p>
</li>
<li>
<p>Model polymorphic relationships</p>
</li>
<li>
<p>Prefer predicates that naturally connect multiple possible types (e.g., assignedTo can target User, Team, Bot) and rely on ontology type assertions to constrain where needed.</p>
</li>
<li>
<p>Use property chains for common paths</p>
</li>
<li>
<p>If business logic often traverses A &#8594; B &#8594; C, define a chain p∘q ⇒ r and materialize r for faster queries and simpler policies.</p>
</li>
<li>
<p>Capture inverses and transitivity</p>
</li>
<li>
<p>For natural inverses (parentOf ⇄ childOf) or transitive relations (partOf, locatedIn), define them in the ontology so edges and queries stay consistent.</p>
</li>
<li>
<p>Keep provenance</p>
</li>
<li>
<p>Record why an edge exists (prov.rule, prov.inputs) so you can recompute, audit, or retract when inputs change.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_querying_with_ontology_edges_vs_direct_references_2">39.6. Querying with ontology edges vs direct references</h3>
<div class="ulist">
<ul>
<li>
<p>Direct reference example (fragile/slow)</p>
</li>
<li>
<p>Query: "Find Orders whose buyer belongs to Org X or its parents."</p>
</li>
<li>
<p>With @Reference: requires joining Order &#8594; User &#8594; Org and recursing org.parent; costly and tightly coupled to fields.</p>
</li>
<li>
<p>Ontology edge example (resilient/fast)</p>
</li>
<li>
<p>Define predicates: placedBy(order, user), memberOf(user, org), ancestorOf(org, org). Define chain placedBy ∘ memberOf ⇒ placedInOrg.</p>
</li>
<li>
<p>Materialize edges: (order --placedInOrg-&#8594; org). Also make ancestorOf transitive.</p>
</li>
<li>
<p>Query becomes: where order._id in EdgeDao.srcIdsByDst(tenantId, "placedInOrg", orgX).</p>
</li>
<li>
<p>With transitivity, you can precompute ancestor closure or add a chain placedInOrg ∘ ancestorOf ⇒ placedInOrg to include parents automatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_from_reference_to_ontology_edges_2">39.7. Migration: from @Reference to ontology edges</h3>
<div class="ulist">
<ul>
<li>
<p>Start by introducing predicates alongside existing references; do not remove references immediately.</p>
</li>
<li>
<p>Materialize edges for hot read paths; keep provenance so you can reconstruct.</p>
</li>
<li>
<p>Gradually update queries (list screens, policy filters) to use ListQueryRewriter with EdgeDao instead of deep traversals or $lookup.</p>
</li>
<li>
<p>Once stable, you can simplify models by removing rigid reference fields where unnecessary and rely on edges for read-side composition.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_performance_and_operational_notes_2">39.8. Performance and operational notes</h3>
<div class="ulist">
<ul>
<li>
<p>Indexing: Create compound indexes on edges: (tenantId, p, dst) and (tenantId, src, p) to support both reverse and forward lookups.</p>
</li>
<li>
<p>Write amplification vs read wins: Materialization adds write work, but dramatically improves read latency and simplifies queries.</p>
</li>
<li>
<p>Consistency: Re-materialize edges on relevant entity changes (source, destination, or intermediate) using OntologyMaterializer.</p>
</li>
<li>
<p>Multi-tenancy: Keep tenantId in the edge key and filters; the provided EdgeDao methods include tenant scoping.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_this_integrates_with_functional_areasdomains_2">39.9. How this integrates with Functional Areas/Domains</h3>
<div class="ulist">
<ul>
<li>
<p>Functional domains often map to concept clusters in the ontology. Use @FunctionalMapping to aid discovery and apply policies per area/domain.</p>
</li>
<li>
<p>Policies can refer to relationships semantically ("hasEdge placedInOrg OrgX") and rely on the policy bridge to turn this into efficient data filters.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_3">39.10. Summary</h3>
<div class="ulist">
<ul>
<li>
<p>Ontology-powered relationships provide a stable, semantic layer over your object model.</p>
</li>
<li>
<p>The Quantum Ontology modules let you define, infer, and query these relationships efficiently on MongoDB.</p>
</li>
<li>
<p>Compared with direct @Reference/EntityReference, ontology edges are more expressive, resilient to change, and typically faster for complex list/policy queries once materialized.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-ecommerce-example">40. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example shows how to use an ontology to model relationships around Orders, Customers, and Shipments, and how the model can evolve to include Fulfillment and Returns without breaking existing queries. We will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define core concepts and predicates.</p>
</li>
<li>
<p>Add property chains that materialize implied relationships for fast queries.</p>
</li>
<li>
<p>Show how queries are rewritten using edges instead of deep object traversals.</p>
</li>
<li>
<p>Evolve the model to support Fulfillment and Returns with minimal changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core concepts (classes)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order, Customer, Organization, Shipment, Address, Region</p>
</li>
<li>
<p>Later evolution: FulfillmentTask, FulfillmentUnit, ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key predicates (relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy(order, customer): who placed the order</p>
</li>
<li>
<p>memberOf(customer, org): a customer belongs to an organization (or account)</p>
</li>
<li>
<p>orderHasShipment(order, shipment): outbound shipment for the order</p>
</li>
<li>
<p>shipsTo(shipment, address): shipment destination</p>
</li>
<li>
<p>locatedIn(address, region): address is located in a Region</p>
</li>
<li>
<p>ancestorOf(org, org): organizational ancestry (transitive)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Property chains (implied relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy ∘ memberOf ⇒ placedInOrg</p>
</li>
<li>
<p>If (order --placedBy-&#8594; customer) and (customer --memberOf-&#8594; org), then infer (order --placedInOrg-&#8594; org)</p>
</li>
<li>
<p>orderHasShipment ∘ shipsTo ⇒ orderShipsTo</p>
</li>
<li>
<p>If (order --orderHasShipment-&#8594; shipment) and (shipment --shipsTo-&#8594; address), infer (order --orderShipsTo-&#8594; address)</p>
</li>
<li>
<p>orderShipsTo ∘ locatedIn ⇒ orderShipsToRegion</p>
</li>
<li>
<p>If (order --orderShipsTo-&#8594; address) and (address --locatedIn-&#8594; region), infer (order --orderShipsToRegion-&#8594; region)</p>
</li>
<li>
<p>placedInOrg ∘ ancestorOf ⇒ placedInOrg</p>
</li>
<li>
<p>Makes placedInOrg resilient to org hierarchy changes (ancestorOf is transitive). This is a common “closure” trick: re-assert the same predicate via chain to absorb hierarchy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Diagram of the core classes and predicates for this example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-graphviz-md5-4ca094e1102e9d1f770462f4e7ca96d4.svg" alt="Diagram" width="864" height="311">
</div>
</div>
<div class="paragraph">
<p>A minimal Java-style snippet to define this TBox</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util</span>.*;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>.*;

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, PropertyDef&gt; props = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">true</span>), <span class="comment">// transitive</span>
  <span class="comment">// implied predicates (no domain/range required, but you may add them for validation)</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>)
);

<span class="predefined-type">List</span>&lt;PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
);

OntologyRegistry.TBox tbox = <span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains);
OntologyRegistry registry = OntologyRegistry.inMemory(tbox);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Materializing edges for an Order</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit facts for order O1:</p>
</li>
<li>
<p>O1 placedBy C9</p>
</li>
<li>
<p>C9 memberOf OrgA</p>
</li>
<li>
<p>O1 orderHasShipment S17</p>
</li>
<li>
<p>S17 shipsTo Addr42</p>
</li>
<li>
<p>Addr42 locatedIn RegionWest</p>
</li>
<li>
<p>OrgA ancestorOf OrgParent</p>
</li>
<li>
<p>Inferred edges after running the reasoner for O1’s snapshot:</p>
</li>
<li>
<p>O1 placedInOrg OrgA</p>
</li>
<li>
<p>O1 placedInOrg OrgParent (via closure with ancestorOf)</p>
</li>
<li>
<p>O1 orderShipsTo Addr42</p>
</li>
<li>
<p>O1 orderShipsToRegion RegionWest</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How queries become simple and fast</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders for Organization OrgParent (including children):</p>
</li>
<li>
<p>Instead of joining Order &#8594; Customer &#8594; Org and recursing org.parent, run a single filter using materialized edges.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.mongodb.client.model.Filters</span>;
<span class="keyword">import</span> <span class="include">org.bson.conversions.Bson</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.policy.ListQueryRewriter</span>;

Bson base = Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Use rewritten in your Mongo find</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson rewritten2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why this is resilient</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If tomorrow Customer becomes AccountContact and the organization model gains Divisions and multi-parent org graphs, you only adjust predicates and chains.</p>
</li>
<li>
<p>Queries that rely on placedInOrg or orderShipsToRegion remain unchanged and fast, because edges are re-materialized by OntologyMaterializer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evolving the model: add Fulfillment</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FulfillmentTask: a unit of work to pick/pack/ship order lines</p>
</li>
<li>
<p>FulfillmentUnit: a logical grouping (e.g., wave, tote, parcel)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills(task, order)</p>
</li>
<li>
<p>realizedBy(order, fulfillmentUnit)</p>
</li>
<li>
<p>taskProduces(task, shipment)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills ⇒ derived edge from task to order; combine with taskProduces to connect order to shipment without touching Order fields:</p>
</li>
<li>
<p>fulfills ∘ taskProduces ⇒ orderHasShipment</p>
</li>
<li>
<p>realizedBy ∘ orderHasShipment ⇒ fulfilledByUnit</p>
</li>
<li>
<p>If (order --realizedBy-&#8594; fu) and (order --orderHasShipment-&#8594; s) ⇒ (fu --fulfillsShipment-&#8594; s) or simply (order --fulfilledByUnit-&#8594; fu)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These chains let you introduce warehouse concepts without changing how UI filters orders by organization or ship-to region. Existing queries still operate via placedInOrg and orderShipsToRegion.</p>
</div>
<div class="paragraph">
<p>Evolving further: add Returns</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn(order, returnRequest)</p>
</li>
<li>
<p>returnFor(returnItem, order)</p>
</li>
<li>
<p>returnRma(returnRequest, rma)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn ⇒ openReturnOnOrg via placedInOrg:</p>
</li>
<li>
<p>hasReturn ∘ placedInOrg ⇒ returnPlacedInOrg</p>
</li>
<li>
<p>returnFor ∘ orderShipsToRegion ⇒ returnShipsToRegion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example queries with new capabilities</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders with open returns in OrgParent:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnPlacedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Returns associated to Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparison with direct references (@Reference/EntityReference)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With direct references you would encode fields like Order.customer, Order.shipments, Shipment.address, Address.region and then implement multi-hop traversals in code or $lookup pipelines, rewriting them whenever you add Fulfillment or Returns.</p>
</li>
<li>
<p>With ontology edges, you keep predicates stable and add property chains. Existing list and policy queries keep working and typically become faster due to single-hop filters on an indexed edges collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational tips for this scenario</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure EdgeDao has indexes on (tenantId, p, dst) and (tenantId, src, p).</p>
</li>
<li>
<p>Use OntologyMaterializer when Order, Shipment, Customer, Address, or org hierarchy changes to keep edges fresh.</p>
</li>
<li>
<p>Keep provenance in edge.prov (rule, inputs) so you can recompute or retract edges when source data changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-visualizing-edges-and-provenance">41. Visualizing ontology edges and provenance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section uses simple diagrams to illustrate how explicit facts (edges) combine with ontology rules (property chains, inverses, transitivity) to produce inferred edges, and how provenance explains each inference.</p>
</div>
<div class="sect2">
<h3 id="_example_graph_orders_customers_organizations">41.1. Example graph: Orders, Customers, Organizations</h3>
<div class="paragraph">
<p>We start from the running example introduced above. The following diagram shows explicit edges in solid lines and inferred edges as dotted lines.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-graphviz-md5-f6605933d90779dad4b0df64cddf4ead.svg" alt="Diagram" width="953" height="168">
</div>
</div>
<div class="paragraph">
<p>You can add more nodes and predicates (shipments, addresses, regions) and draw similar diagrams. The important idea is that you query for semantics (placedInOrg), while the reasoner ensures the materialized edges exist according to the rules.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_graph_shipments_and_regions">41.2. Example graph: Shipments and Regions</h3>
<div class="imageblock">
<div class="content">
<img src="diag-graphviz-md5-d9ee623c7b9a9e666c8e0738da5e4364.svg" alt="Diagram" width="937" height="168">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_provenance_and_how_to_read_it">41.3. What is provenance and how to read it</h3>
<div class="paragraph">
<p>Every inferred edge includes a provenance payload prov that answers “why does this edge exist?”. It captures the rule used and the contributing input edges. With recent enrichments, inputs also include type information when available.</p>
</div>
<div class="paragraph">
<p>Here is an example edge document (simplified JSON for clarity) for the inference O1 --placedInOrg-&#8594; OrgA via the chain placedBy ∘ memberOf ⇒ placedInOrg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">t1</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">O1</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgA</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">inferred</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">prov</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">chain</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">chain</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>: [
        { <span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">O1</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,     <span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">C9</span><span class="delimiter">&quot;</span></span>,   <span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span> },
        { <span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">C9</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgA</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span> }
      ]
    }
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ts</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2025-10-20T10:01:02Z</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- rule indicates which inference rule created the edge (chain, inverse, symmetric, transitive, subPropertyOf).
- inputs lists the contributing explicit edges (or minimal hops) that justified the inference. When types are known from domain/range or snapshots, srcType and dstType are included.
- This provenance enables audit, troubleshooting, and selective recomputation when inputs change.</p>
</div>
<div class="paragraph">
<p>For a transitive example, an O1 --placedInOrg-&#8594; OrgParent edge could have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">prov</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">transitive</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">prop</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>: [ { <span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">O1</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgA</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span> } ]
    }
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Provenance is for explanation and maintenance. The runtime edges you query on remain simple (src, p, dst) with optional type fields for validation and indexing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_querying_ontologies">41.4. Querying Ontologies</h3>
<div class="paragraph">
<p>Quantum provides several ways to leverage ontology relationships in your queries and business logic.</p>
</div>
<div class="sect3">
<h4 id="_biapi_query_language_functions_hasedge_and_hasincomingedge">41.4.1. BIAPI Query Language Functions: hasEdge and hasIncomingEdge</h4>
<div class="paragraph">
<p>The query language (BIAPIQuery) includes built-in functions to filter entities based on their ontology edges. These are the preferred way to perform ontology-aware queries from REST APIs or permission rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>hasEdge(predicate, dst)</code></strong>: Filters for entities (sources) that have an edge pointing TO a specific destination.</p>
</li>
<li>
<p><strong><code>hasIncomingEdge(predicate, src)</code></strong>: Filters for entities (targets) that have an edge coming FROM a specific source.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example BIAPI queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Find orders placed in OrgA
hasEdge(placedInOrg, &quot;OrgA&quot;)

# Find locations accessible by a specific associate
hasIncomingEdge(canAccessLocation, &quot;associate-123&quot;)

# Combine with other filters
hasEdge(placedInOrg, &quot;OrgA&quot;) &amp;&amp; status:PENDING</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_programmatic_querying_with_edgedao">41.4.2. Programmatic Querying with EdgeDao</h4>
<div class="paragraph">
<p>For more complex scenarios in Java code, you can use the <code>EdgeDao</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
EdgeDao edgeDao;

<span class="comment">// Find all destination IDs for a given source and predicate</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; targetIds = edgeDao.dstIdsBySrc(tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Associate</span><span class="delimiter">&quot;</span></span>, associateId, <span class="string"><span class="delimiter">&quot;</span><span class="content">canAccessLocation</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Find all source IDs for a given destination and predicate</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; sourceIds = edgeDao.srcIdsByDst(tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">canAccessLocation</span><span class="delimiter">&quot;</span></span>, locationId);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-integration-morphia-permissions">42. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section focuses on integration and developer experience: how ontology edges flow into Morphia-based repositories and the permission rule language, while remaining fully multi-tenant and secure.</p>
</div>
<div class="sect2">
<h3 id="_big_picture_where_ontology_fits_2">42.1. Big picture: where ontology fits</h3>
<div class="ulist">
<ul>
<li>
<p>Write path (materialization):</p>
</li>
<li>
<p>Your domain code persists entities with minimal direct references.</p>
</li>
<li>
<p>An OntologyMaterializer runs when entities change to derive and upsert edges into the edges collection (per tenant).</p>
</li>
<li>
<p>Policy path (authorization and list filters):</p>
</li>
<li>
<p>The permission rule language evaluates the caller’s SecurityContext/RuleContext and produces logical filters.</p>
</li>
<li>
<p>When a rule asks for a semantic relationship (hasEdge), we use ListQueryRewriter + EdgeDao to translate that into efficient Mongo filters over ids.</p>
</li>
<li>
<p>Read path (queries):</p>
</li>
<li>
<p>Morphia repos apply the base data-domain filters and the rewritten ontology constraint to queries, producing fast lists without deep joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rule_language_add_hasedge_2">42.2. Rule language: add hasEdge()</h3>
<div class="paragraph">
<p>We introduce a policy function/operator to reference ontology edges directly from rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature: hasEdge(predicate, dstIdOrVar)</p>
</li>
<li>
<p>predicate: String name of the ontology predicate (e.g., "placedInOrg", "orderShipsToRegion").</p>
</li>
<li>
<p>dstIdOrVar: Either a concrete id/refName or a variable resolved from RuleContext (e.g., principal.orgRefName, request.region).</p>
</li>
<li>
<p>Semantics: The rule grants/filters entities for which an edge (tenantId, src = entity._id, p = predicate, dst = resolvedDst) exists.</p>
</li>
<li>
<p>Composition: hasEdge can be combined with existing rule clauses (and/or/not) and other filters (states, tags, ownerId, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example rule snippets (illustrative):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow viewing Orders in the caller’s org (including ancestors via ontology closure):</p>
</li>
<li>
<p>allow VIEW Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Restrict list to Orders shipping to a region chosen in request:</p>
</li>
<li>
<p>allow LIST Order when hasEdge("orderShipsToRegion", request.region)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under the hood, policy evaluation uses ListQueryRewriter.hasEdge(&#8230;&#8203;), which converts hasEdge into a Morphia Filter limiting _id to the allowed source ids; compose it with your base filter via Filters.and(&#8230;&#8203;).</p>
</div>
</div>
<div class="sect2">
<h3 id="_passing_tenantid_correctly_2">42.3. Passing tenantId correctly</h3>
<div class="ulist">
<ul>
<li>
<p>Always resolve tenantId from RuleContext/SecurityContext (the same source your repos use for realm/database selection).</p>
</li>
<li>
<p>EdgeDao and ListQueryRewriter already accept tenantId; never cross tenant boundaries when reading edges.</p>
</li>
<li>
<p>Index recommendation (per tenant):</p>
</li>
<li>
<p>(tenantId, p, dst)</p>
</li>
<li>
<p>(tenantId, src, p)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_morphia_repository_integration_patterns_2">42.4. Morphia repository integration patterns</h3>
<div class="paragraph">
<p>The goal is zero-friction usage in existing repos without invasive changes.</p>
</div>
<div class="paragraph">
<p>Option A: Apply ontology constraints in code paths that already construct BSON filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your repo method builds a Bson filter before calling find(), wrap it through rewriter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Bson base = Filters.and(existingFilter1, existingFilter2);
Bson rewritten = hasEdgeRequested
  ? rewriter.rewriteForHasEdge(base, tenantId, predicate, dst)
  : base;
var cursor = datastore.getDatabase().getCollection(coll).find(rewritten);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option B: Apply ontology constraints to Morphia Filter/Query via ids.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the repo uses Morphia’s typed query API instead of BSON, pre-compute the id set and constrain by _id:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Set&lt;String&gt; ids = edgeDao.srcIdsByDst(tenantId, predicate, dst);
if (ids.isEmpty()) {
  return List.of(); // short-circuit
}
query.filter(Filters.in(&quot;_id&quot;, ids));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option C: Centralize in a tiny helper for developer ergonomics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide one helper in your application layer, invoked wherever policies inject additional constraints:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">OntologyFilterHelper</span> {
  <span class="directive">private</span> <span class="directive">final</span> ListQueryRewriter rewriter;
  <span class="directive">public</span> OntologyFilterHelper(ListQueryRewriter r) { <span class="local-variable">this</span>.rewriter = r; }

  <span class="directive">public</span> Bson ensureHasEdge(Bson base, <span class="predefined-type">String</span> tenantId, <span class="predefined-type">String</span> predicate, <span class="predefined-type">String</span> dst) {
    <span class="keyword">return</span> rewriter.rewriteForHasEdge(base, tenantId, predicate, dst);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_where_ontology_materialization_happens">42.5. Where ontology materialization happens</h3>
<div class="ulist">
<ul>
<li>
<p>Automatic on write via repository hook:</p>
</li>
<li>
<p>When you save or update an entity, the framework runs an internal PostPersistHook (OntologyWriteHook) that:</p>
</li>
<li>
<p>extracts explicit edges from fields/getters annotated with @OntologyProperty using a startup-built metadata cache (no per-call reflection), and</p>
</li>
<li>
<p>calls OntologyMaterializer to infer inverse, transitive, symmetric, and super-property edges and upsert them to the edges collection.</p>
</li>
<li>
<p>This is enabled by default. To disable temporarily (e.g., for bulk loads), set: ontology.auto-materialize=false</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="custom-edge-providers">42.6. Custom Edge Providers: OntologyEdgeProvider and HierarchyListEdgeProvider</h3>
<div class="paragraph">
<p>While annotations (<code>@OntologyProperty</code>) and property chains cover many use cases, some relationships require custom logic to determine edges. Quantum provides an SPI for implementing custom edge providers that are automatically discovered and integrated into the materialization process.</p>
</div>
<div class="sect3">
<h4 id="_ontologyedgeprovider_the_core_spi">42.6.1. OntologyEdgeProvider: The Core SPI</h4>
<div class="paragraph">
<p>The <code>OntologyEdgeProvider</code> interface allows you to contribute explicit edges for any entity instance. These edges are merged with annotation-derived edges before being passed to the reasoner.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">OntologyEdgeProvider</span> {
    <span class="comment">/** @return true if this provider supports the given entity type */</span>
    <span class="type">boolean</span> supports(<span class="predefined-type">Class</span>&lt;?&gt; entityType);

    <span class="comment">/** Produce explicit edges for the given entity instance */</span>
    <span class="predefined-type">List</span>&lt;Reasoner.Edge&gt; edges(<span class="predefined-type">String</span> realmId, DataDomainInfo dataDomainInfo, <span class="predefined-type">Object</span> entity);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementations should be annotated with <code>@ApplicationScoped</code> for CDI discovery.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hierarchylistedgeprovider_handling_complex_hierarchies">42.6.2. HierarchyListEdgeProvider: Handling Complex Hierarchies</h4>
<div class="paragraph">
<p>A common pattern in SaaS applications is assigning users/entities to nodes in a hierarchy (e.g., Territories, Organizations) where they should also "inherit" relationships from descendant nodes. <code>HierarchyListEdgeProvider</code> is a specialized base class designed for this purpose.</p>
</div>
<div class="paragraph">
<p>Key features:
- <strong>Hierarchy Traversal</strong>: Automatically expands relationships through parent-child links.
- <strong>List Resolution</strong>: Resolves <code>StaticDynamicList</code> fields to concrete entity IDs.
- <strong>Change Tracking</strong>: Informs the framework which entities need re-materialization when a hierarchy node or list changes.</p>
</div>
<div class="sect4">
<h5 id="_example_territory_location_materialization">Example: Territory → Location Materialization</h5>
<div class="paragraph">
<p>Consider a scenario where:
1. <strong>Associates</strong> are assigned to <strong>Territories</strong>.
2. <strong>Territories</strong> form a hierarchy.
3. Each <strong>Territory</strong> has a list of <strong>Locations</strong>.
4. We want to materialize <code>Associate --canAccessLocation-&#8594; Location</code> edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">TerritoryLocationEdgeProvider</span>
        <span class="directive">extends</span> HierarchyListEdgeProvider&lt;Territory, Territory, Location&gt; {

    <span class="annotation">@Inject</span> TerritoryRepo territoryRepo;
    <span class="annotation">@Inject</span> LocationListResolver listResolver;

    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;Territory&gt; getSourceType() { <span class="keyword">return</span> Territory.class; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> getPredicate() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hasLocation</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> getTargetTypeName() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getAssignedNodeIds(Territory source) {
        <span class="keyword">return</span> <span class="predefined-type">List</span>.of(source.getId().toString());
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Territory&gt; getChildNodes(ComputationContext context, <span class="predefined-type">String</span> nodeId) {
        <span class="keyword">return</span> territoryRepo.getAllChildren(context.dataDomainInfo(), nodeId);
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Location&gt; resolveListItems(ComputationContext context, Territory node) {
        <span class="keyword">return</span> listResolver.resolve(context.dataDomainInfo(), node.getStaticDynamicList());
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> extractTargetId(Location target) {
        <span class="keyword">return</span> target.getRefName();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Combined with a Property Chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">chains</span>:
  - <span class="string"><span class="content">chain: [hasTerritory, hasLocation]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">canAccessLocation</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup ensures that when an Associate is linked to a Territory, they automatically get <code>canAccessLocation</code> edges to all locations in that territory and its descendants.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="property-chains-vs-computed-providers">42.6.3. When to use Property Chains vs ComputedEdgeProvider</h4>
<div class="paragraph">
<p>Understanding when to use property chains versus <code>ComputedEdgeProvider</code> is critical for modeling your ontology effectively. This section provides clear guidance on which approach to use.</p>
</div>
<div class="sect4">
<h5 id="_property_chains_use_for_sequential_multi_hop_traversals">Property Chains: Use for Sequential Multi-Hop Traversals</h5>
<div class="paragraph">
<p>Property chains are ideal when your derived relationship follows a <strong>fixed sequence of predicates</strong> where each step is a simple, direct relationship.</p>
</div>
<div class="paragraph">
<p><strong>Property chains handle:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Multi-hop paths through direct predicates</strong>: Deriving relationships through intermediate entities</p>
<div class="ulist">
<ul>
<li>
<p>Example: <code>Order --placedBy&#8594; Customer --memberOf&#8594; Organization &#8658; Order --placedInOrg&#8594; Organization</code></p>
</li>
<li>
<p>Example: <code>Order --orderHasShipment&#8594; Shipment --shipsTo&#8594; Address &#8658; Order --orderShipsTo&#8594; Address</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Transitive closure within chains</strong>: When one step is a transitive property</p>
<div class="ulist">
<ul>
<li>
<p>Example: <code>Order --placedInOrg&#8594; Org1 --ancestorOf&#8594; Org2 &#8658; Order --placedInOrg&#8594; Org2</code></p>
</li>
<li>
<p>Propagates derived relationships up hierarchies automatically</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Chain composition</strong>: Output of one chain feeds another</p>
<div class="ulist">
<ul>
<li>
<p>Chain 1: <code>[orderHasShipment, shipsTo]</code> &#8658; <code>orderShipsTo</code></p>
</li>
<li>
<p>Chain 2: <code>[orderShipsTo, locatedIn]</code> &#8658; <code>orderShipsToRegion</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Property chain example (YAML):</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">chains</span>:
  - <span class="string"><span class="content">chain: [placedBy, memberOf]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">placedInOrg</span></span>
  - <span class="string"><span class="content">chain: [orderHasShipment, shipsTo]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">orderShipsTo</span></span>
  - <span class="string"><span class="content">chain: [orderShipsTo, locatedIn]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">orderShipsToRegion</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Property chain limitations:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Chains must be <strong>regular</strong> (non-transitive predicates in the chain itself)</p>
</li>
<li>
<p>Chains are <strong>strict sequential paths</strong> - no branching, alternation (<code>OR</code>), or conditional logic</p>
</li>
<li>
<p>No backtracking or negation</p>
</li>
<li>
<p>Cannot involve <strong>external data lookups</strong> or <strong>dynamic queries</strong> during computation</p>
</li>
<li>
<p>Cannot handle <strong>collection expansion</strong> where one entity has a list that must be resolved</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_computededgeprovider_use_for_complex_logic_beyond_sequential_paths">ComputedEdgeProvider: Use for Complex Logic Beyond Sequential Paths</h5>
<div class="paragraph">
<p>Use <code>ComputedEdgeProvider</code> when your derived edges require:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Database queries during computation</strong>: Loading related entities to determine targets</p>
</li>
<li>
<p><strong>Collection/list resolution</strong>: The target set comes from resolving a list (static or dynamic)</p>
</li>
<li>
<p><strong>Conditional logic</strong>: Different targets based on entity state or business rules</p>
</li>
<li>
<p><strong>Non-sequential traversals</strong>: Logic that doesn&#8217;t follow a simple A&#8594;B&#8594;C pattern</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>When to use ComputedEdgeProvider:</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Scenario</th>
<th class="tableblock halign-left valign-top">Why Property Chains Won&#8217;t Work</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associate → canSeeLocation → Location (via Territory hierarchy + LocationList)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires loading the Territory, expanding to children, then resolving each Territory&#8217;s LocationList - involves list resolution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User → canAccessCustomer → Customer (via assigned Regions and dynamic filters)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires executing dynamic queries based on filter strings stored in Region entities</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manager → canViewReport → Report (where Reports are determined by Department + Role combinations)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires conditional logic based on both hierarchy position AND role assignments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity → derivedTarget → Target (where targets depend on runtime configuration)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires external lookups that chains cannot perform</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_hierarchylistedgeprovider_specialized_for_hierarchy_list_pattern">HierarchyListEdgeProvider: Specialized for Hierarchy + List Pattern</h5>
<div class="paragraph">
<p><code>HierarchyListEdgeProvider&lt;S, H, T&gt;</code> is a specialized base class for the common pattern:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get assigned hierarchy nodes from source entity (e.g., Associate&#8217;s Territories)</p>
</li>
<li>
<p>Expand to include all child nodes (hierarchy traversal)</p>
</li>
<li>
<p>Resolve each node&#8217;s list (static or dynamic)</p>
</li>
<li>
<p>Create edges to the resolved items</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Use HierarchyListEdgeProvider when:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your source entity is assigned to hierarchy nodes (Territories, Departments, Regions)</p>
</li>
<li>
<p>Each hierarchy node has an associated list of target entities</p>
</li>
<li>
<p>The relationship should include targets from the assigned node AND all descendants</p>
</li>
<li>
<p>You need provenance tracking of which nodes and lists contributed to each edge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example use cases:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Associate → canSeeLocation → Location</code> via Territory hierarchy</p>
</li>
<li>
<p><code>SalesRep → canAccessAccount → Account</code> via Region hierarchy</p>
</li>
<li>
<p><code>Employee → canViewDocument → Document</code> via Department hierarchy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example implementation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AssociateCanSeeLocationProvider</span>
        <span class="directive">extends</span> HierarchyListEdgeProvider&lt;Associate, Territory, Location&gt; {

    <span class="annotation">@Inject</span> TerritoryRepo territoryRepo;
    <span class="annotation">@Inject</span> LocationListResolver listResolver;

    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">Class</span>&lt;Associate&gt; getSourceType() { <span class="keyword">return</span> Associate.class; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getPredicate() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">canSeeLocation</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getTargetTypeName() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getHierarchyTypeName() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Territory</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getAssignedNodeIds(Associate source) {
        <span class="keyword">return</span> source.getAssignedTerritories().stream()
            .map(ref -&gt; ref.getId().toString())
            .toList();
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Optional&lt;Territory&gt; loadHierarchyNode(ComputationContext ctx, <span class="predefined-type">String</span> nodeId) {
        <span class="keyword">return</span> territoryRepo.findById(<span class="keyword">new</span> ObjectId(nodeId));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Territory&gt; getChildNodes(ComputationContext ctx, <span class="predefined-type">String</span> nodeId) {
        <span class="keyword">return</span> territoryRepo.getAllChildren(<span class="keyword">new</span> ObjectId(nodeId));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Location&gt; resolveListItems(ComputationContext ctx, Territory node) {
        <span class="keyword">return</span> listResolver.resolve(ctx.getDataDomainInfo(), node.getStaticDynamicList());
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> extractTargetId(Location target) {
        <span class="keyword">return</span> target.getId().toString();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_decision_guide">Decision Guide</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 50%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Approach</th>
<th class="tableblock halign-left valign-top">When to Use</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Property Chain (YAML)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequential multi-hop through direct predicates; no external data lookups needed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order --placedBy&#8594; Customer --memberOf&#8594; Org</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Property Chain with Transitive</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hierarchy rollup where relationships are direct predicates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Order --placedInOrg&#8594; Org --ancestorOf&#8594; ParentOrg</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ComputedEdgeProvider</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex logic, conditional branching, or external data lookups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission edges based on roles + entity state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>HierarchyListEdgeProvider</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source assigned to hierarchy nodes, each with associated target lists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Associate → canSeeLocation → Location</code> via Territory + LocationList</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_important_notes">Important Notes</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Source types must be @OntologyClass annotated</strong>: ComputedEdgeProvider implementations will show a warning at startup if their source type lacks <code>@OntologyClass</code>. The edges will not be processed during entity persistence.</p>
</li>
<li>
<p><strong>Providers are automatically discovered</strong>: Any <code>@ApplicationScoped</code> class extending <code>ComputedEdgeProvider</code> is automatically discovered and registered at startup.</p>
</li>
<li>
<p><strong>Provenance is tracked</strong>: <code>ComputedEdgeProvider</code> and <code>HierarchyListEdgeProvider</code> automatically track which inputs contributed to each computed edge, enabling smart incremental updates.</p>
</li>
<li>
<p><strong>Combine approaches when needed</strong>: You can use property chains for some relationships and computed providers for others in the same application.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extending_materialization_with_computededgeprovider_advanced">42.6.4. Extending materialization with ComputedEdgeProvider (Advanced)</h4>
<div class="paragraph">
<p>While <code>OntologyEdgeProvider</code> is sufficient for simple, direct edges, many real-world use cases require edges computed from complex logic, such as hierarchy traversal or dynamic list resolution. <code>ComputedEdgeProvider</code> is a more robust base class that provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Provenance tracking</strong>: Records why an edge exists (which hierarchy nodes and lists were involved).</p>
</li>
<li>
<p><strong>Incremental updates</strong>: Tracks dependencies to know exactly which edges to recompute when a source changes.</p>
</li>
<li>
<p><strong>Specialized hierarchy support</strong>: <code>HierarchyListEdgeProvider</code> simplifies implementing common patterns like "User can see Locations in their assigned Territories (and descendants)".</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_example_hierarchy_based_edge_provider">Example: Hierarchy-based Edge Provider</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AssociateCanSeeLocationProvider</span>
        <span class="directive">extends</span> HierarchyListEdgeProvider&lt;Associate, Territory, Location&gt; {

    <span class="annotation">@Inject</span> TerritoryRepo territoryRepo;
    <span class="annotation">@Inject</span> LocationListResolver listResolver;

    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">Class</span>&lt;Associate&gt; getSourceType() { <span class="keyword">return</span> Associate.class; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getPredicate() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">canSeeLocation</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getTargetTypeName() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>; }
    <span class="annotation">@Override</span> <span class="directive">protected</span> <span class="predefined-type">String</span> getHierarchyTypeName() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Territory</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getAssignedNodeIds(Associate source) {
        <span class="keyword">return</span> source.getAssignedTerritories().stream()
            .map(ref -&gt; ref.getId().toString())
            .toList();
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Optional&lt;Territory&gt; loadHierarchyNode(ComputationContext ctx, <span class="predefined-type">String</span> nodeId) {
        <span class="keyword">return</span> territoryRepo.findById(<span class="keyword">new</span> ObjectId(nodeId));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Territory&gt; getChildNodes(ComputationContext ctx, <span class="predefined-type">String</span> nodeId) {
        <span class="keyword">return</span> territoryRepo.getAllChildren(<span class="keyword">new</span> ObjectId(nodeId));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">List</span>&lt;Location&gt; resolveListItems(ComputationContext ctx, Territory node) {
        <span class="keyword">return</span> listResolver.resolve(ctx.getDataDomainInfo(), node.getStaticDynamicList());
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> extractTargetId(Location target) {
        <span class="keyword">return</span> target.getId().toString();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_multi_hop_and_provenance">Multi-hop and Provenance</h5>
<div class="paragraph">
<p><code>ComputedEdgeProvider</code> supports multi-hop capabilities by allowing providers to contribute to the overall ontology graph that is materialized. The provenance information captured by these providers includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Hierarchy Contributions</strong>: Every node traversed in a hierarchy path.</p>
</li>
<li>
<p><strong>List Contributions</strong>: Every list (static or dynamic) resolved to find target entities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This provenance is stored with the edge and allows the framework to perform smart, incremental recomputations when underlying data (like a Territory&#8217;s child nodes or a LocationList&#8217;s filter) changes.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extending_materialization_with_ontologyedgeprovider_spi">42.6.5. Extending materialization with OntologyEdgeProvider (SPI)</h4>
<div class="paragraph">
<p>The write hook is annotation-first and SPI-second:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, it extracts explicit edges from @OntologyProperty fields/getters on the entity being saved.</p>
</li>
<li>
<p>Then, it discovers any CDI beans implementing com.e2eq.ontology.spi.OntologyEdgeProvider that support the entity type and merges their edges.</p>
</li>
<li>
<p>Finally, it persists explicit edges, prunes stale ones, and rematerializes inferred edges (inverse, subPropertyOf, transitive, symmetric).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This keeps OntologyWriteHook thin and generic while allowing domain modules to contribute additional explicit edges without changing the core.</p>
</div>
<div class="paragraph">
<p>Basic contract</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementations must declare:</p>
</li>
<li>
<p>boolean supports(Class&lt;?&gt; entityType) — return true for the entity types you handle.</p>
</li>
<li>
<p>List&lt;Reasoner.Edge&gt; edges(String realmId, Object entity) — return explicit edges to add for that instance.</p>
</li>
<li>
<p>Register the implementation as a CDI bean (e.g., @ApplicationScoped) in your module; Quarkus will discover it.</p>
</li>
<li>
<p>Edges you return should use your domain refName (or id) for src/dst ids and the ontology type ids for srcType/dstType.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example provider</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@jakarta</span>.enterprise.context.ApplicationScoped
<span class="directive">public</span> <span class="type">class</span> <span class="class">UserCredentialEdgeProvider</span> <span class="directive">implements</span> com.e2eq.ontology.spi.OntologyEdgeProvider {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">boolean</span> supports(<span class="predefined-type">Class</span>&lt;?&gt; entityType) {
    <span class="keyword">return</span> com.e2eq.framework.model.security.User.class.isAssignableFrom(entityType);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> java.util.List&lt;com.e2eq.ontology.core.Reasoner.Edge&gt; edges(<span class="predefined-type">String</span> realmId, <span class="predefined-type">Object</span> entity) {
    <span class="type">var</span> user = (com.e2eq.framework.model.security.User) entity;
    <span class="predefined-type">String</span> srcId = user.getRefName();
    <span class="keyword">if</span> (srcId == <span class="predefined-constant">null</span> || srcId.isBlank()) <span class="keyword">return</span> java.util.List.of();
    <span class="predefined-type">String</span> credRef = user.getCredentialRefName();
    <span class="keyword">if</span> (credRef == <span class="predefined-constant">null</span> || credRef.isBlank()) <span class="keyword">return</span> java.util.List.of();
    <span class="keyword">return</span> java.util.List.of(
      <span class="keyword">new</span> com.e2eq.ontology.core.Reasoner.Edge(
        srcId, <span class="string"><span class="delimiter">&quot;</span><span class="content">User</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">userHasCredential</span><span class="delimiter">&quot;</span></span>, credRef, <span class="string"><span class="delimiter">&quot;</span><span class="content">CredentialUserIdPassword</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>, java.util.Optional.empty()
      )
    );
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Merging behavior and lifecycle</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The hook calls all matching providers and concatenates their edges with the annotation-derived ones.</p>
</li>
<li>
<p>It computes the diff against prior explicit edges for the same source and prunes any stale explicit edges per predicate.</p>
</li>
<li>
<p>Then it invokes the reasoner/materializer to compute and upsert inferred edges.</p>
</li>
<li>
<p>Finally, it executes cascade policies (e.g., ORPHAN_REMOVE/DELETE) declared on @OntologyProperty, using the prior vs. new explicit state.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ID and type resolution tips</p>
</div>
<div class="ulist">
<ul>
<li>
<p>srcId: By default, the hook resolves an entity id using getRefName(), getId(), or toString() fallback. Prefer setting refName on your entities.</p>
</li>
<li>
<p>dstId: You may point to another entity by refName string (no fetch required) if your domain guarantees uniqueness per type and tenant.</p>
</li>
<li>
<p>srcType/dstType: Use the @OntologyClass(id=&#8230;&#8203;) values for the types (e.g., "User", "CredentialUserIdPassword").</p>
</li>
<li>
<p>realmId: The framework passes the current tenant/realm id; include it when persisting or resolving external references if needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Testing your provider</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can write a Quarkus test that persists a source and any targets, calls OntologyWriteHook.afterPersist(tenant, entity), and asserts that:</p>
</li>
<li>
<p>the annotation-derived edges exist, and</p>
</li>
<li>
<p>your provider-derived edges are also present and marked as explicit (inferred=false).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Migration guidance</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start annotation-first. Only add a provider when edges depend on computed fields, cross-aggregate ids, or non-entity sources.</p>
</li>
<li>
<p>Keep providers small and focused per entity type. Avoid duplicating edges that annotations already cover.</p>
</li>
<li>
<p>If multiple providers contribute the same edge, the repo upsert is idempotent.</p>
</li>
<li>
<p>Intermediates and re-materialization:</p>
</li>
<li>
<p>If you change entities that are not the source but affect chains (e.g., Address.region, Customer.memberOf), those sources will get updated the next time they are saved. For immediate consistency across a tenant, run the re-materialization job (see below).</p>
</li>
<li>
<p>Provide nightly/backfill jobs for recomputing edges across a tenant when ontology rules evolve.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_3">42.6.6. Configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># default is true
ontology.auto-materialize=true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_annotate_and_save_edges_are_materialized_automatically">42.6.7. Example: annotate and save — edges are materialized automatically</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> {
  <span class="directive">private</span> <span class="predefined-type">String</span> refName;

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> Customer getCustomer() { <span class="keyword">return</span> customer; }
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {
  <span class="directive">private</span> <span class="predefined-type">String</span> refName;

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">public</span> Organization getOrg() { <span class="keyword">return</span> org; }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Saving an Order will automatically create explicit placedBy and, via chains/inference, placedInOrg and inverse edges as defined in your ontology registry. No manual calls to OntologyMaterializer.apply(&#8230;&#8203;) are required.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_security_and_multi_tenant_considerations_2">42.7. Security and multi-tenant considerations</h3>
<div class="ulist">
<ul>
<li>
<p>Edge rows include tenantId and should be validated/filtered by tenant on every operation.</p>
</li>
<li>
<p>Never trust a client-supplied predicate or destination id blindly; combine with rule evaluation and whitelist allowed predicates per domain if needed.</p>
</li>
<li>
<p>For shared resources across tenants (rare), model cross-tenant permissions at the policy layer; don’t reuse edges across tenants unless explicitly designed.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_developer_workflow_and_dx_checklist_2">42.8. Developer workflow and DX checklist</h3>
<div class="ulist">
<ul>
<li>
<p>When writing a rule: use hasEdge("&lt;predicate&gt;", &lt;rhs&gt;) and rely on RuleContext variables for the destination when possible.</p>
</li>
<li>
<p>When writing a list endpoint: read optional ontology filter hints from the policy layer; if present, apply ensureHasEdge(&#8230;&#8203;) before find().</p>
</li>
<li>
<p>When changing domain relationships: update predicates/chains and re-materialize; list/policy code stays unchanged.</p>
</li>
<li>
<p>When indexing a new tenant: include the edges indexes early and validate via a smoke test query using ListQueryRewriter.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cookbook_end_to_end_example_with_orders_org_2">42.9. Cookbook: end-to-end example with Orders + Org</h3>
<div class="ulist">
<ul>
<li>
<p>Policy: allow LIST Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Request lifecycle:
1) Security filter builds SecurityContext and RuleContext with tenantId and principal.
2) Policy evaluation returns a directive to constrain by hasEdge("placedInOrg", orgRefName).
3) Repo builds base filter (state != ARCHIVED, etc.).
4) Repo calls OntologyFilterHelper.ensureHasEdge(base, tenantId, "placedInOrg", orgRefName).
5) Mongo executes a single-hop query using materialized edges; results respect both policy and multi-tenancy.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_notes_for_teams_using_reference_2">42.10. Migration notes for teams using @Reference</h3>
<div class="ulist">
<ul>
<li>
<p>Keep existing references for write-side integrity and local joins where simple.</p>
</li>
<li>
<p>Introduce ontology edges on hot read paths first; update policy rules to hasEdge and verify results.</p>
</li>
<li>
<p>Gradually replace deep $lookup traversals with hasEdge-based rewrites.</p>
</li>
<li>
<p>Ensure materialization hooks are deployed before removing data fields used as inputs to the ontology.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_primer_first_time_guide_to_core_relationship_semantics">43. Primer: First-time guide to core relationship semantics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are new to ontology terms, the following quick explanations will help you build intuition. Each concept explains what it means, a tiny example, and how it affects queries using hasEdge.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional property</p>
</li>
<li>
<p>What it means: For a given source entity, there is at most one target for this property. Think “single-valued.”</p>
</li>
<li>
<p>Example: placedBy(Order, Customer) is functional because an Order is placed by exactly one Customer.</p>
</li>
<li>
<p>Why it matters: On writes, the latest value replaces any previous one. In storage, you can enforce uniqueness for (tenantId, src, p). Queries are simpler because there’s at most one matching edge per source.</p>
</li>
<li>
<p>In practice: When you save an Order with a different placedBy, the old edge is replaced so hasEdge("placedBy", customerX) reflects the latest truth.</p>
</li>
<li>
<p>Transitive property</p>
</li>
<li>
<p>What it means: The relationship “chains through” intermediates. If A relates-to B and B relates-to C with the same property p, then A relates-to C by p as well.</p>
</li>
<li>
<p>Example: ancestorOf(Org, Org) is transitive: OrgA ancestorOf OrgB and OrgB ancestorOf OrgC implies OrgA ancestorOf OrgC.</p>
</li>
<li>
<p>Why it matters: You can answer reachability questions without specifying every hop. The system can materialize or compute the closure so queries like hasEdge("ancestorOf", OrgC) return OrgA even if the path is multiple hops.</p>
</li>
<li>
<p>In practice: Use transitive for hierarchies like parent/ancestor, partOf, locatedIn, reportsTo.</p>
</li>
<li>
<p>subPropertyOf (property hierarchy)</p>
</li>
<li>
<p>What it means: One property is a more specific form of another. If p ⊑ q (“p is a sub-property of q”), then every (s, p, o) also counts as (s, q, o).</p>
</li>
<li>
<p>Example: placedInOrg ⊑ inOrg. If an Order is placedInOrg ACME, then it is also inOrg ACME.</p>
</li>
<li>
<p>Why it matters: Queries written against the broader property (q) automatically include results from all its specializations (p). The system may materialize the super-property edges for performance.</p>
</li>
<li>
<p>In practice: You can write policies/queries once for inOrg and still match edges stored as placedInOrg.</p>
</li>
<li>
<p>inverseOf (inverse properties)</p>
</li>
<li>
<p>What it means: Two properties point in opposite directions. If p is the inverse of q, then (s, p, o) implies (o, q, s).</p>
</li>
<li>
<p>Example: parentOf ⇄ childOf. If OrgA parentOf OrgB, then OrgB childOf OrgA.</p>
</li>
<li>
<p>Why it matters: You only need to assert one direction; the system can infer the other. Queries can use whichever direction is natural.</p>
</li>
<li>
<p>In practice: If you stored parentOf, you can still query with hasEdge("childOf", OrgA) and find OrgB once inverses are materialized.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Putting it together
- These traits combine. For example, placedInOrg can be declared a subPropertyOf inOrg; ancestorOf can be transitive; parentOf and childOf can be inverses. The reasoner uses these facts to materialize convenient edges so your queries remain simple and fast.
- Your application code typically continues to use the same three query helpers: hasEdge, hasEdgeAny, notHasEdge. The richer semantics affect which edges exist, not how you call them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_ontology_features_in_this_release">44. New ontology features in this release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This release expands the ontology engine and query integration to support a richer, OWL‑RL–inspired subset while keeping the developer experience simple and backward compatible. The following capabilities are now available and used transparently by the materializer and query rewriter:</p>
</div>
<div class="sect2">
<h3 id="_feature_overview">44.1. Feature overview</h3>
<div class="ulist">
<ul>
<li>
<p>subClassOf (class hierarchy)</p>
</li>
<li>
<p>Model taxonomies (e.g., Order ⊑ Entity, Employee ⊑ Person). Used for validation and optional type filters.</p>
</li>
<li>
<p>subPropertyOf (property hierarchy)</p>
</li>
<li>
<p>If p ⊑ q and you assert (s, p, o), the system materializes (s, q, o). Queries on q will match p’s edges as well.</p>
</li>
<li>
<p>inverse properties</p>
</li>
<li>
<p>If p is the inverse of q, asserting (s, p, o) will materialize (o, q, s). Example: parentOf ⇄ childOf.</p>
</li>
<li>
<p>symmetric properties</p>
</li>
<li>
<p>For symmetric p, asserting (s, p, o) materializes (o, p, s). Example: peerOf between organizations.</p>
</li>
<li>
<p>transitive properties</p>
</li>
<li>
<p>For transitive p, if (s, p, m) and (m, p, o) then (s, p, o) is inferred. Typical for ancestorOf, partOf, locatedIn, memberOf within hierarchical contexts.</p>
</li>
<li>
<p>functional properties</p>
</li>
<li>
<p>For functional p, each source s has at most one destination o. Upserts replace the prior value. Useful for single-valued relations like placedBy on Order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All inferred edges carry inferred=true and provenance containing the rule used (e.g., transitive, inverse, subPropertyOf). These edges live in the same collection and are fully queryable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_business_problems_solved">44.2. Business problems solved</h3>
<div class="ulist">
<ul>
<li>
<p>E‑commerce organizational access</p>
</li>
<li>
<p>Problem: “Show me all orders placed in ACME (including subsidiaries).”</p>
</li>
<li>
<p>Solution: Define placedBy, memberOf, placedInOrg with chain placedBy ∘ memberOf ⇒ placedInOrg, and make ancestorOf transitive. Either materialize closure with a chain placedInOrg ∘ ancestorOf ⇒ placedInOrg or use p being transitive. Queries use hasEdge("placedInOrg", orgId).</p>
</li>
<li>
<p>HR management</p>
</li>
<li>
<p>Problem: “List employees who report to VP_X directly or indirectly.”</p>
</li>
<li>
<p>Solution: Define reportsTo as transitive. Query hasEdge("reportsTo", "VP_X").</p>
</li>
<li>
<p>Third‑party and data lineage</p>
</li>
<li>
<p>Problem: “Which datasets are derived from Source S?”</p>
</li>
<li>
<p>Solution: Define derivedFrom as transitive and inverse derivedInto. Record symmetric peerOf for bidirectional partnerships where relevant.</p>
</li>
<li>
<p>Supplier networks (supply chain)</p>
</li>
<li>
<p>Problem: “Find parts supplied by a vendor’s parent company’s peers.”</p>
</li>
<li>
<p>Solution: Use subPropertyOf to roll up specialized edges into a common supplies predicate, define parentOf/childOf inverses, and peerOf symmetric at the org level.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_code_it_with_current_apis">44.3. How to code it with current APIs</h3>
<div class="paragraph">
<p>Below are concise examples showing how to define the ontology, materialize inferences, and query with existing components. These mirror the types already present in this repository and require no grammar changes.</p>
</div>
<div class="sect3">
<h4 id="_1_define_ontology_programmatic_tbox">44.3.1. 1) Define ontology (programmatic TBox)</h4>
<div class="paragraph">
<p>A small TBox-level view of the classes and predicates we define:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-graphviz-md5-c0c55938d0e17cdd80c2046a3d2eddd4.svg" alt="Diagram" width="533" height="242">
</div>
</div>
<div class="paragraph">
<p>Java (at startup, e.g., in a CDI producer):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Produces</span> <span class="annotation">@Singleton</span>
<span class="directive">public</span> OntologyRegistry ontologyRegistry() {
  <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, OntologyRegistry.ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,       <span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>,    <span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>,<span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
  );

  <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, OntologyRegistry.PropertyDef&gt; props = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
  <span class="comment">// Single-valued ⇒ functional</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">false</span>, <span class="comment">/*symmetric*/</span> <span class="predefined-constant">true</span> <span class="comment">/*functional*/</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>,<span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>) <span class="comment">// subPropertyOf example</span>
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>,      <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  <span class="comment">// Transitive ancestor relation</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">true</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  <span class="comment">// Inverses and symmetric</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>,    <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">true</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>,     <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">true</span>, <span class="comment">/*symmetric*/</span> <span class="predefined-constant">false</span>, <span class="comment">/*functional*/</span> <span class="predefined-type">Set</span>.of()
  ));

  <span class="predefined-type">List</span>&lt;OntologyRegistry.PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
      <span class="comment">// Order --placedBy--&gt; Customer --memberOf--&gt; Org  ⇒ Order --placedInOrg--&gt; Org</span>
      <span class="keyword">new</span> OntologyRegistry.PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
      <span class="comment">// Include ancestor closure for placedInOrg results</span>
      <span class="keyword">new</span> OntologyRegistry.PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
  );

  <span class="keyword">return</span> OntologyRegistry.inMemory(<span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- subPropertyOf is modeled via the PropertyDef.subPropertyOf set.
- Inverse and symmetric are encoded in PropertyDef.inverseOf and PropertyDef.symmetric.
- Transitivity is toggled via PropertyDef.transitive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_materialize_inferences_when_data_changes">44.3.2. 2) Materialize inferences when data changes</h4>
<div class="paragraph">
<p>Use OntologyMaterializer or call the Reasoner directly and upsert edges via OntologyEdgeRepo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ForwardChainingReasoner reasoner;
<span class="annotation">@Inject</span> OntologyRegistry ontologyRegistry;
<span class="annotation">@Inject</span> OntologyEdgeRepo edgeRepo;

<span class="directive">public</span> <span class="type">void</span> onOrderSaved(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orderId, <span class="predefined-type">String</span> customerId, <span class="predefined-type">String</span> orgId) {
  <span class="predefined-type">List</span>&lt;Reasoner.Edge&gt; explicit = <span class="predefined-type">List</span>.of(
      <span class="keyword">new</span> Reasoner.Edge(orderId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, customerId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>, Optional.empty()),
      <span class="keyword">new</span> Reasoner.Edge(customerId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, orgId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>, Optional.empty())
  );
  Reasoner.EntitySnapshot snap = <span class="keyword">new</span> Reasoner.EntitySnapshot(tenant, orderId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, explicit);
  Reasoner.InferenceResult out = reasoner.infer(snap, ontologyRegistry);
  <span class="keyword">for</span> (Reasoner.Edge e : out.addEdges()) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Object</span>&gt; prov = e.prov().map(p -&gt; <span class="predefined-type">Map</span>.&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Object</span>&gt;of(<span class="string"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>, p.rule(), <span class="string"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>, p.inputs())).orElse(<span class="predefined-type">Map</span>.of());
    edgeRepo.upsert(tenant, e.srcType(), e.srcId(), e.p(), e.dstType(), e.dstId(), <span class="predefined-constant">true</span>, prov);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The materializer computes and persists:
- subPropertyOf roll‑ups (e.g., placedInOrg ⊑ inOrg ⇒ write inOrg)
- inverse/symmetric counterparts
- transitive closures (bounded to the snapshot inputs; you can also chain for closures)</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_query_with_listqueryrewriter_quarkusmorphia">44.3.3. 3) Query with ListQueryRewriter (Quarkus/Morphia)</h4>
<div class="paragraph">
<p>Use hasEdge/hasEdgeAny/notHasEdge to turn ontology constraints into Morphia filters over your entity collection. The rewriter internally fetches the set of source ids from the edge store and builds an in("refName", …) filter that composes with your attribute predicates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ListQueryRewriter queryRewriter;
<span class="annotation">@Inject</span> MorphiaDatastore datastore;

<span class="directive">public</span> <span class="predefined-type">List</span>&lt;TestOrder&gt; openOrdersIn(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orgId) {
  <span class="type">var</span> status = dev.morphia.query.filters.Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
  <span class="type">var</span> inOrg = queryRewriter.hasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgId);
  <span class="type">var</span> combined = dev.morphia.query.filters.Filters.and(status, inOrg);
  <span class="keyword">return</span> datastore.find(TestOrder.class).filter(combined).iterator().toList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To include multiple orgs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> f = queryRewriter.hasEdgeAny(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-ACME</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-GLOBEX</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To exclude restricted orgs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> f = queryRewriter.notHasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-RESTRICTED</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functional_properties_at_write_time">44.3.4. Functional properties at write time</h4>
<div class="paragraph">
<p>For single‑valued relationships declared functional, configure a unique index over (tenantId, src, p) in your edge store (or rely on repo semantics) and treat upserts as replacements.</p>
</div>
<div class="paragraph">
<p>Practical guidance:
- Mark naturally single‑valued links functional (placedBy, primaryOwner).
- On write, remove or overwrite any prior dst for the same (tenant, src, p).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_backward_compatibility_and_migration">44.4. Backward compatibility and migration</h3>
<div class="ulist">
<ul>
<li>
<p>Grammar/API: No changes needed. The same hasEdge/hasEdgeAny/notHasEdge functions work; results simply become more expressive as ontology features are enabled.</p>
</li>
<li>
<p>Feature flags: You may enable features per property (e.g., transitive) gradually. Queries remain stable.</p>
</li>
<li>
<p>Provenance: Keep prov so you can re‑compute or retract inferred edges when inputs or rules change.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_and_tips">44.5. Troubleshooting and tips</h3>
<div class="ulist">
<ul>
<li>
<p>Empty result from hasEdge: Means no matching edges exist; check whether inferences are being materialized for the predicate you expect.</p>
</li>
<li>
<p>Tenant scoping: All repo calls include tenantId; ensure you pass the correct tenant in both write and read paths.</p>
</li>
<li>
<p>Indexes: For heavy reads, ensure compound indexes on (tenantId, p, dst) and (tenantId, src, p). For functional, consider a unique (tenantId, src, p).</p>
</li>
<li>
<p>Testing: Use Quarkus @QuarkusTest to wire CDI and a test OntologyRegistry producer. Populate explicit edges, run the reasoner, then assert with the repo and query rewriter as shown in the integration tests included with the repository.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_model_first_ontology_with_annotations_and_morphiaontologyloader">45. Model-first ontology with annotations and MorphiaOntologyLoader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows how to use your Morphia model classes as the source of truth for the ontology. You annotate model classes/fields to declare ontology concepts and property traits; at startup, MorphiaOntologyLoader scans MorphiaDatastore.getMapper() to build the OntologyRegistry automatically.</p>
</div>
<div class="sect2">
<h3 id="_why_model_first">45.1. Why model-first?</h3>
<div class="ulist">
<ul>
<li>
<p>Single source of truth: semantics live next to the data model; less drift between code and config.</p>
</li>
<li>
<p>Safer refactors: renames/types evolve in code and the ontology follows.</p>
</li>
<li>
<p>No separate YAML/JSON needed for most use cases; optional overrides remain possible later if needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_annotations_overview">45.2. Annotations overview</h3>
<div class="paragraph">
<p>Two lightweight annotations are used on model classes and fields. They are provided by quantum-ontology-core and can be added to any Morphia-mapped entity (deriving from UnversionedBaseModel).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@OntologyClass</p>
</li>
<li>
<p>id: optional explicit class id (defaults to the simple class name)</p>
</li>
<li>
<p>subClassOf: optional extra parents (in addition to Java inheritance)</p>
</li>
<li>
<p>@OntologyProperty</p>
</li>
<li>
<p>id: optional explicit property id (defaults to the field name)</p>
</li>
<li>
<p>subPropertyOf: property hierarchy roll-up targets</p>
</li>
<li>
<p>inverseOf: name of the inverse property (declare on one side)</p>
</li>
<li>
<p>transitive: whether the property is transitive</p>
</li>
<li>
<p>symmetric: whether the property is symmetric</p>
</li>
<li>
<p>functional: at most one target per source (defaults to true for single-valued fields)</p>
</li>
<li>
<p>domain: override inferred domain (defaults to declaring @OntologyClass)</p>
</li>
<li>
<p>range: override inferred range (defaults to the field/element type)</p>
</li>
<li>
<p>ref: target ontology class id when this field represents a relationship to another ontology type</p>
</li>
<li>
<p>relation: the multiplicity/cardinality for the relationship (NONE, ONE_TO_ONE, ONE_TO_MANY, MANY_TO_ONE, MANY_TO_MANY)</p>
</li>
<li>
<p>edgeType: the edge label used in the ontology graph; if omitted, falls back to id or field name</p>
</li>
<li>
<p>inverseOfEdge: optional inverse edge label if you prefer naming inverses at the edge level</p>
</li>
<li>
<p>materializeEdge: when false, keeps the reference value but skips edge creation (defaults to true)</p>
</li>
<li>
<p>cascade: optional cascade policies (NONE by default). Supports ORPHAN_REMOVE, DELETE, and BLOCK_IF_REFERENCED; see below.</p>
</li>
<li>
<p>cascadeDepth: limit for recursive cascades (default 1); used by DELETE cascades to bound depth and prevent long chains</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
functional is inferred true for single-valued fields and false for collections/maps unless you override it.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ontology-relationships">45.2.1. Relationship semantics on @OntologyProperty</h4>
<div class="paragraph">
<p>When a field is annotated with @OntologyProperty and declares any of ref, relation, or edgeType, the framework treats it as a relationship and will materialize an ontology edge for it on persist/update.</p>
</div>
<div class="paragraph">
<p>Key attributes:
- ref: Names the target ontology class id. If omitted, the loader attempts to infer it from the Java type of the field or its generic element type.
- relation: Declares multiplicity. If not set, it is inferred from the field type: collections imply plural (ONE_TO_MANY), scalars imply singular (MANY_TO_ONE) by convention.
- edgeType: Controls the predicate id used to write/read edges. If absent, the property id (or field name) is used.
- materializeEdge: Set to false to store the reference value without creating graph edges; traversal and inferences will ignore this property.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Many orders reference one Customer (MANY_TO_ONE); name the edge explicitly</span>
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.MANY_TO_ONE,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOMER_OF</span><span class="delimiter">&quot;</span></span>
  )
  <span class="directive">private</span> <span class="predefined-type">String</span> customerId; <span class="comment">// or Customer if you store the object</span>
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">SCorp</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">scorps</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SCorp</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// One SCorp authorizes many Resolutions</span>
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">resolutionIds</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Resolution</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">AUTHORIZES_RESOLUTION</span><span class="delimiter">&quot;</span></span>
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; resolutionIds;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Runtime materialization (conceptual):
- (Order) -[CUSTOMER_OF]&#8594; (Customer)
- (SCorp) -[AUTHORIZES_RESOLUTION]&#8594; (Resolution)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If ref is provided but edgeType is omitted, the system uses the property id (or field name). Consider using descriptive edge names for durability of queries.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ontology-cascading">45.2.2. Cascading policies for relationships</h4>
<div class="paragraph">
<p>Cascading is opt-in and conservative. It controls what happens to related targets and edges when a relationship is modified or a source is deleted.</p>
</div>
<div class="paragraph">
<p>Supported policies today:
- ORPHAN_REMOVE: On update, when an element is removed from a collection (or a singular reference is replaced), the framework deletes the removed target if and only if no other sources still reference it via the same predicate. This is useful for owned child aggregates.
- UNLINK: Edges are always pruned to reflect the current snapshot; you can think of this as implicit and always-on for edge hygiene.</p>
</div>
<div class="paragraph">
<p>Delete-time cascades (also supported):
- DELETE: When deleting the source, also delete targets up to cascadeDepth with cycle guards. Targets are deleted only for predicates that declare DELETE on the source side.
- BLOCK_IF_REFERENCED: Before deleting a target (either directly or via DELETE cascade), if the target is still referenced by another source via the same predicate, the deletion is skipped (or blocked) to preserve referential integrity.</p>
</div>
<div class="paragraph">
<p>Example (delete children when parent is deleted, with safety guards):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Parent</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Parent</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">HAS_CHILD</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Child</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    cascade = { CascadeType.DELETE, CascadeType.BLOCK_IF_REFERENCED },
    cascadeDepth = <span class="integer">1</span> <span class="comment">// delete only direct children</span>
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Child&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior:
- Deleting a Parent removes explicit edges and, with DELETE, deletes its Child documents up to the specified depth.
- With BLOCK_IF_REFERENCED, a Child that is still referenced by another Parent is not deleted; only the edge from the deleted Parent is removed.
- Cycles are guarded by a visited set; depth prevents long delete chains.</p>
</div>
<div class="paragraph">
<p>See integration tests in the ontology-mongo module (CascadeDeleteIT) for expected behavior.</p>
</div>
<div class="paragraph">
<p>Example (owned children with orphan removal):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Parent</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Parent</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">HAS_CHILD</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Child</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    cascade = { CascadeType.ORPHAN_REMOVE }
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Child&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior:
- Persisting a Parent materializes edges (P --HAS_CHILD-&#8594; C) for current children.
- Removing a Child from the collection prunes the edge. If no other Parent points to that Child via HAS_CHILD, the Child entity is deleted.
- If the Child is still referenced by another Parent, it is retained.</p>
</div>
<div class="paragraph">
<p>Verification: See integration tests under quantum-ontology-mongo it module (CascadeOrphanRemoveIT) covering both deletion and shared reference cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="ontology-benefits-relationships">45.2.3. Business benefits of ontology relationships and cascade</h4>
<div class="ulist">
<ul>
<li>
<p>Faster queries and policies: Pre-materialized edges make filtering by relationships a single indexed lookup instead of deep joins or application-side traversals.</p>
</li>
<li>
<p>Safer evolution: Edge names and ontology traits remain stable as you refactor field names/types; queries continue to work.</p>
</li>
<li>
<p>Cleaner models: Relationship intent lives in one place (@OntologyProperty) rather than being scattered across repos and services.</p>
</li>
<li>
<p>Reduced data drift: Automated edge pruning and orphan removal keep the graph consistent with your source-of-truth objects.</p>
</li>
<li>
<p>Auditability: Provenance on inferred edges documents why links exist, aiding debugging and compliance.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_orders_placed_in_an_organization_e_commerce">45.3. Example: Orders placed in an Organization (e-commerce)</h3>
<div class="paragraph">
<p>Below we implement the same business example covered earlier using model annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> status;

  <span class="comment">// Order --placedBy--&gt; Customer (single-valued ⇒ functional)</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Customer placedBy;
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">customers</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Customer --memberOf--&gt; Org (transitive across org tree)</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, transitive = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Org memberOf;
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">orgs</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Org</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Org --parentOf--&gt; Org, with inverse childOf</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">private</span> Org parent;

  <span class="comment">// Optional symmetric relationship between peers</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>, symmetric = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;Org&gt; peers;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, model a super-property to roll up specialized edges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Customer placedBy;

  <span class="comment">// Roll-up predicate for org membership of orders; placedInOrg ⊑ inOrg</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, subPropertyOf = {<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>})
  <span class="directive">private</span> Org inOrgDirect;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these annotations in place, the loader will infer:
- Classes: Order, Customer, Organization (+ hierarchy from Java inheritance)
- Properties: placedBy (functional), memberOf (transitive), parentOf ⇄ childOf (inverse), peerOf (symmetric)
- subPropertyOf: placedInOrg ⊑ inOrg (if declared)</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_the_registry_is_produced_quarkus_cdi">45.4. How the registry is produced (Quarkus CDI)</h3>
<div class="paragraph">
<p>OntologyCoreProducers wires MorphiaOntologyLoader by default. On startup it scans your models and produces a singleton OntologyRegistry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OntologyCoreProducers</span> {
  <span class="annotation">@Inject</span> MorphiaDatastore morphiaDatastore;

  <span class="annotation">@Produces</span> <span class="annotation">@Singleton</span>
  <span class="directive">public</span> OntologyRegistry ontologyRegistry() {
    <span class="keyword">try</span> {
      MorphiaOntologyLoader loader = <span class="keyword">new</span> MorphiaOntologyLoader(morphiaDatastore);
      OntologyRegistry reg = loader.load();
      <span class="keyword">return</span> isEmpty(reg) ? emptyRegistry() : reg;
    } <span class="keyword">catch</span> (<span class="predefined-type">Throwable</span> t) {
      <span class="keyword">return</span> emptyRegistry();
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need manual control (tests, migrations), you can call the loader directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MorphiaOntologyLoader loader = <span class="keyword">new</span> MorphiaOntologyLoader(datastore);
OntologyRegistry registry = loader.load();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Keep annotations minimal. Only add traits that aren’t obvious from the Java type system (e.g., transitive, symmetric, inverse, subPropertyOf).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_defining_an_ontology_with_yaml_yamlontologyloader">45.5. Defining an ontology with YAML (YamlOntologyLoader)</h3>
<div class="paragraph">
<p>You can also author your ontology in a simple YAML file and load it at runtime using YamlOntologyLoader. This is useful when:
- You want product or ops teams to evolve predicates and chains without changing Java models.
- You need to add an overlay (additional properties or chains) on top of what is discovered from annotations.</p>
</div>
<div class="paragraph">
<p>YAML structure supported by YamlOntologyLoader:
- classes: list of concept ids
- properties: list of predicate definitions with optional fields
  - id: predicate name
  - domain: optional class id for the source
  - range: optional class id for the target
  - inverseOf: optional inverse predicate id (declare on either side; loader wires both)
  - transitive: boolean
  - symmetric: boolean
  - relation: NONE | ONE_TO_ONE | ONE_TO_MANY | MANY_TO_ONE | MANY_TO_MANY (if provided, overrides functional)
  - functional: boolean (deprecated in favor of relation; still supported for backward compatibility)
  - subPropertyOf: list of super-predicate ids
- chains: list of property chains
  - chain: [p1, p2, &#8230;&#8203;]
  - implies: r</p>
</div>
<div class="paragraph">
<p>Example YAML (full file available in docs at user-guide/examples/ontology.yaml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="comment"># Example ontology.yaml used by YamlOntologyLoader</span>
<span class="key">version</span>: <span class="string"><span class="content">1</span></span>
<span class="key">classes</span>:
  - <span class="string"><span class="content">id: Order</span></span>
  - <span class="string"><span class="content">id: Customer</span></span>
  - <span class="string"><span class="content">id: Organization</span></span>
<span class="key">properties</span>:
  - <span class="string"><span class="content">id: placedBy</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Customer</span></span>
    <span class="key">inverseOf</span>: <span class="string"><span class="content">placed</span></span>
    <span class="key">functional</span>: <span class="string"><span class="content">true</span></span>
  - <span class="string"><span class="content">id: placed</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Customer</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">inverseOf</span>: <span class="string"><span class="content">placedBy</span></span>
  - <span class="string"><span class="content">id: memberOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Customer</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
  - <span class="string"><span class="content">id: placedInOrg</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">subPropertyOf</span>: <span class="string"><span class="content">[ &quot;inOrg&quot; ]</span></span>
  - <span class="string"><span class="content">id: inOrg</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
  - <span class="string"><span class="content">id: parentOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">inverseOf</span>: <span class="string"><span class="content">childOf</span></span>
  - <span class="string"><span class="content">id: childOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">inverseOf</span>: <span class="string"><span class="content">parentOf</span></span>
  - <span class="string"><span class="content">id: ancestorOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">transitive</span>: <span class="string"><span class="content">true</span></span>
  - <span class="string"><span class="content">id: peerOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">symmetric</span>: <span class="string"><span class="content">true</span></span>
<span class="key">chains</span>:
  - <span class="string"><span class="content">chain: [ &quot;placedBy&quot;, &quot;memberOf&quot; ]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>
  - <span class="string"><span class="content">chain: [ &quot;placedInOrg&quot;, &quot;ancestorOf&quot; ]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Loading YAML in code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct usage (plain Java):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.YamlOntologyLoader</span>;

YamlOntologyLoader loader = <span class="keyword">new</span> YamlOntologyLoader();

<span class="comment">// From classpath resource (place ontology.yaml under src/main/resources)</span>
OntologyRegistry.TBox tbox1 = loader.loadFromClasspath(<span class="string"><span class="delimiter">&quot;</span><span class="content">/ontology.yaml</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// From a file system path</span>
java.nio.file.Path path = java.nio.file.Path.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">config</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ontology.yaml</span><span class="delimiter">&quot;</span></span>);
OntologyRegistry.TBox tbox2 = loader.loadFromPath(path);

<span class="comment">// Build a registry (in-memory) from a TBox</span>
OntologyRegistry registry = <span class="keyword">new</span> com.e2eq.ontology.core.InMemoryOntologyRegistry(tbox2);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus auto-wiring (preferred):</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OntologyCoreProducers will try to overlay YAML on top of the Morphia-discovered TBox at startup. It looks for one of the following, in order:
- A system property ontology.yaml.path pointing to the file.
- An environment variable ONTOLOGY_YAML pointing to the file.
- A conventional file config/ontology.yaml in the working directory.
- A classpath resource /ontology.yaml.</p>
</div>
<div class="paragraph">
<p>If found, it loads the YAML TBox and merges it with the base TBox from annotations using OntologyMerger, then validates using OntologyValidator.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Keep overlays additive. If you need to override flags (e.g., mark an existing property as transitive), ensure your overlay defines the same predicate id with the desired traits; the merger will apply the union/override semantics where supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_materializing_inferences_from_annotated_models">45.6. Materializing inferences from annotated models</h3>
<div class="paragraph">
<p>Materialization is automatic on save/update through the repository hook; you do not need to assemble explicit edge lists or call OntologyMaterializer manually.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What happens:</p>
</li>
<li>
<p>The framework inspects fields/getters annotated with @OntologyProperty and extracts explicit edges.</p>
</li>
<li>
<p>The reasoner applies inverse, symmetric, transitive, and subPropertyOf traits from the registry and upserts inferred edges.</p>
</li>
<li>
<p>When to trigger re-materialization manually:</p>
</li>
<li>
<p>After ontology rule changes (e.g., you mark a property transitive or add an inverse), run your re-materialization job to recompute edges for existing entities in a tenant.</p>
</li>
<li>
<p>During bulk imports, you can disable auto-materialize and run the job afterward.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example: disable auto-materialize for a batch, then rebuild</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">ontology.auto-materialize=false</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> OntologyRebuilder rebuilder; <span class="comment">// your maintenance utility</span>

<span class="directive">public</span> <span class="type">void</span> runBackfill(<span class="predefined-type">String</span> tenantId) {
  rebuilder.recomputeTenant(tenantId);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_querying_using_listqueryrewriter_unchanged">45.7. Querying using ListQueryRewriter (unchanged)</h3>
<div class="paragraph">
<p>Your query code does not change. It benefits from materialized edges that now carry richer semantics from annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ListQueryRewriter queryRewriter;
<span class="annotation">@Inject</span> MorphiaDatastore datastore;

<span class="directive">public</span> <span class="predefined-type">List</span>&lt;Order&gt; openOrdersIn(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orgId) {
  <span class="type">var</span> status = dev.morphia.query.filters.Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
  <span class="type">var</span> inOrg = queryRewriter.hasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgId);
  <span class="type">var</span> combined = dev.morphia.query.filters.Filters.and(status, inOrg);
  <span class="keyword">return</span> datastore.find(Order.class).filter(combined).iterator().toList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To include subsidiaries via ancestor/parent relationships, either:
- Declare ancestorOf as transitive in the model and materialize a closure, or
- Add a property chain placedInOrg ∘ ancestorOf ⇒ placedInOrg in your registry initialization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_business_case_recipes_with_annotations">45.8. Business case recipes with annotations</h3>
<div class="ulist">
<ul>
<li>
<p>E‑commerce org access</p>
</li>
<li>
<p>Annotate placedBy (functional), memberOf (transitive), and optionally parentOf (inverse childOf). Materialize placedInOrg via a property chain. Query hasEdge("placedInOrg", org).</p>
</li>
<li>
<p>HR reporting lines</p>
</li>
<li>
<p>Annotate reportsTo as transitive on Employee; query hasEdge("reportsTo", managerId).</p>
</li>
<li>
<p>Supplier networks</p>
</li>
<li>
<p>Annotate supplies as a base property; use subPropertyOf to roll up specialized suppliesDirect and suppliesViaSubsidiary to supplies; annotate peerOf on Org as symmetric.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_3">45.9. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>The registry is empty at runtime</p>
</li>
<li>
<p>Ensure your models are discovered by Morphia (annotated with @Entity) and that the Quarkus application initializes MorphiaDatastore before the ontology producer.</p>
</li>
<li>
<p>Inverse not applied</p>
</li>
<li>
<p>Declare inverseOf on one side only; the loader will wire both directions.</p>
</li>
<li>
<p>Functional not enforced</p>
</li>
<li>
<p>For functional properties, ensure your edge repository enforces unique (tenantId, src, p) or that your write path overwrites prior values.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_strategy">45.10. Migration strategy</h3>
<div class="ulist">
<ul>
<li>
<p>Start by adding @OntologyProperty to the most important relationships; don’t attempt to annotate everything at once.</p>
</li>
<li>
<p>Keep existing @Reference fields if you have them; use edges for query-time semantics and policy integration first.</p>
</li>
<li>
<p>Add tests that verify the loader discovered your properties (including inverses/subPropertyOf) and that queries via hasEdge behave as expected.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_modeling_guidance_annotate_existing_idreference_getters_keep_api_and_db_clean">45.11. Modeling guidance: annotate existing id/reference getters (keep API and DB clean)</h3>
<div class="ulist">
<ul>
<li>
<p>Prefer annotating getters that already exist in your schema (String ids or existing @Reference fields). Avoid adding embedded objects solely to drive ontology.</p>
</li>
<li>
<p>If you do need a synthetic accessor purely for ontology, hide it from API docs and persistence using @JsonIgnore, @Schema(hidden = true), and @dev.morphia.annotations.Transient.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Recommended pattern: annotate an existing id getter (Swagger unchanged)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.ontology.annotations.OntologyClass</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.annotations.OntologyProperty</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Existing field that is already part of your API/DB contract</span>
  <span class="directive">private</span> <span class="predefined-type">String</span> customerRefName;

  <span class="directive">public</span> <span class="predefined-type">String</span> getCustomerRefName() { <span class="keyword">return</span> customerRefName; }
  <span class="directive">public</span> <span class="type">void</span> setCustomerRefName(<span class="predefined-type">String</span> v) { <span class="local-variable">this</span>.customerRefName = v; }

  <span class="comment">// Drives ontology edges without changing Swagger: the getter already exists and returns a String id</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> <span class="predefined-type">String</span> customerIdForEdges() { <span class="keyword">return</span> getCustomerRefName(); }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because AnnotatedEdgeExtractor treats CharSequence targets as ids, annotating a String-returning getter produces edges without introducing new embedded objects. Your Swagger/OpenAPI and persisted shape remain unchanged.</p>
</div>
<div class="paragraph">
<p>Optional: use an existing @Reference instead of an id</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@dev</span>.morphia.annotations.Reference
  <span class="directive">private</span> Customer customer; <span class="comment">// already in your schema</span>

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> Customer getCustomer() { <span class="keyword">return</span> customer; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you must add an ontology-only accessor, hide it</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonIgnore</span>;
<span class="keyword">import</span> <span class="include">io.swagger.v3.oas.annotations.media.Schema</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.annotations.Transient</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> orgRefName; <span class="comment">// real field</span>

  <span class="comment">// Hidden from API docs and persistence, used only to emit an ontology edge</span>
  <span class="annotation">@JsonIgnore</span>
  <span class="annotation">@Schema</span>(hidden = <span class="predefined-constant">true</span>)
  <span class="annotation">@Transient</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, subPropertyOf = {<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>})
  <span class="directive">public</span> <span class="predefined-type">String</span> placedInOrgEdge() { <span class="keyword">return</span> orgRefName; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These patterns keep your REST and database contracts clear while allowing ontology materialization to happen automatically on writes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-rest-api">46. Exploring the ontology via REST and JointJS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows how to inspect your ontology (TBox) and your instance relationships (ABox) through a small, read‑only REST API and how to render the results in a browser using JointJS. These endpoints are implemented in the quantum-ontology-mongo module and are intended for diagnostics, admin tooling, and lightweight visualization.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For a complete, copy‑paste friendly reference of every parameter and more examples, see the module guide at quantum-ontology-mongo/README.md. The summary below is intentionally concise to keep this document flowing without duplication.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_base_info">46.1. Base info</h3>
<div class="ulist">
<ul>
<li>
<p>Base path: /ontology</p>
</li>
<li>
<p>Media type: application/json</p>
</li>
<li>
<p>Security: Bearer JWT, roles user or admin</p>
</li>
<li>
<p>Multi‑tenancy: pass X-Realm: &lt;tenant-id&gt; header for ABox queries (and for any repo‑backed calls). TBox demos may work without it if your deployment wires an in‑memory registry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example (replace token and realm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -H &quot;Authorization: Bearer $TOKEN&quot; \
     -H &quot;X-Realm: demo&quot; \
     http://localhost:8080/ontology/summary</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tbox_schema_endpoints">46.2. TBox (schema) endpoints</h3>
<div class="paragraph">
<p>These expose ontology registry metadata and a JointJS‑ready schema graph.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /ontology/registry — Full TBox snapshot. Depending on your registry producer, classes may be best‑effort.</p>
</li>
<li>
<p>GET /ontology/classes — Lists known classes (often inferred from property domains/ranges).</p>
</li>
<li>
<p>GET /ontology/classes/{name} — Class details by name.</p>
</li>
<li>
<p>GET /ontology/properties — Lists properties.</p>
</li>
<li>
<p>GET /ontology/properties/{name} — Property details by name.</p>
</li>
<li>
<p>GET /ontology/propertyChains — Lists property chains.</p>
</li>
<li>
<p>GET /ontology/graph/jointjs — Returns { cells: [&#8230;&#8203;] } for a quick schema visualization in JointJS.</p>
</li>
<li>
<p>GET /ontology/summary — Small counts summary (classes/properties/chains).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basic call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -H &quot;Authorization: Bearer $TOKEN&quot; \
     http://localhost:8080/ontology/graph/jointjs | jq '.cells | length'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_abox_instances_graph_endpoint">46.3. ABox (instances) graph endpoint</h3>
<div class="paragraph">
<p>Builds a neighborhood graph around a specific instance (src id + type). Useful for investigating relationships and verifying inferences.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GET /ontology/graph/instances/jointjs</p>
</li>
<li>
<p>Headers: X-Realm: &lt;tenant-id&gt; (required)</p>
</li>
<li>
<p>Query params:</p>
</li>
<li>
<p>src: source id (required)</p>
</li>
<li>
<p>type: ontology class/type of the source id (required)</p>
</li>
<li>
<p>direction: out | in | both (default: out)</p>
</li>
<li>
<p>p: repeatable predicate filter (optional)</p>
</li>
<li>
<p>limit: max edges to include (default: 200)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">curl -H &quot;Authorization: Bearer $TOKEN&quot; \
     -H &quot;X-Realm: demo&quot; \
     &quot;http://localhost:8080/ontology/graph/instances/jointjs?src=O1&amp;type=Order&amp;direction=both&amp;limit=100&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Response shape:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{ <span class="key"><span class="delimiter">&quot;</span><span class="content">cells</span><span class="delimiter">&quot;</span></span>: [] }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Elements (instances) are rectangles with attrs.root data-type=instance and data-class=&lt;Type&gt;.</p>
</li>
<li>
<p>Links are labeled with the predicate. Inferred links are visually distinguished and marked in data:</p>
</li>
<li>
<p>Styling: dashed gray stroke (strokeDasharray: "5,5", stroke: "#9e9e9e").</p>
</li>
<li>
<p>Metadata: data.inferred = true.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rendering_with_jointjs_quick_snippet">46.4. Rendering with JointJS (quick snippet)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">async <span class="keyword">function</span> <span class="function">renderJointJs</span>(divId, url) {
  const res = await fetch(url, { <span class="key">headers</span>: { <span class="key"><span class="delimiter">'</span><span class="content">Authorization</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Bearer </span><span class="delimiter">'</span></span> + window.token, <span class="key"><span class="delimiter">'</span><span class="content">X-Realm</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">demo</span><span class="delimiter">'</span></span> } });
  const { cells } = await res.json();
  const graph = <span class="keyword">new</span> joint.dia.Graph();
  graph.fromJSON({ cells });
  const paper = <span class="keyword">new</span> joint.dia.Paper({ <span class="key">el</span>: document.getElementById(divId), <span class="key">model</span>: graph, <span class="key">width</span>: <span class="integer">1400</span>, <span class="key">height</span>: <span class="integer">900</span>, <span class="key">gridSize</span>: <span class="integer">10</span>, <span class="key">drawGrid</span>: <span class="predefined-constant">true</span> });
  <span class="comment">// Optional: apply a layout here</span>
}
<span class="comment">// Example: schema graph</span>
<span class="comment">// renderJointJs('paper', '/ontology/graph/jointjs');</span>
<span class="comment">// Example: instance graph around Order O1</span>
<span class="comment">// renderJointJs('paper', '/ontology/graph/instances/jointjs?src=O1&amp;type=Order&amp;direction=both');</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JointJS will honor the attrs/labels we return. You can add a legend in your UI to explain that dashed gray edges are inferred, while solid edges are explicit.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_when_to_use_these_endpoints">46.5. When to use these endpoints</h3>
<div class="ulist">
<ul>
<li>
<p>During development: inspect whether your ontology registry is loaded as expected and whether property chains/inverses are effective.</p>
</li>
<li>
<p>During troubleshooting: confirm that edges exist for the predicates your queries or policies reference (see also <a href="#ontology-integration-morphia-permissions">Integrating Ontology</a>).</p>
</li>
<li>
<p>For lightweight admin tools: the JointJS payload can be embedded in a simple HTML page to visualize current relationships.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For deep dives, parameter matrices, and additional examples (including large graph considerations), consult quantum-ontology-mongo/README.md in this repository.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dev-howto-ontology-yaml-materialization-reindex-provenance">47. Developer how-to: YAML properties, chains, write-time materialization, reindex, and provenance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section is a concise, task-focused guide for developers. It shows how to declare properties and chains in YAML, how write-time materialization works and how to toggle it, how to reindex after YAML changes, and how edge provenance is stored and how deletions are handled. Examples use the Order/Shipment/Address/Org model.</p>
</div>
<div class="sect2">
<h3 id="_declare_properties_and_chains_in_yaml">47.1. Declare properties and chains in YAML</h3>
<div class="paragraph">
<p>Place an ontology.yaml in your classpath (src/main/resources) or supply a path via environment variable ONTOLOGY_YAML or system property ontology.yaml.path. The loader supports classes, properties, and property chains.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">version</span>: <span class="string"><span class="content">1</span></span>
<span class="key">classes</span>:
  - <span class="string"><span class="content">id: Order</span></span>
  - <span class="string"><span class="content">id: Customer</span></span>
  - <span class="string"><span class="content">id: Organization</span></span>
  - <span class="string"><span class="content">id: Shipment</span></span>
  - <span class="string"><span class="content">id: Address</span></span>
  - <span class="string"><span class="content">id: Region</span></span>

<span class="key">properties</span>:
  - <span class="string"><span class="content">id: placedBy</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Customer</span></span>
    <span class="key">functional</span>: <span class="string"><span class="content">true</span></span>
  - <span class="string"><span class="content">id: memberOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Customer</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
  - <span class="string"><span class="content">id: orderHasShipment</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Shipment</span></span>
  - <span class="string"><span class="content">id: shipsTo</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Shipment</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Address</span></span>
  - <span class="string"><span class="content">id: locatedIn</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Address</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Region</span></span>
  - <span class="string"><span class="content">id: ancestorOf</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
    <span class="key">transitive</span>: <span class="string"><span class="content">true</span></span>
  <span class="comment"># implied predicates materialized by chains</span>
  - <span class="string"><span class="content">id: placedInOrg</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Organization</span></span>
  - <span class="string"><span class="content">id: orderShipsTo</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Address</span></span>
  - <span class="string"><span class="content">id: orderShipsToRegion</span></span>
    <span class="key">domain</span>: <span class="string"><span class="content">Order</span></span>
    <span class="key">range</span>: <span class="string"><span class="content">Region</span></span>

<span class="key">chains</span>:
  - <span class="string"><span class="content">chain: [placedBy, memberOf]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">placedInOrg</span></span>
  - <span class="string"><span class="content">chain: [orderHasShipment, shipsTo]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">orderShipsTo</span></span>
  - <span class="string"><span class="content">chain: [orderShipsTo, locatedIn]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">orderShipsToRegion</span></span>
  - <span class="string"><span class="content">chain: [placedInOrg, ancestorOf]</span></span>
    <span class="key">implies</span>: <span class="string"><span class="content">placedInOrg</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Chains are ordered. The last predicate referenced must already exist as a property id.
- You may chain an implied property (e.g., placedInOrg) with another property (ancestorOf) to re-imply itself (useful with transitivity on ancestorOf).
- Domain and range help with type checking and tooling; they are optional but recommended.</p>
</div>
<div class="paragraph">
<p>See also: <a href="#_defining_an_ontology_with_yaml_yamlontologyloader">Defining an ontology with YAML (YamlOntologyLoader)</a> for a broader introduction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_write_time_materialization_what_runs_and_how_to_toggle">47.2. Write-time materialization: what runs and how to toggle</h3>
<div class="paragraph">
<p>When an entity annotated with @OntologyClass is persisted, the framework:
- Extracts explicit edges from fields/getters annotated with @OntologyProperty on that entity.
- Merges any additional explicit edges from SPI providers (beans implementing com.e2eq.ontology.spi.OntologyEdgeProvider).
- Calls OntologyMaterializer, which runs the forward-chaining reasoner and writes the inferred/derived edges. It also prunes stale explicit and inferred edges for that source.</p>
</div>
<div class="paragraph">
<p>Global toggle</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># default is true
ontology.auto-materialize=true</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set ontology.auto-materialize=false to temporarily disable the write hook (useful for bulk loads or tests).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Per-property toggle</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, materializeEdge = <span class="predefined-constant">false</span>)
<span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; shipmentRefNames;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>materializeEdge=false skips extracting explicit edges for that property only. This does not disable derived edges that might arise from other explicit inputs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Provider-based edges</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement OntologyEdgeProvider to contribute explicit edges not backed by fields. The extractor merges these before materialization. See <a href="#_where_ontology_materialization_happens">Where ontology materialization happens</a> for a full example.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_reindex_after_yaml_changes">47.3. Reindex after YAML changes</h3>
<div class="paragraph">
<p>If you change ontology.yaml (add properties, mark a property transitive, add chains), you should trigger a tenant-wide re-materialization so derived edges reflect the new rules.</p>
</div>
<div class="paragraph">
<p>REST endpoints (admin-only):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># Start reindex for a realm (tenant)
curl -X POST &quot;http://localhost:8080/ontology/admin/reindex?realm=default&quot;

# Check status
curl -s &quot;http://localhost:8080/ontology/admin/reindex/status&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tips:
- Reindex discovers all @OntologyClass entities via Morphia and re-applies write-time materialization to each instance.
- For large tenants, consider running during off-hours. The service streams per class; status shows progress.
- If you need to purge previously derived edges before recomputing, use a force mode if exposed by your deployment (some environments wire runAsync(realm, force=true)).</p>
</div>
<div class="paragraph">
<p>Related: Drift-repair job</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For targeted repair, use the drift-repair endpoint to prune unsupported derived edges and re-derive per entity class with pagination:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"># Run prune+derive for Orders (page size 100)
curl -X POST &quot;http://localhost:8080/ontology/admin/drift-repair?realm=default&amp;entityClass=com.yourpkg.Order&amp;pageSize=100&quot;

# Continue from a page token
curl -X POST &quot;http://localhost:8080/ontology/admin/drift-repair?realm=default&amp;entityClass=com.yourpkg.Order&amp;pageToken=6543210abcdef...&quot;

# Only prune (no derive)
curl -X POST &quot;http://localhost:8080/ontology/admin/drift-repair?realm=default&amp;entityClass=com.yourpkg.Order&amp;derive=false&quot;

# Dry-run (no writes)
curl -X POST &quot;http://localhost:8080/ontology/admin/drift-repair?realm=default&amp;entityClass=com.yourpkg.Order&amp;dryRun=true&quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_edge_provenance_format_and_deletions">47.4. Edge provenance format and deletions</h3>
<div class="paragraph">
<p>Storage model (Mongo edges collection):
- Each edge document stores: tenantId, src, srcType, p (predicate), dst, dstType, inferred, derived, prov (map), support (list), ts.
- Derived edges include structured support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dataDomain</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ORD-1</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">US-WEST</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">inferred</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">derived</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">prov</span><span class="delimiter">&quot;</span></span>: { <span class="key"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">chain(orderShipsTo,locatedIn)</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">ORD-1|orderShipsTo|ADDR-9</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ADDR-9|locatedIn|US-WEST</span><span class="delimiter">&quot;</span></span>] },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">support</span><span class="delimiter">&quot;</span></span>: [ { <span class="key"><span class="delimiter">&quot;</span><span class="content">ruleId</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">chain:orderShipsTo&gt;locatedIn</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">pathEdgeIds</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">ORD-1|orderShipsTo|ADDR-9</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ADDR-9|locatedIn|US-WEST</span><span class="delimiter">&quot;</span></span>] } ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ts</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">2025-11-10T20:22:00Z</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deletion and pruning rules
- Explicit edges: Re-computed on each write. For each predicate p on the source, any previous explicit dst not present in the new explicit set is deleted (deleteExplicitBySrcNotIn).
- Inferred/derived edges: After recomputation, any prior inferred edge for p whose dst is not in the newly inferred set is deleted (deleteInferredBySrcNotIn).
- Safety cleanup: A periodic or manual prune removes derived edges that have no support recorded (pruneDerivedWithoutSupport). Use the drift-repair job or a scheduled task to keep storage clean when inputs are removed out-of-band.</p>
</div>
<div class="paragraph">
<p>Worked examples (source Order = O, Customer = C, Organization = G, Shipment = S, Address = A, Region = R)</p>
</div>
<div class="paragraph">
<p>1) [placedBy, memberOf] ⇒ placedInOrg</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inputs: O --placedBy-&#8594; C, C --memberOf-&#8594; G</p>
</li>
<li>
<p>Implied: O --placedInOrg-&#8594; G</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">O</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">srcType</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">dst</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">G</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">dstType</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">inferred</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">derived</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">prov</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">chain(placedBy,memberOf)</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>:[<span class="string"><span class="delimiter">&quot;</span><span class="content">O|placedBy|C</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">C|memberOf|G</span><span class="delimiter">&quot;</span></span>]},
 <span class="key"><span class="delimiter">&quot;</span><span class="content">support</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">ruleId</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">chain:placedBy&gt;memberOf</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">pathEdgeIds</span><span class="delimiter">&quot;</span></span>:[<span class="string"><span class="delimiter">&quot;</span><span class="content">O|placedBy|C</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">C|memberOf|G</span><span class="delimiter">&quot;</span></span>]}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) [orderHasShipment, shipsTo] ⇒ orderShipsTo</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inputs: O --orderHasShipment-&#8594; S, S --shipsTo-&#8594; A</p>
</li>
<li>
<p>Implied: O --orderShipsTo-&#8594; A</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{"src":"O","srcType":"Order","p":"orderShipsTo","dst":"A","dstType":"Address","inferred":true,"derived":true,
 "prov":{"rule":"chain(orderHasShipment,shipsTo)","inputs":["O|orderHasShipment|S","S|shipsTo|A"]},
 "support":[{"ruleId":"chain:orderHasShipment&gt;shipsTo","pathEdgeIds":["O|orderHasShipment|S","S|shipsTo|A"]}]}</pre>
</div>
</div>
<div class="paragraph">
<p>3) [orderShipsTo, locatedIn] ⇒ orderShipsToRegion</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inputs: O --orderShipsTo-&#8594; A, A --locatedIn-&#8594; R</p>
</li>
<li>
<p>Implied: O --orderShipsToRegion-&#8594; R</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{"src":"O","srcType":"Order","p":"orderShipsToRegion","dst":"R","dstType":"Region","inferred":true,"derived":true,
 "prov":{"rule":"chain(orderShipsTo,locatedIn)","inputs":["O|orderShipsTo|A","A|locatedIn|R"]},
 "support":[{"ruleId":"chain:orderShipsTo&gt;locatedIn","pathEdgeIds":["O|orderShipsTo|A","A|locatedIn|R"]}]}</pre>
</div>
</div>
<div class="paragraph">
<p>4) [placedInOrg, ancestorOf] ⇒ placedInOrg</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inputs: O --placedInOrg-&#8594; G1, G1 --ancestorOf-&#8594; G2 (ancestorOf is transitive)</p>
</li>
<li>
<p>Implied: O --placedInOrg-&#8594; G2 (can repeat over the ancestor chain)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{"src":"O","srcType":"Order","p":"placedInOrg","dst":"G2","dstType":"Organization","inferred":true,"derived":true,
 "prov":{"rule":"chain(placedInOrg,ancestorOf)","inputs":["O|placedInOrg|G1","G1|ancestorOf|G2"]},
 "support":[{"ruleId":"chain:placedInOrg&gt;ancestorOf","pathEdgeIds":["O|placedInOrg|G1","G1|ancestorOf|G2"]}]}</pre>
</div>
</div>
<div class="paragraph">
<p>Operational notes
- If you delete inputs (e.g., remove C.memberOf=G), the next write of O (or a reindex) will prune stale placedInOrg edges. If inputs are removed out-of-band, run drift-repair to prune unsupported derived edges.
- Always scope operations by realm/tenant. Edges are partitioned by dataDomain.tenantId and indexed accordingly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_samples_2">48. Samples</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="tutorial-supply-chain" class="sect0">Supply Chain Collaboration SaaS: A Business‑First Guide</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This guide explains, in plain language, how the Quantum framework helps you build a Supply Chain Collaboration Software‑as‑a‑Service (SaaS). We focus on real business problems—secure data sharing, multi‑party workflows, and tenant isolation—and show how the framework’s building blocks solve them without requiring you to stitch together dozens of bespoke APIs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_a_supplychain_saas_needs_and_how_quantum_helps">49. What a supply‑chain SaaS needs (and how Quantum helps)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Common needs when launching a collaboration platform:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secure sharing across companies: Buyers, suppliers, carriers, and 3PLs must see the same truth, but only what they’re allowed to see.</p>
</li>
<li>
<p>Role‑appropriate views: Planners, operations, and analysts look at the same orders/shipments but need different fields, filters, and actions.</p>
</li>
<li>
<p>Auditability and control: You need a clear explanation of who saw or changed what, and why that was allowed.</p>
</li>
<li>
<p>Fast onboarding: Each partner authenticates differently; you can’t force everyone into one identity provider.</p>
</li>
<li>
<p>API consistency: Your UI and integrations shouldn’t learn a different API for every screen or entity.</p>
</li>
<li>
<p>Data lifecycle and stewardship: Easy data imports/exports, clear status tracking, and repeatable completion steps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How Quantum maps to these needs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multi‑tenancy by design: Each organization (tenant) is isolated by default; sharing is added deliberately and safely.</p>
</li>
<li>
<p>Policy‑driven permissions: Human‑readable rules answer “who can do what” and add scoping filters so only the right data shows up.</p>
</li>
<li>
<p>Consistent REST and Query: One List API and a simple query language cover most searches and reports—no explosion of bespoke endpoints.</p>
</li>
<li>
<p>Flexible identity: Support for different authentication methods per organization, plus delegated admin so each tenant manages its own users.</p>
</li>
<li>
<p>State + tasks: Built‑in patterns for long‑running, stateful processes and “completion tasks” to move work forward predictably.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_multitenancy_is_a_natural_fit_for_supply_chains">50. Why multi‑tenancy is a natural fit for supply chains</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Supply chains are networks. Everyone shares a process, but not a database. Quantum isolates each tenant’s data by default and lets you selectively share records with partners:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Private by default: A supplier’s purchase orders are not visible to other suppliers.</p>
</li>
<li>
<p>Share on purpose: Create a “collaboration bubble” around a purchase order or shipment so a buyer and a specific carrier can see the same milestones and documents.</p>
</li>
<li>
<p>Central where it helps: Keep a global partner directory or product catalog in a shared domain if that reduces duplication.</p>
</li>
<li>
<p>Regional and regulatory needs: Pin certain data (e.g., EU shipments) to the correct region with simple policies.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_who_uses_the_system_organizations_and_roles">51. Who uses the system (organizations and roles)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Organizations (tenants)
- Shippers and customers: create orders, monitor shipments, approve changes.
- Carriers and 3PLs: accept tenders, provide status, confirm delivery.
- Suppliers: acknowledge POs, provide ASN/invoice data.</p>
</div>
<div class="paragraph">
<p>Common user types within each organization
- Planners: need forward‑looking visibility—capacity, forecasts, purchase orders.
- Operations: need day‑to‑day details—stops, ETAs, exceptions.
- Business analysts: need trends and history—on‑time performance, cost, root causes.</p>
</div>
<div class="paragraph">
<p>Data visibility examples
- Private notes: an operations note on a shipment visible only inside the shipper’s tenant.
- Shared context: a delivery appointment visible to both the shipper and the carrier for a specific shipment.
- Role‑filtered: analysts see aggregated KPIs, planners see open exceptions, operators see actionable tasks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identity_and_access_meet_partners_where_they_are">52. Identity and access: meet partners where they are</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every organization may authenticate differently:
- Enterprise SSO (OIDC/SAML) for shippers and large suppliers.
- Username/password for smaller partners.
- Service accounts and tokens for system‑to‑system integrations.</p>
</div>
<div class="paragraph">
<p>Quantum supports these patterns and lets each tenant manage its own users (delegated administration). Permissions can differ by user type and tenant while staying auditable and predictable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modeling_without_jargon_areas_domains_and_actions">53. Modeling without jargon: Areas, Domains, and Actions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To keep your platform organized, Quantum groups things into:
- Functional Areas: broad business spaces like Collaboration, Finance, or Catalog.
- Functional Domains: specific entity types within an area—Partner, Shipment, PurchaseOrder, Invoice.
- Functional Actions: what users do—VIEW, CREATE, UPDATE, DELETE, APPROVE, EXPORT, etc.</p>
</div>
<div class="paragraph">
<p>Why this matters:
- Clear menus for the UI (group screens by area and domain).
- Clear policy rules (easier to say “Carriers can VIEW Shipments” or “Only Finance can APPROVE Invoices”).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_policies_that_say_who_can_do_what_rule_language">54. Policies that say “who can do what” (Rule Language)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Policies are simple, readable rules that match:
- Who is calling (identity and roles)
- What they’re trying to access (area, domain, action)
- Request details (headers/body, like a shipment id or tenant)</p>
</div>
<div class="paragraph">
<p>Rules then allow or deny the action and can add filters so the user only sees data they’re permitted to see. See the Permissions guide for authoring details (<a href="../user-guide/permissions.html#permissions">Permissions Guide</a>).</p>
</div>
<div class="paragraph">
<p>Write‑time data placement (where a new record belongs)
- By default, new records use the creator’s organization.
- You can override per area/domain with a small policy—for example, keep Partner records in a shared “directory” domain while Shipments stay tenant‑local. See “Data domain assignment on create” (<a href="../user-guide/permissions.html#_data_domain_assignment">../user-guide/permissions.html</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_domain_contexts_and_domain_policies_placing_and_sharing_data">55. Domain contexts and domain policies (placing and sharing data)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In supply chains, the same entity often lives in different business contexts (e.g., a Shipment inside a Supplier’s operations vs. the Buyer’s view). Domain contexts let you keep data where it naturally belongs while still collaborating safely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep most data tenant‑local: Each organization owns its operational truth (orders, shipments, tasks).</p>
</li>
<li>
<p>Create shared contexts deliberately: Use a shared “Directory” context for master data like Partners and Facilities so everyone references the same records.</p>
</li>
<li>
<p>Policy‑driven sharing: Collaboration bubbles share just the relevant records (a specific PO, shipment, or appointment) with the right partners. Policies ensure each party only sees the fields and actions appropriate to them.</p>
</li>
<li>
<p>Regional and compliance contexts: Pin data to a geography (e.g., EU) when regulations require it; policies keep reads and writes aligned.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Business impact
- Lower friction: Organize data the way teams actually work (local operations + shared directories).
- Safer collaboration: Sharing is explicit and explainable—no surprise data leaks.
- Compliance by construction: Residency and scoping rules are enforced by policy, not by custom code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrap_tenants_with_seed_packs_zerotouch_baseline_data">56. Bootstrap tenants with Seed Packs (zero‑touch baseline data)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Onboarding partners is a bottleneck in many SaaS rollouts. Seed packs provide a fast, repeatable way to initialize each tenant with the right starting data and settings.</p>
</div>
<div class="paragraph">
<p>What seed packs give you
- Versioned, reviewable baseline: Curate CSV/JSON datasets and settings (code lists, roles, sample workflows) under version control.
- Archetypes for editions: Bundle multiple packs into a named edition (e.g., “Logistics Core” vs. “Supplier Lite”) to match your product tiers.
- Safe, idempotent updates: Re‑apply packs any time; only changes are applied. You can inspect what’s pending before you apply.
- Admin APIs and startup automation: New tenants can be provisioned with the right archetype automatically; admins can check pending updates and apply them when ready.</p>
</div>
<div class="paragraph">
<p>Why this matters to a supply‑chain SaaS
- Faster go‑live: New buyers, suppliers, and carriers start with consistent roles, code lists, and sample workflows.
- Less manual setup: Reduce back‑and‑forth with partners; eliminate error‑prone spreadsheets and one‑off scripts.
- Controlled change: Roll out new catalogs or policy tweaks as a versioned pack; apply to selected tenants when they opt in.</p>
</div>
<div class="paragraph">
<p>Learn more: <a href="../user-guide/seed-packs.html">Seed packs and declarative tenant seeding</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security_policies_practical_protections_and_proofs">57. Security policies: practical protections and proofs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Security isn’t just login. The framework’s policy layer turns business rules into enforceable, auditable protections across UI, APIs, and imports/exports.</p>
</div>
<div class="paragraph">
<p>What’s protected
- Least privilege by role: Planners, Operators, and Analysts only get the actions and fields they need.
- Field‑level and record‑level controls: Share a shipment with a carrier without exposing private buyer notes or margins.
- Tamper‑evident changes: Important state transitions and task completions are tracked and explainable.
- Delegated administration: Each organization manages its users and roles; platform admins retain oversight with audit trails.</p>
</div>
<div class="paragraph">
<p>Why it’s better than ad‑hoc controls
- One policy engine, everywhere: The same rules guard screens, APIs, and bulk operations—reducing gaps and regressions.
- Explainable decisions: When an action is denied or filtered, admins can see why.
- Easier audits: Policies and seed packs create a repeatable, documented configuration per tenant.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_small_powerful_api_surface_list_query">58. A small, powerful API surface: List + Query</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Instead of building a unique search endpoint for every screen, Quantum gives you:
- List API: a single, consistent endpoint per domain to list, filter, sort, page, and project fields.
- Query Language: a simple filter syntax so UIs and reports can ask precise questions.
- Automatic enforcement: policies and data‑domain rules are always applied server‑side, so callers only receive allowed data.</p>
</div>
<div class="paragraph">
<p>Business outcomes
- Faster delivery: new screens reuse the same list API.
- Fewer mistakes: less custom code, more consistent results.
- Safer by default: even power users can’t bypass policy enforcement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delegated_administration_tenantlevel_user_management">59. Delegated Administration (tenant‑level user management)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Empower each organization to run their own house while you keep platform‑wide safety:
- Tenant admins invite users, reset passwords, and assign roles.
- Role templates per tenant align with their org structure (Planner, Ops, Analyst, Carrier Dispatcher, etc.).
- Cross‑tenant boundaries are respected; global administrators can still support, audit, and troubleshoot with impersonation/acting‑on‑behalf‑of where permitted and logged.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrations_and_data_management">60. Integrations and data management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Supply chains depend on clean, timely data. Quantum provides:
- CSV imports/exports: onboard master data quickly, rerun safely, and let business users fix and re‑upload.
- Stateful objects: model processes (e.g., Shipment lifecycle) with clear states—Created → In‑Transit → Delivered → Closed.
- Completion Tasks: checklist‑like steps (confirm pickup, upload POD, reconcile invoice) that drive work to done and provide accountability.
- Consistent access: the same policies that protect your UI protect imports/exports and API calls.</p>
</div>
<div class="paragraph">
<p>Example uses
- Bulk load a new supplier catalog with CSV import; analysts export exceptions weekly for review.
- Track shipment exceptions as tasks; operations completes them with evidence (attachments/notes), all audited.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_endtoend_examples_2">61. End‑to‑end examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1) Buyer–supplier collaboration on a Purchase Order
- Create a collaboration bubble around a PO so both parties see schedule, holds, and documents.
- Supplier can UPDATE promised dates; buyer can APPROVE changes. Private buyer notes remain private.</p>
</div>
<div class="paragraph">
<p>2) Shared partner directory, curated centrally
- Keep one shared Partner domain so everyone finds the same carrier and facility records.
- Only directory curators can CREATE/UPDATE; all tenants can VIEW.</p>
</div>
<div class="paragraph">
<p>3) EU shipment residency
- Shipments created by anyone in Europe are written to an EU partition by policy. Reads remain role‑ and tenant‑scoped.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_you_dont_have_to_build_from_scratch">62. What you don’t have to build from scratch</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Data isolation and safe sharing across tenants</p>
</li>
<li>
<p>A consistent CRUD and search API for every domain</p>
</li>
<li>
<p>A policy engine that explains its decisions and applies filters</p>
</li>
<li>
<p>A write‑time placement policy (so data lands in the right partition)</p>
</li>
<li>
<p>Patterns for long‑running, stateful business processes and task completion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The framework gives you these foundations so your teams focus on business value—on‑time deliveries, lower cost, happier customers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_helpful_capabilities_you_get_out_of_the_box">63. Other helpful capabilities you get out of the box</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Pending seed visibility: Admins can see which seed packs have updates pending for a tenant before applying them, reducing surprise changes.</p>
</li>
<li>
<p>Version selection and rollback strategy: The platform automatically selects the latest compatible seed pack version; because packs are versioned and reviewable, you can test in a sandbox realm before rolling out.</p>
</li>
<li>
<p>Archetypes (editions): Model product tiers by composing packs; useful for offering lighter supplier/carrier editions versus full buyer editions.</p>
</li>
<li>
<p>Explainable access decisions: When access is denied or results are filtered, admins can inspect the reasoning—useful during partner onboarding and audits.</p>
</li>
<li>
<p>Idempotent imports/exports: Bulk data operations can be retried safely, which is critical when partners exchange large files over unreliable networks.</p>
</li>
<li>
<p>Observability hooks: Standardized endpoints and logs make it easier to monitor SLAs (e.g., late tasks, delayed updates) without custom plumbing.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps_2">64. Next steps</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Start with siloed defaults; prove value quickly using the List API.</p>
</li>
<li>
<p>Add small, targeted policies to enable collaboration bubbles and shared directories.</p>
</li>
<li>
<p>Introduce delegated administration so partners self‑serve.</p>
</li>
<li>
<p>Use CSV imports and Completion Tasks to operationalize data stewardship.</p>
</li>
<li>
<p>Deep dive: Permissions and Rule Language (<a href="../user-guide/permissions.html#permissions">Permissions Guide</a>), and Data domain assignment on create (<a href="../user-guide/permissions.html#_data_domain_assignment">Data domain assignment on create</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_day_in_the_life_from_purchase_order_to_delivery">65. A day in the life: From Purchase Order to Delivery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This story ties the pieces together in a realistic sequence. We follow a Purchase Order (PO) from creation to delivery, with shared visibility for suppliers and carriers, a clear state graph, and checklist-like Completion Tasks guiding the work.</p>
</div>
<div class="paragraph">
<p>1) Purchase Order is created (by the Buyer)
- Action: A buyer creates a PO in the Collaboration area under the PurchaseOrder domain.
- Data placement: By default, the PO is written to the buyer’s organization (their data domain). If you prefer a shared domain for POs, configure a small policy; otherwise, the default works well.
- Programmatic sharing: A rule shares the specific PO with the chosen Supplier (or Suppliers). The Supplier can view the PO and update the fields you allow (e.g., promised date), but cannot see private buyer-only fields.</p>
</div>
<div class="paragraph">
<p>State graph (illustrative)
- Draft → Open → SupplierAcknowledged → ReadyToShip → PartiallyShipped → FullyShipped → Received → Closed</p>
</div>
<div class="paragraph">
<p>Completion Tasks (examples attached to the PO)
- Buyer: Provide required documents (commercial terms, incoterms)
- Supplier: Acknowledge PO (due in 24 hours)
- Supplier: Provide ASN (advanced shipping notice) for each shipment
- Supplier: Confirm pickup window
- Buyer: Approve any date changes</p>
</div>
<div class="paragraph">
<p>2) The Supplier prepares shipments (shared onward to Carriers)
- Action: The Supplier creates one or more Shipments linked to the PO (and optionally to specific lines).
- Data placement: Shipments are written to the Supplier’s domain by default (their own organization), but are shared with the Buyer so both parties see the same timeline.
- Sharing to Carriers: When the Supplier tenders a shipment, the shipment is shared with the selected Carrier so they can update movement and milestones.</p>
</div>
<div class="paragraph">
<p>Shipment state graph (illustrative)
- Planned → Tendered → Accepted → InTransit → Delivered → ProofVerified → Closed</p>
</div>
<div class="paragraph">
<p>Shipment Completion Tasks (examples)
- Carrier: Confirm pickup
- Carrier: Update in-transit location/ETA
- Carrier: Upload POD (proof of delivery)
- Supplier: Reconcile quantities shipped vs. ordered</p>
</div>
<div class="paragraph">
<p>3) Status updates complete tasks and move states forward
- When the Supplier marks “SupplierAcknowledged,” the PO’s acknowledgement task completes and the PO moves to SupplierAcknowledged.
- When all lines are ready and at least one shipment is created, the PO advances to ReadyToShip. If some but not all lines ship, it enters PartiallyShipped; once all lines ship, it becomes FullyShipped.
- Carrier updates (e.g., Delivered with POD uploaded) complete shipment tasks. Those completion events can also advance the PO state (e.g., all shipments Delivered → PO moves to Received). Final checks (invoices matched, discrepancies resolved) move the PO to Closed.</p>
</div>
<div class="paragraph">
<p>Why this is safe and predictable
- Roles and policies ensure each party sees only what they should: the Buyer sees everything; the Supplier sees the shared PO and its related shipments; the Carrier sees only the shipments they handle.
- Completion Tasks remove ambiguity: everyone knows the next step and who owns it. Each task completion is audited.
- The state graph makes lifecycle transitions explicit. Policies can require certain tasks to be completed before a state transition is allowed.</p>
</div>
<div class="paragraph">
<p>4) Business visibility and reporting (List API + Query)
- Operations view: “Purchase Orders in progress” shows all POs in Open, SupplierAcknowledged, ReadyToShip, or PartiallyShipped, including late tasks and upcoming milestones.
- Buyer/supplier view: Both parties see the same PO status and related Shipments, with role-appropriate fields.
- Simple reporting example (illustrative):
  GET /collaboration/purchaseorder/list?filter=status IN ("Open","SupplierAcknowledged","ReadyToShip","PartiallyShipped")&amp;sort=dueDate:asc&amp;limit=50
  - Add projections to include key fields and roll-ups (e.g., shipped vs. ordered quantities). Related Shipment info can be retrieved similarly via the List API on the Shipment domain, filtered by the PO id.</p>
</div>
<div class="paragraph">
<p>What made this easy (and repeatable)
- Multi-tenancy by default: Each org’s data is isolated; sharing is explicit and safe.
- Policies (Rule Language): Define who can see or update which fields and when. The same rules apply to UI, API, and imports/exports.
- Data domain assignment on create: Defaults keep data in the creator’s org; you can configure exceptions (e.g., shared directories) with a tiny policy.
- Stateful objects + Completion Tasks: Clear states and checklists turn complex collaboration into a predictable flow.
- List API + Query Language: One consistent way to fetch work lists, timelines, and reports without proliferating custom endpoints.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_2">66. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuration">66.1. Configuration Reference</h3>
<div class="paragraph">
<p>This appendix explains key configuration properties used in Quantum applications, organized by functional area.</p>
</div>
<div class="sect3">
<h4 id="_configuration_basics">66.1.1. Configuration Basics</h4>
<div class="sect4">
<h5 id="_file_locations">File Locations</h5>
<div class="ulist">
<ul>
<li>
<p><code>src/main/resources/application.properties</code> - main configuration</p>
</li>
<li>
<p><code>src/test/resources/application.properties</code> - test overrides</p>
</li>
<li>
<p><code>.env</code> file - local development secrets (not committed)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_profiles_and_environment_variables">Profiles and Environment Variables</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Profile-specific properties
%dev.auth.jwt.duration=7200
%test.quarkus.mongodb.database=test-db
%prod.quarkus.log.level=WARN

# Environment variable substitution
quarkus.mongodb.connection-string=${MONGODB_CONNECTION_STRING:mongodb://localhost:27017}
auth.jwt.secret=${JWT_SECRET:change-me-in-production}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_precedence">Precedence</h5>
<div class="paragraph">
<p>System properties &gt; Environment variables &gt; application.properties</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database_configuration">66.1.2. Database Configuration</h4>
<div class="sect4">
<h5 id="_mongodb_connection">MongoDB Connection</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Basic connection
quarkus.mongodb.connection-string=mongodb://localhost:27017
quarkus.mongodb.database=my-app

# With authentication
quarkus.mongodb.connection-string=mongodb://user:pass@host:27017/database?authSource=admin

# Disable dev services (use real MongoDB)
quarkus.mongodb.devservices.enabled=false</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_morphia_configuration">Morphia Configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Database and package scanning
quarkus.morphia.database=my-app-db
quarkus.morphia.packages=com.example.model,com.example.entities

# Schema management
quarkus.morphia.create-caps=true
quarkus.morphia.create-indexes=true
quarkus.morphia.create-validators=true</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authentication_configuration">66.1.3. Authentication Configuration</h4>
<div class="sect4">
<h5 id="_jwt_provider_3">JWT Provider</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Enable JWT authentication
quarkus.smallrye-jwt.enabled=true
auth.provider=custom

# JWT validation
mp.jwt.verify.publickey.location=publicKey.pem
mp.jwt.verify.issuer=my-app
mp.jwt.verify.audiences=my-app-users

# Custom JWT settings
auth.jwt.secret=${JWT_SECRET:your-secret-here}
auth.jwt.expiration=60
auth.jwt.refresh-expiration=1440</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_oidc_provider">OIDC Provider</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Enable OIDC
quarkus.oidc.enabled=true
auth.provider=oidc

# OIDC configuration
quarkus.oidc.auth-server-url=https://your-provider.com/auth/realms/your-realm
quarkus.oidc.client-id=your-client-id
quarkus.oidc.credentials.secret=your-client-secret
quarkus.oidc.roles.role-claim-path=groups</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_quantum_framework_configuration">66.1.4. Quantum Framework Configuration</h4>
<div class="sect4">
<h5 id="_database_migration">Database Migration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Migration settings
quantum.database.version=1.0.0
quantum.database.scope=DEV
quantum.database.migration.enabled=true
quantum.database.migration.changeset.package=com.example.migrations</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_seed_packs_filesystem_classpath">Seed packs (filesystem + classpath)</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Enable seed pack discovery and application on startup
quantum.seed-pack.enabled=true
quantum.seed-pack.apply.on-startup=true

# Filesystem root for seed packs when present in the app repo
# If the path does not exist, the framework still loads classpath seed packs
# contributed by dependencies (e.g., quantum-framework) from resources under seed-packs/
quantum.seed-pack.root=src/main/resources/seed-packs

# Optional CSV filter to apply only specific seed pack names
# Example: quantum.seed.apply.filter=system-initialize,my-tenant
quantum.seed.apply.filter=</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Classpath seed loading: The framework automatically discovers seed packs packaged
under <code>seed-packs/</code> on the application classpath (including JAR dependencies).
Apps depending on the framework no longer need to copy framework seeds locally
or reference absolute file paths. If both filesystem and classpath contain seed
packs with the same name, the latest semantic version is applied.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_security_rules_diagnostics">Security rules diagnostics</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Elevate RuleContext auto‑reload diagnostics from DEBUG to INFO when troubleshooting
quantum.securityrules.ruleContext.debugAutoReload=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tips:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In unit tests that run inside Quarkus, prefer using a CDI‑managed <code>RuleContext</code>.
A helper is provided in tests: <code>RuleContextTestUtils.reload(&lt;realm&gt;)</code> to force
a refresh of policies from the repository for a given realm.</p>
</li>
<li>
<p>If you construct <code>RuleContext</code> manually (outside CDI), repository injection is not available,
and auto‑reload is skipped to avoid wiping programmatically added rules.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_realm_and_tenant_configuration">Realm and Tenant Configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># System realm configuration
quantum.realmConfig.systemTenantId=system
quantum.realmConfig.systemAccountId=system-account
quantum.realmConfig.systemOrgRefName=SYSTEM
quantum.realmConfig.systemUserId=system-user

# Default tenant settings
quantum.realmConfig.defaultTenantId=default
quantum.realmConfig.defaultAccountId=default-account
quantum.realmConfig.defaultOrgRefName=DEFAULT

# Anonymous user (use carefully)
quantum.anonymousUserId=anonymous</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_3">66.1.5. See Also</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://quarkus.io/guides/config-reference">Quarkus Configuration Guide</a></p>
</li>
<li>
<p><a href="../user-guide/auth.html">Authentication Configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ontology_configuration_optional">66.1.6. Ontology Configuration (optional)</h4>
<div class="paragraph">
<p>Enablement</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">e2eq.ontology.enabled=false   # default; set true to enable ontology wiring in your app</code></pre>
</div>
</div>
<div class="paragraph">
<p>TBox Persistence</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Enable TBox persistence to MongoDB (default: true)
# When enabled, the ontology TBox (schema) is persisted to MongoDB for faster startup
# and version history. The TBox is automatically rebuilt if the YAML source changes.
quantum.ontology.tbox.persist=true

# Force rebuild of TBox even if persisted version exists (default: false)
# Useful for development or when you want to ensure fresh rebuild from sources
quantum.ontology.tbox.force-rebuild=false

# Package scanning for @OntologyClass and @OntologyProperty annotations
quantum.ontology.scan.packages=com.example.model,com.example.entities</code></pre>
</div>
</div>
<div class="paragraph">
<p>Registry modes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In-memory (recommended to start): build a TBox in code/resources and instantiate OntologyRegistry.inMemory(tbox).</p>
</li>
<li>
<p>Mongo-backed (advanced): load a TBox from a Mongo collection and cache it in memory for hot reload/versioning.</p>
</li>
<li>
<p>Persisted TBox (recommended for production): TBox is persisted to MongoDB and loaded on startup for faster initialization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Edges collection and indexes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an edges collection (name of your choice) when enabling ontology. Ensure the following indexes:</p>
</li>
<li>
<p>Compound: { tenantId:1, p:1, dst:1 }</p>
</li>
<li>
<p>Compound: { tenantId:1, src:1, p:1 }</p>
</li>
<li>
<p>Optionally, add a TTL on ts for inferred edges if you plan periodic full recomputes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Materialization hooks</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use OntologyMaterializer to recompute inferred edges when entities change (sources and intermediates for your property chains).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../user-guide/ontology.html">Ontologies in Quantum</a></p>
</li>
<li>
<p><a href="../user-guide/ontology.html#ontology-integration-morphia-permissions">Integrating Ontology</a>
=== Quarkus Foundation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum builds on Quarkus, a Kubernetes-native Java stack optimized for fast startup, low memory footprint, and developer productivity.</p>
</div>
</div>
<div class="sect3">
<h4 id="_key_quarkus_capabilities">66.1.7. Key Quarkus Capabilities</h4>
<div class="sect4">
<h5 id="_developer_experience">Developer Experience</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Live reload</strong>: Code changes are reflected immediately in dev mode</p>
</li>
<li>
<p><strong>Unified config</strong>: Single application.properties for all configuration</p>
</li>
<li>
<p><strong>Dev UI</strong>: Rich development interface at <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a></p>
</li>
<li>
<p><strong>Test-first ergonomics</strong>: Built-in test support with @QuarkusTest</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_build_time_optimizations">Build-time Optimizations</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Classpath indexing</strong>: Aggressive build-time analysis reduces runtime scanning</p>
</li>
<li>
<p><strong>Ahead-of-time processing</strong>: Framework initialization moved to build time</p>
</li>
<li>
<p><strong>Jandex indexes</strong>: Annotation discovery without runtime reflection</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_cloud_native">Cloud Native</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Container integration</strong>: Seamless Docker and Kubernetes deployment</p>
</li>
<li>
<p><strong>Health checks</strong>: Built-in health and readiness endpoints</p>
</li>
<li>
<p><strong>Metrics</strong>: Micrometer and Prometheus integration</p>
</li>
<li>
<p><strong>Configuration</strong>: Environment-aware config with profiles</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arc_quarkus_cdi">66.1.8. Arc (Quarkus CDI)</h4>
<div class="paragraph">
<p>Arc is Quarkus' CDI implementation, focused on build-time analysis and small runtime overhead.</p>
</div>
<div class="sect4">
<h5 id="_common_scopes">Common Scopes</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Scope</th>
<th class="tableblock halign-left valign-top">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@ApplicationScoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stateless services, repositories (recommended default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RequestScoped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Per-request context holders</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Singleton</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single instance without CDI proxies</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Dependent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short-lived helpers (default if no scope declared)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_bean_discovery">Bean Discovery</h5>
<div class="ulist">
<ul>
<li>
<p>Classes become beans with scope annotations or producer methods</p>
</li>
<li>
<p>Use <code>@Qualifier</code> to disambiguate multiple implementations</p>
</li>
<li>
<p><code>Instance&lt;T&gt;</code> for programmatic bean selection</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_example">Example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductService</span> {
    <span class="annotation">@Inject</span> ProductRepo repo;

    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Product&gt; findActive() {
        <span class="keyword">return</span> repo.findByActive(<span class="predefined-constant">true</span>);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_native_compilation_with_graalvm">66.1.9. Native Compilation with GraalVM</h4>
<div class="sect4">
<h5 id="_benefits_2">Benefits</h5>
<div class="ulist">
<ul>
<li>
<p>Millisecond startup times</p>
</li>
<li>
<p>Drastically reduced memory footprint</p>
</li>
<li>
<p>Ideal for serverless and microservices</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_constraints">Constraints</h5>
<div class="ulist">
<ul>
<li>
<p>Reflection needs explicit configuration</p>
</li>
<li>
<p>Dynamic proxies require substitution</p>
</li>
<li>
<p>Some dynamic classloading limitations</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_4">Configuration</h5>
<div class="paragraph">
<p>Use <code>@RegisterForReflection</code> for classes accessed via reflection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RegisterForReflection</span>
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="comment">// Ensures reflection metadata in native image</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extension_ecosystem">66.1.10. Extension Ecosystem</h4>
<div class="paragraph">
<p>Quarkus provides extensions for:
- <strong>Data</strong>: MongoDB, PostgreSQL, Redis, Elasticsearch
- <strong>Security</strong>: JWT, OIDC, OAuth2, RBAC
- <strong>Messaging</strong>: Kafka, AMQP, JMS
- <strong>Observability</strong>: Metrics, tracing, health checks
- <strong>Cloud</strong>: AWS, Azure, Google Cloud integrations</p>
</div>
</div>
<div class="sect3">
<h4 id="_quantums_quarkus_integration">66.1.11. Quantum&#8217;s Quarkus Integration</h4>
<div class="paragraph">
<p>Quantum leverages Quarkus for:
- <strong>CDI</strong>: Dependency injection for repositories and services
- <strong>JAX-RS</strong>: REST endpoint framework via BaseResource
- <strong>Security</strong>: JWT/OIDC integration for authentication
- <strong>MongoDB</strong>: Morphia integration for persistence
- <strong>Configuration</strong>: MicroProfile Config for settings
- <strong>OpenAPI</strong>: Automatic API documentation</p>
</div>
</div>
<div class="sect3">
<h4 id="_getting_started_with_quarkus">66.1.12. Getting Started with Quarkus</h4>
<div class="sect4">
<h5 id="_create_project">Create Project</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:create \
    -DprojectGroupId=com.example \
    -DprojectArtifactId=my-app \
    -DclassName=&quot;com.example.MyResource&quot; \
    -Dpath=&quot;/hello&quot;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_development_mode">Development Mode</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_native_build">Native Build</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw package -Pnative</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_4">66.1.13. See Also</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://quarkus.io/guides/">Quarkus Guides</a></p>
</li>
<li>
<p><a href="https://quarkus.io/guides/cdi-reference">CDI Reference</a></p>
</li>
<li>
<p><a href="https://quarkus.io/guides/building-native-image">Native Image Guide</a>
=== Glossary</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_core_concepts">66.1.14. Core Concepts</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>BaseModel</strong></dt>
<dd>
<p>Abstract base class for all Quantum entities, providing DataDomain, audit fields, ID management, and validation hooks.</p>
</dd>
<dt class="hdlist1"><strong>DataDomain</strong></dt>
<dd>
<p>Scoping information attached to every model (tenantId, orgRefName, ownerId, etc.) that enables multi-tenant isolation and controlled sharing.</p>
</dd>
<dt class="hdlist1"><strong>DomainContext</strong></dt>
<dd>
<p>Runtime context representing the current execution scope (tenant, org, user, functional area/domain, action) used by repositories and security rules.</p>
</dd>
<dt class="hdlist1"><strong>Functional Area</strong></dt>
<dd>
<p>Broad business capability grouping (e.g., Catalog, Collaboration, Identity) used for organizing models and security policies.</p>
</dd>
<dt class="hdlist1"><strong>Functional Domain</strong></dt>
<dd>
<p>Specific entity type within a functional area (e.g., Product within Catalog, Shipment within Collaboration) used for fine-grained permissions.</p>
</dd>
<dt class="hdlist1"><strong>RuleContext</strong></dt>
<dd>
<p>Policy evaluation engine that determines allowed actions and contributes data filters based on identity, functional area/domain, and business rules.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_multi_tenancy">66.1.15. Multi-Tenancy</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Tenant</strong></dt>
<dd>
<p>Logical partition representing a customer or organization in a multi-tenant system, identified by tenantId.</p>
</dd>
<dt class="hdlist1"><strong>Organization (Org)</strong></dt>
<dd>
<p>Business unit within a tenant, identified by orgRefName, enabling sub-tenant grouping and sharing.</p>
</dd>
<dt class="hdlist1"><strong>Realm</strong></dt>
<dd>
<p>Database or data partition, often corresponding to a MongoDB database, that can be selected per request via X-Realm header.</p>
</dd>
<dt class="hdlist1"><strong>Shared Domain</strong></dt>
<dd>
<p>Data domain accessible across multiple tenants (e.g., public catalogs, partner directories) as opposed to tenant-isolated data.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_security_2">66.1.16. Security</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Principal</strong></dt>
<dd>
<p>Authenticated user identity with associated roles, tenant membership, and permissions.</p>
</dd>
<dt class="hdlist1"><strong>Permission Rule</strong></dt>
<dd>
<p>Declarative policy that matches requests (URL, method, headers, body) and decides ALLOW/DENY with optional data filters.</p>
</dd>
<dt class="hdlist1"><strong>Access Resolver</strong></dt>
<dd>
<p>Plugin that computes dynamic access lists (e.g., customer IDs a user can see) for use in permission filters.</p>
</dd>
<dt class="hdlist1"><strong>Impersonation</strong></dt>
<dd>
<p>Acting as another user identity for troubleshooting or administrative purposes, controlled by scripts and realm restrictions.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_data_and_persistence">66.1.17. Data and Persistence</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>MorphiaRepo</strong></dt>
<dd>
<p>Repository interface extending MongoDB operations with Quantum&#8217;s DataDomain filtering, validation, and audit capabilities.</p>
</dd>
<dt class="hdlist1"><strong>EntityReference</strong></dt>
<dd>
<p>Lightweight reference object containing ID, type, refName, and displayName, used for foreign keys without full object loading.</p>
</dd>
<dt class="hdlist1"><strong>StateGraph</strong></dt>
<dd>
<p>Finite state machine definition for model fields, enforcing valid states and transitions (e.g., Order: Draft → Processing → Shipped).</p>
</dd>
<dt class="hdlist1"><strong>Completion Task</strong></dt>
<dd>
<p>Persistent work item with status tracking, used for checklists and long-running processes with audit trails.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_rest_and_apis">66.1.18. REST and APIs</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>BaseResource</strong></dt>
<dd>
<p>Abstract REST resource class providing consistent CRUD endpoints (find, get, list, save, update, delete) with automatic security and validation.</p>
</dd>
<dt class="hdlist1"><strong>Query Language</strong></dt>
<dd>
<p>ANTLR-based filter syntax used across all list endpoints, permission rules, and access resolvers for consistent data querying.</p>
</dd>
<dt class="hdlist1"><strong>UIActions</strong></dt>
<dd>
<p>List of actions a user can perform on a specific entity instance, computed based on entity state and user permissions.</p>
</dd>
<dt class="hdlist1"><strong>CSV Import/Export</strong></dt>
<dd>
<p>Built-in endpoints for bulk data operations with validation, preview sessions, and error handling.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_framework_components">66.1.19. Framework Components</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>ValidationInterceptor</strong></dt>
<dd>
<p>Morphia interceptor that runs Jakarta Bean Validation and defaults DataDomain before persistence.</p>
</dd>
<dt class="hdlist1"><strong>SecurityFilter</strong></dt>
<dd>
<p>JAX-RS filter that builds security context (PrincipalContext, ResourceContext) and evaluates permissions for each request.</p>
</dd>
<dt class="hdlist1"><strong>DataDomainResolver</strong></dt>
<dd>
<p>Service that determines which DataDomain to assign to new entities based on functional area/domain policies.</p>
</dd>
<dt class="hdlist1"><strong>Migration</strong></dt>
<dd>
<p>Versioned database schema and data changes managed by Quantum&#8217;s migration framework with changeset tracking.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_annotations">66.1.20. Annotations</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>@FunctionalMapping</strong></dt>
<dd>
<p>Class-level annotation declaring a model&#8217;s functional area and domain, replacing legacy bmFunctionalArea() methods.</p>
</dd>
<dt class="hdlist1"><strong>@FunctionalAction</strong></dt>
<dd>
<p>Method-level annotation specifying the action performed by a REST endpoint when it differs from HTTP verb defaults.</p>
</dd>
<dt class="hdlist1"><strong>@TrackReferences</strong></dt>
<dd>
<p>Field annotation on @Reference fields that maintains back-reference sets for referential integrity checking.</p>
</dd>
<dt class="hdlist1"><strong>@RegisterForReflection</strong></dt>
<dd>
<p>Quarkus annotation ensuring classes are available for reflection in native images.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_external_integrations">66.1.21. External Integrations</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>JWT Provider</strong></dt>
<dd>
<p>Authentication module that validates JSON Web Tokens and populates security context with user identity and roles.</p>
</dd>
<dt class="hdlist1"><strong>OIDC Integration</strong></dt>
<dd>
<p>OpenID Connect support for enterprise identity providers like Keycloak, Auth0, and AWS Cognito.</p>
</dd>
<dt class="hdlist1"><strong>Feature Flags</strong></dt>
<dd>
<p>Configuration-driven capability toggles with targeting rules for gradual rollouts and A/B testing.</p>
</dd>
<dt class="hdlist1"><strong>Postmark Integration</strong></dt>
<dd>
<p>Email service integration for transactional messaging with template support.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_ontology_optional_feature">66.1.22. Ontology (optional feature)</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Ontology</strong></dt>
<dd>
<p>A formal description of concepts (classes) and their relationships (properties/predicates) with rules (e.g., property chains) that allow inferring implied facts. See <a href="../user-guide/ontology.html">Ontologies in Quantum</a>.</p>
</dd>
<dt class="hdlist1"><strong>Predicate / Property</strong></dt>
<dd>
<p>A named relationship (e.g., placedBy, memberOf, orderShipsToRegion). Predicates connect source and destination IDs and can be declared inverse or transitive.</p>
</dd>
<dt class="hdlist1"><strong>Property Chain</strong></dt>
<dd>
<p>A rule of the form p∘q⇒r meaning if (A --p-&#8594; B) and (B --q-&#8594; C), infer (A --r-&#8594; C). Chains make common traversals first-class and fast.</p>
</dd>
<dt class="hdlist1"><strong>Edge (materialized)</strong></dt>
<dd>
<p>A persisted tuple (tenantId, src, p, dst) representing a relationship, often inferred from rules. Edges live in a dedicated collection and power single-hop queries and policies.</p>
</dd>
<dt class="hdlist1"><strong>Ontology Materializer</strong></dt>
<dd>
<p>A component that computes inferred edges for an entity snapshot and upserts them to the edges collection. Keeps edges fresh as data changes.</p>
</dd>
<dt class="hdlist1"><strong>ListQueryRewriter</strong></dt>
<dd>
<p>A helper that turns semantic constraints into efficient Mongo queries (e.g., id IN srcIdsByDst). Integrates with permission rules and Morphia repos.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.2.3<br>
Last updated 2026-01-26 13:37:58 -0500
</div>
</div>
</body>
</html>