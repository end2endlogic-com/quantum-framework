<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>AI Agent Integration</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body id="ai-agent-integration" class="book toc2 toc-left">
<div id="header">
<h1>AI Agent Integration</h1>
<div class="details">
<span id="revnumber">version 1.3.0-SNAPSHOT,</span>
<span id="revdate">2026-02-23T21:00:11Z</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_goals">1. Goals</a></li>
<li><a href="#_query_gateway_as_the_single_integration_point_crudl">2. Query Gateway as the Single Integration Point (CRUDL)</a></li>
<li><a href="#_realistic_scenarios_and_use_cases">3. Realistic Scenarios and Use Cases</a>
<ul class="sectlevel2">
<li><a href="#_scenario_1_support_agent_looking_up_a_customer_or_order">3.1. Scenario 1: Support agent looking up a customer or order</a></li>
<li><a href="#_scenario_2_analyst_exploring_data_via_natural_language">3.2. Scenario 2: Analyst exploring data via natural language</a></li>
<li><a href="#_scenario_3_developer_in_cursor_asking_about_live_data_while_coding">3.3. Scenario 3: Developer in Cursor asking about live data while coding</a></li>
<li><a href="#_scenario_4_tenant_specific_bot_running_as_a_service_user">3.4. Scenario 4: Tenant-specific bot running as a service user</a></li>
<li><a href="#_scenario_5_one_integration_test_as_the_contract_for_the_bridge">3.5. Scenario 5: One integration test as the “contract” for the bridge</a></li>
<li><a href="#_scenario_6_suggesting_regulatory_obligations_for_an_entity_in_a_jurisdiction">3.6. Scenario 6: Suggesting regulatory obligations for an entity in a jurisdiction</a></li>
</ul>
</li>
<li><a href="#_integrating_the_query_grammar_into_the_agent_framework">4. Integrating the query grammar into the agent framework</a>
<ul class="sectlevel2">
<li><a href="#_query_hints_endpoint">4.1. Query-hints endpoint</a></li>
<li><a href="#_example_what_is_the_query_string_to_retrieve_locations_in_atlanta">4.2. Example: "What is the query string to retrieve locations in Atlanta?"</a></li>
<li><a href="#_example_did_you_know_you_could_use_expand_on_order_with_customer">4.3. Example: "Did you know you could use expand on Order with customer?"</a></li>
<li><a href="#_expand_and_ontology_in_the_same_flow">4.4. Expand and ontology in the same flow</a></li>
</ul>
</li>
<li><a href="#_asking_permission_and_policy_questions">5. Asking permission and policy questions</a>
<ul class="sectlevel2">
<li><a href="#_permission_check_api_single_decision">5.1. Permission check API (single decision)</a></li>
<li><a href="#_evaluate_api_full_allowdeny_matrix_for_an_identity">5.2. Evaluate API (full allow/deny matrix for an identity)</a></li>
<li><a href="#_if_not_why_not_identify_the_rule_that_caused_the_denial">5.3. "If not, why not?" — identify the rule that caused the denial</a></li>
<li><a href="#_suggesting_changes_to_rules_to_allow_an_actionentity_pair">5.4. Suggesting changes to rules to allow an action/entity pair</a></li>
<li><a href="#_least_privilege_rules_for_a_given_scenario">5.5. Least-privilege rules for a given scenario</a></li>
<li><a href="#_permission_hints_endpoint_discoverable_by_agents">5.6. Permission hints endpoint (discoverable by agents)</a></li>
</ul>
</li>
<li><a href="#multi-tenancy-and-tenant-specific-configuration">6. Multi-Tenancy and Tenant-Specific Configuration</a></li>
<li><a href="#_apis_to_add_gateway_centric">7. APIs to Add (Gateway-Centric)</a>
<ul class="sectlevel2">
<li><a href="#_1_agent_tools_capabilities_discovery">7.1. 1. Agent Tools / Capabilities (Discovery)</a></li>
<li><a href="#_2_schema_ontology_for_agents_retrieval_context">7.2. 2. Schema / Ontology for Agents (Retrieval Context)</a></li>
<li><a href="#_3_unified_agent_action_api">7.3. 3. Unified Agent Action API</a></li>
<li><a href="#_4_session_trace_headers_audit_and_multi_turn">7.4. 4. Session / Trace Headers (Audit and Multi-Turn)</a></li>
<li><a href="#_5_retrieval_context_endpoint_optional_rag_like">7.5. 5. Retrieval Context Endpoint (Optional, RAG-Like)</a></li>
</ul>
</li>
<li><a href="#_mcp_integration_cursor_chatgpt_gemini">8. MCP Integration (Cursor, ChatGPT, Gemini)</a>
<ul class="sectlevel2">
<li><a href="#_how_mcp_maps_to_the_framework_gateway_centric">8.1. How MCP Maps to the Framework (Gateway-Centric)</a></li>
<li><a href="#_two_integration_approaches">8.2. Two Integration Approaches</a>
<ul class="sectlevel3">
<li><a href="#_option_a_native_mcp_recommended">8.2.1. Option A: Native MCP (Recommended)</a></li>
<li><a href="#_option_b_mcp_bridge_server">8.2.2. Option B: MCP Bridge Server</a></li>
</ul>
</li>
<li><a href="#_client_configuration">8.3. Client Configuration</a></li>
<li><a href="#_auth_and_security_bridge">8.4. Auth and Security (Bridge)</a></li>
<li><a href="#_mcp_bridge_configuration">8.5. MCP Bridge Configuration</a>
<ul class="sectlevel3">
<li><a href="#_environment_variables_bridge">8.5.1. Environment Variables (Bridge)</a></li>
<li><a href="#_http_endpoints_the_bridge_calls">8.5.2. HTTP Endpoints the Bridge Calls</a></li>
<li><a href="#_requestresponse_examples_bridge_backend">8.5.3. Request/Response Examples (Bridge → Backend)</a></li>
<li><a href="#_cursor_configuration_example">8.5.4. Cursor Configuration Example</a></li>
<li><a href="#_claude_desktop_configuration_example">8.5.5. Claude Desktop Configuration Example</a></li>
<li><a href="#_backend_configuration_optional">8.5.6. Backend Configuration (Optional)</a></li>
<li><a href="#_integration_test_as_example">8.5.7. Integration Test as Example</a></li>
</ul>
</li>
<li><a href="#_implementation_order_for_mcp">8.6. Implementation Order for MCP</a></li>
<li><a href="#_mcp_references">8.7. MCP References</a></li>
</ul>
</li>
<li><a href="#_summary_table">9. Summary Table</a></li>
<li><a href="#_implementation_order">10. Implementation Order</a></li>
<li><a href="#_security_and_governance">11. Security and Governance</a></li>
<li><a href="#_references">12. References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section describes APIs to add to the framework to support AI agent integration, aligned with patterns discussed in agentic enterprise systems (e.g. Palantir AIP: session management, retrieval context, and tools for action-taking agents).</p>
</div>
<div class="paragraph">
<p>Reference: <a href="https://www.youtube.com/watch?v=SePXznjZ-1A">"Agentic Operating System for the Enterprise | Palantir&#8217;s AIP Lead Jack Dobson at AIPCon 6"</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_goals">1. Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Let agents <strong>discover</strong> what they can do (tools, schema) without hard-coding endpoint URLs.</p>
</li>
<li>
<p>Let agents <strong>execute</strong> governed actions (query, save, delete) with existing security (realm, permissions, <code>@FunctionalAction</code>).</p>
</li>
<li>
<p><strong>Multi-tenant:</strong> Each tenant (realm) has its own agent configuration and tool instances; tools list and execute are scoped by tenant.</p>
</li>
<li>
<p><strong>Tenant runAs:</strong> Tenant configuration can specify a <code>runAsUserId</code> so tool execution runs under that user&#8217;s security context (PrincipalContext), integrating with the overall security and policy framework.</p>
</li>
<li>
<p>Provide <strong>retrieval context</strong> (ontology, type schemas) so the agent can build valid requests and inject context into the LLM.</p>
</li>
<li>
<p>Support <strong>session/trace</strong> for audit and multi-turn correlation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_gateway_as_the_single_integration_point_crudl">2. Query Gateway as the Single Integration Point (CRUDL)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For <strong>CRUDL</strong> (Create, Read, Update, Delete, List) over entity data, agents and MCP should integrate with the <strong>Query Gateway</strong> only—not across the broader REST API space. The gateway is generic and acts as a single integration point for all Morphia-mapped entity types.</p>
</div>
<div class="paragraph">
<p><strong>Why the gateway is sufficient:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>One set of endpoints</strong> — <code>GET /api/query/rootTypes</code>, <code>POST /api/query/plan</code>, <code>POST /api/query/find</code>, <code>POST /api/query/save</code>, <code>POST /api/query/delete</code>, <code>POST /api/query/deleteMany</code> cover List (rootTypes + find), Read (find), Create/Update (save), and Delete (delete, deleteMany).</p>
</li>
<li>
<p><strong>Type-agnostic</strong> — The gateway accepts a <code>rootType</code> (e.g. <code>Location</code>, <code>Order</code>) and a query or entity body; there is no need for the agent to know or call domain-specific resources (e.g. <code>/orders</code>, <code>/products</code>). The same six operations work for every entity type.</p>
</li>
<li>
<p><strong>Single security surface</strong> — One resource (<code>QueryGatewayResource</code>) with one <code>@FunctionalMapping</code> (area/domain) and method-level <code>@FunctionalAction</code>; permission and realm resolution are consistent for all CRUDL.</p>
</li>
<li>
<p><strong>Simpler agents and bridges</strong> — An AI agent or MCP bridge can implement exactly six tool shapes (rootTypes, plan, find, save, delete, deleteMany) and one base path (<code>/api/query</code>). No need to discover or maintain many REST paths per domain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Implications for agent and MCP design:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Tools</strong> — Agent/MCP tools should map directly to gateway operations (query_rootTypes, query_plan, query_find, query_save, query_delete, query_deleteMany). No separate tools per entity or per domain resource.</p>
</li>
<li>
<p><strong>Schema</strong> — Discovery and schema can be gateway-derived: <code>rootTypes</code> lists available types; optional per-type schema (e.g. <code>GET /api/agent/schema/{rootType}</code>) can be built from the same Morphia metadata the gateway uses.</p>
</li>
<li>
<p><strong>Optional agent layer</strong> — A thin layer (<code>GET /api/agent/tools</code>, <code>POST /api/agent/execute</code>, <code>GET /api/agent/schema</code>) can sit on top of the gateway to provide tool discovery, unified execute, and schema for LLMs; implementation delegates to the gateway and does not duplicate logic.</p>
</li>
<li>
<p><strong>Domain REST resources</strong> — Domain-specific resources (e.g. <code>BaseResource</code>/<code>OntologyAwareResource</code> subclasses with paths like <code>/orders</code>, <code>/shipments</code>) remain for human-driven UIs and workflows. Agents and MCP use the gateway for CRUDL unless a future design explicitly adds agent-only tools that call those resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="rest-crud.html">REST CRUD</a> and <a href="planner-and-query-gateway.html">Planner and Query Gateway</a> for the gateway API and query syntax.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_realistic_scenarios_and_use_cases">3. Realistic Scenarios and Use Cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The agent APIs and MCP bridge are abstract until you see how they are used in practice. Below are concrete scenarios that show <strong>who</strong> uses the system, <strong>what</strong> they ask, and <strong>how</strong> the tools and schema flow fits in.</p>
</div>
<div class="sect2">
<h3 id="_scenario_1_support_agent_looking_up_a_customer_or_order">3.1. Scenario 1: Support agent looking up a customer or order</h3>
<div class="paragraph">
<p><strong>Who:</strong> A support rep in a chat UI backed by an AI (e.g. ChatGPT, Claude, or an in-app bot).
<strong>What they ask:</strong> “What’s the status of order #ORD-8842 for customer <a href="mailto:acme@example.com">acme@example.com</a>?”</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The AI client (or your app) connects to an MCP server that is configured to call your Quantum backend (<code>QUANTUM_BASE_URL</code>, <code>QUANTUM_AUTH_TOKEN</code>).</p>
</li>
<li>
<p>The MCP server exposes six tools. The LLM chooses <code>query_find</code> and calls it with something like: <code>rootType: "Order"</code>, <code>query: "orderNumber:ORD-8842"</code>, <code>realm: "acme-corp"</code>.</p>
</li>
<li>
<p>The bridge sends <code>POST /api/agent/execute</code> with <code>tool: "query_find"</code> and those <code>arguments</code>. The backend runs the query in the correct realm with your existing security and data scoping.</p>
</li>
<li>
<p>The LLM gets back a list of matching orders (or none) and answers: “Order ORD-8842 is Shipped, delivered last Tuesday.”</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> Support doesn’t need to learn your UI or query syntax. They ask in natural language; the agent uses the <strong>same</strong> gateway and permissions as your human-driven app.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_2_analyst_exploring_data_via_natural_language">3.2. Scenario 2: Analyst exploring data via natural language</h3>
<div class="paragraph">
<p><strong>Who:</strong> A business analyst in a BI or “ask your data” product (e.g. Cursor, a Slack bot, or an internal Copilot).
<strong>What they ask:</strong> “Show me all active locations in the West region, and how many orders each had last month.”</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The analyst’s client uses MCP to talk to your bridge. The bridge has already called <code>GET /api/agent/tools</code> and <code>GET /api/agent/schema</code> so the LLM knows there are types like <code>Location</code>, <code>Order</code>, and that it can run <code>query_find</code> with a BIAPI query string.</p>
</li>
<li>
<p>The LLM might first call <code>query_find</code> with <code>rootType: "Location"</code>, <code>query: "region:West &amp;&amp; status:ACTIVE"</code>, <code>realm: "acme-corp"</code>, <code>page: { limit: 50 }</code>.</p>
</li>
<li>
<p>It then calls <code>query_find</code> again for <code>Order</code> with a query that filters by date and optionally by location (if the schema shows how orders link to locations). Your gateway returns rows; the LLM summarizes or charts them.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> The analyst never writes BIAPI or touches <code>/api/query</code> directly. Discovery (tools + schema) is enough for the LLM to build valid <code>rootType</code> and <code>query</code> arguments.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_3_developer_in_cursor_asking_about_live_data_while_coding">3.3. Scenario 3: Developer in Cursor asking about live data while coding</h3>
<div class="paragraph">
<p><strong>Who:</strong> A developer working in Cursor (or another IDE with MCP) on a feature that uses your API.
<strong>What they ask:</strong> “What does a CodeList entity look like in our API?” or “Find me a sample Location so I can see the shape of the response.”</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cursor starts your MCP bridge (e.g. <code>quantum-mcp-bridge</code>) with env pointing at your dev/staging backend.</p>
</li>
<li>
<p>The developer asks in the chat. The LLM uses MCP <code>resources/list</code> (your bridge → <code>GET /api/agent/schema</code>) to see that <code>CodeList</code> and <code>Location</code> exist.</p>
</li>
<li>
<p>It uses <code>resources/read</code> for <code>CodeList</code> (bridge → <code>GET /api/agent/schema/CodeList</code>) to get the JSON Schema–like shape (fields, types).</p>
</li>
<li>
<p>To get a sample, it calls <code>tools/call</code> for <code>query_find</code> with <code>rootType: "Location"</code>, <code>query: "status:ACTIVE"</code>, <code>page: { limit: 1 }</code>. The bridge sends <code>POST /api/agent/execute</code>; the developer sees a real example in the chat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> The developer stays in the IDE and gets schema + live samples without opening Swagger or running <code>curl</code> by hand. The bridge is the only integration point.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_4_tenant_specific_bot_running_as_a_service_user">3.4. Scenario 4: Tenant-specific bot running as a service user</h3>
<div class="paragraph">
<p><strong>Who:</strong> A tenant (e.g. “acme-corp”) has an automated bot that creates or updates records (e.g. syncing from an external system). The bot should run with a fixed service identity for audit and security.</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You configure the tenant: <code>quantum.agent.tenant.acme-corp.runAsUserId=bot-sync@acme-corp</code>, and optionally <code>enabledTools=query_find,query_save</code>, <code>maxFindLimit=100</code>.</p>
</li>
<li>
<p>When the MCP bridge (or any client) calls <code>POST /api/agent/execute</code> with <code>arguments.realm: "acme-corp"</code>, the backend loads tenant config and sees <code>runAsUserId</code>. If your app provides a <code>RunAsPrincipalResolver</code>, the backend runs the gateway call <strong>as</strong> <code>bot-sync@acme-corp</code> (that user’s permissions and data scope).</p>
</li>
<li>
<p>The caller (e.g. an API key for the sync job) only needs permission to call the agent API for that tenant; the actual data access is under the service user. Audit logs can record both caller and runAs user.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> Bots and integrations get a clear, tenant-scoped identity and limits without you building separate “bot-only” APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_5_one_integration_test_as_the_contract_for_the_bridge">3.5. Scenario 5: One integration test as the “contract” for the bridge</h3>
<div class="paragraph">
<p><strong>Who:</strong> You or a bridge implementer.
<strong>What you need:</strong> A single, runnable example that proves the backend supports the full flow a bridge must perform.</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the framework’s integration test: <code>mvn -pl quantum-framework -Dtest=AgentMcpBridgeFlowIT test</code>.</p>
</li>
<li>
<p>The test does, in order: discover tools (<code>GET /api/agent/tools</code>), list schema (<code>GET /api/agent/schema</code>), read schema for one type (<code>GET /api/agent/schema/CodeList</code>), then execute <code>query_rootTypes</code>, <code>query_plan</code>, and <code>query_find</code> via <code>POST /api/agent/execute</code>. That sequence is exactly what an MCP bridge does.</p>
</li>
<li>
<p>If the test passes, the backend contract is satisfied. A TypeScript or Python MCP server that calls the same endpoints with the same shapes will work against this backend.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> The test is both a regression guard and a living specification for “how to use the agent API like an MCP bridge.”</p>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_6_suggesting_regulatory_obligations_for_an_entity_in_a_jurisdiction">3.6. Scenario 6: Suggesting regulatory obligations for an entity in a jurisdiction</h3>
<div class="paragraph">
<p><strong>Who:</strong> A compliance or operations user in the PSA app (e.g. PSM frontend).
<strong>What they need:</strong> Given an entity (e.g. Legal Entity) in a jurisdiction/state, see <strong>suggested</strong> regulatory obligations to track; accept the ones that apply and have them created in the database.</p>
</div>
<div class="paragraph">
<p><strong>Flow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User is on a Jurisdiction or Legal Entity detail page and clicks "Suggest obligations."</p>
</li>
<li>
<p>The frontend calls a <strong>domain</strong> endpoint (e.g. <code>POST /psa/obligations/suggest</code>) with jurisdiction (and optional entity). The backend uses jurisdiction requirements (and optionally an LLM) to produce a list of suggested obligations (details, due date, priority).</p>
</li>
<li>
<p>The UI shows the suggestions; the user selects which to accept and clicks "Accept selected."</p>
</li>
<li>
<p>The frontend calls the Query Gateway <code>POST /api/query/save</code> (rootType Obligation) for each accepted suggestion, persisting new Obligation records.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Why it matters:</strong> The framework&#8217;s agent tools (query_find, schema) can feed context into an LLM or rule engine; the "suggest" capability is implemented as a domain REST endpoint in the app (psa-app), not as a seventh gateway tool. User acceptance keeps humans in the loop before data is written. The full design is PSA-specific and lives in the psa-app repository: <code>doc/design/regulatory-obligations-agent-design.adoc</code> (Regulatory Obligations — Agent-Driven Suggestions and User Acceptance).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_the_query_grammar_into_the_agent_framework">4. Integrating the query grammar into the agent framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Developers and agents need to know <strong>what query string</strong> to use for questions like "retrieve locations in Atlanta" or "get orders with their customer hydrated." The framework exposes the query grammar and <strong>"did you know"</strong> hints so the LLM can both <strong>answer</strong> "what is the query string to retrieve X?" and <strong>suggest</strong> expand/ontology usage.</p>
</div>
<div class="sect2">
<h3 id="_query_hints_endpoint">4.1. Query-hints endpoint</h3>
<div class="paragraph">
<p><strong>Endpoint:</strong> <code>GET /api/agent/query-hints</code></p>
</div>
<div class="paragraph">
<p><strong>Purpose:</strong> Return a structured summary of the BIAPI query grammar, example queries by intent, and "did you know" hints. The MCP bridge or agent can call this once (or on demand) and inject the response into context so the LLM can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Answer: "What is the query string to retrieve locations in Atlanta?" → use <code>exampleQueries</code> (e.g. <code>city:Atlanta</code> or <code>address.city:Atlanta</code> for <code>rootType: Location</code>).</p>
</li>
<li>
<p>Suggest: "Did you know you could use the query gateway with expand on entity Order with relationship customer to get a combined result set?" → use <code>didYouKnow</code> (e.g. expand(customer) &amp;&amp; status:ACTIVE).</p>
</li>
<li>
<p>Use ontology: When the app uses ontology edges (hasEdge, hasEdgeAny, notHasEdge), <code>queryGrammarSummary.ontologyEdges</code> and a did-you-know hint explain that ontology-aware list endpoints filter by relationship; for gateway find, use attribute filters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Response shape:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>queryGrammarSummary</code> — Short doc: <code>syntax</code>, <code>operators</code> (equals, inList, wildcards, andOrNot, etc.), <code>expand</code> (expand(path), AGGREGATION mode), <code>ontologyEdges</code> (hasEdge usage in list/ontology endpoints).</p>
</li>
<li>
<p><code>exampleQueries</code> — List of <code>{ intent, query, rootType, description }</code>. Examples: "Locations in Atlanta" → <code>city:Atlanta</code>, "Orders with customer hydrated" → <code>expand(customer) &amp;&amp; status:ACTIVE</code>, "Locations whose name contains 'Warehouse'" → <code>name:*Warehouse*</code>.</p>
</li>
<li>
<p><code>didYouKnow</code> — List of <code>{ title, body, exampleQuery, rootTypeExample }</code>. Hints such as: "You can use expand(path) to get a combined result set", "You can expand array references with [*]", "Check the plan before running a query with expand", "Ontology relationships can filter list results", "Wildcards and numeric/date prefixes".</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_example_what_is_the_query_string_to_retrieve_locations_in_atlanta">4.2. Example: "What is the query string to retrieve locations in Atlanta?"</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user (or developer in Cursor) asks: "What is the query string to retrieve locations in Atlanta?"</p>
</li>
<li>
<p>The agent has already loaded <code>GET /api/agent/query-hints</code> (or loads it now). From <code>exampleQueries</code> it finds an entry with intent "Locations in Atlanta": <code>query: "city:Atlanta"</code>, <code>rootType: "Location"</code>.</p>
</li>
<li>
<p>The agent answers: "Use <code>city:Atlanta</code> with <code>rootType: Location</code>. If your Location model uses a different field (e.g. address.city), use <code>address.city:Atlanta</code>. Call query_find with arguments: rootType: Location, query: city:Atlanta, page: { limit: 10 }."</p>
</li>
<li>
<p>Optionally the agent can run query_plan or query_find to validate or return a sample.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_example_did_you_know_you_could_use_expand_on_order_with_customer">4.3. Example: "Did you know you could use expand on Order with customer?"</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The agent surfaces a hint from <code>didYouKnow</code>: "You can use expand(path) to get a combined result set. Instead of fetching an order and then its customer in a second call, use expand(customer) in the query string. Example: expand(customer) &amp;&amp; status:ACTIVE for rootType Order."</p>
</li>
<li>
<p>The developer (or another agent) can then use <code>query_find</code> with <code>query: "expand(customer) &amp;&amp; status:ACTIVE"</code> and <code>rootType: "Order"</code> to get orders with nested customer objects. If AGGREGATION execution is enabled, the result set looks like: each order has a <code>customer</code> field populated with the related entity.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_expand_and_ontology_in_the_same_flow">4.4. Expand and ontology in the same flow</h3>
<div class="ulist">
<ul>
<li>
<p><strong>expand(path)</strong> — Use in the <strong>query string</strong> passed to <code>query_find</code> or <code>query_plan</code>. The gateway parses expand(&#8230;&#8203;) and selects AGGREGATION mode; execution (when enabled) returns a combined result set. See <a href="query-expansion.html">Relationship hydration with expand(path)</a> and <a href="planner-and-query-gateway.html">Planner and QueryGateway</a>.</p>
</li>
<li>
<p><strong>Ontology edges (hasEdge, hasEdgeAny, notHasEdge)</strong> — Used by ontology-aware list endpoints and permission rules (ListQueryRewriter). For the <strong>generic</strong> query gateway find, use normal attribute filters. For entities that have ontology list endpoints (e.g. GET /locations/ontology), those endpoints accept ontology constraints; the agent can point the user to the right endpoint or use query_find with attribute filters only.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In short: expose <code>GET /api/agent/query-hints</code> so developers and agents can ask "what query gets X?" and get "did you know you could use expand(&#8230;&#8203;) to get a combined result set that looks like this&#8230;&#8203;".</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_asking_permission_and_policy_questions">5. Asking permission and policy questions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Agents and developers need to answer: <strong>"Can role X perform this action on this Entity?"</strong>, <strong>"If not, why not—which rule caused the denial?"</strong>, <strong>"What rule changes would allow this identity/action/entity combination?"</strong>, and <strong>"What least-privilege rules are needed for this scenario?"</strong>. The framework exposes a <strong>permission check API</strong> and an <strong>evaluate API</strong> so the LLM can answer these questions and suggest minimal policy changes.</p>
</div>
<div class="sect2">
<h3 id="_permission_check_api_single_decision">5.1. Permission check API (single decision)</h3>
<div class="paragraph">
<p><strong>Endpoint:</strong> <code>POST /system/permissions/check</code> (see <a href="permissions.html">Permissions</a>).</p>
</div>
<div class="paragraph">
<p><strong>Purpose:</strong> Determine whether a given identity (userId or role) is allowed to perform a given action in a given area/functionalDomain. The response includes the <strong>winning rule</strong> that determined the outcome, so when the decision is DENY you can answer "why not? — rule R caused it."</p>
</div>
<div class="paragraph">
<p><strong>Request body (CheckRequest):</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>identity</code> (required): userId or role name (e.g. <code>support@acme.com</code> or <code>ADMIN</code>). Roles are resolved from credential, user profile groups, and token.</p>
</li>
<li>
<p><code>area</code>, <code>functionalDomain</code>, <code>action</code> (required for a concrete check): Map from the REST capability you care about. For the Query Gateway: <code>area=integration</code>, <code>functionalDomain=query</code>, <code>action=find|save|delete|listRootTypes|plan|deleteMany</code>. For other resources, use the <code>@FunctionalMapping</code> / <code>@FunctionalAction</code> values (e.g. <code>area=MIGRATION</code>, <code>functionalDomain=INDEXES</code>, <code>action=APPLY_ALL_INDEXES</code>).</p>
</li>
<li>
<p>Optional: <code>realm</code>, <code>tenantId</code>, <code>orgRefName</code>, <code>accountNumber</code>, <code>dataSegment</code>, <code>ownerId</code>, <code>resourceId</code> for DataDomain/body matching.</p>
</li>
<li>
<p>Optional: <code>modelClass</code>, <code>resource</code> (JSON snapshot) for in-memory filter evaluation when the rule has andFilterString/orFilterString.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Response (SecurityCheckResponse):</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>decision</code>: <code>"ALLOW"</code> or <code>"DENY"</code>.</p>
</li>
<li>
<p><code>finalEffect</code>, <code>decisionScope</code>: <code>EXACT</code> | <code>SCOPED</code> | <code>DEFAULT</code>.</p>
</li>
<li>
<p><strong><code>winningRuleName</code></strong>: The rule that determined the outcome. When <code>decision</code> is DENY, this is the rule that caused the denial—answer "if not, why not?" with this name.</p>
</li>
<li>
<p><code>winningRulePriority</code>, <code>winningRuleFinal</code>: Metadata of the winning rule.</p>
</li>
<li>
<p><code>scopedConstraints</code>, <code>filterConstraints</code>, <code>notApplicable</code>: Optional details for SCOPED or filter-related decisions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example: "Can role ABC perform find on Location?"</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Map "find on Location" to the Query Gateway: area=<code>integration</code>, functionalDomain=<code>query</code>, action=<code>find</code>.</p>
</li>
<li>
<p>Call <code>POST /system/permissions/check</code> with body: <code>{"identity": "ABC", "area": "integration", "functionalDomain": "query", "action": "find", "realm": "defaultRealm"}</code>.</p>
</li>
<li>
<p>If response <code>decision</code> is ALLOW → "Yes, role ABC can perform find." If DENY → "No. The rule that caused the denial is: " + response <code>winningRuleName</code> (e.g. <code>default-deny</code> or a specific DENY rule).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_evaluate_api_full_allowdeny_matrix_for_an_identity">5.2. Evaluate API (full allow/deny matrix for an identity)</h3>
<div class="paragraph">
<p><strong>Endpoint:</strong> <code>POST /system/permissions/evaluate</code></p>
</div>
<div class="paragraph">
<p><strong>Purpose:</strong> Get allow/deny decisions for <strong>all</strong> area/functionalDomain/action combinations (or a subset) for a given identity. Use this to compare "what APIs does this scenario need?" with "what does this identity have?" and identify <strong>gaps</strong> for least-privilege.</p>
</div>
<div class="paragraph">
<p><strong>Request (EvaluateRequest):</strong> <code>identity</code> (required), optional <code>realm</code>, <code>roles</code>, DataDomain fields, and optional filters <code>area</code>, <code>functionalDomain</code>, <code>action</code> to narrow.</p>
</div>
<div class="paragraph">
<p><strong>Response (EvaluationResult):</strong> <code>allow</code> and <code>deny</code> (area → domain → list of actions), and <code>decisions[area][domain][action]</code> with <code>effect</code>, <code>decisionScope</code>, <strong><code>rule</code></strong> (winning rule name), <code>priority</code>, <code>finalRule</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_if_not_why_not_identify_the_rule_that_caused_the_denial">5.3. "If not, why not?" — identify the rule that caused the denial</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Call <code>POST /system/permissions/check</code> with the identity and the desired area/functionalDomain/action.</p>
</li>
<li>
<p>If <code>decision</code> is DENY, the response field <strong><code>winningRuleName</code></strong> is the name of the rule that caused the denial (e.g. <code>default-deny</code>, or a DENY rule that matched by priority). Use it to answer "Rule X caused the denial; to allow this combination you would need to add an ALLOW rule with higher priority or narrow the scope of the DENY rule."</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_suggesting_changes_to_rules_to_allow_an_actionentity_pair">5.4. Suggesting changes to rules to allow an action/entity pair</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Check</strong> — Run the check for the identity and the desired (area, functionalDomain, action). If DENY, note <code>winningRuleName</code>.</p>
</li>
<li>
<p><strong>Suggest</strong> — Propose a minimal ALLOW rule: identity (or role), area, functionalDomain, action, optional DataDomain/body, priority (e.g. 500 for standard ALLOWs), and optional andFilterString for data scoping. Example: "Add a rule: name=allow-support-query-find, identity=SUPPORT, area=integration, functionalDomain=query, action=find, effect=ALLOW, priority=500."</p>
</li>
<li>
<p><strong>Authoring</strong> — Actual rule creation/update is done in your rule store (YAML, repo, or admin API). The agent only suggests the rule shape; a human or governance workflow typically applies the change.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_least_privilege_rules_for_a_given_scenario">5.5. Least-privilege rules for a given scenario</h3>
<div class="paragraph">
<p><strong>Goal:</strong> Determine the set of REST APIs (area/functionalDomain/action) needed to complete a scenario, compare to what a given identity is allowed, and suggest the <strong>minimal</strong> ALLOW rules to close gaps.</p>
</div>
<div class="paragraph">
<p><strong>Workflow:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Scenario → required APIs</strong> — From the scenario description, list the operations (e.g. "support user must list locations, then find orders for a customer"). Map each to (area, functionalDomain, action): e.g. list locations → integration/query/listRootTypes and integration/query/find with rootType=Location; find orders → integration/query/find with rootType=Order.</p>
</li>
<li>
<p><strong>Current policies</strong> — Call <code>POST /system/permissions/evaluate</code> for the identity that would execute (e.g. <code>support@acme.com</code> or role <code>SUPPORT</code>). You get allow/deny per (area, domain, action), and per-action <code>rule</code> (winning rule name).</p>
</li>
<li>
<p><strong>Gaps</strong> — Required (area, domain, action) pairs that are DENY or not present in the allow matrix are gaps. Optionally run <code>POST /system/permissions/check</code> per gap to get <code>winningRuleName</code> for each denial.</p>
</li>
<li>
<p><strong>Suggest minimal rules</strong> — For each gap, suggest one ALLOW rule (identity, area, functionalDomain, action, priority). Prefer a single role-based ALLOW with the minimum scope (e.g. only the actions needed) rather than broad wildcards. Example: "Add ALLOW rule for identity=SUPPORT, area=integration, functionalDomain=query, action in [listRootTypes, find], priority=500."</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Example:</strong> Scenario = "Support user lists locations and finds orders by customer ref." Required: (integration, query, listRootTypes), (integration, query, find). Evaluate for identity=SUPPORT → if find is DENY with winningRule=default-deny, suggest: "Add rule allow-support-query-read: identity=SUPPORT, area=integration, functionalDomain=query, action=* (or listRootTypes,find), effect=ALLOW, priority=500."</p>
</div>
</div>
<div class="sect2">
<h3 id="_permission_hints_endpoint_discoverable_by_agents">5.6. Permission hints endpoint (discoverable by agents)</h3>
<div class="paragraph">
<p><strong>Endpoint:</strong> <code>GET /api/agent/permission-hints</code></p>
</div>
<div class="paragraph">
<p><strong>Purpose:</strong> Return a short description of the check and evaluate APIs, how to map "entity" and "action" to area/functionalDomain/action (e.g. Query Gateway mapping), example check requests, and "did you know" hints so the agent can answer permission questions and suggest rule changes. See the Summary Table and MCP Bridge Configuration for the optional call from the bridge.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multi-tenancy-and-tenant-specific-configuration">6. Multi-Tenancy and Tenant-Specific Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Agent integration is <strong>multi-tenant</strong>: each tenant (realm) has its own configuration and tool instances.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Realm scope</strong> — Tools list and execute are scoped by tenant (realm). The effective realm is resolved from the request (e.g. <code>realm</code> query param, <code>arguments.realm</code>, or <code>X-Realm</code> header), then the principal&#8217;s default realm, then configured default.</p>
</li>
<li>
<p><strong>Per-tenant configuration</strong> — Each tenant can have:</p>
</li>
<li>
<p><em>runAsUserId</em> (optional): The userId to use as the security context when executing agent tools for that tenant. When set, the backend runs the gateway under that user&#8217;s PrincipalContext so that permissions and data scoping apply as that user (same pattern as impersonation). This integrates with the overall security and policy framework.</p>
</li>
<li>
<p><em>enabledTools</em> (optional): List of tool names enabled for that tenant; GET /api/agent/tools returns only those tools for the requested realm.</p>
</li>
<li>
<p><em>limits</em> (optional): Per-tenant limits (e.g. max find limit).</p>
</li>
<li>
<p><strong>Caller permission</strong> — The caller must be allowed to use the agent API for the target tenant; the actual execution runs under the tenant&#8217;s runAs user (if configured) or the caller. Audit logs record both caller and runAs user when runAs is used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Secrets (global vs tenant-level):</strong> Application-wide secrets (e.g. JWT signing key, vault connection) are <strong>global</strong> and tenant-independent; they are resolved at startup. Per-tenant secrets (e.g. LLM API keys for hosted providers like OpenAI, Claude, or Gemini) are <strong>tenant-level</strong> and must be resolved per realm at request time—prefer a vault with realm-scoped paths or a tenant config store that references vault keys. See <a href="secrets-and-vault.html">Secrets and Vault Configuration</a> for the two-level model and how to configure HashiCorp Vault or AWS Secrets Manager.</p>
</div>
<div class="paragraph">
<p><strong>Token consumption and allocation:</strong> Per-tenant token pools can be assigned to different sets of APIs and Tools/LLM configurations for usage-based billing. Record LLM usage (by tenant and runAsUserId) and API call usage (by tenant and caller); allocate token types (API_CALL, LLM_REQUEST, LLM_INPUT_TOKENS, LLM_OUTPUT_TOKENS) scoped to API identifiers and/or tool names and LLM config keys. See <a href="usage-and-token-allocation.html">Usage Metering and Token Allocation</a>.</p>
</div>
<div class="paragraph">
<p>See the implementation design (<code>docs/design/AI_AGENT_INTEGRATION_DESIGN.md</code>) for the data model (e.g. AgentTenantConfig), storage options, and runAs resolution.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_apis_to_add_gateway_centric">7. APIs to Add (Gateway-Centric)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_agent_tools_capabilities_discovery">7.1. 1. Agent Tools / Capabilities (Discovery)</h3>
<div class="paragraph">
<p><strong>Purpose:</strong> One endpoint that returns a machine-readable list of "tools" the agent can call—scoped to <strong>Query Gateway operations</strong> so the agent has a single, consistent CRUDL surface.</p>
</div>
<div class="paragraph">
<p><strong>Suggested endpoint:</strong> <code>GET /api/agent/tools</code> (or <code>GET /api/agent/capabilities</code>).</p>
</div>
<div class="paragraph">
<p><strong>Response shape (conceptual):</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>List of tools, one per gateway operation:</p>
</li>
<li>
<p><code>query_rootTypes</code> — list entity types (maps to <code>GET /api/query/rootTypes</code>).</p>
</li>
<li>
<p><code>query_plan</code> — get execution plan for a query (maps to <code>POST /api/query/plan</code>).</p>
</li>
<li>
<p><code>query_find</code> — list/read entities (maps to <code>POST /api/query/find</code>).</p>
</li>
<li>
<p><code>query_count</code> — count entities (maps to <code>POST /api/query/count</code>).</p>
</li>
<li>
<p><code>query_save</code> — create or update an entity (maps to <code>POST /api/query/save</code>).</p>
</li>
<li>
<p><code>query_delete</code> — delete one entity by id (maps to <code>POST /api/query/delete</code>).</p>
</li>
<li>
<p><code>query_deleteMany</code> — delete many by query (maps to <code>POST /api/query/deleteMany</code>).</p>
</li>
<li>
<p><code>query_export</code> — export entities (maps to <code>POST /api/query/export</code>).</p>
</li>
<li>
<p><code>query_import_analyze</code> — analyze CSV for import (maps to <code>POST /api/query/importAnalyze</code>).</p>
</li>
<li>
<p><code>query_import_rows</code> — list import rows (maps to <code>POST /api/query/importRows</code>).</p>
</li>
<li>
<p><code>query_import_commit</code> — commit import (maps to <code>POST /api/query/importCommit</code>).</p>
</li>
<li>
<p><code>query_import_cancel</code> — cancel import (maps to <code>POST /api/query/importCancel</code>).</p>
</li>
<li>
<p>Each tool includes: <code>name</code>, <code>description</code> (for the LLM), <code>parameters</code> (JSON Schema for the request body), and optional <code>area</code>/<code>domain</code>/<code>action</code> for permission alignment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Implementation notes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement by enumerating the six gateway operations (and their request DTOs) from <code>QueryGatewayResource</code>; no need to scan the rest of the REST API space.</p>
</li>
<li>
<p>Only include tools the current principal is allowed to use (e.g. permission for integration/query and the corresponding action).</p>
</li>
<li>
<p>Response format can align with OpenAI function calling or MCP tool definitions so agents and MCP bridges consume it directly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Why:</strong> Agents discover a single CRUDL surface (the gateway) instead of many domain endpoints; aligns with "Tools" in Palantir AIP while keeping integration simple.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_2_schema_ontology_for_agents_retrieval_context">7.2. 2. Schema / Ontology for Agents (Retrieval Context)</h3>
<div class="paragraph">
<p><strong>Purpose:</strong> Expose type schemas (and optional ontology metadata) so the agent can build valid gateway payloads: <code>rootType</code>, <code>query</code>, and entity bodies. All schema is <strong>gateway-derived</strong>—the same types the gateway already uses.</p>
</div>
<div class="paragraph">
<p><strong>Suggested endpoints:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /api/agent/schema</code> — list of entity types; <strong>reuse or wrap <code>GET /api/query/rootTypes</code></strong> so there is a single source of truth. Optionally add per-type field metadata (name, type, required).</p>
</li>
<li>
<p><code>GET /api/agent/schema/{rootType}</code> — JSON Schema (or equivalent) for one root type (fields, types, constraints) so the agent can construct valid <code>find</code>/<code>save</code> bodies. Derive from the same Morphia <code>EntityModel</code> the gateway uses.</p>
</li>
<li>
<p>Optional: <code>GET /api/agent/ontology</code> — high-level ontology summary (entity kinds, relations) for retrieval context; can wrap ontology modules if present, but CRUDL schema stays gateway-centric.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Implementation notes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Schema should be derived from the same Morphia mapping the gateway uses (e.g. <code>EntityModel</code>, <code>@Property</code>, <code>@Reference</code>); no separate schema store.</p>
</li>
<li>
<p>Keep responses concise so they fit in LLM context windows.</p>
</li>
<li>
<p>Agents that only use the gateway need only <code>rootTypes</code> and optional per-type schema; ontology is an optional enrichment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Why:</strong> Single source of truth (gateway + Morphia); agents get valid <code>rootType</code> and field names without integrating with domain-specific REST docs.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_3_unified_agent_action_api">7.3. 3. Unified Agent Action API</h3>
<div class="paragraph">
<p><strong>Purpose:</strong> Single HTTP entry point for the agent to execute a gateway "tool" by name and arguments, so the agent does not need to know individual gateway paths. The implementation <strong>delegates only to the Query Gateway</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Suggested endpoint:</strong> <code>POST /api/agent/execute</code> (or <code>POST /api/agent/tools/execute</code>).</p>
</div>
<div class="paragraph">
<p><strong>Request shape (conceptual):</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tool</code> (or <code>name</code>): one of <code>query_rootTypes</code>, <code>query_plan</code>, <code>query_find</code>, <code>query_count</code>, <code>query_save</code>, <code>query_delete</code>, <code>query_deleteMany</code>, <code>query_export</code>, <code>query_import_*</code>.</p>
</li>
<li>
<p><code>arguments</code> (or <code>params</code>): JSON object matching the gateway request body for that operation (e.g. <code>rootType</code>, <code>query</code>, <code>page</code> for <code>query_find</code>; <code>rootType</code>, <code>entity</code> for <code>query_save</code>).</p>
</li>
<li>
<p>Optional: <code>sessionId</code>, <code>traceId</code> for audit and multi-turn correlation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Response:</strong> Same as the underlying gateway operation (e.g. find result, save result, delete result, or error).</p>
</div>
<div class="paragraph">
<p><strong>Implementation notes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Delegate only to <code>QueryGatewayResource</code></strong> — no branching to domain resources. Map <code>tool</code> to the corresponding gateway method (plan, find, save, delete, deleteMany, rootTypes) and pass <code>arguments</code> as the request body. One integration point, one security surface.</p>
</li>
<li>
<p>Security: same realm resolution, permission checks (<code>@FunctionalAction</code>), and data scoping as the gateway.</p>
</li>
<li>
<p>Optional: validate <code>tool</code> and <code>arguments</code> against the schema from <code>GET /api/agent/tools</code> to return clear errors.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Why:</strong> Agent calls one execute endpoint; the server translates to the appropriate gateway call. No need for the agent (or MCP bridge) to integrate across the REST API space for CRUDL.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_4_session_trace_headers_audit_and_multi_turn">7.4. 4. Session / Trace Headers (Audit and Multi-Turn)</h3>
<div class="paragraph">
<p><strong>Purpose:</strong> Allow agent runtimes to pass a session and/or trace ID so that all requests belonging to one conversation or run can be correlated and audited.</p>
</div>
<div class="paragraph">
<p><strong>Suggested approach:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Request headers: e.g. <code>X-Agent-Session-Id</code>, <code>X-Agent-Trace-Id</code> (or <code>X-Request-Trace-Id</code>).</p>
</li>
<li>
<p>Store or log these in existing audit / request logging so that support and compliance can filter by session or trace.</p>
</li>
<li>
<p>No new endpoint required; only header handling and propagation to logging or audit tables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Implementation notes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security filter or request filter: read headers, put values into <code>SecurityContext</code> or request-scoped context so that any downstream code (e.g. query gateway, permission checks) can attach them to logs or audit events.</p>
</li>
<li>
<p>Optional: include <code>sessionId</code> / <code>traceId</code> in error responses (e.g. in a response header or a small JSON envelope) so the agent runtime can correlate failures.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Why:</strong> Matches multi-turn and session management in agentic APIs; supports debugging and compliance.</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_5_retrieval_context_endpoint_optional_rag_like">7.5. 5. Retrieval Context Endpoint (Optional, RAG-Like)</h3>
<div class="paragraph">
<p><strong>Purpose:</strong> Allow the agent to request a chunk of "context" (e.g. entities or ontology neighborhood) to inject into the LLM. Prefer <strong>gateway-based</strong> context where possible.</p>
</div>
<div class="paragraph">
<p><strong>Suggested endpoint:</strong> <code>POST /api/agent/context</code> (or <code>GET /api/agent/context</code> with query params).</p>
</div>
<div class="paragraph">
<p><strong>Request (conceptual):</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code>: e.g. <code>entity_by_id</code>, <code>search</code>, or optional <code>ontology_edges</code>.</p>
</li>
<li>
<p>Parameters: e.g. <code>rootType</code>, <code>query</code>, <code>limit</code>, <code>id</code> (for entity_by_id); optional <code>entityId</code> for ontology edges.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Response:</strong> Structured context (e.g. list of entities, or ontology edges) in a stable, concise format.</p>
</div>
<div class="paragraph">
<p><strong>Implementation notes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Gateway-first</strong> — For <code>entity_by_id</code> or <code>search</code>, implement by calling the gateway: e.g. <code>POST /api/query/find</code> with <code>rootType</code>, <code>query</code> (e.g. <code>_id:&#8230;&#8203;</code> for by-id), and a small <code>limit</code>. No need to call domain-specific list endpoints.</p>
</li>
<li>
<p>Optional: for <code>ontology_edges</code>, wrap <code>OntologyAwareResource</code>/ontology services if the app uses them; otherwise omit or keep context to gateway find results.</p>
</li>
<li>
<p>Limit size (e.g. <code>limit</code> cap) to avoid overwhelming the LLM context window.</p>
</li>
<li>
<p>Enforce same security and realm as the gateway.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Why:</strong> Retrieval context stays aligned with the single integration point (gateway find); optional ontology enriches when available.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mcp_integration_cursor_chatgpt_gemini">8. MCP Integration (Cursor, ChatGPT, Gemini)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://modelcontextprotocol.io">Model Context Protocol (MCP)</a> is an open standard that lets AI clients (Cursor, Claude Desktop, ChatGPT, Gemini, etc.) discover and call <strong>tools</strong> and read <strong>resources</strong> from a server. Integrating MCP with the <strong>Query Gateway as the single integration point</strong> means the MCP bridge talks only to the gateway (and optional thin agent layer) for CRUDL—no integration across the rest of the REST API space.</p>
</div>
<div class="sect2">
<h3 id="_how_mcp_maps_to_the_framework_gateway_centric">8.1. How MCP Maps to the Framework (Gateway-Centric)</h3>
<div class="paragraph">
<p>| MCP concept | Purpose | Framework equivalent (native or bridge) |
|-------------|---------|------------------------------------------------|
| <strong>Tools</strong> | Actions the LLM can call (<code>tools/list</code>, <code>tools/call</code>) | 12+ tools: <code>query_rootTypes</code>, <code>query_plan</code>, <code>query_find</code>, <code>query_save</code>, <code>query_delete</code>, <code>query_deleteMany</code>, <code>query_count</code>, <code>query_export</code>, <code>query_import_*</code> → <code>QueryGatewayResource</code> (or <code>POST /api/agent/execute</code>) |
| <strong>Resources</strong> | Read-only data for context (<code>resources/list</code>, <code>resources/read</code>) | <code>quantum://schema</code>, <code>quantum://query-hints</code>, <code>quantum://permission-hints</code>. |
| <strong>Prompts</strong> (optional) | Parameterized prompt templates | Domain prompts that invoke the six gateway tools (e.g. "List active locations", "Find orders for customer X") |</p>
</div>
<div class="paragraph">
<p>MCP uses JSON-RPC over stdio (local) or HTTP (SSE / Streamable HTTP) for remote servers. Cursor and Claude support both; ChatGPT and Gemini can use remote MCP when they support the protocol.</p>
</div>
</div>
<div class="sect2">
<h3 id="_two_integration_approaches">8.2. Two Integration Approaches</h3>
<div class="sect3">
<h4 id="_option_a_native_mcp_recommended">8.2.1. Option A: Native MCP (Recommended)</h4>
<div class="paragraph">
<p>Use the <code>quantum-mcp-server</code> module to expose the Query Gateway as a set of MCP tools and resources directly from your backend. This provides the most integrated experience and reuses your existing security, realm, and data-scoping logic. See <a href="mcp-server-and-client.html">MCP Server and Client</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_option_b_mcp_bridge_server">8.2.2. Option B: MCP Bridge Server</h4>
<div class="paragraph">
<p>Run a <strong>standalone MCP server</strong> (e.g. in Node.js or Python) that talks to your Quantum REST APIs. This is useful if you cannot use the Java-based MCP module or need to consolidate multiple backend services into one MCP surface.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_configuration">8.3. Client Configuration</h3>
<div class="paragraph">
<p><strong>Cursor</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Project-level: create <code>.cursor/mcp.json</code> in the repo.</p>
</li>
<li>
<p>For a <strong>local</strong> bridge (stdio): point to the bridge command (e.g. <code>npx</code> / <code>node</code> or <code>uv run</code> for Python).</p>
</li>
<li>
<p>For a <strong>remote</strong> bridge (SSE): use the SSE transport and the bridge’s URL (e.g. <code><a href="https://mcp-bridge.example.com/sse" class="bare">https://mcp-bridge.example.com/sse</a></code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example (local bridge, stdio):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">mcpServers</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">quantum</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">command</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">node</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">args</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/quantum-mcp-bridge/build/index.js</span><span class="delimiter">&quot;</span></span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">env</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">QUANTUM_BASE_URL</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">https://your-api.example.com</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">QUANTUM_AUTH_TOKEN</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;bearer-or-api-key&gt;</span><span class="delimiter">&quot;</span></span>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Claude (Desktop)</strong> — Same idea: add the bridge under <code>mcpServers</code> in the Claude Desktop config (e.g. <code>~/Library/Application Support/Claude/claude_desktop_config.json</code> on macOS), with <code>command</code>/<code>args</code> for stdio or use Custom Connector for a remote URL.</p>
</div>
<div class="paragraph">
<p><strong>Claude (browser)</strong> — Use Custom Connectors: add the remote MCP server URL (your bridge’s SSE endpoint) and complete authentication as required by your bridge (e.g. API key or OAuth).</p>
</div>
<div class="paragraph">
<p><strong>ChatGPT / Gemini</strong> — When they support MCP, use the remote (SSE) URL of your bridge and any documented auth (header or OAuth). No changes needed on the Quantum backend.</p>
</div>
</div>
<div class="sect2">
<h3 id="_auth_and_security_bridge">8.4. Auth and Security (Bridge)</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Token storage:</strong> The bridge should receive the backend auth token via environment variable (or a secure config), not hardcoded. Cursor/Claude inject env when starting the bridge (e.g. <code>QUANTUM_AUTH_TOKEN</code>).</p>
</li>
<li>
<p><strong>Backend unchanged:</strong> Realm resolution, permission checks, and data scoping remain in the framework; the bridge is a transparent HTTP client.</p>
</li>
<li>
<p><strong>Optional:</strong> Support <code>X-Realm</code> (or equivalent) in tool arguments so the user/agent can scope requests to a tenant when allowed by the principal.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_mcp_bridge_configuration">8.5. MCP Bridge Configuration</h3>
<div class="paragraph">
<p>This section defines the <strong>configuration contract</strong> between an MCP bridge and the Quantum backend. A bridge that implements this contract can discover tools, read schema, and execute gateway operations via the agent REST APIs. The framework provides integration tests (e.g. <code>AgentMcpBridgeFlowIT</code>) that exercise this flow as a living example.</p>
</div>
<div class="sect3">
<h4 id="_environment_variables_bridge">8.5.1. Environment Variables (Bridge)</h4>
<div class="paragraph">
<p>The bridge must be configured with at least the backend base URL and an auth token. All HTTP requests from the bridge to the backend use these values.</p>
</div>
<div class="paragraph">
<p>| Variable | Required | Description |
|----------|----------|-------------|
| <code>QUANTUM_BASE_URL</code> | Yes | Base URL of the Quantum REST API (e.g. <code><a href="https://your-app.example.com" class="bare">https://your-app.example.com</a></code>). No trailing slash. |
| <code>QUANTUM_AUTH_TOKEN</code> | Yes | Bearer token or API key for authentication. Sent as <code>Authorization: Bearer &lt;token&gt;</code> (or as required by the app). |
| <code>QUANTUM_REALM</code> | No | Default realm for tool calls when the user/agent does not pass <code>realm</code> in arguments. When set, the bridge can add <code>realm</code> to every execute payload. |</p>
</div>
</div>
<div class="sect3">
<h4 id="_http_endpoints_the_bridge_calls">8.5.2. HTTP Endpoints the Bridge Calls</h4>
<div class="paragraph">
<p>The bridge implements MCP <code>tools/list</code>, <code>tools/call</code>, and optionally <code>resources/list</code> / <code>resources/read</code> by calling the following agent endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MCP <code>tools/list</code></strong> → <code>GET {baseUrl}/api/agent/tools?realm={realm}</code>
Returns <code>{ "tools": [ { "name", "description", "parameters", "area", "domain", "action" }, &#8230;&#8203; ], "count" }</code>.
Use optional <code>realm</code> when <code>QUANTUM_REALM</code> is set or the client requests a tenant.</p>
</li>
<li>
<p><strong>MCP <code>tools/call</code></strong> → <code>POST {baseUrl}/api/agent/execute</code>
Body: <code>{ "tool": "&lt;name&gt;", "arguments": { "rootType"?, "query"?, "entity"?, "id"?, "realm"?, "page"?, "sort"?, &#8230;&#8203; }, "sessionId"?, "traceId"? }</code>.
Response: same as the underlying gateway operation (e.g. find returns a collection, save returns save response).
The bridge forwards the MCP tool name (e.g. <code>query_find</code>) and the MCP arguments map as <code>arguments</code>.</p>
</li>
<li>
<p><strong>MCP <code>resources/list</code></strong> (optional) → <code>GET {baseUrl}/api/agent/schema</code>
Returns <code>{ "rootTypes": [ { "className", "simpleName", "collectionName" }, &#8230;&#8203; ], "count" }</code>.
The bridge can expose these as MCP resources (e.g. <code>quantum://schema</code> or one resource per root type).</p>
</li>
<li>
<p><strong>MCP <code>resources/read</code></strong> for a type (optional) → <code>GET {baseUrl}/api/agent/schema/{rootType}</code>
Returns JSON Schema-like <code>{ "type", "title", "properties", &#8230;&#8203; }</code> for the given root type (simple name or FQCN).</p>
</li>
<li>
<p><strong>Query hints</strong> (optional) → <code>GET {baseUrl}/api/agent/query-hints</code> — Returns query grammar summary, example queries (e.g. "Locations in Atlanta" → <code>city:Atlanta</code>), and "did you know" hints (e.g. expand(customer) for combined result sets). Inject into LLM context so the agent can answer "what is the query string to retrieve X?" and suggest expand/ontology usage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All requests must include the auth header (e.g. <code>Authorization: Bearer &lt;QUANTUM_AUTH_TOKEN&gt;</code>). Optional headers for audit: <code>X-Agent-Session-Id</code>, <code>X-Agent-Trace-Id</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requestresponse_examples_bridge_backend">8.5.3. Request/Response Examples (Bridge → Backend)</h4>
<div class="paragraph">
<p><strong>Discover tools (MCP tools/list):</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>GET /api/agent/tools?realm=my-tenant
Authorization: Bearer &lt;token&gt;

Response 200:
{
  "tools": [
    { "name": "query_rootTypes", "description": "...", "parameters": { "type": "object", "properties": {}, "required": [] }, "area": "integration", "domain": "query", "action": "listRootTypes" },
    { "name": "query_find", "description": "...", "parameters": { ... }, "area": "integration", "domain": "query", "action": "find" },
    ...
  ],
  "count": 6
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Execute a tool (MCP tools/call for query_find):</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>POST /api/agent/execute
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "tool": "query_find",
  "arguments": {
    "rootType": "CodeList",
    "query": "refName:ACTIVE",
    "realm": "my-tenant",
    "page": { "limit": 10, "skip": 0 }
  },
  "sessionId": "sess-123",
  "traceId": "trace-456"
}

Response 200: (same as POST /api/query/find; Collection envelope)
{
  "rows": [ ... ],
  "offset": 0,
  "limit": 10,
  "filter": "refName:ACTIVE",
  "rowCount": 0
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>List schema (MCP resources/list):</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>GET /api/agent/schema
Authorization: Bearer &lt;token&gt;

Response 200:
{
  "rootTypes": [ { "className": "com.example.CodeList", "simpleName": "CodeList", "collectionName": "codeLists" }, ... ],
  "count": 12
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Read schema for one type (MCP resources/read):</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>GET /api/agent/schema/CodeList
Authorization: Bearer &lt;token&gt;

Response 200:
{
  "type": "object",
  "title": "CodeList",
  "properties": { "refName": { "type": "string" }, "name": { "type": "string" }, ... }
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cursor_configuration_example">8.5.4. Cursor Configuration Example</h4>
<div class="paragraph">
<p>Create <code>.cursor/mcp.json</code> (or use Cursor MCP settings) to point at your Quantum MCP bridge. The bridge is a separate process (Node/Python) that reads <code>QUANTUM_BASE_URL</code> and <code>QUANTUM_AUTH_TOKEN</code> from the environment.</p>
</div>
<div class="paragraph">
<p><strong>Local bridge (stdio):</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
  "mcpServers": {
    "quantum": {
      "command": "node",
      "args": ["/path/to/quantum-mcp-bridge/dist/index.js"],
      "env": {
        "QUANTUM_BASE_URL": "https://api.mycompany.com",
        "QUANTUM_AUTH_TOKEN": "your-bearer-token",
        "QUANTUM_REALM": "defaultRealm"
      }
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Remote bridge (SSE):</strong> If the bridge is deployed as an HTTP MCP server (e.g. <code><a href="https://mcp-bridge.mycompany.com/sse" class="bare">https://mcp-bridge.mycompany.com/sse</a></code>), use the SSE transport and omit <code>command</code>/<code>args</code>; configure the remote URL and auth as required by Cursor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_claude_desktop_configuration_example">8.5.5. Claude Desktop Configuration Example</h4>
<div class="paragraph">
<p>Edit the Claude Desktop config (e.g. <code>~/Library/Application Support/Claude/claude_desktop_config.json</code> on macOS):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
  "mcpServers": {
    "quantum": {
      "command": "node",
      "args": ["/path/to/quantum-mcp-bridge/dist/index.js"],
      "env": {
        "QUANTUM_BASE_URL": "https://api.mycompany.com",
        "QUANTUM_AUTH_TOKEN": "your-bearer-token",
        "QUANTUM_REALM": "defaultRealm"
      }
    }
  }
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_backend_configuration_optional">8.5.6. Backend Configuration (Optional)</h4>
<div class="paragraph">
<p>When the backend is used by an MCP bridge with tenant-specific agent config, set per-realm options in <code>application.properties</code> (or equivalent):</p>
</div>
<div class="literalblock">
<div class="content">
<pre># Per-tenant agent config (optional)
quantum.agent.tenant.defaultRealm.runAsUserId=agent-service-user
quantum.agent.tenant.defaultRealm.enabledTools=query_rootTypes,query_plan,query_find,query_save
quantum.agent.tenant.defaultRealm.maxFindLimit=100</pre>
</div>
</div>
<div class="paragraph">
<p>The bridge does not need to know these values; the backend applies them when handling <code>/api/agent/tools</code> and <code>/api/agent/execute</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integration_test_as_example">8.5.7. Integration Test as Example</h4>
<div class="paragraph">
<p>The framework includes an integration test that <strong>simulates the MCP bridge flow</strong> end-to-end: discover tools, list schema, read schema for a type, then execute <code>query_rootTypes</code>, <code>query_plan</code>, and <code>query_find</code>. This test serves as a <strong>living example</strong> of the exact HTTP sequence a bridge must perform. See <code>AgentMcpBridgeFlowIT</code> in the <code>quantum-framework</code> module. Run it with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mvn -pl quantum-framework -Dtest=AgentMcpBridgeFlowIT test</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_order_for_mcp">8.6. Implementation Order for MCP</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement the <strong>agent REST APIs</strong> (tools discovery, schema, optional execute) as in the Summary Table.</p>
</li>
<li>
<p>Build and document a <strong>bridge</strong> (Option A): one MCP server that implements tools (and optionally resources) by calling those REST APIs; document base URL and auth env vars.</p>
</li>
<li>
<p>Add <strong>Cursor/Claude config examples</strong> to the framework docs (e.g. in this guide or a dedicated MCP section).</p>
</li>
<li>
<p>Optionally add <strong>native MCP</strong> in the backend (Option B) later for a single-deployment story.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_mcp_references">8.7. MCP References</h3>
<div class="ulist">
<ul>
<li>
<p>Specification: <a href="https://modelcontextprotocol.io/specification">Model Context Protocol</a></p>
</li>
<li>
<p>Server concepts (tools, resources, prompts): <a href="https://modelcontextprotocol.io/docs/learn/server-concepts">Understanding MCP servers</a></p>
</li>
<li>
<p>Build a server: <a href="https://modelcontextprotocol.io/docs/develop/build-server">Build an MCP server</a></p>
</li>
<li>
<p>SDKs: <a href="https://modelcontextprotocol.io/docs/sdk">MCP SDKs</a> (TypeScript, Python, Java, etc.)</p>
</li>
<li>
<p>Remote servers: <a href="https://modelcontextprotocol.io/docs/develop/connect-remote-servers">Connect to remote MCP servers</a></p>
</li>
<li>
<p>Cursor MCP: <a href="https://cursor.com/docs/context/mcp">Cursor – Model Context Protocol</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary_table">9. Summary Table</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>CRUDL is fully covered by the Query Gateway</strong> (<code>/api/query</code>). The agent APIs below are a thin discovery/schema/execute layer on top of the gateway; they do not introduce a second CRUDL surface or require integration across domain REST resources.</p>
</div>
<div class="paragraph">
<p>| API | Method | Purpose |
|-----|--------|--------|
| <code>/api/query/<strong></code> (existing) | GET/POST | <strong>Single integration point:</strong> rootTypes, plan, find, count, save, delete, deleteMany, export, import for all entity types. |
| <code>/api/agent/tools</code> | GET | Discover the 12+ gateway tools (names, descriptions, parameters); permission-filtered. |
| <code>/api/agent/schema</code> | GET | List entity types (wrap or reuse <code>GET /api/query/rootTypes</code>) and optional field metadata. |
| <code>/api/agent/schema/{rootType}</code> | GET | JSON Schema for one root type (gateway-derived Morphia metadata). |
| <code>/api/agent/query-hints</code> | GET | Query grammar summary, example queries by intent, and "did you know" hints (expand, ontology). |
| <code>/api/agent/permission-hints</code> | GET | Permission check/evaluate API summary, area/domain/action mapping. |
| <code>/api/agent/ontology</code> | GET | Optional: ontology summary for retrieval context. |
| <code>/api/agent/execute</code> | POST | Execute one of the gateway tools by name + arguments (delegate to <code>QueryGatewayResource</code>). |
| <code>/api/agent/config/</strong></code> | GET/POST/DELETE | CRUD for Agent configuration (LLM reference, prompt context, enabled tools). Realm-scoped. See <a href="mcp-server-and-client.html#agent-config-api">Agent Configuration API</a>. |
| <code>/api/agent/context</code> | POST/GET | Optional: retrieval context (gateway find or optional ontology). |
| (headers) | - | <code>X-Agent-Session-Id</code>, <code>X-Agent-Trace-Id</code> for audit and multi-turn. |</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_order">10. Implementation Order</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Treat the gateway as the single CRUDL integration point</strong> — agents and MCP use only <code>/api/query</code> (and optional agent layer) for CRUDL; no per-domain REST integration.</p>
</li>
<li>
<p><strong>Tools discovery</strong> (<code>GET /api/agent/tools</code>) — enumerate the six gateway operations; enables agents to know what they can call.</p>
</li>
<li>
<p><strong>Schema for agents</strong> (<code>GET /api/agent/schema</code>, <code>GET /api/agent/schema/{rootType}</code>) — gateway-derived from <code>rootTypes</code> and Morphia metadata.</p>
</li>
<li>
<p><strong>Session/trace headers</strong> — low effort, high value for audit and debugging.</p>
</li>
<li>
<p><strong>Unified execute</strong> (<code>POST /api/agent/execute</code>) — delegate only to <code>QueryGatewayResource</code>.</p>
</li>
<li>
<p><strong>Agent configuration</strong> (<code>/api/agent/config/*</code>) — CRUD for Agent entities (LLM ref, prompt context, tool filter); realm-scoped.</p>
</li>
<li>
<p><strong>Retrieval context</strong> (<code>POST /api/agent/context</code>) and <strong>ontology summary</strong> — optional; prefer gateway find for context.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security_and_governance">11. Security and Governance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>All new agent endpoints delegate to the <strong>Query Gateway</strong> for CRUDL; they use the same security filter, realm resolution, and data scoping as <code>QueryGatewayResource</code>.</p>
</li>
<li>
<p>Tools discovery lists only the six gateway tools and only if the current principal is allowed (e.g. integration/query area and corresponding action).</p>
</li>
<li>
<p>Unified execute must not bypass <code>@FunctionalAction</code> or permission checks; it calls the same gateway logic—no delegation to domain resources for CRUDL.</p>
</li>
<li>
<p>Prefer existing patterns: <code>PrincipalContext</code>, <code>SecurityContext</code>, and optional <code>X-Realm</code> for tenant isolation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">12. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Architecture design:</strong> <code>docs/design/AI_AGENT_TOOL_REFACTOR_CLARIFICATION.md</code> in the framework repo — current agent/tool architecture, data flow, key files, and what was removed.</p>
</li>
<li>
<p><strong>Implementation design:</strong> <code>docs/design/AI_AGENT_INTEGRATION_DESIGN.md</code> in the framework repo — API specs, DTOs, backend classes, MCP bridge, implementation phases, and testing strategy.</p>
</li>
<li>
<p>Palantir Foundry – Use AIP Agents through Foundry APIs: <a href="https://palantir.com/docs/foundry/agent-studio/foundry-apis/" class="bare">https://palantir.com/docs/foundry/agent-studio/foundry-apis/</a></p>
</li>
<li>
<p>AIP Agent Studio overview: <a href="https://www.palantir.com/docs/foundry/agent-studio/overview" class="bare">https://www.palantir.com/docs/foundry/agent-studio/overview</a></p>
</li>
<li>
<p>Video: <a href="https://www.youtube.com/watch?v=SePXznjZ-1A">"Agentic Operating System for the Enterprise | Palantir&#8217;s AIP Lead Jack Dobson at AIPCon 6"</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.3.0-SNAPSHOT<br>
Last updated 2026-02-23 15:55:05 -0500
</div>
</div>
</body>
</html>