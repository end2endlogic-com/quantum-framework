<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Modeling with Functional Areas, Domains, and Actions</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#modeling">1. Modeling with Functional Areas, Domains, and Actions</a>
<ul class="sectlevel3">
<li><a href="#_prefer_annotations_for_functional_mapping_recommended">1.1. Prefer Annotations for Functional Mapping (recommended)</a></li>
<li><a href="#_datadomain_on_models">1.2. DataDomain on Models</a></li>
<li><a href="#_persistence_repositories">1.3. Persistence Repositories</a></li>
<li><a href="#_exposing_rest_resources">1.4. Exposing REST Resources</a></li>
<li><a href="#_lombok_in_models">1.5. Lombok in Models</a></li>
<li><a href="#_validation_with_jakarta_bean_validation">1.6. Validation with Jakarta Bean Validation</a></li>
<li><a href="#_jackson_vs_jakarta_validation_annotations">1.7. Jackson vs Jakarta Validation Annotations</a></li>
</ul>
</li>
<li><a href="#_jackson_objectmapper_in_quarkus_and_in_quantum">2. Jackson ObjectMapper in Quarkus and in Quantum</a></li>
<li><a href="#_validation_lifecycle_and_morphia_interceptors">3. Validation Lifecycle and Morphia Interceptors</a></li>
<li><a href="#_functional_areadomain_in_rulecontext_permission_language">4. Functional Area/Domain in RuleContext Permission Language</a></li>
<li><a href="#_stategraphs_on_models">5. StateGraphs on Models</a></li>
<li><a href="#_state_graph_dot">6. State Graph (DOT)</a></li>
<li><a href="#_completiontasks_and_completiontaskgroups">7. CompletionTasks and CompletionTaskGroups</a></li>
<li><a href="#_references_and_entityreference">8. References and EntityReference</a></li>
<li><a href="#_tracking_references_with_trackreferences_and_delete_semantics">9. Tracking References with @TrackReferences and Delete Semantics</a>
<ul class="sectlevel2">
<li><a href="#ontologies-in-quantum">9.1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</a>
<ul class="sectlevel3">
<li><a href="#_what_is_an_ontology">9.1.1. What is an Ontology?</a></li>
<li><a href="#_ontology_vs_object_model">9.1.2. Ontology vs. Object Model</a></li>
<li><a href="#_why_prefer_ontology_driven_relationships_over_referenceentityreference">9.1.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</a></li>
<li><a href="#_how_quantum_supports_ontologies">9.1.4. How Quantum supports Ontologies</a></li>
<li><a href="#_modeling_guidance_from_object_fields_to_predicates">9.1.5. Modeling guidance: from object fields to predicates</a></li>
<li><a href="#_querying_with_ontology_edges_vs_direct_references">9.1.6. Querying with ontology edges vs direct references</a></li>
<li><a href="#_migration_from_reference_to_ontology_edges">9.1.7. Migration: from @Reference to ontology edges</a></li>
<li><a href="#_performance_and_operational_notes">9.1.8. Performance and operational notes</a></li>
<li><a href="#_how_this_integrates_with_functional_areasdomains">9.1.9. How this integrates with Functional Areas/Domains</a></li>
<li><a href="#_summary">9.1.10. Summary</a></li>
<li><a href="#ontology-ecommerce-example">9.1.11. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</a></li>
</ul>
</li>
<li><a href="#ontology-integration-morphia-permissions">9.2. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</a>
<ul class="sectlevel3">
<li><a href="#_big_picture_where_ontology_fits">9.2.1. Big picture: where ontology fits</a></li>
<li><a href="#_rule_language_add_hasedge">9.2.2. Rule language: add hasEdge()</a></li>
<li><a href="#_passing_tenantid_correctly">9.2.3. Passing tenantId correctly</a></li>
<li><a href="#_morphia_repository_integration_patterns">9.2.4. Morphia repository integration patterns</a></li>
<li><a href="#_where_to_hook_materialization">9.2.5. Where to hook materialization</a></li>
<li><a href="#_security_and_multi_tenant_considerations">9.2.6. Security and multi-tenant considerations</a></li>
<li><a href="#_developer_workflow_and_dx_checklist">9.2.7. Developer workflow and DX checklist</a></li>
<li><a href="#_cookbook_end_to_end_example_with_orders_org">9.2.8. Cookbook: end-to-end example with Orders + Org</a></li>
<li><a href="#_migration_notes_for_teams_using_reference">9.2.9. Migration notes for teams using @Reference</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="modeling">1. Modeling with Functional Areas, Domains, and Actions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quantum organizes your system around three core constructs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional Area: A broad capability area (e.g., Identity, Catalog, Orders, Collaboration).</p>
</li>
<li>
<p>Functional Domain: A cohesive sub-area within an area (e.g., in Collaboration: Partners, Shipments, Tasks).</p>
</li>
<li>
<p>Actions: The set of operations applicable to a domain (CREATE, UPDATE, VIEW, DELETE, ARCHIVE, plus domain-specific actions).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These constructs allow:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fine-grained sharing: Point specific functional areas to shared databases while others remain strictly segmented.</p>
</li>
<li>
<p>Policy composition: Apply RuleContext decisions at the level of area/domain/action.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_prefer_annotations_for_functional_mapping_recommended">1.1. Prefer Annotations for Functional Mapping (recommended)</h4>
<div class="paragraph">
<p>Starting with this version, you should use annotations to declare a model or resource&#8217;s Functional Area/Domain and the Action being performed. The legacy bmFunctionalArea() and bmFunctionalDomain() methods are still supported for backward compatibility in this release, but they will be phased out soon.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Class-level mapping: use @FunctionalMapping(area = "&lt;area&gt;", domain = "&lt;domain&gt;") on your model or resource class.</p>
</li>
<li>
<p>Method-level action: use @FunctionalAction("&lt;ACTION&gt;") on your JAX-RS resource methods when the action is not implied by the HTTP verb.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example: model annotated with FunctionalMapping</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok</span>.*;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalMapping</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="annotation">@FunctionalMapping</span>(area = <span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span>, domain = <span class="string"><span class="delimiter">&quot;</span><span class="content">product</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="comment">// No need to override bmFunctionalArea/bmFunctionalDomain when using @FunctionalMapping</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: resource method annotated with FunctionalAction</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">jakarta.ws.rs</span>.*;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.core.MediaType</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.annotations.FunctionalAction</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
<span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> {

    <span class="comment">// Action will default from HTTP verb (POST -&gt; CREATE), but you can be explicit:</span>
    <span class="annotation">@POST</span>
    <span class="annotation">@FunctionalAction</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Product create(Product payload) { <span class="comment">/* ... */</span> <span class="keyword">return</span> payload; }

    <span class="comment">// GET will infer VIEW automatically when building the ResourceContext</span>
    <span class="annotation">@GET</span>
    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Product get(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) { <span class="comment">/* ... */</span> <span class="keyword">return</span> <span class="keyword">new</span> Product(); }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How the framework uses these annotations</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityFilter: If the matched resource class has @FunctionalMapping, it uses area/domain from the annotation. If the method has @FunctionalAction, it uses that value; otherwise, it infers the action from the HTTP method (GET=VIEW, POST=CREATE, PUT/PATCH=UPDATE, DELETE=DELETE). If annotations are absent, it falls back to the existing path- and convention-based logic.</p>
</li>
<li>
<p>MorphiaRepo.fillUIActions: If the model class has @FunctionalMapping, its area/domain are used to resolve allowed UI actions; otherwise, it falls back to the legacy bmFunctionalArea()/bmFunctionalDomain() methods.</p>
</li>
<li>
<p>PermissionResource: When listing functional domains, it prefers @FunctionalMapping on entity classes and falls back to bmFunctionalArea()/bmFunctionalDomain() when missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Migration notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preferred: add @FunctionalMapping to each model class (or resource class) and remove the bmFunctionalArea/bmFunctionalDomain overrides.</p>
</li>
<li>
<p>Transitional: you can keep the legacy methods; they will be used only if the annotation is not present.</p>
</li>
<li>
<p>Future: bmFunctionalArea and bmFunctionalDomain will be removed in a future release; plan to migrate now.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also: <a href="security-annotations.html#security-annotations">Security Annotations: FunctionalMapping and FunctionalAction</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_datadomain_on_models">1.2. DataDomain on Models</h4>
<div class="paragraph">
<p>All persisted models carry DataDomain (tenantId, orgRefName, ownerId, etc.) for rule-based filtering and cross-tenant sharing.</p>
</div>
<div class="paragraph">
<p>Example model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;
<span class="keyword">import</span> <span class="include">lombok.Data</span>;
<span class="keyword">import</span> <span class="include">lombok.EqualsAndHashCode</span>;
<span class="keyword">import</span> <span class="include">lombok.NoArgsConstructor</span>;
<span class="keyword">import</span> <span class="include">lombok.experimental.SuperBuilder</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.base.BaseModel</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
    <span class="directive">private</span> <span class="predefined-type">String</span> sku;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog</span><span class="delimiter">&quot;</span></span>; }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Product</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_persistence_repositories">1.3. Persistence Repositories</h4>
<div class="paragraph">
<p>Define a repository to persist and query your model. With Morphia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.model.persistent.morphia.MorphiaRepo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ProductRepo</span> <span class="directive">extends</span> MorphiaRepo&lt;Product&gt; {
    <span class="comment">// custom queries can be added here</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exposing_rest_resources">1.4. Exposing REST Resources</h4>
<div class="paragraph">
<p>Expose consistent CRUD endpoints by extending BaseResource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.framework.rest.resources.BaseResource</span>;
<span class="keyword">import</span> <span class="include">jakarta.ws.rs.Path</span>;

<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/products</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductResource</span> <span class="directive">extends</span> BaseResource&lt;Product, ProductRepo&gt; {
    <span class="comment">// Inherit find, get, list, save, update, delete endpoints</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this minimal setup, you get standard REST APIs guarded by RuleContext/DataDomain and enriched with UIAction metadata.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lombok_in_models">1.5. Lombok in Models</h4>
<div class="paragraph">
<p>Lombok reduces boilerplate in Quantum models and supports inheritance-friendly builders.</p>
</div>
<div class="paragraph">
<p>Common annotations you will see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Data: Generates getters, setters, toString, equals, and hashCode.</p>
</li>
<li>
<p>@NoArgsConstructor: Required by frameworks that need a no-arg constructor (e.g., Jackson, Morphia).</p>
</li>
<li>
<p>@EqualsAndHashCode(callSuper = true): Includes superclass fields in equality and hash.</p>
</li>
<li>
<p>@SuperBuilder: Provides a builder that cooperates with parent classes (useful for BaseModel subclasses).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="annotation">@NoArgsConstructor</span>
<span class="annotation">@SuperBuilder</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Product</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> sku;
  <span class="directive">private</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- Prefer @SuperBuilder over @Builder when extending BaseModel/UnversionedBaseModel.
- Keep equals/hashCode stable for collections and caches; include callSuper when needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_validation_with_jakarta_bean_validation">1.6. Validation with Jakarta Bean Validation</h4>
<div class="paragraph">
<p>Quantum uses Jakarta Bean Validation to enforce invariants on models at persist time (and optionally at REST boundaries).</p>
</div>
<div class="paragraph">
<p>Typical annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Size(min=3): String/collection length constraints.</p>
</li>
<li>
<p>@Valid: Cascade validation to nested objects (e.g., DataDomain on models).</p>
</li>
<li>
<p>@NotNull, @Email, @Pattern, etc., as needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where validation runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Repository layer via Morphia ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Executes validator.validate(entity) before the document is written.</p>
</li>
<li>
<p>If there are violations and the entity does not implement InvalidSavable with canSaveInvalid=true, an E2eqValidationException is thrown.</p>
</li>
<li>
<p>If DataDomain is null and SecurityContext has a principal, ValidationInterceptor will default the DataDomain from the principal context.</p>
</li>
<li>
<p>Optionally at REST boundaries: You may also annotate resource DTOs/parameters with Jakarta validation; Quarkus can validate them before the method executes.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_jackson_vs_jakarta_validation_annotations">1.7. Jackson vs Jakarta Validation Annotations</h4>
<div class="paragraph">
<p>These two families of annotations serve different purposes and complement each other:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jackson annotations (com.fasterxml.jackson.annotation.*) control JSON serialization/deserialization.</p>
</li>
<li>
<p>Examples: @JsonIgnore, @JsonIgnoreProperties, @JsonProperty, @JsonInclude.</p>
</li>
<li>
<p>They do not enforce business constraints; they affect how JSON is produced/consumed.</p>
</li>
<li>
<p>Jakarta Validation annotations (jakarta.validation.*) declare constraints that are evaluated at runtime.</p>
</li>
<li>
<p>Examples: @NotNull, @Size, @Valid, @Pattern.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Correspondence and interplay:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Jackson to hide or rename fields in API responses/requests (e.g., @JsonIgnore on transient/calculated fields such as UIActionList).</p>
</li>
<li>
<p>Use Jakarta Validation to ensure incoming/outgoing models satisfy required constraints; ValidationInterceptor runs before persistence to enforce them.</p>
</li>
<li>
<p>Its common to annotate the same field with both families when you both constrain values and want specific JSON behavior.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jackson_objectmapper_in_quarkus_and_in_quantum">2. Jackson ObjectMapper in Quarkus and in Quantum</h2>
<div class="sectionbody">
<div class="paragraph">
<p>How Quarkus creates ObjectMapper:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus produces a CDI-managed ObjectMapper. You can customize it by providing a bean that implements io.quarkus.jackson.ObjectMapperCustomizer.</p>
</li>
<li>
<p>You can also tweak common features via application.properties using quarkus.jackson.* properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Quantum defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The framework provides a QuarkusJacksonCustomizer that:</p>
</li>
<li>
<p>Sets DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES = true (reject unknown JSON fields).</p>
</li>
<li>
<p>Registers custom serializers/deserializers for org.bson.types.ObjectId so it can be used as String in APIs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Snippet from the framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">QuarkusJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper objectMapper) {
    objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="predefined-constant">true</span>);
    SimpleModule module = <span class="keyword">new</span> SimpleModule();
    module.addSerializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonSerializer());
    module.addDeserializer(ObjectId.class, <span class="keyword">new</span> ObjectIdJsonDeserializer());
    objectMapper.registerModule(module);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Customize in your app:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add another ObjectMapperCustomizer bean (order is not guaranteed; make changes idempotent):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyJacksonCustomizer</span> <span class="directive">implements</span> ObjectMapperCustomizer {
  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> customize(ObjectMapper mapper) {
    mapper.findAndRegisterModules();
    mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
    mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
  }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Or set properties in application.properties:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># Fail if extraneous fields are present
quarkus.jackson.fail-on-unknown-properties=true
# Example date format and inclusion
quarkus.jackson.write-dates-as-timestamps=false
quarkus.jackson.serialization-inclusion=NON_NULL</code></pre>
</div>
</div>
<div class="paragraph">
<p>When to adjust:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relax fail-on-unknown only for backward-compatibility scenarios; strictness helps catch client mistakes.</p>
</li>
<li>
<p>Register modules (JavaTime, etc.) if your models include those types.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_lifecycle_and_morphia_interceptors">3. Validation Lifecycle and Morphia Interceptors</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-eb93a6a189c8f862001d90ef83301062.svg" alt="Diagram" width="1332" height="446">
</div>
</div>
<div class="paragraph">
<p>Morphia interceptors enhance and enforce behavior during persistence. Quantum registers the following for each realm-specific datastore:</p>
</div>
<div class="paragraph">
<p>Order of registration (see MorphiaDataStore):
1) ValidationInterceptor
2) PermissionRuleInterceptor
3) AuditInterceptor
4) ReferenceInterceptor
5) PersistenceAuditEventInterceptor</p>
</div>
<div class="paragraph">
<p>High-level responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ValidationInterceptor (prePersist):</p>
</li>
<li>
<p>Defaults DataDomain from SecurityContext if missing.</p>
</li>
<li>
<p>Runs bean validation and throws E2eqValidationException on violations unless the entity supports saving invalid states (InvalidSavable).</p>
</li>
<li>
<p>PermissionRuleInterceptor (prePersist):</p>
</li>
<li>
<p>Evaluates RuleContext with PrincipalContext and ResourceContext from SecurityContext.</p>
</li>
<li>
<p>Throws SecurityCheckException if the rule decision is not ALLOW (enforcing write permissions for save/update/delete).</p>
</li>
<li>
<p>AuditInterceptor (prePersist):</p>
</li>
<li>
<p>Sets AuditInfo on creation and updates lastUpdate fields on modification; captures impersonation details if present.</p>
</li>
<li>
<p>ReferenceInterceptor (prePersist):</p>
</li>
<li>
<p>For @Reference fields annotated with @TrackReferences, maintains back-references on the parent entities via ReferenceEntry and persists the parent when needed.</p>
</li>
<li>
<p>PersistenceAuditEventInterceptor (prePersist when @AuditPersistence is present):</p>
</li>
<li>
<p>Appends a PersistentEvent with type PERSIST, date, userId, and version to the models persistentEvents before saving.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When does validation occur?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On every save/update path that hits persistence, prePersist triggers validation (and permission/audit/reference processing) before the document is written to MongoDB, guaranteeing constraints and policies are enforced consistently across all repositories.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_areadomain_in_rulecontext_permission_language">4. Functional Area/Domain in RuleContext Permission Language</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-d1b559d0b5553fa1f33a365251de99a5.svg" alt="Diagram" width="1049" height="350">
</div>
</div>
<div class="paragraph">
<p>Models express their placement in the business model via:
- bmFunctionalArea(): returns a broad capability area (e.g., Catalog, Collaboration, Identity)
- bmFunctionalDomain(): returns the specific domain within that area (e.g., Product, Shipment, Partner)</p>
</div>
<div class="paragraph">
<p>How these map into authorization and rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ResourceContext/DomainContext: When a request operates on a model, the framework derives the functional area and domain from the model type (or resource) and places them on the current context alongside the action (CREATE, UPDATE, VIEW, DELETE, ARCHIVE). RuleContext consumes these to evaluate policies.</p>
</li>
<li>
<p>Permission language (SecurityURI-based matching): The framework derives area and functionalDomain from REST path segments using the convention: /{area}/{functionalDomain}/{action}/&#8230;&#8203; . These values, together with action and identity, form the SecurityURI (header + body) used by the rule engine. Rules match on SecurityURI fields using wildcard string comparison; there is no HTTP method/URL pattern matching.</p>
</li>
<li>
<p>Permission language (query variables): The ANTLR-based query language exposes variables that can be referenced in filters:</p>
</li>
<li>
<p>${area} corresponds to bmFunctionalArea()</p>
</li>
<li>
<p>${functionalDomain} corresponds to bmFunctionalDomain()
These can be used to author reusable filters or to record audit decisions by area/domain.</p>
</li>
<li>
<p>Repository filters: RuleContext can contribute additional predicates that are area/domain-specific, enabling fine-grained sharing. For example, a shared Catalog area may allow cross-tenant VIEW, while a Collaboration.Shipment domain remains tenant-strict.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>1) SecurityURI-based rule matching (Permissions)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">name: allow-catalog-product-reads</span></span>
  <span class="key">description</span>: <span class="string"><span class="content">Allow USER and ADMIN to view products in the Catalog area</span></span>
  <span class="key">securityURI</span>:
    <span class="key">header</span>:
      <span class="key">identity</span>: <span class="string"><span class="content">USER</span></span>            <span class="comment"># role treated as identity; author a second rule for ADMIN if needed</span>
      <span class="key">area</span>: <span class="string"><span class="content">Catalog</span></span>
      <span class="key">functionalDomain</span>: <span class="string"><span class="content">Product</span></span>
      <span class="key">action</span>: <span class="string"><span class="content">view</span></span>
    <span class="key">body</span>:
      <span class="key">realm</span>: <span class="string"><span class="content">system-com</span></span>
      <span class="key">accountNumber</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">tenantId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">dataSegment</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">ownerId</span>: <span class="string"><span class="content">'*'</span></span>
      <span class="key">resourceId</span>: <span class="string"><span class="content">'*'</span></span>
  <span class="key">effect</span>: <span class="string"><span class="content">ALLOW</span></span>
  <span class="key">priority</span>: <span class="string"><span class="content">300</span></span>
  <span class="key">finalRule</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Query variable usage (Filters)</p>
</div>
<div class="paragraph">
<p>You can reference the active area/domain in filter expressions (e.g., for auditing or conditional branching in custom rule evaluators):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Constrain reads differently when operating in the Catalog area
(${area}:&quot;Catalog&quot; &amp;&amp; dataDomain.orgRefName:&quot;PUBLIC&quot;) ||
(${area}:!&quot;Catalog&quot; &amp;&amp; dataDomain.tenantId:${pTenantId})</code></pre>
</div>
</div>
<div class="paragraph">
<p>3) Model-driven mapping</p>
</div>
<div class="paragraph">
<p>Given a model like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Collaboration</span><span class="delimiter">&quot;</span></span>; }
<span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>; }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Incoming REST requests that operate on Shipment resources set area=Collaboration and functionalDomain=Shipment in the ResourceContext.</p>
</li>
<li>
<p>RuleContext evaluates policies considering action + area + domain, e.g., deny cross-tenant UPDATE in Collaboration.Shipment, but allow cross-tenant VIEW in Collaboration.Partner if marked shared.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Path convention: Use leading segments /{area}/{functionalDomain}/{action}/&#8230;&#8203; so the framework can derive ResourceContext reliably. Extra segments after the first three are allowed; only the first three are used to compute area, domain, and action.</p>
</li>
<li>
<p>Nonconformant paths: If the path has fewer than three segments, the framework sets an anonymous/default ResourceContext. In practice, rules will typically evaluate to DENY unless there is an explicit allowance for anonymous contexts.</p>
</li>
<li>
<p>See also: the Permissions section for rule-base matching and priorities, and the DomainContext/RuleContext section for end-to-end flow.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stategraphs_on_models">5. StateGraphs on Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>StateGraphs let you restrict valid values and transitions of String state fields. They are declared on model fields with @StateGraph and enforced during save/update when the model class is annotated with @Stateful.</p>
</div>
<div class="paragraph">
<p>Key pieces:
- @StateGraph(graphName="&#8230;&#8203;"): mark a String field as governed by a named state graph.
- @Stateful: mark the entity type as participating in state validation.
- StateGraphManager: runtime registry that holds graphs and validates transitions.
- StringState and StateNode: define the graph (states, initial/final flags, transitions).</p>
</div>
<div class="paragraph">
<p>Defining a state graph at startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Startup</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StateGraphInitializer</span> {
  <span class="annotation">@Inject</span> StateGraphManager stateGraphManager;
  <span class="annotation">@PostConstruct</span> <span class="type">void</span> init() {
    StringState order = <span class="keyword">new</span> StringState();
    order.setFieldName(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, StateNode&gt; states = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">true</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">false</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    states.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  StateNode.builder().state(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>).initialState(<span class="predefined-constant">false</span>).finalState(<span class="predefined-constant">true</span>).build());
    order.setStates(states);

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">List</span>&lt;StateNode&gt;&gt; transitions = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PENDING</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">PROCESSING</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHIPPED</span><span class="delimiter">&quot;</span></span>,    <span class="predefined-type">List</span>.of(states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>), states.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>)));
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELIVERED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    transitions.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CANCELLED</span><span class="delimiter">&quot;</span></span>,  <span class="predefined-constant">null</span>);
    order.setTransitions(transitions);

    stateGraphManager.defineStateGraph(order);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_state_graph_dot">6. State Graph (DOT)</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="state-graph.svg" alt="state graph" width="1006" height="353">
</div>
</div>
<div class="paragraph">
<p>Using the graph in a model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateful</span>
<span class="annotation">@Entity</span>
<span class="annotation">@EqualsAndHashCode</span>(callSuper = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@StateGraph</span>(graphName = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderStringState</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">private</span> <span class="predefined-type">String</span> status;

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()  { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Orders</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain(){ <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="state-lifecycle.svg" alt="state lifecycle" width="836" height="569">
</div>
</div>
<div class="paragraph">
<p>How it affects save/update:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On create: validateInitialStates ensures the field value is one of the configured initial states. Otherwise, InvalidStateTransitionException is thrown.</p>
</li>
<li>
<p>On update: validateStateTransitions checks each @StateGraph fields old&#8594;new transition against the graph via StateGraphManager.validateTransition(). If invalid, save/update fails with InvalidStateTransitionException. This applies to full-entity saves and to partial updates via repo.update(&#8230;&#8203;pairs) on that field.</p>
</li>
<li>
<p>Utilities: StateGraphManager.getNextPossibleStates(graphName, current) and printStateGraph(&#8230;&#8203;) can aid UIs.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_completiontasks_and_completiontaskgroups">7. CompletionTasks and CompletionTaskGroups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CompletionTasks and CompletionTaskGroups provide a simple, persistent way to track a series of work items that need to be completed, either by background processes or external systems. Use them when you need durable progress tracking across restarts and an auditable record of outcomes.</p>
</div>
<div class="paragraph">
<p>Key models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CompletionTask: an individual unit of work with fields like status, timestamps, and optional result/details.</p>
</li>
<li>
<p>CompletionTaskGroup: a container that represents a cohort of tasks progressing toward completion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Model overview:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Individual task</span>
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">completionTask</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CompletionTask</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">public</span> <span class="type">enum</span> Status { PENDING, RUNNING, SUCCESS, FAILED }

  <span class="annotation">@Reference</span>
  CompletionTaskGroup group;   <span class="comment">// optional grouping</span>
  <span class="predefined-type">String</span> details;              <span class="comment">// human-readable context (what/why)</span>
  Status status;               <span class="comment">// PENDING -&gt; RUNNING -&gt; (SUCCESS|FAILED)</span>
  <span class="predefined-type">Date</span> createdDate;            <span class="comment">// when the task was created</span>
  <span class="predefined-type">Date</span> completedDate;          <span class="comment">// set when terminal (SUCCESS/FAILED)</span>
  <span class="predefined-type">String</span> result;               <span class="comment">// output, message, or error summary</span>

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()   { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">TASK</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETION_TASK</span><span class="delimiter">&quot;</span></span>; }
}

<span class="comment">// Group of tasks</span>
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">completionTaskGroup</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CompletionTaskGroup</span> <span class="directive">extends</span> BaseModel {
  <span class="directive">public</span> <span class="type">enum</span> Status { NEW, RUNNING, COMPLETE }

  <span class="predefined-type">String</span> description;   <span class="comment">// e.g., &quot;Onboarding: create resources&quot;</span>
  Status status;        <span class="comment">// reflects overall progress of the group</span>
  <span class="predefined-type">Date</span> createdDate;     <span class="comment">// when the group was created</span>
  <span class="predefined-type">Date</span> completedDate;   <span class="comment">// when the group finished</span>

  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalArea()   { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">TASK</span><span class="delimiter">&quot;</span></span>; }
  <span class="annotation">@Override</span> <span class="directive">public</span> <span class="predefined-type">String</span> bmFunctionalDomain() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETION_TASK_GROUP</span><span class="delimiter">&quot;</span></span>; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typical lifecycle:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-plantuml-md5-2eeb655becc44b8fa685c07e4ac12e5c.svg" alt="Diagram" width="760" height="738">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a CompletionTaskGroup in NEW status.</p>
</li>
<li>
<p>Create N CompletionTasks (status=PENDING) referencing the group.</p>
</li>
<li>
<p>A worker picks tasks and flips status to RUNNING, performs the work, then to SUCCESS or FAILED, setting completedDate and result.</p>
</li>
<li>
<p>Periodically update the group:</p>
</li>
<li>
<p>If at least one task is RUNNING (and none pending), set group status to RUNNING.</p>
</li>
<li>
<p>When all tasks are terminal (SUCCESS or FAILED), set group status to COMPLETE and completedDate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to use for tracking a series of things that need to be completed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Batch operations: When submitting a batch (e.g., provisioning 100 accounts), create one group and 100 tasks. The UI/API can poll the group to show overall progress and per-item results.</p>
</li>
<li>
<p>Multi-step workflows: Represent each step as its own task, or use one task per target resource. Groups help correlate all steps for a single business request.</p>
</li>
<li>
<p>Retry/compensation: FAILED tasks can be retried by creating new tasks or resetting status to PENDING based on your policy. Keep result populated with failure reasons.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example creation flow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionTaskGroup group = CompletionTaskGroup.builder()
  .description(<span class="string"><span class="delimiter">&quot;</span><span class="content">Catalog import: 250 SKUs</span><span class="delimiter">&quot;</span></span>)
  .status(CompletionTaskGroup.Status.NEW)
  .createdDate(<span class="keyword">new</span> <span class="predefined-type">Date</span>())
  .build();
completionTaskGroupRepo.save(group);

<span class="keyword">for</span> (Sku s : skus) {
  CompletionTask t = CompletionTask.builder()
    .group(group)
    .details(<span class="string"><span class="delimiter">&quot;</span><span class="content">Import SKU </span><span class="delimiter">&quot;</span></span> + s.code())
    .status(CompletionTask.Status.PENDING)
    .createdDate(<span class="keyword">new</span> <span class="predefined-type">Date</span>())
    .build();
  completionTaskRepo.save(t);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example worker progression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Fetch a PENDING task and execute</span>
CompletionTask t = completionTaskRepo.findOneByStatus(CompletionTask.Status.PENDING);
<span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) {
  completionTaskRepo.update(t.getId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.RUNNING);
  <span class="keyword">try</span> {
    <span class="comment">// ... do work ...</span>
    completionTaskRepo.update(t.getId(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.SUCCESS,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OK</span><span class="delimiter">&quot;</span></span>);
  } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    completionTaskRepo.update(t.getId(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTask.Status.FAILED,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>, e.getMessage());
  }
}

<span class="comment">// Periodically recompute group status</span>
<span class="predefined-type">List</span>&lt;CompletionTask&gt; tasks = completionTaskRepo.findByGroup(group);
<span class="type">boolean</span> allTerminal = tasks.stream().allMatch(x -&gt; x.getStatus()==SUCCESS || x.getStatus()==FAILED);
<span class="type">boolean</span> anyRunning = tasks.stream().anyMatch(x -&gt; x.getStatus()==RUNNING);
<span class="type">boolean</span> anyPending = tasks.stream().anyMatch(x -&gt; x.getStatus()==PENDING);

<span class="keyword">if</span> (allTerminal) {
  completionTaskGroupRepo.update(group.getId(),
    <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTaskGroup.Status.COMPLETE,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">completedDate</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>());
} <span class="keyword">else</span> <span class="keyword">if</span> (anyRunning || (!anyPending &amp;&amp; !allTerminal)) {
  completionTaskGroupRepo.update(group.getId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, CompletionTaskGroup.Status.RUNNING);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes and best practices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep details short but diagnostic, and store richer context in result.</p>
</li>
<li>
<p>Use DataDomain fields for multi-tenant scoping so groups/tasks are isolated per tenant/org as needed.</p>
</li>
<li>
<p>Avoid unbounded growth: archive or purge old groups once COMPLETE.</p>
</li>
<li>
<p>Consider idempotency keys in details or a custom field to prevent processing the same logical work twice.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references_and_entityreference">8. References and EntityReference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Morphia @Reference establishes relationships between entities:
- One-to-one: a BaseModel field annotated with @Reference.
- One-to-many: a Collection&lt;BaseModel&gt; field annotated with @Reference.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Shipment</span> <span class="directive">extends</span> BaseModel {
  <span class="annotation">@Reference</span>(ignoreMissing = <span class="predefined-constant">false</span>)
  <span class="annotation">@TrackReferences</span>
  <span class="directive">private</span> Partner partner;   <span class="comment">// parent entity</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>EntityReference is a lightweight reference object used across the framework to avoid DBRef loading when only identity info is needed. Any model can produce one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityReference ref = shipment.createEntityReference();
<span class="comment">// contains: entityId, entityType, entityRefName, entityDisplayName (and optional realm)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>REST convenience:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BaseResource exposes GET /entityref to list EntityReference for a model with optional filter/sort.</p>
</li>
<li>
<p>Repositories expose getEntityReferenceListByQuery(&#8230;&#8203;), and utilities exist to convert lists of EntityReference back to entities when needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When to use which:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use @Reference for strong persistence-level links where Morphia should maintain foreign references.</p>
</li>
<li>
<p>Use EntityReference for UI lists, foreign-key-like pointers in other documents, events/audit logs, or cross-module decoupling without DBRef behavior.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tracking_references_with_trackreferences_and_delete_semantics">9. Tracking References with @TrackReferences and Delete Semantics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>@TrackReferences on a @Reference field tells the framework to maintain a back-reference set on the parent entity. The back-reference field is UnversionedBaseModel.references (a Set&lt;ReferenceEntry&gt;), which is calculated/maintained by the framework and should not be set by clients.</p>
</div>
<div class="paragraph">
<p>What references contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each ReferenceEntry holds: referencedId (ObjectId of the child), type (fully-qualified class name of the childs entity), and refName (childs stable reference name).</p>
</li>
<li>
<p>It indicates that the parent is being referenced by the given child entity. The set is used for fast checks and to enforce referential integrity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How tracking works (save/update):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReferenceInterceptor inspects @Reference fields annotated with @TrackReferences during prePersist.</p>
</li>
<li>
<p>When a child references a parent, a ReferenceEntry for the child is added to the parents references set and the parent is saved to persist the back-reference.</p>
</li>
<li>
<p>For @Reference collections, entries are added for each child-parent pair.</p>
</li>
<li>
<p>If a @Reference is null but ignoreMissing=false, a save will fail with an IllegalStateException since the parent is required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How it affects delete:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During delete in MorphiaRepo.delete(&#8230;&#8203;):</p>
</li>
<li>
<p>If obj.references is empty, the object can be deleted directly (after removing any references it holds to parents).</p>
</li>
<li>
<p>If obj.references is not empty, the repo checks each ReferenceEntry. If any referring parent still exists, a ReferentialIntegrityViolationException is thrown to prevent breaking relationships.</p>
</li>
<li>
<p>If all references are stale (referring objects no longer exist), the repo removes stale entries, removes this objects own reference constraints from parents, and performs the delete within a transaction.</p>
</li>
<li>
<p>removeReferenceConstraint(&#8230;&#8203;) ensures that, when deleting a child, its ReferenceEntry is removed from parent.references and the parent is saved, keeping back-references consistent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Practical guidance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotate parent links with both @Reference and @TrackReferences when you need strong integrity guarantees and easy who references me? queries.</p>
</li>
<li>
<p>Use ignoreMissing=true only for optional references; you still get back-reference tracking when not null.</p>
</li>
<li>
<p>Expect HTTP delete to fail with a meaningful error if there are live references; remove or update those references first, or design cascading behavior explicitly in your domain logic.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="ontologies-in-quantum">9.1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Looking for the short implementation plan? See PROPOSAL.md at the repository root for a concise module-by-module checklist.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section explains what an ontology is, how it differs from a traditional object model, and how the Quantum Ontology modules make it practical to apply ontology ideas to your domain models and queries. It also contrasts ontology-driven relationships with direct object references (for example, using @Reference or EntityReference).</p>
</div>
<div class="sect3">
<h4 id="_what_is_an_ontology">9.1.1. What is an Ontology?</h4>
<div class="paragraph">
<p>In software terms, an ontology is a formal, explicit specification of concepts and their relationships.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concepts (Classes): Named categories/types in your domain. Concepts can form taxonomies (is-a hierarchies), be declared disjoint, or be equivalent.</p>
</li>
<li>
<p>Relationships (Properties): Named relationships between entities. Properties can have a domain (applies to X) and a range (points to Y). They may be inverse or transitive.</p>
</li>
<li>
<p>Axioms (Rules): Constraints and entailment rules, including property chains such as: if (A --p-&#8594; B) and (B --q-&#8594; C) then we infer (A --r-&#8594; C).</p>
</li>
<li>
<p>Inference: The process of deriving new facts (types, labels, edges) that were not explicitly stored but follow from axioms and known facts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An ontology is not the data; it is the schema plus logic that gives your data additional meaning and enables consistent, automated inferences.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ontology_vs_object_model">9.1.2. Ontology vs. Object Model</h4>
<div class="paragraph">
<p>A conventional object model focuses on concrete classes, fields, and direct references between objects at implementation time. An ontology focuses on semantic types and relationships, with explicit rules that can derive new knowledge independent of how objects are instantiated.</p>
</div>
<div class="paragraph">
<p>Key differences:
- Purpose
  - Object model: Encapsulate data and behavior for application code generation and persistence.
  - Ontology: Encode shared meaning, constraints, and inference rules that remain stable as implementation details change.
- Relationship handling
  - Object model: Typically uses direct references or foreign keys; traversals are hard-coded and fragile to change.
  - Ontology: Uses named predicates (properties) and can infer additional relationships by rules (property chains, inverses, transitivity).
- Polymorphism and evolution
  - Object model: Polymorphism requires class inheritance in code; cross-cutting categories are awkward to add later.
  - Ontology: Entities can have multiple types/labels at once. New concepts and properties can be introduced without breaking existing data.
- Querying
  - Object model: Queries couple to concrete classes and field paths; changes force query rewrites.
  - Ontology: Queries target semantic relationships; reasoners can materialize edges that queries reuse, decoupling queries from implementation details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_prefer_ontology_driven_relationships_over_referenceentityreference">9.1.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</h4>
<div class="paragraph">
<p>Direct references (@Reference or custom EntityReference) are simple to start but become restrictive as domains grow:
- Tight coupling: Code and queries couple to concrete field paths (customer.primaryAddress.id), making refactors risky.
- Limited expressivity: Hard to encode and reuse higher-order relationships (e.g., "partners of my supplier&#8217;s parent org").
- Poor polymorphism: References point to one collection/type; accommodating multiple target types requires extra code.
- Performance pitfalls: Deep traversals cause extra queries, N+1 selects, or complex $lookup joins.</p>
</div>
<div class="paragraph">
<p>Ontology-driven edges address these issues:
- Decoupling via predicates: Use named predicates (e.g., hasAddress, memberOf, supplies) that remain stable while internal object fields change.
- Inference for reachability: Property chains can materialize implied links (A --p-&#8594; B &amp; B --q-&#8594; C &#8658; A --r-&#8594; C), avoiding runtime multi-hop traversals.
- Polymorphism-first: A predicate can connect heterogeneous types; type inferences (domain/range) remain consistent.
- Query performance: Pre-materialized edges allow single-hop, index-friendly queries (in or eq filters) instead of ad-hoc multi-collection traversals.
- Resilience to change: You can add or modify rules without rewriting data structures or touching referencing fields across models.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_quantum_supports_ontologies">9.1.4. How Quantum supports Ontologies</h4>
<div class="paragraph">
<p>Quantum provides three cooperating modules that make ontology modeling practical and fast:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum-ontology-core (package com.e2eq.ontology.core)</p>
</li>
<li>
<p>OntologyRegistry: Holds the TBox (terminology) of your ontology.</p>
</li>
<li>
<p>ClassDef: Concept names and relationships (parents, disjointWith, sameAs).</p>
</li>
<li>
<p>PropertyDef: Property names with optional domain, range, inverse flags, and transitivity.</p>
</li>
<li>
<p>PropertyChainDef: Rules that define multi-hop implications (chains &#8594; implied property).</p>
</li>
<li>
<p>TBox: Container for classes, properties, and property chains.</p>
</li>
<li>
<p>Reasoner interface and ForwardChainingReasoner: Given an entity snapshot and the registry, computes inferences:</p>
</li>
<li>
<p>New types/labels to assert on entities.</p>
</li>
<li>
<p>New edges to add (implied by property chains, inverses, or other rules).</p>
</li>
<li>
<p>quantum-ontology-mongo (package com.e2eq.ontology.mongo)</p>
</li>
<li>
<p>EdgeDao: A thin DAO around an edges collection in Mongo. Each edge contains tenantId, src, predicate p, dst, inferred flag, provenance, and timestamp.</p>
</li>
<li>
<p>OntologyMaterializer: Runs the Reasoner for an entity snapshot and upserts the inferred edges, so queries can be rewritten to simple in/in eq filters.</p>
</li>
<li>
<p>quantum-ontology-policy-bridge (package com.e2eq.ontology.policy)</p>
</li>
<li>
<p>ListQueryRewriter: Takes a base query and rewrites it using the EdgeDao to filter by the set of source entity ids that have a specific predicate to a given destination.</p>
</li>
<li>
<p>This integrates ontology edges with RuleContext or policy decisions: policy asks for entities related by a predicate; the rewriter converts that into an efficient Mongo query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These modules let you define your ontology (core), materialize derived relations (mongo), and leverage them in access and list queries (policy bridge).</p>
</div>
</div>
<div class="sect3">
<h4 id="_modeling_guidance_from_object_fields_to_predicates">9.1.5. Modeling guidance: from object fields to predicates</h4>
<div class="ulist">
<ul>
<li>
<p>Name relationships explicitly</p>
</li>
<li>
<p>Define clear predicate names (hasAddress, memberOf, supplies, owns, assignedTo). Avoid encoding relationship semantics in field names only.</p>
</li>
<li>
<p>Keep object model minimal and flexible</p>
</li>
<li>
<p>Store lightweight identifiers (ids) as needed, but avoid deeply nested reference graphs that encode traversals in code.</p>
</li>
<li>
<p>Model polymorphic relationships</p>
</li>
<li>
<p>Prefer predicates that naturally connect multiple possible types (e.g., assignedTo can target User, Team, Bot) and rely on ontology type assertions to constrain where needed.</p>
</li>
<li>
<p>Use property chains for common paths</p>
</li>
<li>
<p>If business logic often traverses A &#8594; B &#8594; C, define a chain pq  r and materialize r for faster queries and simpler policies.</p>
</li>
<li>
<p>Capture inverses and transitivity</p>
</li>
<li>
<p>For natural inverses (parentOf  childOf) or transitive relations (partOf, locatedIn), define them in the ontology so edges and queries stay consistent.</p>
</li>
<li>
<p>Keep provenance</p>
</li>
<li>
<p>Record why an edge exists (prov.rule, prov.inputs) so you can recompute, audit, or retract when inputs change.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_querying_with_ontology_edges_vs_direct_references">9.1.6. Querying with ontology edges vs direct references</h4>
<div class="ulist">
<ul>
<li>
<p>Direct reference example (fragile/slow)</p>
</li>
<li>
<p>Query: "Find Orders whose buyer belongs to Org X or its parents."</p>
</li>
<li>
<p>With @Reference: requires joining Order &#8594; User &#8594; Org and recursing org.parent; costly and tightly coupled to fields.</p>
</li>
<li>
<p>Ontology edge example (resilient/fast)</p>
</li>
<li>
<p>Define predicates: placedBy(order, user), memberOf(user, org), ancestorOf(org, org). Define chain placedBy  memberOf  placedInOrg.</p>
</li>
<li>
<p>Materialize edges: (order --placedInOrg-&#8594; org). Also make ancestorOf transitive.</p>
</li>
<li>
<p>Query becomes: where order._id in EdgeDao.srcIdsByDst(tenantId, "placedInOrg", orgX).</p>
</li>
<li>
<p>With transitivity, you can precompute ancestor closure or add a chain placedInOrg  ancestorOf  placedInOrg to include parents automatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_migration_from_reference_to_ontology_edges">9.1.7. Migration: from @Reference to ontology edges</h4>
<div class="ulist">
<ul>
<li>
<p>Start by introducing predicates alongside existing references; do not remove references immediately.</p>
</li>
<li>
<p>Materialize edges for hot read paths; keep provenance so you can reconstruct.</p>
</li>
<li>
<p>Gradually update queries (list screens, policy filters) to use ListQueryRewriter with EdgeDao instead of deep traversals or $lookup.</p>
</li>
<li>
<p>Once stable, you can simplify models by removing rigid reference fields where unnecessary and rely on edges for read-side composition.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_performance_and_operational_notes">9.1.8. Performance and operational notes</h4>
<div class="ulist">
<ul>
<li>
<p>Indexing: Create compound indexes on edges: (tenantId, p, dst) and (tenantId, src, p) to support both reverse and forward lookups.</p>
</li>
<li>
<p>Write amplification vs read wins: Materialization adds write work, but dramatically improves read latency and simplifies queries.</p>
</li>
<li>
<p>Consistency: Re-materialize edges on relevant entity changes (source, destination, or intermediate) using OntologyMaterializer.</p>
</li>
<li>
<p>Multi-tenancy: Keep tenantId in the edge key and filters; the provided EdgeDao methods include tenant scoping.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_how_this_integrates_with_functional_areasdomains">9.1.9. How this integrates with Functional Areas/Domains</h4>
<div class="ulist">
<ul>
<li>
<p>Functional domains often map to concept clusters in the ontology. Use @FunctionalMapping to aid discovery and apply policies per area/domain.</p>
</li>
<li>
<p>Policies can refer to relationships semantically ("hasEdge placedInOrg OrgX") and rely on the policy bridge to turn this into efficient data filters.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_summary">9.1.10. Summary</h4>
<div class="ulist">
<ul>
<li>
<p>Ontology-powered relationships provide a stable, semantic layer over your object model.</p>
</li>
<li>
<p>The Quantum Ontology modules let you define, infer, and query these relationships efficiently on MongoDB.</p>
</li>
<li>
<p>Compared with direct @Reference/EntityReference, ontology edges are more expressive, resilient to change, and typically faster for complex list/policy queries once materialized.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ontology-ecommerce-example">9.1.11. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</h4>
<div class="paragraph">
<p>This example shows how to use an ontology to model relationships around Orders, Customers, and Shipments, and how the model can evolve to include Fulfillment and Returns without breaking existing queries. We will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define core concepts and predicates.</p>
</li>
<li>
<p>Add property chains that materialize implied relationships for fast queries.</p>
</li>
<li>
<p>Show how queries are rewritten using edges instead of deep object traversals.</p>
</li>
<li>
<p>Evolve the model to support Fulfillment and Returns with minimal changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core concepts (classes)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order, Customer, Organization, Shipment, Address, Region</p>
</li>
<li>
<p>Later evolution: FulfillmentTask, FulfillmentUnit, ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key predicates (relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy(order, customer): who placed the order</p>
</li>
<li>
<p>memberOf(customer, org): a customer belongs to an organization (or account)</p>
</li>
<li>
<p>orderHasShipment(order, shipment): outbound shipment for the order</p>
</li>
<li>
<p>shipsTo(shipment, address): shipment destination</p>
</li>
<li>
<p>locatedIn(address, region): address is located in a Region</p>
</li>
<li>
<p>ancestorOf(org, org): organizational ancestry (transitive)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Property chains (implied relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy  memberOf  placedInOrg</p>
</li>
<li>
<p>If (order --placedBy-&#8594; customer) and (customer --memberOf-&#8594; org), then infer (order --placedInOrg-&#8594; org)</p>
</li>
<li>
<p>orderHasShipment  shipsTo  orderShipsTo</p>
</li>
<li>
<p>If (order --orderHasShipment-&#8594; shipment) and (shipment --shipsTo-&#8594; address), infer (order --orderShipsTo-&#8594; address)</p>
</li>
<li>
<p>orderShipsTo  locatedIn  orderShipsToRegion</p>
</li>
<li>
<p>If (order --orderShipsTo-&#8594; address) and (address --locatedIn-&#8594; region), infer (order --orderShipsToRegion-&#8594; region)</p>
</li>
<li>
<p>placedInOrg  ancestorOf  placedInOrg</p>
</li>
<li>
<p>Makes placedInOrg resilient to org hierarchy changes (ancestorOf is transitive). This is a common closure trick: re-assert the same predicate via chain to absorb hierarchy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A minimal Java-style snippet to define this TBox</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util</span>.*;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>.*;

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, PropertyDef&gt; props = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">true</span>), <span class="comment">// transitive</span>
  <span class="comment">// implied predicates (no domain/range required, but you may add them for validation)</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>)
);

<span class="predefined-type">List</span>&lt;PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
);

OntologyRegistry.TBox tbox = <span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains);
OntologyRegistry registry = OntologyRegistry.inMemory(tbox);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Materializing edges for an Order</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit facts for order O1:</p>
</li>
<li>
<p>O1 placedBy C9</p>
</li>
<li>
<p>C9 memberOf OrgA</p>
</li>
<li>
<p>O1 orderHasShipment S17</p>
</li>
<li>
<p>S17 shipsTo Addr42</p>
</li>
<li>
<p>Addr42 locatedIn RegionWest</p>
</li>
<li>
<p>OrgA ancestorOf OrgParent</p>
</li>
<li>
<p>Inferred edges after running the reasoner for O1s snapshot:</p>
</li>
<li>
<p>O1 placedInOrg OrgA</p>
</li>
<li>
<p>O1 placedInOrg OrgParent (via closure with ancestorOf)</p>
</li>
<li>
<p>O1 orderShipsTo Addr42</p>
</li>
<li>
<p>O1 orderShipsToRegion RegionWest</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How queries become simple and fast</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders for Organization OrgParent (including children):</p>
</li>
<li>
<p>Instead of joining Order &#8594; Customer &#8594; Org and recursing org.parent, run a single filter using materialized edges.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.mongodb.client.model.Filters</span>;
<span class="keyword">import</span> <span class="include">org.bson.conversions.Bson</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.policy.ListQueryRewriter</span>;

Bson base = Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Use rewritten in your Mongo find</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson rewritten2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why this is resilient</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If tomorrow Customer becomes AccountContact and the organization model gains Divisions and multi-parent org graphs, you only adjust predicates and chains.</p>
</li>
<li>
<p>Queries that rely on placedInOrg or orderShipsToRegion remain unchanged and fast, because edges are re-materialized by OntologyMaterializer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evolving the model: add Fulfillment</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FulfillmentTask: a unit of work to pick/pack/ship order lines</p>
</li>
<li>
<p>FulfillmentUnit: a logical grouping (e.g., wave, tote, parcel)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills(task, order)</p>
</li>
<li>
<p>realizedBy(order, fulfillmentUnit)</p>
</li>
<li>
<p>taskProduces(task, shipment)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills  derived edge from task to order; combine with taskProduces to connect order to shipment without touching Order fields:</p>
</li>
<li>
<p>fulfills  taskProduces  orderHasShipment</p>
</li>
<li>
<p>realizedBy  orderHasShipment  fulfilledByUnit</p>
</li>
<li>
<p>If (order --realizedBy-&#8594; fu) and (order --orderHasShipment-&#8594; s)  (fu --fulfillsShipment-&#8594; s) or simply (order --fulfilledByUnit-&#8594; fu)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These chains let you introduce warehouse concepts without changing how UI filters orders by organization or ship-to region. Existing queries still operate via placedInOrg and orderShipsToRegion.</p>
</div>
<div class="paragraph">
<p>Evolving further: add Returns</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn(order, returnRequest)</p>
</li>
<li>
<p>returnFor(returnItem, order)</p>
</li>
<li>
<p>returnRma(returnRequest, rma)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn  openReturnOnOrg via placedInOrg:</p>
</li>
<li>
<p>hasReturn  placedInOrg  returnPlacedInOrg</p>
</li>
<li>
<p>returnFor  orderShipsToRegion  returnShipsToRegion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example queries with new capabilities</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders with open returns in OrgParent:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnPlacedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Returns associated to Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparison with direct references (@Reference/EntityReference)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With direct references you would encode fields like Order.customer, Order.shipments, Shipment.address, Address.region and then implement multi-hop traversals in code or $lookup pipelines, rewriting them whenever you add Fulfillment or Returns.</p>
</li>
<li>
<p>With ontology edges, you keep predicates stable and add property chains. Existing list and policy queries keep working and typically become faster due to single-hop filters on an indexed edges collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational tips for this scenario</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure EdgeDao has indexes on (tenantId, p, dst) and (tenantId, src, p).</p>
</li>
<li>
<p>Use OntologyMaterializer when Order, Shipment, Customer, Address, or org hierarchy changes to keep edges fresh.</p>
</li>
<li>
<p>Keep provenance in edge.prov (rule, inputs) so you can recompute or retract edges when source data changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ontology-integration-morphia-permissions">9.2. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</h3>
<div class="paragraph">
<p>This section focuses on integration and developer experience: how ontology edges flow into Morphia-based repositories and the permission rule language, while remaining fully multi-tenant and secure.</p>
</div>
<div class="sect3">
<h4 id="_big_picture_where_ontology_fits">9.2.1. Big picture: where ontology fits</h4>
<div class="ulist">
<ul>
<li>
<p>Write path (materialization):</p>
</li>
<li>
<p>Your domain code persists entities with minimal direct references.</p>
</li>
<li>
<p>An OntologyMaterializer runs when entities change to derive and upsert edges into the edges collection (per tenant).</p>
</li>
<li>
<p>Policy path (authorization and list filters):</p>
</li>
<li>
<p>The permission rule language evaluates the callers SecurityContext/RuleContext and produces logical filters.</p>
</li>
<li>
<p>When a rule asks for a semantic relationship (hasEdge), we use ListQueryRewriter + EdgeDao to translate that into efficient Mongo filters over ids.</p>
</li>
<li>
<p>Read path (queries):</p>
</li>
<li>
<p>Morphia repos apply the base data-domain filters and the rewritten ontology constraint to queries, producing fast lists without deep joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_rule_language_add_hasedge">9.2.2. Rule language: add hasEdge()</h4>
<div class="paragraph">
<p>We introduce a policy function/operator to reference ontology edges directly from rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature: hasEdge(predicate, dstIdOrVar)</p>
</li>
<li>
<p>predicate: String name of the ontology predicate (e.g., "placedInOrg", "orderShipsToRegion").</p>
</li>
<li>
<p>dstIdOrVar: Either a concrete id/refName or a variable resolved from RuleContext (e.g., principal.orgRefName, request.region).</p>
</li>
<li>
<p>Semantics: The rule grants/filters entities for which an edge (tenantId, src = entity._id, p = predicate, dst = resolvedDst) exists.</p>
</li>
<li>
<p>Composition: hasEdge can be combined with existing rule clauses (and/or/not) and other filters (states, tags, ownerId, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example rule snippets (illustrative):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow viewing Orders in the callers org (including ancestors via ontology closure):</p>
</li>
<li>
<p>allow VIEW Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Restrict list to Orders shipping to a region chosen in request:</p>
</li>
<li>
<p>allow LIST Order when hasEdge("orderShipsToRegion", request.region)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under the hood, policy evaluation uses ListQueryRewriter.rewriteForHasEdge(&#8230;&#8203;), which converts hasEdge into a set of source ids and merges that with the base query.</p>
</div>
</div>
<div class="sect3">
<h4 id="_passing_tenantid_correctly">9.2.3. Passing tenantId correctly</h4>
<div class="ulist">
<ul>
<li>
<p>Always resolve tenantId from RuleContext/SecurityContext (the same source your repos use for realm/database selection).</p>
</li>
<li>
<p>EdgeDao and ListQueryRewriter already accept tenantId; never cross tenant boundaries when reading edges.</p>
</li>
<li>
<p>Index recommendation (per tenant):</p>
</li>
<li>
<p>(tenantId, p, dst)</p>
</li>
<li>
<p>(tenantId, src, p)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_morphia_repository_integration_patterns">9.2.4. Morphia repository integration patterns</h4>
<div class="paragraph">
<p>The goal is zero-friction usage in existing repos without invasive changes.</p>
</div>
<div class="paragraph">
<p>Option A: Apply ontology constraints in code paths that already construct BSON filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your repo method builds a Bson filter before calling find(), wrap it through rewriter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson base = Filters.and(existingFilters...);
Bson rewritten = hasEdgeRequested
  ? rewriter.rewriteForHasEdge(base, tenantId, predicate, dst)
  : base;
<span class="type">var</span> cursor = datastore.getDatabase().getCollection(coll).find(rewritten);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option B: Apply ontology constraints to Morphia Filter/Query via ids.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the repo uses Morphias typed query API instead of BSON, pre-compute the id set and constrain by _id:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; ids = edgeDao.srcIdsByDst(tenantId, predicate, dst);
<span class="keyword">if</span> (ids.isEmpty()) {
  <span class="keyword">return</span> <span class="predefined-type">List</span>.of(); <span class="comment">// short-circuit</span>
}
query.filter(Filters.in(<span class="string"><span class="delimiter">&quot;</span><span class="content">_id</span><span class="delimiter">&quot;</span></span>, ids));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option C: Centralize in a tiny helper for developer ergonomics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide one helper in your application layer, invoked wherever policies inject additional constraints:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">OntologyFilterHelper</span> {
  <span class="directive">private</span> <span class="directive">final</span> ListQueryRewriter rewriter;
  <span class="directive">public</span> OntologyFilterHelper(ListQueryRewriter r) { <span class="local-variable">this</span>.rewriter = r; }

  <span class="directive">public</span> Bson ensureHasEdge(Bson base, <span class="predefined-type">String</span> tenantId, <span class="predefined-type">String</span> predicate, <span class="predefined-type">String</span> dst) {
    <span class="keyword">return</span> rewriter.rewriteForHasEdge(base, tenantId, predicate, dst);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_where_to_hook_materialization">9.2.5. Where to hook materialization</h4>
<div class="ulist">
<ul>
<li>
<p>On entity changes that are sources or intermediates for chains:</p>
</li>
<li>
<p>Order (placedBy, orderHasShipment), Customer (memberOf), Shipment (shipsTo), Address (locatedIn), Organization (ancestorOf/parent), and any Fulfillment/Returns entities.</p>
</li>
<li>
<p>Recommended patterns:</p>
</li>
<li>
<p>On-save/on-update hooks in your service layer call OntologyMaterializer.apply(&#8230;&#8203;) with the explicit edges known from the entity snapshot.</p>
</li>
<li>
<p>For intermediates (e.g., Address.region changed), enqueue affected sources for recomputation; use provenance to locate impacted edges.</p>
</li>
<li>
<p>Provide nightly/backfill jobs for recomputing edges across a tenant when ontology rules evolve.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_security_and_multi_tenant_considerations">9.2.6. Security and multi-tenant considerations</h4>
<div class="ulist">
<ul>
<li>
<p>Edge rows include tenantId and should be validated/filtered by tenant on every operation.</p>
</li>
<li>
<p>Never trust a client-supplied predicate or destination id blindly; combine with rule evaluation and whitelist allowed predicates per domain if needed.</p>
</li>
<li>
<p>For shared resources across tenants (rare), model cross-tenant permissions at the policy layer; dont reuse edges across tenants unless explicitly designed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_developer_workflow_and_dx_checklist">9.2.7. Developer workflow and DX checklist</h4>
<div class="ulist">
<ul>
<li>
<p>When writing a rule: use hasEdge("&lt;predicate&gt;", &lt;rhs&gt;) and rely on RuleContext variables for the destination when possible.</p>
</li>
<li>
<p>When writing a list endpoint: read optional ontology filter hints from the policy layer; if present, apply ensureHasEdge(&#8230;&#8203;) before find().</p>
</li>
<li>
<p>When changing domain relationships: update predicates/chains and re-materialize; list/policy code stays unchanged.</p>
</li>
<li>
<p>When indexing a new tenant: include the edges indexes early and validate via a smoke test query using ListQueryRewriter.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cookbook_end_to_end_example_with_orders_org">9.2.8. Cookbook: end-to-end example with Orders + Org</h4>
<div class="ulist">
<ul>
<li>
<p>Policy: allow LIST Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Request lifecycle:
1) Security filter builds SecurityContext and RuleContext with tenantId and principal.
2) Policy evaluation returns a directive to constrain by hasEdge("placedInOrg", orgRefName).
3) Repo builds base filter (state != ARCHIVED, etc.).
4) Repo calls OntologyFilterHelper.ensureHasEdge(base, tenantId, "placedInOrg", orgRefName).
5) Mongo executes a single-hop query using materialized edges; results respect both policy and multi-tenancy.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_migration_notes_for_teams_using_reference">9.2.9. Migration notes for teams using @Reference</h4>
<div class="ulist">
<ul>
<li>
<p>Keep existing references for write-side integrity and local joins where simple.</p>
</li>
<li>
<p>Introduce ontology edges on hot read paths first; update policy rules to hasEdge and verify results.</p>
</li>
<li>
<p>Gradually replace deep $lookup traversals with hasEdge-based rewrites.</p>
</li>
<li>
<p>Ensure materialization hooks are deployed before removing data fields used as inputs to the ontology.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.2.3<br>
Last updated 2025-11-02 16:28:17 -0500
</div>
</div>
</body>
</html>