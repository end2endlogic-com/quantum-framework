<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</h1>
<div class="details">
<span id="revnumber">version 1.2.2-SNAPSHOT,</span>
<span id="revdate">2025-10-29T20:43:14Z</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#ontologies-in-quantum">1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</a>
<ul class="sectlevel2">
<li><a href="#_what_is_an_ontology">1.1. What is an Ontology?</a></li>
<li><a href="#_ontology_vs_object_model">1.2. Ontology vs. Object Model</a></li>
<li><a href="#_why_prefer_ontology_driven_relationships_over_referenceentityreference">1.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</a></li>
<li><a href="#_how_quantum_supports_ontologies">1.4. How Quantum supports Ontologies</a></li>
<li><a href="#_modeling_guidance_from_object_fields_to_predicates">1.5. Modeling guidance: from object fields to predicates</a></li>
<li><a href="#_querying_with_ontology_edges_vs_direct_references">1.6. Querying with ontology edges vs direct references</a></li>
<li><a href="#_migration_from_reference_to_ontology_edges">1.7. Migration: from @Reference to ontology edges</a></li>
<li><a href="#_performance_and_operational_notes">1.8. Performance and operational notes</a></li>
<li><a href="#_how_this_integrates_with_functional_areasdomains">1.9. How this integrates with Functional Areas/Domains</a></li>
<li><a href="#_summary">1.10. Summary</a></li>
</ul>
</li>
<li><a href="#ontology-ecommerce-example">2. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</a></li>
<li><a href="#ontology-integration-morphia-permissions">3. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</a>
<ul class="sectlevel2">
<li><a href="#_big_picture_where_ontology_fits">3.1. Big picture: where ontology fits</a></li>
<li><a href="#_rule_language_add_hasedge">3.2. Rule language: add hasEdge()</a></li>
<li><a href="#_passing_tenantid_correctly">3.3. Passing tenantId correctly</a></li>
<li><a href="#_morphia_repository_integration_patterns">3.4. Morphia repository integration patterns</a></li>
<li><a href="#_where_ontology_materialization_happens">3.5. Where ontology materialization happens</a>
<ul class="sectlevel3">
<li><a href="#_configuration">3.5.1. Configuration</a></li>
<li><a href="#_example_annotate_and_save_edges_are_materialized_automatically">3.5.2. Example: annotate and save — edges are materialized automatically</a></li>
</ul>
</li>
<li><a href="#_security_and_multi_tenant_considerations">3.6. Security and multi-tenant considerations</a></li>
<li><a href="#_developer_workflow_and_dx_checklist">3.7. Developer workflow and DX checklist</a></li>
<li><a href="#_cookbook_end_to_end_example_with_orders_org">3.8. Cookbook: end-to-end example with Orders + Org</a></li>
<li><a href="#_migration_notes_for_teams_using_reference">3.9. Migration notes for teams using @Reference</a></li>
</ul>
</li>
<li><a href="#_primer_first_time_guide_to_core_relationship_semantics">4. Primer: First-time guide to core relationship semantics</a></li>
<li><a href="#_new_ontology_features_in_this_release">5. New ontology features in this release</a>
<ul class="sectlevel2">
<li><a href="#_feature_overview">5.1. Feature overview</a></li>
<li><a href="#_business_problems_solved">5.2. Business problems solved</a></li>
<li><a href="#_how_to_code_it_with_current_apis">5.3. How to code it with current APIs</a>
<ul class="sectlevel3">
<li><a href="#_1_define_ontology_programmatic_tbox">5.3.1. 1) Define ontology (programmatic TBox)</a></li>
<li><a href="#_2_materialize_inferences_when_data_changes">5.3.2. 2) Materialize inferences when data changes</a></li>
<li><a href="#_3_query_with_listqueryrewriter_quarkusmorphia">5.3.3. 3) Query with ListQueryRewriter (Quarkus/Morphia)</a></li>
<li><a href="#_functional_properties_at_write_time">5.3.4. Functional properties at write time</a></li>
</ul>
</li>
<li><a href="#_backward_compatibility_and_migration">5.4. Backward compatibility and migration</a></li>
<li><a href="#_troubleshooting_and_tips">5.5. Troubleshooting and tips</a></li>
</ul>
</li>
<li><a href="#_model_first_ontology_with_annotations_and_morphiaontologyloader">6. Model-first ontology with annotations and MorphiaOntologyLoader</a>
<ul class="sectlevel2">
<li><a href="#_why_model_first">6.1. Why model-first?</a></li>
<li><a href="#_annotations_overview">6.2. Annotations overview</a>
<ul class="sectlevel3">
<li><a href="#ontology-relationships">6.2.1. Relationship semantics on @OntologyProperty</a></li>
<li><a href="#ontology-cascading">6.2.2. Cascading policies for relationships</a></li>
<li><a href="#ontology-benefits-relationships">6.2.3. Business benefits of ontology relationships and cascade</a></li>
</ul>
</li>
<li><a href="#_example_orders_placed_in_an_organization_e_commerce">6.3. Example: Orders placed in an Organization (e-commerce)</a></li>
<li><a href="#_how_the_registry_is_produced_quarkus_cdi">6.4. How the registry is produced (Quarkus CDI)</a></li>
<li><a href="#_materializing_inferences_from_annotated_models">6.5. Materializing inferences from annotated models</a></li>
<li><a href="#_querying_using_listqueryrewriter_unchanged">6.6. Querying using ListQueryRewriter (unchanged)</a></li>
<li><a href="#_business_case_recipes_with_annotations">6.7. Business case recipes with annotations</a></li>
<li><a href="#_troubleshooting">6.8. Troubleshooting</a></li>
<li><a href="#_migration_strategy">6.9. Migration strategy</a></li>
<li><a href="#_modeling_guidance_annotate_existing_idreference_getters_keep_api_and_db_clean">6.10. Modeling guidance: annotate existing id/reference getters (keep API and DB clean)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="ontologies-in-quantum">1. Ontologies in Quantum: Modeling Relationships That Are Resilient and Fast</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Looking for the short implementation plan? See PROPOSAL.md at the repository root for a concise module-by-module checklist.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section explains what an ontology is, how it differs from a traditional object model, and how the Quantum Ontology modules make it practical to apply ontology ideas to your domain models and queries. It also contrasts ontology-driven relationships with direct object references (for example, using @Reference or EntityReference).</p>
</div>
<div class="sect2">
<h3 id="_what_is_an_ontology">1.1. What is an Ontology?</h3>
<div class="paragraph">
<p>In software terms, an ontology is a formal, explicit specification of concepts and their relationships.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concepts (Classes): Named categories/types in your domain. Concepts can form taxonomies (is-a hierarchies), be declared disjoint, or be equivalent.</p>
</li>
<li>
<p>Relationships (Properties): Named relationships between entities. Properties can have a domain (applies to X) and a range (points to Y). They may be inverse or transitive.</p>
</li>
<li>
<p>Axioms (Rules): Constraints and entailment rules, including property chains such as: if (A --p-&#8594; B) and (B --q-&#8594; C) then we infer (A --r-&#8594; C).</p>
</li>
<li>
<p>Inference: The process of deriving new facts (types, labels, edges) that were not explicitly stored but follow from axioms and known facts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An ontology is not the data; it is the schema plus logic that gives your data additional meaning and enables consistent, automated inferences.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ontology_vs_object_model">1.2. Ontology vs. Object Model</h3>
<div class="paragraph">
<p>A conventional object model focuses on concrete classes, fields, and direct references between objects at implementation time. An ontology focuses on semantic types and relationships, with explicit rules that can derive new knowledge independent of how objects are instantiated.</p>
</div>
<div class="paragraph">
<p>Key differences:
- Purpose
  - Object model: Encapsulate data and behavior for application code generation and persistence.
  - Ontology: Encode shared meaning, constraints, and inference rules that remain stable as implementation details change.
- Relationship handling
  - Object model: Typically uses direct references or foreign keys; traversals are hard-coded and fragile to change.
  - Ontology: Uses named predicates (properties) and can infer additional relationships by rules (property chains, inverses, transitivity).
- Polymorphism and evolution
  - Object model: Polymorphism requires class inheritance in code; cross-cutting categories are awkward to add later.
  - Ontology: Entities can have multiple types/labels at once. New concepts and properties can be introduced without breaking existing data.
- Querying
  - Object model: Queries couple to concrete classes and field paths; changes force query rewrites.
  - Ontology: Queries target semantic relationships; reasoners can materialize edges that queries reuse, decoupling queries from implementation details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_prefer_ontology_driven_relationships_over_referenceentityreference">1.3. Why prefer Ontology-driven relationships over @Reference/EntityReference</h3>
<div class="paragraph">
<p>Direct references (@Reference or custom EntityReference) are simple to start but become restrictive as domains grow:
- Tight coupling: Code and queries couple to concrete field paths (customer.primaryAddress.id), making refactors risky.
- Limited expressivity: Hard to encode and reuse higher-order relationships (e.g., "partners of my supplier&#8217;s parent org").
- Poor polymorphism: References point to one collection/type; accommodating multiple target types requires extra code.
- Performance pitfalls: Deep traversals cause extra queries, N+1 selects, or complex $lookup joins.</p>
</div>
<div class="paragraph">
<p>Ontology-driven edges address these issues:
- Decoupling via predicates: Use named predicates (e.g., hasAddress, memberOf, supplies) that remain stable while internal object fields change.
- Inference for reachability: Property chains can materialize implied links (A --p-&#8594; B &amp; B --q-&#8594; C &#8658; A --r-&#8594; C), avoiding runtime multi-hop traversals.
- Polymorphism-first: A predicate can connect heterogeneous types; type inferences (domain/range) remain consistent.
- Query performance: Pre-materialized edges allow single-hop, index-friendly queries (in or eq filters) instead of ad-hoc multi-collection traversals.
- Resilience to change: You can add or modify rules without rewriting data structures or touching referencing fields across models.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_quantum_supports_ontologies">1.4. How Quantum supports Ontologies</h3>
<div class="paragraph">
<p>Quantum provides three cooperating modules that make ontology modeling practical and fast:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quantum-ontology-core (package com.e2eq.ontology.core)</p>
</li>
<li>
<p>OntologyRegistry: Holds the TBox (terminology) of your ontology.</p>
</li>
<li>
<p>ClassDef: Concept names and relationships (parents, disjointWith, sameAs).</p>
</li>
<li>
<p>PropertyDef: Property names with optional domain, range, inverse flags, and transitivity.</p>
</li>
<li>
<p>PropertyChainDef: Rules that define multi-hop implications (chains &#8594; implied property).</p>
</li>
<li>
<p>TBox: Container for classes, properties, and property chains.</p>
</li>
<li>
<p>Reasoner interface and ForwardChainingReasoner: Given an entity snapshot and the registry, computes inferences:</p>
</li>
<li>
<p>New types/labels to assert on entities.</p>
</li>
<li>
<p>New edges to add (implied by property chains, inverses, or other rules).</p>
</li>
<li>
<p>quantum-ontology-mongo (package com.e2eq.ontology.mongo)</p>
</li>
<li>
<p>EdgeDao: A thin DAO around an edges collection in Mongo. Each edge contains tenantId, src, predicate p, dst, inferred flag, provenance, and timestamp.</p>
</li>
<li>
<p>OntologyMaterializer: Runs the Reasoner for an entity snapshot and upserts the inferred edges, so queries can be rewritten to simple in/in eq filters.</p>
</li>
<li>
<p>quantum-ontology-policy-bridge (package com.e2eq.ontology.policy)</p>
</li>
<li>
<p>ListQueryRewriter: Takes a base query and rewrites it using the EdgeDao to filter by the set of source entity ids that have a specific predicate to a given destination.</p>
</li>
<li>
<p>This integrates ontology edges with RuleContext or policy decisions: policy asks for entities related by a predicate; the rewriter converts that into an efficient Mongo query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These modules let you define your ontology (core), materialize derived relations (mongo), and leverage them in access and list queries (policy bridge).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Quarkus, all ontology components are CDI-managed. Inject EdgeDao and services via @Inject; indexes are ensured automatically at startup by OntologyMongoProducers. Configure collection/database with properties ontology.mongo.database and ontology.mongo.collection.edges.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modeling_guidance_from_object_fields_to_predicates">1.5. Modeling guidance: from object fields to predicates</h3>
<div class="ulist">
<ul>
<li>
<p>Name relationships explicitly</p>
</li>
<li>
<p>Define clear predicate names (hasAddress, memberOf, supplies, owns, assignedTo). Avoid encoding relationship semantics in field names only.</p>
</li>
<li>
<p>Keep object model minimal and flexible</p>
</li>
<li>
<p>Store lightweight identifiers (ids) as needed, but avoid deeply nested reference graphs that encode traversals in code.</p>
</li>
<li>
<p>Model polymorphic relationships</p>
</li>
<li>
<p>Prefer predicates that naturally connect multiple possible types (e.g., assignedTo can target User, Team, Bot) and rely on ontology type assertions to constrain where needed.</p>
</li>
<li>
<p>Use property chains for common paths</p>
</li>
<li>
<p>If business logic often traverses A &#8594; B &#8594; C, define a chain p∘q ⇒ r and materialize r for faster queries and simpler policies.</p>
</li>
<li>
<p>Capture inverses and transitivity</p>
</li>
<li>
<p>For natural inverses (parentOf ⇄ childOf) or transitive relations (partOf, locatedIn), define them in the ontology so edges and queries stay consistent.</p>
</li>
<li>
<p>Keep provenance</p>
</li>
<li>
<p>Record why an edge exists (prov.rule, prov.inputs) so you can recompute, audit, or retract when inputs change.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_querying_with_ontology_edges_vs_direct_references">1.6. Querying with ontology edges vs direct references</h3>
<div class="ulist">
<ul>
<li>
<p>Direct reference example (fragile/slow)</p>
</li>
<li>
<p>Query: "Find Orders whose buyer belongs to Org X or its parents."</p>
</li>
<li>
<p>With @Reference: requires joining Order &#8594; User &#8594; Org and recursing org.parent; costly and tightly coupled to fields.</p>
</li>
<li>
<p>Ontology edge example (resilient/fast)</p>
</li>
<li>
<p>Define predicates: placedBy(order, user), memberOf(user, org), ancestorOf(org, org). Define chain placedBy ∘ memberOf ⇒ placedInOrg.</p>
</li>
<li>
<p>Materialize edges: (order --placedInOrg-&#8594; org). Also make ancestorOf transitive.</p>
</li>
<li>
<p>Query becomes: where order._id in EdgeDao.srcIdsByDst(tenantId, "placedInOrg", orgX).</p>
</li>
<li>
<p>With transitivity, you can precompute ancestor closure or add a chain placedInOrg ∘ ancestorOf ⇒ placedInOrg to include parents automatically.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_from_reference_to_ontology_edges">1.7. Migration: from @Reference to ontology edges</h3>
<div class="ulist">
<ul>
<li>
<p>Start by introducing predicates alongside existing references; do not remove references immediately.</p>
</li>
<li>
<p>Materialize edges for hot read paths; keep provenance so you can reconstruct.</p>
</li>
<li>
<p>Gradually update queries (list screens, policy filters) to use ListQueryRewriter with EdgeDao instead of deep traversals or $lookup.</p>
</li>
<li>
<p>Once stable, you can simplify models by removing rigid reference fields where unnecessary and rely on edges for read-side composition.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_performance_and_operational_notes">1.8. Performance and operational notes</h3>
<div class="ulist">
<ul>
<li>
<p>Indexing: Create compound indexes on edges: (tenantId, p, dst) and (tenantId, src, p) to support both reverse and forward lookups.</p>
</li>
<li>
<p>Write amplification vs read wins: Materialization adds write work, but dramatically improves read latency and simplifies queries.</p>
</li>
<li>
<p>Consistency: Re-materialize edges on relevant entity changes (source, destination, or intermediate) using OntologyMaterializer.</p>
</li>
<li>
<p>Multi-tenancy: Keep tenantId in the edge key and filters; the provided EdgeDao methods include tenant scoping.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_this_integrates_with_functional_areasdomains">1.9. How this integrates with Functional Areas/Domains</h3>
<div class="ulist">
<ul>
<li>
<p>Functional domains often map to concept clusters in the ontology. Use @FunctionalMapping to aid discovery and apply policies per area/domain.</p>
</li>
<li>
<p>Policies can refer to relationships semantically ("hasEdge placedInOrg OrgX") and rely on the policy bridge to turn this into efficient data filters.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary">1.10. Summary</h3>
<div class="ulist">
<ul>
<li>
<p>Ontology-powered relationships provide a stable, semantic layer over your object model.</p>
</li>
<li>
<p>The Quantum Ontology modules let you define, infer, and query these relationships efficiently on MongoDB.</p>
</li>
<li>
<p>Compared with direct @Reference/EntityReference, ontology edges are more expressive, resilient to change, and typically faster for complex list/policy queries once materialized.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-ecommerce-example">2. Concrete example: Sales Orders, Shipments, and evolving to Fulfillment/Returns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example shows how to use an ontology to model relationships around Orders, Customers, and Shipments, and how the model can evolve to include Fulfillment and Returns without breaking existing queries. We will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define core concepts and predicates.</p>
</li>
<li>
<p>Add property chains that materialize implied relationships for fast queries.</p>
</li>
<li>
<p>Show how queries are rewritten using edges instead of deep object traversals.</p>
</li>
<li>
<p>Evolve the model to support Fulfillment and Returns with minimal changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core concepts (classes)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Order, Customer, Organization, Shipment, Address, Region</p>
</li>
<li>
<p>Later evolution: FulfillmentTask, FulfillmentUnit, ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key predicates (relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy(order, customer): who placed the order</p>
</li>
<li>
<p>memberOf(customer, org): a customer belongs to an organization (or account)</p>
</li>
<li>
<p>orderHasShipment(order, shipment): outbound shipment for the order</p>
</li>
<li>
<p>shipsTo(shipment, address): shipment destination</p>
</li>
<li>
<p>locatedIn(address, region): address is located in a Region</p>
</li>
<li>
<p>ancestorOf(org, org): organizational ancestry (transitive)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Property chains (implied relationships)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>placedBy ∘ memberOf ⇒ placedInOrg</p>
</li>
<li>
<p>If (order --placedBy-&#8594; customer) and (customer --memberOf-&#8594; org), then infer (order --placedInOrg-&#8594; org)</p>
</li>
<li>
<p>orderHasShipment ∘ shipsTo ⇒ orderShipsTo</p>
</li>
<li>
<p>If (order --orderHasShipment-&#8594; shipment) and (shipment --shipsTo-&#8594; address), infer (order --orderShipsTo-&#8594; address)</p>
</li>
<li>
<p>orderShipsTo ∘ locatedIn ⇒ orderShipsToRegion</p>
</li>
<li>
<p>If (order --orderShipsTo-&#8594; address) and (address --locatedIn-&#8594; region), infer (order --orderShipsToRegion-&#8594; region)</p>
</li>
<li>
<p>placedInOrg ∘ ancestorOf ⇒ placedInOrg</p>
</li>
<li>
<p>Makes placedInOrg resilient to org hierarchy changes (ancestorOf is transitive). This is a common “closure” trick: re-assert the same predicate via chain to absorb hierarchy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A minimal Java-style snippet to define this TBox</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util</span>.*;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.core.OntologyRegistry</span>.*;

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, PropertyDef&gt; props = <span class="predefined-type">Map</span>.of(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Shipment</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">true</span>), <span class="comment">// transitive</span>
  <span class="comment">// implied predicates (no domain/range required, but you may add them for validation)</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> PropertyDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Region</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(), <span class="predefined-constant">false</span>)
);

<span class="predefined-type">List</span>&lt;PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderHasShipment</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">shipsTo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsTo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">locatedIn</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>),
  <span class="keyword">new</span> PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
);

OntologyRegistry.TBox tbox = <span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains);
OntologyRegistry registry = OntologyRegistry.inMemory(tbox);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Materializing edges for an Order</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit facts for order O1:</p>
</li>
<li>
<p>O1 placedBy C9</p>
</li>
<li>
<p>C9 memberOf OrgA</p>
</li>
<li>
<p>O1 orderHasShipment S17</p>
</li>
<li>
<p>S17 shipsTo Addr42</p>
</li>
<li>
<p>Addr42 locatedIn RegionWest</p>
</li>
<li>
<p>OrgA ancestorOf OrgParent</p>
</li>
<li>
<p>Inferred edges after running the reasoner for O1’s snapshot:</p>
</li>
<li>
<p>O1 placedInOrg OrgA</p>
</li>
<li>
<p>O1 placedInOrg OrgParent (via closure with ancestorOf)</p>
</li>
<li>
<p>O1 orderShipsTo Addr42</p>
</li>
<li>
<p>O1 orderShipsToRegion RegionWest</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How queries become simple and fast</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders for Organization OrgParent (including children):</p>
</li>
<li>
<p>Instead of joining Order &#8594; Customer &#8594; Org and recursing org.parent, run a single filter using materialized edges.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.mongodb.client.model.Filters</span>;
<span class="keyword">import</span> <span class="include">org.bson.conversions.Bson</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.policy.ListQueryRewriter</span>;

Bson base = Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
Bson rewritten = rewriter.rewriteForHasEdge(base, tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Use rewritten in your Mongo find</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson rewritten2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">orderShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why this is resilient</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If tomorrow Customer becomes AccountContact and the organization model gains Divisions and multi-parent org graphs, you only adjust predicates and chains.</p>
</li>
<li>
<p>Queries that rely on placedInOrg or orderShipsToRegion remain unchanged and fast, because edges are re-materialized by OntologyMaterializer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evolving the model: add Fulfillment</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FulfillmentTask: a unit of work to pick/pack/ship order lines</p>
</li>
<li>
<p>FulfillmentUnit: a logical grouping (e.g., wave, tote, parcel)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills(task, order)</p>
</li>
<li>
<p>realizedBy(order, fulfillmentUnit)</p>
</li>
<li>
<p>taskProduces(task, shipment)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fulfills ⇒ derived edge from task to order; combine with taskProduces to connect order to shipment without touching Order fields:</p>
</li>
<li>
<p>fulfills ∘ taskProduces ⇒ orderHasShipment</p>
</li>
<li>
<p>realizedBy ∘ orderHasShipment ⇒ fulfilledByUnit</p>
</li>
<li>
<p>If (order --realizedBy-&#8594; fu) and (order --orderHasShipment-&#8594; s) ⇒ (fu --fulfillsShipment-&#8594; s) or simply (order --fulfilledByUnit-&#8594; fu)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These chains let you introduce warehouse concepts without changing how UI filters orders by organization or ship-to region. Existing queries still operate via placedInOrg and orderShipsToRegion.</p>
</div>
<div class="paragraph">
<p>Evolving further: add Returns</p>
</div>
<div class="paragraph">
<p>New concepts</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ReturnRequest, ReturnItem, RMA</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New predicates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn(order, returnRequest)</p>
</li>
<li>
<p>returnFor(returnItem, order)</p>
</li>
<li>
<p>returnRma(returnRequest, rma)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New chains (implied)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hasReturn ⇒ openReturnOnOrg via placedInOrg:</p>
</li>
<li>
<p>hasReturn ∘ placedInOrg ⇒ returnPlacedInOrg</p>
</li>
<li>
<p>returnFor ∘ orderShipsToRegion ⇒ returnShipsToRegion</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example queries with new capabilities</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List Orders with open returns in OrgParent:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnPlacedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OrgParent</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Returns associated to Orders shipping to RegionWest:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson r2 = rewriter.rewriteForHasEdge(Filters.empty(), tenantId, <span class="string"><span class="delimiter">&quot;</span><span class="content">returnShipsToRegion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RegionWest</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comparison with direct references (@Reference/EntityReference)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With direct references you would encode fields like Order.customer, Order.shipments, Shipment.address, Address.region and then implement multi-hop traversals in code or $lookup pipelines, rewriting them whenever you add Fulfillment or Returns.</p>
</li>
<li>
<p>With ontology edges, you keep predicates stable and add property chains. Existing list and policy queries keep working and typically become faster due to single-hop filters on an indexed edges collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Operational tips for this scenario</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure EdgeDao has indexes on (tenantId, p, dst) and (tenantId, src, p).</p>
</li>
<li>
<p>Use OntologyMaterializer when Order, Shipment, Customer, Address, or org hierarchy changes to keep edges fresh.</p>
</li>
<li>
<p>Keep provenance in edge.prov (rule, inputs) so you can recompute or retract edges when source data changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ontology-integration-morphia-permissions">3. Integrating Ontology with Morphia, Permissions, and Multi-tenancy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section focuses on integration and developer experience: how ontology edges flow into Morphia-based repositories and the permission rule language, while remaining fully multi-tenant and secure.</p>
</div>
<div class="sect2">
<h3 id="_big_picture_where_ontology_fits">3.1. Big picture: where ontology fits</h3>
<div class="ulist">
<ul>
<li>
<p>Write path (materialization):</p>
</li>
<li>
<p>Your domain code persists entities with minimal direct references.</p>
</li>
<li>
<p>An OntologyMaterializer runs when entities change to derive and upsert edges into the edges collection (per tenant).</p>
</li>
<li>
<p>Policy path (authorization and list filters):</p>
</li>
<li>
<p>The permission rule language evaluates the caller’s SecurityContext/RuleContext and produces logical filters.</p>
</li>
<li>
<p>When a rule asks for a semantic relationship (hasEdge), we use ListQueryRewriter + EdgeDao to translate that into efficient Mongo filters over ids.</p>
</li>
<li>
<p>Read path (queries):</p>
</li>
<li>
<p>Morphia repos apply the base data-domain filters and the rewritten ontology constraint to queries, producing fast lists without deep joins.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rule_language_add_hasedge">3.2. Rule language: add hasEdge()</h3>
<div class="paragraph">
<p>We introduce a policy function/operator to reference ontology edges directly from rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signature: hasEdge(predicate, dstIdOrVar)</p>
</li>
<li>
<p>predicate: String name of the ontology predicate (e.g., "placedInOrg", "orderShipsToRegion").</p>
</li>
<li>
<p>dstIdOrVar: Either a concrete id/refName or a variable resolved from RuleContext (e.g., principal.orgRefName, request.region).</p>
</li>
<li>
<p>Semantics: The rule grants/filters entities for which an edge (tenantId, src = entity._id, p = predicate, dst = resolvedDst) exists.</p>
</li>
<li>
<p>Composition: hasEdge can be combined with existing rule clauses (and/or/not) and other filters (states, tags, ownerId, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example rule snippets (illustrative):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow viewing Orders in the caller’s org (including ancestors via ontology closure):</p>
</li>
<li>
<p>allow VIEW Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Restrict list to Orders shipping to a region chosen in request:</p>
</li>
<li>
<p>allow LIST Order when hasEdge("orderShipsToRegion", request.region)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Under the hood, policy evaluation uses ListQueryRewriter.hasEdge(&#8230;&#8203;), which converts hasEdge into a Morphia Filter limiting _id to the allowed source ids; compose it with your base filter via Filters.and(&#8230;&#8203;).</p>
</div>
</div>
<div class="sect2">
<h3 id="_passing_tenantid_correctly">3.3. Passing tenantId correctly</h3>
<div class="ulist">
<ul>
<li>
<p>Always resolve tenantId from RuleContext/SecurityContext (the same source your repos use for realm/database selection).</p>
</li>
<li>
<p>EdgeDao and ListQueryRewriter already accept tenantId; never cross tenant boundaries when reading edges.</p>
</li>
<li>
<p>Index recommendation (per tenant):</p>
</li>
<li>
<p>(tenantId, p, dst)</p>
</li>
<li>
<p>(tenantId, src, p)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_morphia_repository_integration_patterns">3.4. Morphia repository integration patterns</h3>
<div class="paragraph">
<p>The goal is zero-friction usage in existing repos without invasive changes.</p>
</div>
<div class="paragraph">
<p>Option A: Apply ontology constraints in code paths that already construct BSON filters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your repo method builds a Bson filter before calling find(), wrap it through rewriter:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Bson base = Filters.and(existingFilters...);
Bson rewritten = hasEdgeRequested
  ? rewriter.rewriteForHasEdge(base, tenantId, predicate, dst)
  : base;
<span class="type">var</span> cursor = datastore.getDatabase().getCollection(coll).find(rewritten);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option B: Apply ontology constraints to Morphia Filter/Query via ids.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the repo uses Morphia’s typed query API instead of BSON, pre-compute the id set and constrain by _id:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; ids = edgeDao.srcIdsByDst(tenantId, predicate, dst);
<span class="keyword">if</span> (ids.isEmpty()) {
  <span class="keyword">return</span> <span class="predefined-type">List</span>.of(); <span class="comment">// short-circuit</span>
}
query.filter(Filters.in(<span class="string"><span class="delimiter">&quot;</span><span class="content">_id</span><span class="delimiter">&quot;</span></span>, ids));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option C: Centralize in a tiny helper for developer ergonomics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide one helper in your application layer, invoked wherever policies inject additional constraints:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">OntologyFilterHelper</span> {
  <span class="directive">private</span> <span class="directive">final</span> ListQueryRewriter rewriter;
  <span class="directive">public</span> OntologyFilterHelper(ListQueryRewriter r) { <span class="local-variable">this</span>.rewriter = r; }

  <span class="directive">public</span> Bson ensureHasEdge(Bson base, <span class="predefined-type">String</span> tenantId, <span class="predefined-type">String</span> predicate, <span class="predefined-type">String</span> dst) {
    <span class="keyword">return</span> rewriter.rewriteForHasEdge(base, tenantId, predicate, dst);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_where_ontology_materialization_happens">3.5. Where ontology materialization happens</h3>
<div class="ulist">
<ul>
<li>
<p>Automatic on write via repository hook:</p>
</li>
<li>
<p>When you save or update an entity, the framework runs an internal PostPersistHook (OntologyWriteHook) that:</p>
</li>
<li>
<p>extracts explicit edges from fields/getters annotated with @OntologyProperty using a startup-built metadata cache (no per-call reflection), and</p>
</li>
<li>
<p>calls OntologyMaterializer to infer inverse, transitive, symmetric, and super-property edges and upsert them to the edges collection.</p>
</li>
<li>
<p>This is enabled by default. To disable temporarily (e.g., for bulk loads), set: ontology.auto-materialize=false</p>
</li>
<li>
<p>Intermediates and re-materialization:</p>
</li>
<li>
<p>If you change entities that are not the source but affect chains (e.g., Address.region, Customer.memberOf), those sources will get updated the next time they are saved. For immediate consistency across a tenant, run the re-materialization job (see below).</p>
</li>
<li>
<p>Provide nightly/backfill jobs for recomputing edges across a tenant when ontology rules evolve.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_configuration">3.5.1. Configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># default is true
ontology.auto-materialize=true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_annotate_and_save_edges_are_materialized_automatically">3.5.2. Example: annotate and save — edges are materialized automatically</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> {
  <span class="directive">private</span> <span class="predefined-type">String</span> refName;

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> Customer getCustomer() { <span class="keyword">return</span> customer; }
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {
  <span class="directive">private</span> <span class="predefined-type">String</span> refName;

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">public</span> Organization getOrg() { <span class="keyword">return</span> org; }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Saving an Order will automatically create explicit placedBy and, via chains/inference, placedInOrg and inverse edges as defined in your ontology registry. No manual calls to OntologyMaterializer.apply(&#8230;&#8203;) are required.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_security_and_multi_tenant_considerations">3.6. Security and multi-tenant considerations</h3>
<div class="ulist">
<ul>
<li>
<p>Edge rows include tenantId and should be validated/filtered by tenant on every operation.</p>
</li>
<li>
<p>Never trust a client-supplied predicate or destination id blindly; combine with rule evaluation and whitelist allowed predicates per domain if needed.</p>
</li>
<li>
<p>For shared resources across tenants (rare), model cross-tenant permissions at the policy layer; don’t reuse edges across tenants unless explicitly designed.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_developer_workflow_and_dx_checklist">3.7. Developer workflow and DX checklist</h3>
<div class="ulist">
<ul>
<li>
<p>When writing a rule: use hasEdge("&lt;predicate&gt;", &lt;rhs&gt;) and rely on RuleContext variables for the destination when possible.</p>
</li>
<li>
<p>When writing a list endpoint: read optional ontology filter hints from the policy layer; if present, apply ensureHasEdge(&#8230;&#8203;) before find().</p>
</li>
<li>
<p>When changing domain relationships: update predicates/chains and re-materialize; list/policy code stays unchanged.</p>
</li>
<li>
<p>When indexing a new tenant: include the edges indexes early and validate via a smoke test query using ListQueryRewriter.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cookbook_end_to_end_example_with_orders_org">3.8. Cookbook: end-to-end example with Orders + Org</h3>
<div class="ulist">
<ul>
<li>
<p>Policy: allow LIST Order when hasEdge("placedInOrg", principal.orgRefName)</p>
</li>
<li>
<p>Request lifecycle:
1) Security filter builds SecurityContext and RuleContext with tenantId and principal.
2) Policy evaluation returns a directive to constrain by hasEdge("placedInOrg", orgRefName).
3) Repo builds base filter (state != ARCHIVED, etc.).
4) Repo calls OntologyFilterHelper.ensureHasEdge(base, tenantId, "placedInOrg", orgRefName).
5) Mongo executes a single-hop query using materialized edges; results respect both policy and multi-tenancy.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_notes_for_teams_using_reference">3.9. Migration notes for teams using @Reference</h3>
<div class="ulist">
<ul>
<li>
<p>Keep existing references for write-side integrity and local joins where simple.</p>
</li>
<li>
<p>Introduce ontology edges on hot read paths first; update policy rules to hasEdge and verify results.</p>
</li>
<li>
<p>Gradually replace deep $lookup traversals with hasEdge-based rewrites.</p>
</li>
<li>
<p>Ensure materialization hooks are deployed before removing data fields used as inputs to the ontology.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_primer_first_time_guide_to_core_relationship_semantics">4. Primer: First-time guide to core relationship semantics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are new to ontology terms, the following quick explanations will help you build intuition. Each concept explains what it means, a tiny example, and how it affects queries using hasEdge.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional property</p>
</li>
<li>
<p>What it means: For a given source entity, there is at most one target for this property. Think “single-valued.”</p>
</li>
<li>
<p>Example: placedBy(Order, Customer) is functional because an Order is placed by exactly one Customer.</p>
</li>
<li>
<p>Why it matters: On writes, the latest value replaces any previous one. In storage, you can enforce uniqueness for (tenantId, src, p). Queries are simpler because there’s at most one matching edge per source.</p>
</li>
<li>
<p>In practice: When you save an Order with a different placedBy, the old edge is replaced so hasEdge("placedBy", customerX) reflects the latest truth.</p>
</li>
<li>
<p>Transitive property</p>
</li>
<li>
<p>What it means: The relationship “chains through” intermediates. If A relates-to B and B relates-to C with the same property p, then A relates-to C by p as well.</p>
</li>
<li>
<p>Example: ancestorOf(Org, Org) is transitive: OrgA ancestorOf OrgB and OrgB ancestorOf OrgC implies OrgA ancestorOf OrgC.</p>
</li>
<li>
<p>Why it matters: You can answer reachability questions without specifying every hop. The system can materialize or compute the closure so queries like hasEdge("ancestorOf", OrgC) return OrgA even if the path is multiple hops.</p>
</li>
<li>
<p>In practice: Use transitive for hierarchies like parent/ancestor, partOf, locatedIn, reportsTo.</p>
</li>
<li>
<p>subPropertyOf (property hierarchy)</p>
</li>
<li>
<p>What it means: One property is a more specific form of another. If p ⊑ q (“p is a sub-property of q”), then every (s, p, o) also counts as (s, q, o).</p>
</li>
<li>
<p>Example: placedInOrg ⊑ inOrg. If an Order is placedInOrg ACME, then it is also inOrg ACME.</p>
</li>
<li>
<p>Why it matters: Queries written against the broader property (q) automatically include results from all its specializations (p). The system may materialize the super-property edges for performance.</p>
</li>
<li>
<p>In practice: You can write policies/queries once for inOrg and still match edges stored as placedInOrg.</p>
</li>
<li>
<p>inverseOf (inverse properties)</p>
</li>
<li>
<p>What it means: Two properties point in opposite directions. If p is the inverse of q, then (s, p, o) implies (o, q, s).</p>
</li>
<li>
<p>Example: parentOf ⇄ childOf. If OrgA parentOf OrgB, then OrgB childOf OrgA.</p>
</li>
<li>
<p>Why it matters: You only need to assert one direction; the system can infer the other. Queries can use whichever direction is natural.</p>
</li>
<li>
<p>In practice: If you stored parentOf, you can still query with hasEdge("childOf", OrgA) and find OrgB once inverses are materialized.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Putting it together
- These traits combine. For example, placedInOrg can be declared a subPropertyOf inOrg; ancestorOf can be transitive; parentOf and childOf can be inverses. The reasoner uses these facts to materialize convenient edges so your queries remain simple and fast.
- Your application code typically continues to use the same three query helpers: hasEdge, hasEdgeAny, notHasEdge. The richer semantics affect which edges exist, not how you call them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_ontology_features_in_this_release">5. New ontology features in this release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This release expands the ontology engine and query integration to support a richer, OWL‑RL–inspired subset while keeping the developer experience simple and backward compatible. The following capabilities are now available and used transparently by the materializer and query rewriter:</p>
</div>
<div class="sect2">
<h3 id="_feature_overview">5.1. Feature overview</h3>
<div class="ulist">
<ul>
<li>
<p>subClassOf (class hierarchy)</p>
</li>
<li>
<p>Model taxonomies (e.g., Order ⊑ Entity, Employee ⊑ Person). Used for validation and optional type filters.</p>
</li>
<li>
<p>subPropertyOf (property hierarchy)</p>
</li>
<li>
<p>If p ⊑ q and you assert (s, p, o), the system materializes (s, q, o). Queries on q will match p’s edges as well.</p>
</li>
<li>
<p>inverse properties</p>
</li>
<li>
<p>If p is the inverse of q, asserting (s, p, o) will materialize (o, q, s). Example: parentOf ⇄ childOf.</p>
</li>
<li>
<p>symmetric properties</p>
</li>
<li>
<p>For symmetric p, asserting (s, p, o) materializes (o, p, s). Example: peerOf between organizations.</p>
</li>
<li>
<p>transitive properties</p>
</li>
<li>
<p>For transitive p, if (s, p, m) and (m, p, o) then (s, p, o) is inferred. Typical for ancestorOf, partOf, locatedIn, memberOf within hierarchical contexts.</p>
</li>
<li>
<p>functional properties</p>
</li>
<li>
<p>For functional p, each source s has at most one destination o. Upserts replace the prior value. Useful for single-valued relations like placedBy on Order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All inferred edges carry inferred=true and provenance containing the rule used (e.g., transitive, inverse, subPropertyOf). These edges live in the same collection and are fully queryable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_business_problems_solved">5.2. Business problems solved</h3>
<div class="ulist">
<ul>
<li>
<p>E‑commerce organizational access</p>
</li>
<li>
<p>Problem: “Show me all orders placed in ACME (including subsidiaries).”</p>
</li>
<li>
<p>Solution: Define placedBy, memberOf, placedInOrg with chain placedBy ∘ memberOf ⇒ placedInOrg, and make ancestorOf transitive. Either materialize closure with a chain placedInOrg ∘ ancestorOf ⇒ placedInOrg or use p being transitive. Queries use hasEdge("placedInOrg", orgId).</p>
</li>
<li>
<p>HR management</p>
</li>
<li>
<p>Problem: “List employees who report to VP_X directly or indirectly.”</p>
</li>
<li>
<p>Solution: Define reportsTo as transitive. Query hasEdge("reportsTo", "VP_X").</p>
</li>
<li>
<p>Third‑party and data lineage</p>
</li>
<li>
<p>Problem: “Which datasets are derived from Source S?”</p>
</li>
<li>
<p>Solution: Define derivedFrom as transitive and inverse derivedInto. Record symmetric peerOf for bidirectional partnerships where relevant.</p>
</li>
<li>
<p>Supplier networks (supply chain)</p>
</li>
<li>
<p>Problem: “Find parts supplied by a vendor’s parent company’s peers.”</p>
</li>
<li>
<p>Solution: Use subPropertyOf to roll up specialized edges into a common supplies predicate, define parentOf/childOf inverses, and peerOf symmetric at the org level.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_code_it_with_current_apis">5.3. How to code it with current APIs</h3>
<div class="paragraph">
<p>Below are concise examples showing how to define the ontology, materialize inferences, and query with existing components. These mirror the types already present in this repository and require no grammar changes.</p>
</div>
<div class="sect3">
<h4 id="_1_define_ontology_programmatic_tbox">5.3.1. 1) Define ontology (programmatic TBox)</h4>
<div class="paragraph">
<p>Java (at startup, e.g., in a CDI producer):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Produces</span> <span class="annotation">@Singleton</span>
<span class="directive">public</span> OntologyRegistry ontologyRegistry() {
  <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, OntologyRegistry.ClassDef&gt; classes = <span class="predefined-type">Map</span>.of(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>,       <span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>,    <span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of()),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>,<span class="keyword">new</span> OntologyRegistry.ClassDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of(), <span class="predefined-type">Set</span>.of())
  );

  <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, OntologyRegistry.PropertyDef&gt; props = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
  <span class="comment">// Single-valued ⇒ functional</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">false</span>, <span class="comment">/*symmetric*/</span> <span class="predefined-constant">true</span> <span class="comment">/*functional*/</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>,<span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>) <span class="comment">// subPropertyOf example</span>
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>,      <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  <span class="comment">// Transitive ancestor relation</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">true</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  <span class="comment">// Inverses and symmetric</span>
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>,   <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>,    <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">true</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-constant">false</span>, <span class="predefined-type">Set</span>.of()
  ));
  props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>,     <span class="keyword">new</span> OntologyRegistry.PropertyDef(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>, Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), Optional.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">false</span>, Optional.empty(),
      <span class="predefined-constant">false</span>, <span class="comment">/*transitive*/</span> <span class="predefined-constant">true</span>, <span class="comment">/*symmetric*/</span> <span class="predefined-constant">false</span>, <span class="comment">/*functional*/</span> <span class="predefined-type">Set</span>.of()
  ));

  <span class="predefined-type">List</span>&lt;OntologyRegistry.PropertyChainDef&gt; chains = <span class="predefined-type">List</span>.of(
      <span class="comment">// Order --placedBy--&gt; Customer --memberOf--&gt; Org  ⇒ Order --placedInOrg--&gt; Org</span>
      <span class="keyword">new</span> OntologyRegistry.PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>),
      <span class="comment">// Include ancestor closure for placedInOrg results</span>
      <span class="keyword">new</span> OntologyRegistry.PropertyChainDef(<span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ancestorOf</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>)
  );

  <span class="keyword">return</span> OntologyRegistry.inMemory(<span class="keyword">new</span> OntologyRegistry.TBox(classes, props, chains));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes:
- subPropertyOf is modeled via the PropertyDef.subPropertyOf set.
- Inverse and symmetric are encoded in PropertyDef.inverseOf and PropertyDef.symmetric.
- Transitivity is toggled via PropertyDef.transitive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_materialize_inferences_when_data_changes">5.3.2. 2) Materialize inferences when data changes</h4>
<div class="paragraph">
<p>Use OntologyMaterializer or call the Reasoner directly and upsert edges via OntologyEdgeRepo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ForwardChainingReasoner reasoner;
<span class="annotation">@Inject</span> OntologyRegistry ontologyRegistry;
<span class="annotation">@Inject</span> OntologyEdgeRepo edgeRepo;

<span class="directive">public</span> <span class="type">void</span> onOrderSaved(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orderId, <span class="predefined-type">String</span> customerId, <span class="predefined-type">String</span> orgId) {
  <span class="predefined-type">List</span>&lt;Reasoner.Edge&gt; explicit = <span class="predefined-type">List</span>.of(
      <span class="keyword">new</span> Reasoner.Edge(orderId, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, customerId, <span class="predefined-constant">false</span>, Optional.empty()),
      <span class="keyword">new</span> Reasoner.Edge(customerId, <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, orgId, <span class="predefined-constant">false</span>, Optional.empty())
  );
  Reasoner.EntitySnapshot snap = <span class="keyword">new</span> Reasoner.EntitySnapshot(tenant, orderId, <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>, explicit);
  Reasoner.InferenceResult out = reasoner.infer(snap, ontologyRegistry);
  <span class="keyword">for</span> (Reasoner.Edge e : out.addEdges()) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Object</span>&gt; prov = e.prov().map(p -&gt; <span class="predefined-type">Map</span>.&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Object</span>&gt;of(<span class="string"><span class="delimiter">&quot;</span><span class="content">rule</span><span class="delimiter">&quot;</span></span>, p.rule(), <span class="string"><span class="delimiter">&quot;</span><span class="content">inputs</span><span class="delimiter">&quot;</span></span>, p.inputs())).orElse(<span class="predefined-type">Map</span>.of());
    edgeRepo.upsert(tenant, e.srcId(), e.p(), e.dstId(), <span class="predefined-constant">true</span>, prov);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The materializer computes and persists:
- subPropertyOf roll‑ups (e.g., placedInOrg ⊑ inOrg ⇒ write inOrg)
- inverse/symmetric counterparts
- transitive closures (bounded to the snapshot inputs; you can also chain for closures)</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_query_with_listqueryrewriter_quarkusmorphia">5.3.3. 3) Query with ListQueryRewriter (Quarkus/Morphia)</h4>
<div class="paragraph">
<p>Use hasEdge/hasEdgeAny/notHasEdge to turn ontology constraints into Morphia filters over your entity collection. The rewriter internally fetches the set of source ids from the edge store and builds an in("refName", …) filter that composes with your attribute predicates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ListQueryRewriter queryRewriter;
<span class="annotation">@Inject</span> MorphiaDatastore datastore;

<span class="directive">public</span> <span class="predefined-type">List</span>&lt;TestOrder&gt; openOrdersIn(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orgId) {
  <span class="type">var</span> status = dev.morphia.query.filters.Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
  <span class="type">var</span> inOrg = queryRewriter.hasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgId);
  <span class="type">var</span> combined = dev.morphia.query.filters.Filters.and(status, inOrg);
  <span class="keyword">return</span> datastore.find(TestOrder.class).filter(combined).iterator().toList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To include multiple orgs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> f = queryRewriter.hasEdgeAny(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-ACME</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-GLOBEX</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To exclude restricted orgs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> f = queryRewriter.notHasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ORG-RESTRICTED</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functional_properties_at_write_time">5.3.4. Functional properties at write time</h4>
<div class="paragraph">
<p>For single‑valued relationships declared functional, configure a unique index over (tenantId, src, p) in your edge store (or rely on repo semantics) and treat upserts as replacements.</p>
</div>
<div class="paragraph">
<p>Practical guidance:
- Mark naturally single‑valued links functional (placedBy, primaryOwner).
- On write, remove or overwrite any prior dst for the same (tenant, src, p).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_backward_compatibility_and_migration">5.4. Backward compatibility and migration</h3>
<div class="ulist">
<ul>
<li>
<p>Grammar/API: No changes needed. The same hasEdge/hasEdgeAny/notHasEdge functions work; results simply become more expressive as ontology features are enabled.</p>
</li>
<li>
<p>Feature flags: You may enable features per property (e.g., transitive) gradually. Queries remain stable.</p>
</li>
<li>
<p>Provenance: Keep prov so you can re‑compute or retract inferred edges when inputs or rules change.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_and_tips">5.5. Troubleshooting and tips</h3>
<div class="ulist">
<ul>
<li>
<p>Empty result from hasEdge: Means no matching edges exist; check whether inferences are being materialized for the predicate you expect.</p>
</li>
<li>
<p>Tenant scoping: All repo calls include tenantId; ensure you pass the correct tenant in both write and read paths.</p>
</li>
<li>
<p>Indexes: For heavy reads, ensure compound indexes on (tenantId, p, dst) and (tenantId, src, p). For functional, consider a unique (tenantId, src, p).</p>
</li>
<li>
<p>Testing: Use Quarkus @QuarkusTest to wire CDI and a test OntologyRegistry producer. Populate explicit edges, run the reasoner, then assert with the repo and query rewriter as shown in the integration tests included with the repository.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_model_first_ontology_with_annotations_and_morphiaontologyloader">6. Model-first ontology with annotations and MorphiaOntologyLoader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows how to use your Morphia model classes as the source of truth for the ontology. You annotate model classes/fields to declare ontology concepts and property traits; at startup, MorphiaOntologyLoader scans MorphiaDatastore.getMapper() to build the OntologyRegistry automatically.</p>
</div>
<div class="sect2">
<h3 id="_why_model_first">6.1. Why model-first?</h3>
<div class="ulist">
<ul>
<li>
<p>Single source of truth: semantics live next to the data model; less drift between code and config.</p>
</li>
<li>
<p>Safer refactors: renames/types evolve in code and the ontology follows.</p>
</li>
<li>
<p>No separate YAML/JSON needed for most use cases; optional overrides remain possible later if needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_annotations_overview">6.2. Annotations overview</h3>
<div class="paragraph">
<p>Two lightweight annotations are used on model classes and fields. They are provided by quantum-ontology-core and can be added to any Morphia-mapped entity (deriving from UnversionedBaseModel).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@OntologyClass</p>
</li>
<li>
<p>id: optional explicit class id (defaults to the simple class name)</p>
</li>
<li>
<p>subClassOf: optional extra parents (in addition to Java inheritance)</p>
</li>
<li>
<p>@OntologyProperty</p>
</li>
<li>
<p>id: optional explicit property id (defaults to the field name)</p>
</li>
<li>
<p>subPropertyOf: property hierarchy roll-up targets</p>
</li>
<li>
<p>inverseOf: name of the inverse property (declare on one side)</p>
</li>
<li>
<p>transitive: whether the property is transitive</p>
</li>
<li>
<p>symmetric: whether the property is symmetric</p>
</li>
<li>
<p>functional: at most one target per source (defaults to true for single-valued fields)</p>
</li>
<li>
<p>domain: override inferred domain (defaults to declaring @OntologyClass)</p>
</li>
<li>
<p>range: override inferred range (defaults to the field/element type)</p>
</li>
<li>
<p>ref: target ontology class id when this field represents a relationship to another ontology type</p>
</li>
<li>
<p>relation: the multiplicity/cardinality for the relationship (NONE, ONE_TO_ONE, ONE_TO_MANY, MANY_TO_ONE, MANY_TO_MANY)</p>
</li>
<li>
<p>edgeType: the edge label used in the ontology graph; if omitted, falls back to id or field name</p>
</li>
<li>
<p>inverseOfEdge: optional inverse edge label if you prefer naming inverses at the edge level</p>
</li>
<li>
<p>materializeEdge: when false, keeps the reference value but skips edge creation (defaults to true)</p>
</li>
<li>
<p>cascade: optional cascade policies (NONE by default). Supports ORPHAN_REMOVE, DELETE, and BLOCK_IF_REFERENCED; see below.</p>
</li>
<li>
<p>cascadeDepth: limit for recursive cascades (default 1); used by DELETE cascades to bound depth and prevent long chains</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
functional is inferred true for single-valued fields and false for collections/maps unless you override it.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="ontology-relationships">6.2.1. Relationship semantics on @OntologyProperty</h4>
<div class="paragraph">
<p>When a field is annotated with @OntologyProperty and declares any of ref, relation, or edgeType, the framework treats it as a relationship and will materialize an ontology edge for it on persist/update.</p>
</div>
<div class="paragraph">
<p>Key attributes:
- ref: Names the target ontology class id. If omitted, the loader attempts to infer it from the Java type of the field or its generic element type.
- relation: Declares multiplicity. If not set, it is inferred from the field type: collections imply plural (ONE_TO_MANY), scalars imply singular (MANY_TO_ONE) by convention.
- edgeType: Controls the predicate id used to write/read edges. If absent, the property id (or field name) is used.
- materializeEdge: Set to false to store the reference value without creating graph edges; traversal and inferences will ignore this property.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Many orders reference one Customer (MANY_TO_ONE); name the edge explicitly</span>
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.MANY_TO_ONE,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOMER_OF</span><span class="delimiter">&quot;</span></span>
  )
  <span class="directive">private</span> <span class="predefined-type">String</span> customerId; <span class="comment">// or Customer if you store the object</span>
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">SCorp</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">scorps</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SCorp</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// One SCorp authorizes many Resolutions</span>
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">resolutionIds</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Resolution</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">AUTHORIZES_RESOLUTION</span><span class="delimiter">&quot;</span></span>
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; resolutionIds;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Runtime materialization (conceptual):
- (Order) -[CUSTOMER_OF]&#8594; (Customer)
- (SCorp) -[AUTHORIZES_RESOLUTION]&#8594; (Resolution)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If ref is provided but edgeType is omitted, the system uses the property id (or field name). Consider using descriptive edge names for durability of queries.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ontology-cascading">6.2.2. Cascading policies for relationships</h4>
<div class="paragraph">
<p>Cascading is opt-in and conservative. It controls what happens to related targets and edges when a relationship is modified or a source is deleted.</p>
</div>
<div class="paragraph">
<p>Supported policies today:
- ORPHAN_REMOVE: On update, when an element is removed from a collection (or a singular reference is replaced), the framework deletes the removed target if and only if no other sources still reference it via the same predicate. This is useful for owned child aggregates.
- UNLINK: Edges are always pruned to reflect the current snapshot; you can think of this as implicit and always-on for edge hygiene.</p>
</div>
<div class="paragraph">
<p>Delete-time cascades (also supported):
- DELETE: When deleting the source, also delete targets up to cascadeDepth with cycle guards. Targets are deleted only for predicates that declare DELETE on the source side.
- BLOCK_IF_REFERENCED: Before deleting a target (either directly or via DELETE cascade), if the target is still referenced by another source via the same predicate, the deletion is skipped (or blocked) to preserve referential integrity.</p>
</div>
<div class="paragraph">
<p>Example (delete children when parent is deleted, with safety guards):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Parent</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Parent</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">HAS_CHILD</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Child</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    cascade = { CascadeType.DELETE, CascadeType.BLOCK_IF_REFERENCED },
    cascadeDepth = <span class="integer">1</span> <span class="comment">// delete only direct children</span>
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Child&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior:
- Deleting a Parent removes explicit edges and, with DELETE, deletes its Child documents up to the specified depth.
- With BLOCK_IF_REFERENCED, a Child that is still referenced by another Parent is not deleted; only the edge from the deleted Parent is removed.
- Cycles are guarded by a visited set; depth prevents long delete chains.</p>
</div>
<div class="paragraph">
<p>See integration tests in the ontology-mongo module (CascadeDeleteIT) for expected behavior.</p>
</div>
<div class="paragraph">
<p>Example (owned children with orphan removal):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Parent</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parents</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Parent</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">children</span><span class="delimiter">&quot;</span></span>,
    edgeType = <span class="string"><span class="delimiter">&quot;</span><span class="content">HAS_CHILD</span><span class="delimiter">&quot;</span></span>,
    ref = <span class="string"><span class="delimiter">&quot;</span><span class="content">Child</span><span class="delimiter">&quot;</span></span>,
    relation = <span class="predefined-type">RelationType</span>.ONE_TO_MANY,
    cascade = { CascadeType.ORPHAN_REMOVE }
  )
  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Child&gt; children = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behavior:
- Persisting a Parent materializes edges (P --HAS_CHILD-&#8594; C) for current children.
- Removing a Child from the collection prunes the edge. If no other Parent points to that Child via HAS_CHILD, the Child entity is deleted.
- If the Child is still referenced by another Parent, it is retained.</p>
</div>
<div class="paragraph">
<p>Verification: See integration tests under quantum-ontology-mongo it module (CascadeOrphanRemoveIT) covering both deletion and shared reference cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="ontology-benefits-relationships">6.2.3. Business benefits of ontology relationships and cascade</h4>
<div class="ulist">
<ul>
<li>
<p>Faster queries and policies: Pre-materialized edges make filtering by relationships a single indexed lookup instead of deep joins or application-side traversals.</p>
</li>
<li>
<p>Safer evolution: Edge names and ontology traits remain stable as you refactor field names/types; queries continue to work.</p>
</li>
<li>
<p>Cleaner models: Relationship intent lives in one place (@OntologyProperty) rather than being scattered across repos and services.</p>
</li>
<li>
<p>Reduced data drift: Automated edge pruning and orphan removal keep the graph consistent with your source-of-truth objects.</p>
</li>
<li>
<p>Auditability: Provenance on inferred edges documents why links exist, aiding debugging and compliance.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_orders_placed_in_an_organization_e_commerce">6.3. Example: Orders placed in an Organization (e-commerce)</h3>
<div class="paragraph">
<p>Below we implement the same business example covered earlier using model annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> status;

  <span class="comment">// Order --placedBy--&gt; Customer (single-valued ⇒ functional)</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Customer placedBy;
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">customers</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Customer --memberOf--&gt; Org (transitive across org tree)</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span>, transitive = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Org memberOf;
}

<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Organization</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Entity</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">orgs</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Org</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Org --parentOf--&gt; Org, with inverse childOf</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">parentOf</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">childOf</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">private</span> Org parent;

  <span class="comment">// Optional symmetric relationship between peers</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">peerOf</span><span class="delimiter">&quot;</span></span>, symmetric = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;Org&gt; peers;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, model a super-property to roll up specialized edges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">private</span> Customer placedBy;

  <span class="comment">// Roll-up predicate for org membership of orders; placedInOrg ⊑ inOrg</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, subPropertyOf = {<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>})
  <span class="directive">private</span> Org inOrgDirect;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these annotations in place, the loader will infer:
- Classes: Order, Customer, Organization (+ hierarchy from Java inheritance)
- Properties: placedBy (functional), memberOf (transitive), parentOf ⇄ childOf (inverse), peerOf (symmetric)
- subPropertyOf: placedInOrg ⊑ inOrg (if declared)</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_the_registry_is_produced_quarkus_cdi">6.4. How the registry is produced (Quarkus CDI)</h3>
<div class="paragraph">
<p>OntologyCoreProducers wires MorphiaOntologyLoader by default. On startup it scans your models and produces a singleton OntologyRegistry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OntologyCoreProducers</span> {
  <span class="annotation">@Inject</span> MorphiaDatastore morphiaDatastore;

  <span class="annotation">@Produces</span> <span class="annotation">@Singleton</span>
  <span class="directive">public</span> OntologyRegistry ontologyRegistry() {
    <span class="keyword">try</span> {
      MorphiaOntologyLoader loader = <span class="keyword">new</span> MorphiaOntologyLoader(morphiaDatastore);
      OntologyRegistry reg = loader.load();
      <span class="keyword">return</span> isEmpty(reg) ? emptyRegistry() : reg;
    } <span class="keyword">catch</span> (<span class="predefined-type">Throwable</span> t) {
      <span class="keyword">return</span> emptyRegistry();
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need manual control (tests, migrations), you can call the loader directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MorphiaOntologyLoader loader = <span class="keyword">new</span> MorphiaOntologyLoader(datastore);
OntologyRegistry registry = loader.load();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Keep annotations minimal. Only add traits that aren’t obvious from the Java type system (e.g., transitive, symmetric, inverse, subPropertyOf).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_materializing_inferences_from_annotated_models">6.5. Materializing inferences from annotated models</h3>
<div class="paragraph">
<p>Materialization is automatic on save/update through the repository hook; you do not need to assemble explicit edge lists or call OntologyMaterializer manually.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What happens:</p>
</li>
<li>
<p>The framework inspects fields/getters annotated with @OntologyProperty and extracts explicit edges.</p>
</li>
<li>
<p>The reasoner applies inverse, symmetric, transitive, and subPropertyOf traits from the registry and upserts inferred edges.</p>
</li>
<li>
<p>When to trigger re-materialization manually:</p>
</li>
<li>
<p>After ontology rule changes (e.g., you mark a property transitive or add an inverse), run your re-materialization job to recompute edges for existing entities in a tenant.</p>
</li>
<li>
<p>During bulk imports, you can disable auto-materialize and run the job afterward.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example: disable auto-materialize for a batch, then rebuild</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">ontology.auto-materialize=false</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> OntologyRebuilder rebuilder; <span class="comment">// your maintenance utility</span>

<span class="directive">public</span> <span class="type">void</span> runBackfill(<span class="predefined-type">String</span> tenantId) {
  rebuilder.recomputeTenant(tenantId);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_querying_using_listqueryrewriter_unchanged">6.6. Querying using ListQueryRewriter (unchanged)</h3>
<div class="paragraph">
<p>Your query code does not change. It benefits from materialized edges that now carry richer semantics from annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span> ListQueryRewriter queryRewriter;
<span class="annotation">@Inject</span> MorphiaDatastore datastore;

<span class="directive">public</span> <span class="predefined-type">List</span>&lt;Order&gt; openOrdersIn(<span class="predefined-type">String</span> tenant, <span class="predefined-type">String</span> orgId) {
  <span class="type">var</span> status = dev.morphia.query.filters.Filters.eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">status</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">OPEN</span><span class="delimiter">&quot;</span></span>);
  <span class="type">var</span> inOrg = queryRewriter.hasEdge(tenant, <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, orgId);
  <span class="type">var</span> combined = dev.morphia.query.filters.Filters.and(status, inOrg);
  <span class="keyword">return</span> datastore.find(Order.class).filter(combined).iterator().toList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To include subsidiaries via ancestor/parent relationships, either:
- Declare ancestorOf as transitive in the model and materialize a closure, or
- Add a property chain placedInOrg ∘ ancestorOf ⇒ placedInOrg in your registry initialization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_business_case_recipes_with_annotations">6.7. Business case recipes with annotations</h3>
<div class="ulist">
<ul>
<li>
<p>E‑commerce org access</p>
</li>
<li>
<p>Annotate placedBy (functional), memberOf (transitive), and optionally parentOf (inverse childOf). Materialize placedInOrg via a property chain. Query hasEdge("placedInOrg", org).</p>
</li>
<li>
<p>HR reporting lines</p>
</li>
<li>
<p>Annotate reportsTo as transitive on Employee; query hasEdge("reportsTo", managerId).</p>
</li>
<li>
<p>Supplier networks</p>
</li>
<li>
<p>Annotate supplies as a base property; use subPropertyOf to roll up specialized suppliesDirect and suppliesViaSubsidiary to supplies; annotate peerOf on Org as symmetric.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">6.8. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>The registry is empty at runtime</p>
</li>
<li>
<p>Ensure your models are discovered by Morphia (annotated with @Entity) and that the Quarkus application initializes MorphiaDatastore before the ontology producer.</p>
</li>
<li>
<p>Inverse not applied</p>
</li>
<li>
<p>Declare inverseOf on one side only; the loader will wire both directions.</p>
</li>
<li>
<p>Functional not enforced</p>
</li>
<li>
<p>For functional properties, ensure your edge repository enforces unique (tenantId, src, p) or that your write path overwrites prior values.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_migration_strategy">6.9. Migration strategy</h3>
<div class="ulist">
<ul>
<li>
<p>Start by adding @OntologyProperty to the most important relationships; don’t attempt to annotate everything at once.</p>
</li>
<li>
<p>Keep existing @Reference fields if you have them; use edges for query-time semantics and policy integration first.</p>
</li>
<li>
<p>Add tests that verify the loader discovered your properties (including inverses/subPropertyOf) and that queries via hasEdge behave as expected.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_modeling_guidance_annotate_existing_idreference_getters_keep_api_and_db_clean">6.10. Modeling guidance: annotate existing id/reference getters (keep API and DB clean)</h3>
<div class="ulist">
<ul>
<li>
<p>Prefer annotating getters that already exist in your schema (String ids or existing @Reference fields). Avoid adding embedded objects solely to drive ontology.</p>
</li>
<li>
<p>If you do need a synthetic accessor purely for ontology, hide it from API docs and persistence using @JsonIgnore, @Schema(hidden = true), and @dev.morphia.annotations.Transient.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Recommended pattern: annotate an existing id getter (Swagger unchanged)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.e2eq.ontology.annotations.OntologyClass</span>;
<span class="keyword">import</span> <span class="include">com.e2eq.ontology.annotations.OntologyProperty</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.annotations.Entity</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="comment">// Existing field that is already part of your API/DB contract</span>
  <span class="directive">private</span> <span class="predefined-type">String</span> customerRefName;

  <span class="directive">public</span> <span class="predefined-type">String</span> getCustomerRefName() { <span class="keyword">return</span> customerRefName; }
  <span class="directive">public</span> <span class="type">void</span> setCustomerRefName(<span class="predefined-type">String</span> v) { <span class="local-variable">this</span>.customerRefName = v; }

  <span class="comment">// Drives ontology edges without changing Swagger: the getter already exists and returns a String id</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> <span class="predefined-type">String</span> customerIdForEdges() { <span class="keyword">return</span> getCustomerRefName(); }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because AnnotatedEdgeExtractor treats CharSequence targets as ids, annotating a String-returning getter produces edges without introducing new embedded objects. Your Swagger/OpenAPI and persisted shape remain unchanged.</p>
</div>
<div class="paragraph">
<p>Optional: use an existing @Reference instead of an id</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="annotation">@dev</span>.morphia.annotations.Reference
  <span class="directive">private</span> Customer customer; <span class="comment">// already in your schema</span>

  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedBy</span><span class="delimiter">&quot;</span></span>, inverseOf = <span class="string"><span class="delimiter">&quot;</span><span class="content">placed</span><span class="delimiter">&quot;</span></span>, functional = <span class="predefined-constant">true</span>)
  <span class="directive">public</span> Customer getCustomer() { <span class="keyword">return</span> customer; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you must add an ontology-only accessor, hide it</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonIgnore</span>;
<span class="keyword">import</span> <span class="include">io.swagger.v3.oas.annotations.media.Schema</span>;
<span class="keyword">import</span> <span class="include">dev.morphia.annotations.Transient</span>;

<span class="annotation">@Entity</span>
<span class="annotation">@OntologyClass</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Order</span> <span class="directive">extends</span> UnversionedBaseModel {
  <span class="directive">private</span> <span class="predefined-type">String</span> orgRefName; <span class="comment">// real field</span>

  <span class="comment">// Hidden from API docs and persistence, used only to emit an ontology edge</span>
  <span class="annotation">@JsonIgnore</span>
  <span class="annotation">@Schema</span>(hidden = <span class="predefined-constant">true</span>)
  <span class="annotation">@Transient</span>
  <span class="annotation">@OntologyProperty</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">placedInOrg</span><span class="delimiter">&quot;</span></span>, subPropertyOf = {<span class="string"><span class="delimiter">&quot;</span><span class="content">inOrg</span><span class="delimiter">&quot;</span></span>})
  <span class="directive">public</span> <span class="predefined-type">String</span> placedInOrgEdge() { <span class="keyword">return</span> orgRefName; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These patterns keep your REST and database contracts clear while allowing ontology materialization to happen automatically on writes.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.2.2-SNAPSHOT<br>
Last updated 2025-10-29 15:07:09 -0400
</div>
</div>
</body>
</html>